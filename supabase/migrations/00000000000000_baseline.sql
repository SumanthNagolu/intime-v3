--
-- PostgreSQL database dump
--


-- Dumped from database version 17.6
-- Dumped by pg_dump version 18.0

SET statement_timeout = 0;
SET lock_timeout = 0;
SET idle_in_transaction_session_timeout = 0;
SET transaction_timeout = 0;
SET client_encoding = 'UTF8';
SET standard_conforming_strings = on;
SELECT pg_catalog.set_config('search_path', '', false);
SET check_function_bodies = false;
SET xmloption = content;
SET client_min_messages = warning;
SET row_security = off;

--
-- Name: public; Type: SCHEMA; Schema: -; Owner: -
--

CREATE SCHEMA public;


--
-- Name: SCHEMA public; Type: COMMENT; Schema: -; Owner: -
--

COMMENT ON SCHEMA public IS 'Helper functions for authentication, authorization, and timestamps';


--
-- Name: activity_direction; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.activity_direction AS ENUM (
    'inbound',
    'outbound'
);


--
-- Name: activity_outcome; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.activity_outcome AS ENUM (
    'positive',
    'neutral',
    'negative'
);


--
-- Name: activity_priority; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.activity_priority AS ENUM (
    'low',
    'medium',
    'high',
    'urgent'
);


--
-- Name: activity_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.activity_status AS ENUM (
    'scheduled',
    'open',
    'in_progress',
    'completed',
    'skipped',
    'cancelled'
);


--
-- Name: activity_type_enum; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.activity_type_enum AS ENUM (
    'email',
    'call',
    'meeting',
    'note',
    'linkedin_message',
    'task',
    'follow_up',
    'reminder'
);


--
-- Name: bench_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.bench_status AS ENUM (
    'onboarding',
    'available',
    'marketing',
    'interviewing',
    'placed',
    'inactive'
);


--
-- Name: benefit_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.benefit_status AS ENUM (
    'pending',
    'active',
    'terminated'
);


--
-- Name: benefit_type; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.benefit_type AS ENUM (
    'health',
    'dental',
    'vision',
    '401k',
    'life',
    'disability',
    'hsa',
    'fsa'
);


--
-- Name: company_category; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.company_category AS ENUM (
    'client',
    'vendor',
    'partner',
    'prospect'
);


--
-- Name: company_note_type; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.company_note_type AS ENUM (
    'general',
    'meeting',
    'call',
    'strategy',
    'warning',
    'opportunity',
    'competitive_intel'
);


--
-- Name: company_relationship_category; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.company_relationship_category AS ENUM (
    'parent_child',
    'msp_client',
    'prime_sub',
    'referral_partner',
    'competitor',
    'affiliate',
    'merger_acquisition'
);


--
-- Name: company_relationship_type; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.company_relationship_type AS ENUM (
    'direct_client',
    'msp_client',
    'prime_vendor',
    'sub_vendor',
    'implementation_partner',
    'referral_partner',
    'competitor'
);


--
-- Name: company_segment; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.company_segment AS ENUM (
    'enterprise',
    'mid_market',
    'smb',
    'startup'
);


--
-- Name: company_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.company_status AS ENUM (
    'active',
    'inactive',
    'on_hold',
    'churned',
    'do_not_use',
    'pending_approval'
);


--
-- Name: company_team_role; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.company_team_role AS ENUM (
    'owner',
    'account_manager',
    'recruiter',
    'sales',
    'coordinator',
    'executive_sponsor',
    'viewer'
);


--
-- Name: company_tier; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.company_tier AS ENUM (
    'strategic',
    'preferred',
    'standard',
    'transactional'
);


--
-- Name: company_vendor_type; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.company_vendor_type AS ENUM (
    'direct_client',
    'prime_vendor',
    'sub_vendor',
    'msp',
    'vms_provider',
    'talent_supplier',
    'referral_source'
);


--
-- Name: compliance_applies_to; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.compliance_applies_to AS ENUM (
    'all',
    'fte',
    'contractor'
);


--
-- Name: compliance_frequency; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.compliance_frequency AS ENUM (
    'once',
    'annual',
    'quarterly',
    'monthly'
);


--
-- Name: compliance_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.compliance_status AS ENUM (
    'pending',
    'completed',
    'overdue',
    'exempt'
);


--
-- Name: compliance_type; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.compliance_type AS ENUM (
    'federal',
    'state',
    'local'
);


--
-- Name: contact_decision_authority; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.contact_decision_authority AS ENUM (
    'decision_maker',
    'influencer',
    'champion',
    'gatekeeper',
    'end_user',
    'budget_holder',
    'technical_evaluator',
    'procurement'
);


--
-- Name: contract_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.contract_status AS ENUM (
    'draft',
    'in_review',
    'pending_signature',
    'active',
    'expired',
    'terminated',
    'superseded'
);


--
-- Name: contract_type; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.contract_type AS ENUM (
    'msa',
    'sow',
    'nda',
    'amendment',
    'addendum',
    'rate_agreement',
    'referral_agreement',
    'subcontract',
    'other'
);


--
-- Name: coverage_level; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.coverage_level AS ENUM (
    'employee',
    'employee_spouse',
    'employee_children',
    'family'
);


--
-- Name: document_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.document_status AS ENUM (
    'pending',
    'approved',
    'expired',
    'rejected'
);


--
-- Name: document_type; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.document_type AS ENUM (
    'offer_letter',
    'contract',
    'i9',
    'w4',
    'tax_form',
    'nda',
    'handbook_ack',
    'performance_review',
    'termination',
    'other'
);


--
-- Name: employment_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.employment_status AS ENUM (
    'onboarding',
    'active',
    'on_leave',
    'terminated'
);


--
-- Name: employment_type; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.employment_type AS ENUM (
    'fte',
    'contractor',
    'intern',
    'part_time'
);


--
-- Name: enrollment_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.enrollment_status AS ENUM (
    'pending',
    'active',
    'completed',
    'dropped',
    'expired'
);


--
-- Name: feedback_type; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.feedback_type AS ENUM (
    'strength',
    'improvement',
    'comment'
);


--
-- Name: goal_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.goal_status AS ENUM (
    'not_started',
    'in_progress',
    'completed',
    'cancelled'
);


--
-- Name: graduate_candidate_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.graduate_candidate_status AS ENUM (
    'pending_review',
    'bench_candidate',
    'placed',
    'opted_out',
    'not_qualified'
);


--
-- Name: i9_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.i9_status AS ENUM (
    'pending',
    'section1_complete',
    'completed',
    'expired'
);


--
-- Name: immigration_case_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.immigration_case_status AS ENUM (
    'not_started',
    'in_progress',
    'rfe',
    'approved',
    'denied',
    'withdrawn'
);


--
-- Name: immigration_case_type; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.immigration_case_type AS ENUM (
    'h1b_transfer',
    'h1b_extension',
    'h1b_amendment',
    'gc_perm',
    'gc_i140',
    'gc_i485',
    'opt_extension',
    'tn_renewal',
    'l1_extension'
);


--
-- Name: job_order_priority; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.job_order_priority AS ENUM (
    'low',
    'medium',
    'high',
    'urgent'
);


--
-- Name: job_order_source; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.job_order_source AS ENUM (
    'email',
    'portal',
    'call',
    'referral'
);


--
-- Name: job_order_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.job_order_status AS ENUM (
    'new',
    'working',
    'filled',
    'closed',
    'on_hold'
);


--
-- Name: leaderboard_scope; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.leaderboard_scope AS ENUM (
    'org',
    'department',
    'course'
);


--
-- Name: leaderboard_type; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.leaderboard_type AS ENUM (
    'weekly',
    'monthly',
    'all_time'
);


--
-- Name: marketing_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.marketing_status AS ENUM (
    'draft',
    'active',
    'paused',
    'archived'
);


--
-- Name: metric_period_type; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.metric_period_type AS ENUM (
    'daily',
    'weekly',
    'monthly',
    'quarterly',
    'yearly'
);


--
-- Name: onboarding_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.onboarding_status AS ENUM (
    'not_started',
    'in_progress',
    'completed',
    'cancelled'
);


--
-- Name: organization_tier; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.organization_tier AS ENUM (
    'starter',
    'growth',
    'enterprise'
);


--
-- Name: path_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.path_status AS ENUM (
    'draft',
    'published',
    'archived'
);


--
-- Name: performance_goal_category; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.performance_goal_category AS ENUM (
    'business',
    'development',
    'behavioral'
);


--
-- Name: pod_member_role; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.pod_member_role AS ENUM (
    'senior',
    'junior'
);


--
-- Name: rate_card_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.rate_card_status AS ENUM (
    'draft',
    'pending_approval',
    'active',
    'expired',
    'superseded'
);


--
-- Name: relationship; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.relationship AS ENUM (
    'spouse',
    'child',
    'domestic_partner',
    'other'
);


--
-- Name: salary_type; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.salary_type AS ENUM (
    'hourly',
    'annual'
);


--
-- Name: skill_level; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.skill_level AS ENUM (
    'beginner',
    'intermediate',
    'advanced'
);


--
-- Name: streak_type_enum; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.streak_type_enum AS ENUM (
    'daily_login',
    'daily_learning',
    'weekly_completion'
);


--
-- Name: task_category; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.task_category AS ENUM (
    'paperwork',
    'it_setup',
    'training',
    'orientation',
    'other'
);


--
-- Name: task_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.task_status AS ENUM (
    'pending',
    'completed',
    'skipped'
);


--
-- Name: time_off_status; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.time_off_status AS ENUM (
    'pending',
    'approved',
    'denied',
    'cancelled'
);


--
-- Name: time_off_type; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.time_off_type AS ENUM (
    'pto',
    'sick',
    'personal',
    'bereavement',
    'jury_duty',
    'parental',
    'unpaid'
);


--
-- Name: vendor_tier; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.vendor_tier AS ENUM (
    'preferred',
    'standard',
    'new'
);


--
-- Name: vendor_type; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.vendor_type AS ENUM (
    'direct_client',
    'prime_vendor',
    'sub_vendor',
    'msp',
    'vms'
);


--
-- Name: visa_alert_level; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.visa_alert_level AS ENUM (
    'green',
    'yellow',
    'orange',
    'red',
    'black'
);


--
-- Name: visa_type; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.visa_type AS ENUM (
    'usc',
    'green_card',
    'gc_ead',
    'h1b',
    'h1b_transfer',
    'h4_ead',
    'l1a',
    'l1b',
    'l2_ead',
    'opt',
    'opt_stem',
    'cpt',
    'tn',
    'e3',
    'o1',
    'canada_citizen',
    'canada_pr',
    'canada_owp',
    'canada_cwp',
    'canada_pgwp',
    'canada_lmia'
);


--
-- Name: work_mode; Type: TYPE; Schema: public; Owner: -
--

CREATE TYPE public.work_mode AS ENUM (
    'on_site',
    'remote',
    'hybrid'
);


--
-- Name: activate_prompt_variant(uuid, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.activate_prompt_variant(p_variant_id uuid, p_traffic_percentage integer) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  -- Ensure traffic percentages don't exceed 100%
  IF (SELECT SUM(traffic_percentage) FROM ai_prompt_variants WHERE is_active = true AND id != p_variant_id) + p_traffic_percentage > 100 THEN
    RAISE EXCEPTION 'Total traffic percentage would exceed 100%%';
  END IF;

  UPDATE ai_prompt_variants
  SET
    is_active = true,
    traffic_percentage = p_traffic_percentage
  WHERE id = p_variant_id;
END;
$$;


--
-- Name: add_trainer_response(uuid, uuid, text, boolean); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.add_trainer_response(p_escalation_id uuid, p_trainer_id uuid, p_message text, p_is_internal_note boolean DEFAULT false) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_response_id UUID;
BEGIN
  -- Insert trainer response
  INSERT INTO trainer_responses (
    escalation_id,
    trainer_id,
    message,
    is_internal_note
  ) VALUES (
    p_escalation_id,
    p_trainer_id,
    p_message,
    p_is_internal_note
  )
  RETURNING id INTO v_response_id;

  -- Update escalation status if not already in progress
  UPDATE ai_mentor_escalations
  SET status = CASE WHEN status = 'pending' THEN 'in_progress' ELSE status END
  WHERE id = p_escalation_id;

  RETURN v_response_id;
END;
$$;


--
-- Name: admin_disable_handler(uuid, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.admin_disable_handler(p_handler_id uuid, p_reason text DEFAULT NULL::text) RETURNS boolean
    LANGUAGE sql SECURITY DEFINER
    AS $$
UPDATE event_subscriptions
SET
  is_active = false,
  auto_disabled_at = NOW(),
  last_failure_message = COALESCE(p_reason, 'Manually disabled by admin')
WHERE id = p_handler_id
RETURNING true;
$$;


--
-- Name: admin_enable_handler(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.admin_enable_handler(p_handler_id uuid) RETURNS boolean
    LANGUAGE sql SECURITY DEFINER
    AS $$
UPDATE event_subscriptions
SET
  is_active = true,
  consecutive_failures = 0,
  auto_disabled_at = NULL
WHERE id = p_handler_id
RETURNING true;
$$;


--
-- Name: admin_get_event_stats(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.admin_get_event_stats(p_org_id uuid DEFAULT NULL::uuid) RETURNS json
    LANGUAGE sql SECURITY DEFINER
    AS $$
SELECT json_build_object(
  'total_events', COUNT(*),
  'pending', COUNT(*) FILTER (WHERE status = 'pending'),
  'processing', COUNT(*) FILTER (WHERE status = 'processing'),
  'completed', COUNT(*) FILTER (WHERE status = 'completed'),
  'failed', COUNT(*) FILTER (WHERE status = 'failed'),
  'dead_letter', COUNT(*) FILTER (WHERE status = 'dead_letter')
)
FROM events
WHERE p_org_id IS NULL OR org_id = p_org_id;
$$;


--
-- Name: admin_get_handler_stats(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.admin_get_handler_stats(p_org_id uuid DEFAULT NULL::uuid) RETURNS json
    LANGUAGE sql SECURITY DEFINER
    AS $$
SELECT json_build_object(
  'total_handlers', COUNT(*),
  'active', COUNT(*) FILTER (WHERE is_active = true),
  'disabled', COUNT(*) FILTER (WHERE is_active = false),
  'avg_failure_rate', COALESCE(AVG(failure_count)::numeric(10,2), 0)
)
FROM event_subscriptions
WHERE p_org_id IS NULL OR org_id = p_org_id;
$$;


SET default_tablespace = '';

SET default_table_access_method = heap;

--
-- Name: events; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.events (
    id uuid DEFAULT extensions.uuid_generate_v4() NOT NULL,
    event_type text NOT NULL,
    event_category text NOT NULL,
    aggregate_id uuid,
    payload jsonb DEFAULT '{}'::jsonb NOT NULL,
    metadata jsonb DEFAULT '{}'::jsonb,
    user_id uuid,
    user_email text,
    status text DEFAULT 'pending'::text,
    retry_count integer DEFAULT 0,
    max_retries integer DEFAULT 3,
    next_retry_at timestamp with time zone,
    error_message text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    processed_at timestamp with time zone,
    failed_at timestamp with time zone,
    event_version integer DEFAULT 1,
    org_id uuid NOT NULL,
    severity text DEFAULT 'info'::text,
    entity_type text,
    entity_id uuid,
    actor_type text DEFAULT 'user'::text,
    actor_id uuid,
    event_data jsonb DEFAULT '{}'::jsonb,
    related_entities jsonb DEFAULT '[]'::jsonb,
    correlation_id text,
    causation_id text,
    parent_event_id uuid,
    occurred_at timestamp with time zone DEFAULT now(),
    idempotency_key text,
    CONSTRAINT valid_event_status CHECK ((status = ANY (ARRAY['pending'::text, 'processing'::text, 'completed'::text, 'failed'::text, 'dead_letter'::text]))),
    CONSTRAINT valid_max_retries CHECK ((max_retries >= 0)),
    CONSTRAINT valid_retry_count CHECK ((retry_count >= 0))
);


--
-- Name: TABLE events; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.events IS 'Event store for event-driven architecture. Uses PostgreSQL LISTEN/NOTIFY for real-time event propagation.';


--
-- Name: COLUMN events.org_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.events.org_id IS 'Organization this event belongs to';


--
-- Name: admin_replay_events(uuid[]); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.admin_replay_events(p_event_ids uuid[]) RETURNS SETOF public.events
    LANGUAGE sql SECURITY DEFINER
    AS $$
UPDATE events
SET
  status = 'pending',
  retry_count = 0,
  next_retry_at = NULL,
  error_message = NULL
WHERE id = ANY(p_event_ids)
  AND status IN ('failed', 'dead_letter')
RETURNING *;
$$;


--
-- Name: app_check_permission(uuid, text, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.app_check_permission(p_user_id uuid, p_permission_code text, p_entity_id uuid DEFAULT NULL::uuid) RETURNS TABLE(allowed boolean, reason text, scope text)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_user_role_id UUID;
  v_role_permission RECORD;
  v_override RECORD;
  v_user_status TEXT;
BEGIN
  -- Get user's role and status
  SELECT role_id, status INTO v_user_role_id, v_user_status
  FROM user_profiles
  WHERE id = p_user_id;

  IF v_user_role_id IS NULL THEN
    RETURN QUERY SELECT false, 'User has no assigned role'::TEXT, NULL::TEXT;
    RETURN;
  END IF;

  IF v_user_status != 'active' THEN
    RETURN QUERY SELECT false, ('User status is ' || v_user_status)::TEXT, NULL::TEXT;
    RETURN;
  END IF;

  -- Check for active override (takes priority)
  SELECT po.* INTO v_override
  FROM permission_overrides po
  JOIN permissions p ON po.permission_id = p.id
  WHERE po.user_id = p_user_id
    AND p.code = p_permission_code
    AND po.revoked_at IS NULL
    AND (po.expires_at IS NULL OR po.expires_at > NOW())
  LIMIT 1;

  IF FOUND THEN
    IF v_override.granted THEN
      RETURN QUERY SELECT true, ('Allowed by custom override: ' || v_override.reason)::TEXT, v_override.scope_override;
    ELSE
      RETURN QUERY SELECT false, ('Denied by custom override: ' || v_override.reason)::TEXT, NULL::TEXT;
    END IF;
    RETURN;
  END IF;

  -- Check role permission
  SELECT rp.*, p.code INTO v_role_permission
  FROM role_permissions rp
  JOIN permissions p ON rp.permission_id = p.id
  WHERE rp.role_id = v_user_role_id
    AND p.code = p_permission_code
    AND rp.granted = true;

  IF NOT FOUND THEN
    RETURN QUERY SELECT false, 'Permission not granted to role'::TEXT, NULL::TEXT;
    RETURN;
  END IF;

  -- Permission granted with scope
  RETURN QUERY SELECT true, 'Allowed by role permission'::TEXT, v_role_permission.scope_condition;
END;
$$;


--
-- Name: FUNCTION app_check_permission(p_user_id uuid, p_permission_code text, p_entity_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.app_check_permission(p_user_id uuid, p_permission_code text, p_entity_id uuid) IS 'Application-level permission check with override support';


--
-- Name: assign_escalation(uuid, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.assign_escalation(p_escalation_id uuid, p_trainer_id uuid) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  UPDATE ai_mentor_escalations
  SET
    assigned_to = p_trainer_id,
    assigned_at = NOW(),
    status = CASE WHEN status = 'pending' THEN 'in_progress' ELSE status END
  WHERE id = p_escalation_id;

  IF NOT FOUND THEN
    RAISE EXCEPTION 'Escalation not found';
  END IF;
END;
$$;


--
-- Name: audit_trigger_func(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.audit_trigger_func() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  INSERT INTO audit_logs (
    table_name,
    action,
    record_id,
    user_id,
    user_email,
    org_id,  -- Can be NULL during initial user creation
    old_values,
    new_values,
    metadata,
    created_at
  )
  VALUES (
    TG_TABLE_NAME::text,
    TG_OP::text,
    COALESCE(NEW.id, OLD.id),
    COALESCE(
      current_setting('app.current_user_id', true)::uuid,
      NEW.id,  -- Use the record's own ID for initial creation
      OLD.id
    ),
    COALESCE(
      current_setting('app.current_user_email', true),
      NEW.email,
      OLD.email,
      'system@intime.local'
    ),
    COALESCE(
      NEW.org_id,  -- Try to get org_id from the new record
      OLD.org_id,  -- Or from the old record
      current_setting('app.current_org_id', true)::uuid,  -- Or from session
      NULL  -- Or allow NULL
    ),
    CASE WHEN TG_OP = 'DELETE' OR TG_OP = 'UPDATE'
      THEN to_jsonb(OLD)
      ELSE NULL
    END,
    CASE WHEN TG_OP = 'INSERT' OR TG_OP = 'UPDATE'
      THEN to_jsonb(NEW)
      ELSE NULL
    END,
    '{}'::jsonb,
    now()
  );

  RETURN COALESCE(NEW, OLD);
END;
$$;


--
-- Name: auth_active_role(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.auth_active_role() RETURNS text
    LANGUAGE plpgsql STABLE SECURITY DEFINER
    AS $$
DECLARE
  active_role TEXT;
BEGIN
  -- Get active_role from JWT user_metadata
  active_role := COALESCE(
    auth.jwt()->>'active_role',
    (
      SELECT r.name
      FROM user_roles ur
      JOIN roles r ON ur.role_id = r.id
      WHERE ur.user_id = auth.uid()
      ORDER BY r.hierarchy_level ASC
      LIMIT 1
    )
  );

  RETURN active_role;
END;
$$;


--
-- Name: FUNCTION auth_active_role(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.auth_active_role() IS 'Get current active role from JWT or default to primary role';


--
-- Name: auth_has_active_role(text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.auth_has_active_role(role_name text) RETURNS boolean
    LANGUAGE plpgsql STABLE SECURITY DEFINER
    AS $$
BEGIN
  RETURN auth_active_role() = role_name;
END;
$$;


--
-- Name: FUNCTION auth_has_active_role(role_name text); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.auth_has_active_role(role_name text) IS 'Check if current active role matches specified role';


--
-- Name: auth_has_any_role(text[]); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.auth_has_any_role(role_names text[]) RETURNS boolean
    LANGUAGE sql STABLE
    AS $$
  SELECT EXISTS (
    SELECT 1 FROM user_roles ur
    JOIN roles r ON ur.role_id = r.id
    WHERE ur.user_id = auth.uid()
      AND r.name = ANY(role_names)
  );
$$;


--
-- Name: auth_has_role(text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.auth_has_role(role_name text) RETURNS boolean
    LANGUAGE plpgsql STABLE SECURITY DEFINER
    AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1
    FROM user_roles ur
    JOIN roles r ON ur.role_id = r.id
    WHERE ur.user_id = auth.uid()
      AND r.name = role_name
  );
END;
$$;


--
-- Name: FUNCTION auth_has_role(role_name text); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.auth_has_role(role_name text) IS 'Check if current user has a specific role';


--
-- Name: auth_org_id(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.auth_org_id() RETURNS uuid
    LANGUAGE plpgsql STABLE SECURITY DEFINER
    AS $$
BEGIN
  RETURN (
    SELECT org_id
    FROM user_profiles
    WHERE id = auth.uid()
    LIMIT 1
  );
END;
$$;


--
-- Name: FUNCTION auth_org_id(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.auth_org_id() IS 'Get current user organization ID from user_profiles';


--
-- Name: auth_user_id(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.auth_user_id() RETURNS uuid
    LANGUAGE sql STABLE
    AS $$
  SELECT auth.uid();
$$;


--
-- Name: FUNCTION auth_user_id(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.auth_user_id() IS 'Returns the authenticated user ID from auth.uid()';


--
-- Name: auth_user_org_id(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.auth_user_org_id() RETURNS uuid
    LANGUAGE sql STABLE SECURITY DEFINER
    AS $$
  SELECT org_id
  FROM user_profiles
  WHERE id = auth_user_id();
$$;


--
-- Name: FUNCTION auth_user_org_id(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.auth_user_org_id() IS 'Returns the organization_id for the authenticated user';


--
-- Name: auto_assign_escalation(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.auto_assign_escalation(p_escalation_id uuid) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_assigned_trainer UUID;
BEGIN
  -- Find trainer with least active escalations
  SELECT t.id INTO v_assigned_trainer
  FROM user_profiles t
  JOIN user_roles ur ON ur.user_id = t.id
  JOIN roles r ON r.id = ur.role_id
  LEFT JOIN ai_mentor_escalations e ON e.assigned_to = t.id AND e.status IN ('pending', 'in_progress')
  WHERE r.name = 'trainer'
  GROUP BY t.id
  ORDER BY COUNT(e.id) ASC, RANDOM()
  LIMIT 1;

  IF v_assigned_trainer IS NOT NULL THEN
    PERFORM assign_escalation(p_escalation_id, v_assigned_trainer);
  END IF;

  RETURN v_assigned_trainer;
END;
$$;


--
-- Name: auto_complete_enrollment_step(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.auto_complete_enrollment_step() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  PERFORM complete_onboarding_step(NEW.user_id, 'enrolled_first_course');
  RETURN NEW;
END;
$$;


--
-- Name: auto_complete_payment_step(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.auto_complete_payment_step() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  IF NEW.status = 'succeeded' THEN
    PERFORM complete_onboarding_step(NEW.user_id, 'connected_payment_method');
  END IF;
  RETURN NEW;
END;
$$;


--
-- Name: auto_complete_quiz_step(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.auto_complete_quiz_step() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  PERFORM complete_onboarding_step(NEW.user_id, 'completed_first_quiz');
  RETURN NEW;
END;
$$;


--
-- Name: auto_complete_video_step(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.auto_complete_video_step() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  PERFORM complete_onboarding_step(NEW.user_id, 'watched_first_video');
  RETURN NEW;
END;
$$;


--
-- Name: auto_create_next_audit_partition(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.auto_create_next_audit_partition() RETURNS void
    LANGUAGE plpgsql
    AS $$
BEGIN
  -- Create partition for 3 months from now
  PERFORM create_audit_log_partition(CURRENT_DATE + INTERVAL '3 months');
END;
$$;


--
-- Name: award_badge_manual(uuid, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.award_badge_manual(p_user_id uuid, p_badge_slug text) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_badge_id UUID;
BEGIN
  -- Get badge ID from slug
  SELECT id INTO v_badge_id
  FROM badges
  WHERE slug = p_badge_slug;

  IF v_badge_id IS NULL THEN
    RAISE EXCEPTION 'Badge not found: %', p_badge_slug;
  END IF;

  -- Award badge (if not already earned)
  INSERT INTO user_badges (user_id, badge_id)
  VALUES (p_user_id, v_badge_id)
  ON CONFLICT (user_id, badge_id) DO NOTHING;

  RETURN v_badge_id;
END;
$$;


--
-- Name: award_badge_xp(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.award_badge_xp() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_xp_reward INTEGER;
  v_badge_name TEXT;
BEGIN
  -- Get badge details
  SELECT xp_reward, name INTO v_xp_reward, v_badge_name
  FROM badges
  WHERE id = NEW.badge_id;

  -- Create XP transaction
  INSERT INTO xp_transactions (
    user_id,
    amount,
    transaction_type,
    description,
    reference_type,
    reference_id
  ) VALUES (
    NEW.user_id,
    v_xp_reward,
    'badge_earned',
    'Earned badge: ' || v_badge_name,
    'badge',
    NEW.badge_id
  );

  RETURN NEW;
END;
$$;


--
-- Name: bulk_import_quiz_questions(uuid, jsonb, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.bulk_import_quiz_questions(p_topic_id uuid, p_questions jsonb, p_created_by uuid DEFAULT NULL::uuid) RETURNS TABLE(success boolean, imported_count integer, errors jsonb)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_question JSONB;
  v_question_id UUID;
  v_imported_count INTEGER := 0;
  v_errors JSONB := '[]'::jsonb;
  v_user_id UUID;
BEGIN
  v_user_id := COALESCE(p_created_by, auth.uid());

  IF v_user_id IS NULL THEN
    RETURN QUERY SELECT FALSE, 0, '["User must be authenticated"]'::jsonb;
    RETURN;
  END IF;

  -- Iterate through questions
  FOR v_question IN SELECT * FROM jsonb_array_elements(p_questions)
  LOOP
    BEGIN
      -- Insert question
      INSERT INTO quiz_questions (
        topic_id,
        question_text,
        question_type,
        options,
        correct_answers,
        explanation,
        difficulty,
        points,
        code_language,
        is_public,
        created_by
      )
      VALUES (
        p_topic_id,
        v_question->>'question_text',
        v_question->>'question_type',
        v_question->'options',
        v_question->'correct_answers',
        v_question->>'explanation',
        COALESCE(v_question->>'difficulty', 'medium'),
        COALESCE((v_question->>'points')::integer, 1),
        v_question->>'code_language',
        COALESCE((v_question->>'is_public')::boolean, FALSE),
        v_user_id
      )
      RETURNING id INTO v_question_id;

      v_imported_count := v_imported_count + 1;

    EXCEPTION WHEN OTHERS THEN
      -- Collect error
      v_errors := v_errors || jsonb_build_object(
        'question', v_question->'question_text',
        'error', SQLERRM
      );
    END;
  END LOOP;

  RETURN QUERY SELECT
    v_imported_count > 0,
    v_imported_count,
    v_errors;
END;
$$;


--
-- Name: bypass_prerequisites_for_role(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.bypass_prerequisites_for_role(p_user_id uuid) RETURNS boolean
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_has_bypass_role BOOLEAN;
BEGIN
  -- Check if user has admin, trainer, or course_admin role
  SELECT EXISTS (
    SELECT 1
    FROM user_roles ur
    JOIN roles r ON r.id = ur.role_id
    WHERE ur.user_id = p_user_id
      AND r.name IN ('admin', 'trainer', 'course_admin')
  ) INTO v_has_bypass_role;

  RETURN COALESCE(v_has_bypass_role, false);
END;
$$;


--
-- Name: FUNCTION bypass_prerequisites_for_role(p_user_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.bypass_prerequisites_for_role(p_user_id uuid) IS 'Checks if user has role that bypasses prerequisites';


--
-- Name: calculate_avg_student_ltv(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.calculate_avg_student_ltv() RETURNS numeric
    LANGUAGE plpgsql STABLE
    AS $$
DECLARE
  avg_monthly_revenue NUMERIC;
  avg_subscription_months NUMERIC;
  churn_rate NUMERIC;
  ltv NUMERIC;
BEGIN
  -- Get average monthly revenue per active subscription
  SELECT AVG(pt.amount) INTO avg_monthly_revenue
  FROM payment_transactions pt
  JOIN student_enrollments se ON se.id = pt.enrollment_id
  WHERE pt.status = 'succeeded'
    AND se.payment_type = 'subscription'
    AND se.status = 'active';

  -- Get average subscription duration in months
  SELECT AVG(
    EXTRACT(EPOCH FROM (
      COALESCE(se.completed_at, NOW()) - se.enrolled_at
    )) / (30 * 24 * 60 * 60)
  ) INTO avg_subscription_months
  FROM student_enrollments se
  WHERE se.payment_type = 'subscription';

  -- Get churn rate
  churn_rate := calculate_churn_rate(3); -- 3-month churn rate

  -- Calculate LTV
  IF churn_rate > 0 THEN
    ltv := (avg_monthly_revenue * avg_subscription_months) / (churn_rate / 100);
  ELSE
    ltv := avg_monthly_revenue * avg_subscription_months;
  END IF;

  RETURN ROUND(COALESCE(ltv, 0), 2);
END;
$$;


--
-- Name: calculate_churn_rate(integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.calculate_churn_rate(p_period_months integer DEFAULT 1) RETURNS numeric
    LANGUAGE plpgsql STABLE
    AS $$
DECLARE
  start_date TIMESTAMPTZ;
  end_date TIMESTAMPTZ;
  starting_subs INTEGER;
  churned_subs INTEGER;
  churn_rate NUMERIC;
BEGIN
  end_date := DATE_TRUNC('month', NOW());
  start_date := end_date - (p_period_months || ' months')::INTERVAL;

  -- Count active subscriptions at start of period
  SELECT COUNT(DISTINCT se.id) INTO starting_subs
  FROM student_enrollments se
  WHERE se.payment_type = 'subscription'
    AND se.status = 'active'
    AND se.enrolled_at < start_date;

  -- Count subscriptions that churned during period
  SELECT COUNT(DISTINCT se.id) INTO churned_subs
  FROM student_enrollments se
  WHERE se.payment_type = 'subscription'
    AND se.status IN ('dropped', 'expired')
    AND se.updated_at >= start_date
    AND se.updated_at < end_date;

  -- Calculate churn rate
  IF starting_subs > 0 THEN
    churn_rate := (churned_subs::NUMERIC / starting_subs) * 100;
  ELSE
    churn_rate := 0;
  END IF;

  RETURN ROUND(churn_rate, 2);
END;
$$;


--
-- Name: calculate_deal_value_from_roles(integer, numeric, integer, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.calculate_deal_value_from_roles(p_placements integer, p_avg_bill_rate numeric, p_hours_per_month integer DEFAULT 173, p_contract_months integer DEFAULT 6) RETURNS numeric
    LANGUAGE plpgsql IMMUTABLE
    AS $$
BEGIN
  RETURN COALESCE(p_placements, 0) *
         COALESCE(p_avg_bill_rate, 0) *
         COALESCE(p_hours_per_month, 173) *
         COALESCE(p_contract_months, 6);
END;
$$;


--
-- Name: FUNCTION calculate_deal_value_from_roles(p_placements integer, p_avg_bill_rate numeric, p_hours_per_month integer, p_contract_months integer); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.calculate_deal_value_from_roles(p_placements integer, p_avg_bill_rate numeric, p_hours_per_month integer, p_contract_months integer) IS 'Calculate deal gross revenue from placements × rate × hours × months';


--
-- Name: calculate_discounted_price(numeric, text, numeric); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.calculate_discounted_price(p_original_price numeric, p_discount_type text, p_discount_value numeric) RETURNS numeric
    LANGUAGE plpgsql IMMUTABLE
    AS $$
BEGIN
  IF p_discount_type = 'percentage' THEN
    RETURN ROUND(p_original_price * (1 - p_discount_value / 100), 2);
  ELSIF p_discount_type = 'fixed' THEN
    RETURN GREATEST(0, p_original_price - p_discount_value);
  ELSE
    RETURN p_original_price;
  END IF;
END;
$$;


--
-- Name: calculate_escalated_days(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.calculate_escalated_days() RETURNS trigger
    LANGUAGE plpgsql
    AS $$ BEGIN IF NEW.target_date IS NOT NULL AND NEW.completed_at IS NULL THEN IF NOW() > NEW.target_date THEN NEW.escalated_days := EXTRACT(DAY FROM (NOW() - NEW.target_date))::INTEGER; IF NEW.escalated_days > 0 AND NOT NEW.is_escalated THEN NEW.is_escalated := TRUE; NEW.escalated_at := NOW(); END IF; ELSE NEW.escalated_days := 0; NEW.is_escalated := FALSE; NEW.escalated_at := NULL; END IF; END IF; RETURN NEW; END; $$;


--
-- Name: calculate_escalation_sla(text, timestamp with time zone); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.calculate_escalation_sla(p_severity text, p_created_at timestamp with time zone) RETURNS TABLE(response_due timestamp with time zone, resolution_due timestamp with time zone)
    LANGUAGE plpgsql IMMUTABLE
    AS $$
BEGIN
  -- SLA based on severity:
  -- Critical: Response 1 hour, Resolution 24 hours
  -- High: Response 2 hours, Resolution 48 hours
  -- Medium: Response 4 hours, Resolution 5 days
  -- Low: Response 24 hours, Resolution 10 days

  CASE p_severity
    WHEN 'critical' THEN
      response_due := p_created_at + INTERVAL '1 hour';
      resolution_due := p_created_at + INTERVAL '24 hours';
    WHEN 'high' THEN
      response_due := p_created_at + INTERVAL '2 hours';
      resolution_due := p_created_at + INTERVAL '48 hours';
    WHEN 'medium' THEN
      response_due := p_created_at + INTERVAL '4 hours';
      resolution_due := p_created_at + INTERVAL '5 days';
    WHEN 'low' THEN
      response_due := p_created_at + INTERVAL '24 hours';
      resolution_due := p_created_at + INTERVAL '10 days';
    ELSE
      response_due := p_created_at + INTERVAL '4 hours';
      resolution_due := p_created_at + INTERVAL '5 days';
  END CASE;

  RETURN NEXT;
END;
$$;


--
-- Name: calculate_lead_score(integer, integer, boolean, boolean, boolean, boolean, boolean, boolean, boolean); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.calculate_lead_score(p_email_opens integer DEFAULT 0, p_link_clicks integer DEFAULT 0, p_has_reply boolean DEFAULT false, p_target_industry boolean DEFAULT false, p_target_company_size boolean DEFAULT false, p_target_funding_stage boolean DEFAULT false, p_positive_sentiment boolean DEFAULT false, p_mentions_hiring boolean DEFAULT false, p_requests_meeting boolean DEFAULT false) RETURNS integer
    LANGUAGE plpgsql
    AS $$
DECLARE
  score INTEGER := 0;
BEGIN
  -- Engagement signals (max 40 points)
  score := score + LEAST(p_email_opens * 3, 15);  -- 3 points per open, max 15
  score := score + LEAST(p_link_clicks * 5, 15);  -- 5 points per click, max 15
  IF p_has_reply THEN score := score + 10; END IF;  -- 10 points for reply

  -- Company fit (max 30 points)
  IF p_target_industry THEN score := score + 10; END IF;
  IF p_target_company_size THEN score := score + 10; END IF;
  IF p_target_funding_stage THEN score := score + 10; END IF;

  -- Response quality (max 30 points)
  IF p_positive_sentiment THEN score := score + 10; END IF;
  IF p_mentions_hiring THEN score := score + 10; END IF;
  IF p_requests_meeting THEN score := score + 10; END IF;

  RETURN LEAST(score, 100);
END;
$$;


--
-- Name: calculate_matching_accuracy(uuid, timestamp with time zone); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.calculate_matching_accuracy(p_org_id uuid, p_start_date timestamp with time zone DEFAULT (now() - '30 days'::interval)) RETURNS TABLE(total_matches bigint, relevant_matches bigint, accuracy numeric, match_precision numeric, avg_match_score numeric)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    COUNT(*) AS total_matches,
    COUNT(*) FILTER (WHERE is_relevant = TRUE) AS relevant_matches,
    -- Accuracy: (relevant / total) × 100
    ROUND(
      (COUNT(*) FILTER (WHERE is_relevant = TRUE)::NUMERIC / NULLIF(COUNT(*), 0)) * 100,
      2
    ) AS accuracy,
    -- Precision: (true positives / (true positives + false positives)) × 100
    ROUND(
      (COUNT(*) FILTER (WHERE is_relevant = TRUE)::NUMERIC /
       NULLIF(COUNT(*) FILTER (WHERE match_score >= 70), 0)) * 100,
      2
    ) AS match_precision,
    -- Average match score
    ROUND(AVG(match_score), 2) AS avg_match_score
  FROM resume_matches
  WHERE org_id = p_org_id
    AND created_at >= p_start_date
    AND is_relevant IS NOT NULL;  -- Only include labeled matches
END;
$$;


--
-- Name: FUNCTION calculate_matching_accuracy(p_org_id uuid, p_start_date timestamp with time zone); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.calculate_matching_accuracy(p_org_id uuid, p_start_date timestamp with time zone) IS 'Calculate resume matching accuracy metrics based on recruiter feedback (is_relevant column)';


--
-- Name: calculate_mrr(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.calculate_mrr() RETURNS numeric
    LANGUAGE plpgsql STABLE
    AS $$
DECLARE
  current_mrr NUMERIC;
BEGIN
  SELECT COALESCE(SUM(pt.amount), 0) INTO current_mrr
  FROM payment_transactions pt
  JOIN student_enrollments se ON se.id = pt.enrollment_id
  WHERE pt.status = 'succeeded'
    AND se.payment_type = 'subscription'
    AND se.status = 'active'
    AND DATE_TRUNC('month', pt.created_at) = DATE_TRUNC('month', NOW());

  RETURN current_mrr;
END;
$$;


--
-- Name: calculate_path_progress(uuid, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.calculate_path_progress(p_user_id uuid, p_path_id uuid) RETURNS integer
    LANGUAGE plpgsql
    AS $$
DECLARE
  total_courses INTEGER;
  completed_courses INTEGER;
  progress INTEGER;
BEGIN
  SELECT COUNT(*)
  INTO total_courses
  FROM learning_path_courses lpc
  WHERE lpc.path_id = p_path_id
    AND lpc.is_required = TRUE;

  SELECT COUNT(*)
  INTO completed_courses
  FROM learning_path_courses lpc
  INNER JOIN student_enrollments se ON lpc.course_id = se.course_id
  WHERE lpc.path_id = p_path_id
    AND lpc.is_required = TRUE
    AND se.user_id = p_user_id
    AND se.status = 'completed';

  IF total_courses = 0 THEN
    progress := 0;
  ELSE
    progress := ROUND((completed_courses::DECIMAL / total_courses::DECIMAL) * 100);
  END IF;

  RETURN progress;
END;
$$;


--
-- Name: calculate_payment_success_rate(integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.calculate_payment_success_rate(p_period_days integer DEFAULT 30) RETURNS numeric
    LANGUAGE plpgsql STABLE
    AS $$
DECLARE
  total_payments INTEGER;
  successful_payments INTEGER;
  success_rate NUMERIC;
BEGIN
  SELECT
    COUNT(*),
    COUNT(CASE WHEN status = 'succeeded' THEN 1 END)
  INTO total_payments, successful_payments
  FROM payment_transactions
  WHERE created_at >= NOW() - (p_period_days || ' days')::INTERVAL;

  IF total_payments > 0 THEN
    success_rate := (successful_payments::NUMERIC / total_payments) * 100;
  ELSE
    success_rate := 0;
  END IF;

  RETURN ROUND(success_rate, 2);
END;
$$;


--
-- Name: calculate_pod_sprint_metrics(uuid, integer, date, date); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.calculate_pod_sprint_metrics(p_pod_id uuid, p_sprint_number integer, p_start_date date, p_end_date date) RETURNS void
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_org_id uuid;
  v_total_placements integer;
  v_total_credits numeric(6,2);
  v_total_revenue numeric(14,2);
  v_avg_margin numeric(5,2);
  v_from_recruiting integer;
  v_from_bench integer;
  v_from_academy integer;
  v_from_ta integer;
  v_from_cross_border integer;
BEGIN
  -- Get org_id from pod
  SELECT org_id INTO v_org_id FROM pods WHERE id = p_pod_id;
  
  -- Calculate metrics from placement_credits
  SELECT 
    COUNT(*)::integer,
    COALESCE(SUM(credit_amount), 0),
    COALESCE(SUM(estimated_revenue), 0),
    COALESCE(AVG(margin_percentage), 0),
    COUNT(*) FILTER (WHERE source_pillar = 'recruiting')::integer,
    COUNT(*) FILTER (WHERE source_pillar = 'bench_sales')::integer,
    COUNT(*) FILTER (WHERE source_pillar = 'training_academy')::integer,
    COUNT(*) FILTER (WHERE source_pillar = 'talent_acquisition')::integer,
    COUNT(*) FILTER (WHERE source_pillar = 'cross_border')::integer
  INTO 
    v_total_placements,
    v_total_credits,
    v_total_revenue,
    v_avg_margin,
    v_from_recruiting,
    v_from_bench,
    v_from_academy,
    v_from_ta,
    v_from_cross_border
  FROM placement_credits
  WHERE pod_id = p_pod_id
    AND sprint_number = p_sprint_number;
  
  -- Upsert metrics
  INSERT INTO pod_sprint_metrics (
    org_id,
    pod_id,
    sprint_number,
    sprint_start_date,
    sprint_end_date,
    total_placements,
    total_credits,
    target_met,
    total_estimated_revenue,
    average_margin,
    placements_from_recruiting,
    placements_from_bench_sales,
    placements_from_academy,
    placements_from_ta,
    placements_from_cross_border,
    calculated_at
  )
  VALUES (
    v_org_id,
    p_pod_id,
    p_sprint_number,
    p_start_date,
    p_end_date,
    v_total_placements,
    v_total_credits,
    v_total_credits >= 2.0,
    v_total_revenue,
    v_avg_margin,
    v_from_recruiting,
    v_from_bench,
    v_from_academy,
    v_from_ta,
    v_from_cross_border,
    now()
  )
  ON CONFLICT (pod_id, sprint_number) DO UPDATE SET
    total_placements = EXCLUDED.total_placements,
    total_credits = EXCLUDED.total_credits,
    target_met = EXCLUDED.target_met,
    total_estimated_revenue = EXCLUDED.total_estimated_revenue,
    average_margin = EXCLUDED.average_margin,
    placements_from_recruiting = EXCLUDED.placements_from_recruiting,
    placements_from_bench_sales = EXCLUDED.placements_from_bench_sales,
    placements_from_academy = EXCLUDED.placements_from_academy,
    placements_from_ta = EXCLUDED.placements_from_ta,
    placements_from_cross_border = EXCLUDED.placements_from_cross_border,
    calculated_at = now(),
    updated_at = now();
END;
$$;


--
-- Name: calculate_refund_rate(integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.calculate_refund_rate(p_period_days integer DEFAULT 30) RETURNS numeric
    LANGUAGE plpgsql STABLE
    AS $$
DECLARE
  total_successful INTEGER;
  total_refunded INTEGER;
  refund_rate NUMERIC;
BEGIN
  SELECT
    COUNT(CASE WHEN status = 'succeeded' THEN 1 END),
    COUNT(CASE WHEN status = 'refunded' THEN 1 END)
  INTO total_successful, total_refunded
  FROM payment_transactions
  WHERE created_at >= NOW() - (p_period_days || ' days')::INTERVAL;

  IF total_successful > 0 THEN
    refund_rate := (total_refunded::NUMERIC / total_successful) * 100;
  ELSE
    refund_rate := 0;
  END IF;

  RETURN ROUND(refund_rate, 2);
END;
$$;


--
-- Name: calculate_resolution_time(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.calculate_resolution_time() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  IF NEW.status = 'resolved' AND OLD.status != 'resolved' THEN
    NEW.resolved_at = NOW();
    NEW.resolution_time_minutes = EXTRACT(EPOCH FROM (NOW() - NEW.created_at)) / 60;
  END IF;
  RETURN NEW;
END;
$$;


--
-- Name: can_switch_to_role(text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.can_switch_to_role(p_role_name text) RETURNS boolean
    LANGUAGE plpgsql STABLE SECURITY DEFINER
    AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1
    FROM user_roles ur
    JOIN roles r ON ur.role_id = r.id
    WHERE ur.user_id = auth.uid()
      AND r.name = p_role_name
  );
END;
$$;


--
-- Name: FUNCTION can_switch_to_role(p_role_name text); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.can_switch_to_role(p_role_name text) IS 'Check if user has permission to switch to specified role';


--
-- Name: cancel_workflow(uuid, uuid, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.cancel_workflow(p_instance_id uuid, p_user_id uuid, p_reason text) RETURNS boolean
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_instance RECORD;
BEGIN
  SELECT * INTO v_instance
  FROM workflow_instances
  WHERE id = p_instance_id
  FOR UPDATE;

  IF NOT FOUND THEN
    RAISE EXCEPTION 'Workflow instance % not found', p_instance_id;
  END IF;

  IF v_instance.status != 'active' THEN
    RAISE EXCEPTION 'Cannot cancel workflow in % status', v_instance.status;
  END IF;

  UPDATE workflow_instances
  SET
    status = 'cancelled',
    cancelled_at = NOW(),
    updated_at = NOW()
  WHERE id = p_instance_id;

  INSERT INTO workflow_history (
    workflow_instance_id,
    from_state_id,
    to_state_id,
    action,
    performed_by,
    notes
  ) VALUES (
    p_instance_id,
    v_instance.current_state_id,
    v_instance.current_state_id,
    'cancel',
    p_user_id,
    p_reason
  );

  PERFORM publish_event(
    'workflow.cancelled',
    v_instance.entity_id,
    jsonb_build_object(
      'instanceId', p_instance_id,
      'reason', p_reason
    ),
    p_user_id,
    '{}'::jsonb
  );

  RETURN TRUE;
END;
$$;


--
-- Name: FUNCTION cancel_workflow(p_instance_id uuid, p_user_id uuid, p_reason text); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.cancel_workflow(p_instance_id uuid, p_user_id uuid, p_reason text) IS 'Cancel an active workflow instance';


--
-- Name: candidate_skills_populate_skill_name(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.candidate_skills_populate_skill_name() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  IF NEW.skill_name IS NULL THEN
    SELECT name INTO NEW.skill_name FROM skills WHERE id = NEW.skill_id;
  END IF;
  RETURN NEW;
END;
$$;


--
-- Name: check_and_award_badge(uuid, text, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.check_and_award_badge(p_user_id uuid, p_trigger_type text, p_current_value integer) RETURNS TABLE(badge_id uuid, badge_name text, xp_reward integer, newly_earned boolean)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_badge RECORD;
  v_already_earned BOOLEAN;
BEGIN
  -- Find matching badges that user doesn't have yet
  FOR v_badge IN
    SELECT b.id, b.name, b.xp_reward, b.trigger_threshold
    FROM badges b
    WHERE b.trigger_type = p_trigger_type
    AND p_current_value >= b.trigger_threshold
    AND NOT EXISTS (
      SELECT 1 FROM user_badges ub
      WHERE ub.user_id = p_user_id
      AND ub.badge_id = b.id
    )
    ORDER BY b.trigger_threshold ASC
  LOOP
    -- Award the badge
    INSERT INTO user_badges (user_id, badge_id, progress_value)
    VALUES (p_user_id, v_badge.id, p_current_value)
    ON CONFLICT (user_id, badge_id) DO NOTHING
    RETURNING true INTO v_already_earned;

    IF v_already_earned IS NOT NULL THEN
      -- Return the newly earned badge
      badge_id := v_badge.id;
      badge_name := v_badge.name;
      xp_reward := v_badge.xp_reward;
      newly_earned := true;
      RETURN NEXT;
    END IF;
  END LOOP;

  RETURN;
END;
$$;


--
-- Name: check_campaign_status_progression(uuid, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.check_campaign_status_progression(p_campaign_id uuid, p_org_id uuid) RETURNS text
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_campaign campaigns%ROWTYPE;
  v_setup_complete BOOLEAN;
  v_all_required_complete BOOLEAN;
  v_new_status TEXT;
  v_total_required INTEGER;
  v_completed_required INTEGER;
BEGIN
  -- Get campaign
  SELECT * INTO v_campaign
  FROM campaigns
  WHERE id = p_campaign_id AND org_id = p_org_id;

  IF v_campaign IS NULL THEN
    RETURN NULL;
  END IF;

  -- Check if setup activities are complete
  SELECT 
    COUNT(*) FILTER (WHERE status = 'completed') = COUNT(*),
    COUNT(*),
    COUNT(*) FILTER (WHERE status = 'completed')
  INTO v_setup_complete, v_total_required, v_completed_required
  FROM activities
  WHERE entity_type = 'campaign'
    AND entity_id = p_campaign_id
    AND org_id = p_org_id
    AND pattern_code IN ('campaign_setup', 'campaign_build_list', 'campaign_configure_sequences', 'campaign_review_launch');

  -- Determine new status based on progress
  v_new_status := v_campaign.status;

  -- Draft -> Active: When review_launch is completed
  IF v_campaign.status = 'draft' THEN
    SELECT EXISTS (
      SELECT 1 FROM activities
      WHERE entity_type = 'campaign'
        AND entity_id = p_campaign_id
        AND pattern_code = 'campaign_review_launch'
        AND status = 'completed'
    ) INTO v_all_required_complete;

    IF v_all_required_complete THEN
      v_new_status := 'active';
    END IF;
  END IF;

  -- Only update if status changed
  IF v_new_status <> v_campaign.status THEN
    UPDATE campaigns
    SET 
      status = v_new_status,
      updated_at = NOW()
    WHERE id = p_campaign_id;

    -- Log the status change
    INSERT INTO crm_activities (
      org_id, entity_type, entity_id,
      activity_type, subject, description,
      status, created_by
    ) VALUES (
      p_org_id, 'campaign', p_campaign_id,
      'note', 'Campaign Status Changed',
      'Campaign status automatically changed from ' || v_campaign.status || ' to ' || v_new_status || ' based on completed activities',
      'completed', NULL
    );
  END IF;

  RETURN v_new_status;
END;
$$;


--
-- Name: check_course_prerequisites(uuid, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.check_course_prerequisites(p_user_id uuid, p_course_id uuid) RETURNS boolean
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_prerequisite_course_ids UUID[];
  v_completed_course_ids UUID[];
BEGIN
  -- Get prerequisite courses
  SELECT prerequisite_course_ids INTO v_prerequisite_course_ids
  FROM courses
  WHERE id = p_course_id;

  -- If no prerequisites, course is accessible
  IF v_prerequisite_course_ids IS NULL OR array_length(v_prerequisite_course_ids, 1) = 0 THEN
    RETURN true;
  END IF;

  -- Get completed courses for user
  SELECT ARRAY_AGG(course_id) INTO v_completed_course_ids
  FROM student_enrollments
  WHERE user_id = p_user_id
    AND status = 'completed';

  -- Check if all prerequisite courses are completed
  RETURN v_prerequisite_course_ids <@ COALESCE(v_completed_course_ids, ARRAY[]::UUID[]);
END;
$$;


--
-- Name: FUNCTION check_course_prerequisites(p_user_id uuid, p_course_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.check_course_prerequisites(p_user_id uuid, p_course_id uuid) IS 'Checks if user has completed prerequisite courses';


--
-- Name: check_current_user_is_admin(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.check_current_user_is_admin() RETURNS boolean
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$ DECLARE profile_id uuid; result boolean; BEGIN SELECT id INTO profile_id FROM user_profiles WHERE auth_id = auth.uid() LIMIT 1; IF profile_id IS NULL THEN RETURN false; END IF; SELECT EXISTS(SELECT 1 FROM user_roles ur JOIN roles r ON r.id = ur.role_id WHERE ur.user_id = profile_id AND r.name = 'admin') INTO result; RETURN COALESCE(result, false); END; $$;


--
-- Name: check_enrollment_prerequisites(uuid, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.check_enrollment_prerequisites(p_user_id uuid, p_course_id uuid) RETURNS boolean
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_prerequisite_ids UUID[];
  v_completed_course_ids UUID[];
BEGIN
  SELECT prerequisite_course_ids INTO v_prerequisite_ids
  FROM courses
  WHERE id = p_course_id;

  IF v_prerequisite_ids IS NULL OR array_length(v_prerequisite_ids, 1) = 0 THEN
    RETURN true;
  END IF;

  SELECT ARRAY_AGG(course_id) INTO v_completed_course_ids
  FROM student_enrollments
  WHERE user_id = p_user_id AND status = 'completed';

  RETURN v_prerequisite_ids <@ COALESCE(v_completed_course_ids, ARRAY[]::UUID[]);
END;
$$;


--
-- Name: FUNCTION check_enrollment_prerequisites(p_user_id uuid, p_course_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.check_enrollment_prerequisites(p_user_id uuid, p_course_id uuid) IS 'Check if student has completed all prerequisite courses';


--
-- Name: check_graduation_eligibility(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.check_graduation_eligibility(p_enrollment_id uuid) RETURNS boolean
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_capstone_passed BOOLEAN;
  v_all_topics_complete BOOLEAN;
BEGIN
  -- Check if capstone passed
  SELECT EXISTS (
    SELECT 1 FROM capstone_submissions
    WHERE enrollment_id = p_enrollment_id
    AND status = 'passed'
  ) INTO v_capstone_passed;

  -- Check if all topics completed (100% progress)
  SELECT (completion_percentage >= 100) INTO v_all_topics_complete
  FROM student_enrollments
  WHERE id = p_enrollment_id;

  RETURN v_capstone_passed AND v_all_topics_complete;
END;
$$;


--
-- Name: check_module_prerequisites(uuid, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.check_module_prerequisites(p_user_id uuid, p_module_id uuid) RETURNS boolean
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_prerequisite_module_ids UUID[];
  v_module_course_id UUID;
  v_completed_topics UUID[];
BEGIN
  -- Get prerequisite modules and course ID
  SELECT prerequisite_module_ids, course_id
  INTO v_prerequisite_module_ids, v_module_course_id
  FROM course_modules
  WHERE id = p_module_id;

  -- If no prerequisites, module is accessible
  IF v_prerequisite_module_ids IS NULL OR array_length(v_prerequisite_module_ids, 1) = 0 THEN
    RETURN true;
  END IF;

  -- Check if user has completed all topics in prerequisite modules
  FOR i IN 1..array_length(v_prerequisite_module_ids, 1) LOOP
    DECLARE
      v_prereq_module_id UUID := v_prerequisite_module_ids[i];
      v_total_topics INTEGER;
      v_completed_count INTEGER;
    BEGIN
      -- Get total required topics in prerequisite module
      SELECT COUNT(*)
      INTO v_total_topics
      FROM module_topics
      WHERE module_id = v_prereq_module_id
        AND is_required = true;

      -- Get completed topics count
      SELECT COUNT(*)
      INTO v_completed_count
      FROM topic_completions tc
      JOIN module_topics mt ON mt.id = tc.topic_id
      WHERE tc.user_id = p_user_id
        AND mt.module_id = v_prereq_module_id
        AND mt.is_required = true;

      -- If not all required topics completed, prerequisite not met
      IF v_completed_count < v_total_topics THEN
        RETURN false;
      END IF;
    END;
  END LOOP;

  RETURN true;
END;
$$;


--
-- Name: FUNCTION check_module_prerequisites(p_user_id uuid, p_module_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.check_module_prerequisites(p_user_id uuid, p_module_id uuid) IS 'Checks if user has completed prerequisite modules';


--
-- Name: check_rate_limits(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.check_rate_limits(p_user_id uuid) RETURNS jsonb
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_limits ai_mentor_rate_limits;
  v_now TIMESTAMPTZ := NOW();
  v_hourly_remaining INTEGER;
  v_daily_remaining INTEGER;
  v_monthly_remaining INTEGER;
  v_is_limited BOOLEAN;
  v_reset_at TIMESTAMPTZ;
BEGIN
  -- Get or create rate limit record
  SELECT * INTO v_limits
  FROM ai_mentor_rate_limits
  WHERE user_id = p_user_id;

  IF NOT FOUND THEN
    -- Create new rate limit record
    INSERT INTO ai_mentor_rate_limits (
      user_id,
      hourly_count,
      daily_count,
      monthly_count,
      hourly_reset_at,
      daily_reset_at,
      monthly_reset_at,
      monthly_cost_usd
    ) VALUES (
      p_user_id,
      0,
      0,
      0,
      v_now + INTERVAL '1 hour',
      v_now + INTERVAL '1 day',
      v_now + INTERVAL '1 month',
      0
    )
    RETURNING * INTO v_limits;
  END IF;

  -- Reset counters if needed
  IF v_now >= v_limits.hourly_reset_at THEN
    UPDATE ai_mentor_rate_limits
    SET hourly_count = 0,
        hourly_reset_at = v_now + INTERVAL '1 hour'
    WHERE user_id = p_user_id
    RETURNING * INTO v_limits;
  END IF;

  IF v_now >= v_limits.daily_reset_at THEN
    UPDATE ai_mentor_rate_limits
    SET daily_count = 0,
        daily_reset_at = v_now + INTERVAL '1 day'
    WHERE user_id = p_user_id
    RETURNING * INTO v_limits;
  END IF;

  IF v_now >= v_limits.monthly_reset_at THEN
    UPDATE ai_mentor_rate_limits
    SET monthly_count = 0,
        monthly_cost_usd = 0,
        monthly_reset_at = v_now + INTERVAL '1 month'
    WHERE user_id = p_user_id
    RETURNING * INTO v_limits;
  END IF;

  -- Calculate remaining
  v_hourly_remaining := GREATEST(0, 10 - v_limits.hourly_count);
  v_daily_remaining := GREATEST(0, 50 - v_limits.daily_count);
  v_monthly_remaining := GREATEST(0, 500 - v_limits.monthly_count);

  -- Check if limited
  v_is_limited := (
    v_limits.hourly_count >= 10 OR
    v_limits.daily_count >= 50 OR
    v_limits.monthly_count >= 500 OR
    v_limits.monthly_cost_usd >= 5.0
  );

  -- Get earliest reset time
  v_reset_at := LEAST(
    v_limits.hourly_reset_at,
    v_limits.daily_reset_at,
    v_limits.monthly_reset_at
  );

  RETURN jsonb_build_object(
    'hourlyRemaining', v_hourly_remaining,
    'dailyRemaining', v_daily_remaining,
    'monthlyRemaining', v_monthly_remaining,
    'monthlyCostUsd', v_limits.monthly_cost_usd,
    'isLimited', v_is_limited,
    'resetAt', v_reset_at
  );
END;
$$;


--
-- Name: check_user_permission(uuid, text, text, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.check_user_permission(p_user_id uuid, p_resource text, p_action text, p_required_scope text DEFAULT 'own'::text) RETURNS boolean
    LANGUAGE plpgsql STABLE SECURITY DEFINER
    AS $$
DECLARE
  v_has_permission BOOLEAN := FALSE;
BEGIN
  -- Check if user has exact permission or higher scope permission
  SELECT EXISTS (
    SELECT 1
    FROM user_roles ur
    JOIN roles r ON ur.role_id = r.id
    JOIN role_permissions rp ON r.id = rp.role_id
    JOIN permissions p ON rp.permission_id = p.id
    WHERE ur.user_id = p_user_id
      AND ur.deleted_at IS NULL
      AND (ur.expires_at IS NULL OR ur.expires_at > NOW())
      AND r.deleted_at IS NULL
      AND r.is_active = TRUE
      AND p.deleted_at IS NULL
      AND p.resource = p_resource
      AND p.action = p_action
      AND (
        -- Exact scope match
        p.scope = p_required_scope
        -- Or higher scope (all > department > pod > team > own)
        OR p.scope = 'all'
        OR (p_required_scope = 'own' AND p.scope IN ('team', 'pod', 'department', 'all'))
        OR (p_required_scope = 'team' AND p.scope IN ('pod', 'department', 'all'))
        OR (p_required_scope = 'pod' AND p.scope IN ('department', 'all'))
        OR (p_required_scope = 'department' AND p.scope = 'all')
      )
  ) INTO v_has_permission;

  RETURN v_has_permission;
END;
$$;


--
-- Name: FUNCTION check_user_permission(p_user_id uuid, p_resource text, p_action text, p_required_scope text); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.check_user_permission(p_user_id uuid, p_resource text, p_action text, p_required_scope text) IS 'Check if user has permission for resource:action with scope hierarchy (all > department > pod > team > own)';


--
-- Name: check_webhook_auto_disable(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.check_webhook_auto_disable() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  IF NEW.consecutive_failures >= 10 AND OLD.consecutive_failures < 10 THEN
    NEW.status = 'disabled';
  END IF;
  RETURN NEW;
END;
$$;


--
-- Name: cleanup_expired_twin_events(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.cleanup_expired_twin_events() RETURNS integer
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_count INTEGER;
BEGIN
  DELETE FROM twin_events
  WHERE expires_at < NOW()
  RETURNING * INTO v_count;

  GET DIAGNOSTICS v_count = ROW_COUNT;
  RETURN v_count;
END;
$$;


--
-- Name: FUNCTION cleanup_expired_twin_events(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.cleanup_expired_twin_events() IS 'Remove expired events from event bus';


--
-- Name: cleanup_old_audit_partitions(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.cleanup_old_audit_partitions() RETURNS TABLE(partition_name text, action text)
    LANGUAGE plpgsql
    AS $$
DECLARE
  partition_record RECORD;
  partition_date DATE;
  retention_months INTEGER;
BEGIN
  -- Loop through all audit_logs partitions
  FOR partition_record IN
    SELECT c.relname
    FROM pg_class c
    JOIN pg_namespace n ON n.oid = c.relnamespace
    WHERE c.relname LIKE 'audit_logs_%'
      AND n.nspname = 'public'
      AND c.relkind = 'r' -- Regular table (partition)
  LOOP
    -- Extract date from partition name (e.g., audit_logs_2025_11 -> 2025-11-01)
    BEGIN
      partition_date := TO_DATE(
        SUBSTRING(partition_record.relname FROM 'audit_logs_(\d{4}_\d{2})'),
        'YYYY_MM'
      );

      -- Get retention policy (default to 6 months)
      retention_months := 6;

      -- Check if partition is older than retention period
      IF partition_date < CURRENT_DATE - (retention_months || ' months')::INTERVAL THEN
        -- Drop the partition
        EXECUTE format('DROP TABLE IF EXISTS %I', partition_record.relname);

        partition_name := partition_record.relname;
        action := 'DROPPED';
        RETURN NEXT;
      END IF;
    EXCEPTION
      WHEN OTHERS THEN
        -- Skip partitions that don't match expected naming pattern
        CONTINUE;
    END;
  END LOOP;
END;
$$;


--
-- Name: FUNCTION cleanup_old_audit_partitions(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.cleanup_old_audit_partitions() IS 'Drops partitions older than retention period. Run monthly via cron.';


--
-- Name: cleanup_old_notifications(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.cleanup_old_notifications() RETURNS void
    LANGUAGE plpgsql
    AS $$
BEGIN
  DELETE FROM notifications
  WHERE is_read = true
    AND read_at < NOW() - INTERVAL '90 days';
END;
$$;


--
-- Name: cleanup_old_screenshots(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.cleanup_old_screenshots() RETURNS integer
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  deleted_count INTEGER;
BEGIN
  -- Soft delete screenshots older than 90 days
  UPDATE employee_screenshots
  SET deleted_at = NOW()
  WHERE captured_at < NOW() - INTERVAL '90 days'
  AND deleted_at IS NULL;

  GET DIAGNOSTICS deleted_count = ROW_COUNT;

  -- Permanently delete screenshots older than 1 year (hard delete)
  DELETE FROM employee_screenshots
  WHERE deleted_at < NOW() - INTERVAL '1 year';

  RETURN deleted_count;
END;
$$;


--
-- Name: cleanup_old_twin_interactions(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.cleanup_old_twin_interactions() RETURNS void
    LANGUAGE plpgsql
    AS $$
BEGIN
  DELETE FROM employee_twin_interactions
  WHERE created_at < NOW() - INTERVAL '90 days';
END;
$$;


--
-- Name: FUNCTION cleanup_old_twin_interactions(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.cleanup_old_twin_interactions() IS 'Remove interactions older than 90 days';


--
-- Name: clear_at_risk_status(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.clear_at_risk_status(p_enrollment_id uuid) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  UPDATE student_enrollments
  SET
    is_at_risk = FALSE,
    at_risk_since = NULL,
    risk_level = NULL,
    risk_reasons = NULL,
    updated_at = NOW()
  WHERE id = p_enrollment_id;
END;
$$;


--
-- Name: complete_activity(uuid, text, text, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.complete_activity(p_activity_id uuid, p_outcome text DEFAULT NULL::text, p_outcome_notes text DEFAULT NULL::text, p_completed_by uuid DEFAULT NULL::uuid) RETURNS void
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_activity activities%ROWTYPE;
  v_successor RECORD;
BEGIN
  -- Get and update activity
  UPDATE activities
  SET
    status = 'completed',
    outcome = COALESCE(p_outcome, outcome),
    outcome_notes = COALESCE(p_outcome_notes, outcome_notes),
    completed_at = NOW(),
    updated_at = NOW(),
    updated_by = p_completed_by
  WHERE id = p_activity_id
    AND status IN ('open', 'in_progress')
  RETURNING * INTO v_activity;

  IF v_activity IS NULL THEN
    RAISE EXCEPTION 'Activity not found or already completed: %', p_activity_id;
  END IF;

  -- Update workplan progress
  IF v_activity.workplan_instance_id IS NOT NULL THEN
    UPDATE workplan_instances
    SET
      completed_activities = completed_activities + 1,
      updated_at = NOW()
    WHERE id = v_activity.workplan_instance_id;
  END IF;

  -- Record history
  INSERT INTO activity_history (activity_id, action, field_changed, new_value, changed_by)
  VALUES (p_activity_id, 'status_changed', 'status', 'completed', p_completed_by);

  -- Create successor activities
  FOR v_successor IN
    SELECT ap.*, aps.condition_type, aps.condition_field, aps.condition_value, aps.delay_days
    FROM activity_pattern_successors aps
    JOIN activity_patterns ap ON ap.id = aps.successor_pattern_id
    WHERE aps.pattern_id = v_activity.pattern_id
    ORDER BY aps.order_index
  LOOP
    -- Check condition (simplified - expand based on condition_type)
    IF v_successor.condition_type = 'always'
       OR (v_successor.condition_type = 'field_equals'
           AND p_outcome = v_successor.condition_value) THEN

      INSERT INTO activities (
        org_id, pattern_code, pattern_id, workplan_instance_id,
        entity_type, entity_id, subject, description, priority,
        category, instructions, due_date, predecessor_activity_id,
        auto_created, created_by
      ) VALUES (
        v_activity.org_id,
        v_successor.code,
        v_successor.id,
        v_activity.workplan_instance_id,
        v_activity.entity_type,
        v_activity.entity_id,
        v_successor.name,
        v_successor.description,
        v_successor.priority,
        v_successor.category,
        v_successor.instructions,
        NOW() + ((COALESCE(v_successor.delay_days, 0) + v_successor.target_days) || ' days')::INTERVAL,
        p_activity_id,
        TRUE,
        p_completed_by
      );
    END IF;
  END LOOP;
END;
$$;


--
-- Name: complete_campaign_activity(uuid, uuid, text, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.complete_campaign_activity(p_activity_id uuid, p_completed_by uuid, p_outcome text DEFAULT 'completed'::text, p_outcome_notes text DEFAULT NULL::text) RETURNS TABLE(activity_id uuid, successor_created boolean, successor_id uuid, successor_name text)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_activity activities%ROWTYPE;
  v_pattern_id UUID;
  v_successor RECORD;
  v_new_activity_id UUID;
  v_pattern activity_patterns%ROWTYPE;
BEGIN
  -- Get the activity
  SELECT * INTO v_activity
  FROM activities
  WHERE id = p_activity_id;

  IF v_activity IS NULL THEN
    RAISE EXCEPTION 'Activity not found: %', p_activity_id;
  END IF;

  IF v_activity.status = 'completed' THEN
    RAISE EXCEPTION 'Activity already completed';
  END IF;

  -- Mark activity as completed
  UPDATE activities SET
    status = 'completed',
    completed_at = NOW(),
    outcome = p_outcome,
    outcome_notes = p_outcome_notes,
    updated_at = NOW(),
    updated_by = p_completed_by
  WHERE id = p_activity_id;

  -- Log history
  INSERT INTO activity_history (activity_id, action, field_changed, old_value, new_value, changed_by)
  VALUES (p_activity_id, 'status_changed', 'status', v_activity.status, 'completed', p_completed_by);

  -- Initialize return values
  activity_id := p_activity_id;
  successor_created := FALSE;
  successor_id := NULL;
  successor_name := NULL;

  -- Check for successor activities
  IF v_activity.pattern_id IS NOT NULL THEN
    FOR v_successor IN
      SELECT aps.*, ap.code, ap.name as pattern_name, ap.description, 
             ap.target_days, ap.escalation_days, ap.priority, ap.category,
             ap.instructions, ap.checklist
      FROM activity_pattern_successors aps
      JOIN activity_patterns ap ON ap.id = aps.successor_pattern_id
      WHERE aps.pattern_id = v_activity.pattern_id
      ORDER BY aps.order_index
    LOOP
      -- Create successor activity
      INSERT INTO activities (
        org_id, entity_type, entity_id,
        pattern_code, pattern_id, workplan_instance_id,
        subject, description, instructions, checklist,
        priority, category, activity_type,
        due_date, escalation_date,
        assigned_to, status,
        predecessor_activity_id, auto_created, created_by
      ) VALUES (
        v_activity.org_id, v_activity.entity_type, v_activity.entity_id,
        v_successor.code, v_successor.successor_pattern_id, v_activity.workplan_instance_id,
        v_successor.pattern_name, v_successor.description, v_successor.instructions, v_successor.checklist,
        v_successor.priority, v_successor.category, 'task',
        NOW() + (v_successor.delay_days || ' days')::INTERVAL + (v_successor.target_days || ' days')::INTERVAL,
        NOW() + (v_successor.delay_days || ' days')::INTERVAL + (COALESCE(v_successor.escalation_days, v_successor.target_days + 1) || ' days')::INTERVAL,
        v_activity.assigned_to, 'open',
        p_activity_id, TRUE, p_completed_by
      ) RETURNING id INTO v_new_activity_id;

      -- Log history for new activity
      INSERT INTO activity_history (activity_id, action, changed_by, notes)
      VALUES (v_new_activity_id, 'created', p_completed_by, 
              'Auto-created as successor of: ' || v_activity.subject);

      successor_created := TRUE;
      successor_id := v_new_activity_id;
      successor_name := v_successor.pattern_name;

      RETURN NEXT;
    END LOOP;
  END IF;

  -- Return at least one row with completion info
  IF NOT successor_created THEN
    RETURN NEXT;
  END IF;
END;
$$;


--
-- Name: complete_onboarding_step(uuid, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.complete_onboarding_step(p_user_id uuid, p_step_name text) RETURNS boolean
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_checklist_id UUID;
BEGIN
  -- Get or create checklist
  v_checklist_id := get_or_create_onboarding_checklist(p_user_id);

  -- Update the specified step
  CASE p_step_name
    WHEN 'completed_profile' THEN
      UPDATE onboarding_checklist
      SET completed_profile = TRUE, completed_profile_at = NOW()
      WHERE id = v_checklist_id AND completed_profile = FALSE;

    WHEN 'enrolled_first_course' THEN
      UPDATE onboarding_checklist
      SET enrolled_first_course = TRUE, enrolled_first_course_at = NOW()
      WHERE id = v_checklist_id AND enrolled_first_course = FALSE;

    WHEN 'watched_first_video' THEN
      UPDATE onboarding_checklist
      SET watched_first_video = TRUE, watched_first_video_at = NOW()
      WHERE id = v_checklist_id AND watched_first_video = FALSE;

    WHEN 'completed_first_quiz' THEN
      UPDATE onboarding_checklist
      SET completed_first_quiz = TRUE, completed_first_quiz_at = NOW()
      WHERE id = v_checklist_id AND completed_first_quiz = FALSE;

    WHEN 'joined_community' THEN
      UPDATE onboarding_checklist
      SET joined_community = TRUE, joined_community_at = NOW()
      WHERE id = v_checklist_id AND joined_community = FALSE;

    WHEN 'connected_payment_method' THEN
      UPDATE onboarding_checklist
      SET connected_payment_method = TRUE, connected_payment_method_at = NOW()
      WHERE id = v_checklist_id AND connected_payment_method = FALSE;

    WHEN 'set_learning_goals' THEN
      UPDATE onboarding_checklist
      SET set_learning_goals = TRUE, set_learning_goals_at = NOW()
      WHERE id = v_checklist_id AND set_learning_goals = FALSE;

    WHEN 'completed_orientation' THEN
      UPDATE onboarding_checklist
      SET completed_orientation = TRUE, completed_orientation_at = NOW()
      WHERE id = v_checklist_id AND completed_orientation = FALSE;

    ELSE
      RAISE EXCEPTION 'Invalid step name: %', p_step_name;
  END CASE;

  RETURN FOUND;
END;
$$;


--
-- Name: complete_topic(uuid, uuid, uuid, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.complete_topic(p_user_id uuid, p_enrollment_id uuid, p_topic_id uuid, p_time_spent_seconds integer DEFAULT 0) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_completion_id UUID;
  v_course_id UUID;
  v_module_id UUID;
  v_topic_unlocked BOOLEAN;
  v_content_type TEXT;
  v_xp_earned INTEGER;
BEGIN
  SELECT is_topic_unlocked(p_user_id, p_topic_id) INTO v_topic_unlocked;

  IF NOT v_topic_unlocked THEN
    RAISE EXCEPTION 'Topic is locked. Complete prerequisites first.';
  END IF;

  SELECT course_id, module_id, content_type
  INTO v_course_id, v_module_id, v_content_type
  FROM module_topics
  WHERE id = p_topic_id;

  v_xp_earned := CASE v_content_type
    WHEN 'video' THEN 10
    WHEN 'reading' THEN 10
    WHEN 'quiz' THEN 20
    WHEN 'lab' THEN 30
    WHEN 'project' THEN 50
    ELSE 10
  END;

  INSERT INTO topic_completions (
    user_id, enrollment_id, course_id, module_id, topic_id,
    time_spent_seconds, xp_earned, completion_source
  ) VALUES (
    p_user_id, p_enrollment_id, v_course_id, v_module_id, p_topic_id,
    p_time_spent_seconds, v_xp_earned, 'manual'
  )
  ON CONFLICT (user_id, topic_id) DO UPDATE
  SET
    time_spent_seconds = topic_completions.time_spent_seconds + EXCLUDED.time_spent_seconds,
    updated_at = NOW()
  RETURNING id INTO v_completion_id;

  IF v_completion_id IS NOT NULL THEN
    INSERT INTO xp_transactions (
      user_id, amount, transaction_type,
      reference_type, reference_id, description
    ) VALUES (
      p_user_id, v_xp_earned, 'topic_completion',
      'topic_completion', v_completion_id,
      'Completed topic: ' || v_content_type
    );
  END IF;

  PERFORM update_enrollment_progress(p_enrollment_id);

  BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY user_xp_totals;
  EXCEPTION
    WHEN OTHERS THEN
      IF SQLSTATE = '55000' THEN
        NULL;
      ELSE
        RAISE;
      END IF;
  END;

  RETURN v_completion_id;
END;
$$;


--
-- Name: FUNCTION complete_topic(p_user_id uuid, p_enrollment_id uuid, p_topic_id uuid, p_time_spent_seconds integer); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.complete_topic(p_user_id uuid, p_enrollment_id uuid, p_topic_id uuid, p_time_spent_seconds integer) IS 'Marks a topic as complete, awards XP, and updates enrollment progress';


--
-- Name: contacts_search_trigger(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.contacts_search_trigger() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.search_vector :=
    setweight(to_tsvector('english', COALESCE(NEW.first_name, '')), 'A') ||
    setweight(to_tsvector('english', COALESCE(NEW.last_name, '')), 'A') ||
    setweight(to_tsvector('english', COALESCE(NEW.email, '')), 'B') ||
    setweight(to_tsvector('english', COALESCE(NEW.company_name, '')), 'C') ||
    setweight(to_tsvector('english', COALESCE(NEW.title, '')), 'C') ||
    setweight(to_tsvector('english', COALESCE(NEW.notes, '')), 'D');
  RETURN NEW;
END;
$$;


--
-- Name: convert_lead_to_deal(uuid, text, numeric, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.convert_lead_to_deal(p_lead_id uuid, p_deal_title text, p_deal_value numeric, p_deal_stage text DEFAULT 'discovery'::text) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_lead leads;
  v_account_id UUID;
  v_deal_id UUID;
BEGIN
  -- Get lead details
  SELECT * INTO v_lead FROM leads WHERE id = p_lead_id;

  IF NOT FOUND THEN
    RAISE EXCEPTION 'Lead not found';
  END IF;

  -- Create account if company lead and not already converted
  IF v_lead.lead_type = 'company' AND v_lead.converted_to_account_id IS NULL THEN
    INSERT INTO accounts (
      org_id,
      name,
      industry,
      status,
      created_by
    ) VALUES (
      v_lead.org_id,
      v_lead.company_name,
      v_lead.industry,
      'prospect',
      auth.uid()
    ) RETURNING id INTO v_account_id;

    -- Update lead with account reference
    UPDATE leads SET converted_to_account_id = v_account_id WHERE id = p_lead_id;
  ELSE
    v_account_id := v_lead.converted_to_account_id;
  END IF;

  -- Create deal
  INSERT INTO deals (
    org_id,
    lead_id,
    account_id,
    title,
    value,
    stage,
    owner_id,
    created_by
  ) VALUES (
    v_lead.org_id,
    p_lead_id,
    v_account_id,
    p_deal_title,
    p_deal_value,
    p_deal_stage,
    v_lead.owner_id,
    auth.uid()
  ) RETURNING id INTO v_deal_id;

  -- Update lead status
  UPDATE leads SET
    status = 'converted',
    converted_to_deal_id = v_deal_id,
    converted_at = NOW()
  WHERE id = p_lead_id;

  -- Log activity
  INSERT INTO activity_log (
    org_id,
    entity_type,
    entity_id,
    activity_type,
    subject,
    body,
    performed_by,
    activity_date
  ) VALUES (
    v_lead.org_id,
    'lead',
    p_lead_id,
    'note',
    'Lead converted to deal',
    format('Lead converted to deal: %s', p_deal_title),
    auth.uid(),
    NOW()
  );

  RETURN v_deal_id;
END;
$$;


--
-- Name: FUNCTION convert_lead_to_deal(p_lead_id uuid, p_deal_title text, p_deal_value numeric, p_deal_stage text); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.convert_lead_to_deal(p_lead_id uuid, p_deal_title text, p_deal_value numeric, p_deal_stage text) IS 'Converts a lead to a deal, optionally creating an account';


--
-- Name: create_audit_log_partition(timestamp without time zone); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.create_audit_log_partition(partition_date timestamp without time zone) RETURNS void
    LANGUAGE plpgsql
    AS $$
DECLARE
  partition_name TEXT;
  start_date DATE;
  end_date DATE;
BEGIN
  -- Calculate partition boundaries
  start_date := DATE_TRUNC('month', partition_date);
  end_date := start_date + INTERVAL '1 month';

  -- Generate partition name (e.g., audit_logs_2025_11)
  partition_name := 'audit_logs_' || TO_CHAR(start_date, 'YYYY_MM');

  -- Check if partition already exists
  IF NOT EXISTS (
    SELECT 1
    FROM pg_class c
    JOIN pg_namespace n ON n.oid = c.relnamespace
    WHERE c.relname = partition_name
      AND n.nspname = 'public'
  ) THEN
    -- Create partition
    EXECUTE format(
      'CREATE TABLE %I PARTITION OF audit_logs FOR VALUES FROM (%L) TO (%L)',
      partition_name,
      start_date,
      end_date
    );

    RAISE NOTICE 'Created partition: % (% to %)', partition_name, start_date, end_date;
  ELSE
    RAISE NOTICE 'Partition % already exists', partition_name;
  END IF;
END;
$$;


--
-- Name: FUNCTION create_audit_log_partition(partition_date timestamp without time zone); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.create_audit_log_partition(partition_date timestamp without time zone) IS 'Creates a monthly partition for audit_logs. Should be run automatically via cron.';


--
-- Name: create_bench_aging_alert(uuid, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.create_bench_aging_alert(p_candidate_id uuid, p_days_on_bench integer) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_org_id UUID;
  v_bench_rep_id UUID;
BEGIN
  -- Get org and bench rep
  SELECT up.org_id, bm.bench_sales_rep_id
  INTO v_org_id, v_bench_rep_id
  FROM user_profiles up
  LEFT JOIN bench_metadata bm ON bm.user_id = up.id
  WHERE up.id = p_candidate_id;

  -- Create notification for bench rep
  IF v_bench_rep_id IS NOT NULL THEN
    INSERT INTO notifications (
      org_id,
      user_id,
      notification_type,
      title,
      message,
      entity_type,
      entity_id,
      priority,
      action_url
    ) VALUES (
      v_org_id,
      v_bench_rep_id,
      CASE
        WHEN p_days_on_bench >= 60 THEN 'bench_alert_60day'
        WHEN p_days_on_bench >= 30 THEN 'bench_alert_30day'
      END,
      format('Consultant on bench for %s days', p_days_on_bench),
      'Urgent: Placement needed',
      'candidate',
      p_candidate_id,
      'urgent',
      '/bench/talent/' || p_candidate_id
    );
  END IF;
END;
$$;


--
-- Name: FUNCTION create_bench_aging_alert(p_candidate_id uuid, p_days_on_bench integer); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.create_bench_aging_alert(p_candidate_id uuid, p_days_on_bench integer) IS 'Helper to create bench aging alert notifications';


--
-- Name: create_campaign_workplan(uuid, uuid, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.create_campaign_workplan(p_campaign_id uuid, p_org_id uuid, p_created_by uuid) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_template workplan_templates%ROWTYPE;
  v_instance_id UUID;
  v_first_pattern activity_patterns%ROWTYPE;
  v_activity_id UUID;
  v_owner_id UUID;
BEGIN
  -- Get campaign owner for activity assignment
  SELECT owner_id INTO v_owner_id
  FROM campaigns
  WHERE id = p_campaign_id AND org_id = p_org_id;

  -- Use creator if no owner set
  v_owner_id := COALESCE(v_owner_id, p_created_by);

  -- Get the campaign standard template
  SELECT * INTO v_template
  FROM workplan_templates
  WHERE code = 'campaign_standard'
    AND (org_id IS NULL OR org_id = p_org_id)
    AND is_active = TRUE
  ORDER BY org_id NULLS LAST
  LIMIT 1;

  IF v_template IS NULL THEN
    RAISE EXCEPTION 'Campaign workplan template not found';
  END IF;

  -- Create workplan instance
  INSERT INTO workplan_instances (
    org_id, template_id, entity_type, entity_id,
    template_code, template_name, total_activities,
    status, created_by
  ) VALUES (
    p_org_id, v_template.id, 'campaign', p_campaign_id,
    v_template.code, v_template.name, 4,
    'active', p_created_by
  ) RETURNING id INTO v_instance_id;

  -- Get first activity pattern (setup)
  SELECT ap.* INTO v_first_pattern
  FROM activity_patterns ap
  JOIN workplan_template_activities wta ON wta.pattern_id = ap.id
  WHERE wta.template_id = v_template.id
  ORDER BY wta.order_index
  LIMIT 1;

  -- Create first activity
  INSERT INTO activities (
    org_id, entity_type, entity_id,
    pattern_code, pattern_id, workplan_instance_id,
    subject, description, instructions, checklist,
    priority, category, activity_type,
    due_date, escalation_date,
    assigned_to, status,
    auto_created, created_by
  ) VALUES (
    p_org_id, 'campaign', p_campaign_id,
    v_first_pattern.code, v_first_pattern.id, v_instance_id,
    v_first_pattern.name, v_first_pattern.description, v_first_pattern.instructions, v_first_pattern.checklist,
    v_first_pattern.priority, v_first_pattern.category, 'task',
    NOW() + (v_first_pattern.target_days || ' days')::INTERVAL,
    NOW() + (COALESCE(v_first_pattern.escalation_days, v_first_pattern.target_days + 1) || ' days')::INTERVAL,
    v_owner_id, 'open',
    TRUE, p_created_by
  ) RETURNING id INTO v_activity_id;

  -- Log activity history
  INSERT INTO activity_history (activity_id, action, changed_by, notes)
  VALUES (v_activity_id, 'created', p_created_by, 'Auto-created from campaign workflow');

  RETURN v_instance_id;
END;
$$;


--
-- Name: create_commission_from_deal(uuid, numeric, numeric); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.create_commission_from_deal(p_deal_id uuid, p_margin_percentage numeric DEFAULT 20.00, p_commission_percentage numeric DEFAULT 5.00) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_deal deals;
  v_commission_id UUID;
  v_gross_margin NUMERIC;
  v_projected_commission NUMERIC;
BEGIN
  -- Get deal details
  SELECT * INTO v_deal FROM deals WHERE id = p_deal_id;

  IF NOT FOUND THEN
    RAISE EXCEPTION 'Deal not found';
  END IF;

  IF v_deal.stage != 'closed_won' THEN
    RAISE EXCEPTION 'Deal must be closed won to create commission';
  END IF;

  -- Calculate commission
  v_gross_margin := COALESCE(v_deal.value, 0) * (p_margin_percentage / 100.0);
  v_projected_commission := v_gross_margin * (p_commission_percentage / 100.0);

  -- Create commission record
  INSERT INTO commissions (
    org_id,
    deal_id,
    user_id,
    deal_value,
    gross_margin,
    margin_percentage,
    commission_percentage,
    projected_commission,
    commission_type,
    status,
    payment_schedule,
    payment_period_start,
    payment_period_end,
    created_by
  ) VALUES (
    v_deal.org_id,
    p_deal_id,
    v_deal.owner_id,
    v_deal.value,
    v_gross_margin,
    p_margin_percentage,
    p_commission_percentage,
    v_projected_commission,
    'deal_close',
    'pending',
    'monthly',
    v_deal.contract_start_date,
    v_deal.contract_start_date + (COALESCE(v_deal.contract_duration_months, 12) || ' months')::INTERVAL,
    v_deal.updated_by
  ) RETURNING id INTO v_commission_id;

  RETURN v_commission_id;
END;
$$;


--
-- Name: FUNCTION create_commission_from_deal(p_deal_id uuid, p_margin_percentage numeric, p_commission_percentage numeric); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.create_commission_from_deal(p_deal_id uuid, p_margin_percentage numeric, p_commission_percentage numeric) IS 'Create a commission record when a deal is closed as won';


--
-- Name: create_escalation(uuid, uuid, uuid, text, numeric, boolean, jsonb, jsonb); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.create_escalation(p_chat_id uuid, p_user_id uuid, p_topic_id uuid, p_reason text, p_confidence numeric DEFAULT 0.5, p_auto_detected boolean DEFAULT true, p_triggers jsonb DEFAULT '{}'::jsonb, p_metadata jsonb DEFAULT '{}'::jsonb) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_escalation_id UUID;
BEGIN
  -- Create escalation record
  INSERT INTO ai_mentor_escalations (
    chat_id,
    user_id,
    topic_id,
    reason,
    confidence,
    auto_detected,
    triggers,
    metadata,
    status
  ) VALUES (
    p_chat_id,
    p_user_id,
    p_topic_id,
    p_reason,
    p_confidence,
    p_auto_detected,
    p_triggers,
    p_metadata,
    'pending'
  )
  RETURNING id INTO v_escalation_id;

  -- Update the original chat
  UPDATE ai_mentor_chats
  SET
    escalated_to_trainer = true,
    escalation_reason = p_reason,
    escalated_at = NOW()
  WHERE id = p_chat_id;

  RETURN v_escalation_id;
END;
$$;


--
-- Name: create_graduate_candidate(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.create_graduate_candidate() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  -- When enrollment status changes to 'completed'
  IF NEW.status = 'completed' AND (OLD.status IS NULL OR OLD.status != 'completed') THEN
    INSERT INTO graduate_candidates (
      user_id,
      enrollment_id,
      graduated_at,
      course_id,
      status
    )
    VALUES (
      NEW.student_id,  -- student_enrollments uses student_id
      NEW.id,
      now(),
      NEW.course_id,
      'pending_review'
    )
    ON CONFLICT DO NOTHING;
  END IF;
  RETURN NEW;
END;
$$;


--
-- Name: create_prompt_variant(text, text, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.create_prompt_variant(p_variant_name text, p_system_prompt text, p_traffic_percentage integer DEFAULT 0) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_variant_id UUID;
BEGIN
  INSERT INTO ai_prompt_variants (
    variant_name,
    system_prompt,
    is_active,
    traffic_percentage
  ) VALUES (
    p_variant_name,
    p_system_prompt,
    false,
    p_traffic_percentage
  )
  RETURNING id INTO v_variant_id;

  RETURN v_variant_id;
END;
$$;


--
-- Name: create_quiz_question(uuid, text, text, jsonb, jsonb, text, text, integer, text, boolean, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.create_quiz_question(p_topic_id uuid, p_question_text text, p_question_type text, p_options jsonb, p_correct_answers jsonb, p_explanation text DEFAULT NULL::text, p_difficulty text DEFAULT 'medium'::text, p_points integer DEFAULT 1, p_code_language text DEFAULT NULL::text, p_is_public boolean DEFAULT false, p_created_by uuid DEFAULT NULL::uuid) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_question_id UUID;
  v_user_id UUID;
BEGIN
  -- Get user ID
  v_user_id := COALESCE(p_created_by, auth.uid());

  IF v_user_id IS NULL THEN
    RAISE EXCEPTION 'User must be authenticated';
  END IF;

  -- Insert question (validation trigger will run automatically)
  INSERT INTO quiz_questions (
    topic_id,
    question_text,
    question_type,
    options,
    correct_answers,
    explanation,
    difficulty,
    points,
    code_language,
    is_public,
    created_by
  )
  VALUES (
    p_topic_id,
    p_question_text,
    p_question_type,
    p_options,
    p_correct_answers,
    p_explanation,
    p_difficulty,
    p_points,
    p_code_language,
    p_is_public,
    v_user_id
  )
  RETURNING id INTO v_question_id;

  RETURN v_question_id;
END;
$$;


--
-- Name: create_submission_notification(uuid, text, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.create_submission_notification(p_submission_id uuid, p_new_status text, p_recipient_id uuid) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_notification_id UUID;
  v_org_id UUID;
  v_submission submissions;
BEGIN
  -- Get submission details
  SELECT s INTO v_submission
  FROM submissions s
  WHERE s.id = p_submission_id;

  v_org_id := v_submission.org_id;

  -- Create notification
  INSERT INTO notifications (
    org_id,
    user_id,
    notification_type,
    title,
    message,
    entity_type,
    entity_id,
    priority,
    action_url
  ) VALUES (
    v_org_id,
    p_recipient_id,
    'submission_update',
    'Submission status updated',
    format('Submission moved to %s', p_new_status),
    'submission',
    p_submission_id,
    CASE
      WHEN p_new_status = 'client_interview' THEN 'high'
      WHEN p_new_status = 'offer_stage' THEN 'high'
      WHEN p_new_status = 'placed' THEN 'urgent'
      ELSE 'normal'
    END,
    '/submissions/' || p_submission_id
  ) RETURNING id INTO v_notification_id;

  RETURN v_notification_id;
END;
$$;


--
-- Name: FUNCTION create_submission_notification(p_submission_id uuid, p_new_status text, p_recipient_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.create_submission_notification(p_submission_id uuid, p_new_status text, p_recipient_id uuid) IS 'Helper to create submission status change notifications';


--
-- Name: create_workplan_instance(text, text, uuid, uuid, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.create_workplan_instance(p_template_code text, p_entity_type text, p_entity_id uuid, p_org_id uuid, p_created_by uuid DEFAULT NULL::uuid) RETURNS uuid
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_template workplan_templates%ROWTYPE;
  v_instance_id UUID;
  v_activity_count INTEGER;
BEGIN
  -- Get template
  SELECT * INTO v_template
  FROM workplan_templates
  WHERE code = p_template_code
    AND (org_id IS NULL OR org_id = p_org_id)
    AND is_active = TRUE
  ORDER BY org_id NULLS LAST
  LIMIT 1;

  IF v_template IS NULL THEN
    RAISE EXCEPTION 'Workplan template not found: %', p_template_code;
  END IF;

  -- Count activities
  SELECT COUNT(*) INTO v_activity_count
  FROM workplan_template_activities
  WHERE template_id = v_template.id;

  -- Create instance
  INSERT INTO workplan_instances (
    org_id, template_id, entity_type, entity_id,
    template_code, template_name, total_activities, created_by
  ) VALUES (
    p_org_id, v_template.id, p_entity_type, p_entity_id,
    v_template.code, v_template.name, v_activity_count, p_created_by
  ) RETURNING id INTO v_instance_id;

  -- Create initial activities (order_index = 1 or no dependencies)
  INSERT INTO activities (
    org_id, pattern_code, pattern_id, workplan_instance_id,
    entity_type, entity_id, subject, description, priority,
    category, instructions, due_date, auto_created, created_by
  )
  SELECT
    p_org_id,
    ap.code,
    ap.id,
    v_instance_id,
    p_entity_type,
    p_entity_id,
    ap.name,
    ap.description,
    ap.priority,
    ap.category,
    ap.instructions,
    NOW() + (ap.target_days || ' days')::INTERVAL,
    TRUE,
    p_created_by
  FROM workplan_template_activities wta
  JOIN activity_patterns ap ON ap.id = wta.pattern_id
  WHERE wta.template_id = v_template.id
    AND wta.order_index = 1;

  RETURN v_instance_id;
END;
$$;


--
-- Name: current_user_org_id(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.current_user_org_id() RETURNS uuid
    LANGUAGE sql STABLE SECURITY DEFINER
    AS $$
  SELECT (auth.jwt() ->> 'org_id')::uuid;
$$;


--
-- Name: FUNCTION current_user_org_id(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.current_user_org_id() IS 'Returns the org_id from the current JWT token for RLS policies';


--
-- Name: deactivate_prompt_variant(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.deactivate_prompt_variant(p_variant_id uuid) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  UPDATE ai_prompt_variants
  SET
    is_active = false,
    traffic_percentage = 0,
    deactivated_at = NOW()
  WHERE id = p_variant_id;
END;
$$;


--
-- Name: delete_quiz_question(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.delete_quiz_question(p_question_id uuid) RETURNS boolean
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  DELETE FROM quiz_questions
  WHERE id = p_question_id;

  RETURN FOUND;
END;
$$;


--
-- Name: dequeue_next_job(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.dequeue_next_job() RETURNS TABLE(job_id uuid, job_type text, payload jsonb, org_id uuid)
    LANGUAGE plpgsql
    AS $$
BEGIN
  RETURN QUERY
  UPDATE background_jobs
  SET
    status = 'processing',
    started_at = NOW(),
    attempts = attempts + 1,
    updated_at = NOW()
  WHERE id = (
    SELECT id FROM background_jobs
    WHERE status = 'pending'
    ORDER BY priority ASC, created_at ASC
    FOR UPDATE SKIP LOCKED
    LIMIT 1
  )
  RETURNING
    background_jobs.id,
    background_jobs.job_type,
    background_jobs.payload,
    background_jobs.org_id;
END;
$$;


--
-- Name: FUNCTION dequeue_next_job(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.dequeue_next_job() IS 'Atomically dequeue next pending job (uses SKIP LOCKED for concurrency)';


--
-- Name: disable_event_handler(text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.disable_event_handler(p_handler_name text) RETURNS boolean
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  UPDATE event_handlers
  SET
    is_enabled = FALSE,
    updated_at = NOW()
  WHERE handler_name = p_handler_name;

  RETURN FOUND;
END;
$$;


--
-- Name: dismiss_escalation(uuid, uuid, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.dismiss_escalation(p_escalation_id uuid, p_trainer_id uuid, p_dismissal_reason text) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  UPDATE ai_mentor_escalations
  SET
    status = 'dismissed',
    resolved_by = p_trainer_id,
    resolved_at = NOW(),
    resolution_notes = p_dismissal_reason,
    resolution_time_minutes = EXTRACT(EPOCH FROM (NOW() - created_at)) / 60
  WHERE id = p_escalation_id;

  IF NOT FOUND THEN
    RAISE EXCEPTION 'Escalation not found';
  END IF;
END;
$$;


--
-- Name: emit_twin_event(uuid, uuid, text, text, text, jsonb, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.emit_twin_event(p_org_id uuid, p_source_user_id uuid, p_source_role text, p_target_role text, p_event_type text, p_payload jsonb DEFAULT '{}'::jsonb, p_priority text DEFAULT 'medium'::text) RETURNS uuid
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_event_id UUID;
BEGIN
  INSERT INTO twin_events (
    org_id, source_user_id, source_role, target_role,
    event_type, payload, priority
  ) VALUES (
    p_org_id, p_source_user_id, p_source_role, p_target_role,
    p_event_type, p_payload, p_priority
  )
  RETURNING id INTO v_event_id;

  RETURN v_event_id;
END;
$$;


--
-- Name: FUNCTION emit_twin_event(p_org_id uuid, p_source_user_id uuid, p_source_role text, p_target_role text, p_event_type text, p_payload jsonb, p_priority text); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.emit_twin_event(p_org_id uuid, p_source_user_id uuid, p_source_role text, p_target_role text, p_event_type text, p_payload jsonb, p_priority text) IS 'Create a new event in the twin event bus';


--
-- Name: enable_event_handler(text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.enable_event_handler(p_handler_name text) RETURNS boolean
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  UPDATE event_handlers
  SET
    is_enabled = TRUE,
    updated_at = NOW()
  WHERE handler_name = p_handler_name;

  RETURN FOUND;
END;
$$;


--
-- Name: enforce_primary_owner(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.enforce_primary_owner() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  -- If setting isPrimary=true, ensure role=accountable
  IF NEW.is_primary = TRUE AND NEW.role != 'accountable' THEN
    RAISE EXCEPTION 'Only accountable role can be primary owner';
  END IF;

  -- If role=accountable, automatically set isPrimary=true and permission=edit
  IF NEW.role = 'accountable' THEN
    NEW.is_primary := TRUE;
    NEW.permission := 'edit';
  END IF;

  RETURN NEW;
END;
$$;


--
-- Name: enroll_student(uuid, uuid, text, numeric, text, timestamp with time zone, timestamp with time zone); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.enroll_student(p_user_id uuid, p_course_id uuid, p_payment_id text, p_payment_amount numeric, p_payment_type text, p_starts_at timestamp with time zone DEFAULT now(), p_expires_at timestamp with time zone DEFAULT NULL::timestamp with time zone) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_enrollment_id UUID;
  v_prerequisites_met BOOLEAN;
BEGIN
  SELECT check_enrollment_prerequisites(p_user_id, p_course_id)
  INTO v_prerequisites_met;

  IF NOT v_prerequisites_met THEN
    RAISE EXCEPTION 'Prerequisites not met for course enrollment';
  END IF;

  INSERT INTO student_enrollments (
    user_id, course_id, status, starts_at, expires_at,
    payment_id, payment_amount, payment_type, enrollment_source
  ) VALUES (
    p_user_id, p_course_id,
    CASE WHEN p_starts_at <= NOW() THEN 'active' ELSE 'pending' END,
    p_starts_at, p_expires_at,
    p_payment_id, p_payment_amount, p_payment_type, 'api'
  )
  RETURNING id INTO v_enrollment_id;

  PERFORM publish_event(
    'course.enrolled',
    jsonb_build_object(
      'enrollment_id', v_enrollment_id,
      'user_id', p_user_id,
      'course_id', p_course_id,
      'payment_type', p_payment_type
    ),
    jsonb_build_object('source', 'enroll_student'),
    p_user_id
  );

  RETURN v_enrollment_id;
EXCEPTION
  WHEN OTHERS THEN
    -- If publish_event doesn't exist, just return enrollment_id
    IF SQLSTATE = '42883' THEN
      RETURN v_enrollment_id;
    ELSE
      RAISE;
    END IF;
END;
$$;


--
-- Name: FUNCTION enroll_student(p_user_id uuid, p_course_id uuid, p_payment_id text, p_payment_amount numeric, p_payment_type text, p_starts_at timestamp with time zone, p_expires_at timestamp with time zone); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.enroll_student(p_user_id uuid, p_course_id uuid, p_payment_id text, p_payment_amount numeric, p_payment_type text, p_starts_at timestamp with time zone, p_expires_at timestamp with time zone) IS 'Enroll a student in a course with prerequisite validation and event publishing';


--
-- Name: escalate_ai_chat(uuid, uuid, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.escalate_ai_chat(p_chat_id uuid, p_user_id uuid, p_reason text) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  UPDATE ai_mentor_chats
  SET
    escalated_to_trainer = true,
    escalation_reason = p_reason,
    escalated_at = NOW(),
    flagged_for_review = true
  WHERE id = p_chat_id
  AND user_id = p_user_id;

  IF NOT FOUND THEN
    RAISE EXCEPTION 'Chat not found or unauthorized';
  END IF;

  -- TODO: Send notification to trainers
  -- This could publish an event or insert into notifications table
END;
$$;


--
-- Name: expire_old_lab_instances(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.expire_old_lab_instances() RETURNS integer
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
    DECLARE
      v_expired_count INTEGER;
    BEGIN
      UPDATE lab_instances
      SET
        status = 'expired',
        updated_at = NOW()
      WHERE status = 'active'
        AND expires_at < NOW();

      GET DIAGNOSTICS v_expired_count = ROW_COUNT;

      RETURN v_expired_count;
    END;
    $$;


--
-- Name: generate_activity_number(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.generate_activity_number() RETURNS trigger
    LANGUAGE plpgsql
    AS $_$
DECLARE
  v_prefix TEXT;
  v_year TEXT;
  v_seq INTEGER;
  v_activity_number TEXT;
BEGIN
  -- Only generate if not already set
  IF NEW.activity_number IS NOT NULL THEN
    RETURN NEW;
  END IF;
  
  -- Get prefix based on activity type
  v_prefix := CASE NEW.activity_type
    WHEN 'call' THEN 'CALL'
    WHEN 'email' THEN 'EMAIL'
    WHEN 'meeting' THEN 'MTG'
    WHEN 'task' THEN 'TASK'
    WHEN 'note' THEN 'NOTE'
    WHEN 'interview' THEN 'INT'
    WHEN 'follow_up' THEN 'FU'
    ELSE 'ACT'
  END;
  
  v_year := TO_CHAR(NOW(), 'YYYY');
  
  -- Get next sequence number for this org + year
  SELECT COALESCE(MAX(
    CASE 
      WHEN activity_number ~ ('^' || v_prefix || '-' || v_year || '-[0-9]+$')
      THEN CAST(SUBSTRING(activity_number FROM '[0-9]+$') AS INTEGER)
      ELSE 0
    END
  ), 0) + 1 INTO v_seq
  FROM activities
  WHERE org_id = NEW.org_id
    AND activity_number LIKE v_prefix || '-' || v_year || '-%';
  
  -- Generate activity number: PREFIX-YYYY-NNNNN
  v_activity_number := v_prefix || '-' || v_year || '-' || LPAD(v_seq::TEXT, 5, '0');
  
  NEW.activity_number := v_activity_number;
  RETURN NEW;
END;
$_$;


--
-- Name: generate_escalation_number(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.generate_escalation_number() RETURNS text
    LANGUAGE plpgsql
    AS $$
BEGIN
  RETURN 'ESC-' || nextval('escalation_number_seq');
END;
$$;


--
-- Name: generate_incident_number(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.generate_incident_number() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_year TEXT;
  v_prefix TEXT := 'INC';
  v_seq INT;
  v_number TEXT;
BEGIN
  -- Get current year
  v_year := TO_CHAR(COALESCE(NEW.started_at, NOW()), 'YYYY');

  -- Get max sequence for this org + year
  SELECT COALESCE(MAX(
    CAST(SUBSTRING(incident_number FROM v_prefix || '-' || v_year || '-(\d+)') AS INTEGER)
  ), 0) + 1
  INTO v_seq
  FROM incidents
  WHERE org_id = NEW.org_id
    AND incident_number LIKE v_prefix || '-' || v_year || '-%';

  -- Generate formatted number
  v_number := v_prefix || '-' || v_year || '-' || LPAD(v_seq::TEXT, 5, '0');

  NEW.incident_number := v_number;
  RETURN NEW;
END;
$$;


--
-- Name: generate_invitation_token(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.generate_invitation_token() RETURNS text
    LANGUAGE plpgsql
    AS $$
DECLARE
  token TEXT;
BEGIN
  -- Generate a secure random token
  token := encode(gen_random_bytes(32), 'hex');
  RETURN token;
END;
$$;


--
-- Name: FUNCTION generate_invitation_token(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.generate_invitation_token() IS 'Generates a secure random token for user invitations';


--
-- Name: generate_webhook_secret(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.generate_webhook_secret() RETURNS text
    LANGUAGE plpgsql
    AS $$
BEGIN
  RETURN encode(gen_random_bytes(32), 'hex');
END;
$$;


--
-- Name: get_active_lab_instance(uuid, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_active_lab_instance(p_user_id uuid, p_topic_id uuid) RETURNS TABLE(instance_id uuid, forked_repo_url text, started_at timestamp with time zone, expires_at timestamp with time zone, time_remaining_seconds integer, status text)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
    BEGIN
      RETURN QUERY
      SELECT
        li.id AS instance_id,
        li.forked_repo_url,
        li.started_at,
        li.expires_at,
        EXTRACT(EPOCH FROM (li.expires_at - NOW()))::INTEGER AS time_remaining_seconds,
        li.status
      FROM lab_instances li
      WHERE li.user_id = p_user_id
        AND li.topic_id = p_topic_id
        AND li.status = 'active'
      ORDER BY li.started_at DESC
      LIMIT 1;
    END;
    $$;


--
-- Name: get_ai_chat_history(uuid, uuid, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_ai_chat_history(p_user_id uuid, p_session_id uuid, p_limit integer DEFAULT 20) RETURNS TABLE(id uuid, question text, response text, conversation_context jsonb, tokens_used integer, response_time_ms integer, cost_usd numeric, student_rating integer, created_at timestamp with time zone)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    c.id,
    c.question,
    c.response,
    c.conversation_context,
    c.tokens_used,
    c.response_time_ms,
    c.cost_usd,
    c.student_rating,
    c.created_at
  FROM ai_mentor_chats c
  JOIN ai_mentor_sessions s ON s.id = p_session_id
  WHERE c.user_id = p_user_id
  AND s.user_id = p_user_id
  ORDER BY c.created_at DESC
  LIMIT p_limit;
END;
$$;


--
-- Name: get_asset_storage_path(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_asset_storage_path(p_asset_id uuid) RETURNS text
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_storage_path TEXT;
BEGIN
  SELECT storage_path INTO v_storage_path
  FROM content_assets
  WHERE id = p_asset_id;

  RETURN v_storage_path;
END;
$$;


--
-- Name: get_at_risk_students_summary(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_at_risk_students_summary() RETURNS TABLE(total_at_risk bigint, high_risk bigint, medium_risk bigint, low_risk bigint, with_interventions bigint, pending_interventions bigint)
    LANGUAGE plpgsql STABLE
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    COUNT(DISTINCT se.id) AS total_at_risk,
    COUNT(DISTINCT CASE WHEN se.risk_level = 'high' THEN se.id END) AS high_risk,
    COUNT(DISTINCT CASE WHEN se.risk_level = 'medium' THEN se.id END) AS medium_risk,
    COUNT(DISTINCT CASE WHEN se.risk_level = 'low' THEN se.id END) AS low_risk,
    COUNT(DISTINCT si.enrollment_id) AS with_interventions,
    COUNT(DISTINCT CASE WHEN si.status = 'pending' THEN si.enrollment_id END) AS pending_interventions
  FROM student_enrollments se
  LEFT JOIN student_interventions si ON si.enrollment_id = se.id AND si.deleted_at IS NULL
  WHERE se.is_at_risk = TRUE
    AND se.deleted_at IS NULL;
END;
$$;


--
-- Name: get_audit_stats(uuid, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_audit_stats(p_org_id uuid, p_hours integer DEFAULT 24) RETURNS TABLE(total_events bigint, failed_logins bigint, security_alerts bigint, data_exports bigint, failed_login_rate numeric, permission_changes bigint)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  WITH stats AS (
    SELECT
      COUNT(*) AS total,
      COUNT(*) FILTER (WHERE action = 'LOGIN' AND result = 'FAILURE') AS failed_logins_count,
      COUNT(*) FILTER (WHERE action = 'LOGIN') AS total_logins,
      COUNT(*) FILTER (WHERE action = 'EXPORT') AS exports,
      COUNT(*) FILTER (WHERE action IN ('PERMISSION_CHANGE', 'ROLE_CHANGE')) AS perm_changes
    FROM audit_logs
    WHERE org_id = p_org_id
      AND created_at >= NOW() - (p_hours || ' hours')::INTERVAL
  ),
  alerts AS (
    SELECT COUNT(*) AS alert_count
    FROM security_alerts
    WHERE org_id = p_org_id
      AND status IN ('open', 'investigating')
  )
  SELECT
    s.total AS total_events,
    s.failed_logins_count AS failed_logins,
    a.alert_count AS security_alerts,
    s.exports AS data_exports,
    CASE WHEN s.total_logins > 0
      THEN ROUND((s.failed_logins_count::NUMERIC / s.total_logins::NUMERIC) * 100, 2)
      ELSE 0
    END AS failed_login_rate,
    s.perm_changes AS permission_changes
  FROM stats s, alerts a;
END;
$$;


--
-- Name: get_available_actions(uuid, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_available_actions(p_instance_id uuid, p_user_id uuid) RETURNS TABLE(action text, display_name text, to_state_name text, required_permission text, has_permission boolean)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    wt.action,
    wt.display_name,
    ws_to.display_name AS to_state_name,
    wt.required_permission,
    CASE
      WHEN wt.required_permission IS NULL THEN TRUE
      ELSE user_has_permission(p_user_id, wt.required_permission, 'execute')
    END AS has_permission
  FROM workflow_instances wi
  JOIN workflow_transitions wt ON wt.workflow_id = wi.workflow_id
    AND wt.from_state_id = wi.current_state_id
  JOIN workflow_states ws_to ON wt.to_state_id = ws_to.id
  WHERE wi.id = p_instance_id
    AND wi.status = 'active'
  ORDER BY ws_to.state_order;
END;
$$;


--
-- Name: FUNCTION get_available_actions(p_instance_id uuid, p_user_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_available_actions(p_instance_id uuid, p_user_id uuid) IS 'Get available actions for workflow instance (with permission check)';


--
-- Name: get_badge_leaderboard_top(integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_badge_leaderboard_top(p_limit integer DEFAULT 10) RETURNS TABLE(user_id uuid, full_name text, avatar_url text, badge_count bigint, rarity_score bigint, badge_xp_earned bigint)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT * FROM badge_leaderboard
  LIMIT p_limit;
END;
$$;


--
-- Name: get_badge_progress(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_badge_progress(p_user_id uuid) RETURNS TABLE(badge_id uuid, slug text, name text, description text, icon_url text, rarity text, trigger_type text, current_value integer, target_value integer, percentage numeric)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    b.id as badge_id,
    b.slug,
    b.name,
    b.description,
    b.icon_url,
    b.rarity,
    b.trigger_type,
    COALESCE(bp.current_value, 0) as current_value,
    b.trigger_threshold as target_value,
    (COALESCE(bp.current_value, 0)::NUMERIC / NULLIF(b.trigger_threshold, 0) * 100) as percentage
  FROM badges b
  LEFT JOIN badge_progress bp ON bp.badge_id = b.id AND bp.user_id = p_user_id
  WHERE NOT EXISTS (
    SELECT 1 FROM user_badges ub
    WHERE ub.user_id = p_user_id
    AND ub.badge_id = b.id
  )
  AND (b.is_hidden = false OR bp.current_value > 0)
  ORDER BY percentage DESC, b.display_order ASC;
END;
$$;


--
-- Name: get_best_quiz_score(uuid, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_best_quiz_score(p_user_id uuid, p_topic_id uuid) RETURNS TABLE(best_score numeric, best_attempt_id uuid, total_attempts integer, passed_attempts integer)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    MAX(qa.score) AS best_score,
    (
      SELECT qa2.id
      FROM quiz_attempts qa2
      WHERE qa2.user_id = p_user_id
        AND qa2.topic_id = p_topic_id
        AND qa2.score = MAX(qa.score)
      ORDER BY qa2.submitted_at ASC
      LIMIT 1
    ) AS best_attempt_id,
    COUNT(*)::INTEGER AS total_attempts,
    COUNT(CASE WHEN qa.passed THEN 1 END)::INTEGER AS passed_attempts
  FROM quiz_attempts qa
  WHERE qa.user_id = p_user_id
    AND qa.topic_id = p_topic_id
    AND qa.submitted_at IS NOT NULL
  GROUP BY qa.user_id, qa.topic_id;
END;
$$;


--
-- Name: get_campaign_channel_performance(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_campaign_channel_performance(p_campaign_id uuid) RETURNS TABLE(channel text, sent bigint, open_rate numeric, click_rate numeric, response_rate numeric, leads bigint)
    LANGUAGE plpgsql
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    cp.primary_channel AS channel,
    COUNT(*) FILTER (WHERE cp.first_contacted_at IS NOT NULL)::BIGINT AS sent,
    CASE WHEN COUNT(*) FILTER (WHERE cp.first_contacted_at IS NOT NULL) > 0
      THEN ROUND(COUNT(*) FILTER (WHERE cp.opened_at IS NOT NULL)::NUMERIC / COUNT(*) FILTER (WHERE cp.first_contacted_at IS NOT NULL)::NUMERIC * 100, 1)
      ELSE 0
    END AS open_rate,
    CASE WHEN COUNT(*) FILTER (WHERE cp.opened_at IS NOT NULL) > 0
      THEN ROUND(COUNT(*) FILTER (WHERE cp.clicked_at IS NOT NULL)::NUMERIC / COUNT(*) FILTER (WHERE cp.opened_at IS NOT NULL)::NUMERIC * 100, 1)
      ELSE 0
    END AS click_rate,
    CASE WHEN COUNT(*) FILTER (WHERE cp.first_contacted_at IS NOT NULL) > 0
      THEN ROUND(COUNT(*) FILTER (WHERE cp.responded_at IS NOT NULL)::NUMERIC / COUNT(*) FILTER (WHERE cp.first_contacted_at IS NOT NULL)::NUMERIC * 100, 1)
      ELSE 0
    END AS response_rate,
    COUNT(*) FILTER (WHERE cp.converted_to_lead_at IS NOT NULL)::BIGINT AS leads
  FROM campaign_prospects cp
  WHERE cp.campaign_id = p_campaign_id
  GROUP BY cp.primary_channel;
END;
$$;


--
-- Name: get_campaign_funnel(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_campaign_funnel(p_campaign_id uuid) RETURNS TABLE(total_prospects bigint, contacted bigint, opened bigint, clicked bigint, responded bigint, leads bigint, meetings bigint, open_rate numeric, response_rate numeric, conversion_rate numeric)
    LANGUAGE plpgsql
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    COUNT(*)::BIGINT AS total_prospects,
    COUNT(*) FILTER (WHERE first_contacted_at IS NOT NULL)::BIGINT AS contacted,
    COUNT(*) FILTER (WHERE opened_at IS NOT NULL)::BIGINT AS opened,
    COUNT(*) FILTER (WHERE clicked_at IS NOT NULL)::BIGINT AS clicked,
    COUNT(*) FILTER (WHERE responded_at IS NOT NULL)::BIGINT AS responded,
    COUNT(*) FILTER (WHERE converted_to_lead_at IS NOT NULL)::BIGINT AS leads,
    COUNT(*) FILTER (WHERE meeting_booked_at IS NOT NULL)::BIGINT AS meetings,
    CASE WHEN COUNT(*) FILTER (WHERE first_contacted_at IS NOT NULL) > 0
      THEN ROUND(COUNT(*) FILTER (WHERE opened_at IS NOT NULL)::NUMERIC / COUNT(*) FILTER (WHERE first_contacted_at IS NOT NULL)::NUMERIC * 100, 1)
      ELSE 0
    END AS open_rate,
    CASE WHEN COUNT(*) FILTER (WHERE first_contacted_at IS NOT NULL) > 0
      THEN ROUND(COUNT(*) FILTER (WHERE responded_at IS NOT NULL)::NUMERIC / COUNT(*) FILTER (WHERE first_contacted_at IS NOT NULL)::NUMERIC * 100, 1)
      ELSE 0
    END AS response_rate,
    CASE WHEN COUNT(*) > 0
      THEN ROUND(COUNT(*) FILTER (WHERE converted_to_lead_at IS NOT NULL)::NUMERIC / COUNT(*)::NUMERIC * 100, 1)
      ELSE 0
    END AS conversion_rate
  FROM campaign_prospects
  WHERE campaign_id = p_campaign_id;
END;
$$;


--
-- Name: get_capstone_submissions(uuid, uuid, text, integer, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_capstone_submissions(p_user_id uuid DEFAULT NULL::uuid, p_course_id uuid DEFAULT NULL::uuid, p_status text DEFAULT NULL::text, p_limit integer DEFAULT 20, p_offset integer DEFAULT 0) RETURNS TABLE(id uuid, user_id uuid, student_name text, student_email text, enrollment_id uuid, course_id uuid, course_title text, repository_url text, demo_video_url text, description text, submitted_at timestamp with time zone, revision_count integer, status text, graded_by uuid, grader_name text, graded_at timestamp with time zone, grade numeric, feedback text, rubric_scores jsonb, peer_review_count integer, avg_peer_rating numeric)
    LANGUAGE plpgsql
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    cs.id,
    cs.user_id,
    up.full_name as student_name,
    up.email as student_email,
    cs.enrollment_id,
    cs.course_id,
    c.title as course_title,
    cs.repository_url,
    cs.demo_video_url,
    cs.description,
    cs.submitted_at,
    cs.revision_count,
    cs.status,
    cs.graded_by,
    grader.full_name as grader_name,
    cs.graded_at,
    cs.grade,
    cs.feedback,
    cs.rubric_scores,
    cs.peer_review_count,
    cs.avg_peer_rating
  FROM capstone_submissions cs
  JOIN user_profiles up ON cs.user_id = up.id
  JOIN courses c ON cs.course_id = c.id
  LEFT JOIN user_profiles grader ON cs.graded_by = grader.id
  WHERE
    (p_user_id IS NULL OR cs.user_id = p_user_id)
    AND (p_course_id IS NULL OR cs.course_id = p_course_id)
    AND (p_status IS NULL OR cs.status = p_status)
  ORDER BY cs.submitted_at DESC
  LIMIT p_limit
  OFFSET p_offset;
END;
$$;


--
-- Name: get_course_enrollment_analytics(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_course_enrollment_analytics(p_course_id uuid) RETURNS TABLE(total_enrollments bigint, active_enrollments bigint, completed_enrollments bigint, avg_completion_percentage numeric, avg_time_to_complete_days numeric)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    COUNT(*) as total_enrollments,
    COUNT(CASE WHEN se.status = 'active' THEN 1 END) as active_enrollments,
    COUNT(CASE WHEN se.status = 'completed' THEN 1 END) as completed_enrollments,
    AVG(se.completion_percentage) as avg_completion_percentage,
    AVG(EXTRACT(EPOCH FROM (se.completed_at - se.enrolled_at)) / 86400) as avg_time_to_complete_days
  FROM student_enrollments se
  WHERE se.course_id = p_course_id;
END;
$$;


--
-- Name: get_course_reading_stats(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_course_reading_stats(p_course_id uuid) RETURNS TABLE(topic_id uuid, topic_title text, total_readers integer, avg_scroll_percentage numeric, total_reading_time_hours numeric)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
    BEGIN
      RETURN QUERY
      SELECT
        mt.id AS topic_id,
        mt.title AS topic_title,
        COUNT(DISTINCT rp.user_id)::INTEGER AS total_readers,
        ROUND(AVG(rp.scroll_percentage), 2) AS avg_scroll_percentage,
        ROUND(SUM(rp.total_reading_time_seconds)::NUMERIC / 3600, 2) AS total_reading_time_hours
      FROM module_topics mt
      JOIN course_modules cm ON cm.id = mt.module_id
      LEFT JOIN reading_progress rp ON rp.topic_id = mt.id
      WHERE cm.course_id = p_course_id
        AND mt.content_type IN ('reading', 'article')
      GROUP BY mt.id, mt.title
      ORDER BY mt.topic_number;
    END;
    $$;


--
-- Name: get_course_storage_usage(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_course_storage_usage(p_course_id uuid) RETURNS TABLE(file_count bigint, total_bytes bigint, video_count bigint, video_bytes bigint, document_count bigint, document_bytes bigint)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    COUNT(*) as file_count,
    COALESCE(SUM(ca.file_size_bytes), 0) as total_bytes,
    COUNT(*) FILTER (WHERE ca.file_type = 'video') as video_count,
    COALESCE(SUM(ca.file_size_bytes) FILTER (WHERE ca.file_type = 'video'), 0) as video_bytes,
    COUNT(*) FILTER (WHERE ca.file_type IN ('pdf', 'document')) as document_count,
    COALESCE(SUM(ca.file_size_bytes) FILTER (WHERE ca.file_type IN ('pdf', 'document')), 0) as document_bytes
  FROM content_assets ca
  JOIN module_topics mt ON mt.id = ca.topic_id
  JOIN course_modules cm ON cm.id = mt.module_id
  WHERE cm.course_id = p_course_id
    AND ca.is_current = true;
END;
$$;


--
-- Name: FUNCTION get_course_storage_usage(p_course_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_course_storage_usage(p_course_id uuid) IS 'Calculates storage usage statistics for a course';


--
-- Name: get_course_watch_stats(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_course_watch_stats(p_course_id uuid) RETURNS TABLE(topic_id uuid, topic_title text, total_viewers integer, avg_completion_percentage numeric, total_watch_time_hours numeric)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
    BEGIN
      RETURN QUERY
      SELECT
        mt.id AS topic_id,
        mt.title AS topic_title,
        COUNT(DISTINCT vp.user_id)::INTEGER AS total_viewers,
        ROUND(AVG(vp.completion_percentage), 2) AS avg_completion_percentage,
        ROUND(SUM(vp.total_watch_time_seconds)::NUMERIC / 3600, 2) AS total_watch_time_hours
      FROM module_topics mt
      JOIN course_modules cm ON cm.id = mt.module_id
      LEFT JOIN video_progress vp ON vp.topic_id = mt.id
      WHERE cm.course_id = p_course_id
        AND mt.content_type = 'video'
      GROUP BY mt.id, mt.title
      ORDER BY mt.topic_number;
    END;
    $$;


--
-- Name: get_current_traffic_allocation(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_current_traffic_allocation() RETURNS TABLE(variant_id uuid, variant_name text, traffic_percentage integer, total_allocated integer)
    LANGUAGE plpgsql
    AS $$
BEGIN
  RETURN QUERY
  WITH active_variants AS (
    SELECT
      id,
      variant_name,
      traffic_percentage
    FROM ai_prompt_variants
    WHERE is_active = true
  )
  SELECT
    av.id as variant_id,
    av.variant_name,
    av.traffic_percentage,
    (SELECT SUM(traffic_percentage) FROM active_variants)::INTEGER as total_allocated
  FROM active_variants av
  ORDER BY av.traffic_percentage DESC;
END;
$$;


--
-- Name: FUNCTION get_current_traffic_allocation(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_current_traffic_allocation() IS 'Returns current A/B test traffic distribution';


--
-- Name: get_enrollment_funnel(integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_enrollment_funnel(p_period_days integer DEFAULT 30) RETURNS TABLE(stage text, count bigint, conversion_rate numeric)
    LANGUAGE plpgsql STABLE
    AS $$
DECLARE
  total_views BIGINT := 1000; -- This would come from analytics tracking
  total_attempts BIGINT;
  total_enrollments BIGINT;
BEGIN
  -- Get payment attempts (checkout sessions created)
  SELECT COUNT(*) INTO total_attempts
  FROM payment_transactions
  WHERE created_at >= NOW() - (p_period_days || ' days')::INTERVAL;

  -- Get successful enrollments
  SELECT COUNT(*) INTO total_enrollments
  FROM student_enrollments
  WHERE enrolled_at >= NOW() - (p_period_days || ' days')::INTERVAL;

  RETURN QUERY
  SELECT
    'Course Views'::TEXT,
    total_views,
    100.0::NUMERIC
  UNION ALL
  SELECT
    'Checkout Attempts'::TEXT,
    total_attempts,
    ROUND((total_attempts::NUMERIC / NULLIF(total_views, 0)) * 100, 2)
  UNION ALL
  SELECT
    'Successful Enrollments'::TEXT,
    total_enrollments,
    ROUND((total_enrollments::NUMERIC / NULLIF(total_attempts, 0)) * 100, 2);
END;
$$;


--
-- Name: get_entity_owner(text, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_entity_owner(p_entity_type text, p_entity_id uuid) RETURNS TABLE(user_id uuid, user_name text, user_email text, role text, permission text)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT 
    oo.user_id,
    up.full_name,
    up.email,
    oo.role,
    oo.permission
  FROM object_owners oo
  JOIN user_profiles up ON up.id = oo.user_id
  WHERE oo.entity_type = p_entity_type
    AND oo.entity_id = p_entity_id
    AND oo.is_primary = TRUE
  LIMIT 1;
END;
$$;


--
-- Name: get_escalation_details(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_escalation_details(p_escalation_id uuid) RETURNS TABLE(escalation_id uuid, chat_id uuid, user_id uuid, student_name text, student_email text, topic_id uuid, topic_title text, reason text, confidence numeric, auto_detected boolean, triggers jsonb, metadata jsonb, status text, assigned_to uuid, assigned_trainer_name text, created_at timestamp with time zone, wait_time_minutes numeric, original_question text, original_response text, response_count integer, resolution_notes text, resolution_time_minutes integer)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    e.id,
    e.chat_id,
    e.user_id,
    u.full_name,
    u.email,
    e.topic_id,
    mt.title,
    e.reason,
    e.confidence,
    e.auto_detected,
    e.triggers,
    e.metadata,
    e.status,
    e.assigned_to,
    trainer.full_name,
    e.created_at,
    EXTRACT(EPOCH FROM (NOW() - e.created_at)) / 60,
    c.question,
    c.response,
    (SELECT COUNT(*)::INTEGER FROM trainer_responses WHERE escalation_id = e.id),
    e.resolution_notes,
    e.resolution_time_minutes
  FROM ai_mentor_escalations e
  JOIN user_profiles u ON u.id = e.user_id
  LEFT JOIN module_topics mt ON mt.id = e.topic_id
  LEFT JOIN user_profiles trainer ON trainer.id = e.assigned_to
  LEFT JOIN ai_mentor_chats c ON c.id = e.chat_id
  WHERE e.id = p_escalation_id;
END;
$$;


--
-- Name: get_event_handler_health(text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_event_handler_health(p_handler_name text DEFAULT NULL::text) RETURNS TABLE(handler_name text, is_enabled boolean, total_processed bigint, total_failed bigint, avg_processing_time_ms numeric, last_processed_at timestamp with time zone, health_status text)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    eh.handler_name,
    eh.is_enabled,
    COUNT(CASE WHEN eh.status = 'completed' THEN 1 END) as total_processed,
    COUNT(CASE WHEN eh.status = 'failed' THEN 1 END) as total_failed,
    AVG(EXTRACT(EPOCH FROM (eh.completed_at - eh.started_at)) * 1000) as avg_processing_time_ms,
    MAX(eh.completed_at) as last_processed_at,
    CASE
      WHEN NOT eh.is_enabled THEN 'disabled'
      WHEN COUNT(CASE WHEN eh.status = 'failed' THEN 1 END) > 10 THEN 'unhealthy'
      WHEN MAX(eh.completed_at) < NOW() - INTERVAL '1 hour' THEN 'stale'
      ELSE 'healthy'
    END as health_status
  FROM event_handlers eh
  WHERE p_handler_name IS NULL OR eh.handler_name = p_handler_name
  GROUP BY eh.handler_name, eh.is_enabled;
END;
$$;


--
-- Name: get_events_filtered(uuid, text, integer, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_events_filtered(p_org_id uuid DEFAULT NULL::uuid, p_event_name text DEFAULT NULL::text, p_limit integer DEFAULT 100, p_offset integer DEFAULT 0) RETURNS TABLE(id uuid, event_name text, payload jsonb, status text, created_at timestamp with time zone, processed_at timestamp with time zone, error_message text, retry_count integer, org_id uuid)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    e.id,
    e.event_name,
    e.payload,
    e.status,
    e.created_at,
    e.processed_at,
    e.error_message,
    e.retry_count,
    e.org_id
  FROM events e
  WHERE
    (p_org_id IS NULL OR e.org_id = p_org_id)
    AND (p_event_name IS NULL OR e.event_name = p_event_name)
  ORDER BY e.created_at DESC
  LIMIT p_limit
  OFFSET p_offset;
END;
$$;


--
-- Name: get_integration_stats(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_integration_stats(p_org_id uuid) RETURNS TABLE(total_count bigint, active_count bigint, error_count bigint, inactive_count bigint)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    COUNT(*) FILTER (WHERE deleted_at IS NULL) as total_count,
    COUNT(*) FILTER (WHERE status = 'active' AND deleted_at IS NULL) as active_count,
    COUNT(*) FILTER (WHERE status = 'error' AND deleted_at IS NULL) as error_count,
    COUNT(*) FILTER (WHERE status = 'inactive' AND deleted_at IS NULL) as inactive_count
  FROM integrations
  WHERE org_id = p_org_id;
END;
$$;


--
-- Name: get_job_queue_stats(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_job_queue_stats() RETURNS TABLE(job_type text, pending_count bigint, processing_count bigint, completed_count bigint, failed_count bigint, avg_processing_seconds numeric)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    bj.job_type,
    COUNT(*) FILTER (WHERE bj.status = 'pending') AS pending_count,
    COUNT(*) FILTER (WHERE bj.status = 'processing') AS processing_count,
    COUNT(*) FILTER (WHERE bj.status = 'completed') AS completed_count,
    COUNT(*) FILTER (WHERE bj.status = 'failed') AS failed_count,
    ROUND(AVG(EXTRACT(EPOCH FROM (bj.completed_at - bj.started_at)))::NUMERIC, 2) AS avg_processing_seconds
  FROM background_jobs bj
  WHERE bj.org_id = auth_user_org_id() OR user_is_admin()
  GROUP BY bj.job_type;
END;
$$;


--
-- Name: FUNCTION get_job_queue_stats(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_job_queue_stats() IS 'Get job queue statistics by job type';


--
-- Name: get_lab_submission_history(uuid, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_lab_submission_history(p_user_id uuid, p_topic_id uuid) RETURNS TABLE(submission_id uuid, repository_url text, submitted_at timestamp with time zone, status text, final_score numeric, passed boolean, feedback text, attempt_number integer)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
    BEGIN
      RETURN QUERY
      SELECT
        ls.id AS submission_id,
        ls.repository_url,
        ls.submitted_at,
        ls.status,
        ls.final_score,
        ls.passed,
        ls.feedback,
        ls.attempt_number
      FROM lab_submissions ls
      WHERE ls.user_id = p_user_id
        AND ls.topic_id = p_topic_id
      ORDER BY ls.attempt_number DESC;
    END;
    $$;


--
-- Name: get_locked_topics_for_user(uuid, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_locked_topics_for_user(p_user_id uuid, p_course_id uuid) RETURNS TABLE(topic_id uuid, topic_title text, module_id uuid, module_title text, topic_number integer, is_unlocked boolean, missing_prerequisites text[])
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    mt.id AS topic_id,
    mt.title AS topic_title,
    cm.id AS module_id,
    cm.title AS module_title,
    mt.topic_number,
    is_topic_unlocked(p_user_id, mt.id) AS is_unlocked,
    COALESCE(
      (
        SELECT ARRAY_AGG(mt2.title)
        FROM module_topics mt2
        WHERE mt2.id = ANY(mt.prerequisite_topic_ids)
          AND NOT EXISTS (
            SELECT 1
            FROM topic_completions tc
            WHERE tc.user_id = p_user_id
              AND tc.topic_id = mt2.id
          )
      ),
      ARRAY[]::TEXT[]
    ) AS missing_prerequisites
  FROM module_topics mt
  JOIN course_modules cm ON cm.id = mt.module_id
  WHERE cm.course_id = p_course_id
    AND mt.is_published = true
  ORDER BY cm.module_number, mt.topic_number;
END;
$$;


--
-- Name: FUNCTION get_locked_topics_for_user(p_user_id uuid, p_course_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_locked_topics_for_user(p_user_id uuid, p_course_id uuid) IS 'Returns all topics for a course with unlock status';


--
-- Name: get_next_badges(uuid, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_next_badges(p_user_id uuid, p_limit integer DEFAULT 5) RETURNS TABLE(badge_id uuid, slug text, name text, description text, icon_url text, rarity text, current_value integer, target_value integer, percentage numeric)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    b.id as badge_id,
    b.slug,
    b.name,
    b.description,
    b.icon_url,
    b.rarity,
    COALESCE(bp.current_value, 0) as current_value,
    b.trigger_threshold as target_value,
    (COALESCE(bp.current_value, 0)::NUMERIC / NULLIF(b.trigger_threshold, 0) * 100) as percentage
  FROM badges b
  LEFT JOIN badge_progress bp ON bp.badge_id = b.id AND bp.user_id = p_user_id
  WHERE NOT EXISTS (
    SELECT 1 FROM user_badges ub
    WHERE ub.user_id = p_user_id
    AND ub.badge_id = b.id
  )
  AND b.is_hidden = false
  ORDER BY percentage DESC, b.trigger_threshold ASC
  LIMIT p_limit;
END;
$$;


--
-- Name: get_next_unlocked_topic(uuid, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_next_unlocked_topic(p_user_id uuid, p_enrollment_id uuid) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_course_id UUID;
  v_next_topic_id UUID;
BEGIN
  -- Get course ID from enrollment
  SELECT course_id INTO v_course_id
  FROM student_enrollments
  WHERE id = p_enrollment_id;

  -- Find first unlocked, incomplete topic
  SELECT mt.id INTO v_next_topic_id
  FROM module_topics mt
  JOIN course_modules cm ON cm.id = mt.module_id
  WHERE cm.course_id = v_course_id
    AND mt.is_published = true
    AND is_topic_unlocked(p_user_id, mt.id) = true
    AND NOT EXISTS (
      SELECT 1
      FROM topic_completions tc
      WHERE tc.user_id = p_user_id
        AND tc.topic_id = mt.id
    )
  ORDER BY cm.module_number, mt.topic_number
  LIMIT 1;

  RETURN v_next_topic_id;
END;
$$;


--
-- Name: FUNCTION get_next_unlocked_topic(p_user_id uuid, p_enrollment_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_next_unlocked_topic(p_user_id uuid, p_enrollment_id uuid) IS 'Finds the next available topic for a student';


--
-- Name: get_onboarding_progress(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_onboarding_progress(p_user_id uuid) RETURNS TABLE(user_id uuid, completed_steps integer, total_steps integer, completion_percentage integer, is_complete boolean, next_step text)
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_checklist onboarding_checklist%ROWTYPE;
  v_next_step TEXT;
BEGIN
  -- Get or create checklist
  PERFORM get_or_create_onboarding_checklist(p_user_id);

  -- Fetch checklist
  SELECT * INTO v_checklist
  FROM onboarding_checklist oc
  WHERE oc.user_id = p_user_id;

  -- Determine next step
  IF NOT v_checklist.completed_profile THEN
    v_next_step := 'Complete your profile';
  ELSIF NOT v_checklist.enrolled_first_course THEN
    v_next_step := 'Enroll in your first course';
  ELSIF NOT v_checklist.watched_first_video THEN
    v_next_step := 'Watch your first video lesson';
  ELSIF NOT v_checklist.completed_first_quiz THEN
    v_next_step := 'Complete your first quiz';
  ELSIF NOT v_checklist.set_learning_goals THEN
    v_next_step := 'Set your learning goals';
  ELSIF NOT v_checklist.joined_community THEN
    v_next_step := 'Join the community forum';
  ELSIF NOT v_checklist.connected_payment_method THEN
    v_next_step := 'Add a payment method';
  ELSIF NOT v_checklist.completed_orientation THEN
    v_next_step := 'Complete orientation';
  ELSE
    v_next_step := 'All done! Start learning';
  END IF;

  RETURN QUERY SELECT
    v_checklist.user_id,
    v_checklist.completed_steps,
    v_checklist.total_steps,
    v_checklist.completion_percentage,
    (v_checklist.completed_at IS NOT NULL) AS is_complete,
    v_next_step;
END;
$$;


--
-- Name: get_or_create_onboarding_checklist(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_or_create_onboarding_checklist(p_user_id uuid) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_checklist_id UUID;
BEGIN
  -- Try to get existing checklist
  SELECT id INTO v_checklist_id
  FROM onboarding_checklist
  WHERE user_id = p_user_id;

  -- If not found, create it
  IF v_checklist_id IS NULL THEN
    INSERT INTO onboarding_checklist (user_id)
    VALUES (p_user_id)
    RETURNING id INTO v_checklist_id;
  END IF;

  RETURN v_checklist_id;
END;
$$;


--
-- Name: get_or_create_quiz_settings(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_or_create_quiz_settings(p_topic_id uuid) RETURNS TABLE(id uuid, topic_id uuid, randomize_questions boolean, randomize_options boolean, passing_threshold integer, show_correct_answers boolean, time_limit_minutes integer, max_attempts integer, allow_review boolean, xp_reward integer)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_settings_id UUID;
BEGIN
  -- Try to get existing settings
  SELECT qs.id INTO v_settings_id
  FROM quiz_settings qs
  WHERE qs.topic_id = p_topic_id;

  -- Create default settings if not exists
  IF v_settings_id IS NULL THEN
    INSERT INTO quiz_settings (topic_id)
    VALUES (p_topic_id)
    RETURNING quiz_settings.id INTO v_settings_id;
  END IF;

  -- Return settings
  RETURN QUERY
  SELECT
    qs.id,
    qs.topic_id,
    qs.randomize_questions,
    qs.randomize_options,
    qs.passing_threshold,
    qs.show_correct_answers,
    qs.time_limit_minutes,
    qs.max_attempts,
    qs.allow_review,
    qs.xp_reward
  FROM quiz_settings qs
  WHERE qs.id = v_settings_id;
END;
$$;


--
-- Name: get_org_context(uuid, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_org_context(p_org_id uuid, p_context_type text) RETURNS jsonb
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_data JSONB;
  v_expires TIMESTAMPTZ;
BEGIN
  SELECT data, expires_at INTO v_data, v_expires
  FROM org_context_cache
  WHERE org_id = p_org_id AND context_type = p_context_type;

  IF NOT FOUND OR v_expires < NOW() THEN
    -- Return NULL to indicate cache miss (caller should refresh)
    RETURN NULL;
  END IF;

  RETURN v_data;
END;
$$;


--
-- Name: FUNCTION get_org_context(p_org_id uuid, p_context_type text); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_org_context(p_org_id uuid, p_context_type text) IS 'Get cached org context (returns NULL if expired)';


--
-- Name: get_peer_reviews_for_submission(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_peer_reviews_for_submission(p_submission_id uuid) RETURNS TABLE(id uuid, reviewer_id uuid, reviewer_name text, rating integer, comments text, strengths text, improvements text, reviewed_at timestamp with time zone)
    LANGUAGE plpgsql
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    pr.id,
    pr.reviewer_id,
    up.full_name as reviewer_name,
    pr.rating,
    pr.comments,
    pr.strengths,
    pr.improvements,
    pr.reviewed_at
  FROM peer_reviews pr
  JOIN user_profiles up ON pr.reviewer_id = up.id
  WHERE pr.submission_id = p_submission_id
  ORDER BY pr.reviewed_at DESC;
END;
$$;


--
-- Name: get_quality_dashboard_metrics(integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_quality_dashboard_metrics(p_days integer DEFAULT 7) RETURNS TABLE(period text, total_chats integer, helpful_count integer, unhelpful_count integer, helpful_percentage numeric, avg_rating numeric, avg_response_time_ms integer, total_cost numeric, escalation_count integer, escalation_rate numeric)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    CASE
      WHEN p_days = 1 THEN TO_CHAR(created_at, 'HH24:00')
      ELSE TO_CHAR(created_at, 'YYYY-MM-DD')
    END as period,
    COUNT(*)::INTEGER as total_chats,
    COUNT(*) FILTER (WHERE student_rating >= 4)::INTEGER as helpful_count,
    COUNT(*) FILTER (WHERE student_rating <= 2)::INTEGER as unhelpful_count,
    (COUNT(*) FILTER (WHERE student_rating >= 4)::NUMERIC / NULLIF(COUNT(*) FILTER (WHERE student_rating IS NOT NULL), 0) * 100) as helpful_percentage,
    AVG(student_rating) as avg_rating,
    AVG(response_time_ms)::INTEGER as avg_response_time_ms,
    SUM(cost_usd) as total_cost,
    COUNT(*) FILTER (WHERE escalated_to_trainer = true)::INTEGER as escalation_count,
    (COUNT(*) FILTER (WHERE escalated_to_trainer = true)::NUMERIC / NULLIF(COUNT(*), 0) * 100) as escalation_rate
  FROM ai_mentor_chats
  WHERE created_at >= NOW() - (p_days || ' days')::INTERVAL
  GROUP BY period
  ORDER BY period DESC;
END;
$$;


--
-- Name: get_question_bank(uuid, text, text, text, boolean, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_question_bank(p_topic_id uuid DEFAULT NULL::uuid, p_question_type text DEFAULT NULL::text, p_difficulty text DEFAULT NULL::text, p_search_text text DEFAULT NULL::text, p_include_public boolean DEFAULT true, p_created_by uuid DEFAULT NULL::uuid) RETURNS TABLE(question_id uuid, topic_id uuid, question_text text, question_type text, difficulty text, points integer, is_public boolean, created_by uuid, created_by_name text, times_used bigint, unique_students bigint, avg_correct_percentage numeric, created_at timestamp with time zone, updated_at timestamp with time zone)
    LANGUAGE plpgsql STABLE
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    qbs.question_id,
    qbs.topic_id,
    qbs.question_text,
    qbs.question_type,
    qbs.difficulty,
    qbs.points,
    qbs.is_public,
    qbs.created_by,
    qbs.created_by_name,
    qbs.times_used,
    qbs.unique_students,
    qbs.avg_correct_percentage,
    qbs.created_at,
    qbs.updated_at
  FROM question_bank_stats qbs
  WHERE
    (p_topic_id IS NULL OR qbs.topic_id = p_topic_id) AND
    (p_question_type IS NULL OR qbs.question_type = p_question_type) AND
    (p_difficulty IS NULL OR qbs.difficulty = p_difficulty) AND
    (p_search_text IS NULL OR qbs.question_text ILIKE '%' || p_search_text || '%') AND
    (p_include_public = TRUE OR qbs.is_public = FALSE) AND
    (p_created_by IS NULL OR qbs.created_by = p_created_by)
  ORDER BY qbs.created_at DESC;
END;
$$;


--
-- Name: FUNCTION get_question_bank(p_topic_id uuid, p_question_type text, p_difficulty text, p_search_text text, p_include_public boolean, p_created_by uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_question_bank(p_topic_id uuid, p_question_type text, p_difficulty text, p_search_text text, p_include_public boolean, p_created_by uuid) IS 'Search and filter question bank with usage statistics';


--
-- Name: get_quiz_attempt_results(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_quiz_attempt_results(p_attempt_id uuid) RETURNS TABLE(attempt_id uuid, user_id uuid, topic_id uuid, attempt_number integer, score numeric, passed boolean, correct_answers integer, total_questions integer, started_at timestamp with time zone, submitted_at timestamp with time zone, time_taken_seconds integer, xp_earned integer, answers jsonb, questions jsonb)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_attempt RECORD;
  v_questions JSONB;
BEGIN
  -- Get attempt
  SELECT * INTO v_attempt
  FROM quiz_attempts
  WHERE id = p_attempt_id;

  IF v_attempt IS NULL THEN
    RAISE EXCEPTION 'Attempt not found';
  END IF;

  -- Get questions with correct answers
  SELECT jsonb_agg(
    jsonb_build_object(
      'id', qq.id,
      'question_text', qq.question_text,
      'question_type', qq.question_type,
      'options', qq.options,
      'correct_answers', qq.correct_answers,
      'explanation', qq.explanation,
      'points', qq.points,
      'difficulty', qq.difficulty,
      'code_language', qq.code_language
    ) ORDER BY qq.created_at
  ) INTO v_questions
  FROM quiz_questions qq
  WHERE qq.topic_id = v_attempt.topic_id;

  RETURN QUERY SELECT
    v_attempt.id,
    v_attempt.user_id,
    v_attempt.topic_id,
    v_attempt.attempt_number,
    v_attempt.score,
    v_attempt.passed,
    v_attempt.correct_answers,
    v_attempt.total_questions,
    v_attempt.started_at,
    v_attempt.submitted_at,
    v_attempt.time_taken_seconds,
    v_attempt.xp_earned,
    v_attempt.answers,
    v_questions;
END;
$$;


--
-- Name: get_quiz_questions(uuid, boolean); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_quiz_questions(p_topic_id uuid, p_randomize boolean DEFAULT false) RETURNS TABLE(id uuid, question_text text, question_type text, options jsonb, difficulty text, points integer, code_language text, randomized_options jsonb)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_randomize_options BOOLEAN;
BEGIN
  -- Get quiz settings
  SELECT qs.randomize_options INTO v_randomize_options
  FROM quiz_settings qs
  WHERE qs.topic_id = p_topic_id;

  -- Default to false if no settings
  v_randomize_options := COALESCE(v_randomize_options, FALSE);

  RETURN QUERY
  SELECT
    qq.id,
    qq.question_text,
    qq.question_type,
    qq.options,
    qq.difficulty,
    qq.points,
    qq.code_language,
    CASE
      WHEN v_randomize_options AND p_randomize THEN
        -- Randomize options order
        (SELECT jsonb_agg(elem ORDER BY random())
         FROM jsonb_array_elements(qq.options) elem)
      ELSE
        qq.options
    END AS randomized_options
  FROM quiz_questions qq
  WHERE qq.topic_id = p_topic_id
  ORDER BY
    CASE WHEN p_randomize THEN random() ELSE qq.created_at::text END;
END;
$$;


--
-- Name: get_reading_progress(uuid, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_reading_progress(p_user_id uuid, p_topic_id uuid) RETURNS TABLE(scroll_percentage integer, last_scroll_position integer, total_reading_time_seconds integer, current_page integer, total_pages integer, content_type text, session_count integer, last_read_at timestamp with time zone)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
    BEGIN
      RETURN QUERY
      SELECT
        rp.scroll_percentage,
        rp.last_scroll_position,
        rp.total_reading_time_seconds,
        rp.current_page,
        rp.total_pages,
        rp.content_type,
        rp.session_count,
        rp.last_read_at
      FROM reading_progress rp
      WHERE rp.user_id = p_user_id
        AND rp.topic_id = p_topic_id;
    END;
    $$;


--
-- Name: get_recruiter_commission_summary(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_recruiter_commission_summary(p_user_id uuid) RETURNS TABLE(total_projected numeric, total_active numeric, total_paid numeric, pending_count integer, active_count integer)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    COALESCE(SUM(CASE WHEN status = 'pending' THEN projected_commission ELSE 0 END), 0) as total_projected,
    COALESCE(SUM(CASE WHEN status = 'active' THEN projected_commission - COALESCE(actual_commission, 0) ELSE 0 END), 0) as total_active,
    COALESCE(SUM(actual_commission), 0) as total_paid,
    CAST(COUNT(*) FILTER (WHERE status = 'pending') AS INTEGER) as pending_count,
    CAST(COUNT(*) FILTER (WHERE status = 'active') AS INTEGER) as active_count
  FROM commissions
  WHERE user_id = p_user_id;
END;
$$;


--
-- Name: FUNCTION get_recruiter_commission_summary(p_user_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_recruiter_commission_summary(p_user_id uuid) IS 'Get commission summary for a recruiter';


--
-- Name: get_resume_stats(uuid, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_resume_stats(p_org_id uuid, p_user_id uuid DEFAULT NULL::uuid) RETURNS TABLE(total_resumes bigint, avg_quality_score numeric, total_interviews integer, total_placements bigint, avg_generation_time_ms integer)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    COUNT(*) AS total_resumes,
    ROUND(AVG(quality_score), 2) AS avg_quality_score,
    SUM(interview_count) AS total_interviews,
    COUNT(*) FILTER (WHERE placement_achieved = TRUE) AS total_placements,
    CAST(AVG(generation_latency_ms) AS INTEGER) AS avg_generation_time_ms
  FROM generated_resumes
  WHERE org_id = p_org_id
    AND (p_user_id IS NULL OR user_id = p_user_id);
END;
$$;


--
-- Name: FUNCTION get_resume_stats(p_org_id uuid, p_user_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_resume_stats(p_org_id uuid, p_user_id uuid) IS 'Get resume generation statistics for an org or specific user';


--
-- Name: get_screenshot_stats(uuid, timestamp with time zone, timestamp with time zone); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_screenshot_stats(p_user_id uuid, p_start_date timestamp with time zone, p_end_date timestamp with time zone) RETURNS TABLE(total_screenshots integer, analyzed_screenshots integer, top_activity text, total_hours double precision)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    COUNT(*)::INTEGER as total_screenshots,
    COUNT(*) FILTER (WHERE analyzed = true)::INTEGER as analyzed_screenshots,
    MODE() WITHIN GROUP (ORDER BY activity_category) as top_activity,
    (COUNT(*) * 30.0 / 3600.0)::FLOAT as total_hours -- 30 seconds per screenshot
  FROM employee_screenshots
  WHERE user_id = p_user_id
  AND captured_at BETWEEN p_start_date AND p_end_date
  AND deleted_at IS NULL;
END;
$$;


--
-- Name: get_sla_stats(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_sla_stats(p_org_id uuid) RETURNS TABLE(total_rules integer, active_rules integer, draft_rules integer, disabled_rules integer, pending_events integer, warning_events integer, breach_events integer, met_today integer, breached_today integer, compliance_rate numeric)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  WITH rule_counts AS (
    SELECT
      COUNT(*)::INTEGER as total,
      COUNT(*) FILTER (WHERE status = 'active')::INTEGER as active,
      COUNT(*) FILTER (WHERE status = 'draft')::INTEGER as draft,
      COUNT(*) FILTER (WHERE status = 'disabled')::INTEGER as disabled
    FROM sla_definitions
    WHERE org_id = p_org_id AND is_active = true
  ),
  event_counts AS (
    SELECT
      COUNT(*) FILTER (WHERE status = 'pending')::INTEGER as pending,
      COUNT(*) FILTER (WHERE status = 'warning')::INTEGER as warning,
      COUNT(*) FILTER (WHERE status IN ('breach', 'critical'))::INTEGER as breach,
      COUNT(*) FILTER (WHERE status = 'met' AND met_at >= CURRENT_DATE)::INTEGER as met_today,
      COUNT(*) FILTER (WHERE status IN ('breach', 'critical') AND updated_at >= CURRENT_DATE)::INTEGER as breached_today
    FROM sla_events
    WHERE org_id = p_org_id
  ),
  compliance AS (
    SELECT
      ROUND(
        100.0 * COUNT(*) FILTER (WHERE status = 'met')
        / NULLIF(COUNT(*) FILTER (WHERE status IN ('met', 'breach', 'critical')), 0),
        1
      )::NUMERIC as rate
    FROM sla_events
    WHERE org_id = p_org_id
      AND updated_at >= CURRENT_DATE - INTERVAL '30 days'
  )
  SELECT
    rc.total, rc.active, rc.draft, rc.disabled,
    ec.pending, ec.warning, ec.breach, ec.met_today, ec.breached_today,
    COALESCE(c.rate, 0)
  FROM rule_counts rc, event_counts ec, compliance c;
END;
$$;


--
-- Name: FUNCTION get_sla_stats(p_org_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_sla_stats(p_org_id uuid) IS 'Returns SLA dashboard statistics for an organization';


--
-- Name: get_submissions_for_peer_review(uuid, uuid, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_submissions_for_peer_review(p_reviewer_id uuid, p_course_id uuid, p_limit integer DEFAULT 10) RETURNS TABLE(id uuid, user_id uuid, student_name text, course_title text, repository_url text, demo_video_url text, description text, submitted_at timestamp with time zone, peer_review_count integer, already_reviewed boolean)
    LANGUAGE plpgsql
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    cs.id,
    cs.user_id,
    up.full_name as student_name,
    c.title as course_title,
    cs.repository_url,
    cs.demo_video_url,
    cs.description,
    cs.submitted_at,
    cs.peer_review_count,
    EXISTS (
      SELECT 1 FROM peer_reviews pr
      WHERE pr.submission_id = cs.id
      AND pr.reviewer_id = p_reviewer_id
    ) as already_reviewed
  FROM capstone_submissions cs
  JOIN user_profiles up ON cs.user_id = up.id
  JOIN courses c ON cs.course_id = c.id
  WHERE
    cs.course_id = p_course_id
    AND cs.user_id != p_reviewer_id -- Don't show own submissions
    AND cs.status IN ('pending', 'peer_review')
  ORDER BY cs.peer_review_count ASC, cs.submitted_at ASC
  LIMIT p_limit;
END;
$$;


--
-- Name: get_today_standup(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_today_standup(p_org_id uuid) RETURNS jsonb
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_standup JSONB;
BEGIN
  SELECT jsonb_build_object(
    'id', id,
    'date', standup_date,
    'report', report,
    'pillar_summaries', pillar_summaries,
    'cross_pollination_insights', cross_pollination_insights,
    'escalations', escalations,
    'organism_health_score', organism_health_score,
    'created_at', created_at
  ) INTO v_standup
  FROM org_standups
  WHERE org_id = p_org_id AND standup_date = CURRENT_DATE;

  RETURN v_standup;
END;
$$;


--
-- Name: FUNCTION get_today_standup(p_org_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_today_standup(p_org_id uuid) IS 'Get todays standup report if exists';


--
-- Name: get_topic_assets(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_topic_assets(p_topic_id uuid) RETURNS TABLE(asset_id uuid, filename text, file_type text, file_size_bytes bigint, cdn_url text, uploaded_at timestamp with time zone)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    id,
    content_assets.filename,
    content_assets.file_type,
    content_assets.file_size_bytes,
    content_assets.cdn_url,
    content_assets.uploaded_at
  FROM content_assets
  WHERE topic_id = p_topic_id
    AND is_current = true
  ORDER BY uploaded_at DESC;
END;
$$;


--
-- Name: FUNCTION get_topic_assets(p_topic_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_topic_assets(p_topic_id uuid) IS 'Returns all current assets for a topic';


--
-- Name: get_trainer_responses(uuid, boolean); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_trainer_responses(p_escalation_id uuid, p_include_internal boolean DEFAULT false) RETURNS TABLE(response_id uuid, trainer_id uuid, trainer_name text, message text, is_internal_note boolean, created_at timestamp with time zone)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    tr.id,
    tr.trainer_id,
    u.full_name,
    tr.message,
    tr.is_internal_note,
    tr.created_at
  FROM trainer_responses tr
  JOIN user_profiles u ON u.id = tr.trainer_id
  WHERE tr.escalation_id = p_escalation_id
  AND (p_include_internal = true OR tr.is_internal_note = false)
  ORDER BY tr.created_at ASC;
END;
$$;


--
-- Name: get_twin_events_for_role(uuid, text, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_twin_events_for_role(p_org_id uuid, p_role text, p_limit integer DEFAULT 50) RETURNS TABLE(id uuid, source_role text, event_type text, payload jsonb, priority text, created_at timestamp with time zone)
    LANGUAGE plpgsql
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    te.id,
    te.source_role,
    te.event_type,
    te.payload,
    te.priority,
    te.created_at
  FROM twin_events te
  WHERE te.org_id = p_org_id
    AND te.processed = FALSE
    AND (te.target_role = p_role OR te.target_role IS NULL)
    AND (te.expires_at IS NULL OR te.expires_at > NOW())
  ORDER BY
    CASE te.priority
      WHEN 'critical' THEN 1
      WHEN 'high' THEN 2
      WHEN 'medium' THEN 3
      WHEN 'low' THEN 4
    END,
    te.created_at DESC
  LIMIT p_limit;
END;
$$;


--
-- Name: FUNCTION get_twin_events_for_role(p_org_id uuid, p_role text, p_limit integer); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_twin_events_for_role(p_org_id uuid, p_role text, p_limit integer) IS 'Get unprocessed events for a specific role';


--
-- Name: get_twin_interaction_count(uuid, text, date); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_twin_interaction_count(p_user_id uuid, p_interaction_type text, p_date date DEFAULT CURRENT_DATE) RETURNS integer
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_count INTEGER;
BEGIN
  SELECT COUNT(*) INTO v_count
  FROM employee_twin_interactions
  WHERE user_id = p_user_id
    AND interaction_type = p_interaction_type
    AND DATE(created_at) = p_date;

  RETURN v_count;
END;
$$;


--
-- Name: FUNCTION get_twin_interaction_count(p_user_id uuid, p_interaction_type text, p_date date); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_twin_interaction_count(p_user_id uuid, p_interaction_type text, p_date date) IS 'Count interactions by type for a user on a given date';


--
-- Name: get_twin_preferences(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_twin_preferences(p_user_id uuid) RETURNS TABLE(enable_morning_briefing boolean, morning_briefing_time time without time zone, enable_proactive_suggestions boolean, suggestion_frequency integer, notify_via_ui boolean, notify_via_slack boolean, notify_via_email boolean, use_productivity_data boolean, use_activity_data boolean)
    LANGUAGE plpgsql
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    tp.enable_morning_briefing,
    tp.morning_briefing_time,
    tp.enable_proactive_suggestions,
    tp.suggestion_frequency,
    tp.notify_via_ui,
    tp.notify_via_slack,
    tp.notify_via_email,
    tp.use_productivity_data,
    tp.use_activity_data
  FROM twin_preferences tp
  WHERE tp.user_id = p_user_id;

  -- If no preferences exist, return defaults
  IF NOT FOUND THEN
    INSERT INTO twin_preferences (user_id) VALUES (p_user_id);
    RETURN QUERY SELECT * FROM get_twin_preferences(p_user_id);
  END IF;
END;
$$;


--
-- Name: FUNCTION get_twin_preferences(p_user_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_twin_preferences(p_user_id uuid) IS 'Get or initialize user twin preferences';


--
-- Name: get_user_ai_sessions(uuid, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_user_ai_sessions(p_user_id uuid, p_limit integer DEFAULT 10) RETURNS TABLE(id uuid, topic_id uuid, course_id uuid, title text, message_count integer, total_tokens integer, total_cost_usd numeric, started_at timestamp with time zone, last_message_at timestamp with time zone)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    s.id,
    s.topic_id,
    s.course_id,
    s.title,
    s.message_count,
    s.total_tokens,
    s.total_cost_usd,
    s.started_at,
    s.last_message_at
  FROM ai_mentor_sessions s
  WHERE s.user_id = p_user_id
  AND s.ended_at IS NULL
  ORDER BY s.last_message_at DESC
  LIMIT p_limit;
END;
$$;


--
-- Name: get_user_available_roles(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_user_available_roles() RETURNS TABLE(role_name text, role_display_name text, role_description text)
    LANGUAGE plpgsql STABLE SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    r.name,
    r.display_name,
    r.description
  FROM user_roles ur
  JOIN roles r ON ur.role_id = r.id
  WHERE ur.user_id = auth.uid()
  ORDER BY r.display_order ASC, r.display_name ASC;
END;
$$;


--
-- Name: FUNCTION get_user_available_roles(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_user_available_roles() IS 'Get list of roles user can switch to';


--
-- Name: get_user_badges(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_user_badges(p_user_id uuid) RETURNS TABLE(badge_id uuid, slug text, name text, description text, icon_url text, rarity text, xp_reward integer, earned_at timestamp with time zone, is_new boolean, share_count integer)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    b.id as badge_id,
    b.slug,
    b.name,
    b.description,
    b.icon_url,
    b.rarity,
    b.xp_reward,
    ub.earned_at,
    ub.is_new,
    ub.share_count
  FROM user_badges ub
  JOIN badges b ON b.id = ub.badge_id
  WHERE ub.user_id = p_user_id
  ORDER BY ub.earned_at DESC;
END;
$$;


--
-- Name: get_user_cohort_rank(uuid, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_user_cohort_rank(p_user_id uuid, p_course_id uuid) RETURNS TABLE(rank bigint, cohort_name text, total_xp integer, cohort_percentile numeric, cohort_size bigint)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    lch.rank,
    lch.cohort_name,
    lch.total_xp,
    lch.cohort_percentile,
    lch.cohort_size
  FROM leaderboard_by_cohort lch
  WHERE lch.user_id = p_user_id
    AND lch.course_id = p_course_id;
END;
$$;


--
-- Name: get_user_course_rank(uuid, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_user_course_rank(p_user_id uuid, p_course_id uuid) RETURNS TABLE(rank bigint, course_xp integer, percentile numeric, total_students bigint)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    lc.rank,
    lc.course_xp,
    lc.percentile,
    lc.total_students
  FROM leaderboard_by_course lc
  WHERE lc.user_id = p_user_id
    AND lc.course_id = p_course_id;
END;
$$;


--
-- Name: get_user_global_rank(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_user_global_rank(p_user_id uuid) RETURNS TABLE(rank bigint, total_xp integer, percentile numeric)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    lg.rank,
    lg.total_xp,
    ROUND((1 - (lg.rank::numeric / total_count.count::numeric)) * 100, 1) as percentile
  FROM leaderboard_global lg
  CROSS JOIN (SELECT COUNT(*) as count FROM leaderboard_global) total_count
  WHERE lg.user_id = p_user_id;
END;
$$;


--
-- Name: get_user_leaderboard_summary(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_user_leaderboard_summary(p_user_id uuid) RETURNS TABLE(global_rank bigint, global_percentile numeric, total_xp integer, weekly_rank bigint, weekly_xp bigint, is_all_time_top100 boolean, leaderboard_visible boolean)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    lg.rank as global_rank,
    ROUND((1 - (lg.rank::numeric / total.count::numeric)) * 100, 1) as global_percentile,
    lg.total_xp,
    lw.rank as weekly_rank,
    lw.weekly_xp,
    EXISTS(SELECT 1 FROM leaderboard_all_time lat WHERE lat.user_id = p_user_id) as is_all_time_top100,
    up.leaderboard_visible
  FROM user_profiles up
  LEFT JOIN leaderboard_global lg ON lg.user_id = p_user_id
  LEFT JOIN LATERAL (
    SELECT rank, weekly_xp
    FROM leaderboard_weekly
    WHERE user_id = p_user_id
      AND is_current_week = true
    LIMIT 1
  ) lw ON true
  CROSS JOIN (SELECT COUNT(*) as count FROM leaderboard_global) total
  WHERE up.id = p_user_id;
END;
$$;


--
-- Name: get_user_level_info(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_user_level_info(p_user_id uuid) RETURNS TABLE(current_level integer, current_xp integer, xp_to_next_level integer, current_level_title text, next_level integer, next_level_title text, progress_percent integer)
    LANGUAGE plpgsql
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    ul.current_level,
    ul.current_xp,
    ul.xp_to_next_level,
    ld_current.title AS current_level_title,
    (ul.current_level + 1)::INTEGER AS next_level,
    ld_next.title AS next_level_title,
    ROUND((ul.current_xp::DECIMAL / ul.xp_to_next_level::DECIMAL) * 100)::INTEGER AS progress_percent
  FROM user_levels ul
  LEFT JOIN level_definitions ld_current ON ul.current_level = ld_current.level
  LEFT JOIN level_definitions ld_next ON (ul.current_level + 1) = ld_next.level
  WHERE ul.user_id = p_user_id;
END;
$$;


--
-- Name: get_user_permissions(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_user_permissions(p_user_id uuid) RETURNS TABLE(resource text, action text, scope text, via_role text)
    LANGUAGE plpgsql STABLE
    AS $$
BEGIN
  RETURN QUERY
  SELECT DISTINCT
    p.resource,
    p.action,
    p.scope,
    r.name AS via_role
  FROM user_roles ur
  JOIN roles r ON ur.role_id = r.id
  JOIN role_permissions rp ON r.id = rp.role_id
  JOIN permissions p ON rp.permission_id = p.id
  WHERE ur.user_id = p_user_id
    AND ur.deleted_at IS NULL
    AND (ur.expires_at IS NULL OR ur.expires_at > NOW())
    AND r.deleted_at IS NULL
    AND p.deleted_at IS NULL
  ORDER BY p.resource, p.action, p.scope;
END;
$$;


--
-- Name: FUNCTION get_user_permissions(p_user_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_user_permissions(p_user_id uuid) IS 'Get all permissions for a user across all their roles.';


--
-- Name: get_user_quiz_attempts(uuid, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_user_quiz_attempts(p_user_id uuid, p_topic_id uuid) RETURNS TABLE(id uuid, attempt_number integer, started_at timestamp with time zone, submitted_at timestamp with time zone, score numeric, passed boolean, correct_answers integer, total_questions integer, time_taken_seconds integer, xp_earned integer)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    qa.id,
    qa.attempt_number,
    qa.started_at,
    qa.submitted_at,
    qa.score,
    qa.passed,
    qa.correct_answers,
    qa.total_questions,
    qa.time_taken_seconds,
    qa.xp_earned
  FROM quiz_attempts qa
  WHERE qa.user_id = p_user_id
    AND qa.topic_id = p_topic_id
  ORDER BY qa.attempt_number DESC;
END;
$$;


--
-- Name: get_user_reading_stats(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_user_reading_stats(p_user_id uuid) RETURNS TABLE(total_articles_read integer, total_reading_time_seconds integer, total_articles_completed integer, avg_scroll_percentage numeric)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
    BEGIN
      RETURN QUERY
      SELECT
        COUNT(*)::INTEGER AS total_articles_read,
        SUM(rp.total_reading_time_seconds)::INTEGER AS total_reading_time_seconds,
        COUNT(*) FILTER (WHERE rp.scroll_percentage >= 90)::INTEGER AS total_articles_completed,
        ROUND(AVG(rp.scroll_percentage), 2) AS avg_scroll_percentage
      FROM reading_progress rp
      WHERE rp.user_id = p_user_id;
    END;
    $$;


--
-- Name: get_user_total_xp(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_user_total_xp(p_user_id uuid) RETURNS integer
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_total_xp INTEGER;
BEGIN
  SELECT COALESCE(total_xp, 0) INTO v_total_xp
  FROM user_xp_totals
  WHERE user_id = p_user_id;

  RETURN COALESCE(v_total_xp, 0);
END;
$$;


--
-- Name: FUNCTION get_user_total_xp(p_user_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.get_user_total_xp(p_user_id uuid) IS 'Returns total XP earned by a user';


--
-- Name: get_user_watch_stats(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_user_watch_stats(p_user_id uuid) RETURNS TABLE(total_videos_watched integer, total_watch_time_seconds integer, total_videos_completed integer, avg_completion_percentage numeric)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
    BEGIN
      RETURN QUERY
      SELECT
        COUNT(*)::INTEGER AS total_videos_watched,
        SUM(vp.total_watch_time_seconds)::INTEGER AS total_watch_time_seconds,
        COUNT(*) FILTER (WHERE vp.completion_percentage >= 90)::INTEGER AS total_videos_completed,
        ROUND(AVG(vp.completion_percentage), 2) AS avg_completion_percentage
      FROM video_progress vp
      WHERE vp.user_id = p_user_id;
    END;
    $$;


--
-- Name: get_user_weekly_performance(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_user_weekly_performance(p_user_id uuid) RETURNS TABLE(week_label text, weekly_xp bigint, rank bigint, is_current_week boolean)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    lw.week_label,
    lw.weekly_xp,
    lw.rank,
    lw.is_current_week
  FROM leaderboard_weekly lw
  WHERE lw.user_id = p_user_id
    AND lw.week_start >= CURRENT_DATE - INTERVAL '5 weeks'
  ORDER BY lw.week_start DESC;
END;
$$;


--
-- Name: get_video_progress(uuid, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_video_progress(p_user_id uuid, p_topic_id uuid) RETURNS TABLE(last_position_seconds integer, total_watch_time_seconds integer, completion_percentage integer, session_count integer, last_watched_at timestamp with time zone)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
    BEGIN
      RETURN QUERY
      SELECT
        vp.last_position_seconds,
        vp.total_watch_time_seconds,
        vp.completion_percentage,
        vp.session_count,
        vp.last_watched_at
      FROM video_progress vp
      WHERE vp.user_id = p_user_id
        AND vp.topic_id = p_topic_id;
    END;
    $$;


--
-- Name: get_webhook_stats(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_webhook_stats(p_org_id uuid) RETURNS TABLE(total_webhooks bigint, active_webhooks bigint, total_deliveries bigint, successful_deliveries bigint, failed_deliveries bigint, dlq_count bigint)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    (SELECT COUNT(*) FROM webhooks WHERE org_id = p_org_id AND deleted_at IS NULL) as total_webhooks,
    (SELECT COUNT(*) FROM webhooks WHERE org_id = p_org_id AND status = 'active' AND deleted_at IS NULL) as active_webhooks,
    (SELECT COUNT(*) FROM webhook_deliveries WHERE org_id = p_org_id) as total_deliveries,
    (SELECT COUNT(*) FROM webhook_deliveries WHERE org_id = p_org_id AND status = 'success') as successful_deliveries,
    (SELECT COUNT(*) FROM webhook_deliveries WHERE org_id = p_org_id AND status = 'failed') as failed_deliveries,
    (SELECT COUNT(*) FROM webhook_deliveries WHERE org_id = p_org_id AND status = 'dlq') as dlq_count;
END;
$$;


--
-- Name: grade_capstone(uuid, uuid, numeric, text, jsonb, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.grade_capstone(p_submission_id uuid, p_grader_id uuid, p_grade numeric, p_feedback text, p_rubric_scores jsonb DEFAULT NULL::jsonb, p_status text DEFAULT 'passed'::text) RETURNS boolean
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_enrollment_id UUID;
  v_user_id UUID;
BEGIN
  -- Validate status
  IF p_status NOT IN ('passed', 'failed', 'revision_requested') THEN
    RAISE EXCEPTION 'Invalid status. Must be: passed, failed, or revision_requested';
  END IF;

  -- Update submission
  UPDATE capstone_submissions
  SET
    graded_by = p_grader_id,
    graded_at = NOW(),
    grade = p_grade,
    feedback = p_feedback,
    rubric_scores = p_rubric_scores,
    status = p_status,
    updated_at = NOW()
  WHERE id = p_submission_id
  RETURNING enrollment_id, user_id INTO v_enrollment_id, v_user_id;

  IF NOT FOUND THEN
    RAISE EXCEPTION 'Submission not found';
  END IF;

  -- If passed, check graduation eligibility
  IF p_status = 'passed' THEN
    -- Award XP for capstone completion
    INSERT INTO xp_transactions (
      user_id,
      enrollment_id,
      amount,
      reason,
      source_type,
      source_id
    ) VALUES (
      v_user_id,
      v_enrollment_id,
      100, -- Capstone XP reward
      'Capstone project passed',
      'capstone',
      p_submission_id
    );

    -- Check if eligible for graduation
    IF check_graduation_eligibility(v_enrollment_id) THEN
      PERFORM trigger_graduation(v_enrollment_id);
    END IF;
  END IF;

  -- Log event
  PERFORM publish_event(
    'capstone.graded',
    p_submission_id,
    jsonb_build_object(
      'user_id', v_user_id,
      'enrollment_id', v_enrollment_id,
      'grade', p_grade,
      'status', p_status,
      'grader_id', p_grader_id
    ),
    p_grader_id
  );

  RETURN TRUE;
END;
$$;


--
-- Name: grant_role_to_user(uuid, text, uuid, boolean, timestamp with time zone); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.grant_role_to_user(p_user_id uuid, p_role_name text, p_granted_by uuid, p_is_primary boolean DEFAULT false, p_expires_at timestamp with time zone DEFAULT NULL::timestamp with time zone) RETURNS boolean
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_role_id UUID;
BEGIN
  -- Get role ID
  SELECT id INTO v_role_id
  FROM roles
  WHERE name = p_role_name AND deleted_at IS NULL;

  IF v_role_id IS NULL THEN
    RAISE EXCEPTION 'Role % does not exist', p_role_name;
  END IF;

  -- If this is primary role, unset any existing primary roles
  IF p_is_primary THEN
    UPDATE user_roles
    SET is_primary = FALSE
    WHERE user_id = p_user_id AND deleted_at IS NULL;
  END IF;

  -- Insert or update user_role
  INSERT INTO user_roles (user_id, role_id, assigned_by, is_primary, expires_at)
  VALUES (p_user_id, v_role_id, p_granted_by, p_is_primary, p_expires_at)
  ON CONFLICT (user_id, role_id)
  DO UPDATE SET
    deleted_at = NULL, -- Un-soft-delete if previously removed
    is_primary = EXCLUDED.is_primary,
    expires_at = EXCLUDED.expires_at,
    assigned_by = EXCLUDED.assigned_by,
    assigned_at = NOW();

  RETURN TRUE;
END;
$$;


--
-- Name: handle_task_completion(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.handle_task_completion() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  IF NEW.completed = true AND OLD.completed = false THEN
    NEW.completed_at = NOW();
  ELSIF NEW.completed = false AND OLD.completed = true THEN
    NEW.completed_at = NULL;
    NEW.completed_by = NULL;
  END IF;
  RETURN NEW;
END;
$$;


--
-- Name: has_edit_access(uuid, text, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.has_edit_access(p_user_id uuid, p_entity_type text, p_entity_id uuid) RETURNS boolean
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_has_access BOOLEAN;
BEGIN
  SELECT EXISTS (
    SELECT 1 FROM object_owners
    WHERE entity_type = p_entity_type
      AND entity_id = p_entity_id
      AND user_id = p_user_id
      AND permission = 'edit'
  ) INTO v_has_access;
  
  RETURN v_has_access;
END;
$$;


--
-- Name: has_role(uuid, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.has_role(user_id uuid, role_name text) RETURNS boolean
    LANGUAGE sql STABLE
    AS $$ SELECT EXISTS (SELECT 1 FROM public.user_roles ur JOIN public.roles r ON r.id = ur.role_id WHERE ur.user_id = user_id AND r.name = role_name); $$;


--
-- Name: increment_badge_progress(uuid, text, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.increment_badge_progress(p_user_id uuid, p_trigger_type text, p_increment integer DEFAULT 1) RETURNS integer
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_new_value INTEGER;
BEGIN
  -- Update or create progress for all badges of this trigger type
  UPDATE badge_progress
  SET
    current_value = current_value + p_increment,
    last_updated = NOW()
  WHERE user_id = p_user_id
  AND badge_id IN (
    SELECT id FROM badges WHERE trigger_type = p_trigger_type
  );

  -- Get the new max value for this trigger type
  SELECT MAX(current_value) INTO v_new_value
  FROM badge_progress
  WHERE user_id = p_user_id
  AND badge_id IN (
    SELECT id FROM badges WHERE trigger_type = p_trigger_type
  );

  RETURN COALESCE(v_new_value, p_increment);
END;
$$;


--
-- Name: increment_rate_limits(uuid, integer, numeric); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.increment_rate_limits(p_user_id uuid, p_tokens_used integer, p_cost_usd numeric) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  UPDATE ai_mentor_rate_limits
  SET
    hourly_count = hourly_count + 1,
    daily_count = daily_count + 1,
    monthly_count = monthly_count + 1,
    monthly_cost_usd = monthly_cost_usd + p_cost_usd,
    updated_at = NOW()
  WHERE user_id = p_user_id;

  -- If record doesn't exist, create it
  IF NOT FOUND THEN
    INSERT INTO ai_mentor_rate_limits (
      user_id,
      hourly_count,
      daily_count,
      monthly_count,
      monthly_cost_usd,
      hourly_reset_at,
      daily_reset_at,
      monthly_reset_at
    ) VALUES (
      p_user_id,
      1,
      1,
      1,
      p_cost_usd,
      NOW() + INTERVAL '1 hour',
      NOW() + INTERVAL '1 day',
      NOW() + INTERVAL '1 month'
    );
  END IF;
END;
$$;


--
-- Name: increment_sequence_template_usage(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.increment_sequence_template_usage() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  -- Increment usage count for newly added templates
  IF TG_OP = 'INSERT' THEN
    UPDATE sequence_templates 
    SET usage_count = usage_count + 1, updated_at = now()
    WHERE id = NEW.sequence_template_id;
  END IF;
  
  -- Decrement usage count when removed
  IF TG_OP = 'DELETE' THEN
    UPDATE sequence_templates 
    SET usage_count = GREATEST(0, usage_count - 1), updated_at = now()
    WHERE id = OLD.sequence_template_id;
  END IF;
  
  RETURN COALESCE(NEW, OLD);
END;
$$;


--
-- Name: is_topic_unlocked(uuid, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.is_topic_unlocked(p_user_id uuid, p_topic_id uuid) RETURNS boolean
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_prerequisite_topics UUID[];
  v_completed_topics UUID[];
BEGIN
  SELECT prerequisite_topic_ids INTO v_prerequisite_topics
  FROM module_topics
  WHERE id = p_topic_id;

  IF v_prerequisite_topics IS NULL OR array_length(v_prerequisite_topics, 1) = 0 THEN
    RETURN true;
  END IF;

  SELECT ARRAY_AGG(topic_id) INTO v_completed_topics
  FROM topic_completions
  WHERE user_id = p_user_id;

  RETURN v_prerequisite_topics <@ COALESCE(v_completed_topics, ARRAY[]::UUID[]);
END;
$$;


--
-- Name: FUNCTION is_topic_unlocked(p_user_id uuid, p_topic_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.is_topic_unlocked(p_user_id uuid, p_topic_id uuid) IS 'Checks if a topic is unlocked for a user based on prerequisites';


--
-- Name: log_audit_event(text, text, uuid, uuid, jsonb, jsonb, jsonb, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.log_audit_event(p_table_name text, p_action text, p_record_id uuid, p_user_id uuid, p_old_values jsonb DEFAULT NULL::jsonb, p_new_values jsonb DEFAULT NULL::jsonb, p_metadata jsonb DEFAULT '{}'::jsonb, p_severity text DEFAULT 'info'::text) RETURNS uuid
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_audit_id UUID;
  v_user_email TEXT;
  v_changed_fields TEXT[];
BEGIN
  -- Get user email for denormalization
  SELECT email INTO v_user_email
  FROM user_profiles
  WHERE id = p_user_id;

  -- Calculate changed fields (for UPDATE actions)
  IF p_action = 'UPDATE' AND p_old_values IS NOT NULL AND p_new_values IS NOT NULL THEN
    SELECT ARRAY_AGG(key)
    INTO v_changed_fields
    FROM jsonb_each(p_new_values)
    WHERE value != COALESCE(p_old_values->key, 'null'::jsonb);
  END IF;

  -- Insert audit log
  INSERT INTO audit_logs (
    table_name,
    action,
    record_id,
    user_id,
    user_email,
    old_values,
    new_values,
    changed_fields,
    metadata,
    severity
  ) VALUES (
    p_table_name,
    p_action,
    p_record_id,
    p_user_id,
    v_user_email,
    p_old_values,
    p_new_values,
    v_changed_fields,
    p_metadata,
    p_severity
  ) RETURNING id INTO v_audit_id;

  RETURN v_audit_id;
END;
$$;


--
-- Name: FUNCTION log_audit_event(p_table_name text, p_action text, p_record_id uuid, p_user_id uuid, p_old_values jsonb, p_new_values jsonb, p_metadata jsonb, p_severity text); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.log_audit_event(p_table_name text, p_action text, p_record_id uuid, p_user_id uuid, p_old_values jsonb, p_new_values jsonb, p_metadata jsonb, p_severity text) IS 'Helper function to log audit events programmatically.';


--
-- Name: log_deal_stage_change(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.log_deal_stage_change() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  -- Only log if stage actually changed
  IF OLD.stage IS DISTINCT FROM NEW.stage THEN
    -- Close out the previous stage entry
    UPDATE deal_stages_history
    SET exited_at = NOW(),
        duration_days = EXTRACT(DAY FROM (NOW() - entered_at))
    WHERE deal_id = NEW.id
      AND exited_at IS NULL;

    -- Insert new stage entry
    INSERT INTO deal_stages_history (
      deal_id,
      stage,
      previous_stage,
      entered_at,
      changed_by
    ) VALUES (
      NEW.id,
      NEW.stage,
      OLD.stage,
      NOW(),
      NEW.updated_by
    );

    -- Update last activity
    NEW.last_activity_at := NOW();
  END IF;

  RETURN NEW;
END;
$$;


--
-- Name: log_intervention_status_change(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.log_intervention_status_change() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  IF OLD.status IS DISTINCT FROM NEW.status THEN
    INSERT INTO audit_logs (
      event_type,
      table_name,
      record_id,
      user_id,
      old_values,
      new_values,
      metadata
    ) VALUES (
      'intervention.status_changed',
      'student_interventions',
      NEW.id,
      auth.uid(),
      jsonb_build_object('status', OLD.status),
      jsonb_build_object('status', NEW.status),
      jsonb_build_object(
        'student_id', NEW.student_id,
        'enrollment_id', NEW.enrollment_id,
        'from_status', OLD.status,
        'to_status', NEW.status
      )
    );
  END IF;

  RETURN NEW;
END;
$$;


--
-- Name: log_raci_change(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.log_raci_change() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  IF TG_OP = 'INSERT' THEN
    INSERT INTO raci_change_log (
      org_id, object_owner_id, entity_type, entity_id,
      change_type, new_role, new_user_id, new_permission, changed_by
    ) VALUES (
      NEW.org_id, NEW.id, NEW.entity_type, NEW.entity_id,
      'assigned', NEW.role, NEW.user_id, NEW.permission, NEW.assigned_by
    );
  ELSIF TG_OP = 'UPDATE' THEN
    IF OLD.role != NEW.role OR OLD.permission != NEW.permission OR OLD.user_id != NEW.user_id THEN
      INSERT INTO raci_change_log (
        org_id, object_owner_id, entity_type, entity_id,
        change_type, previous_role, new_role, previous_user_id, new_user_id,
        previous_permission, new_permission, changed_by
      ) VALUES (
        NEW.org_id, NEW.id, NEW.entity_type, NEW.entity_id,
        CASE 
          WHEN OLD.user_id != NEW.user_id THEN 'transferred'
          WHEN OLD.role != NEW.role THEN 'role_changed'
          ELSE 'permission_changed'
        END,
        OLD.role, NEW.role, OLD.user_id, NEW.user_id,
        OLD.permission, NEW.permission, NEW.assigned_by
      );
    END IF;
  ELSIF TG_OP = 'DELETE' THEN
    INSERT INTO raci_change_log (
      org_id, entity_type, entity_id,
      change_type, previous_role, previous_user_id, previous_permission
    ) VALUES (
      OLD.org_id, OLD.entity_type, OLD.entity_id,
      'removed', OLD.role, OLD.user_id, OLD.permission
    );
  END IF;
  
  RETURN COALESCE(NEW, OLD);
END;
$$;


--
-- Name: mark_badge_viewed(uuid, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.mark_badge_viewed(p_user_id uuid, p_badge_id uuid) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  UPDATE user_badges
  SET
    viewed_at = NOW(),
    is_new = false
  WHERE user_id = p_user_id
  AND badge_id = p_badge_id
  AND viewed_at IS NULL;
END;
$$;


--
-- Name: mark_enrollment_at_risk(uuid, text, text[]); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.mark_enrollment_at_risk(p_enrollment_id uuid, p_risk_level text, p_risk_reasons text[]) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  UPDATE student_enrollments
  SET
    is_at_risk = TRUE,
    at_risk_since = COALESCE(at_risk_since, NOW()),
    risk_level = p_risk_level,
    risk_reasons = p_risk_reasons,
    updated_at = NOW()
  WHERE id = p_enrollment_id;
END;
$$;


--
-- Name: mark_event_completed(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.mark_event_completed(p_event_id uuid) RETURNS boolean
    LANGUAGE plpgsql
    AS $$
BEGIN
  UPDATE events
  SET
    status = 'completed',
    processed_at = NOW()
  WHERE id = p_event_id
    AND status != 'completed';

  RETURN FOUND;
END;
$$;


--
-- Name: mark_event_failed(uuid, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.mark_event_failed(p_event_id uuid, p_error_message text) RETURNS boolean
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_retry_count INTEGER;
  v_max_retries INTEGER;
  v_next_retry_at TIMESTAMPTZ;
BEGIN
  -- Get current retry count and max retries
  SELECT retry_count, max_retries
  INTO v_retry_count, v_max_retries
  FROM events
  WHERE id = p_event_id;

  -- Calculate next retry time (exponential backoff: 2^retry_count minutes)
  v_next_retry_at := NOW() + (POWER(2, v_retry_count + 1) || ' minutes')::INTERVAL;

  -- Update event
  IF v_retry_count < v_max_retries THEN
    -- Still have retries left
    UPDATE events
    SET
      status = 'failed',
      retry_count = retry_count + 1,
      next_retry_at = v_next_retry_at,
      error_message = p_error_message
    WHERE id = p_event_id;
  ELSE
    -- Exhausted retries, move to dead letter queue
    UPDATE events
    SET
      status = 'dead_letter',
      failed_at = NOW(),
      error_message = p_error_message
    WHERE id = p_event_id;
  END IF;

  RETURN FOUND;
END;
$$;


--
-- Name: mark_job_completed(uuid, jsonb); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.mark_job_completed(p_job_id uuid, p_result jsonb DEFAULT NULL::jsonb) RETURNS boolean
    LANGUAGE plpgsql
    AS $$
BEGIN
  UPDATE background_jobs
  SET
    status = 'completed',
    completed_at = NOW(),
    result = p_result,
    updated_at = NOW()
  WHERE id = p_job_id;

  RETURN FOUND;
END;
$$;


--
-- Name: FUNCTION mark_job_completed(p_job_id uuid, p_result jsonb); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.mark_job_completed(p_job_id uuid, p_result jsonb) IS 'Mark a job as completed with optional result';


--
-- Name: mark_job_failed(uuid, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.mark_job_failed(p_job_id uuid, p_error_message text) RETURNS boolean
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_attempts INTEGER;
  v_max_attempts INTEGER;
BEGIN
  SELECT attempts, max_attempts
  INTO v_attempts, v_max_attempts
  FROM background_jobs
  WHERE id = p_job_id;

  UPDATE background_jobs
  SET
    status = CASE
      WHEN v_attempts >= v_max_attempts THEN 'failed' -- Permanently failed
      ELSE 'pending' -- Retry
    END,
    error_message = p_error_message,
    updated_at = NOW()
  WHERE id = p_job_id;

  RETURN FOUND;
END;
$$;


--
-- Name: FUNCTION mark_job_failed(p_job_id uuid, p_error_message text); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.mark_job_failed(p_job_id uuid, p_error_message text) IS 'Mark a job as failed (will retry if attempts < max_attempts)';


--
-- Name: mark_twin_event_processed(uuid, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.mark_twin_event_processed(p_event_id uuid, p_processed_by uuid DEFAULT NULL::uuid) RETURNS boolean
    LANGUAGE plpgsql
    AS $$
BEGIN
  UPDATE twin_events
  SET
    processed = TRUE,
    processed_at = NOW(),
    processed_by = COALESCE(p_processed_by, auth.uid())
  WHERE id = p_event_id;

  RETURN FOUND;
END;
$$;


--
-- Name: FUNCTION mark_twin_event_processed(p_event_id uuid, p_processed_by uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.mark_twin_event_processed(p_event_id uuid, p_processed_by uuid) IS 'Mark an event as processed';


--
-- Name: notify_mentioned_users(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.notify_mentioned_users() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
DECLARE
  mentioned_user UUID;
BEGIN
  IF NEW.mentioned_user_ids IS NOT NULL AND array_length(NEW.mentioned_user_ids, 1) > 0 THEN
    FOREACH mentioned_user IN ARRAY NEW.mentioned_user_ids
    LOOP
      INSERT INTO notifications (
        org_id,
        user_id,
        notification_type,
        title,
        message,
        entity_type,
        entity_id,
        priority,
        action_url
      ) VALUES (
        NEW.org_id,
        mentioned_user,
        'mention',
        'You were mentioned in a comment',
        LEFT(NEW.content, 100),
        NEW.entity_type,
        NEW.entity_id,
        'normal',
        '/' || NEW.entity_type || 's/' || NEW.entity_id || '#comment-' || NEW.id
      );
    END LOOP;
  END IF;
  RETURN NEW;
END;
$$;


--
-- Name: notify_task_assigned(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.notify_task_assigned() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  IF NEW.assigned_to IS NOT NULL AND (OLD.assigned_to IS NULL OR OLD.assigned_to != NEW.assigned_to) THEN
    INSERT INTO notifications (
      org_id,
      user_id,
      notification_type,
      title,
      message,
      entity_type,
      entity_id,
      priority,
      action_url
    ) VALUES (
      NEW.org_id,
      NEW.assigned_to,
      'task_assigned',
      'New task assigned to you',
      NEW.title,
      'task',
      NEW.id,
      CASE NEW.priority
        WHEN 'urgent' THEN 'urgent'
        WHEN 'high' THEN 'high'
        ELSE 'normal'
      END,
      '/tasks/' || NEW.id
    );
  END IF;
  RETURN NEW;
END;
$$;


--
-- Name: object_owners_updated_at_trigger(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.object_owners_updated_at_trigger() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: prevent_audit_log_modification(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.prevent_audit_log_modification() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  RAISE EXCEPTION 'Audit logs are immutable. Cannot UPDATE or DELETE audit records.';
  RETURN NULL;
END;
$$;


--
-- Name: prevent_user_hard_delete(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.prevent_user_hard_delete() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  RAISE EXCEPTION 'Hard deletes are not allowed on user_profiles. Use soft delete (UPDATE deleted_at) instead.';
  RETURN NULL;
END;
$$;


--
-- Name: prevent_workflow_history_modification(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.prevent_workflow_history_modification() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  RAISE EXCEPTION 'Workflow history is immutable (cannot UPDATE or DELETE)';
END;
$$;


--
-- Name: publish_event(text, uuid, jsonb, uuid, jsonb); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.publish_event(p_event_type text, p_aggregate_id uuid, p_payload jsonb, p_user_id uuid DEFAULT NULL::uuid, p_metadata jsonb DEFAULT '{}'::jsonb) RETURNS uuid
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_event_id UUID;
  v_event_category TEXT;
  v_user_email TEXT;
  v_notify_payload TEXT;
BEGIN
  -- Extract category from event_type (e.g., 'user.created' -> 'user')
  v_event_category := SPLIT_PART(p_event_type, '.', 1);

  -- Get user email if user_id provided
  IF p_user_id IS NOT NULL THEN
    SELECT email INTO v_user_email
    FROM user_profiles
    WHERE id = p_user_id;
  END IF;

  -- Insert event
  INSERT INTO events (
    event_type,
    event_category,
    aggregate_id,
    payload,
    metadata,
    user_id,
    user_email,
    status
  ) VALUES (
    p_event_type,
    v_event_category,
    p_aggregate_id,
    p_payload,
    p_metadata,
    p_user_id,
    v_user_email,
    'pending'
  ) RETURNING id INTO v_event_id;

  -- Build notification payload
  v_notify_payload := json_build_object(
    'event_id', v_event_id,
    'event_type', p_event_type,
    'aggregate_id', p_aggregate_id,
    'timestamp', NOW()
  )::TEXT;

  -- Send NOTIFY on channel matching event category
  PERFORM pg_notify(v_event_category, v_notify_payload);

  -- Also send on global event channel
  PERFORM pg_notify('events', v_notify_payload);

  RETURN v_event_id;
END;
$$;


--
-- Name: FUNCTION publish_event(p_event_type text, p_aggregate_id uuid, p_payload jsonb, p_user_id uuid, p_metadata jsonb); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.publish_event(p_event_type text, p_aggregate_id uuid, p_payload jsonb, p_user_id uuid, p_metadata jsonb) IS 'Publish an event to the event bus. Triggers PostgreSQL NOTIFY for real-time processing.';


--
-- Name: publish_event(text, uuid, jsonb, uuid, jsonb, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.publish_event(p_event_type text, p_aggregate_id uuid, p_payload jsonb, p_user_id uuid DEFAULT NULL::uuid, p_metadata jsonb DEFAULT '{}'::jsonb, p_org_id uuid DEFAULT NULL::uuid) RETURNS uuid
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_event_id UUID;
  v_event_category TEXT;
  v_user_email TEXT;
  v_notify_payload TEXT;
  v_org_id UUID;
BEGIN
  -- Extract category from event_type (e.g., 'user.created' -> 'user')
  v_event_category := SPLIT_PART(p_event_type, '.', 1);

  -- Get user email if user_id provided
  IF p_user_id IS NOT NULL THEN
    SELECT email, org_id INTO v_user_email, v_org_id
    FROM user_profiles
    WHERE id = p_user_id;
  END IF;

  -- If org_id provided explicitly, use it. Otherwise use the one from user profile.
  -- If still null, try to get from auth context (if running in RLS context)
  IF p_org_id IS NOT NULL THEN
    v_org_id := p_org_id;
  END IF;

  -- Fallback to default org if still null (should not happen in production)
  IF v_org_id IS NULL THEN
    v_org_id := '00000000-0000-0000-0000-000000000001'::UUID;
  END IF;

  -- Insert event
  INSERT INTO events (
    event_type,
    event_category,
    aggregate_id,
    payload,
    metadata,
    user_id,
    user_email,
    org_id, -- New field
    status
  ) VALUES (
    p_event_type,
    v_event_category,
    p_aggregate_id,
    p_payload,
    p_metadata,
    p_user_id,
    v_user_email,
    v_org_id,
    'pending'
  ) RETURNING id INTO v_event_id;

  -- Build notification payload (lightweight)
  v_notify_payload := json_build_object(
    'event_id', v_event_id,
    'event_type', p_event_type,
    'aggregate_id', p_aggregate_id,
    'org_id', v_org_id,
    'timestamp', NOW()
  )::TEXT;

  -- Send NOTIFY on channel matching event category
  PERFORM pg_notify(v_event_category, v_notify_payload);

  -- Also send on global event channel
  PERFORM pg_notify('events', v_notify_payload);

  RETURN v_event_id;
END;
$$;


--
-- Name: FUNCTION publish_event(p_event_type text, p_aggregate_id uuid, p_payload jsonb, p_user_id uuid, p_metadata jsonb, p_org_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.publish_event(p_event_type text, p_aggregate_id uuid, p_payload jsonb, p_user_id uuid, p_metadata jsonb, p_org_id uuid) IS 'Publish an event to the event bus. Triggers PostgreSQL NOTIFY for real-time processing. Supports multi-tenancy.';


--
-- Name: rate_ai_chat(uuid, uuid, integer, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.rate_ai_chat(p_chat_id uuid, p_user_id uuid, p_rating integer, p_feedback text DEFAULT NULL::text) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  -- Validate rating
  IF p_rating NOT BETWEEN 1 AND 5 THEN
    RAISE EXCEPTION 'Rating must be between 1 and 5';
  END IF;

  -- Update chat with rating
  UPDATE ai_mentor_chats
  SET
    student_rating = p_rating,
    student_feedback = p_feedback,
    rated_at = NOW(),
    -- Auto-flag low ratings
    flagged_for_review = CASE WHEN p_rating <= 2 THEN true ELSE flagged_for_review END
  WHERE id = p_chat_id
  AND user_id = p_user_id;

  IF NOT FOUND THEN
    RAISE EXCEPTION 'Chat not found or unauthorized';
  END IF;
END;
$$;


--
-- Name: record_auto_grade(uuid, jsonb, numeric, boolean); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.record_auto_grade(p_submission_id uuid, p_auto_grade_result jsonb, p_auto_grade_score numeric, p_passed boolean DEFAULT NULL::boolean) RETURNS boolean
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
    DECLARE
      v_passed BOOLEAN;
    BEGIN
      -- Determine pass/fail (70% threshold if not explicitly provided)
      v_passed := COALESCE(p_passed, p_auto_grade_score >= 70);

      UPDATE lab_submissions
      SET
        auto_grade_result = p_auto_grade_result,
        auto_grade_score = p_auto_grade_score,
        auto_graded_at = NOW(),
        status = CASE
          WHEN v_passed THEN 'passed'
          ELSE 'manual_review'
        END,
        final_score = p_auto_grade_score,
        passed = v_passed,
        updated_at = NOW()
      WHERE id = p_submission_id;

      RETURN v_passed;
    END;
    $$;


--
-- Name: record_content_upload(text, text, text, text, bigint, uuid, uuid, uuid, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.record_content_upload(p_filename text, p_storage_path text, p_file_type text, p_mime_type text, p_file_size_bytes bigint, p_topic_id uuid DEFAULT NULL::uuid, p_lesson_id uuid DEFAULT NULL::uuid, p_uploaded_by uuid DEFAULT NULL::uuid, p_cdn_url text DEFAULT NULL::text) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_asset_id UUID;
BEGIN
  IF p_file_type NOT IN ('video', 'pdf', 'image', 'document', 'other') THEN
    RAISE EXCEPTION 'Invalid file type: %', p_file_type;
  END IF;

  IF p_file_size_bytes <= 0 THEN
    RAISE EXCEPTION 'Invalid file size: %', p_file_size_bytes;
  END IF;

  INSERT INTO content_assets (
    filename,
    storage_path,
    file_type,
    mime_type,
    file_size_bytes,
    topic_id,
    lesson_id,
    uploaded_by,
    cdn_url
  ) VALUES (
    p_filename,
    p_storage_path,
    p_file_type,
    p_mime_type,
    p_file_size_bytes,
    p_topic_id,
    p_lesson_id,
    COALESCE(p_uploaded_by, auth.uid()),
    p_cdn_url
  )
  RETURNING id INTO v_asset_id;

  RETURN v_asset_id;
END;
$$;


--
-- Name: FUNCTION record_content_upload(p_filename text, p_storage_path text, p_file_type text, p_mime_type text, p_file_size_bytes bigint, p_topic_id uuid, p_lesson_id uuid, p_uploaded_by uuid, p_cdn_url text); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.record_content_upload(p_filename text, p_storage_path text, p_file_type text, p_mime_type text, p_file_size_bytes bigint, p_topic_id uuid, p_lesson_id uuid, p_uploaded_by uuid, p_cdn_url text) IS 'Records a new content upload in the database';


--
-- Name: record_discount_usage(uuid, uuid, uuid, numeric, numeric, numeric, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.record_discount_usage(p_discount_code_id uuid, p_user_id uuid, p_enrollment_id uuid, p_original_amount numeric, p_discount_amount numeric, p_final_amount numeric, p_stripe_payment_intent_id text DEFAULT NULL::text) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_usage_id UUID;
BEGIN
  -- Insert usage record
  INSERT INTO discount_code_usage (
    discount_code_id,
    user_id,
    enrollment_id,
    original_amount,
    discount_amount,
    final_amount,
    stripe_payment_intent_id
  ) VALUES (
    p_discount_code_id,
    p_user_id,
    p_enrollment_id,
    p_original_amount,
    p_discount_amount,
    p_final_amount,
    p_stripe_payment_intent_id
  )
  RETURNING id INTO v_usage_id;

  -- Increment usage count
  UPDATE discount_codes
  SET uses_count = uses_count + 1
  WHERE id = p_discount_code_id;

  RETURN v_usage_id;
END;
$$;


--
-- Name: record_manual_grade(uuid, uuid, numeric, jsonb, text, boolean); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.record_manual_grade(p_submission_id uuid, p_grader_id uuid, p_manual_score numeric, p_rubric_scores jsonb DEFAULT NULL::jsonb, p_feedback text DEFAULT NULL::text, p_passed boolean DEFAULT NULL::boolean) RETURNS boolean
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
    DECLARE
      v_auto_score NUMERIC;
      v_final_score NUMERIC;
      v_passed BOOLEAN;
    BEGIN
      -- Get existing auto-grade score
      SELECT auto_grade_score INTO v_auto_score
      FROM lab_submissions
      WHERE id = p_submission_id;

      -- Calculate final score (average of auto + manual if both exist)
      IF v_auto_score IS NOT NULL THEN
        v_final_score := (v_auto_score + p_manual_score) / 2;
      ELSE
        v_final_score := p_manual_score;
      END IF;

      -- Determine pass/fail (70% threshold if not explicitly provided)
      v_passed := COALESCE(p_passed, v_final_score >= 70);

      UPDATE lab_submissions
      SET
        manual_grade_score = p_manual_score,
        rubric_scores = p_rubric_scores,
        graded_by = p_grader_id,
        graded_at = NOW(),
        feedback = p_feedback,
        final_score = v_final_score,
        passed = v_passed,
        status = CASE WHEN v_passed THEN 'passed' ELSE 'failed' END,
        updated_at = NOW()
      WHERE id = p_submission_id;

      RETURN v_passed;
    END;
    $$;


--
-- Name: record_notification(uuid, text, uuid, text, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.record_notification(p_escalation_id uuid, p_notification_type text, p_recipient_id uuid DEFAULT NULL::uuid, p_recipient_email text DEFAULT NULL::text, p_recipient_slack_id text DEFAULT NULL::text) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_notification_id UUID;
BEGIN
  INSERT INTO escalation_notifications (
    escalation_id,
    notification_type,
    recipient_id,
    recipient_email,
    recipient_slack_id,
    sent_at
  ) VALUES (
    p_escalation_id,
    p_notification_type,
    p_recipient_id,
    p_recipient_email,
    p_recipient_slack_id,
    NOW()
  )
  RETURNING id INTO v_notification_id;

  RETURN v_notification_id;
END;
$$;


--
-- Name: record_question_pattern(text, uuid, uuid, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.record_question_pattern(p_question text, p_topic_id uuid, p_user_id uuid, p_rating integer DEFAULT NULL::integer) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_pattern_hash TEXT;
  v_pattern_id UUID;
  v_canonical_question TEXT;
BEGIN
  -- Simple hash based on normalized question (lowercase, trimmed)
  v_pattern_hash := MD5(LOWER(TRIM(p_question)));

  -- Try to find existing pattern
  SELECT id, canonical_question INTO v_pattern_id, v_canonical_question
  FROM ai_question_patterns
  WHERE pattern_hash = v_pattern_hash;

  IF FOUND THEN
    -- Update existing pattern - NOW USING INDEXED COLUMN!
    UPDATE ai_question_patterns
    SET
      occurrence_count = occurrence_count + 1,
      unique_students = (
        SELECT COUNT(DISTINCT user_id)
        FROM ai_mentor_chats
        WHERE question_hash = v_pattern_hash  -- Uses index!
      ),
      avg_response_quality = (
        SELECT AVG(student_rating)
        FROM ai_mentor_chats
        WHERE question_hash = v_pattern_hash  -- Uses index!
        AND student_rating IS NOT NULL
      ),
      last_seen = NOW()
    WHERE pattern_hash = v_pattern_hash;
  ELSE
    -- Create new pattern
    INSERT INTO ai_question_patterns (
      pattern_hash,
      canonical_question,
      topic_id,
      occurrence_count,
      unique_students,
      avg_response_quality
    ) VALUES (
      v_pattern_hash,
      p_question,
      p_topic_id,
      1,
      1,
      p_rating
    )
    RETURNING id INTO v_pattern_id;
  END IF;

  RETURN v_pattern_id;
END;
$$;


--
-- Name: refresh_revenue_analytics(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.refresh_revenue_analytics() RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  REFRESH MATERIALIZED VIEW CONCURRENTLY revenue_analytics;
  REFRESH MATERIALIZED VIEW CONCURRENTLY course_revenue_analytics;
  REFRESH MATERIALIZED VIEW CONCURRENTLY student_ltv_analytics;
  REFRESH MATERIALIZED VIEW CONCURRENTLY discount_effectiveness_analytics;
END;
$$;


--
-- Name: FUNCTION refresh_revenue_analytics(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.refresh_revenue_analytics() IS 'ACAD-030: Refresh all revenue analytics materialized views (call via cron)';


--
-- Name: replace_content_asset(uuid, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.replace_content_asset(p_old_asset_id uuid, p_new_asset_id uuid) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  UPDATE content_assets
  SET
    replaced_by = p_new_asset_id,
    is_current = false,
    updated_at = NOW()
  WHERE id = p_old_asset_id;

  UPDATE content_assets
  SET is_current = true
  WHERE id = p_new_asset_id;
END;
$$;


--
-- Name: FUNCTION replace_content_asset(p_old_asset_id uuid, p_new_asset_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.replace_content_asset(p_old_asset_id uuid, p_new_asset_id uuid) IS 'Marks an asset as replaced by a newer version';


--
-- Name: replay_events(text, timestamp with time zone, timestamp with time zone); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.replay_events(p_event_type_pattern text DEFAULT NULL::text, p_from_timestamp timestamp with time zone DEFAULT (now() - '01:00:00'::interval), p_to_timestamp timestamp with time zone DEFAULT now()) RETURNS TABLE(event_id uuid, event_type text, created_at timestamp with time zone, replayed boolean)
    LANGUAGE plpgsql
    AS $$
DECLARE
  event_record RECORD;
  v_notify_payload TEXT;
BEGIN
  FOR event_record IN
    SELECT id, events.event_type, events.event_category, aggregate_id, events.created_at
    FROM events
    WHERE events.created_at BETWEEN p_from_timestamp AND p_to_timestamp
      AND (p_event_type_pattern IS NULL OR events.event_type LIKE p_event_type_pattern)
      AND status = 'completed'
    ORDER BY events.created_at ASC
  LOOP
    -- Build notification payload
    v_notify_payload := json_build_object(
      'event_id', event_record.id,
      'event_type', event_record.event_type,
      'aggregate_id', event_record.aggregate_id,
      'timestamp', event_record.created_at,
      'replayed', TRUE
    )::TEXT;

    -- Send NOTIFY
    PERFORM pg_notify(event_record.event_category, v_notify_payload);
    PERFORM pg_notify('events', v_notify_payload);

    event_id := event_record.id;
    event_type := event_record.event_type;
    created_at := event_record.created_at;
    replayed := TRUE;

    RETURN NEXT;
  END LOOP;
END;
$$;


--
-- Name: FUNCTION replay_events(p_event_type_pattern text, p_from_timestamp timestamp with time zone, p_to_timestamp timestamp with time zone); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.replay_events(p_event_type_pattern text, p_from_timestamp timestamp with time zone, p_to_timestamp timestamp with time zone) IS 'Replay historical events for debugging or re-processing. Useful for recovering from failures.';


--
-- Name: replay_failed_events_batch(integer, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.replay_failed_events_batch(p_batch_size integer DEFAULT 10, p_org_id uuid DEFAULT NULL::uuid) RETURNS TABLE(event_id uuid, event_name text, replayed boolean)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN QUERY
  WITH failed_events AS (
    SELECT e.id, e.event_name
    FROM events e
    WHERE e.status = 'failed'
      AND (p_org_id IS NULL OR e.org_id = p_org_id)
    ORDER BY e.created_at ASC
    LIMIT p_batch_size
    FOR UPDATE SKIP LOCKED
  ),
  updated AS (
    UPDATE events
    SET
      status = 'pending',
      retry_count = retry_count + 1,
      error_message = NULL,
      updated_at = NOW()
    WHERE id IN (SELECT id FROM failed_events)
    RETURNING id, event_name
  )
  SELECT u.id, u.event_name, TRUE
  FROM updated u;
END;
$$;


--
-- Name: reset_reading_progress(uuid, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.reset_reading_progress(p_user_id uuid, p_topic_id uuid) RETURNS boolean
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
    BEGIN
      UPDATE reading_progress
      SET
        scroll_percentage = 0,
        last_scroll_position = 0,
        total_reading_time_seconds = 0,
        current_page = NULL,
        session_count = 0,
        updated_at = NOW()
      WHERE user_id = p_user_id
        AND topic_id = p_topic_id;

      RETURN FOUND;
    END;
    $$;


--
-- Name: reset_video_progress(uuid, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.reset_video_progress(p_user_id uuid, p_topic_id uuid) RETURNS boolean
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
    BEGIN
      UPDATE video_progress
      SET
        last_position_seconds = 0,
        total_watch_time_seconds = 0,
        session_count = 0,
        updated_at = NOW()
      WHERE user_id = p_user_id
        AND topic_id = p_topic_id;

      RETURN FOUND;
    END;
    $$;


--
-- Name: resolve_escalation(uuid, uuid, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.resolve_escalation(p_escalation_id uuid, p_trainer_id uuid, p_resolution_notes text) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  UPDATE ai_mentor_escalations
  SET
    status = 'resolved',
    resolved_by = p_trainer_id,
    resolved_at = NOW(),
    resolution_notes = p_resolution_notes,
    resolution_time_minutes = EXTRACT(EPOCH FROM (NOW() - created_at)) / 60
  WHERE id = p_escalation_id;

  IF NOT FOUND THEN
    RAISE EXCEPTION 'Escalation not found';
  END IF;
END;
$$;


--
-- Name: retry_failed_events(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.retry_failed_events() RETURNS TABLE(event_id uuid, event_type text)
    LANGUAGE plpgsql
    AS $$
BEGIN
  RETURN QUERY
  UPDATE events
  SET
    status = 'pending',
    next_retry_at = NULL
  WHERE status = 'failed'
    AND next_retry_at IS NOT NULL
    AND next_retry_at <= NOW()
  RETURNING id, events.event_type;
END;
$$;


--
-- Name: revoke_role_from_user(uuid, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.revoke_role_from_user(p_user_id uuid, p_role_name text) RETURNS boolean
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_role_id UUID;
BEGIN
  -- Get role ID
  SELECT id INTO v_role_id
  FROM roles
  WHERE name = p_role_name AND deleted_at IS NULL;

  IF v_role_id IS NULL THEN
    RAISE EXCEPTION 'Role % does not exist', p_role_name;
  END IF;

  -- Soft delete the user_role
  UPDATE user_roles
  SET deleted_at = NOW()
  WHERE user_id = p_user_id AND role_id = v_role_id AND deleted_at IS NULL;

  RETURN TRUE;
END;
$$;


--
-- Name: save_reading_progress(uuid, uuid, uuid, integer, integer, integer, text, integer, integer, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.save_reading_progress(p_user_id uuid, p_topic_id uuid, p_enrollment_id uuid, p_scroll_percentage integer, p_last_scroll_position integer, p_reading_time_increment integer DEFAULT 0, p_content_type text DEFAULT 'markdown'::text, p_content_length integer DEFAULT NULL::integer, p_current_page integer DEFAULT NULL::integer, p_total_pages integer DEFAULT NULL::integer) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
    DECLARE
      v_progress_id UUID;
    BEGIN
      INSERT INTO reading_progress (
        user_id,
        topic_id,
        enrollment_id,
        scroll_percentage,
        last_scroll_position,
        total_reading_time_seconds,
        content_type,
        content_length,
        current_page,
        total_pages,
        session_count,
        last_read_at
      ) VALUES (
        p_user_id,
        p_topic_id,
        p_enrollment_id,
        p_scroll_percentage,
        p_last_scroll_position,
        p_reading_time_increment,
        p_content_type,
        p_content_length,
        p_current_page,
        p_total_pages,
        1,
        NOW()
      )
      ON CONFLICT (user_id, topic_id) DO UPDATE SET
        scroll_percentage = GREATEST(reading_progress.scroll_percentage, p_scroll_percentage),
        last_scroll_position = p_last_scroll_position,
        total_reading_time_seconds = reading_progress.total_reading_time_seconds + p_reading_time_increment,
        content_type = COALESCE(p_content_type, reading_progress.content_type),
        content_length = COALESCE(p_content_length, reading_progress.content_length),
        current_page = COALESCE(p_current_page, reading_progress.current_page),
        total_pages = COALESCE(p_total_pages, reading_progress.total_pages),
        last_read_at = NOW(),
        session_count = reading_progress.session_count + 1
      RETURNING id INTO v_progress_id;

      RETURN v_progress_id;
    END;
    $$;


--
-- Name: save_video_progress(uuid, uuid, uuid, integer, integer, text, text, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.save_video_progress(p_user_id uuid, p_topic_id uuid, p_enrollment_id uuid, p_last_position_seconds integer, p_video_duration_seconds integer, p_video_url text, p_video_provider text, p_watch_time_increment integer DEFAULT 0) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
    DECLARE
      v_progress_id UUID;
    BEGIN
      INSERT INTO video_progress (
        user_id,
        topic_id,
        enrollment_id,
        last_position_seconds,
        video_duration_seconds,
        video_url,
        video_provider,
        total_watch_time_seconds,
        session_count,
        last_watched_at
      ) VALUES (
        p_user_id,
        p_topic_id,
        p_enrollment_id,
        p_last_position_seconds,
        p_video_duration_seconds,
        p_video_url,
        p_video_provider,
        p_watch_time_increment,
        1,
        NOW()
      )
      ON CONFLICT (user_id, topic_id) DO UPDATE SET
        last_position_seconds = p_last_position_seconds,
        video_duration_seconds = COALESCE(p_video_duration_seconds, video_progress.video_duration_seconds),
        total_watch_time_seconds = video_progress.total_watch_time_seconds + p_watch_time_increment,
        last_watched_at = NOW(),
        session_count = video_progress.session_count + 1
      RETURNING id INTO v_progress_id;

      RETURN v_progress_id;
    END;
    $$;


--
-- Name: search_candidates(uuid, public.vector, double precision, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.search_candidates(p_org_id uuid, p_query_embedding public.vector, p_match_threshold double precision DEFAULT 0.70, p_match_count integer DEFAULT 10) RETURNS TABLE(candidate_id uuid, resume_text text, skills text[], experience_level text, availability text, similarity double precision)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  -- Semantic search using pgvector cosine similarity
  RETURN QUERY
  SELECT
    ce.candidate_id,
    ce.resume_text,
    ce.skills,
    ce.experience_level,
    ce.availability,
    -- Calculate similarity (1 - cosine distance = cosine similarity)
    1 - (ce.embedding <=> p_query_embedding) AS similarity
  FROM candidate_embeddings ce
  WHERE ce.org_id = p_org_id
    AND 1 - (ce.embedding <=> p_query_embedding) > p_match_threshold
  ORDER BY ce.embedding <=> p_query_embedding  -- <=> is cosine distance operator
  LIMIT p_match_count;
END;
$$;


--
-- Name: FUNCTION search_candidates(p_org_id uuid, p_query_embedding public.vector, p_match_threshold double precision, p_match_count integer); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.search_candidates(p_org_id uuid, p_query_embedding public.vector, p_match_threshold double precision, p_match_count integer) IS 'Semantic candidate search using pgvector cosine similarity. Returns top-K matches above threshold.';


--
-- Name: search_embeddings(public.vector, integer, jsonb); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.search_embeddings(query_embedding public.vector, match_count integer DEFAULT 5, filter_metadata jsonb DEFAULT NULL::jsonb) RETURNS TABLE(id text, content text, metadata jsonb, similarity double precision)
    LANGUAGE plpgsql
    AS $$
BEGIN
  RETURN QUERY
  SELECT
    e.id,
    e.content,
    e.metadata,
    1 - (e.embedding <=> query_embedding) AS similarity
  FROM public.ai_embeddings e
  WHERE
    CASE
      WHEN filter_metadata IS NOT NULL THEN
        e.metadata @> filter_metadata
      ELSE TRUE
    END
  ORDER BY e.embedding <=> query_embedding
  LIMIT match_count;
END;
$$;


--
-- Name: FUNCTION search_embeddings(query_embedding public.vector, match_count integer, filter_metadata jsonb); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.search_embeddings(query_embedding public.vector, match_count integer, filter_metadata jsonb) IS 'Semantic search over embeddings using cosine similarity';


--
-- Name: select_prompt_variant(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.select_prompt_variant() RETURNS TABLE(variant_id uuid, system_prompt text)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_random INTEGER;
  v_cumulative INTEGER := 0;
  v_variant RECORD;
BEGIN
  -- Get random number 1-100
  v_random := FLOOR(RANDOM() * 100) + 1;

  -- Select variant based on traffic percentage
  FOR v_variant IN
    SELECT id, system_prompt, traffic_percentage
    FROM ai_prompt_variants
    WHERE is_active = true
    ORDER BY traffic_percentage DESC
  LOOP
    v_cumulative := v_cumulative + v_variant.traffic_percentage;

    IF v_random <= v_cumulative THEN
      variant_id := v_variant.id;
      system_prompt := v_variant.system_prompt;
      RETURN NEXT;
      RETURN;
    END IF;
  END LOOP;

  -- Default: return NULL (use default prompt)
  RETURN;
END;
$$;


--
-- Name: set_escalation_number(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.set_escalation_number() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  IF NEW.escalation_number IS NULL THEN
    NEW.escalation_number := generate_escalation_number();
  END IF;
  RETURN NEW;
END;
$$;


--
-- Name: set_onboarding_completion(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.set_onboarding_completion() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  IF NEW.completed_steps = NEW.total_steps AND OLD.completed_at IS NULL THEN
    NEW.completed_at := NOW();
  ELSIF NEW.completed_steps < NEW.total_steps AND OLD.completed_at IS NOT NULL THEN
    NEW.completed_at := NULL;
  END IF;

  RETURN NEW;
END;
$$;


--
-- Name: set_org_context(uuid, text, jsonb, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.set_org_context(p_org_id uuid, p_context_type text, p_data jsonb, p_ttl_hours integer DEFAULT 24) RETURNS boolean
    LANGUAGE plpgsql
    AS $$
BEGIN
  INSERT INTO org_context_cache (org_id, context_type, data, expires_at, updated_at)
  VALUES (
    p_org_id,
    p_context_type,
    p_data,
    NOW() + (p_ttl_hours || ' hours')::INTERVAL,
    NOW()
  )
  ON CONFLICT (org_id, context_type) DO UPDATE SET
    data = EXCLUDED.data,
    expires_at = EXCLUDED.expires_at,
    updated_at = NOW();

  RETURN TRUE;
END;
$$;


--
-- Name: FUNCTION set_org_context(p_org_id uuid, p_context_type text, p_data jsonb, p_ttl_hours integer); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.set_org_context(p_org_id uuid, p_context_type text, p_data jsonb, p_ttl_hours integer) IS 'Update org context cache with TTL';


--
-- Name: share_badge(uuid, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.share_badge(p_user_id uuid, p_badge_id uuid) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  UPDATE user_badges
  SET
    shared_at = NOW(),
    share_count = share_count + 1
  WHERE user_id = p_user_id
  AND badge_id = p_badge_id;
END;
$$;


--
-- Name: start_lab_instance(uuid, uuid, uuid, text, text, integer, text, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.start_lab_instance(p_user_id uuid, p_topic_id uuid, p_enrollment_id uuid, p_forked_repo_url text, p_original_template_url text, p_time_limit_minutes integer DEFAULT 120, p_github_username text DEFAULT NULL::text, p_lab_template_id uuid DEFAULT NULL::uuid) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
    DECLARE
      v_instance_id UUID;
      v_expires_at TIMESTAMPTZ;
    BEGIN
      -- Check for existing active instance
      SELECT id INTO v_instance_id
      FROM lab_instances
      WHERE user_id = p_user_id
        AND topic_id = p_topic_id
        AND status = 'active';

      IF v_instance_id IS NOT NULL THEN
        RAISE EXCEPTION 'User already has an active lab instance for this topic';
      END IF;

      -- Calculate expiration time
      v_expires_at := NOW() + (p_time_limit_minutes || ' minutes')::INTERVAL;

      -- Create new instance
      INSERT INTO lab_instances (
        user_id,
        topic_id,
        enrollment_id,
        lab_template_id,
        forked_repo_url,
        original_template_url,
        status,
        started_at,
        expires_at,
        github_username,
        last_activity_at
      ) VALUES (
        p_user_id,
        p_topic_id,
        p_enrollment_id,
        p_lab_template_id,
        p_forked_repo_url,
        p_original_template_url,
        'active',
        NOW(),
        v_expires_at,
        p_github_username,
        NOW()
      )
      RETURNING id INTO v_instance_id;

      RETURN v_instance_id;
    END;
    $$;


--
-- Name: start_quiz_attempt(uuid, uuid, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.start_quiz_attempt(p_user_id uuid, p_topic_id uuid, p_enrollment_id uuid) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_attempt_id UUID;
  v_attempt_number INTEGER;
  v_max_attempts INTEGER;
  v_total_questions INTEGER;
BEGIN
  -- Get quiz settings
  SELECT max_attempts INTO v_max_attempts
  FROM quiz_settings
  WHERE topic_id = p_topic_id;

  -- Check if max attempts reached
  IF v_max_attempts IS NOT NULL THEN
    SELECT COUNT(*) INTO v_attempt_number
    FROM quiz_attempts
    WHERE user_id = p_user_id AND topic_id = p_topic_id;

    IF v_attempt_number >= v_max_attempts THEN
      RAISE EXCEPTION 'Maximum attempts (%) reached for this quiz', v_max_attempts;
    END IF;
  END IF;

  -- Get next attempt number
  SELECT COALESCE(MAX(attempt_number), 0) + 1 INTO v_attempt_number
  FROM quiz_attempts
  WHERE user_id = p_user_id AND topic_id = p_topic_id;

  -- Count total questions
  SELECT COUNT(*) INTO v_total_questions
  FROM quiz_questions
  WHERE topic_id = p_topic_id;

  -- Create attempt record
  INSERT INTO quiz_attempts (
    user_id,
    topic_id,
    enrollment_id,
    attempt_number,
    total_questions,
    started_at
  )
  VALUES (
    p_user_id,
    p_topic_id,
    p_enrollment_id,
    v_attempt_number,
    v_total_questions,
    NOW()
  )
  RETURNING id INTO v_attempt_id;

  RETURN v_attempt_id;
END;
$$;


--
-- Name: start_workflow(uuid, text, uuid, uuid, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.start_workflow(p_workflow_id uuid, p_entity_type text, p_entity_id uuid, p_user_id uuid, p_org_id uuid) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_initial_state_id UUID;
  v_instance_id UUID;
BEGIN
  -- Get initial state
  SELECT id INTO v_initial_state_id
  FROM workflow_states
  WHERE workflow_id = p_workflow_id
    AND is_initial = TRUE
  LIMIT 1;

  IF v_initial_state_id IS NULL THEN
    RAISE EXCEPTION 'Workflow % has no initial state', p_workflow_id;
  END IF;

  -- Create instance
  INSERT INTO workflow_instances (
    org_id,
    workflow_id,
    entity_type,
    entity_id,
    current_state_id,
    created_by
  ) VALUES (
    p_org_id,
    p_workflow_id,
    p_entity_type,
    p_entity_id,
    v_initial_state_id,
    p_user_id
  ) RETURNING id INTO v_instance_id;

  -- Record initial state in history
  INSERT INTO workflow_history (
    workflow_instance_id,
    from_state_id,
    to_state_id,
    action,
    performed_by,
    notes
  ) VALUES (
    v_instance_id,
    NULL,
    v_initial_state_id,
    'start',
    p_user_id,
    'Workflow started'
  );

  -- Publish event
  PERFORM publish_event(
    'workflow.started',
    p_entity_id,
    jsonb_build_object(
      'instanceId', v_instance_id,
      'workflowId', p_workflow_id,
      'entityType', p_entity_type,
      'entityId', p_entity_id,
      'initialState', v_initial_state_id
    ),
    p_user_id,
    '{}'::jsonb
  );

  RETURN v_instance_id;
END;
$$;


--
-- Name: FUNCTION start_workflow(p_workflow_id uuid, p_entity_type text, p_entity_id uuid, p_user_id uuid, p_org_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.start_workflow(p_workflow_id uuid, p_entity_type text, p_entity_id uuid, p_user_id uuid, p_org_id uuid) IS 'Start a new workflow instance';


--
-- Name: store_ai_chat(uuid, uuid, uuid, uuid, text, text, jsonb, integer, integer, numeric); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.store_ai_chat(p_user_id uuid, p_topic_id uuid, p_course_id uuid, p_session_id uuid, p_question text, p_response text, p_conversation_context jsonb, p_tokens_used integer, p_response_time_ms integer, p_cost_usd numeric) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_chat_id UUID;
BEGIN
  INSERT INTO ai_mentor_chats (
    user_id,
    topic_id,
    course_id,
    question,
    response,
    conversation_context,
    tokens_used,
    response_time_ms,
    cost_usd
  ) VALUES (
    p_user_id,
    p_topic_id,
    p_course_id,
    p_question,
    p_response,
    p_conversation_context,
    p_tokens_used,
    p_response_time_ms,
    p_cost_usd
  )
  RETURNING id INTO v_chat_id;

  RETURN v_chat_id;
END;
$$;


--
-- Name: submit_capstone(uuid, uuid, uuid, text, text, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.submit_capstone(p_user_id uuid, p_enrollment_id uuid, p_course_id uuid, p_repository_url text, p_demo_video_url text DEFAULT NULL::text, p_description text DEFAULT NULL::text) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_submission_id UUID;
  v_previous_submission_count INTEGER;
BEGIN
  -- Check if user has an active enrollment
  IF NOT EXISTS (
    SELECT 1 FROM student_enrollments
    WHERE id = p_enrollment_id
    AND user_id = p_user_id
    AND status = 'active'
  ) THEN
    RAISE EXCEPTION 'Invalid or inactive enrollment';
  END IF;

  -- Count previous submissions for revision count
  SELECT COUNT(*) INTO v_previous_submission_count
  FROM capstone_submissions
  WHERE enrollment_id = p_enrollment_id;

  -- Create submission
  INSERT INTO capstone_submissions (
    user_id,
    enrollment_id,
    course_id,
    repository_url,
    demo_video_url,
    description,
    revision_count,
    status
  ) VALUES (
    p_user_id,
    p_enrollment_id,
    p_course_id,
    p_repository_url,
    p_demo_video_url,
    p_description,
    v_previous_submission_count,
    'pending'
  )
  RETURNING id INTO v_submission_id;

  -- Log event
  PERFORM publish_event(
    'capstone.submitted',
    v_submission_id,
    jsonb_build_object(
      'user_id', p_user_id,
      'enrollment_id', p_enrollment_id,
      'course_id', p_course_id,
      'revision_count', v_previous_submission_count
    ),
    p_user_id
  );

  RETURN v_submission_id;
END;
$$;


--
-- Name: submit_lab(uuid, uuid, uuid, uuid, text, text, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.submit_lab(p_user_id uuid, p_topic_id uuid, p_enrollment_id uuid, p_lab_instance_id uuid, p_repository_url text, p_commit_sha text DEFAULT NULL::text, p_branch_name text DEFAULT 'main'::text) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
    DECLARE
      v_submission_id UUID;
      v_attempt_number INTEGER;
    BEGIN
      -- Get next attempt number
      SELECT COALESCE(MAX(attempt_number), 0) + 1
      INTO v_attempt_number
      FROM lab_submissions
      WHERE user_id = p_user_id
        AND topic_id = p_topic_id;

      -- Create submission
      INSERT INTO lab_submissions (
        user_id,
        topic_id,
        enrollment_id,
        lab_instance_id,
        repository_url,
        commit_sha,
        branch_name,
        submitted_at,
        status,
        attempt_number
      ) VALUES (
        p_user_id,
        p_topic_id,
        p_enrollment_id,
        p_lab_instance_id,
        p_repository_url,
        p_commit_sha,
        p_branch_name,
        NOW(),
        'pending',
        v_attempt_number
      )
      RETURNING id INTO v_submission_id;

      RETURN v_submission_id;
    END;
    $$;


--
-- Name: submit_peer_review(uuid, uuid, integer, text, text, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.submit_peer_review(p_submission_id uuid, p_reviewer_id uuid, p_rating integer, p_comments text, p_strengths text DEFAULT NULL::text, p_improvements text DEFAULT NULL::text) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_review_id UUID;
  v_submission_user_id UUID;
BEGIN
  -- Get submission owner
  SELECT user_id INTO v_submission_user_id
  FROM capstone_submissions
  WHERE id = p_submission_id;

  IF NOT FOUND THEN
    RAISE EXCEPTION 'Submission not found';
  END IF;

  -- Prevent self-review
  IF v_submission_user_id = p_reviewer_id THEN
    RAISE EXCEPTION 'Cannot review your own submission';
  END IF;

  -- Check if reviewer is enrolled in the same course
  IF NOT EXISTS (
    SELECT 1 FROM student_enrollments se1
    WHERE se1.user_id = p_reviewer_id
    AND se1.course_id = (
      SELECT course_id FROM capstone_submissions WHERE id = p_submission_id
    )
    AND se1.status IN ('active', 'completed')
  ) THEN
    RAISE EXCEPTION 'Must be enrolled in the same course to peer review';
  END IF;

  -- Insert or update peer review
  INSERT INTO peer_reviews (
    submission_id,
    reviewer_id,
    rating,
    comments,
    strengths,
    improvements
  ) VALUES (
    p_submission_id,
    p_reviewer_id,
    p_rating,
    p_comments,
    p_strengths,
    p_improvements
  )
  ON CONFLICT (submission_id, reviewer_id)
  DO UPDATE SET
    rating = EXCLUDED.rating,
    comments = EXCLUDED.comments,
    strengths = EXCLUDED.strengths,
    improvements = EXCLUDED.improvements,
    reviewed_at = NOW(),
    updated_at = NOW()
  RETURNING id INTO v_review_id;

  -- Update submission status if enough peer reviews
  UPDATE capstone_submissions
  SET status = CASE
    WHEN peer_review_count >= 3 AND status = 'pending' THEN 'trainer_review'
    ELSE status
  END
  WHERE id = p_submission_id;

  RETURN v_review_id;
END;
$$;


--
-- Name: submit_quiz_attempt(uuid, jsonb); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.submit_quiz_attempt(p_attempt_id uuid, p_answers jsonb) RETURNS TABLE(attempt_id uuid, score numeric, passed boolean, correct_answers integer, total_questions integer, xp_earned integer, results jsonb)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_attempt RECORD;
  v_question RECORD;
  v_total_points INTEGER := 0;
  v_earned_points INTEGER := 0;
  v_correct_count INTEGER := 0;
  v_score NUMERIC;
  v_passed BOOLEAN;
  v_passing_threshold INTEGER;
  v_xp_reward INTEGER;
  v_xp_earned INTEGER := 0;
  v_is_first_pass BOOLEAN := FALSE;
  v_results JSONB := '[]'::jsonb;
  v_question_result JSONB;
  v_user_answers JSONB;
  v_is_correct BOOLEAN;
  v_time_taken_seconds INTEGER;
BEGIN
  -- Get attempt details
  SELECT * INTO v_attempt
  FROM quiz_attempts
  WHERE id = p_attempt_id;

  IF v_attempt IS NULL THEN
    RAISE EXCEPTION 'Attempt not found';
  END IF;

  IF v_attempt.submitted_at IS NOT NULL THEN
    RAISE EXCEPTION 'Quiz already submitted';
  END IF;

  -- Get quiz settings
  SELECT passing_threshold, xp_reward
  INTO v_passing_threshold, v_xp_reward
  FROM quiz_settings
  WHERE topic_id = v_attempt.topic_id;

  -- Default values if no settings
  v_passing_threshold := COALESCE(v_passing_threshold, 70);
  v_xp_reward := COALESCE(v_xp_reward, 10);

  -- Grade each question
  FOR v_question IN
    SELECT * FROM quiz_questions
    WHERE topic_id = v_attempt.topic_id
    ORDER BY created_at
  LOOP
    v_total_points := v_total_points + v_question.points;
    v_user_answers := p_answers->v_question.id::text;

    -- Check if answer is correct (exact match for JSONB arrays)
    v_is_correct := (v_user_answers = v_question.correct_answers);

    IF v_is_correct THEN
      v_earned_points := v_earned_points + v_question.points;
      v_correct_count := v_correct_count + 1;
    END IF;

    -- Build result for this question
    v_question_result := jsonb_build_object(
      'question_id', v_question.id,
      'is_correct', v_is_correct,
      'user_answers', v_user_answers,
      'correct_answers', v_question.correct_answers,
      'points_earned', CASE WHEN v_is_correct THEN v_question.points ELSE 0 END,
      'points_possible', v_question.points
    );

    v_results := v_results || v_question_result;
  END LOOP;

  -- Calculate score
  IF v_total_points > 0 THEN
    v_score := ROUND((v_earned_points::NUMERIC / v_total_points) * 100, 2);
  ELSE
    v_score := 0;
  END IF;

  -- Determine pass/fail
  v_passed := v_score >= v_passing_threshold;

  -- Calculate time taken
  v_time_taken_seconds := EXTRACT(EPOCH FROM (NOW() - v_attempt.started_at))::INTEGER;

  -- Update attempt record
  UPDATE quiz_attempts
  SET
    submitted_at = NOW(),
    answers = p_answers,
    correct_answers = v_correct_count,
    score = v_score,
    passed = v_passed,
    time_taken_seconds = v_time_taken_seconds
  WHERE id = p_attempt_id;

  -- Award XP and complete topic if passed (only on first pass)
  IF v_passed THEN
    -- Check if this is the first pass
    SELECT NOT EXISTS (
      SELECT 1 FROM quiz_attempts
      WHERE user_id = v_attempt.user_id
        AND topic_id = v_attempt.topic_id
        AND passed = TRUE
        AND id != p_attempt_id
    ) INTO v_is_first_pass;

    IF v_is_first_pass THEN
      -- Award XP
      INSERT INTO xp_transactions (
        user_id,
        enrollment_id,
        activity_type,
        activity_id,
        xp_earned,
        description
      )
      VALUES (
        v_attempt.user_id,
        v_attempt.enrollment_id,
        'quiz_passed',
        p_attempt_id,
        v_xp_reward,
        'Passed quiz on first attempt'
      );

      v_xp_earned := v_xp_reward;

      -- Update attempt with XP
      UPDATE quiz_attempts
      SET xp_earned = v_xp_reward
      WHERE id = p_attempt_id;

      -- Complete topic
      PERFORM complete_topic(
        v_attempt.user_id,
        v_attempt.topic_id,
        v_attempt.enrollment_id,
        'quiz',
        p_attempt_id
      );
    END IF;
  END IF;

  -- Return results
  RETURN QUERY SELECT
    p_attempt_id,
    v_score,
    v_passed,
    v_correct_count,
    v_attempt.total_questions,
    v_xp_earned,
    v_results;
END;
$$;


--
-- Name: subscribe_to_events(text, text, text, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.subscribe_to_events(p_subscriber_name text, p_event_pattern text, p_handler_function text DEFAULT NULL::text, p_webhook_url text DEFAULT NULL::text) RETURNS uuid
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_subscription_id UUID;
BEGIN
  -- Validate that at least one handler is provided
  IF p_handler_function IS NULL AND p_webhook_url IS NULL THEN
    RAISE EXCEPTION 'Must provide either handler_function or webhook_url';
  END IF;

  -- Insert or update subscription
  INSERT INTO event_subscriptions (
    subscriber_name,
    event_pattern,
    handler_function,
    webhook_url,
    is_active
  ) VALUES (
    p_subscriber_name,
    p_event_pattern,
    p_handler_function,
    p_webhook_url,
    TRUE
  )
  ON CONFLICT (subscriber_name, event_pattern)
  DO UPDATE SET
    handler_function = EXCLUDED.handler_function,
    webhook_url = EXCLUDED.webhook_url,
    is_active = TRUE,
    updated_at = NOW()
  RETURNING id INTO v_subscription_id;

  RETURN v_subscription_id;
END;
$$;


--
-- Name: sync_job_client_id(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.sync_job_client_id() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  IF NEW.account_id IS DISTINCT FROM OLD.account_id THEN
    NEW.client_id := NEW.account_id;
  END IF;
  IF NEW.client_id IS DISTINCT FROM OLD.client_id THEN
    NEW.account_id := NEW.client_id;
  END IF;
  RETURN NEW;
END;
$$;


--
-- Name: test_rls_as_user(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.test_rls_as_user(p_user_id uuid) RETURNS TABLE(table_name text, can_select boolean, can_insert boolean, can_update boolean, can_delete boolean)
    LANGUAGE plpgsql
    AS $$
BEGIN
  -- Set current user context
  PERFORM set_config('app.current_user_id', p_user_id::TEXT, TRUE);

  -- Test each table
  RETURN QUERY
  SELECT
    'user_profiles'::TEXT,
    EXISTS (SELECT 1 FROM user_profiles LIMIT 1),
    FALSE, -- Simplified for testing
    FALSE,
    FALSE;

  -- Reset user context
  PERFORM set_config('app.current_user_id', '', TRUE);
END;
$$;


--
-- Name: test_simple_function(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.test_simple_function() RETURNS text
    LANGUAGE plpgsql
    AS $$
BEGIN
  RETURN 'Hello from function';
END;
$$;


--
-- Name: transfer_ownership(text, uuid, uuid, text, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.transfer_ownership(p_entity_type text, p_entity_id uuid, p_new_accountable_id uuid, p_keep_previous_as text DEFAULT NULL::text, p_transferred_by uuid DEFAULT NULL::uuid) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_old_owner RECORD;
  v_org_id UUID;
  v_new_owner_id UUID;
BEGIN
  -- Get current accountable owner
  SELECT * INTO v_old_owner
  FROM object_owners
  WHERE entity_type = p_entity_type
    AND entity_id = p_entity_id
    AND role = 'accountable';
    
  IF v_old_owner IS NULL THEN
    RAISE EXCEPTION 'No accountable owner found for this entity';
  END IF;
  
  v_org_id := v_old_owner.org_id;
  
  -- Update or remove old accountable
  IF p_keep_previous_as IS NOT NULL AND p_keep_previous_as IN ('responsible', 'consulted', 'informed') THEN
    UPDATE object_owners
    SET role = p_keep_previous_as,
        permission = CASE WHEN p_keep_previous_as = 'responsible' THEN 'edit' ELSE 'view' END,
        is_primary = FALSE,
        updated_at = NOW()
    WHERE id = v_old_owner.id;
  ELSE
    DELETE FROM object_owners WHERE id = v_old_owner.id;
  END IF;
  
  -- Insert new accountable
  INSERT INTO object_owners (
    org_id, entity_type, entity_id, user_id,
    role, permission, is_primary, assigned_by, assignment_type
  ) VALUES (
    v_org_id, p_entity_type, p_entity_id, p_new_accountable_id,
    'accountable', 'edit', TRUE, p_transferred_by, 'manual'
  )
  ON CONFLICT (entity_type, entity_id, user_id) 
  DO UPDATE SET
    role = 'accountable',
    permission = 'edit',
    is_primary = TRUE,
    assigned_by = p_transferred_by,
    updated_at = NOW()
  RETURNING id INTO v_new_owner_id;
  
  RETURN v_new_owner_id;
END;
$$;


--
-- Name: transition_workflow(uuid, text, uuid, text, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.transition_workflow(p_instance_id uuid, p_action text, p_user_id uuid, p_notes text DEFAULT NULL::text, p_expected_version integer DEFAULT NULL::integer) RETURNS boolean
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_instance RECORD;
  v_transition RECORD;
BEGIN
  -- Lock instance row (pessimistic locking)
  SELECT
    wi.*,
    w.name AS workflow_name,
    ws_current.name AS current_state_name
  INTO v_instance
  FROM workflow_instances wi
  JOIN workflows w ON wi.workflow_id = w.id
  JOIN workflow_states ws_current ON wi.current_state_id = ws_current.id
  WHERE wi.id = p_instance_id
  FOR UPDATE;

  IF NOT FOUND THEN
    RAISE EXCEPTION 'Workflow instance % not found', p_instance_id;
  END IF;

  -- Check status is active
  IF v_instance.status != 'active' THEN
    RAISE EXCEPTION 'Cannot transition workflow in % status', v_instance.status;
  END IF;

  -- Optimistic locking check
  IF p_expected_version IS NOT NULL AND v_instance.version != p_expected_version THEN
    RAISE EXCEPTION 'Workflow instance was modified by another user (version mismatch)';
  END IF;

  -- Find valid transition
  SELECT
    wt.*,
    ws_to.id AS to_state_id,
    ws_to.name AS to_state_name,
    ws_to.is_terminal
  INTO v_transition
  FROM workflow_transitions wt
  JOIN workflow_states ws_to ON wt.to_state_id = ws_to.id
  WHERE wt.workflow_id = v_instance.workflow_id
    AND wt.from_state_id = v_instance.current_state_id
    AND wt.action = p_action;

  IF NOT FOUND THEN
    RAISE EXCEPTION 'Invalid transition: action "%" not allowed from state "%"',
      p_action, v_instance.current_state_name;
  END IF;

  -- Check permission if required
  IF v_transition.required_permission IS NOT NULL THEN
    IF NOT user_has_permission(p_user_id, v_transition.required_permission, 'execute') THEN
      RAISE EXCEPTION 'User does not have permission: %', v_transition.required_permission;
    END IF;
  END IF;

  -- Update instance
  UPDATE workflow_instances
  SET
    current_state_id = v_transition.to_state_id,
    status = CASE
      WHEN v_transition.is_terminal THEN 'completed'
      ELSE 'active'
    END,
    completed_at = CASE
      WHEN v_transition.is_terminal THEN NOW()
      ELSE NULL
    END,
    version = version + 1,
    updated_at = NOW()
  WHERE id = p_instance_id;

  -- Record in history
  INSERT INTO workflow_history (
    workflow_instance_id,
    from_state_id,
    to_state_id,
    action,
    performed_by,
    notes
  ) VALUES (
    p_instance_id,
    v_instance.current_state_id,
    v_transition.to_state_id,
    p_action,
    p_user_id,
    p_notes
  );

  -- Publish event
  PERFORM publish_event(
    'workflow.state_changed',
    v_instance.entity_id,
    jsonb_build_object(
      'instanceId', p_instance_id,
      'workflowId', v_instance.workflow_id,
      'workflowName', v_instance.workflow_name,
      'fromState', v_instance.current_state_name,
      'toState', v_transition.to_state_name,
      'action', p_action,
      'entityType', v_instance.entity_type,
      'entityId', v_instance.entity_id,
      'isCompleted', v_transition.is_terminal
    ),
    p_user_id,
    '{}'::jsonb
  );

  RETURN TRUE;
END;
$$;


--
-- Name: FUNCTION transition_workflow(p_instance_id uuid, p_action text, p_user_id uuid, p_notes text, p_expected_version integer); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.transition_workflow(p_instance_id uuid, p_action text, p_user_id uuid, p_notes text, p_expected_version integer) IS 'Transition workflow instance to new state';


--
-- Name: trigger_activity_completion_check(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trigger_activity_completion_check() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  -- Only process when activity is completed
  IF NEW.status = 'completed' AND OLD.status <> 'completed' THEN
    -- Only for campaign activities
    IF NEW.entity_type = 'campaign' THEN
      PERFORM check_campaign_status_progression(NEW.entity_id, NEW.org_id);
    END IF;
  END IF;
  RETURN NEW;
END;
$$;


--
-- Name: trigger_audit_log(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trigger_audit_log() RETURNS trigger
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_old_values JSONB;
  v_new_values JSONB;
  v_action TEXT;
  v_user_id UUID;
  v_record_id UUID;
  v_new_jsonb JSONB;
  v_old_jsonb JSONB;
BEGIN
  -- Determine action
  IF TG_OP = 'INSERT' THEN
    v_action := 'INSERT';
    v_new_jsonb := to_jsonb(NEW);
    v_new_values := v_new_jsonb;
    v_old_values := NULL;
  ELSIF TG_OP = 'UPDATE' THEN
    v_action := 'UPDATE';
    v_new_jsonb := to_jsonb(NEW);
    v_old_jsonb := to_jsonb(OLD);
    v_old_values := v_old_jsonb;
    v_new_values := v_new_jsonb;
  ELSIF TG_OP = 'DELETE' THEN
    v_action := 'DELETE';
    v_old_jsonb := to_jsonb(OLD);
    v_old_values := v_old_jsonb;
    v_new_values := NULL;
  END IF;

  -- Try to get record ID from jsonb (safer than direct field access)
  -- Try 'id' first, then other common PK fields, cast to UUID
  IF v_new_jsonb IS NOT NULL THEN
    v_record_id := COALESCE(
      (v_new_jsonb->>'id')::UUID,
      (v_new_jsonb->>'user_id')::UUID,  -- for tables like user_roles
      (v_new_jsonb->>'role_id')::UUID   -- fallback
    );
  ELSIF v_old_jsonb IS NOT NULL THEN
    v_record_id := COALESCE(
      (v_old_jsonb->>'id')::UUID,
      (v_old_jsonb->>'user_id')::UUID,
      (v_old_jsonb->>'role_id')::UUID
    );
  END IF;

  -- Try to get current user ID from various sources (safer with jsonb)
  v_user_id := NULLIF(current_setting('app.current_user_id', TRUE), '')::UUID;

  IF v_user_id IS NULL AND v_new_jsonb IS NOT NULL THEN
    v_user_id := COALESCE(
      (v_new_jsonb->>'updated_by')::UUID,
      (v_new_jsonb->>'created_by')::UUID,
      (v_new_jsonb->>'assigned_by')::UUID  -- for user_roles
    );
  END IF;

  IF v_user_id IS NULL AND v_old_jsonb IS NOT NULL THEN
    v_user_id := COALESCE(
      (v_old_jsonb->>'updated_by')::UUID,
      (v_old_jsonb->>'created_by')::UUID
    );
  END IF;

  -- Log the audit event
  PERFORM log_audit_event(
    p_table_name := TG_TABLE_NAME,
    p_action := v_action,
    p_record_id := v_record_id,
    p_user_id := v_user_id,
    p_old_values := v_old_values,
    p_new_values := v_new_values,
    p_metadata := '{}'::jsonb,
    p_severity := 'info'
  );

  RETURN COALESCE(NEW, OLD);
END;
$$;


--
-- Name: trigger_campaign_workplan(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trigger_campaign_workplan() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  -- Only create workplan for new campaigns
  IF TG_OP = 'INSERT' THEN
    PERFORM create_campaign_workplan(NEW.id, NEW.org_id, NEW.created_by);
  END IF;
  RETURN NEW;
END;
$$;


--
-- Name: trigger_graduation(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trigger_graduation(p_enrollment_id uuid) RETURNS boolean
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_user_id UUID;
  v_course_id UUID;
  v_enrollment_rec RECORD;
BEGIN
  -- Get enrollment details
  SELECT * INTO v_enrollment_rec
  FROM student_enrollments
  WHERE id = p_enrollment_id;

  IF NOT FOUND THEN
    RAISE EXCEPTION 'Enrollment not found';
  END IF;

  v_user_id := v_enrollment_rec.user_id;
  v_course_id := v_enrollment_rec.course_id;

  -- Update enrollment status to completed
  UPDATE student_enrollments
  SET
    status = 'completed',
    completed_at = NOW(),
    updated_at = NOW()
  WHERE id = p_enrollment_id;

  -- Grant 'candidate' role (graduates become bench candidates)
  IF NOT EXISTS (
    SELECT 1 FROM user_roles ur
    JOIN roles r ON ur.role_id = r.id
    WHERE ur.user_id = v_user_id
    AND r.name = 'candidate'
  ) THEN
    PERFORM grant_role_to_user(
      v_user_id,
      'candidate',
      v_user_id, -- Self-granted via system
      FALSE, -- Not primary
      NULL -- No expiration
    );
  END IF;

  -- Publish graduation event (will trigger certificate generation)
  PERFORM publish_event(
    'student.graduated',
    v_user_id,
    jsonb_build_object(
      'enrollment_id', p_enrollment_id,
      'course_id', v_course_id,
      'graduated_at', NOW()
    ),
    v_user_id
  );

  RETURN TRUE;
END;
$$;


--
-- Name: trigger_set_timestamp(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trigger_set_timestamp() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_accounts_search_vector(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_accounts_search_vector() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.search_vector :=
    setweight(to_tsvector('english', COALESCE(NEW.name, '')), 'A') ||
    setweight(to_tsvector('english', COALESCE(NEW.industry, '')), 'B') ||
    setweight(to_tsvector('english', COALESCE(NEW.description, '')), 'C');
  RETURN NEW;
END;
$$;


--
-- Name: update_activities_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_activities_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
    BEGIN
        NEW.updated_at = NOW();
        RETURN NEW;
    END;
    $$;


--
-- Name: update_ai_session(uuid, uuid, uuid, uuid, text, integer, numeric); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_ai_session(p_session_id uuid, p_user_id uuid, p_topic_id uuid, p_course_id uuid, p_question text, p_tokens_used integer, p_cost_usd numeric) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_session_id UUID;
  v_title TEXT;
BEGIN
  -- If session_id is provided, update existing session
  IF p_session_id IS NOT NULL THEN
    UPDATE ai_mentor_sessions
    SET
      message_count = message_count + 1,
      total_tokens = total_tokens + p_tokens_used,
      total_cost_usd = total_cost_usd + p_cost_usd,
      last_message_at = NOW()
    WHERE id = p_session_id
    RETURNING id INTO v_session_id;

    RETURN v_session_id;
  END IF;

  -- Otherwise, create new session
  -- Generate title from question (first 60 chars)
  v_title := CASE
    WHEN LENGTH(p_question) <= 60 THEN p_question
    ELSE SUBSTRING(p_question FROM 1 FOR 57) || '...'
  END;

  INSERT INTO ai_mentor_sessions (
    user_id,
    topic_id,
    course_id,
    title,
    message_count,
    total_tokens,
    total_cost_usd,
    started_at,
    last_message_at
  ) VALUES (
    p_user_id,
    p_topic_id,
    p_course_id,
    v_title,
    1,
    p_tokens_used,
    p_cost_usd,
    NOW(),
    NOW()
  )
  RETURNING id INTO v_session_id;

  RETURN v_session_id;
END;
$$;


--
-- Name: update_approval_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_approval_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$;


--
-- Name: update_badge_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_badge_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_bench_days_on_bench(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_bench_days_on_bench() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  -- Compute days on bench based on candidate_status and bench_start_date
  NEW.days_on_bench := CASE
    WHEN (SELECT candidate_status FROM user_profiles WHERE id = NEW.user_id) = 'bench'
    THEN (CURRENT_DATE - NEW.bench_start_date)::INTEGER
    ELSE 0
  END;
  RETURN NEW;
END;
$$;


--
-- Name: update_bench_immigration_status(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_bench_immigration_status() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  UPDATE bench_metadata SET
    has_active_immigration_case = EXISTS (
      SELECT 1 FROM immigration_cases
      WHERE candidate_id = NEW.candidate_id
        AND status IN ('drafting', 'submitted', 'rfe')
    ),
    immigration_case_id = CASE
      WHEN NEW.status IN ('drafting', 'submitted', 'rfe') THEN NEW.id
      ELSE NULL
    END
  WHERE user_id = NEW.candidate_id;
  RETURN NEW;
END;
$$;


--
-- Name: update_campaign_metrics(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_campaign_metrics() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  -- Update campaign metrics when prospects are updated
  UPDATE campaigns
  SET
    audience_size = (SELECT COUNT(*) FROM campaign_prospects WHERE campaign_id = NEW.campaign_id),
    prospects_contacted = (SELECT COUNT(*) FROM campaign_prospects WHERE campaign_id = NEW.campaign_id AND first_contacted_at IS NOT NULL),
    prospects_opened = (SELECT COUNT(*) FROM campaign_prospects WHERE campaign_id = NEW.campaign_id AND opened_at IS NOT NULL),
    prospects_clicked = (SELECT COUNT(*) FROM campaign_prospects WHERE campaign_id = NEW.campaign_id AND clicked_at IS NOT NULL),
    prospects_responded = (SELECT COUNT(*) FROM campaign_prospects WHERE campaign_id = NEW.campaign_id AND responded_at IS NOT NULL),
    leads_generated = (SELECT COUNT(*) FROM campaign_prospects WHERE campaign_id = NEW.campaign_id AND converted_to_lead_at IS NOT NULL),
    meetings_booked = (SELECT COUNT(*) FROM campaign_prospects WHERE campaign_id = NEW.campaign_id AND meeting_booked_at IS NOT NULL),
    updated_at = NOW()
  WHERE id = NEW.campaign_id;

  RETURN NEW;
END;
$$;


--
-- Name: update_campaigns_search_vector(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_campaigns_search_vector() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.search_vector :=
    setweight(to_tsvector('english', COALESCE(NEW.name, '')), 'A') ||
    setweight(to_tsvector('english', COALESCE(NEW.description, '')), 'B') ||
    setweight(to_tsvector('english', COALESCE(NEW.goal, '')), 'C');
  RETURN NEW;
END;
$$;


--
-- Name: update_candidate_on_placement(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_candidate_on_placement() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  IF NEW.status = 'active' THEN
    UPDATE user_profiles SET
      candidate_status = 'placed'
    WHERE id = NEW.candidate_id;
  ELSIF NEW.status = 'ended' OR NEW.status = 'cancelled' THEN
    UPDATE user_profiles SET
      candidate_status = 'active'
    WHERE id = NEW.candidate_id;
  END IF;
  RETURN NEW;
END;
$$;


--
-- Name: update_candidate_prepared_profiles_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_candidate_prepared_profiles_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_candidate_screenings_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_candidate_screenings_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_comment_reply_count(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_comment_reply_count() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  IF NEW.parent_comment_id IS NOT NULL THEN
    UPDATE comments SET
      reply_count = (SELECT COUNT(*) FROM comments WHERE parent_comment_id = NEW.parent_comment_id AND NOT is_deleted)
    WHERE id = NEW.parent_comment_id;
  END IF;
  RETURN NEW;
END;
$$;


--
-- Name: update_commissions_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_commissions_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_companies_hierarchy_path(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_companies_hierarchy_path() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
DECLARE
  parent_path TEXT;
BEGIN
  IF NEW.parent_company_id IS NULL THEN
    NEW.hierarchy_path := '/' || NEW.id::TEXT;
    NEW.hierarchy_level := 0;
  ELSE
    SELECT hierarchy_path, hierarchy_level + 1
    INTO parent_path, NEW.hierarchy_level
    FROM companies
    WHERE id = NEW.parent_company_id;

    NEW.hierarchy_path := parent_path || '/' || NEW.id::TEXT;
  END IF;
  RETURN NEW;
END;
$$;


--
-- Name: update_companies_search_vector(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_companies_search_vector() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.search_vector := to_tsvector('english',
    COALESCE(NEW.name, '') || ' ' ||
    COALESCE(NEW.legal_name, '') || ' ' ||
    COALESCE(NEW.dba_name, '') || ' ' ||
    COALESCE(NEW.industry, '') || ' ' ||
    COALESCE(NEW.headquarters_city, '') || ' ' ||
    COALESCE(NEW.headquarters_state, '')
  );
  NEW.updated_at := now();
  RETURN NEW;
END;
$$;


--
-- Name: update_contact_from_engagement(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_contact_from_engagement() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  IF NEW.event_type = 'email_opened' THEN
    UPDATE campaign_contacts SET
      status = 'opened',
      opened_at = NEW.event_timestamp
    WHERE id = NEW.campaign_contact_id AND status = 'sent';
  ELSIF NEW.event_type = 'link_clicked' THEN
    UPDATE campaign_contacts SET
      clicked_at = NEW.event_timestamp
    WHERE id = NEW.campaign_contact_id;
  ELSIF NEW.event_type = 'email_bounced' THEN
    UPDATE campaign_contacts SET
      status = 'bounced'
    WHERE id = NEW.campaign_contact_id;
  ELSIF NEW.event_type = 'unsubscribed' THEN
    UPDATE campaign_contacts SET
      status = 'unsubscribed'
    WHERE id = NEW.campaign_contact_id;
  END IF;
  RETURN NEW;
END;
$$;


--
-- Name: update_content_assets_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_content_assets_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_course_module_count(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_course_module_count() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  IF TG_OP = 'INSERT' THEN
    UPDATE courses
    SET total_modules = (SELECT COUNT(*) FROM course_modules WHERE course_id = NEW.course_id)
    WHERE id = NEW.course_id;
  ELSIF TG_OP = 'DELETE' THEN
    UPDATE courses
    SET total_modules = (SELECT COUNT(*) FROM course_modules WHERE course_id = OLD.course_id)
    WHERE id = OLD.course_id;
  END IF;
  RETURN NULL;
END;
$$;


--
-- Name: update_course_topic_count(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_course_topic_count() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_course_id UUID;
BEGIN
  IF TG_OP = 'INSERT' THEN
    SELECT course_id INTO v_course_id
    FROM course_modules
    WHERE id = NEW.module_id;

    UPDATE courses
    SET total_topics = (
      SELECT COUNT(*)
      FROM module_topics mt
      JOIN course_modules cm ON cm.id = mt.module_id
      WHERE cm.course_id = v_course_id
    )
    WHERE id = v_course_id;
  ELSIF TG_OP = 'DELETE' THEN
    SELECT course_id INTO v_course_id
    FROM course_modules
    WHERE id = OLD.module_id;

    UPDATE courses
    SET total_topics = (
      SELECT COUNT(*)
      FROM module_topics mt
      JOIN course_modules cm ON cm.id = mt.module_id
      WHERE cm.course_id = v_course_id
    )
    WHERE id = v_course_id;
  END IF;
  RETURN NULL;
END;
$$;


--
-- Name: update_deal_health_status(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_deal_health_status() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_days_since_activity INTEGER;
  v_days_to_close INTEGER;
BEGIN
  -- Calculate days since last activity
  v_days_since_activity := EXTRACT(DAY FROM (NOW() - COALESCE(NEW.last_activity_at, NEW.created_at)));

  -- Calculate days until expected close
  v_days_to_close := CASE
    WHEN NEW.expected_close_date IS NOT NULL
    THEN (NEW.expected_close_date - CURRENT_DATE)
    ELSE 999
  END;

  -- Skip for closed deals
  IF NEW.stage IN ('closed_won', 'closed_lost') THEN
    NEW.health_status := NULL;
    RETURN NEW;
  END IF;

  -- Determine health status
  IF NEW.health_status = 'at_risk' THEN
    -- Keep at_risk if manually set (don't override)
    NULL;
  ELSIF v_days_to_close <= 14 AND NEW.stage NOT IN ('verbal_commit') THEN
    NEW.health_status := 'urgent';
  ELSIF v_days_since_activity > 14 THEN
    NEW.health_status := 'stale';
  ELSIF v_days_since_activity > 7 THEN
    NEW.health_status := 'slow';
  ELSE
    NEW.health_status := 'on_track';
  END IF;

  RETURN NEW;
END;
$$;


--
-- Name: update_employee_rating(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_employee_rating() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  IF NEW.status = 'completed' AND NEW.overall_rating IS NOT NULL THEN
    UPDATE user_profiles SET
      employee_performance_rating = NEW.overall_rating
    WHERE id = NEW.employee_id;
  END IF;
  RETURN NEW;
END;
$$;


--
-- Name: update_employee_screenshots_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_employee_screenshots_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_enrollment_progress(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_enrollment_progress(p_enrollment_id uuid) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_user_id UUID;
  v_course_id UUID;
  v_total_topics INTEGER;
  v_completed_topics INTEGER;
  v_new_percentage INTEGER;
  v_current_percentage INTEGER;
BEGIN
  SELECT user_id, course_id, completion_percentage
  INTO v_user_id, v_course_id, v_current_percentage
  FROM student_enrollments
  WHERE id = p_enrollment_id;

  SELECT total_topics INTO v_total_topics
  FROM courses
  WHERE id = v_course_id;

  IF v_total_topics = 0 THEN
    RETURN;
  END IF;

  SELECT COUNT(*) INTO v_completed_topics
  FROM topic_completions
  WHERE enrollment_id = p_enrollment_id;

  v_new_percentage := LEAST(100, (v_completed_topics * 100) / v_total_topics);

  UPDATE student_enrollments
  SET
    completion_percentage = v_new_percentage,
    updated_at = NOW(),
    completed_at = CASE
      WHEN v_new_percentage = 100 AND v_current_percentage < 100 THEN NOW()
      ELSE completed_at
    END,
    status = CASE
      WHEN v_new_percentage = 100 AND status = 'active' THEN 'completed'
      ELSE status
    END
  WHERE id = p_enrollment_id;

  IF v_new_percentage = 100 AND v_current_percentage < 100 THEN
    BEGIN
      PERFORM publish_event(
        'course.graduated',
        jsonb_build_object(
          'enrollment_id', p_enrollment_id,
          'user_id', v_user_id,
          'course_id', v_course_id,
          'completed_topics', v_completed_topics
        ),
        jsonb_build_object('source', 'update_enrollment_progress'),
        v_user_id
      );
    EXCEPTION
      WHEN OTHERS THEN
        IF SQLSTATE = '42883' THEN
          NULL;
        ELSE
          RAISE;
        END IF;
    END;
  END IF;
END;
$$;


--
-- Name: FUNCTION update_enrollment_progress(p_enrollment_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.update_enrollment_progress(p_enrollment_id uuid) IS 'Recalculates enrollment completion percentage based on completed topics';


--
-- Name: update_enrollment_status(uuid, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_enrollment_status(p_enrollment_id uuid, p_new_status text) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_user_id UUID;
  v_course_id UUID;
BEGIN
  UPDATE student_enrollments
  SET
    status = p_new_status,
    updated_at = NOW(),
    completed_at = CASE WHEN p_new_status = 'completed' THEN NOW() ELSE completed_at END,
    dropped_at = CASE WHEN p_new_status = 'dropped' THEN NOW() ELSE dropped_at END
  WHERE id = p_enrollment_id
  RETURNING user_id, course_id INTO v_user_id, v_course_id;

  PERFORM publish_event(
    'enrollment.status_changed',
    jsonb_build_object(
      'enrollment_id', p_enrollment_id,
      'user_id', v_user_id,
      'course_id', v_course_id,
      'new_status', p_new_status
    ),
    jsonb_build_object('source', 'update_enrollment_status'),
    v_user_id
  );
EXCEPTION
  WHEN OTHERS THEN
    -- If publish_event doesn't exist, silently continue
    IF SQLSTATE = '42883' THEN
      NULL;
    ELSE
      RAISE;
    END IF;
END;
$$;


--
-- Name: update_enrollment_timestamp(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_enrollment_timestamp() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_escalation_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_escalation_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_event_subscriptions_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_event_subscriptions_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_external_job_submission_count(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_external_job_submission_count() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  UPDATE external_jobs SET
    submission_count = (SELECT COUNT(*) FROM bench_submissions WHERE external_job_id = NEW.external_job_id)
  WHERE id = NEW.external_job_id;
  RETURN NEW;
END;
$$;


--
-- Name: update_external_jobs_search_vector(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_external_jobs_search_vector() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.search_vector :=
    setweight(to_tsvector('english', COALESCE(NEW.title, '')), 'A') ||
    setweight(to_tsvector('english', COALESCE(NEW.company_name, '')), 'B') ||
    setweight(to_tsvector('english', COALESCE(NEW.description, '')), 'C') ||
    setweight(to_tsvector('english', COALESCE(NEW.location, '')), 'C');
  RETURN NEW;
END;
$$;


--
-- Name: update_immigration_days_elapsed(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_immigration_days_elapsed() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.days_elapsed := (CURRENT_DATE - COALESCE(NEW.filed_date, NEW.created_at::DATE))::INTEGER;
  RETURN NEW;
END;
$$;


--
-- Name: update_integrations_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_integrations_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_job_positions_filled(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_job_positions_filled() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  IF NEW.status = 'placed' AND (OLD.status IS NULL OR OLD.status != 'placed') THEN
    UPDATE jobs SET positions_filled = positions_filled + 1 WHERE id = NEW.job_id;

    -- Auto-close job if all positions filled
    UPDATE jobs SET status = 'filled', filled_date = CURRENT_DATE
    WHERE id = NEW.job_id AND positions_filled >= positions_count;
  END IF;
  RETURN NEW;
END;
$$;


--
-- Name: update_jobs_search_vector(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_jobs_search_vector() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.search_vector :=
    setweight(to_tsvector('english', COALESCE(NEW.title, '')), 'A') ||
    setweight(to_tsvector('english', COALESCE(NEW.description, '')), 'B') ||
    setweight(to_tsvector('english', COALESCE(NEW.location, '')), 'C');
  RETURN NEW;
END;
$$;


--
-- Name: update_lab_activity(uuid, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_lab_activity(p_instance_id uuid, p_time_increment_seconds integer DEFAULT 0) RETURNS boolean
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
    BEGIN
      UPDATE lab_instances
      SET
        last_activity_at = NOW(),
        time_spent_seconds = time_spent_seconds + p_time_increment_seconds,
        updated_at = NOW()
      WHERE id = p_instance_id
        AND status = 'active';

      RETURN FOUND;
    END;
    $$;


--
-- Name: update_lab_instance_on_submission(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_lab_instance_on_submission() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  UPDATE lab_instances
  SET
    status = 'submitted',
    completed_at = NEW.submitted_at,
    updated_at = NOW()
  WHERE id = NEW.lab_instance_id
    AND status = 'active';

  RETURN NEW;
END;
$$;


--
-- Name: update_lab_timestamp(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_lab_timestamp() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_lead_strategies_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_lead_strategies_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
    BEGIN
      NEW.updated_at = NOW();
      RETURN NEW;
    END;
    $$;


--
-- Name: update_lead_tasks_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_lead_tasks_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_leaderboard_visibility(uuid, boolean); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_leaderboard_visibility(p_user_id uuid, p_visible boolean) RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  UPDATE user_profiles
  SET leaderboard_visible = p_visible
  WHERE id = p_user_id;
END;
$$;


--
-- Name: update_leads_search_vector(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_leads_search_vector() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.search_vector :=
    setweight(to_tsvector('english', COALESCE(NEW.company_name, '')), 'A') ||
    setweight(to_tsvector('english', COALESCE(NEW.first_name || ' ' || NEW.last_name, '')), 'A') ||
    setweight(to_tsvector('english', COALESCE(NEW.email, '')), 'B') ||
    setweight(to_tsvector('english', COALESCE(NEW.industry, '')), 'C');
  RETURN NEW;
END;
$$;


--
-- Name: update_learning_streak(uuid, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_learning_streak(p_user_id uuid, p_streak_type text) RETURNS void
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_streak RECORD;
  v_hours_since_last_activity INTEGER;
BEGIN
  SELECT * INTO v_streak
  FROM learning_streaks
  WHERE user_id = p_user_id
    AND streak_type::TEXT = p_streak_type;

  IF v_streak IS NULL THEN
    INSERT INTO learning_streaks (
      user_id,
      streak_type,
      current_count,
      longest_count,
      last_activity_date,
      streak_started_at
    ) VALUES (
      p_user_id,
      p_streak_type::streak_type_enum,
      1,
      1,
      NOW(),
      NOW()
    );
  ELSE
    v_hours_since_last_activity := EXTRACT(EPOCH FROM (NOW() - v_streak.last_activity_date)) / 3600;

    IF v_hours_since_last_activity < 48 THEN
      UPDATE learning_streaks
      SET current_count = current_count + 1,
          longest_count = GREATEST(longest_count, current_count + 1),
          last_activity_date = NOW(),
          updated_at = NOW()
      WHERE user_id = p_user_id
        AND streak_type::TEXT = p_streak_type;
    ELSE
      UPDATE learning_streaks
      SET current_count = 1,
          last_activity_date = NOW(),
          streak_started_at = NOW(),
          updated_at = NOW()
      WHERE user_id = p_user_id
        AND streak_type::TEXT = p_streak_type;
    END IF;
  END IF;
END;
$$;


--
-- Name: update_payroll_run_totals(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_payroll_run_totals() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  UPDATE payroll_runs SET
    employee_count = (SELECT COUNT(*) FROM payroll_items WHERE payroll_run_id = NEW.payroll_run_id),
    total_gross_pay = (SELECT COALESCE(SUM(gross_pay), 0) FROM payroll_items WHERE payroll_run_id = NEW.payroll_run_id),
    total_taxes = (SELECT COALESCE(SUM(taxes_withheld), 0) FROM payroll_items WHERE payroll_run_id = NEW.payroll_run_id),
    total_net_pay = (SELECT COALESCE(SUM(net_pay), 0) FROM payroll_items WHERE payroll_run_id = NEW.payroll_run_id)
  WHERE id = NEW.payroll_run_id;
  RETURN NEW;
END;
$$;


--
-- Name: update_peer_review_stats(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_peer_review_stats() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  UPDATE capstone_submissions
  SET
    peer_review_count = (
      SELECT COUNT(*) FROM peer_reviews WHERE submission_id = NEW.submission_id
    ),
    avg_peer_rating = (
      SELECT AVG(rating)::NUMERIC(3,2) FROM peer_reviews WHERE submission_id = NEW.submission_id
    )
  WHERE id = NEW.submission_id;

  RETURN NEW;
END;
$$;


--
-- Name: update_placement_checkins_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_placement_checkins_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$;


--
-- Name: update_productivity_reports_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_productivity_reports_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_prompt_variant_metrics(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_prompt_variant_metrics() RETURNS void
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  UPDATE ai_prompt_variants pv
  SET
    total_uses = (
      SELECT COUNT(*)
      FROM ai_mentor_chats
      WHERE prompt_variant_id = pv.id
    ),
    avg_rating = (
      SELECT AVG(student_rating)
      FROM ai_mentor_chats
      WHERE prompt_variant_id = pv.id
      AND student_rating IS NOT NULL
    ),
    avg_response_time_ms = (
      SELECT AVG(response_time_ms)
      FROM ai_mentor_chats
      WHERE prompt_variant_id = pv.id
    ),
    avg_tokens_used = (
      SELECT AVG(tokens_used)
      FROM ai_mentor_chats
      WHERE prompt_variant_id = pv.id
    ),
    escalation_count = (
      SELECT COUNT(*)
      FROM ai_mentor_chats
      WHERE prompt_variant_id = pv.id
      AND escalated_to_trainer = true
    )
  WHERE pv.id IN (
    SELECT DISTINCT prompt_variant_id
    FROM ai_mentor_chats
    WHERE prompt_variant_id IS NOT NULL
  );
END;
$$;


--
-- Name: update_quiz_question(uuid, text, text, jsonb, jsonb, text, text, integer, text, boolean); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_quiz_question(p_question_id uuid, p_question_text text DEFAULT NULL::text, p_question_type text DEFAULT NULL::text, p_options jsonb DEFAULT NULL::jsonb, p_correct_answers jsonb DEFAULT NULL::jsonb, p_explanation text DEFAULT NULL::text, p_difficulty text DEFAULT NULL::text, p_points integer DEFAULT NULL::integer, p_code_language text DEFAULT NULL::text, p_is_public boolean DEFAULT NULL::boolean) RETURNS boolean
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  UPDATE quiz_questions
  SET
    question_text = COALESCE(p_question_text, question_text),
    question_type = COALESCE(p_question_type, question_type),
    options = COALESCE(p_options, options),
    correct_answers = COALESCE(p_correct_answers, correct_answers),
    explanation = COALESCE(p_explanation, explanation),
    difficulty = COALESCE(p_difficulty, difficulty),
    points = COALESCE(p_points, points),
    code_language = COALESCE(p_code_language, code_language),
    is_public = COALESCE(p_is_public, is_public),
    updated_at = NOW()
  WHERE id = p_question_id;

  RETURN FOUND;
END;
$$;


--
-- Name: update_quiz_settings(uuid, boolean, boolean, integer, boolean, integer, integer, boolean, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_quiz_settings(p_topic_id uuid, p_randomize_questions boolean DEFAULT NULL::boolean, p_randomize_options boolean DEFAULT NULL::boolean, p_passing_threshold integer DEFAULT NULL::integer, p_show_correct_answers boolean DEFAULT NULL::boolean, p_time_limit_minutes integer DEFAULT NULL::integer, p_max_attempts integer DEFAULT NULL::integer, p_allow_review boolean DEFAULT NULL::boolean, p_xp_reward integer DEFAULT NULL::integer) RETURNS uuid
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
DECLARE
  v_settings_id UUID;
BEGIN
  -- Ensure settings exist
  SELECT id INTO v_settings_id
  FROM get_or_create_quiz_settings(p_topic_id);

  -- Update settings
  UPDATE quiz_settings
  SET
    randomize_questions = COALESCE(p_randomize_questions, randomize_questions),
    randomize_options = COALESCE(p_randomize_options, randomize_options),
    passing_threshold = COALESCE(p_passing_threshold, passing_threshold),
    show_correct_answers = COALESCE(p_show_correct_answers, show_correct_answers),
    time_limit_minutes = COALESCE(p_time_limit_minutes, time_limit_minutes),
    max_attempts = COALESCE(p_max_attempts, max_attempts),
    allow_review = COALESCE(p_allow_review, allow_review),
    xp_reward = COALESCE(p_xp_reward, xp_reward),
    updated_at = NOW()
  WHERE id = v_settings_id;

  RETURN v_settings_id;
END;
$$;


--
-- Name: update_reading_progress_timestamp(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_reading_progress_timestamp() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_roles_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_roles_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_saved_searches_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_saved_searches_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_sequence_templates_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_sequence_templates_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$;


--
-- Name: update_sla_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_sla_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_submission_interview_count(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_submission_interview_count() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  UPDATE submissions SET
    interview_count = (SELECT COUNT(*) FROM interviews WHERE submission_id = NEW.submission_id),
    last_interview_date = NEW.scheduled_at
  WHERE id = NEW.submission_id;
  RETURN NEW;
END;
$$;


--
-- Name: update_submission_on_offer(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_submission_on_offer() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  IF NEW.status = 'accepted' AND (OLD.status IS NULL OR OLD.status != 'accepted') THEN
    UPDATE submissions SET
      status = 'placed',
      offer_accepted_at = NEW.accepted_at
    WHERE id = NEW.submission_id;
  ELSIF NEW.status = 'declined' THEN
    UPDATE submissions SET
      offer_declined_at = NEW.declined_at,
      offer_decline_reason = NEW.decline_reason
    WHERE id = NEW.submission_id;
  END IF;
  RETURN NEW;
END;
$$;


--
-- Name: update_timeline_search_vector(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_timeline_search_vector() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.search_vector :=
    setweight(to_tsvector('english', COALESCE(NEW.conversation_summary, '')), 'A') ||
    setweight(to_tsvector('english', COALESCE(NEW.user_intent, '')), 'B') ||
    setweight(to_tsvector('english', COALESCE(NEW.ai_generated_summary, '')), 'C') ||
    setweight(to_tsvector('english', array_to_string(COALESCE(NEW.tags, ARRAY[]::TEXT[]), ' ')), 'D');
  RETURN NEW;
END;
$$;


--
-- Name: update_topic_completions_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_topic_completions_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_updated_at_column(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_updated_at_column() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: FUNCTION update_updated_at_column(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.update_updated_at_column() IS 'Auto-update updated_at timestamp on row modification';


--
-- Name: update_user_profiles_search_vector(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_user_profiles_search_vector() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.search_vector :=
    setweight(to_tsvector('english', COALESCE(NEW.full_name, '')), 'A') ||
    setweight(to_tsvector('english', COALESCE(NEW.email, '')), 'B') ||
    setweight(to_tsvector('english', array_to_string(COALESCE(NEW.candidate_skills, ARRAY[]::TEXT[]), ' ')), 'C') ||
    setweight(to_tsvector('english', COALESCE(NEW.client_company_name, '')), 'D');
  RETURN NEW;
END;
$$;


--
-- Name: update_user_profiles_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_user_profiles_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_video_progress_timestamp(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_video_progress_timestamp() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: update_webhooks_updated_at(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_webhooks_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;


--
-- Name: user_belongs_to_org(uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.user_belongs_to_org(check_org_id uuid) RETURNS boolean
    LANGUAGE sql STABLE SECURITY DEFINER
    AS $$
  SELECT EXISTS (
    SELECT 1
    FROM user_profiles
    WHERE id = auth_user_id()
      AND org_id = check_org_id
  );
$$;


--
-- Name: FUNCTION user_belongs_to_org(check_org_id uuid); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.user_belongs_to_org(check_org_id uuid) IS 'Checks if the current user belongs to the specified organization';


--
-- Name: user_has_any_role(text[]); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.user_has_any_role(role_names text[]) RETURNS boolean
    LANGUAGE plpgsql STABLE SECURITY DEFINER
    AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1
    FROM user_roles ur
    JOIN roles r ON ur.role_id = r.id
    WHERE ur.user_id = auth_user_id()
      AND r.name = ANY(role_names)
      AND ur.deleted_at IS NULL
      AND (ur.expires_at IS NULL OR ur.expires_at > NOW())
      AND r.deleted_at IS NULL
  );
END;
$$;


--
-- Name: user_has_permission(uuid, text, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.user_has_permission(p_user_id uuid, p_resource text, p_action text) RETURNS boolean
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1
    FROM user_roles ur
    JOIN role_permissions rp ON rp.role_id = ur.role_id
    WHERE ur.user_id = p_user_id
    AND rp.resource = p_resource
    AND rp.action = p_action
  );
END;
$$;


--
-- Name: FUNCTION user_has_permission(p_user_id uuid, p_resource text, p_action text); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.user_has_permission(p_user_id uuid, p_resource text, p_action text) IS 'Checks if user has specific permission on resource';


--
-- Name: user_has_permission(uuid, text, text, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.user_has_permission(p_user_id uuid, p_resource text, p_action text, p_scope text DEFAULT 'own'::text) RETURNS boolean
    LANGUAGE plpgsql STABLE
    AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1
    FROM user_roles ur
    JOIN role_permissions rp ON ur.role_id = rp.role_id
    JOIN permissions p ON rp.permission_id = p.id
    WHERE ur.user_id = p_user_id
      AND ur.deleted_at IS NULL
      AND (ur.expires_at IS NULL OR ur.expires_at > NOW())
      AND p.resource = p_resource
      AND p.action = p_action
      AND (p.scope = p_scope OR p.scope = 'all')
      AND p.deleted_at IS NULL
  );
END;
$$;


--
-- Name: FUNCTION user_has_permission(p_user_id uuid, p_resource text, p_action text, p_scope text); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.user_has_permission(p_user_id uuid, p_resource text, p_action text, p_scope text) IS 'Check if a user has a specific permission (considers all their active roles).';


--
-- Name: user_has_role(text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.user_has_role(role_name text) RETURNS boolean
    LANGUAGE sql STABLE
    AS $$
  SELECT EXISTS (
    SELECT 1
    FROM public.user_roles ur
    JOIN public.roles r ON r.id = ur.role_id
    WHERE ur.user_id = auth.uid()
      AND r.name = role_name
  );
$$;


--
-- Name: FUNCTION user_has_role(role_name text); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.user_has_role(role_name text) IS 'Returns TRUE if authenticated user has the specified role';


--
-- Name: user_has_role(uuid, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.user_has_role(p_user_id uuid, p_role_name text) RETURNS boolean
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1
    FROM user_roles ur
    JOIN roles r ON r.id = ur.role_id
    WHERE ur.user_id = p_user_id
    AND r.name = p_role_name
  );
END;
$$;


--
-- Name: FUNCTION user_has_role(p_user_id uuid, p_role_name text); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.user_has_role(p_user_id uuid, p_role_name text) IS 'Checks if user has specific role by name';


--
-- Name: user_is_admin(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.user_is_admin() RETURNS boolean
    LANGUAGE plpgsql SECURITY DEFINER
    AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1
    FROM user_roles ur
    JOIN roles r ON r.id = ur.role_id
    WHERE ur.user_id = auth.uid()
    AND r.name = 'admin'
  );
END;
$$;


--
-- Name: FUNCTION user_is_admin(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.user_is_admin() IS 'Returns true if current user has admin role';


--
-- Name: user_is_org_admin(uuid, uuid); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.user_is_org_admin(user_id uuid, org_id uuid) RETURNS boolean
    LANGUAGE sql STABLE
    AS $$ SELECT EXISTS (SELECT 1 FROM public.user_roles ur JOIN public.roles r ON r.id = ur.role_id WHERE ur.user_id = user_id AND r.name = 'admin'); $$;


--
-- Name: validate_discount_code(text, uuid, uuid, text, numeric); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.validate_discount_code(p_code text, p_user_id uuid, p_course_id uuid DEFAULT NULL::uuid, p_plan_type text DEFAULT NULL::text, p_amount numeric DEFAULT NULL::numeric) RETURNS TABLE(is_valid boolean, discount_id uuid, discount_type text, discount_value numeric, error_message text)
    LANGUAGE plpgsql SECURITY DEFINER
    AS $_$
DECLARE
  v_discount RECORD;
  v_usage_count INTEGER;
BEGIN
  -- Get discount code
  SELECT * INTO v_discount
  FROM discount_codes
  WHERE code = p_code
    AND deleted_at IS NULL
    AND is_active = true
    AND valid_from <= NOW()
    AND (valid_until IS NULL OR valid_until >= NOW());

  -- Check if code exists
  IF v_discount IS NULL THEN
    RETURN QUERY SELECT false, NULL::UUID, NULL::TEXT, NULL::NUMERIC, 'Invalid or expired discount code';
    RETURN;
  END IF;

  -- Check max uses
  IF v_discount.max_uses IS NOT NULL AND v_discount.uses_count >= v_discount.max_uses THEN
    RETURN QUERY SELECT false, NULL::UUID, NULL::TEXT, NULL::NUMERIC, 'Discount code has reached maximum uses';
    RETURN;
  END IF;

  -- Check user-specific usage
  SELECT COUNT(*) INTO v_usage_count
  FROM discount_code_usage
  WHERE discount_code_id = v_discount.id
    AND user_id = p_user_id;

  IF v_discount.max_uses_per_user IS NOT NULL AND v_usage_count >= v_discount.max_uses_per_user THEN
    RETURN QUERY SELECT false, NULL::UUID, NULL::TEXT, NULL::NUMERIC, 'You have already used this discount code';
    RETURN;
  END IF;

  -- Check plan type restriction
  IF v_discount.applicable_plan_types IS NOT NULL AND p_plan_type IS NOT NULL THEN
    IF NOT (p_plan_type = ANY(v_discount.applicable_plan_types)) THEN
      RETURN QUERY SELECT false, NULL::UUID, NULL::TEXT, NULL::NUMERIC, 'Discount code not applicable to this plan';
      RETURN;
    END IF;
  END IF;

  -- Check course restriction
  IF v_discount.applicable_course_ids IS NOT NULL AND p_course_id IS NOT NULL THEN
    IF NOT (p_course_id = ANY(v_discount.applicable_course_ids)) THEN
      RETURN QUERY SELECT false, NULL::UUID, NULL::TEXT, NULL::NUMERIC, 'Discount code not applicable to this course';
      RETURN;
    END IF;
  END IF;

  -- Check minimum purchase amount
  IF v_discount.minimum_purchase_amount IS NOT NULL AND p_amount IS NOT NULL THEN
    IF p_amount < v_discount.minimum_purchase_amount THEN
      RETURN QUERY SELECT false, NULL::UUID, NULL::TEXT, NULL::NUMERIC,
        format('Minimum purchase amount of $%s required', v_discount.minimum_purchase_amount);
      RETURN;
    END IF;
  END IF;

  -- All validations passed
  RETURN QUERY SELECT
    true,
    v_discount.id,
    v_discount.discount_type,
    v_discount.discount_value,
    NULL::TEXT;
END;
$_$;


--
-- Name: validate_quiz_question(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.validate_quiz_question() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
  -- Validate options is an array
  IF jsonb_typeof(NEW.options) != 'array' THEN
    RAISE EXCEPTION 'options must be a JSON array';
  END IF;

  -- Validate correct_answers is an array
  IF jsonb_typeof(NEW.correct_answers) != 'array' THEN
    RAISE EXCEPTION 'correct_answers must be a JSON array';
  END IF;

  -- Type-specific validation
  CASE NEW.question_type
    WHEN 'true_false' THEN
      -- Must have exactly 2 options
      IF jsonb_array_length(NEW.options) != 2 THEN
        RAISE EXCEPTION 'true_false questions must have exactly 2 options';
      END IF;
      -- Must have exactly 1 correct answer
      IF jsonb_array_length(NEW.correct_answers) != 1 THEN
        RAISE EXCEPTION 'true_false questions must have exactly 1 correct answer';
      END IF;

    WHEN 'multiple_choice_single' THEN
      -- Must have at least 2 options
      IF jsonb_array_length(NEW.options) < 2 THEN
        RAISE EXCEPTION 'multiple_choice_single questions must have at least 2 options';
      END IF;
      -- Must have exactly 1 correct answer
      IF jsonb_array_length(NEW.correct_answers) != 1 THEN
        RAISE EXCEPTION 'multiple_choice_single questions must have exactly 1 correct answer';
      END IF;

    WHEN 'multiple_choice_multiple' THEN
      -- Must have at least 2 options
      IF jsonb_array_length(NEW.options) < 2 THEN
        RAISE EXCEPTION 'multiple_choice_multiple questions must have at least 2 options';
      END IF;
      -- Must have at least 1 correct answer
      IF jsonb_array_length(NEW.correct_answers) < 1 THEN
        RAISE EXCEPTION 'multiple_choice_multiple questions must have at least 1 correct answer';
      END IF;

    WHEN 'code' THEN
      -- Code language must be specified
      IF NEW.code_language IS NULL THEN
        RAISE EXCEPTION 'code questions must have a code_language specified';
      END IF;
  END CASE;

  RETURN NEW;
END;
$$;


--
-- Name: validate_single_accountable(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.validate_single_accountable() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
DECLARE
  accountable_count INTEGER;
BEGIN
  -- Only check if this is an accountable role
  IF NEW.role = 'accountable' THEN
    -- Count existing accountable owners for this entity (excluding self on update)
    SELECT COUNT(*) INTO accountable_count
    FROM object_owners
    WHERE entity_type = NEW.entity_type
      AND entity_id = NEW.entity_id
      AND role = 'accountable'
      AND id != COALESCE(NEW.id, '00000000-0000-0000-0000-000000000000'::uuid);

    IF accountable_count > 0 THEN
      RAISE EXCEPTION 'Entity already has an accountable owner. Use transferOwnership to change.';
    END IF;
  END IF;

  RETURN NEW;
END;
$$;


--
-- Name: validate_traffic_allocation(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.validate_traffic_allocation() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
DECLARE
  v_total INTEGER;
BEGIN
  -- Lock the table for this transaction to prevent race conditions
  LOCK TABLE ai_prompt_variants IN SHARE ROW EXCLUSIVE MODE;

  -- Calculate total active traffic excluding current row
  SELECT COALESCE(SUM(traffic_percentage), 0) INTO v_total
  FROM ai_prompt_variants
  WHERE is_active = true
  AND id != COALESCE(NEW.id, '00000000-0000-0000-0000-000000000000'::UUID);

  -- Check if new allocation would exceed 100%
  IF NEW.is_active AND (v_total + NEW.traffic_percentage > 100) THEN
    RAISE EXCEPTION 'Traffic allocation would exceed 100%% (current active: %, adding: %)',
      v_total, NEW.traffic_percentage
      USING HINT = 'Deactivate or reduce traffic for other variants first';
  END IF;

  RETURN NEW;
END;
$$;


--
-- Name: FUNCTION validate_traffic_allocation(); Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON FUNCTION public.validate_traffic_allocation() IS 'Ensures traffic percentage never exceeds 100% (with row-level locking for concurrency safety)';


--
-- Name: _migration_candidate_mapping; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public._migration_candidate_mapping (
    user_profile_id uuid NOT NULL,
    contact_id uuid NOT NULL,
    migrated_at timestamp with time zone DEFAULT now()
);


--
-- Name: _migration_lead_mapping; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public._migration_lead_mapping (
    lead_id uuid NOT NULL,
    contact_id uuid NOT NULL,
    migrated_at timestamp with time zone DEFAULT now()
);


--
-- Name: accounts; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.accounts (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    name text NOT NULL,
    industry text,
    company_type text DEFAULT 'direct_client'::text,
    status text DEFAULT 'prospect'::text NOT NULL,
    tier text,
    account_manager_id uuid,
    responsiveness text,
    preferred_quality text,
    description text,
    contract_start_date timestamp with time zone,
    contract_end_date timestamp with time zone,
    payment_terms_days integer DEFAULT 30,
    markup_percentage numeric(5,2),
    annual_revenue_target numeric(12,2),
    website text,
    phone text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid,
    updated_by uuid,
    deleted_at timestamp with time zone,
    search_vector tsvector,
    legal_name text,
    founded_year integer,
    employee_count integer,
    annual_revenue numeric(15,2),
    health_score integer,
    primary_contact_id uuid,
    onboarding_status text DEFAULT 'pending'::text,
    onboarding_completed_at timestamp with time zone,
    onboarding_completed_by uuid,
    nps_score integer,
    last_contact_date timestamp with time zone,
    next_contact_date timestamp with time zone,
    relationship_health text DEFAULT 'healthy'::text,
    billing_entity_name text,
    billing_email text,
    billing_phone text,
    billing_currency text DEFAULT 'USD'::text,
    billing_frequency text DEFAULT 'monthly'::text,
    po_required boolean DEFAULT false,
    current_po_number text,
    preferred_contact_method text DEFAULT 'email'::text,
    meeting_cadence text DEFAULT 'weekly'::text,
    communication_channel text,
    tax_id text,
    funding_stage text,
    company_size text,
    linkedin_url text,
    owner_id uuid,
    CONSTRAINT accounts_nps_score_check CHECK (((nps_score >= 0) AND (nps_score <= 10)))
);


--
-- Name: TABLE accounts; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.accounts IS 'Client companies and prospects';


--
-- Name: COLUMN accounts.onboarding_status; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.accounts.onboarding_status IS 'Account onboarding status: pending, in_progress, completed';


--
-- Name: COLUMN accounts.relationship_health; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.accounts.relationship_health IS 'Overall account health: healthy, attention, at_risk';


--
-- Name: addresses; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.addresses (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    entity_type text NOT NULL,
    entity_id uuid NOT NULL,
    address_type text NOT NULL,
    address_line_1 text,
    address_line_2 text,
    address_line_3 text,
    city text,
    state_province text,
    postal_code text,
    country_code text DEFAULT 'US'::text NOT NULL,
    county text,
    latitude numeric(10,7),
    longitude numeric(10,7),
    is_verified boolean DEFAULT false,
    verified_at timestamp with time zone,
    verification_source text,
    is_primary boolean DEFAULT false,
    effective_from date,
    effective_to date,
    notes text,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    created_by uuid,
    updated_by uuid,
    CONSTRAINT addresses_address_type_check CHECK ((address_type = ANY (ARRAY['current'::text, 'permanent'::text, 'mailing'::text, 'work'::text, 'billing'::text, 'shipping'::text, 'headquarters'::text, 'office'::text, 'job_location'::text, 'meeting'::text, 'first_day'::text]))),
    CONSTRAINT addresses_entity_type_check CHECK ((entity_type = ANY (ARRAY['candidate'::text, 'account'::text, 'contact'::text, 'vendor'::text, 'organization'::text, 'lead'::text, 'job'::text, 'interview'::text, 'employee'::text, 'placement'::text])))
);


--
-- Name: account_addresses_view; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.account_addresses_view AS
 SELECT a.id AS account_id,
    a.org_id,
    a.name AS account_name,
    addr.id AS address_id,
    addr.address_type,
    addr.address_line_1,
    addr.address_line_2,
    addr.address_line_3,
    addr.city,
    addr.state_province,
    addr.postal_code,
    addr.country_code,
    addr.county,
    addr.latitude,
    addr.longitude,
    addr.is_verified,
    addr.is_primary,
    addr.effective_from,
    addr.effective_to,
    addr.notes,
    addr.created_at,
    addr.updated_at
   FROM (public.accounts a
     LEFT JOIN public.addresses addr ON (((addr.entity_type = 'account'::text) AND (addr.entity_id = a.id))));


--
-- Name: VIEW account_addresses_view; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.account_addresses_view IS 'View for accessing account addresses from the unified addresses table';


--
-- Name: account_contacts; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.account_contacts (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    account_id uuid NOT NULL,
    contact_id uuid NOT NULL,
    vendor_id uuid,
    is_primary boolean DEFAULT false,
    role text,
    decision_authority text,
    relationship_started_at timestamp with time zone DEFAULT now(),
    relationship_notes text,
    is_active boolean DEFAULT true,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid,
    deleted_at timestamp with time zone,
    CONSTRAINT account_contacts_decision_authority_check CHECK (((decision_authority IS NULL) OR (decision_authority = ANY (ARRAY['decision_maker'::text, 'influencer'::text, 'gatekeeper'::text, 'end_user'::text, 'champion'::text]))))
);


--
-- Name: account_contracts; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.account_contracts (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    account_id uuid NOT NULL,
    contract_type text NOT NULL,
    status text DEFAULT 'draft'::text NOT NULL,
    name text,
    start_date timestamp with time zone,
    end_date timestamp with time zone,
    signed_date timestamp with time zone,
    value numeric(12,2),
    currency text DEFAULT 'USD'::text,
    terms jsonb,
    payment_terms_days integer,
    document_url text,
    notes text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid
);


--
-- Name: TABLE account_contracts; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.account_contracts IS 'MSA, SOW, NDA and other contract documents';


--
-- Name: account_metrics; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.account_metrics (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    account_id uuid NOT NULL,
    period text NOT NULL,
    period_start timestamp with time zone NOT NULL,
    period_end timestamp with time zone NOT NULL,
    total_placements integer DEFAULT 0,
    active_placements integer DEFAULT 0,
    ended_placements integer DEFAULT 0,
    total_revenue numeric(12,2) DEFAULT 0,
    total_margin numeric(12,2) DEFAULT 0,
    avg_ttf_days numeric(5,1),
    submission_to_interview_rate numeric(5,2),
    interview_to_offer_rate numeric(5,2),
    offer_acceptance_rate numeric(5,2),
    total_submissions integer DEFAULT 0,
    total_interviews integer DEFAULT 0,
    total_offers integer DEFAULT 0,
    health_score integer,
    calculated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE account_metrics; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.account_metrics IS 'Monthly performance metrics per account';


--
-- Name: account_notes; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.account_notes (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    account_id uuid NOT NULL,
    title text,
    content text NOT NULL,
    note_type text DEFAULT 'general'::text,
    is_pinned boolean DEFAULT false,
    created_by uuid NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_by uuid,
    deleted_at timestamp with time zone
);


--
-- Name: TABLE account_notes; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.account_notes IS 'General notes attached to accounts';


--
-- Name: account_preferences; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.account_preferences (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    account_id uuid NOT NULL,
    preferred_skills text[],
    excluded_skills text[],
    preferred_visa_types text[],
    excluded_visa_types text[],
    rate_range_min numeric(10,2),
    rate_range_max numeric(10,2),
    preferred_rate_type text DEFAULT 'hourly'::text,
    work_mode_preference text,
    onsite_requirement text,
    interview_process_notes text,
    typical_interview_rounds integer,
    interview_turnaround_days integer,
    background_check_required boolean DEFAULT false,
    drug_screen_required boolean DEFAULT false,
    security_clearance_required text,
    notes text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE account_preferences; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.account_preferences IS 'Hiring/staffing preferences for accounts';


--
-- Name: account_team; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.account_team (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    account_id uuid NOT NULL,
    user_id uuid NOT NULL,
    role text NOT NULL,
    assigned_at timestamp with time zone DEFAULT now() NOT NULL,
    unassigned_at timestamp with time zone,
    is_active boolean DEFAULT true,
    is_primary boolean DEFAULT false,
    notes text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid
);


--
-- Name: TABLE account_team; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.account_team IS 'RCAI team assignments for accounts';


--
-- Name: companies; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.companies (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    company_number character varying(50),
    category public.company_category NOT NULL,
    relationship_type public.company_relationship_type DEFAULT 'direct_client'::public.company_relationship_type NOT NULL,
    segment public.company_segment,
    tier public.company_tier DEFAULT 'standard'::public.company_tier,
    status public.company_status DEFAULT 'active'::public.company_status NOT NULL,
    name text NOT NULL,
    legal_name text,
    dba_name text,
    industry text,
    sub_industry text,
    sic_code character varying(10),
    naics_code character varying(10),
    employee_count integer,
    employee_range character varying(20),
    annual_revenue numeric(15,2),
    revenue_range character varying(20),
    founded_year integer,
    ownership_type character varying(50),
    parent_company_id uuid,
    hierarchy_level integer DEFAULT 0,
    hierarchy_path text,
    is_headquarters boolean DEFAULT true,
    website text,
    phone text,
    linkedin_url text,
    headquarters_city text,
    headquarters_state text,
    headquarters_country text DEFAULT 'USA'::text,
    timezone text DEFAULT 'America/New_York'::text,
    owner_id uuid,
    account_manager_id uuid,
    pod_id uuid,
    primary_contact_id uuid,
    is_msp_program boolean DEFAULT false,
    msp_provider_id uuid,
    our_msp_tier integer,
    vms_platform character varying(50),
    vms_vendor_id character varying(100),
    vms_api_enabled boolean DEFAULT false,
    msa_status character varying(20) DEFAULT 'none'::character varying,
    msa_effective_date date,
    msa_expiration_date date,
    msa_auto_renews boolean DEFAULT false,
    default_payment_terms character varying(20) DEFAULT 'Net 30'::character varying,
    default_currency character varying(3) DEFAULT 'USD'::character varying,
    default_markup_percentage numeric(5,2),
    default_fee_percentage numeric(5,2),
    credit_limit numeric(12,2),
    credit_status character varying(20) DEFAULT 'approved'::character varying,
    account_score integer,
    account_grade character(1),
    health_score integer,
    health_status character varying(20) DEFAULT 'healthy'::character varying,
    churn_risk integer,
    nps_score integer,
    lifetime_revenue numeric(15,2) DEFAULT 0,
    lifetime_placements integer DEFAULT 0,
    revenue_ytd numeric(15,2) DEFAULT 0,
    placements_ytd integer DEFAULT 0,
    revenue_last_12m numeric(15,2) DEFAULT 0,
    avg_margin_percentage numeric(5,2),
    first_engagement_date date,
    last_job_date date,
    last_placement_date date,
    last_activity_date timestamp with time zone,
    last_contacted_date timestamp with time zone,
    next_scheduled_contact date,
    active_jobs_count integer DEFAULT 0,
    active_placements_count integer DEFAULT 0,
    total_contacts_count integer DEFAULT 0,
    source character varying(50),
    source_detail text,
    source_campaign_id uuid,
    referring_company_id uuid,
    referring_contact_id uuid,
    converted_from_lead_id uuid,
    preferred_contact_method character varying(20) DEFAULT 'email'::character varying,
    submission_method character varying(20) DEFAULT 'email'::character varying,
    invoice_delivery_method character varying(20) DEFAULT 'email'::character varying,
    meeting_cadence character varying(20),
    is_strategic boolean DEFAULT false,
    requires_po boolean DEFAULT false,
    requires_approval_for_submission boolean DEFAULT false,
    allows_remote_work boolean DEFAULT true,
    onboarding_status text DEFAULT 'pending'::text,
    onboarding_completed_at timestamp with time zone,
    onboarding_completed_by uuid,
    onboarding_data jsonb DEFAULT '{}'::jsonb,
    tags text[],
    custom_fields jsonb DEFAULT '{}'::jsonb,
    preferences jsonb DEFAULT '{}'::jsonb,
    legacy_account_id uuid,
    legacy_vendor_id uuid,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid,
    updated_by uuid,
    deleted_at timestamp with time zone,
    search_vector tsvector,
    CONSTRAINT companies_account_grade_check CHECK ((account_grade = ANY (ARRAY['A'::bpchar, 'B'::bpchar, 'C'::bpchar, 'D'::bpchar]))),
    CONSTRAINT companies_account_score_check CHECK (((account_score >= 0) AND (account_score <= 100))),
    CONSTRAINT companies_churn_risk_check CHECK (((churn_risk >= 0) AND (churn_risk <= 100))),
    CONSTRAINT companies_health_score_check CHECK (((health_score >= 0) AND (health_score <= 100))),
    CONSTRAINT companies_nps_score_check CHECK (((nps_score >= '-100'::integer) AND (nps_score <= 100))),
    CONSTRAINT companies_our_msp_tier_check CHECK (((our_msp_tier >= 1) AND (our_msp_tier <= 5))),
    CONSTRAINT valid_hierarchy CHECK (((parent_company_id IS NULL) OR (parent_company_id <> id))),
    CONSTRAINT valid_msp_reference CHECK (((msp_provider_id IS NULL) OR (msp_provider_id <> id)))
);


--
-- Name: TABLE companies; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.companies IS 'Unified table for all business entities (clients, vendors, partners, prospects)';


--
-- Name: COLUMN companies.category; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.companies.category IS 'Primary classification: client, vendor, partner, prospect';


--
-- Name: COLUMN companies.legacy_account_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.companies.legacy_account_id IS 'Reference to original accounts.id for migration tracking';


--
-- Name: COLUMN companies.legacy_vendor_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.companies.legacy_vendor_id IS 'Reference to original vendors.id for migration tracking';


--
-- Name: company_client_details; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.company_client_details (
    company_id uuid NOT NULL,
    org_id uuid NOT NULL,
    billing_entity_name text,
    billing_email text,
    billing_phone text,
    billing_contact_id uuid,
    po_required boolean DEFAULT false,
    current_po_number text,
    po_expiration_date date,
    invoice_format character varying(20) DEFAULT 'standard'::character varying,
    invoice_consolidation character varying(20) DEFAULT 'per_placement'::character varying,
    invoice_due_reminder_days integer DEFAULT 7,
    billing_address_line_1 text,
    billing_address_line_2 text,
    billing_city text,
    billing_state text,
    billing_postal_code text,
    billing_country text DEFAULT 'USA'::text,
    preferred_work_arrangements text[],
    preferred_contract_types text[],
    allows_contract_to_hire boolean DEFAULT true,
    cth_conversion_fee_percentage numeric(5,2),
    cth_conversion_credit_days integer DEFAULT 90,
    responsiveness_rating character varying(20),
    feedback_quality_rating character varying(20),
    hiring_speed_rating character varying(20),
    preferred_experience_levels text[],
    typical_interview_rounds integer,
    avg_time_to_decision_days integer,
    interview_process_notes text,
    exclusive_supplier boolean DEFAULT false,
    exclusive_start_date date,
    exclusive_end_date date,
    known_competitors text[],
    wallet_share_percentage numeric(5,2),
    qbr_frequency character varying(20),
    last_qbr_date date,
    next_qbr_date date,
    executive_sponsor_id uuid,
    legacy_billing_data jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE company_client_details; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.company_client_details IS 'Extension table for client/prospect-specific fields (class table inheritance)';


--
-- Name: accounts_v; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.accounts_v AS
 SELECT c.id,
    c.org_id,
    c.name,
    c.legal_name,
    c.industry,
    (c.status)::text AS status,
    (c.tier)::text AS tier,
    (c.segment)::text AS company_type,
    c.website,
    c.phone,
    c.linkedin_url,
    c.headquarters_city,
    c.headquarters_state,
    concat(c.headquarters_city, ', ', c.headquarters_state) AS headquarters_location,
    c.employee_count,
    c.annual_revenue,
    c.founded_year,
    c.owner_id,
    c.account_manager_id,
    c.primary_contact_id,
    c.health_score,
    c.health_status AS relationship_health,
    c.nps_score,
    c.last_contacted_date AS last_contact_date,
    c.next_scheduled_contact AS next_contact_date,
    c.default_markup_percentage AS markup_percentage,
    c.onboarding_status,
    c.onboarding_completed_at,
    c.onboarding_completed_by,
    c.preferred_contact_method,
    c.meeting_cadence,
    c.requires_po AS po_required,
    cd.billing_entity_name,
    cd.billing_email,
    cd.billing_phone,
    cd.billing_address_line_1 AS billing_address,
    cd.billing_city,
    cd.billing_state,
    cd.billing_postal_code,
    cd.billing_country,
    cd.current_po_number,
    c.tags,
    c.custom_fields,
    c.created_at,
    c.updated_at,
    c.created_by,
    c.updated_by,
    c.deleted_at,
    c.search_vector
   FROM (public.companies c
     LEFT JOIN public.company_client_details cd ON ((cd.company_id = c.id)))
  WHERE ((c.category = ANY (ARRAY['client'::public.company_category, 'prospect'::public.company_category])) AND (c.deleted_at IS NULL));


--
-- Name: VIEW accounts_v; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.accounts_v IS 'Backward compatibility view for accounts table - maps to companies with category IN (client, prospect)';


--
-- Name: achievements; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.achievements (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    slug text NOT NULL,
    name text NOT NULL,
    description text NOT NULL,
    category text NOT NULL,
    badge_url text,
    xp_reward integer DEFAULT 0 NOT NULL,
    criteria jsonb NOT NULL,
    is_secret boolean DEFAULT false,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: activities; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.activities (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    entity_type text NOT NULL,
    entity_id uuid NOT NULL,
    activity_type text NOT NULL,
    status text DEFAULT 'open'::text NOT NULL,
    priority text DEFAULT 'medium'::text NOT NULL,
    subject text,
    body text,
    direction text,
    scheduled_at timestamp with time zone,
    due_date timestamp with time zone DEFAULT now(),
    escalation_date timestamp with time zone,
    completed_at timestamp with time zone,
    skipped_at timestamp with time zone,
    duration_minutes integer,
    outcome text,
    assigned_to uuid,
    performed_by uuid,
    poc_id uuid,
    parent_activity_id uuid,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid,
    pattern_code text,
    pattern_id uuid,
    workplan_instance_id uuid,
    description text,
    category text,
    instructions text,
    checklist jsonb,
    checklist_progress jsonb,
    assigned_group uuid,
    assigned_at timestamp with time zone,
    started_at timestamp with time zone,
    scheduled_for timestamp with time zone,
    outcome_notes text,
    auto_created boolean DEFAULT false,
    auto_completed boolean DEFAULT false,
    predecessor_activity_id uuid,
    escalation_count integer DEFAULT 0,
    last_escalated_at timestamp with time zone,
    reminder_sent_at timestamp with time zone,
    reminder_count integer DEFAULT 0,
    deleted_at timestamp with time zone,
    updated_by uuid,
    activity_number text,
    secondary_entity_type text,
    secondary_entity_id uuid,
    follow_up_required boolean DEFAULT false,
    follow_up_date timestamp with time zone,
    follow_up_activity_id uuid,
    tags text[],
    custom_fields jsonb DEFAULT '{}'::jsonb,
    points_earned numeric(5,2) DEFAULT 0,
    related_contact_id uuid,
    related_deal_id uuid,
    related_campaign_id uuid,
    next_steps text,
    next_follow_up_date timestamp with time zone
);


--
-- Name: TABLE activities; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.activities IS 'Unified activities table for all entity types (leads, deals, accounts, campaigns, etc.) - replaces crm_activities';


--
-- Name: COLUMN activities.pattern_code; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activities.pattern_code IS 'Code of the activity pattern used (denormalized for performance)';


--
-- Name: COLUMN activities.pattern_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activities.pattern_id IS 'Reference to activity pattern template';


--
-- Name: COLUMN activities.workplan_instance_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activities.workplan_instance_id IS 'Reference to workplan instance if part of a workflow';


--
-- Name: COLUMN activities.description; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activities.description IS 'Extended description of the activity';


--
-- Name: COLUMN activities.category; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activities.category IS 'Activity category for grouping';


--
-- Name: COLUMN activities.instructions; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activities.instructions IS 'Step-by-step instructions for completing the activity';


--
-- Name: COLUMN activities.checklist; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activities.checklist IS 'Checklist items as JSONB (legacy - use activity_checklist_items)';


--
-- Name: COLUMN activities.checklist_progress; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activities.checklist_progress IS 'Checklist completion progress';


--
-- Name: COLUMN activities.assigned_group; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activities.assigned_group IS 'Pod/team assigned to this activity';


--
-- Name: COLUMN activities.assigned_at; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activities.assigned_at IS 'When the activity was assigned';


--
-- Name: COLUMN activities.started_at; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activities.started_at IS 'When work started on this activity';


--
-- Name: COLUMN activities.scheduled_for; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activities.scheduled_for IS 'Scheduled date/time for this activity';


--
-- Name: COLUMN activities.outcome_notes; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activities.outcome_notes IS 'Detailed notes about the outcome';


--
-- Name: COLUMN activities.auto_created; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activities.auto_created IS 'Whether this activity was auto-created by a rule';


--
-- Name: COLUMN activities.auto_completed; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activities.auto_completed IS 'Whether this activity was auto-completed';


--
-- Name: COLUMN activities.predecessor_activity_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activities.predecessor_activity_id IS 'Activity that must complete before this one';


--
-- Name: COLUMN activities.escalation_count; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activities.escalation_count IS 'Number of times this activity has been escalated';


--
-- Name: COLUMN activities.last_escalated_at; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activities.last_escalated_at IS 'When this activity was last escalated';


--
-- Name: COLUMN activities.reminder_sent_at; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activities.reminder_sent_at IS 'When the last reminder was sent';


--
-- Name: COLUMN activities.reminder_count; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activities.reminder_count IS 'Number of reminders sent';


--
-- Name: COLUMN activities.deleted_at; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activities.deleted_at IS 'Soft delete timestamp';


--
-- Name: COLUMN activities.updated_by; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activities.updated_by IS 'User who last updated this activity';


--
-- Name: COLUMN activities.activity_number; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activities.activity_number IS 'Human-readable identifier (e.g., CALL-2024-00001)';


--
-- Name: COLUMN activities.secondary_entity_type; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activities.secondary_entity_type IS 'Type of secondary linked entity (for multi-entity activities)';


--
-- Name: COLUMN activities.secondary_entity_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activities.secondary_entity_id IS 'ID of secondary linked entity';


--
-- Name: COLUMN activities.follow_up_required; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activities.follow_up_required IS 'Whether this activity requires a follow-up';


--
-- Name: COLUMN activities.follow_up_date; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activities.follow_up_date IS 'When the follow-up should occur';


--
-- Name: COLUMN activities.follow_up_activity_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activities.follow_up_activity_id IS 'Reference to the follow-up activity if created';


--
-- Name: COLUMN activities.tags; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activities.tags IS 'Array of tags for categorization and filtering';


--
-- Name: COLUMN activities.custom_fields; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activities.custom_fields IS 'JSONB for org-specific custom fields';


--
-- Name: activity_attachments; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.activity_attachments (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    activity_id uuid NOT NULL,
    file_name text NOT NULL,
    file_size integer,
    file_type text,
    file_url text NOT NULL,
    storage_key text,
    description text,
    deleted_at timestamp with time zone,
    uploaded_at timestamp with time zone DEFAULT now() NOT NULL,
    uploaded_by uuid NOT NULL
);


--
-- Name: TABLE activity_attachments; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.activity_attachments IS 'File attachments for activities';


--
-- Name: activity_auto_rules; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.activity_auto_rules (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid,
    rule_name text NOT NULL,
    rule_code text NOT NULL,
    description text,
    event_type text NOT NULL,
    event_category text NOT NULL,
    entity_type text NOT NULL,
    condition jsonb,
    activity_pattern_id uuid NOT NULL,
    delay_days integer DEFAULT 0,
    delay_hours integer DEFAULT 0,
    assign_to_field text,
    assign_to_user_id uuid,
    assign_to_group_id uuid,
    is_active boolean DEFAULT true,
    priority integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE activity_auto_rules; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.activity_auto_rules IS 'Event-driven rules for automatic activity creation';


--
-- Name: activity_checklist_items; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.activity_checklist_items (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    activity_id uuid NOT NULL,
    pattern_checklist_item_id uuid,
    item_text text NOT NULL,
    order_index integer DEFAULT 0,
    is_completed boolean DEFAULT false,
    completed_at timestamp with time zone,
    completed_by uuid,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE activity_checklist_items; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.activity_checklist_items IS 'Checklist items for activity instances';


--
-- Name: activity_comments; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.activity_comments (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    activity_id uuid NOT NULL,
    comment_text text NOT NULL,
    comment_type text DEFAULT 'comment'::text,
    parent_comment_id uuid,
    mentioned_users uuid[],
    is_internal boolean DEFAULT false,
    deleted_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_by uuid
);


--
-- Name: TABLE activity_comments; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.activity_comments IS 'Comments and discussion threads for activities';


--
-- Name: activity_dependencies; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.activity_dependencies (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    activity_id uuid NOT NULL,
    depends_on_activity_id uuid NOT NULL,
    dependency_type text DEFAULT 'finish_to_start'::text,
    lag_days integer DEFAULT 0,
    is_strict boolean DEFAULT true,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE activity_dependencies; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.activity_dependencies IS 'Blocking dependencies between activities';


--
-- Name: activity_field_values; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.activity_field_values (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    activity_id uuid NOT NULL,
    field_id uuid NOT NULL,
    field_value text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE activity_field_values; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.activity_field_values IS 'Custom field values for activity instances';


--
-- Name: activity_history; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.activity_history (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    activity_id uuid NOT NULL,
    action text NOT NULL,
    field_changed text,
    old_value text,
    new_value text,
    changed_by uuid,
    changed_at timestamp with time zone DEFAULT now() NOT NULL,
    notes text
);


--
-- Name: TABLE activity_history; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.activity_history IS 'Audit trail of activity changes';


--
-- Name: activity_log; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.activity_log (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    entity_type text NOT NULL,
    entity_id uuid NOT NULL,
    activity_type text NOT NULL,
    subject text,
    body text,
    direction text,
    performed_by uuid,
    poc_id uuid,
    activity_date timestamp with time zone DEFAULT now() NOT NULL,
    duration_minutes integer,
    outcome text,
    next_action text,
    next_action_date timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE activity_log; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.activity_log IS 'Communication history and interactions';


--
-- Name: activity_metrics; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.activity_metrics (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    metric_date timestamp with time zone NOT NULL,
    entity_type text,
    activity_type text,
    activity_category text,
    user_id uuid,
    pod_id uuid,
    total_activities integer DEFAULT 0,
    created_activities integer DEFAULT 0,
    completed_activities integer DEFAULT 0,
    overdue_activities integer DEFAULT 0,
    completion_rate numeric(5,2),
    avg_completion_time_hours numeric(10,2),
    sla_met_count integer DEFAULT 0,
    sla_breached_count integer DEFAULT 0,
    sla_compliance_rate numeric(5,2),
    total_time_minutes integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE activity_metrics; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.activity_metrics IS 'Aggregated activity performance metrics';


--
-- Name: activity_number_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.activity_number_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: activity_participants; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.activity_participants (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    activity_id uuid NOT NULL,
    user_id uuid NOT NULL,
    role text NOT NULL,
    permission text DEFAULT 'view'::text,
    is_primary boolean DEFAULT false,
    notify_on_update boolean DEFAULT true,
    added_at timestamp with time zone DEFAULT now() NOT NULL,
    added_by uuid
);


--
-- Name: TABLE activity_participants; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.activity_participants IS 'RCAI (Responsible, Accountable, Consulted, Informed) model for activities';


--
-- Name: activity_pattern_successors; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.activity_pattern_successors (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    pattern_id uuid NOT NULL,
    successor_pattern_id uuid NOT NULL,
    condition_type text DEFAULT 'always'::text,
    condition_field text,
    condition_value text,
    condition_expression jsonb,
    delay_days integer DEFAULT 0,
    order_index integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE activity_pattern_successors; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.activity_pattern_successors IS 'Sequential flow of activity patterns';


--
-- Name: activity_patterns; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.activity_patterns (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid,
    code text NOT NULL,
    name text NOT NULL,
    description text,
    target_days integer DEFAULT 1,
    escalation_days integer,
    default_assignee text DEFAULT 'owner'::text,
    assignee_group_id uuid,
    assignee_user_id uuid,
    priority text DEFAULT 'normal'::text,
    auto_complete boolean DEFAULT false,
    auto_complete_condition jsonb,
    auto_action text,
    auto_action_config jsonb,
    category text,
    entity_type text NOT NULL,
    instructions text,
    checklist jsonb,
    is_system boolean DEFAULT false,
    is_active boolean DEFAULT true,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    icon text DEFAULT '📋'::text,
    color text DEFAULT 'blue'::text,
    display_order integer DEFAULT 100,
    show_in_timeline boolean DEFAULT true,
    outcomes jsonb DEFAULT '[]'::jsonb,
    points numeric(5,2) DEFAULT 0,
    point_multipliers jsonb DEFAULT '[]'::jsonb,
    auto_log_integrations text[] DEFAULT '{}'::text[],
    followup_rules jsonb DEFAULT '[]'::jsonb,
    field_dependencies jsonb DEFAULT '[]'::jsonb,
    created_by uuid
);


--
-- Name: TABLE activity_patterns; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.activity_patterns IS 'Reusable activity templates with default configuration';


--
-- Name: COLUMN activity_patterns.icon; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activity_patterns.icon IS 'Emoji or icon identifier for UI display';


--
-- Name: COLUMN activity_patterns.color; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activity_patterns.color IS 'Color theme for categorization (blue, green, red, etc.)';


--
-- Name: COLUMN activity_patterns.display_order; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activity_patterns.display_order IS 'Sort order within category (lower = higher priority)';


--
-- Name: COLUMN activity_patterns.show_in_timeline; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activity_patterns.show_in_timeline IS 'Whether to show this activity type in entity timelines';


--
-- Name: COLUMN activity_patterns.outcomes; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activity_patterns.outcomes IS 'Predefined outcome options with colors and next actions';


--
-- Name: COLUMN activity_patterns.points; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activity_patterns.points IS 'Base points earned when activity is logged';


--
-- Name: COLUMN activity_patterns.point_multipliers; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activity_patterns.point_multipliers IS 'Conditional point multipliers based on outcome/duration';


--
-- Name: COLUMN activity_patterns.auto_log_integrations; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activity_patterns.auto_log_integrations IS 'Integration types that auto-log this activity';


--
-- Name: COLUMN activity_patterns.followup_rules; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activity_patterns.followup_rules IS 'Auto follow-up task creation rules';


--
-- Name: COLUMN activity_patterns.field_dependencies; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.activity_patterns.field_dependencies IS 'Conditional field requirements';


--
-- Name: activity_reminders; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.activity_reminders (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    activity_id uuid NOT NULL,
    user_id uuid NOT NULL,
    remind_at timestamp with time zone NOT NULL,
    reminder_type text DEFAULT 'relative'::text,
    relative_days integer,
    relative_hours integer,
    channel text DEFAULT 'email'::text,
    is_sent boolean DEFAULT false,
    sent_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE activity_reminders; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.activity_reminders IS 'Reminder configuration for activities';


--
-- Name: activity_stats_daily; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.activity_stats_daily (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    user_id uuid NOT NULL,
    date date NOT NULL,
    pattern_id uuid,
    count integer DEFAULT 0,
    total_duration_minutes integer DEFAULT 0,
    total_points numeric(10,2) DEFAULT 0,
    outcomes jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE activity_stats_daily; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.activity_stats_daily IS 'Aggregated daily activity statistics per user and pattern';


--
-- Name: activity_time_entries; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.activity_time_entries (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    activity_id uuid NOT NULL,
    user_id uuid NOT NULL,
    start_time timestamp with time zone NOT NULL,
    end_time timestamp with time zone,
    duration_minutes integer,
    description text,
    is_billable boolean DEFAULT false,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE activity_time_entries; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.activity_time_entries IS 'Time tracking for activities';


--
-- Name: ai_agent_interactions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.ai_agent_interactions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    user_id uuid,
    agent_name text NOT NULL,
    interaction_type text NOT NULL,
    input text,
    output text,
    model_used text,
    tokens_used integer DEFAULT 0,
    cost_usd numeric(10,6) DEFAULT 0.00,
    latency_ms integer DEFAULT 0,
    success boolean DEFAULT true NOT NULL,
    error_message text,
    metadata jsonb DEFAULT '{}'::jsonb NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT ai_agent_interactions_cost_positive CHECK ((cost_usd >= (0)::numeric)),
    CONSTRAINT ai_agent_interactions_latency_positive CHECK ((latency_ms >= 0)),
    CONSTRAINT ai_agent_interactions_tokens_positive CHECK ((tokens_used >= 0))
);


--
-- Name: TABLE ai_agent_interactions; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.ai_agent_interactions IS 'Agent execution logs (Sprint 2: AI-INF-005)';


--
-- Name: COLUMN ai_agent_interactions.interaction_type; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.ai_agent_interactions.interaction_type IS 'Type of interaction (query, briefing, suggestion, etc.)';


--
-- Name: ai_conversations; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.ai_conversations (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    agent_type text NOT NULL,
    messages jsonb DEFAULT '[]'::jsonb NOT NULL,
    metadata jsonb DEFAULT '{}'::jsonb NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE ai_conversations; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.ai_conversations IS 'Long-term storage for AI agent conversations';


--
-- Name: COLUMN ai_conversations.agent_type; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.ai_conversations.agent_type IS 'Type of AI agent (code_mentor, employee_twin, etc.)';


--
-- Name: COLUMN ai_conversations.messages; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.ai_conversations.messages IS 'Array of messages in JSONB format';


--
-- Name: COLUMN ai_conversations.metadata; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.ai_conversations.metadata IS 'Additional conversation metadata';


--
-- Name: ai_cost_tracking; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.ai_cost_tracking (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    user_id uuid,
    provider text NOT NULL,
    model text NOT NULL,
    input_tokens integer DEFAULT 0 NOT NULL,
    output_tokens integer DEFAULT 0 NOT NULL,
    cost_usd numeric(10,6) DEFAULT 0.00 NOT NULL,
    latency_ms integer DEFAULT 0 NOT NULL,
    metadata jsonb DEFAULT '{}'::jsonb NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT ai_cost_tracking_cost_positive CHECK ((cost_usd >= (0)::numeric)),
    CONSTRAINT ai_cost_tracking_latency_positive CHECK ((latency_ms >= 0)),
    CONSTRAINT ai_cost_tracking_provider_check CHECK ((provider = ANY (ARRAY['openai'::text, 'anthropic'::text]))),
    CONSTRAINT ai_cost_tracking_tokens_positive CHECK (((input_tokens >= 0) AND (output_tokens >= 0)))
);


--
-- Name: TABLE ai_cost_tracking; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.ai_cost_tracking IS 'AI API cost tracking via Helicone (Sprint 2: AI-INF-004)';


--
-- Name: COLUMN ai_cost_tracking.cost_usd; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.ai_cost_tracking.cost_usd IS 'Cost in USD (6 decimal precision for micro-transactions)';


--
-- Name: COLUMN ai_cost_tracking.metadata; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.ai_cost_tracking.metadata IS 'Additional context (agent name, task type, etc.)';


--
-- Name: ai_embeddings; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.ai_embeddings (
    id text NOT NULL,
    content text NOT NULL,
    embedding public.vector(1536) NOT NULL,
    metadata jsonb DEFAULT '{}'::jsonb NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE ai_embeddings; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.ai_embeddings IS 'Vector embeddings for semantic search (RAG)';


--
-- Name: COLUMN ai_embeddings.embedding; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.ai_embeddings.embedding IS '1536-dimensional vector from text-embedding-3-small';


--
-- Name: ai_foundation_validation; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.ai_foundation_validation AS
 SELECT 'RLS Functions'::text AS component,
        CASE
            WHEN (count(*) = 4) THEN 'OK'::text
            ELSE 'MISSING'::text
        END AS status
   FROM pg_proc
  WHERE ((pg_proc.proname = ANY (ARRAY['auth_user_id'::name, 'auth_user_org_id'::name, 'user_is_admin'::name, 'user_has_role'::name])) AND (pg_proc.pronamespace = ('public'::regnamespace)::oid))
UNION ALL
 SELECT 'AI Tables'::text AS component,
        CASE
            WHEN (count(*) = 3) THEN 'OK'::text
            ELSE 'MISSING'::text
        END AS status
   FROM pg_tables
  WHERE ((pg_tables.schemaname = 'public'::name) AND (pg_tables.tablename = ANY (ARRAY['ai_conversations'::name, 'ai_embeddings'::name, 'ai_patterns'::name])))
UNION ALL
 SELECT 'pgvector Extension'::text AS component,
        CASE
            WHEN (count(*) = 1) THEN 'OK'::text
            ELSE 'NOT INSTALLED'::text
        END AS status
   FROM pg_extension
  WHERE (pg_extension.extname = 'vector'::name)
UNION ALL
 SELECT 'Vector Search Function'::text AS component,
        CASE
            WHEN (count(*) = 1) THEN 'OK'::text
            ELSE 'MISSING'::text
        END AS status
   FROM pg_proc
  WHERE ((pg_proc.proname = 'search_embeddings'::name) AND (pg_proc.pronamespace = ('public'::regnamespace)::oid));


--
-- Name: VIEW ai_foundation_validation; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.ai_foundation_validation IS 'Validation status for AI foundation infrastructure';


--
-- Name: ai_mentor_chats; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.ai_mentor_chats (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    topic_id uuid,
    course_id uuid,
    question text NOT NULL,
    response text NOT NULL,
    conversation_context jsonb DEFAULT '[]'::jsonb,
    tokens_used integer DEFAULT 0 NOT NULL,
    response_time_ms integer DEFAULT 0 NOT NULL,
    model text DEFAULT 'gpt-4o-mini'::text NOT NULL,
    cost_usd numeric(10,6) DEFAULT 0,
    student_rating integer,
    student_feedback text,
    flagged_for_review boolean DEFAULT false,
    escalated_to_trainer boolean DEFAULT false,
    escalation_reason text,
    created_at timestamp with time zone DEFAULT now(),
    rated_at timestamp with time zone,
    escalated_at timestamp with time zone,
    prompt_variant_id uuid,
    question_hash text GENERATED ALWAYS AS (md5(lower(TRIM(BOTH FROM question)))) STORED,
    CONSTRAINT ai_mentor_chats_student_rating_check CHECK (((student_rating >= 1) AND (student_rating <= 5)))
);


--
-- Name: TABLE ai_mentor_chats; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.ai_mentor_chats IS 'AI mentor chat history with metrics and quality control';


--
-- Name: COLUMN ai_mentor_chats.question_hash; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.ai_mentor_chats.question_hash IS 'MD5 hash of normalized question for fast pattern matching (generated column)';


--
-- Name: module_topics; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.module_topics (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    module_id uuid NOT NULL,
    slug text NOT NULL,
    title text NOT NULL,
    description text,
    topic_number integer NOT NULL,
    estimated_duration_minutes integer,
    content_type text NOT NULL,
    prerequisite_topic_ids uuid[],
    is_published boolean DEFAULT false,
    is_required boolean DEFAULT true,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT module_topics_content_type_check CHECK ((content_type = ANY (ARRAY['video'::text, 'reading'::text, 'quiz'::text, 'lab'::text, 'project'::text])))
);


--
-- Name: TABLE module_topics; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.module_topics IS 'Specific lessons within modules (typically 5-10 topics per module)';


--
-- Name: ai_mentor_cost_breakdown; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.ai_mentor_cost_breakdown AS
 SELECT date(mc.created_at) AS date,
    mc.topic_id,
    mt.title AS topic_title,
    count(*) AS chat_count,
    sum(mc.tokens_used) AS total_tokens,
    sum(mc.cost_usd) AS total_cost,
    avg(mc.cost_usd) AS avg_cost_per_chat,
    ((sum(mc.cost_usd) / (NULLIF(sum(mc.tokens_used), 0))::numeric) * (1000)::numeric) AS cost_per_1k_tokens,
    (sum(mc.cost_usd) / (NULLIF(count(*) FILTER (WHERE (mc.student_rating >= 4)), 0))::numeric) AS cost_per_helpful_response
   FROM (public.ai_mentor_chats mc
     LEFT JOIN public.module_topics mt ON ((mt.id = mc.topic_id)))
  WHERE (mc.created_at >= (CURRENT_DATE - '30 days'::interval))
  GROUP BY (date(mc.created_at)), mc.topic_id, mt.title
  ORDER BY (date(mc.created_at)) DESC, (sum(mc.cost_usd)) DESC;


--
-- Name: VIEW ai_mentor_cost_breakdown; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.ai_mentor_cost_breakdown IS 'Cost analysis by date and topic';


--
-- Name: ai_mentor_daily_stats; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.ai_mentor_daily_stats AS
 SELECT date(created_at) AS date,
    count(*) AS total_chats,
    count(DISTINCT user_id) AS unique_users,
    sum(tokens_used) AS total_tokens,
    sum(cost_usd) AS total_cost,
    avg(response_time_ms) AS avg_response_time_ms,
    avg(student_rating) FILTER (WHERE (student_rating IS NOT NULL)) AS avg_rating,
    count(*) FILTER (WHERE (flagged_for_review = true)) AS flagged_count,
    count(*) FILTER (WHERE (escalated_to_trainer = true)) AS escalated_count
   FROM public.ai_mentor_chats
  GROUP BY (date(created_at))
  ORDER BY (date(created_at)) DESC;


--
-- Name: VIEW ai_mentor_daily_stats; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.ai_mentor_daily_stats IS 'Daily aggregated AI mentor usage and cost statistics';


--
-- Name: ai_mentor_escalations; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.ai_mentor_escalations (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    chat_id uuid NOT NULL,
    user_id uuid NOT NULL,
    topic_id uuid,
    reason text NOT NULL,
    confidence numeric(3,2),
    auto_detected boolean DEFAULT true,
    triggers jsonb DEFAULT '{}'::jsonb,
    metadata jsonb DEFAULT '{}'::jsonb,
    assigned_to uuid,
    assigned_at timestamp with time zone,
    status text DEFAULT 'pending'::text,
    resolved_by uuid,
    resolved_at timestamp with time zone,
    resolution_notes text,
    resolution_time_minutes integer,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT ai_mentor_escalations_confidence_check CHECK (((confidence >= (0)::numeric) AND (confidence <= (1)::numeric))),
    CONSTRAINT ai_mentor_escalations_status_check CHECK ((status = ANY (ARRAY['pending'::text, 'in_progress'::text, 'resolved'::text, 'dismissed'::text])))
);


--
-- Name: TABLE ai_mentor_escalations; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.ai_mentor_escalations IS 'Tracks escalations from AI mentor to human trainers';


--
-- Name: ai_mentor_hourly_stats; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.ai_mentor_hourly_stats AS
 SELECT date_trunc('hour'::text, created_at) AS hour,
    count(*) AS total_chats,
    count(DISTINCT user_id) AS unique_users,
    sum(tokens_used) AS total_tokens,
    sum(cost_usd) AS total_cost,
    avg(response_time_ms) AS avg_response_time_ms,
    avg(student_rating) FILTER (WHERE (student_rating IS NOT NULL)) AS avg_rating,
    count(*) FILTER (WHERE (student_rating >= 4)) AS positive_ratings,
    count(*) FILTER (WHERE (student_rating <= 2)) AS negative_ratings,
    count(*) FILTER (WHERE (flagged_for_review = true)) AS flagged_count,
    count(*) FILTER (WHERE (escalated_to_trainer = true)) AS escalated_count
   FROM public.ai_mentor_chats
  WHERE (created_at >= (now() - '7 days'::interval))
  GROUP BY (date_trunc('hour'::text, created_at))
  ORDER BY (date_trunc('hour'::text, created_at)) DESC;


--
-- Name: VIEW ai_mentor_hourly_stats; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.ai_mentor_hourly_stats IS 'Hourly metrics for real-time monitoring';


--
-- Name: ai_mentor_rate_limits; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.ai_mentor_rate_limits (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    hourly_count integer DEFAULT 0 NOT NULL,
    daily_count integer DEFAULT 0 NOT NULL,
    monthly_count integer DEFAULT 0 NOT NULL,
    hourly_reset_at timestamp with time zone DEFAULT (now() + '01:00:00'::interval) NOT NULL,
    daily_reset_at timestamp with time zone DEFAULT (now() + '1 day'::interval) NOT NULL,
    monthly_reset_at timestamp with time zone DEFAULT (now() + '1 mon'::interval) NOT NULL,
    monthly_cost_usd numeric(10,4) DEFAULT 0,
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE ai_mentor_rate_limits; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.ai_mentor_rate_limits IS 'Rate limiting per user to prevent abuse and control costs';


--
-- Name: ai_mentor_sessions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.ai_mentor_sessions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    topic_id uuid,
    course_id uuid,
    title text,
    message_count integer DEFAULT 0 NOT NULL,
    total_tokens integer DEFAULT 0 NOT NULL,
    total_cost_usd numeric(10,6) DEFAULT 0,
    started_at timestamp with time zone DEFAULT now(),
    last_message_at timestamp with time zone DEFAULT now(),
    ended_at timestamp with time zone
);


--
-- Name: TABLE ai_mentor_sessions; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.ai_mentor_sessions IS 'Conversation sessions grouping related chat messages';


--
-- Name: user_profiles; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.user_profiles (
    id uuid DEFAULT extensions.uuid_generate_v4() NOT NULL,
    auth_id uuid,
    email text NOT NULL,
    full_name text NOT NULL,
    avatar_url text,
    phone text,
    timezone text DEFAULT 'America/New_York'::text,
    locale text DEFAULT 'en-US'::text,
    student_enrollment_date timestamp with time zone,
    student_course_id uuid,
    student_current_module text,
    student_course_progress jsonb DEFAULT '{}'::jsonb,
    student_graduation_date timestamp with time zone,
    student_certificates jsonb DEFAULT '[]'::jsonb,
    employee_hire_date timestamp with time zone,
    employee_department text,
    employee_position text,
    employee_salary numeric(10,2),
    employee_status text,
    employee_manager_id uuid,
    employee_performance_rating numeric(3,2),
    candidate_status text,
    candidate_resume_url text,
    candidate_skills text[],
    candidate_experience_years integer,
    candidate_current_visa text,
    candidate_visa_expiry timestamp with time zone,
    candidate_hourly_rate numeric(10,2),
    candidate_bench_start_date timestamp with time zone,
    candidate_availability text,
    candidate_location text,
    candidate_willing_to_relocate boolean DEFAULT false,
    client_company_name text,
    client_industry text,
    client_tier text,
    client_contract_start_date timestamp with time zone,
    client_contract_end_date timestamp with time zone,
    client_payment_terms integer DEFAULT 30,
    client_preferred_markup_percentage numeric(5,2),
    recruiter_territory text,
    recruiter_specialization text[],
    recruiter_monthly_placement_target integer DEFAULT 2,
    recruiter_pod_id uuid,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid,
    updated_by uuid,
    deleted_at timestamp with time zone,
    is_active boolean DEFAULT true,
    search_vector tsvector,
    org_id uuid NOT NULL,
    leaderboard_visible boolean DEFAULT true,
    first_name text,
    last_name text,
    middle_name text,
    preferred_name text,
    date_of_birth date,
    gender text,
    nationality text,
    email_secondary text,
    phone_home text,
    phone_work text,
    preferred_contact_method text,
    preferred_call_time text,
    do_not_contact boolean DEFAULT false,
    do_not_email boolean DEFAULT false,
    do_not_text boolean DEFAULT false,
    linkedin_url text,
    github_url text,
    portfolio_url text,
    personal_website text,
    emergency_contact_name text,
    emergency_contact_relationship text,
    emergency_contact_phone text,
    emergency_contact_email text,
    lead_source text,
    lead_source_detail text,
    marketing_status text,
    is_on_hotlist boolean DEFAULT false,
    hotlist_added_at timestamp with time zone,
    hotlist_added_by uuid,
    hotlist_notes text,
    current_employment_status text,
    notice_period_days integer,
    earliest_start_date date,
    preferred_employment_type text[],
    preferred_locations text[],
    relocation_assistance_required boolean DEFAULT false,
    relocation_notes text,
    desired_salary_annual numeric(12,2),
    desired_salary_currency text DEFAULT 'USD'::text,
    minimum_hourly_rate numeric(10,2),
    minimum_annual_salary numeric(12,2),
    benefits_required text[],
    compensation_notes text,
    languages jsonb DEFAULT '[]'::jsonb,
    recruiter_rating integer,
    recruiter_rating_notes text,
    profile_completeness_score integer DEFAULT 0,
    last_profile_update timestamp with time zone,
    last_activity_date timestamp with time zone,
    last_contacted_at timestamp with time zone,
    last_contacted_by uuid,
    professional_headline text,
    professional_summary text,
    career_objectives text,
    tags text[],
    categories text[],
    employee_role text,
    stripe_customer_id text,
    title text,
    total_placements integer DEFAULT 0,
    manager_id uuid,
    two_factor_enabled boolean DEFAULT false,
    password_changed_at timestamp with time zone,
    start_date date,
    last_login_at timestamp with time zone,
    role_id uuid,
    status text DEFAULT 'active'::text,
    CONSTRAINT user_profiles_status_check CHECK ((status = ANY (ARRAY['pending'::text, 'active'::text, 'suspended'::text, 'deactivated'::text]))),
    CONSTRAINT valid_candidate_availability CHECK (((candidate_availability IS NULL) OR (candidate_availability = ANY (ARRAY['immediate'::text, '2_weeks'::text, '1_month'::text])))),
    CONSTRAINT valid_candidate_status CHECK (((candidate_status IS NULL) OR (candidate_status = ANY (ARRAY['active'::text, 'placed'::text, 'bench'::text, 'inactive'::text, 'blacklisted'::text])))),
    CONSTRAINT valid_client_tier CHECK (((client_tier IS NULL) OR (client_tier = ANY (ARRAY['preferred'::text, 'strategic'::text, 'exclusive'::text])))),
    CONSTRAINT valid_email CHECK ((email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}$'::text)),
    CONSTRAINT valid_employee_status CHECK (((employee_status IS NULL) OR (employee_status = ANY (ARRAY['active'::text, 'on_leave'::text, 'terminated'::text])))),
    CONSTRAINT valid_phone CHECK (((phone IS NULL) OR (phone ~* '^\+?[1-9]\d{1,14}$'::text)))
);


--
-- Name: TABLE user_profiles; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.user_profiles IS 'Unified user table supporting all roles: students, employees, candidates, clients, recruiters, admins.
Uses nullable role-specific columns to avoid data silos while maintaining a single source of truth.';


--
-- Name: COLUMN user_profiles.auth_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.user_profiles.auth_id IS 'Link to Supabase auth.users table. Nullable to support users created outside auth flow (e.g., imported candidates).';


--
-- Name: COLUMN user_profiles.candidate_status; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.user_profiles.candidate_status IS 'Candidate lifecycle: active (sourced) → bench (available) → placed (working) → inactive (not pursuing).';


--
-- Name: COLUMN user_profiles.client_tier; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.user_profiles.client_tier IS 'Client relationship tier: preferred (standard) → strategic (high volume) → exclusive (partnership).';


--
-- Name: COLUMN user_profiles.deleted_at; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.user_profiles.deleted_at IS 'Soft delete timestamp. NULL = active, NOT NULL = deleted. Hard deletes are prevented by trigger.';


--
-- Name: COLUMN user_profiles.search_vector; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.user_profiles.search_vector IS 'Auto-maintained full-text search vector. Updated via trigger on INSERT/UPDATE.';


--
-- Name: COLUMN user_profiles.org_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.user_profiles.org_id IS 'Organization this user belongs to (multi-tenancy)';


--
-- Name: COLUMN user_profiles.leaderboard_visible; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.user_profiles.leaderboard_visible IS 'Whether user wants to appear on public leaderboards (privacy setting)';


--
-- Name: ai_mentor_student_engagement; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.ai_mentor_student_engagement AS
 SELECT u.id AS user_id,
    u.full_name,
    count(mc.id) AS total_chats,
    date(min(mc.created_at)) AS first_chat_date,
    date(max(mc.created_at)) AS last_chat_date,
    (EXTRACT(epoch FROM (max(mc.created_at) - min(mc.created_at))) / (86400)::numeric) AS active_days,
    avg(mc.student_rating) FILTER (WHERE (mc.student_rating IS NOT NULL)) AS avg_rating_given,
    (((count(*) FILTER (WHERE (mc.student_rating IS NOT NULL)))::numeric / (NULLIF(count(*), 0))::numeric) * (100)::numeric) AS rating_frequency,
    count(DISTINCT mc.topic_id) AS topics_explored,
    count(*) FILTER (WHERE (mc.escalated_to_trainer = true)) AS escalations,
    sum(mc.cost_usd) AS total_cost_incurred
   FROM (public.user_profiles u
     JOIN public.ai_mentor_chats mc ON ((mc.user_id = u.id)))
  GROUP BY u.id, u.full_name
  ORDER BY (count(mc.id)) DESC;


--
-- Name: VIEW ai_mentor_student_engagement; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.ai_mentor_student_engagement IS 'Student engagement patterns and cost attribution';


--
-- Name: roles; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.roles (
    id uuid DEFAULT extensions.uuid_generate_v4() NOT NULL,
    name text NOT NULL,
    display_name text NOT NULL,
    description text,
    parent_role_id uuid,
    hierarchy_level integer DEFAULT 0,
    is_system_role boolean DEFAULT false,
    is_active boolean DEFAULT true,
    color_code text DEFAULT '#6366f1'::text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid,
    deleted_at timestamp with time zone,
    updated_by uuid,
    display_order integer DEFAULT 0,
    CONSTRAINT valid_role_name CHECK ((name ~ '^[a-z_]+$'::text))
);


--
-- Name: TABLE roles; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.roles IS 'System roles with hierarchical support. Each user can have multiple roles (multi-role users).';


--
-- Name: user_roles; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.user_roles (
    user_id uuid NOT NULL,
    role_id uuid NOT NULL,
    assigned_at timestamp with time zone DEFAULT now() NOT NULL,
    assigned_by uuid,
    expires_at timestamp with time zone,
    is_primary boolean DEFAULT false,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone,
    created_by uuid,
    updated_by uuid,
    updated_at timestamp with time zone
);


--
-- Name: TABLE user_roles; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.user_roles IS 'Junction table mapping users to roles. Supports multi-role users and temporary role assignments.';


--
-- Name: ai_mentor_student_stats; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.ai_mentor_student_stats AS
 SELECT u.id AS user_id,
    u.full_name,
    u.email,
    count(c.id) AS total_chats,
    sum(c.tokens_used) AS total_tokens,
    sum(c.cost_usd) AS total_cost,
    avg(c.response_time_ms) AS avg_response_time_ms,
    avg(c.student_rating) FILTER (WHERE (c.student_rating IS NOT NULL)) AS avg_rating,
    count(*) FILTER (WHERE (c.flagged_for_review = true)) AS flagged_count,
    count(*) FILTER (WHERE (c.escalated_to_trainer = true)) AS escalated_count,
    max(c.created_at) AS last_chat_at
   FROM (public.user_profiles u
     LEFT JOIN public.ai_mentor_chats c ON ((c.user_id = u.id)))
  WHERE (EXISTS ( SELECT 1
           FROM (public.user_roles ur
             JOIN public.roles r ON ((r.id = ur.role_id)))
          WHERE ((ur.user_id = u.id) AND (r.name = 'student'::text))))
  GROUP BY u.id, u.full_name, u.email;


--
-- Name: VIEW ai_mentor_student_stats; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.ai_mentor_student_stats IS 'Per-student AI mentor usage analytics';


--
-- Name: course_modules; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.course_modules (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    course_id uuid NOT NULL,
    slug text NOT NULL,
    title text NOT NULL,
    description text,
    module_number integer NOT NULL,
    estimated_duration_hours integer,
    prerequisite_module_ids uuid[],
    is_published boolean DEFAULT false,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE course_modules; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.course_modules IS 'High-level learning units within a course (typically 4-8 modules per course)';


--
-- Name: courses; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.courses (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    slug text NOT NULL,
    title text NOT NULL,
    subtitle text,
    description text NOT NULL,
    total_modules integer DEFAULT 0 NOT NULL,
    total_topics integer DEFAULT 0 NOT NULL,
    estimated_duration_weeks integer NOT NULL,
    price_monthly numeric(10,2),
    price_one_time numeric(10,2),
    is_included_in_all_access boolean DEFAULT true,
    prerequisite_course_ids uuid[],
    skill_level text,
    thumbnail_url text,
    promo_video_url text,
    is_published boolean DEFAULT false,
    is_featured boolean DEFAULT false,
    created_by uuid,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    deleted_at timestamp with time zone,
    CONSTRAINT courses_skill_level_check CHECK ((skill_level = ANY (ARRAY['beginner'::text, 'intermediate'::text, 'advanced'::text])))
);


--
-- Name: TABLE courses; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.courses IS 'Multi-course catalog supporting any technical training (Guidewire, Salesforce, AWS, etc.)';


--
-- Name: COLUMN courses.prerequisite_course_ids; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.courses.prerequisite_course_ids IS 'Array of course UUIDs required before enrollment';


--
-- Name: ai_mentor_topic_quality; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.ai_mentor_topic_quality AS
 SELECT mt.id AS topic_id,
    mt.title AS topic_title,
    c.title AS course_title,
    count(mc.id) AS total_chats,
    count(DISTINCT mc.user_id) AS unique_students,
    avg(mc.student_rating) FILTER (WHERE (mc.student_rating IS NOT NULL)) AS avg_rating,
    (((count(*) FILTER (WHERE (mc.student_rating >= 4)))::numeric / (NULLIF(count(*) FILTER (WHERE (mc.student_rating IS NOT NULL)), 0))::numeric) * (100)::numeric) AS helpful_percentage,
    (((count(*) FILTER (WHERE (mc.student_rating <= 2)))::numeric / (NULLIF(count(*) FILTER (WHERE (mc.student_rating IS NOT NULL)), 0))::numeric) * (100)::numeric) AS unhelpful_percentage,
    avg(mc.response_time_ms) AS avg_response_time_ms,
    avg(mc.tokens_used) AS avg_tokens_used,
    sum(mc.cost_usd) AS total_cost,
    (((count(*) FILTER (WHERE (mc.escalated_to_trainer = true)))::numeric / (NULLIF(count(*), 0))::numeric) * (100)::numeric) AS escalation_rate,
    count(*) FILTER (WHERE (mc.flagged_for_review = true)) AS flagged_count
   FROM (((public.module_topics mt
     JOIN public.course_modules cm ON ((cm.id = mt.module_id)))
     JOIN public.courses c ON ((c.id = cm.course_id)))
     LEFT JOIN public.ai_mentor_chats mc ON ((mc.topic_id = mt.id)))
  GROUP BY mt.id, mt.title, c.title
 HAVING (count(mc.id) > 0)
  ORDER BY (count(mc.id)) DESC;


--
-- Name: VIEW ai_mentor_topic_quality; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.ai_mentor_topic_quality IS 'Quality metrics by topic for identifying problem areas';


--
-- Name: ai_mentor_topic_stats; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.ai_mentor_topic_stats AS
 SELECT mt.id AS topic_id,
    mt.title AS topic_title,
    c.title AS course_title,
    count(mc.id) AS total_chats,
    count(DISTINCT mc.user_id) AS unique_students,
    avg(mc.student_rating) FILTER (WHERE (mc.student_rating IS NOT NULL)) AS avg_rating,
    count(*) FILTER (WHERE (mc.escalated_to_trainer = true)) AS escalation_count
   FROM (((public.module_topics mt
     JOIN public.course_modules m ON ((m.id = mt.module_id)))
     JOIN public.courses c ON ((c.id = m.course_id)))
     LEFT JOIN public.ai_mentor_chats mc ON ((mc.topic_id = mt.id)))
  GROUP BY mt.id, mt.title, c.title
  ORDER BY (count(mc.id)) DESC;


--
-- Name: VIEW ai_mentor_topic_stats; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.ai_mentor_topic_stats IS 'Topic-level analytics showing which topics need most help';


--
-- Name: ai_patterns; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.ai_patterns (
    id text NOT NULL,
    user_id uuid NOT NULL,
    pattern_type text NOT NULL,
    description text NOT NULL,
    occurrence_count integer DEFAULT 1 NOT NULL,
    first_seen timestamp with time zone DEFAULT now() NOT NULL,
    last_seen timestamp with time zone DEFAULT now() NOT NULL,
    metadata jsonb DEFAULT '{}'::jsonb NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE ai_patterns; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.ai_patterns IS 'Extracted patterns from user conversations';


--
-- Name: COLUMN ai_patterns.pattern_type; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.ai_patterns.pattern_type IS 'Type of pattern (question, struggle, preference, skill)';


--
-- Name: ai_prompt_variants; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.ai_prompt_variants (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    variant_name text NOT NULL,
    system_prompt text NOT NULL,
    is_active boolean DEFAULT false,
    traffic_percentage integer DEFAULT 0,
    total_uses integer DEFAULT 0,
    avg_rating numeric(3,2),
    avg_response_time_ms integer,
    avg_tokens_used integer,
    escalation_count integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT now(),
    deactivated_at timestamp with time zone,
    CONSTRAINT ai_prompt_variants_traffic_percentage_check CHECK (((traffic_percentage >= 0) AND (traffic_percentage <= 100)))
);


--
-- Name: TABLE ai_prompt_variants; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.ai_prompt_variants IS 'A/B testing system for AI mentor prompt optimization';


--
-- Name: ai_prompt_variant_performance; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.ai_prompt_variant_performance AS
 SELECT pv.id AS variant_id,
    pv.variant_name,
    pv.is_active,
    pv.traffic_percentage,
    count(mc.id) AS total_uses,
    count(DISTINCT mc.user_id) AS unique_users,
    avg(mc.student_rating) FILTER (WHERE (mc.student_rating IS NOT NULL)) AS avg_rating,
    (((count(*) FILTER (WHERE (mc.student_rating >= 4)))::numeric / (NULLIF(count(*) FILTER (WHERE (mc.student_rating IS NOT NULL)), 0))::numeric) * (100)::numeric) AS helpful_percentage,
    avg(mc.response_time_ms) AS avg_response_time_ms,
    avg(mc.tokens_used) AS avg_tokens_used,
    avg(mc.cost_usd) AS avg_cost_per_chat,
    (((count(*) FILTER (WHERE (mc.escalated_to_trainer = true)))::numeric / (NULLIF(count(*), 0))::numeric) * (100)::numeric) AS escalation_rate,
    count(*) FILTER (WHERE (mc.flagged_for_review = true)) AS flagged_count,
    pv.created_at
   FROM (public.ai_prompt_variants pv
     LEFT JOIN public.ai_mentor_chats mc ON ((mc.prompt_variant_id = pv.id)))
  GROUP BY pv.id, pv.variant_name, pv.is_active, pv.traffic_percentage, pv.created_at
  ORDER BY pv.created_at DESC;


--
-- Name: VIEW ai_prompt_variant_performance; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.ai_prompt_variant_performance IS 'A/B test results comparison';


--
-- Name: ai_prompts; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.ai_prompts (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    name text NOT NULL,
    version integer DEFAULT 1 NOT NULL,
    category text NOT NULL,
    content text NOT NULL,
    description text,
    variables jsonb DEFAULT '[]'::jsonb NOT NULL,
    is_active boolean DEFAULT true NOT NULL,
    created_by uuid,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT ai_prompts_name_check CHECK ((name ~ '^[a-z0-9_]+$'::text)),
    CONSTRAINT ai_prompts_version_positive CHECK ((version > 0))
);


--
-- Name: TABLE ai_prompts; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.ai_prompts IS 'AI prompt templates with version control (Sprint 2: AI-INF-006)';


--
-- Name: COLUMN ai_prompts.variables; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.ai_prompts.variables IS 'Array of required variable names (JSON array of strings)';


--
-- Name: ai_question_patterns; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.ai_question_patterns (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    pattern_hash text NOT NULL,
    canonical_question text NOT NULL,
    category text,
    topic_id uuid,
    occurrence_count integer DEFAULT 1,
    unique_students integer DEFAULT 1,
    avg_response_quality numeric(3,2),
    escalation_rate numeric(5,4),
    first_seen timestamp with time zone DEFAULT now(),
    last_seen timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE ai_question_patterns; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.ai_question_patterns IS 'Tracks common question patterns for curriculum optimization';


--
-- Name: ai_test; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.ai_test (
    id uuid DEFAULT gen_random_uuid() NOT NULL
);


--
-- Name: alert_rules; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.alert_rules (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    name text NOT NULL,
    description text,
    event_type text NOT NULL,
    result_condition text DEFAULT 'ANY'::text,
    threshold_count integer DEFAULT 5 NOT NULL,
    time_window_minutes integer DEFAULT 10 NOT NULL,
    object_type text,
    additional_conditions jsonb DEFAULT '{}'::jsonb,
    severity text NOT NULL,
    notification_channels jsonb DEFAULT '{"dashboard": true}'::jsonb,
    auto_action text,
    is_active boolean DEFAULT true,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    created_by uuid,
    CONSTRAINT alert_rules_auto_action_check CHECK ((auto_action = ANY (ARRAY['none'::text, 'lock_account'::text, 'block_ip'::text, 'require_2fa'::text, 'notify_manager'::text]))),
    CONSTRAINT alert_rules_result_condition_check CHECK ((result_condition = ANY (ARRAY['ANY'::text, 'SUCCESS'::text, 'FAILURE'::text]))),
    CONSTRAINT alert_rules_severity_check CHECK ((severity = ANY (ARRAY['LOW'::text, 'MEDIUM'::text, 'HIGH'::text, 'CRITICAL'::text])))
);


--
-- Name: api_tokens; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.api_tokens (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    name character varying(100) NOT NULL,
    token_hash character varying(255) NOT NULL,
    token_prefix character varying(10) NOT NULL,
    scopes text[] DEFAULT '{}'::text[] NOT NULL,
    expires_at timestamp with time zone,
    last_used_at timestamp with time zone,
    last_used_ip inet,
    usage_count integer DEFAULT 0,
    rate_limit_per_hour integer DEFAULT 1000,
    created_by uuid NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    revoked_at timestamp with time zone,
    revoked_by uuid
);


--
-- Name: approval_instances; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.approval_instances (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    workflow_id uuid NOT NULL,
    entity_type text NOT NULL,
    entity_id uuid NOT NULL,
    current_level integer DEFAULT 1,
    status text DEFAULT 'pending'::text NOT NULL,
    requested_by uuid NOT NULL,
    requested_at timestamp with time zone DEFAULT now() NOT NULL,
    request_notes text,
    request_data jsonb DEFAULT '{}'::jsonb,
    resolved_by uuid,
    resolved_at timestamp with time zone,
    resolution_notes text,
    is_escalated boolean DEFAULT false,
    escalated_at timestamp with time zone,
    escalated_to uuid,
    expires_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE approval_instances; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.approval_instances IS 'Individual approval requests linked to a workflow';


--
-- Name: COLUMN approval_instances.request_data; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.approval_instances.request_data IS 'Snapshot of entity data at request time for audit trail';


--
-- Name: approval_steps; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.approval_steps (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    instance_id uuid NOT NULL,
    level integer NOT NULL,
    approver_role text,
    approver_id uuid,
    status text DEFAULT 'pending'::text NOT NULL,
    decided_by uuid,
    decided_at timestamp with time zone,
    decision text,
    decision_notes text,
    reminder_sent_at timestamp with time zone,
    reminder_count integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE approval_steps; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.approval_steps IS 'Each step in an approval process with decision tracking';


--
-- Name: approval_workflows; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.approval_workflows (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    name text NOT NULL,
    description text,
    entity_type text NOT NULL,
    approval_levels jsonb DEFAULT '[]'::jsonb NOT NULL,
    auto_approve_condition text,
    escalation_days integer DEFAULT 3,
    escalation_role text,
    is_active boolean DEFAULT true,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid
);


--
-- Name: TABLE approval_workflows; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.approval_workflows IS 'Definition of approval workflows for various entity types';


--
-- Name: COLUMN approval_workflows.approval_levels; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.approval_workflows.approval_levels IS 'JSON array defining approval levels: [{level, role, condition}]';


--
-- Name: archived_records; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.archived_records (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    entity_type character varying(50) NOT NULL,
    original_id uuid NOT NULL,
    original_data jsonb NOT NULL,
    archive_reason character varying(100),
    archived_by uuid NOT NULL,
    archived_at timestamp with time zone DEFAULT now() NOT NULL,
    restored_at timestamp with time zone,
    restored_by uuid,
    permanently_deleted_at timestamp with time zone,
    deleted_by uuid
);


--
-- Name: TABLE archived_records; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.archived_records IS 'Stores archived/soft-deleted records with full data for restoration';


--
-- Name: audit_log_retention_policy; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.audit_log_retention_policy (
    id uuid DEFAULT extensions.uuid_generate_v4() NOT NULL,
    table_name text NOT NULL,
    retention_months integer DEFAULT 6 NOT NULL,
    archive_after_months integer,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT valid_archive CHECK (((archive_after_months IS NULL) OR (archive_after_months < retention_months))),
    CONSTRAINT valid_retention CHECK ((retention_months > 0))
);


--
-- Name: audit_logs; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.audit_logs (
    id uuid DEFAULT extensions.uuid_generate_v4(),
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    table_name text NOT NULL,
    action text NOT NULL,
    record_id uuid,
    user_id uuid,
    user_email text,
    user_ip_address inet,
    user_agent text,
    old_values jsonb,
    new_values jsonb,
    changed_fields text[],
    request_id text,
    session_id text,
    request_path text,
    request_method text,
    metadata jsonb DEFAULT '{}'::jsonb,
    severity text DEFAULT 'info'::text,
    org_id uuid,
    entity_type text,
    entity_id uuid,
    actor_type text DEFAULT 'user'::text,
    actor_id uuid,
    correlation_id text,
    parent_audit_id uuid,
    is_compliance_relevant boolean DEFAULT false,
    retention_category text,
    result text DEFAULT 'SUCCESS'::text,
    event_id bigint NOT NULL,
    ip_address inet,
    response_code integer,
    response_time_ms integer,
    object_name text,
    CONSTRAINT audit_logs_result_check CHECK ((result = ANY (ARRAY['SUCCESS'::text, 'FAILURE'::text]))),
    CONSTRAINT valid_action CHECK ((action = ANY (ARRAY['INSERT'::text, 'UPDATE'::text, 'DELETE'::text, 'LOGIN'::text, 'LOGOUT'::text, 'APPROVE'::text, 'REJECT'::text, 'EXPORT'::text, 'IMPORT'::text, 'CUSTOM'::text]))),
    CONSTRAINT valid_severity CHECK ((severity = ANY (ARRAY['debug'::text, 'info'::text, 'warning'::text, 'error'::text, 'critical'::text])))
)
PARTITION BY RANGE (created_at);


--
-- Name: TABLE audit_logs; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.audit_logs IS 'Immutable audit trail with monthly partitioning. Tracks all sensitive operations for compliance and security.';


--
-- Name: COLUMN audit_logs.org_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.audit_logs.org_id IS 'Organization this audit log belongs to';


--
-- Name: audit_logs_event_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.audit_logs_event_id_seq
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: audit_logs_event_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.audit_logs_event_id_seq OWNED BY public.audit_logs.event_id;


--
-- Name: audit_logs_2025_11; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.audit_logs_2025_11 (
    id uuid DEFAULT extensions.uuid_generate_v4(),
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    table_name text NOT NULL,
    action text NOT NULL,
    record_id uuid,
    user_id uuid,
    user_email text,
    user_ip_address inet,
    user_agent text,
    old_values jsonb,
    new_values jsonb,
    changed_fields text[],
    request_id text,
    session_id text,
    request_path text,
    request_method text,
    metadata jsonb DEFAULT '{}'::jsonb,
    severity text DEFAULT 'info'::text,
    org_id uuid,
    entity_type text,
    entity_id uuid,
    actor_type text DEFAULT 'user'::text,
    actor_id uuid,
    correlation_id text,
    parent_audit_id uuid,
    is_compliance_relevant boolean DEFAULT false,
    retention_category text,
    result text DEFAULT 'SUCCESS'::text,
    event_id bigint DEFAULT nextval('public.audit_logs_event_id_seq'::regclass) NOT NULL,
    ip_address inet,
    response_code integer,
    response_time_ms integer,
    object_name text,
    CONSTRAINT audit_logs_result_check CHECK ((result = ANY (ARRAY['SUCCESS'::text, 'FAILURE'::text]))),
    CONSTRAINT valid_action CHECK ((action = ANY (ARRAY['INSERT'::text, 'UPDATE'::text, 'DELETE'::text, 'LOGIN'::text, 'LOGOUT'::text, 'APPROVE'::text, 'REJECT'::text, 'EXPORT'::text, 'IMPORT'::text, 'CUSTOM'::text]))),
    CONSTRAINT valid_severity CHECK ((severity = ANY (ARRAY['debug'::text, 'info'::text, 'warning'::text, 'error'::text, 'critical'::text])))
);


--
-- Name: audit_logs_2025_12; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.audit_logs_2025_12 (
    id uuid DEFAULT extensions.uuid_generate_v4(),
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    table_name text NOT NULL,
    action text NOT NULL,
    record_id uuid,
    user_id uuid,
    user_email text,
    user_ip_address inet,
    user_agent text,
    old_values jsonb,
    new_values jsonb,
    changed_fields text[],
    request_id text,
    session_id text,
    request_path text,
    request_method text,
    metadata jsonb DEFAULT '{}'::jsonb,
    severity text DEFAULT 'info'::text,
    org_id uuid,
    entity_type text,
    entity_id uuid,
    actor_type text DEFAULT 'user'::text,
    actor_id uuid,
    correlation_id text,
    parent_audit_id uuid,
    is_compliance_relevant boolean DEFAULT false,
    retention_category text,
    result text DEFAULT 'SUCCESS'::text,
    event_id bigint DEFAULT nextval('public.audit_logs_event_id_seq'::regclass) NOT NULL,
    ip_address inet,
    response_code integer,
    response_time_ms integer,
    object_name text,
    CONSTRAINT audit_logs_result_check CHECK ((result = ANY (ARRAY['SUCCESS'::text, 'FAILURE'::text]))),
    CONSTRAINT valid_action CHECK ((action = ANY (ARRAY['INSERT'::text, 'UPDATE'::text, 'DELETE'::text, 'LOGIN'::text, 'LOGOUT'::text, 'APPROVE'::text, 'REJECT'::text, 'EXPORT'::text, 'IMPORT'::text, 'CUSTOM'::text]))),
    CONSTRAINT valid_severity CHECK ((severity = ANY (ARRAY['debug'::text, 'info'::text, 'warning'::text, 'error'::text, 'critical'::text])))
);


--
-- Name: audit_logs_2026_01; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.audit_logs_2026_01 (
    id uuid DEFAULT extensions.uuid_generate_v4(),
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    table_name text NOT NULL,
    action text NOT NULL,
    record_id uuid,
    user_id uuid,
    user_email text,
    user_ip_address inet,
    user_agent text,
    old_values jsonb,
    new_values jsonb,
    changed_fields text[],
    request_id text,
    session_id text,
    request_path text,
    request_method text,
    metadata jsonb DEFAULT '{}'::jsonb,
    severity text DEFAULT 'info'::text,
    org_id uuid,
    entity_type text,
    entity_id uuid,
    actor_type text DEFAULT 'user'::text,
    actor_id uuid,
    correlation_id text,
    parent_audit_id uuid,
    is_compliance_relevant boolean DEFAULT false,
    retention_category text,
    result text DEFAULT 'SUCCESS'::text,
    event_id bigint DEFAULT nextval('public.audit_logs_event_id_seq'::regclass) NOT NULL,
    ip_address inet,
    response_code integer,
    response_time_ms integer,
    object_name text,
    CONSTRAINT audit_logs_result_check CHECK ((result = ANY (ARRAY['SUCCESS'::text, 'FAILURE'::text]))),
    CONSTRAINT valid_action CHECK ((action = ANY (ARRAY['INSERT'::text, 'UPDATE'::text, 'DELETE'::text, 'LOGIN'::text, 'LOGOUT'::text, 'APPROVE'::text, 'REJECT'::text, 'EXPORT'::text, 'IMPORT'::text, 'CUSTOM'::text]))),
    CONSTRAINT valid_severity CHECK ((severity = ANY (ARRAY['debug'::text, 'info'::text, 'warning'::text, 'error'::text, 'critical'::text])))
);


--
-- Name: audit_logs_2026_02; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.audit_logs_2026_02 (
    id uuid DEFAULT extensions.uuid_generate_v4(),
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    table_name text NOT NULL,
    action text NOT NULL,
    record_id uuid,
    user_id uuid,
    user_email text,
    user_ip_address inet,
    user_agent text,
    old_values jsonb,
    new_values jsonb,
    changed_fields text[],
    request_id text,
    session_id text,
    request_path text,
    request_method text,
    metadata jsonb DEFAULT '{}'::jsonb,
    severity text DEFAULT 'info'::text,
    org_id uuid,
    entity_type text,
    entity_id uuid,
    actor_type text DEFAULT 'user'::text,
    actor_id uuid,
    correlation_id text,
    parent_audit_id uuid,
    is_compliance_relevant boolean DEFAULT false,
    retention_category text,
    result text DEFAULT 'SUCCESS'::text,
    event_id bigint DEFAULT nextval('public.audit_logs_event_id_seq'::regclass) NOT NULL,
    ip_address inet,
    response_code integer,
    response_time_ms integer,
    object_name text,
    CONSTRAINT audit_logs_result_check CHECK ((result = ANY (ARRAY['SUCCESS'::text, 'FAILURE'::text]))),
    CONSTRAINT valid_action CHECK ((action = ANY (ARRAY['INSERT'::text, 'UPDATE'::text, 'DELETE'::text, 'LOGIN'::text, 'LOGOUT'::text, 'APPROVE'::text, 'REJECT'::text, 'EXPORT'::text, 'IMPORT'::text, 'CUSTOM'::text]))),
    CONSTRAINT valid_severity CHECK ((severity = ANY (ARRAY['debug'::text, 'info'::text, 'warning'::text, 'error'::text, 'critical'::text])))
);


--
-- Name: background_jobs; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.background_jobs (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    job_type text NOT NULL,
    payload jsonb NOT NULL,
    status text DEFAULT 'pending'::text NOT NULL,
    attempts integer DEFAULT 0 NOT NULL,
    max_attempts integer DEFAULT 3 NOT NULL,
    error_message text,
    result jsonb,
    priority integer DEFAULT 5 NOT NULL,
    created_by uuid NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    started_at timestamp with time zone,
    completed_at timestamp with time zone,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT valid_job_status CHECK ((status = ANY (ARRAY['pending'::text, 'processing'::text, 'completed'::text, 'failed'::text]))),
    CONSTRAINT valid_job_type CHECK ((job_type = ANY (ARRAY['generate_document'::text, 'send_email'::text, 'send_bulk_email'::text, 'import_data'::text, 'export_data'::text]))),
    CONSTRAINT valid_priority CHECK (((priority >= 1) AND (priority <= 10)))
);


--
-- Name: TABLE background_jobs; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.background_jobs IS 'PostgreSQL-based background job queue';


--
-- Name: COLUMN background_jobs.priority; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.background_jobs.priority IS '1 = highest priority, 10 = lowest';


--
-- Name: badges; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.badges (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    slug text NOT NULL,
    name text NOT NULL,
    description text NOT NULL,
    icon_url text,
    xp_reward integer DEFAULT 50,
    rarity text NOT NULL,
    display_order integer DEFAULT 0,
    is_hidden boolean DEFAULT false,
    trigger_type text NOT NULL,
    trigger_threshold integer DEFAULT 1,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT badges_rarity_check CHECK ((rarity = ANY (ARRAY['common'::text, 'rare'::text, 'epic'::text, 'legendary'::text]))),
    CONSTRAINT badges_trigger_type_check CHECK ((trigger_type = ANY (ARRAY['first_video'::text, 'first_quiz'::text, 'first_lab'::text, 'quiz_streak'::text, 'perfect_quiz'::text, 'lab_completion'::text, 'course_completion'::text, 'ai_mentor_usage'::text, 'help_others'::text, 'speed_demon'::text, 'night_owl'::text, 'early_bird'::text, 'consistency'::text, 'achievement_hunter'::text]))),
    CONSTRAINT badges_xp_reward_check CHECK ((xp_reward >= 0))
);


--
-- Name: TABLE badges; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.badges IS 'Badge definitions with trigger rules and rewards';


--
-- Name: user_badges; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.user_badges (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    badge_id uuid NOT NULL,
    earned_at timestamp with time zone DEFAULT now(),
    progress_value integer DEFAULT 0,
    is_new boolean DEFAULT true,
    viewed_at timestamp with time zone,
    shared_at timestamp with time zone,
    share_count integer DEFAULT 0
);


--
-- Name: TABLE user_badges; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.user_badges IS 'Tracks which badges users have earned';


--
-- Name: badge_completion_stats; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.badge_completion_stats AS
 SELECT b.id AS badge_id,
    b.name AS badge_name,
    b.rarity,
    b.trigger_type,
    count(ub.id) AS total_earned,
    count(DISTINCT ub.user_id) AS unique_earners,
    (((count(DISTINCT ub.user_id))::numeric / (NULLIF(( SELECT count(DISTINCT user_badges.user_id) AS count
           FROM public.user_badges), 0))::numeric) * (100)::numeric) AS completion_percentage,
    min(ub.earned_at) AS first_earned_at,
    max(ub.earned_at) AS last_earned_at,
    sum(ub.share_count) AS total_shares
   FROM (public.badges b
     LEFT JOIN public.user_badges ub ON ((ub.badge_id = b.id)))
  GROUP BY b.id, b.name, b.rarity, b.trigger_type
  ORDER BY (count(ub.id)) DESC;


--
-- Name: VIEW badge_completion_stats; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.badge_completion_stats IS 'Badge earn rates and rarity statistics';


--
-- Name: badge_leaderboard; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.badge_leaderboard AS
 WITH top_users AS (
         SELECT u.id,
            u.full_name,
            u.avatar_url,
            count(ub_1.id) AS badge_count,
            sum(
                CASE b_1.rarity
                    WHEN 'legendary'::text THEN 4
                    WHEN 'epic'::text THEN 3
                    WHEN 'rare'::text THEN 2
                    WHEN 'common'::text THEN 1
                    ELSE 0
                END) AS rarity_score,
            sum(b_1.xp_reward) AS badge_xp_earned
           FROM ((public.user_profiles u
             LEFT JOIN public.user_badges ub_1 ON ((ub_1.user_id = u.id)))
             LEFT JOIN public.badges b_1 ON ((b_1.id = ub_1.badge_id)))
          GROUP BY u.id, u.full_name, u.avatar_url
          ORDER BY (count(ub_1.id)) DESC, (sum(
                CASE b_1.rarity
                    WHEN 'legendary'::text THEN 4
                    WHEN 'epic'::text THEN 3
                    WHEN 'rare'::text THEN 2
                    WHEN 'common'::text THEN 1
                    ELSE 0
                END)) DESC
         LIMIT 100
        )
 SELECT tu.id AS user_id,
    tu.full_name,
    tu.avatar_url,
    tu.badge_count,
    tu.rarity_score,
    tu.badge_xp_earned,
    COALESCE(jsonb_agg(jsonb_build_object('badge_id', b.id, 'name', b.name, 'rarity', b.rarity, 'earned_at', ub.earned_at) ORDER BY ub.earned_at DESC) FILTER (WHERE (ub.id IS NOT NULL)), '[]'::jsonb) AS recent_badges
   FROM ((top_users tu
     LEFT JOIN public.user_badges ub ON ((ub.user_id = tu.id)))
     LEFT JOIN public.badges b ON ((b.id = ub.badge_id)))
  GROUP BY tu.id, tu.full_name, tu.avatar_url, tu.badge_count, tu.rarity_score, tu.badge_xp_earned
  ORDER BY tu.badge_count DESC, tu.rarity_score DESC;


--
-- Name: VIEW badge_leaderboard; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.badge_leaderboard IS 'Top 100 badge collectors (optimized with CTE to filter first, then aggregate)';


--
-- Name: badge_progress; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.badge_progress (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    badge_id uuid NOT NULL,
    current_value integer DEFAULT 0,
    target_value integer NOT NULL,
    last_updated timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE badge_progress; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.badge_progress IS 'Tracks progress toward earning badges';


--
-- Name: badge_trigger_events; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.badge_trigger_events (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    trigger_type text NOT NULL,
    event_data jsonb DEFAULT '{}'::jsonb,
    processed boolean DEFAULT false,
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE badge_trigger_events; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.badge_trigger_events IS 'Queue of events that may trigger badge awards';


--
-- Name: bench_consultants; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.bench_consultants (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    candidate_id uuid NOT NULL,
    status public.bench_status DEFAULT 'available'::public.bench_status NOT NULL,
    bench_start_date date NOT NULL,
    visa_type public.visa_type,
    visa_expiry_date date,
    work_auth_status text,
    min_acceptable_rate numeric(10,2),
    target_rate numeric(10,2),
    currency text DEFAULT 'USD'::text,
    willing_relocate boolean DEFAULT false,
    preferred_locations text[],
    marketing_status public.marketing_status DEFAULT 'draft'::public.marketing_status,
    bench_sales_rep_id uuid,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid,
    deleted_at timestamp with time zone,
    contact_id uuid
);


--
-- Name: TABLE bench_consultants; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.bench_consultants IS 'Main table for consultants on bench (extends user_profiles)';


--
-- Name: benefit_dependents; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.benefit_dependents (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    employee_benefit_id uuid NOT NULL,
    name text NOT NULL,
    relationship public.relationship NOT NULL,
    date_of_birth date,
    ssn_encrypted text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: benefit_plan_options; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.benefit_plan_options (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    plan_id uuid NOT NULL,
    option_name text NOT NULL,
    coverage_level public.coverage_level NOT NULL,
    employer_contribution numeric(10,2),
    employee_contribution numeric(10,2),
    description text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: benefit_plans; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.benefit_plans (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    name text NOT NULL,
    type public.benefit_type NOT NULL,
    provider text,
    status text DEFAULT 'active'::text NOT NULL,
    effective_date date,
    termination_date date,
    description text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid
);


--
-- Name: break_glass_access; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.break_glass_access (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    user_id uuid,
    accessed_by text NOT NULL,
    reason text NOT NULL,
    incident_id uuid,
    authorized_by text NOT NULL,
    actions_taken text[] DEFAULT '{}'::text[],
    accessed_at timestamp with time zone DEFAULT now() NOT NULL,
    ended_at timestamp with time zone,
    ip_address inet,
    user_agent text,
    metadata jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE break_glass_access; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.break_glass_access IS 'Emergency break-glass access logging';


--
-- Name: bulk_activity_jobs; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.bulk_activity_jobs (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    job_name text NOT NULL,
    job_type text NOT NULL,
    activity_pattern_id uuid,
    target_entity_type text,
    target_entity_ids uuid[],
    target_criteria jsonb,
    operation jsonb NOT NULL,
    status text DEFAULT 'pending'::text,
    total_items integer DEFAULT 0,
    processed_items integer DEFAULT 0,
    failed_items integer DEFAULT 0,
    error_log jsonb,
    result_summary jsonb,
    started_at timestamp with time zone,
    completed_at timestamp with time zone,
    canceled_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid NOT NULL
);


--
-- Name: TABLE bulk_activity_jobs; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.bulk_activity_jobs IS 'Bulk operations on activities';


--
-- Name: bulk_update_history; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.bulk_update_history (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    update_type character varying(50) NOT NULL,
    affected_user_ids uuid[] NOT NULL,
    changes jsonb NOT NULL,
    previous_state jsonb NOT NULL,
    reason text NOT NULL,
    applied_by uuid NOT NULL,
    applied_at timestamp with time zone DEFAULT now() NOT NULL,
    rolled_back_at timestamp with time zone,
    rolled_back_by uuid,
    CONSTRAINT bulk_update_history_valid_type CHECK (((update_type)::text = ANY ((ARRAY['enable_feature'::character varying, 'disable_feature'::character varying, 'change_scope'::character varying, 'add_permission'::character varying, 'remove_permission'::character varying])::text[])))
);


--
-- Name: campaign_documents; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.campaign_documents (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    campaign_id uuid NOT NULL,
    org_id uuid NOT NULL,
    name text NOT NULL,
    description text,
    document_type text DEFAULT 'attachment'::text NOT NULL,
    category text,
    file_url text,
    file_name text,
    file_size integer,
    mime_type text,
    usage_count integer DEFAULT 0,
    last_used_at timestamp with time zone,
    template_variables jsonb,
    uploaded_by uuid,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone
);


--
-- Name: campaign_enrollments; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.campaign_enrollments (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    campaign_id uuid NOT NULL,
    contact_id uuid NOT NULL,
    primary_channel text,
    sequence_step integer DEFAULT 0,
    sequence_status text DEFAULT 'pending'::text,
    stop_reason text,
    first_contacted_at timestamp with time zone,
    last_contacted_at timestamp with time zone,
    opened_at timestamp with time zone,
    clicked_at timestamp with time zone,
    responded_at timestamp with time zone,
    response_type text,
    response_text text,
    converted_to_lead_at timestamp with time zone,
    converted_lead_id uuid,
    meeting_booked_at timestamp with time zone,
    meeting_scheduled_for timestamp with time zone,
    engagement_score integer DEFAULT 0,
    status text DEFAULT 'enrolled'::text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT campaign_enrollments_engagement_score_check CHECK (((engagement_score >= 0) AND (engagement_score <= 100))),
    CONSTRAINT campaign_enrollments_primary_channel_check CHECK ((primary_channel = ANY (ARRAY['email'::text, 'linkedin'::text, 'phone'::text, 'sms'::text]))),
    CONSTRAINT campaign_enrollments_response_type_check CHECK (((response_type IS NULL) OR (response_type = ANY (ARRAY['positive'::text, 'neutral'::text, 'negative'::text, 'auto_reply'::text, 'out_of_office'::text])))),
    CONSTRAINT campaign_enrollments_sequence_status_check CHECK ((sequence_status = ANY (ARRAY['pending'::text, 'in_progress'::text, 'stopped'::text, 'completed'::text, 'paused'::text]))),
    CONSTRAINT campaign_enrollments_status_check CHECK ((status = ANY (ARRAY['enrolled'::text, 'contacted'::text, 'engaged'::text, 'responded'::text, 'converted'::text, 'unsubscribed'::text, 'bounced'::text, 'stopped'::text])))
);


--
-- Name: contacts; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.contacts (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    first_name text,
    last_name text,
    email text,
    phone text,
    mobile text,
    linkedin_url text,
    avatar_url text,
    title text,
    company_name text,
    company_id uuid,
    department text,
    timezone text DEFAULT 'America/New_York'::text,
    preferred_contact_method text DEFAULT 'email'::text,
    best_time_to_contact text,
    do_not_call_before text,
    do_not_call_after text,
    status text DEFAULT 'active'::text NOT NULL,
    source text,
    source_detail text,
    source_campaign_id uuid,
    user_profile_id uuid,
    last_contacted_at timestamp with time zone,
    last_response_at timestamp with time zone,
    total_interactions integer DEFAULT 0,
    engagement_score integer DEFAULT 0,
    twitter_url text,
    github_url text,
    decision_authority text,
    buying_role text,
    influence_level text,
    tags text[],
    notes text,
    internal_notes text,
    owner_id uuid,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid,
    updated_by uuid,
    deleted_at timestamp with time zone,
    search_vector tsvector,
    relationship_notes text,
    is_primary boolean DEFAULT false,
    marketing_emails_opt_in boolean DEFAULT true,
    newsletter_opt_in boolean DEFAULT true,
    product_updates_opt_in boolean DEFAULT true,
    do_not_call boolean DEFAULT false,
    preferred_meeting_platform text,
    meeting_duration integer DEFAULT 30,
    communication_frequency text,
    vendor_id uuid,
    types text[] DEFAULT '{}'::text[],
    subtype text DEFAULT 'general'::text,
    candidate_status text,
    candidate_resume_url text,
    candidate_skills text[],
    candidate_experience_years integer,
    candidate_current_visa text,
    candidate_visa_expiry timestamp with time zone,
    candidate_hourly_rate numeric(10,2),
    candidate_bench_start_date timestamp with time zone,
    candidate_availability text,
    candidate_willing_to_relocate boolean DEFAULT false,
    candidate_preferred_locations text[],
    candidate_current_employment_status text,
    candidate_notice_period_days integer,
    candidate_earliest_start_date date,
    candidate_preferred_employment_type text[],
    candidate_desired_salary_annual numeric(12,2),
    candidate_desired_salary_currency text DEFAULT 'USD'::text,
    candidate_minimum_hourly_rate numeric(10,2),
    candidate_minimum_annual_salary numeric(12,2),
    candidate_benefits_required text[],
    candidate_compensation_notes text,
    candidate_professional_headline text,
    candidate_professional_summary text,
    candidate_career_objectives text,
    candidate_recruiter_rating integer,
    candidate_recruiter_rating_notes text,
    candidate_profile_completeness_score integer DEFAULT 0,
    candidate_is_on_hotlist boolean DEFAULT false,
    candidate_hotlist_added_at timestamp with time zone,
    candidate_hotlist_notes text,
    employee_id uuid,
    employee_department text,
    employee_hire_date date,
    employee_position text,
    employee_status text,
    lead_status text,
    lead_score integer,
    lead_source text,
    lead_estimated_value numeric(12,2),
    lead_converted_to_deal_id uuid,
    lead_converted_to_account_id uuid,
    lead_converted_at timestamp with time zone,
    lead_lost_reason text,
    lead_bant_budget integer DEFAULT 0,
    lead_bant_authority integer DEFAULT 0,
    lead_bant_need integer DEFAULT 0,
    lead_bant_timeline integer DEFAULT 0,
    lead_bant_budget_notes text,
    lead_bant_authority_notes text,
    lead_bant_need_notes text,
    lead_bant_timeline_notes text,
    lead_bant_total_score integer GENERATED ALWAYS AS ((((COALESCE(lead_bant_budget, 0) + COALESCE(lead_bant_authority, 0)) + COALESCE(lead_bant_need, 0)) + COALESCE(lead_bant_timeline, 0))) STORED,
    lead_budget_status text,
    lead_estimated_monthly_spend numeric(12,2),
    lead_authority_level text,
    lead_business_need text,
    lead_urgency text,
    lead_target_start_date date,
    lead_positions_count integer DEFAULT 1,
    lead_skills_needed text[],
    lead_contract_types text[],
    lead_qualification_result text,
    lead_qualification_notes text,
    lead_qualified_at timestamp with time zone,
    lead_qualified_by uuid,
    lead_interest_level text,
    lead_hiring_needs text,
    lead_pain_points text,
    lead_next_action text,
    lead_next_action_date date,
    prospect_primary_campaign_id uuid,
    prospect_current_sequence_step integer,
    prospect_sequence_status text,
    prospect_converted_to_lead_at timestamp with time zone,
    prospect_first_contacted_at timestamp with time zone,
    prospect_responded_at timestamp with time zone,
    prospect_response_type text,
    auth_id uuid,
    account_id uuid,
    date_of_birth date,
    gender text,
    nationality text,
    languages jsonb DEFAULT '[]'::jsonb,
    middle_name text,
    preferred_name text,
    phone_home text,
    phone_work text,
    email_secondary text,
    emergency_contact_name text,
    emergency_contact_relationship text,
    emergency_contact_phone text,
    emergency_contact_email text,
    portfolio_url text,
    personal_website text,
    do_not_email boolean DEFAULT false,
    do_not_text boolean DEFAULT false,
    last_activity_date timestamp with time zone,
    last_contacted_by uuid,
    category text NOT NULL,
    contact_status text DEFAULT 'active'::text,
    primary_address_id uuid,
    suffix text,
    pronouns text,
    photo_url text,
    secondary_email text,
    work_email text,
    work_phone text,
    home_phone text,
    current_company_id uuid,
    current_title text,
    current_department text,
    language text DEFAULT 'en'::text,
    bench_type text,
    bench_status text,
    bench_vendor_id uuid,
    bench_vendor_contact_id uuid,
    bench_start_date date,
    bench_target_end_date date,
    bench_max_bench_days integer,
    bench_bill_rate numeric(10,2),
    bench_pay_rate numeric(10,2),
    bench_markup_percentage numeric(5,2),
    bench_cost_per_day numeric(10,2),
    bench_total_placements integer DEFAULT 0,
    bench_last_placement_end date,
    bench_utilization_rate numeric(5,2),
    placed_status text,
    placed_client_id uuid,
    placed_job_id uuid,
    placed_start_date date,
    placed_end_date date,
    placed_extension_count integer DEFAULT 0,
    client_contact_company_id uuid,
    client_contact_role text,
    client_contact_decision_authority boolean DEFAULT false,
    client_contact_budget_authority boolean DEFAULT false,
    client_contact_contract_signer boolean DEFAULT false,
    client_contact_relationship_strength integer,
    client_contact_relationship_owner_id uuid,
    client_contact_first_meeting_date date,
    client_contact_last_meeting_date date,
    client_contact_meeting_cadence text,
    client_contact_preferred_vendors text[],
    client_contact_hiring_style text,
    client_contact_interview_style text,
    vendor_contact_company_id uuid,
    vendor_contact_role text,
    vendor_contact_specialty_areas text[],
    vendor_contact_response_rating integer,
    vendor_contact_quality_rating integer,
    referral_source_type text,
    referral_total_referrals integer DEFAULT 0,
    referral_successful_placements integer DEFAULT 0,
    referral_success_rate numeric(5,2),
    referral_fee_percentage numeric(5,2),
    referral_last_referral_date date,
    alumni_former_employee_id uuid,
    alumni_departure_date date,
    alumni_departure_reason text,
    alumni_rehire_eligible boolean DEFAULT true,
    alumni_current_employer text,
    alumni_last_contact_date date,
    candidate_hotlist_added_by uuid,
    candidate_hotlist_reason text,
    candidate_priority integer DEFAULT 0,
    candidate_do_not_submit_to uuid[],
    candidate_remote_preference text,
    candidate_years_experience numeric(4,1),
    candidate_cover_letter_url text,
    candidate_resume_updated_at timestamp with time zone,
    lead_converted_to_type text,
    lead_converted_to_id uuid,
    company_name_legal text,
    company_dba_name text,
    company_trade_names text[],
    company_type text,
    company_structure text,
    industry_id uuid,
    industry_secondary_id uuid,
    naics_code text,
    sic_code text,
    employee_count integer,
    employee_count_range text,
    annual_revenue numeric(15,2),
    annual_revenue_range text,
    founded_year integer,
    website_url text,
    company_linkedin_url text,
    company_twitter_url text,
    logo_url text,
    company_description text,
    parent_company_id uuid,
    ultimate_parent_id uuid,
    subsidiary_count integer DEFAULT 0,
    ein_tax_id_encrypted text,
    duns_number text,
    registration_state text,
    registration_country text DEFAULT 'US'::text,
    company_lead_estimated_annual_value numeric(12,2),
    company_lead_estimated_positions_per_year integer,
    company_lead_primary_hiring_needs text[],
    client_status text,
    client_tier text,
    client_segment text,
    client_prospect_date date,
    client_converted_date date,
    client_first_placement_date date,
    client_last_active_date date,
    client_dormant_since date,
    client_churned_date date,
    client_churn_reason text,
    client_contract_type text,
    client_contract_start_date date,
    client_contract_end_date date,
    client_contract_auto_renew boolean DEFAULT false,
    client_contract_url text,
    client_payment_terms integer DEFAULT 30,
    client_credit_limit numeric(12,2),
    client_credit_status text,
    client_default_markup numeric(5,2),
    client_default_bill_rate numeric(10,2),
    client_uses_vms boolean DEFAULT false,
    client_vms_system text,
    client_vms_supplier_id text,
    client_msp_id uuid,
    client_team_lead_id uuid,
    client_recruiter_ids uuid[],
    client_open_positions_count integer DEFAULT 0,
    client_active_placements_count integer DEFAULT 0,
    client_total_placements_count integer DEFAULT 0,
    client_lifetime_revenue numeric(15,2) DEFAULT 0,
    vendor_status text,
    vendor_tier text,
    vendor_type text,
    vendor_specialty_areas text[],
    vendor_geographic_coverage text[],
    vendor_resource_types text[],
    vendor_payment_terms integer DEFAULT 30,
    vendor_default_markup numeric(5,2),
    vendor_referral_fee_percentage numeric(5,2),
    vendor_approved_date date,
    vendor_approved_by uuid,
    vendor_last_review_date date,
    vendor_next_review_date date,
    vendor_insurance_verified boolean DEFAULT false,
    vendor_insurance_expiry_date date,
    vendor_w9_on_file boolean DEFAULT false,
    vendor_w9_received_date date,
    vendor_compliance_status text,
    vendor_background_check_compliant boolean DEFAULT false,
    vendor_drug_test_compliant boolean DEFAULT false,
    vendor_quality_rating numeric(3,2),
    vendor_response_rating numeric(3,2),
    vendor_fill_rate numeric(5,2),
    vendor_submissions_count integer DEFAULT 0,
    vendor_placements_count integer DEFAULT 0,
    vendor_active_resources_count integer DEFAULT 0,
    msp_program_name text,
    msp_managed_clients uuid[],
    msp_our_tier_status text,
    msp_contract_start_date date,
    msp_contract_end_date date,
    msp_fee_percentage numeric(5,2),
    vms_platform_name text,
    vms_integration_status text,
    agency_relationship text,
    agency_partnership_type text,
    agency_partnership_agreement text,
    agency_do_not_recruit_from boolean DEFAULT false,
    agency_specialty_areas text[],
    agency_geographic_focus text[],
    linked_company_id uuid,
    vendor_company_id uuid,
    source_company_id uuid,
    employer_company_id uuid,
    CONSTRAINT contacts_agency_relationship_check CHECK (((agency_relationship IS NULL) OR (agency_relationship = ANY (ARRAY['partner'::text, 'competitor'::text, 'both'::text])))),
    CONSTRAINT contacts_bench_type_check CHECK (((bench_type IS NULL) OR (bench_type = ANY (ARRAY['w2_internal'::text, 'w2_vendor'::text, '1099'::text, 'c2c'::text])))),
    CONSTRAINT contacts_candidate_availability_check CHECK (((candidate_availability IS NULL) OR (candidate_availability = ANY (ARRAY['immediate'::text, '2_weeks'::text, '1_month'::text, '2_months'::text, '3_months'::text, 'not_available'::text])))),
    CONSTRAINT contacts_candidate_remote_preference_check CHECK (((candidate_remote_preference IS NULL) OR (candidate_remote_preference = ANY (ARRAY['remote'::text, 'hybrid'::text, 'onsite'::text, 'flexible'::text])))),
    CONSTRAINT contacts_candidate_status_check CHECK (((candidate_status IS NULL) OR (candidate_status = ANY (ARRAY['active'::text, 'passive'::text, 'placed'::text, 'bench'::text, 'inactive'::text, 'blacklisted'::text])))),
    CONSTRAINT contacts_category_check CHECK ((category = ANY (ARRAY['person'::text, 'company'::text]))),
    CONSTRAINT contacts_category_subtype_consistency CHECK ((((category = 'person'::text) AND (subtype ~~ 'person_%'::text)) OR ((category = 'company'::text) AND (subtype ~~ 'company_%'::text)))),
    CONSTRAINT contacts_client_relationship_strength_check CHECK (((client_contact_relationship_strength IS NULL) OR ((client_contact_relationship_strength >= 1) AND (client_contact_relationship_strength <= 10)))),
    CONSTRAINT contacts_client_status_check CHECK (((client_status IS NULL) OR (client_status = ANY (ARRAY['active'::text, 'dormant'::text, 'former'::text, 'blacklisted'::text])))),
    CONSTRAINT contacts_client_tier_check CHECK (((client_tier IS NULL) OR (client_tier = ANY (ARRAY['enterprise'::text, 'strategic'::text, 'growth'::text, 'standard'::text, 'startup'::text])))),
    CONSTRAINT contacts_company_status_check CHECK (((category <> 'company'::text) OR (contact_status = ANY (ARRAY['active'::text, 'inactive'::text, 'pending'::text, 'dormant'::text, 'former'::text, 'blacklisted'::text, 'suspended'::text])))),
    CONSTRAINT contacts_company_structure_check CHECK (((company_structure IS NULL) OR (company_structure = ANY (ARRAY['public'::text, 'private'::text, 'subsidiary'::text, 'franchise'::text])))),
    CONSTRAINT contacts_company_type_check CHECK (((company_type IS NULL) OR (company_type = ANY (ARRAY['corporation'::text, 'llc'::text, 'partnership'::text, 'sole_prop'::text, 'nonprofit'::text])))),
    CONSTRAINT contacts_employee_status_check CHECK (((employee_status IS NULL) OR (employee_status = ANY (ARRAY['active'::text, 'on_leave'::text, 'terminated'::text])))),
    CONSTRAINT contacts_lead_authority_level_check CHECK (((lead_authority_level IS NULL) OR (lead_authority_level = ANY (ARRAY['decision_maker'::text, 'influencer'::text, 'gatekeeper'::text, 'no_authority'::text])))),
    CONSTRAINT contacts_lead_bant_authority_check CHECK (((lead_bant_authority IS NULL) OR ((lead_bant_authority >= 0) AND (lead_bant_authority <= 25)))),
    CONSTRAINT contacts_lead_bant_budget_check CHECK (((lead_bant_budget IS NULL) OR ((lead_bant_budget >= 0) AND (lead_bant_budget <= 25)))),
    CONSTRAINT contacts_lead_bant_need_check CHECK (((lead_bant_need IS NULL) OR ((lead_bant_need >= 0) AND (lead_bant_need <= 25)))),
    CONSTRAINT contacts_lead_bant_timeline_check CHECK (((lead_bant_timeline IS NULL) OR ((lead_bant_timeline >= 0) AND (lead_bant_timeline <= 25)))),
    CONSTRAINT contacts_lead_qualification_result_check CHECK (((lead_qualification_result IS NULL) OR (lead_qualification_result = ANY (ARRAY['qualified_convert'::text, 'qualified_nurture'::text, 'not_qualified'::text])))),
    CONSTRAINT contacts_lead_score_check CHECK (((lead_score IS NULL) OR ((lead_score >= 0) AND (lead_score <= 100)))),
    CONSTRAINT contacts_lead_status_check CHECK (((lead_status IS NULL) OR (lead_status = ANY (ARRAY['new'::text, 'contacted'::text, 'warm'::text, 'hot'::text, 'cold'::text, 'qualified'::text, 'unqualified'::text, 'converted'::text, 'lost'::text, 'nurture'::text])))),
    CONSTRAINT contacts_placed_status_check CHECK (((placed_status IS NULL) OR (placed_status = ANY (ARRAY['active'::text, 'ending_soon'::text, 'extended'::text, 'completed'::text])))),
    CONSTRAINT contacts_prospect_response_type_check CHECK (((prospect_response_type IS NULL) OR (prospect_response_type = ANY (ARRAY['positive'::text, 'neutral'::text, 'negative'::text, 'auto_reply'::text, 'out_of_office'::text])))),
    CONSTRAINT contacts_prospect_sequence_status_check CHECK (((prospect_sequence_status IS NULL) OR (prospect_sequence_status = ANY (ARRAY['pending'::text, 'in_progress'::text, 'paused'::text, 'completed'::text, 'stopped'::text])))),
    CONSTRAINT contacts_subtype_check CHECK ((subtype = ANY (ARRAY['person_prospect'::text, 'person_lead'::text, 'person_candidate'::text, 'person_bench_internal'::text, 'person_bench_vendor'::text, 'person_placed'::text, 'person_client_contact'::text, 'person_hiring_manager'::text, 'person_hr_contact'::text, 'person_vendor_contact'::text, 'person_employee'::text, 'person_referral_source'::text, 'person_alumni'::text, 'company_prospect'::text, 'company_lead'::text, 'company_client'::text, 'company_vendor'::text, 'company_msp'::text, 'company_vms'::text, 'company_end_client'::text, 'company_agency'::text, 'company_institution'::text]))),
    CONSTRAINT contacts_vendor_quality_rating_check CHECK (((vendor_contact_quality_rating IS NULL) OR ((vendor_contact_quality_rating >= 1) AND (vendor_contact_quality_rating <= 5)))),
    CONSTRAINT contacts_vendor_response_rating_check CHECK (((vendor_contact_response_rating IS NULL) OR ((vendor_contact_response_rating >= 1) AND (vendor_contact_response_rating <= 5)))),
    CONSTRAINT contacts_vendor_status_check CHECK (((vendor_status IS NULL) OR (vendor_status = ANY (ARRAY['pending'::text, 'approved'::text, 'preferred'::text, 'suspended'::text, 'blacklisted'::text])))),
    CONSTRAINT contacts_vendor_tier_check CHECK (((vendor_tier IS NULL) OR (vendor_tier = ANY (ARRAY['preferred'::text, 'approved'::text, 'probationary'::text, 'new'::text])))),
    CONSTRAINT contacts_vms_integration_status_check CHECK (((vms_integration_status IS NULL) OR (vms_integration_status = ANY (ARRAY['not_integrated'::text, 'pending'::text, 'active'::text, 'suspended'::text]))))
);


--
-- Name: TABLE contacts; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.contacts IS 'Unified contacts table for all contact types (client POCs, candidates, vendors, partners) - replaces crm_contacts';


--
-- Name: COLUMN contacts.user_profile_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.contacts.user_profile_id IS 'Bridge column for migration from user_profiles table. Will be deprecated after full migration.';


--
-- Name: COLUMN contacts.subtype; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.contacts.subtype IS 'Contact subtype following enterprise pattern. 13 person subtypes (person_*) and 9 company subtypes (company_*).';


--
-- Name: COLUMN contacts.candidate_status; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.contacts.candidate_status IS 'Candidate lifecycle: active (sourced) → passive (not actively looking) → bench (available) → placed (working) → inactive (not pursuing) → blacklisted';


--
-- Name: COLUMN contacts.candidate_skills; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.contacts.candidate_skills IS 'Array of technical/professional skills for candidates';


--
-- Name: COLUMN contacts.employee_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.contacts.employee_id IS 'Link to employees table for employee contacts (HR data)';


--
-- Name: COLUMN contacts.lead_bant_total_score; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.contacts.lead_bant_total_score IS 'Computed BANT score (0-100): Budget + Authority + Need + Timeline';


--
-- Name: COLUMN contacts.auth_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.contacts.auth_id IS 'Link to Supabase auth.users for contacts who can log in (employees, clients)';


--
-- Name: COLUMN contacts.account_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.contacts.account_id IS 'Link to accounts table for client_poc and lead contacts';


--
-- Name: COLUMN contacts.category; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.contacts.category IS 'Contact category: person or company. Determines which subtype prefixes are valid.';


--
-- Name: COLUMN contacts.contact_status; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.contacts.contact_status IS 'Current status within the subtype context. Values depend on subtype.';


--
-- Name: COLUMN contacts.primary_address_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.contacts.primary_address_id IS 'FK to primary address in centralized addresses table.';


--
-- Name: COLUMN contacts.current_company_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.contacts.current_company_id IS 'FK to company contact (category=company) where this person currently works';


--
-- Name: COLUMN contacts.bench_type; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.contacts.bench_type IS 'Employment type for bench resources: w2_internal (direct employee), w2_vendor (via vendor), 1099 (contractor), c2c (corp-to-corp)';


--
-- Name: COLUMN contacts.bench_status; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.contacts.bench_status IS 'Current bench status for availability tracking';


--
-- Name: COLUMN contacts.placed_status; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.contacts.placed_status IS 'Current placement status: active, ending_soon (within 30 days), extended, completed';


--
-- Name: COLUMN contacts.client_contact_relationship_strength; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.contacts.client_contact_relationship_strength IS 'Relationship strength score 1-10 (1=cold, 10=champion)';


--
-- Name: COLUMN contacts.candidate_remote_preference; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.contacts.candidate_remote_preference IS 'Remote work preference: remote, hybrid, onsite, or flexible';


--
-- Name: COLUMN contacts.linked_company_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.contacts.linked_company_id IS 'FK to companies table for primary company association (replaces account_id)';


--
-- Name: COLUMN contacts.vendor_company_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.contacts.vendor_company_id IS 'FK to companies table for vendor association (replaces vendor_id)';


--
-- Name: COLUMN contacts.source_company_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.contacts.source_company_id IS 'FK to companies table for talent source (replaces bench_vendor_id)';


--
-- Name: COLUMN contacts.employer_company_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.contacts.employer_company_id IS 'FK to companies table for current employer';


--
-- Name: campaign_prospects_view; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.campaign_prospects_view AS
 SELECT ce.id,
    ce.org_id,
    ce.campaign_id,
    NULL::uuid AS lead_id,
    c.first_name,
    c.last_name,
    c.email,
    c.phone,
    c.linkedin_url,
    c.company_name,
    NULL::text AS company_industry,
    NULL::text AS company_size,
    c.title,
    NULL::text AS location,
    c.timezone,
    ce.primary_channel,
    ce.sequence_step,
    ce.sequence_status,
    ce.stop_reason,
    ce.first_contacted_at,
    ce.last_contacted_at,
    ce.opened_at,
    ce.clicked_at,
    ce.responded_at,
    ce.response_type,
    ce.response_text,
    ce.converted_to_lead_at,
    ce.converted_lead_id,
    ce.meeting_booked_at,
    ce.meeting_scheduled_for,
    ce.engagement_score,
    ce.status,
    ce.created_at,
    ce.updated_at,
    ce.contact_id
   FROM (public.campaign_enrollments ce
     JOIN public.contacts c ON (((c.id = ce.contact_id) AND (c.deleted_at IS NULL))));


--
-- Name: VIEW campaign_prospects_view; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.campaign_prospects_view IS 'View of campaign enrollments with prospect details - location now from addresses table';


--
-- Name: campaign_sequence_logs; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.campaign_sequence_logs (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    campaign_id uuid NOT NULL,
    channel text NOT NULL,
    step_number integer NOT NULL,
    action_type text NOT NULL,
    action_at timestamp with time zone DEFAULT now() NOT NULL,
    subject text,
    content_preview text,
    link_clicked text,
    call_duration_seconds integer,
    call_outcome text,
    response_text text,
    sentiment text,
    metadata jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    enrollment_id uuid
);


--
-- Name: campaign_sequences; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.campaign_sequences (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    campaign_id uuid NOT NULL,
    sequence_template_id uuid NOT NULL,
    org_id uuid NOT NULL,
    is_active boolean DEFAULT true,
    enrolled_count integer DEFAULT 0,
    completed_count integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE campaign_sequences; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.campaign_sequences IS 'Junction table tracking which sequences are used in which campaigns';


--
-- Name: campaigns; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.campaigns (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    name text NOT NULL,
    description text,
    campaign_type text DEFAULT 'talent_sourcing'::text NOT NULL,
    channel text DEFAULT 'email'::text NOT NULL,
    status text DEFAULT 'draft'::text NOT NULL,
    target_audience text,
    target_locations text[],
    target_skills text[],
    target_company_sizes text[],
    is_ab_test boolean DEFAULT false,
    variant_a_template_id uuid,
    variant_b_template_id uuid,
    ab_split_percentage integer DEFAULT 50,
    target_contacts_count integer,
    target_response_rate numeric(5,2),
    target_conversion_count integer,
    contacts_reached integer DEFAULT 0,
    emails_sent integer DEFAULT 0,
    linkedin_messages_sent integer DEFAULT 0,
    responses_received integer DEFAULT 0,
    conversions integer DEFAULT 0,
    response_rate numeric(5,2) GENERATED ALWAYS AS (
CASE
    WHEN (emails_sent > 0) THEN round((((responses_received)::numeric / (emails_sent)::numeric) * (100)::numeric), 2)
    ELSE (0)::numeric
END) STORED,
    start_date date,
    end_date date,
    owner_id uuid NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid,
    deleted_at timestamp with time zone,
    goal text,
    target_criteria jsonb DEFAULT '{}'::jsonb,
    channels text[] DEFAULT '{}'::text[],
    sequences jsonb DEFAULT '{}'::jsonb,
    budget_total numeric(12,2) DEFAULT 0,
    budget_currency text DEFAULT 'USD'::text,
    target_leads integer DEFAULT 0,
    target_meetings integer DEFAULT 0,
    target_revenue numeric(12,2) DEFAULT 0,
    compliance_settings jsonb DEFAULT '{"casl": true, "gdpr": true, "canSpam": true, "includeUnsubscribe": true}'::jsonb,
    approved_by uuid,
    approved_at timestamp with time zone,
    rejection_reason text,
    approval_status text DEFAULT 'not_required'::text,
    ab_test_config jsonb,
    budget_spent numeric(12,2) DEFAULT 0,
    leads_generated integer DEFAULT 0,
    meetings_booked integer DEFAULT 0,
    revenue_generated numeric(12,2) DEFAULT 0,
    audience_size integer DEFAULT 0,
    prospects_contacted integer DEFAULT 0,
    prospects_opened integer DEFAULT 0,
    prospects_clicked integer DEFAULT 0,
    prospects_responded integer DEFAULT 0,
    search_vector tsvector,
    sequence_template_ids uuid[] DEFAULT '{}'::uuid[],
    updated_by uuid
);


--
-- Name: TABLE campaigns; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.campaigns IS 'Outreach campaigns for talent sourcing and business development';


--
-- Name: COLUMN campaigns.sequence_template_ids; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.campaigns.sequence_template_ids IS 'Array of sequence template IDs used by this campaign';


--
-- Name: candidate_availability; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.candidate_availability (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    candidate_id uuid NOT NULL,
    available_from date,
    notice_period_days integer,
    preferred_rate_min numeric(10,2),
    preferred_rate_max numeric(10,2),
    currency text DEFAULT 'USD'::text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone,
    contact_id uuid
);


--
-- Name: candidate_background_checks; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.candidate_background_checks (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    candidate_id uuid NOT NULL,
    submission_id uuid,
    placement_id uuid,
    provider text,
    provider_reference_id text,
    provider_order_id text,
    package_name text,
    package_type text,
    status text DEFAULT 'not_started'::text NOT NULL,
    overall_result text,
    requested_at timestamp with time zone,
    requested_by uuid,
    initiated_at timestamp with time zone,
    estimated_completion date,
    completed_at timestamp with time zone,
    expires_at timestamp with time zone,
    valid_for_months integer DEFAULT 12,
    checks jsonb DEFAULT '{}'::jsonb,
    adjudication_status text,
    adjudication_notes text,
    adjudicated_by uuid,
    adjudicated_at timestamp with time zone,
    adverse_action_required boolean DEFAULT false,
    pre_adverse_sent_at timestamp with time zone,
    pre_adverse_response_deadline date,
    final_adverse_sent_at timestamp with time zone,
    adverse_action_notes text,
    consent_form_file_id uuid,
    consent_signed_at timestamp with time zone,
    consent_ip_address text,
    consent_user_agent text,
    authorization_form_file_id uuid,
    report_file_id uuid,
    report_received_at timestamp with time zone,
    cost numeric(10,2),
    cost_currency text DEFAULT 'USD'::text,
    billed_to text,
    notes text,
    internal_notes text,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    created_by uuid,
    updated_by uuid,
    contact_id uuid
);


--
-- Name: candidate_certifications; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.candidate_certifications (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    candidate_id uuid NOT NULL,
    certification_type text NOT NULL,
    name text NOT NULL,
    acronym text,
    issuing_organization text,
    credential_id text,
    credential_url text,
    issue_date date,
    expiry_date date,
    is_lifetime boolean DEFAULT false,
    requires_renewal boolean DEFAULT false,
    renewal_period_months integer,
    cpe_credits_required integer,
    license_type text,
    license_number text,
    license_state text,
    license_country text,
    license_jurisdiction text,
    clearance_level text,
    clearance_status text,
    clearance_granted_date date,
    investigation_type text,
    polygraph_type text,
    polygraph_date date,
    sap_access boolean DEFAULT false,
    sci_access boolean DEFAULT false,
    is_verified boolean DEFAULT false,
    verified_at timestamp with time zone,
    verified_by uuid,
    verification_method text,
    verification_notes text,
    document_file_id uuid,
    display_order integer DEFAULT 0,
    is_featured boolean DEFAULT false,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    created_by uuid,
    updated_by uuid,
    contact_id uuid
);


--
-- Name: candidate_compliance_documents; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.candidate_compliance_documents (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    candidate_id uuid NOT NULL,
    placement_id uuid,
    submission_id uuid,
    document_type text NOT NULL,
    document_name text NOT NULL,
    document_description text,
    document_category text,
    status text DEFAULT 'required'::text NOT NULL,
    required_by date,
    requested_at timestamp with time zone,
    submitted_at timestamp with time zone,
    reviewed_at timestamp with time zone,
    reviewed_by uuid,
    approved_at timestamp with time zone,
    approved_by uuid,
    rejected_at timestamp with time zone,
    rejected_by uuid,
    rejection_reason text,
    effective_date date,
    expires_at date,
    file_id uuid,
    file_url text,
    file_name text,
    file_size integer,
    file_mime_type text,
    requires_signature boolean DEFAULT true,
    is_signed boolean DEFAULT false,
    signed_at timestamp with time zone,
    signer_name text,
    signer_email text,
    signature_ip text,
    signature_user_agent text,
    signature_method text,
    signature_envelope_id text,
    version integer DEFAULT 1,
    previous_version_id uuid,
    is_current_version boolean DEFAULT true,
    client_id uuid,
    client_name text,
    notes text,
    internal_notes text,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    created_by uuid,
    updated_by uuid,
    contact_id uuid
);


--
-- Name: candidate_documents; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.candidate_documents (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    candidate_id uuid NOT NULL,
    type text NOT NULL,
    file_url text NOT NULL,
    file_name text NOT NULL,
    version integer DEFAULT 1,
    is_primary boolean DEFAULT false,
    uploaded_at timestamp with time zone DEFAULT now() NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone,
    contact_id uuid
);


--
-- Name: candidate_education; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.candidate_education (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    candidate_id uuid NOT NULL,
    degree_type text,
    degree_name text,
    field_of_study text,
    minor text,
    concentration text,
    institution_name text NOT NULL,
    institution_type text,
    institution_city text,
    institution_state text,
    institution_country text,
    country_code text,
    start_date date,
    end_date date,
    expected_graduation date,
    is_current boolean DEFAULT false,
    gpa numeric(4,2),
    gpa_scale numeric(3,1) DEFAULT 4.0,
    class_rank text,
    honors text,
    thesis_title text,
    dissertation_title text,
    is_verified boolean DEFAULT false,
    verified_at timestamp with time zone,
    verified_by uuid,
    verification_method text,
    verification_notes text,
    transcript_file_id uuid,
    diploma_file_id uuid,
    display_order integer DEFAULT 0,
    is_highest_degree boolean DEFAULT false,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    created_by uuid,
    updated_by uuid,
    contact_id uuid
);


--
-- Name: candidate_embeddings; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.candidate_embeddings (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    candidate_id uuid NOT NULL,
    embedding public.vector(1536),
    resume_text text NOT NULL,
    skills text[],
    experience_level text,
    availability text,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    contact_id uuid,
    CONSTRAINT candidate_embeddings_availability_check CHECK ((availability = ANY (ARRAY['immediate'::text, '2-weeks'::text, '1-month'::text]))),
    CONSTRAINT candidate_embeddings_experience_level_check CHECK ((experience_level = ANY (ARRAY['entry'::text, 'mid'::text, 'senior'::text])))
);


--
-- Name: TABLE candidate_embeddings; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.candidate_embeddings IS 'Semantic embeddings for candidate resumes (resume matching AI-MATCH-001)';


--
-- Name: COLUMN candidate_embeddings.embedding; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.candidate_embeddings.embedding IS 'pgvector embedding (1536 dims from text-embedding-3-small)';


--
-- Name: candidate_preferences; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.candidate_preferences (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    candidate_id uuid NOT NULL,
    preferred_job_types text[],
    preferred_work_modes text[],
    preferred_industries text[],
    min_rate numeric(10,2),
    max_commute_miles integer,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone,
    contact_id uuid
);


--
-- Name: candidate_prepared_profiles; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.candidate_prepared_profiles (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    candidate_id uuid NOT NULL,
    job_id uuid,
    template_type text DEFAULT 'standard'::text NOT NULL,
    summary text,
    key_highlights text[],
    skills_matrix jsonb,
    experience_summary jsonb,
    why_this_candidate text,
    education jsonb,
    status text DEFAULT 'draft'::text NOT NULL,
    finalized_at timestamp with time zone,
    finalized_by uuid,
    pdf_url text,
    docx_url text,
    last_exported_at timestamp with time zone,
    created_by uuid NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone,
    contact_id uuid
);


--
-- Name: TABLE candidate_prepared_profiles; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.candidate_prepared_profiles IS 'Stores formatted candidate profiles for client submission (E05)';


--
-- Name: candidate_profiles; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.candidate_profiles (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    candidate_id uuid NOT NULL,
    summary text,
    total_experience_years numeric(4,1),
    highest_education text,
    linkedin_url text,
    github_url text,
    portfolio_url text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone,
    contact_id uuid
);


--
-- Name: candidate_references; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.candidate_references (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    candidate_id uuid NOT NULL,
    reference_name text NOT NULL,
    reference_title text,
    reference_company text,
    relationship_type text,
    relationship_description text,
    years_known integer,
    worked_together_from date,
    worked_together_to date,
    email text,
    phone text,
    linkedin_url text,
    preferred_contact_method text,
    best_time_to_contact text,
    status text DEFAULT 'pending'::text,
    contact_attempts integer DEFAULT 0,
    last_contact_attempt timestamp with time zone,
    contacted_at timestamp with time zone,
    contacted_by uuid,
    completed_at timestamp with time zone,
    rating integer,
    overall_impression text,
    would_rehire boolean,
    would_work_with_again boolean,
    feedback_summary text,
    strengths text[],
    areas_for_improvement text[],
    questionnaire_responses jsonb,
    verification_notes text,
    internal_notes text,
    reference_consent_given boolean DEFAULT false,
    consent_date timestamp with time zone,
    display_order integer DEFAULT 0,
    is_primary boolean DEFAULT false,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    created_by uuid,
    updated_by uuid,
    contact_id uuid
);


--
-- Name: candidate_resumes; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.candidate_resumes (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    candidate_id uuid NOT NULL,
    version integer DEFAULT 1 NOT NULL,
    is_latest boolean DEFAULT true NOT NULL,
    previous_version_id uuid,
    bucket text DEFAULT 'resumes'::text NOT NULL,
    file_path text NOT NULL,
    file_name text NOT NULL,
    file_size integer NOT NULL,
    mime_type text NOT NULL,
    resume_type text DEFAULT 'master'::text,
    title text,
    notes text,
    parsed_content text,
    parsed_skills text[],
    parsed_experience text,
    ai_summary text,
    submission_write_up text,
    uploaded_by uuid NOT NULL,
    uploaded_at timestamp with time zone DEFAULT now() NOT NULL,
    is_archived boolean DEFAULT false,
    archived_at timestamp with time zone,
    archived_by uuid,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    contact_id uuid
);


--
-- Name: candidate_screenings; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.candidate_screenings (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    candidate_id uuid NOT NULL,
    job_id uuid,
    submission_id uuid,
    screener_id uuid NOT NULL,
    status text DEFAULT 'in_progress'::text NOT NULL,
    started_at timestamp with time zone DEFAULT now() NOT NULL,
    completed_at timestamp with time zone,
    duration_minutes integer,
    knockout_passed boolean,
    knockout_answers jsonb DEFAULT '[]'::jsonb,
    technical_scores jsonb DEFAULT '{}'::jsonb,
    technical_overall numeric(3,2),
    project_discussion jsonb,
    soft_skills_scores jsonb DEFAULT '{}'::jsonb,
    soft_skills_overall numeric(3,2),
    culture_fit_score numeric(3,2),
    interest_level text,
    motivation_notes jsonb,
    overall_score numeric(3,2),
    recommendation text DEFAULT 'hold'::text NOT NULL,
    strengths text[],
    concerns text[],
    interview_prep_notes text,
    compensation_discussion jsonb,
    next_steps jsonb DEFAULT '[]'::jsonb,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone,
    contact_id uuid
);


--
-- Name: TABLE candidate_screenings; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.candidate_screenings IS 'Stores candidate phone screening sessions with knockout results, technical/soft skill scores, and recommendations';


--
-- Name: COLUMN candidate_screenings.knockout_answers; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.candidate_screenings.knockout_answers IS 'JSONB array: [{ question_id, question, answer, passed, notes }]';


--
-- Name: COLUMN candidate_screenings.technical_scores; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.candidate_screenings.technical_scores IS 'JSONB object: { skill_name: { rating: 1-5, notes: string } }';


--
-- Name: COLUMN candidate_screenings.soft_skills_scores; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.candidate_screenings.soft_skills_scores IS 'JSONB object: { category: { rating: 1-5, notes: string } } - categories: communication, problem_solving, collaboration, leadership';


--
-- Name: COLUMN candidate_screenings.recommendation; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.candidate_screenings.recommendation IS 'submit, submit_with_reservations, hold, reject';


--
-- Name: candidate_skills; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.candidate_skills (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    candidate_id uuid NOT NULL,
    skill_id uuid NOT NULL,
    proficiency_level text DEFAULT 'intermediate'::text,
    years_of_experience numeric(4,1),
    is_certified boolean DEFAULT false,
    certification_name text,
    last_used_date date,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    skill_name text,
    certification_expiry date,
    is_primary boolean DEFAULT false,
    source text,
    contact_id uuid
);


--
-- Name: TABLE candidate_skills; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.candidate_skills IS 'Unified skills table - canonical source for all candidate/consultant skills';


--
-- Name: COLUMN candidate_skills.skill_name; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.candidate_skills.skill_name IS 'Denormalized from skills table for performance. Auto-populated by trigger.';


--
-- Name: COLUMN candidate_skills.source; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.candidate_skills.source IS 'Origin of the skill record: manual, resume_parse, linkedin, or migrated from consultant_skills_matrix';


--
-- Name: candidate_work_authorizations; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.candidate_work_authorizations (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    candidate_id uuid NOT NULL,
    authorization_type text NOT NULL,
    visa_type text,
    country_code text NOT NULL,
    status text DEFAULT 'active'::text NOT NULL,
    issue_date date,
    expiry_date date,
    receipt_number text,
    requires_sponsorship boolean DEFAULT false,
    current_sponsor text,
    is_transferable boolean DEFAULT true,
    transfer_in_progress boolean DEFAULT false,
    cap_exempt boolean DEFAULT false,
    lottery_selected boolean,
    lottery_year integer,
    ead_category text,
    ead_card_number text,
    ead_expiry date,
    i9_completed boolean DEFAULT false,
    i9_completed_at timestamp with time zone,
    i9_expiry_date date,
    i9_section_2_completed boolean DEFAULT false,
    i9_document_list text,
    i9_document_details jsonb,
    e_verify_status text,
    e_verify_case_number text,
    e_verify_completion_date date,
    passport_country text,
    passport_number_encrypted text,
    passport_issue_date date,
    passport_expiry_date date,
    has_valid_visa_stamp boolean DEFAULT false,
    visa_stamp_expiry date,
    documents jsonb DEFAULT '[]'::jsonb,
    notes text,
    is_primary boolean DEFAULT false,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    created_by uuid,
    updated_by uuid,
    contact_id uuid
);


--
-- Name: candidate_work_history; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.candidate_work_history (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    candidate_id uuid NOT NULL,
    company_name text NOT NULL,
    company_industry text,
    company_size text,
    job_title text NOT NULL,
    department text,
    employment_type text,
    employment_basis text,
    location_city text,
    location_state text,
    location_country text,
    country_code text,
    is_remote boolean DEFAULT false,
    remote_type text,
    start_date date NOT NULL,
    end_date date,
    is_current boolean DEFAULT false,
    description text,
    responsibilities text[],
    achievements text[],
    skills_used text[],
    tools_used text[],
    projects text[],
    salary_amount numeric(12,2),
    salary_currency text DEFAULT 'USD'::text,
    salary_type text,
    supervisor_name text,
    supervisor_title text,
    supervisor_email text,
    supervisor_phone text,
    hr_contact_name text,
    hr_contact_email text,
    hr_contact_phone text,
    is_verified boolean DEFAULT false,
    verified_at timestamp with time zone,
    verified_by uuid,
    verification_method text,
    verification_notes text,
    reason_for_leaving text,
    is_rehire_eligible boolean,
    rehire_notes text,
    display_order integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    created_by uuid,
    updated_by uuid,
    contact_id uuid
);


--
-- Name: capstone_submissions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.capstone_submissions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    enrollment_id uuid NOT NULL,
    course_id uuid NOT NULL,
    repository_url text NOT NULL,
    demo_video_url text,
    description text,
    submitted_at timestamp with time zone DEFAULT now(),
    revision_count integer DEFAULT 0,
    status text DEFAULT 'pending'::text,
    graded_by uuid,
    graded_at timestamp with time zone,
    grade numeric(5,2),
    feedback text,
    rubric_scores jsonb,
    peer_review_count integer DEFAULT 0,
    avg_peer_rating numeric(3,2),
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT capstone_submissions_avg_peer_rating_check CHECK (((avg_peer_rating >= (0)::numeric) AND (avg_peer_rating <= (5)::numeric))),
    CONSTRAINT capstone_submissions_grade_check CHECK (((grade >= (0)::numeric) AND (grade <= (100)::numeric))),
    CONSTRAINT capstone_submissions_status_check CHECK ((status = ANY (ARRAY['pending'::text, 'peer_review'::text, 'trainer_review'::text, 'passed'::text, 'failed'::text, 'revision_requested'::text])))
);


--
-- Name: TABLE capstone_submissions; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.capstone_submissions IS 'Student capstone project submissions with grading workflow';


--
-- Name: capstone_grading_queue; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.capstone_grading_queue AS
 SELECT cs.id,
    cs.user_id,
    cs.enrollment_id,
    cs.course_id,
    up.full_name AS student_name,
    up.email AS student_email,
    c.title AS course_title,
    cs.repository_url,
    cs.demo_video_url,
    cs.description,
    cs.submitted_at,
    cs.status,
    cs.revision_count,
    cs.peer_review_count,
    cs.avg_peer_rating,
    (EXTRACT(epoch FROM (now() - cs.submitted_at)) / (3600)::numeric) AS hours_waiting
   FROM ((public.capstone_submissions cs
     JOIN public.user_profiles up ON ((cs.user_id = up.id)))
     JOIN public.courses c ON ((cs.course_id = c.id)))
  WHERE (cs.status = ANY (ARRAY['pending'::text, 'peer_review'::text, 'trainer_review'::text]))
  ORDER BY cs.submitted_at;


--
-- Name: VIEW capstone_grading_queue; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.capstone_grading_queue IS 'Capstone submissions awaiting trainer grading';


--
-- Name: capstone_statistics; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.capstone_statistics AS
 SELECT cs.course_id,
    c.title AS course_title,
    count(*) AS total_submissions,
    count(
        CASE
            WHEN (cs.status = 'passed'::text) THEN 1
            ELSE NULL::integer
        END) AS passed_count,
    count(
        CASE
            WHEN (cs.status = 'failed'::text) THEN 1
            ELSE NULL::integer
        END) AS failed_count,
    count(
        CASE
            WHEN (cs.status = 'revision_requested'::text) THEN 1
            ELSE NULL::integer
        END) AS revision_count,
    avg(cs.grade) FILTER (WHERE (cs.grade IS NOT NULL)) AS avg_grade,
    avg(cs.peer_review_count) AS avg_peer_reviews,
    avg(cs.revision_count) AS avg_revisions
   FROM (public.capstone_submissions cs
     JOIN public.courses c ON ((cs.course_id = c.id)))
  GROUP BY cs.course_id, c.title;


--
-- Name: VIEW capstone_statistics; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.capstone_statistics IS 'Capstone submission statistics by course';


--
-- Name: certificate_templates; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.certificate_templates (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    name text NOT NULL,
    design_template text NOT NULL,
    fields jsonb,
    is_active boolean DEFAULT true,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: certificates; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.certificates (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    enrollment_id uuid NOT NULL,
    template_id uuid,
    certificate_number text NOT NULL,
    issued_at timestamp with time zone DEFAULT now() NOT NULL,
    expiry_date timestamp with time zone,
    pdf_url text,
    verification_code text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: comments; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.comments (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    entity_type text NOT NULL,
    entity_id uuid NOT NULL,
    content text NOT NULL,
    parent_comment_id uuid,
    reply_count integer DEFAULT 0,
    author_id uuid NOT NULL,
    mentioned_user_ids uuid[],
    reactions jsonb DEFAULT '{}'::jsonb,
    is_deleted boolean DEFAULT false,
    deleted_at timestamp with time zone,
    deleted_by uuid,
    is_edited boolean DEFAULT false,
    edited_at timestamp with time zone,
    original_content text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE comments; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.comments IS 'Collaborative comments on entities with @mentions';


--
-- Name: commission_payments; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.commission_payments (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    commission_id uuid NOT NULL,
    amount numeric(12,2) NOT NULL,
    payment_date date NOT NULL,
    payment_method text,
    reference_number text,
    period_start date,
    period_end date,
    period_label text,
    notes text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid
);


--
-- Name: TABLE commission_payments; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.commission_payments IS 'Payment history for commissions';


--
-- Name: commissions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.commissions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    deal_id uuid NOT NULL,
    placement_id uuid,
    user_id uuid NOT NULL,
    deal_value numeric(12,2) NOT NULL,
    gross_margin numeric(12,2),
    margin_percentage numeric(5,2) DEFAULT 20.00,
    commission_percentage numeric(5,2) DEFAULT 5.00,
    projected_commission numeric(12,2) NOT NULL,
    actual_commission numeric(12,2),
    commission_type text DEFAULT 'deal_close'::text NOT NULL,
    status text DEFAULT 'pending'::text NOT NULL,
    payment_schedule text DEFAULT 'monthly'::text,
    payment_period_start date,
    payment_period_end date,
    activated_at timestamp with time zone,
    paid_at timestamp with time zone,
    cancelled_at timestamp with time zone,
    cancelled_reason text,
    notes text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid,
    CONSTRAINT commissions_commission_type_check CHECK ((commission_type = ANY (ARRAY['deal_close'::text, 'placement'::text, 'renewal'::text, 'expansion'::text]))),
    CONSTRAINT commissions_payment_schedule_check CHECK ((payment_schedule = ANY (ARRAY['one_time'::text, 'monthly'::text, 'quarterly'::text]))),
    CONSTRAINT commissions_status_check CHECK ((status = ANY (ARRAY['pending'::text, 'active'::text, 'paid'::text, 'cancelled'::text, 'clawback'::text])))
);


--
-- Name: TABLE commissions; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.commissions IS 'Tracks commissions earned from closed deals and placements';


--
-- Name: COLUMN commissions.projected_commission; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.commissions.projected_commission IS 'Calculated commission based on deal value and rates';


--
-- Name: COLUMN commissions.actual_commission; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.commissions.actual_commission IS 'Running total of actual commission paid';


--
-- Name: COLUMN commissions.status; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.commissions.status IS 'pending=awaiting first placement, active=earning commissions, paid=fully paid, cancelled=deal fell through, clawback=returned due to early termination';


--
-- Name: company_addresses; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.company_addresses (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    company_id uuid NOT NULL,
    address_id uuid NOT NULL,
    address_type character varying(30) NOT NULL,
    is_primary boolean DEFAULT false,
    label text,
    is_active boolean DEFAULT true,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: company_compliance_requirements; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.company_compliance_requirements (
    company_id uuid NOT NULL,
    org_id uuid NOT NULL,
    general_liability_required boolean DEFAULT false,
    general_liability_minimum text,
    professional_liability_required boolean DEFAULT false,
    professional_liability_minimum text,
    workers_comp_required boolean DEFAULT true,
    cyber_liability_required boolean DEFAULT false,
    cyber_liability_minimum text,
    umbrella_required boolean DEFAULT false,
    umbrella_minimum text,
    coi_on_file boolean DEFAULT false,
    coi_expiration_date date,
    coi_document_url text,
    client_named_on_coi boolean DEFAULT false,
    background_check_required boolean DEFAULT false,
    background_check_level character varying(50),
    background_check_vendor character varying(50),
    background_check_max_age_days integer DEFAULT 365,
    drug_test_required boolean DEFAULT false,
    drug_test_type character varying(20),
    drug_test_frequency character varying(20),
    security_clearance_required boolean DEFAULT false,
    security_clearance_level character varying(50),
    citizenship_required character varying(50),
    hipaa_training_required boolean DEFAULT false,
    sox_compliance_required boolean DEFAULT false,
    pci_compliance_required boolean DEFAULT false,
    fedramp_required boolean DEFAULT false,
    w9_required boolean DEFAULT true,
    nda_required boolean DEFAULT false,
    non_compete_required boolean DEFAULT false,
    i9_verification_method character varying(20) DEFAULT 'standard'::character varying,
    work_authorization_types text[],
    soc2_attestation_required boolean DEFAULT false,
    gdpr_compliance_required boolean DEFAULT false,
    ccpa_compliance_required boolean DEFAULT false,
    data_retention_years integer DEFAULT 7,
    data_handling_instructions text,
    safety_training_required boolean DEFAULT false,
    safety_certifications text[],
    ppe_requirements text[],
    custom_requirements jsonb DEFAULT '{}'::jsonb,
    updated_at timestamp with time zone DEFAULT now(),
    updated_by uuid
);


--
-- Name: company_contacts; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.company_contacts (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    company_id uuid NOT NULL,
    contact_id uuid NOT NULL,
    job_title text,
    department text,
    role_description text,
    decision_authority public.contact_decision_authority,
    influence_level integer,
    is_primary boolean DEFAULT false,
    is_active boolean DEFAULT true,
    relationship_strength integer,
    last_contact_date date,
    preferred_contact_method character varying(20),
    started_at date,
    left_at date,
    left_reason text,
    vendor_company_id uuid,
    notes text,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    created_by uuid,
    CONSTRAINT company_contacts_influence_level_check CHECK (((influence_level >= 1) AND (influence_level <= 5))),
    CONSTRAINT company_contacts_relationship_strength_check CHECK (((relationship_strength >= 1) AND (relationship_strength <= 5)))
);


--
-- Name: company_contracts; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.company_contracts (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    company_id uuid NOT NULL,
    contract_type public.contract_type NOT NULL,
    contract_number character varying(50),
    name text NOT NULL,
    description text,
    status public.contract_status DEFAULT 'draft'::public.contract_status,
    effective_date date,
    expiration_date date,
    signed_date date,
    terminated_date date,
    auto_renews boolean DEFAULT false,
    renewal_term_months integer,
    renewal_notice_days integer DEFAULT 30,
    contract_value numeric(15,2),
    currency character varying(3) DEFAULT 'USD'::character varying,
    our_signatory_id uuid,
    their_signatory_name text,
    their_signatory_title text,
    their_signatory_email text,
    document_url text,
    document_storage_key text,
    terms jsonb DEFAULT '{}'::jsonb,
    parent_contract_id uuid,
    expiration_alert_sent boolean DEFAULT false,
    expiration_alert_date date,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    created_by uuid,
    deleted_at timestamp with time zone
);


--
-- Name: company_health_scores; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.company_health_scores (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    company_id uuid NOT NULL,
    score_date date DEFAULT CURRENT_DATE NOT NULL,
    overall_score integer,
    overall_grade character(1),
    health_status character varying(20),
    engagement_score integer,
    days_since_last_contact integer,
    days_since_last_job integer,
    response_rate_percentage numeric(5,2),
    meetings_last_90d integer,
    financial_score integer,
    revenue_trend character varying(10),
    revenue_vs_target_percentage numeric(5,2),
    payment_timeliness_score integer,
    outstanding_ar_amount numeric(12,2),
    relationship_score integer,
    nps_score integer,
    satisfaction_score numeric(3,1),
    escalations_last_90d integer,
    decision_maker_turnover boolean DEFAULT false,
    opportunity_score integer,
    active_jobs_count integer,
    pipeline_value numeric(12,2),
    expansion_potential character varying(20),
    risk_factors jsonb DEFAULT '[]'::jsonb,
    recommended_actions jsonb DEFAULT '[]'::jsonb,
    calculated_at timestamp with time zone DEFAULT now(),
    calculated_by character varying(50) DEFAULT 'system'::character varying,
    CONSTRAINT company_health_scores_engagement_score_check CHECK (((engagement_score >= 0) AND (engagement_score <= 30))),
    CONSTRAINT company_health_scores_financial_score_check CHECK (((financial_score >= 0) AND (financial_score <= 30))),
    CONSTRAINT company_health_scores_opportunity_score_check CHECK (((opportunity_score >= 0) AND (opportunity_score <= 20))),
    CONSTRAINT company_health_scores_overall_grade_check CHECK ((overall_grade = ANY (ARRAY['A'::bpchar, 'B'::bpchar, 'C'::bpchar, 'D'::bpchar, 'F'::bpchar]))),
    CONSTRAINT company_health_scores_overall_score_check CHECK (((overall_score >= 0) AND (overall_score <= 100))),
    CONSTRAINT company_health_scores_relationship_score_check CHECK (((relationship_score >= 0) AND (relationship_score <= 20)))
);


--
-- Name: company_metrics; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.company_metrics (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    company_id uuid NOT NULL,
    period_type public.metric_period_type NOT NULL,
    period_start date NOT NULL,
    period_end date NOT NULL,
    jobs_posted integer DEFAULT 0,
    jobs_filled integer DEFAULT 0,
    jobs_cancelled integer DEFAULT 0,
    fill_rate numeric(5,2),
    avg_time_to_fill_days integer,
    submissions_sent integer DEFAULT 0,
    submissions_accepted integer DEFAULT 0,
    submissions_rejected integer DEFAULT 0,
    submission_to_interview_rate numeric(5,2),
    interviews_scheduled integer DEFAULT 0,
    interviews_completed integer DEFAULT 0,
    interviews_cancelled integer DEFAULT 0,
    interview_to_offer_rate numeric(5,2),
    placements_started integer DEFAULT 0,
    placements_ended integer DEFAULT 0,
    placements_active_eop integer DEFAULT 0,
    avg_placement_duration_days integer,
    gross_revenue numeric(15,2) DEFAULT 0,
    net_revenue numeric(15,2) DEFAULT 0,
    gross_margin numeric(15,2) DEFAULT 0,
    gross_margin_percentage numeric(5,2),
    revenue_per_placement numeric(12,2),
    activities_logged integer DEFAULT 0,
    emails_sent integer DEFAULT 0,
    calls_made integer DEFAULT 0,
    meetings_held integer DEFAULT 0,
    engagement_score integer,
    performance_score integer,
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: company_notes; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.company_notes (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    company_id uuid NOT NULL,
    note_type public.company_note_type DEFAULT 'general'::public.company_note_type,
    title text,
    content text NOT NULL,
    is_pinned boolean DEFAULT false,
    is_private boolean DEFAULT false,
    related_contact_id uuid,
    related_job_id uuid,
    related_deal_id uuid,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    created_by uuid NOT NULL,
    deleted_at timestamp with time zone
);


--
-- Name: company_partner_details; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.company_partner_details (
    company_id uuid NOT NULL,
    org_id uuid NOT NULL,
    partnership_type character varying(50),
    partnership_tier character varying(20),
    partnership_start_date date,
    partnership_renewal_date date,
    referral_fee_percentage numeric(5,2),
    referral_fee_flat numeric(10,2),
    referral_tracking_period_days integer DEFAULT 365,
    total_referrals integer DEFAULT 0,
    successful_referrals integer DEFAULT 0,
    referral_conversion_rate numeric(5,2),
    total_referral_revenue numeric(15,2) DEFAULT 0,
    co_marketing_fund numeric(10,2),
    co_marketing_activities text[],
    joint_case_studies text[],
    api_integration_enabled boolean DEFAULT false,
    integration_type character varying(50),
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE company_partner_details; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.company_partner_details IS 'Extension table for partner-specific fields (class table inheritance)';


--
-- Name: company_preferences; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.company_preferences (
    company_id uuid NOT NULL,
    org_id uuid NOT NULL,
    preferred_skills text[],
    excluded_skills text[],
    required_certifications text[],
    min_years_experience integer,
    max_years_experience integer,
    preferred_experience_levels text[],
    degree_required boolean DEFAULT false,
    preferred_degree_levels text[],
    preferred_universities text[],
    visa_types_accepted text[],
    requires_us_citizen boolean DEFAULT false,
    work_mode_preference character varying(20),
    office_locations text[],
    remote_states_allowed text[],
    relocation_assistance boolean DEFAULT false,
    rate_range_min numeric(10,2),
    rate_range_max numeric(10,2),
    rate_type character varying(20) DEFAULT 'hourly'::character varying,
    typical_start_timeline_days integer,
    interview_format_preference text[],
    decision_timeline_days integer,
    preferred_submission_format character varying(50),
    submission_limit_per_job integer,
    feedback_commitment character varying(50),
    custom_preferences jsonb DEFAULT '{}'::jsonb,
    special_instructions text,
    updated_at timestamp with time zone DEFAULT now(),
    updated_by uuid
);


--
-- Name: company_rate_card_items; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.company_rate_card_items (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    rate_card_id uuid NOT NULL,
    job_category text NOT NULL,
    job_level text,
    job_family text,
    min_pay_rate numeric(10,2),
    max_pay_rate numeric(10,2),
    target_pay_rate numeric(10,2),
    min_bill_rate numeric(10,2),
    max_bill_rate numeric(10,2),
    standard_bill_rate numeric(10,2),
    target_margin_percentage numeric(5,2),
    min_margin_percentage numeric(5,2),
    rate_type character varying(20) DEFAULT 'hourly'::character varying,
    overtime_multiplier numeric(3,2),
    sort_order integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: company_rate_cards; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.company_rate_cards (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    company_id uuid NOT NULL,
    name text NOT NULL,
    version integer DEFAULT 1,
    effective_start_date date NOT NULL,
    effective_end_date date,
    status public.rate_card_status DEFAULT 'draft'::public.rate_card_status,
    currency character varying(3) DEFAULT 'USD'::character varying,
    applicable_regions text[],
    msp_program_id uuid,
    msp_tier integer,
    default_markup_percentage numeric(5,2),
    max_markup_percentage numeric(5,2),
    min_margin_percentage numeric(5,2),
    overtime_multiplier numeric(3,2) DEFAULT 1.5,
    double_time_multiplier numeric(3,2) DEFAULT 2.0,
    direct_hire_fee_percentage numeric(5,2) DEFAULT 20.00,
    guarantee_period_days integer DEFAULT 90,
    cth_conversion_fee_percentage numeric(5,2),
    cth_hours_credit integer DEFAULT 0,
    per_diem_rate numeric(8,2),
    mileage_rate numeric(5,3),
    expense_markup_percentage numeric(5,2) DEFAULT 0,
    notes text,
    approved_by uuid,
    approved_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    created_by uuid,
    deleted_at timestamp with time zone
);


--
-- Name: company_relationships; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.company_relationships (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    company_a_id uuid NOT NULL,
    company_b_id uuid NOT NULL,
    relationship_category public.company_relationship_category NOT NULL,
    relationship_direction character varying(10) NOT NULL,
    relationship_label_a_to_b text,
    relationship_label_b_to_a text,
    is_active boolean DEFAULT true,
    started_date date,
    ended_date date,
    details jsonb DEFAULT '{}'::jsonb,
    notes text,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    created_by uuid,
    deleted_at timestamp with time zone,
    CONSTRAINT company_relationships_check CHECK ((company_a_id <> company_b_id))
);


--
-- Name: company_revenue; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.company_revenue (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    company_id uuid NOT NULL,
    revenue_type character varying(50) NOT NULL,
    placement_id uuid,
    job_id uuid,
    invoice_id uuid,
    revenue_date date NOT NULL,
    period_start date,
    period_end date,
    gross_revenue numeric(12,2) NOT NULL,
    cost numeric(12,2) DEFAULT 0,
    gross_margin numeric(12,2),
    margin_percentage numeric(5,2),
    currency character varying(3) DEFAULT 'USD'::character varying,
    billing_company_id uuid,
    end_client_company_id uuid,
    job_category text,
    job_level text,
    work_location_state text,
    contract_type character varying(20),
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: company_tags; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.company_tags (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    company_id uuid NOT NULL,
    tag_name text NOT NULL,
    tag_category text,
    created_at timestamp with time zone DEFAULT now(),
    created_by uuid
);


--
-- Name: company_team; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.company_team (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    company_id uuid NOT NULL,
    user_id uuid NOT NULL,
    role public.company_team_role NOT NULL,
    is_primary boolean DEFAULT false,
    region text,
    job_categories text[],
    assigned_at timestamp with time zone DEFAULT now(),
    assigned_by uuid,
    removed_at timestamp with time zone,
    removed_by uuid,
    notify_on_new_job boolean DEFAULT true,
    notify_on_placement boolean DEFAULT true,
    notify_on_activity boolean DEFAULT false,
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: company_vendor_details; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.company_vendor_details (
    company_id uuid NOT NULL,
    org_id uuid NOT NULL,
    vendor_type public.company_vendor_type DEFAULT 'prime_vendor'::public.company_vendor_type NOT NULL,
    industry_focus text[],
    geographic_focus text[],
    skill_focus text[],
    vendor_manager_id uuid,
    onboarded_date date,
    last_job_order_date date,
    payment_terms_to_us character varying(20) DEFAULT 'Net 60'::character varying,
    typical_markup_to_client numeric(5,2),
    our_typical_margin numeric(5,2),
    preferred_job_categories text[],
    excluded_job_categories text[],
    min_rate_hourly numeric(10,2),
    max_rate_hourly numeric(10,2),
    accepts_corp_to_corp boolean DEFAULT true,
    accepts_1099 boolean DEFAULT true,
    total_job_orders integer DEFAULT 0,
    filled_job_orders integer DEFAULT 0,
    fill_rate numeric(5,2),
    avg_time_to_fill_days integer,
    total_revenue_from_vendor numeric(15,2) DEFAULT 0,
    job_order_delivery_method character varying(20) DEFAULT 'email'::character varying,
    submission_format character varying(20) DEFAULT 'email'::character varying,
    requires_right_to_represent boolean DEFAULT true,
    rtr_validity_hours integer DEFAULT 24,
    is_blacklisted boolean DEFAULT false,
    blacklist_reason text,
    blacklist_date date,
    has_payment_issues boolean DEFAULT false,
    payment_issue_notes text,
    supplies_talent boolean DEFAULT false,
    talent_categories text[],
    talent_specializations text[],
    bench_consultants_count integer DEFAULT 0,
    candidates_supplied_count integer DEFAULT 0,
    candidates_placed_count integer DEFAULT 0,
    talent_placement_rate numeric(5,2),
    avg_talent_quality_score numeric(3,1),
    legacy_terms_data jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE company_vendor_details; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.company_vendor_details IS 'Extension table for vendor-specific fields (class table inheritance)';


--
-- Name: COLUMN company_vendor_details.vendor_type; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.company_vendor_details.vendor_type IS 'Type of vendor (company_vendor_type enum): direct_client, prime_vendor, sub_vendor, msp, vms_provider, talent_supplier, referral_source';


--
-- Name: compliance_requirements; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.compliance_requirements (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    name text NOT NULL,
    type public.compliance_type NOT NULL,
    jurisdiction text,
    applies_to public.compliance_applies_to DEFAULT 'all'::public.compliance_applies_to NOT NULL,
    frequency public.compliance_frequency NOT NULL,
    description text,
    document_template_url text,
    is_active boolean DEFAULT true,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid
);


--
-- Name: consultant_availability; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.consultant_availability (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    consultant_id uuid NOT NULL,
    available_from date NOT NULL,
    notice_period_days integer DEFAULT 0,
    blackout_dates jsonb,
    travel_restrictions text,
    relocation_assistance_needed boolean DEFAULT false,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE consultant_availability; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.consultant_availability IS 'Availability and scheduling constraints';


--
-- Name: consultant_rates; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.consultant_rates (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    consultant_id uuid NOT NULL,
    rate_type text DEFAULT 'hourly'::text NOT NULL,
    min_rate numeric(10,2) NOT NULL,
    target_rate numeric(10,2) NOT NULL,
    max_rate numeric(10,2),
    currency text DEFAULT 'USD'::text NOT NULL,
    effective_from date NOT NULL,
    effective_to date,
    notes text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid
);


--
-- Name: TABLE consultant_rates; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.consultant_rates IS 'Rate history and expectations';


--
-- Name: consultant_visa_details; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.consultant_visa_details (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    consultant_id uuid NOT NULL,
    visa_type public.visa_type NOT NULL,
    visa_start_date date,
    visa_expiry_date date,
    lca_status text,
    employer_of_record text,
    grace_period_ends date,
    alert_level public.visa_alert_level DEFAULT 'green'::public.visa_alert_level,
    notes text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE consultant_visa_details; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.consultant_visa_details IS 'Detailed visa information and tracking';


--
-- Name: consultant_work_authorization; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.consultant_work_authorization (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    consultant_id uuid NOT NULL,
    auth_type text NOT NULL,
    start_date date,
    end_date date,
    document_url text,
    document_file_id uuid,
    verified_by uuid,
    verified_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE consultant_work_authorization; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.consultant_work_authorization IS 'Work authorization documents and verification';


--
-- Name: contact_addresses_view; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.contact_addresses_view AS
 SELECT c.id AS contact_id,
    c.org_id,
    c.first_name,
    c.last_name,
    c.email,
    addr.id AS address_id,
    addr.address_type,
    addr.address_line_1,
    addr.city,
    addr.state_province,
    addr.postal_code,
    addr.country_code,
    addr.is_primary,
    addr.created_at,
    addr.updated_at
   FROM (public.contacts c
     LEFT JOIN public.addresses addr ON (((addr.entity_type = 'contact'::text) AND (addr.entity_id = c.id))))
  WHERE (c.deleted_at IS NULL);


--
-- Name: VIEW contact_addresses_view; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.contact_addresses_view IS 'View for accessing contact addresses';


--
-- Name: contact_agreements; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.contact_agreements (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    contact_id uuid NOT NULL,
    agreement_type text NOT NULL,
    agreement_name text,
    effective_date date,
    expiry_date date,
    auto_renew boolean DEFAULT false,
    renewal_notice_days integer DEFAULT 30,
    status text DEFAULT 'draft'::text NOT NULL,
    document_url text,
    signed_document_url text,
    our_signer_id uuid,
    our_signed_at timestamp with time zone,
    their_signer_name text,
    their_signed_at timestamp with time zone,
    terms jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone,
    CONSTRAINT contact_agreements_status_check CHECK ((status = ANY (ARRAY['draft'::text, 'pending'::text, 'active'::text, 'expired'::text, 'terminated'::text]))),
    CONSTRAINT contact_agreements_type_check CHECK ((agreement_type = ANY (ARRAY['msa'::text, 'nda'::text, 'sow'::text, 'rate_card'::text, 'sla'::text, 'vendor_agreement'::text, 'other'::text])))
);


--
-- Name: TABLE contact_agreements; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.contact_agreements IS 'MSAs, contracts, NDAs for company contacts';


--
-- Name: contact_certifications; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.contact_certifications (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    contact_id uuid NOT NULL,
    certification_name text NOT NULL,
    issuing_organization text,
    issue_date date,
    expiry_date date,
    is_active boolean DEFAULT true,
    credential_id text,
    verification_url text,
    renewal_required boolean DEFAULT false,
    renewal_reminder_sent_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone
);


--
-- Name: TABLE contact_certifications; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.contact_certifications IS 'Professional certifications, migrated from candidate_certifications';


--
-- Name: contact_communication_preferences; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.contact_communication_preferences (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    contact_id uuid NOT NULL,
    channel text NOT NULL,
    is_opted_in boolean DEFAULT true,
    opted_in_at timestamp with time zone,
    opted_out_at timestamp with time zone,
    consent_source text,
    frequency_preference text,
    content_preferences text[],
    bounce_count integer DEFAULT 0,
    last_bounce_at timestamp with time zone,
    complaint_count integer DEFAULT 0,
    last_complaint_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT contact_comm_prefs_channel_check CHECK ((channel = ANY (ARRAY['email'::text, 'phone'::text, 'sms'::text, 'linkedin'::text, 'whatsapp'::text, 'mail'::text])))
);


--
-- Name: TABLE contact_communication_preferences; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.contact_communication_preferences IS 'Channel-specific opt-in/out preferences';


--
-- Name: contact_compliance; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.contact_compliance (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    contact_id uuid NOT NULL,
    compliance_type text NOT NULL,
    status text DEFAULT 'pending'::text NOT NULL,
    document_url text,
    document_received_at timestamp with time zone,
    effective_date date,
    expiry_date date,
    verified_by uuid,
    verified_at timestamp with time zone,
    verification_notes text,
    policy_number text,
    coverage_amount numeric(15,2),
    insurance_carrier text,
    expiry_alert_sent_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone,
    CONSTRAINT contact_compliance_status_check CHECK ((status = ANY (ARRAY['pending'::text, 'received'::text, 'verified'::text, 'expiring'::text, 'expired'::text, 'rejected'::text]))),
    CONSTRAINT contact_compliance_type_check CHECK ((compliance_type = ANY (ARRAY['general_liability'::text, 'workers_comp'::text, 'e_o'::text, 'cyber'::text, 'w9'::text, 'coi'::text, 'background_check'::text, 'drug_test'::text, 'i9'::text, 'w4'::text, 'direct_deposit'::text])))
);


--
-- Name: TABLE contact_compliance; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.contact_compliance IS 'Insurance, W9, background checks, and other compliance documents';


--
-- Name: contact_education; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.contact_education (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    contact_id uuid NOT NULL,
    institution_name text NOT NULL,
    institution_type text,
    degree_type text,
    field_of_study text,
    major text,
    minor text,
    start_date date,
    end_date date,
    graduation_date date,
    is_completed boolean DEFAULT false,
    gpa numeric(4,2),
    gpa_scale numeric(3,1) DEFAULT 4.0,
    honors text,
    activities text,
    achievements text[],
    is_verified boolean DEFAULT false,
    verified_by uuid,
    display_order integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone
);


--
-- Name: TABLE contact_education; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.contact_education IS 'Education records for contacts, migrated from candidate_education';


--
-- Name: contact_lead_data; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.contact_lead_data (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    contact_id uuid NOT NULL,
    lead_score integer,
    lead_status text DEFAULT 'new'::text,
    qualification_status text,
    budget_confirmed boolean DEFAULT false,
    authority_confirmed boolean DEFAULT false,
    need_confirmed boolean DEFAULT false,
    timeline_confirmed boolean DEFAULT false,
    estimated_value numeric(12,2),
    estimated_close_date date,
    converted_to_deal_id uuid,
    converted_to_account_id uuid,
    converted_at timestamp with time zone,
    lost_reason text,
    source_campaign_id uuid,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT contact_lead_data_lead_score_check CHECK (((lead_score >= 0) AND (lead_score <= 100))),
    CONSTRAINT contact_lead_data_lead_status_check CHECK ((lead_status = ANY (ARRAY['new'::text, 'warm'::text, 'hot'::text, 'cold'::text, 'qualified'::text, 'unqualified'::text, 'converted'::text, 'lost'::text]))),
    CONSTRAINT contact_lead_data_qualification_status_check CHECK ((qualification_status = ANY (ARRAY['unqualified'::text, 'marketing_qualified'::text, 'sales_qualified'::text, 'opportunity'::text])))
);


--
-- Name: contact_merge_history; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.contact_merge_history (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    survivor_contact_id uuid NOT NULL,
    merged_contact_id uuid NOT NULL,
    merged_at timestamp with time zone DEFAULT now() NOT NULL,
    merged_by uuid,
    field_selections jsonb DEFAULT '{}'::jsonb,
    merged_contact_snapshot jsonb NOT NULL,
    notes text
);


--
-- Name: TABLE contact_merge_history; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.contact_merge_history IS 'Audit trail for contact deduplication merges';


--
-- Name: contact_rate_cards; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.contact_rate_cards (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    contact_id uuid NOT NULL,
    client_id uuid,
    skill_id uuid,
    job_id uuid,
    bill_rate_hourly numeric(10,2),
    pay_rate_hourly numeric(10,2),
    markup_percentage numeric(5,2),
    overtime_multiplier numeric(3,2) DEFAULT 1.5,
    effective_date date NOT NULL,
    expiry_date date,
    is_active boolean DEFAULT true,
    approved_by uuid,
    approved_at timestamp with time zone,
    notes text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone
);


--
-- Name: TABLE contact_rate_cards; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.contact_rate_cards IS 'Bill/pay rates by context (client, skill, job)';


--
-- Name: contact_relationships; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.contact_relationships (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    source_contact_id uuid NOT NULL,
    target_contact_id uuid NOT NULL,
    relationship_type text NOT NULL,
    title_at_company text,
    department_at_company text,
    start_date date,
    end_date date,
    is_current boolean DEFAULT false,
    relationship_strength integer,
    notes text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid,
    updated_by uuid,
    deleted_at timestamp with time zone,
    CONSTRAINT contact_relationships_strength_check CHECK (((relationship_strength IS NULL) OR ((relationship_strength >= 1) AND (relationship_strength <= 10)))),
    CONSTRAINT contact_relationships_type_check CHECK ((relationship_type = ANY (ARRAY['works_at'::text, 'worked_at'::text, 'owns'::text, 'founded'::text, 'board_member'::text, 'reports_to'::text, 'manages'::text, 'referred_by'::text, 'knows'::text, 'mentors'::text, 'spouse_of'::text])))
);


--
-- Name: TABLE contact_relationships; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.contact_relationships IS 'Tracks relationships between contacts (person-company employment, person-person referrals, etc.)';


--
-- Name: contact_roles; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.contact_roles (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    contact_id uuid NOT NULL,
    role_type text NOT NULL,
    role_status text DEFAULT 'active'::text NOT NULL,
    context_company_id uuid,
    context_details jsonb DEFAULT '{}'::jsonb,
    role_started_at timestamp with time zone DEFAULT now(),
    role_ended_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid,
    deleted_at timestamp with time zone,
    CONSTRAINT contact_roles_status_check CHECK ((role_status = ANY (ARRAY['active'::text, 'inactive'::text, 'pending'::text, 'suspended'::text]))),
    CONSTRAINT contact_roles_type_check CHECK ((role_type = ANY (ARRAY['candidate'::text, 'employee'::text, 'client_contact'::text, 'hiring_manager'::text, 'hr_contact'::text, 'vendor_contact'::text, 'bench_internal'::text, 'bench_vendor'::text, 'placed'::text, 'referral_source'::text, 'alumni'::text])))
);


--
-- Name: TABLE contact_roles; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.contact_roles IS 'Tracks multiple concurrent roles a contact can have (candidate, employee, vendor contact, etc.)';


--
-- Name: contact_skills; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.contact_skills (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    contact_id uuid NOT NULL,
    skill_id uuid,
    skill_name text NOT NULL,
    skill_category text,
    proficiency_level integer DEFAULT 3,
    years_experience numeric(4,1),
    last_used_date date,
    is_primary boolean DEFAULT false,
    is_verified boolean DEFAULT false,
    verified_by uuid,
    verified_at timestamp with time zone,
    verification_method text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone,
    CONSTRAINT contact_skills_proficiency_check CHECK (((proficiency_level >= 1) AND (proficiency_level <= 5)))
);


--
-- Name: TABLE contact_skills; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.contact_skills IS 'Unified skills for all contact types, migrated from candidate_skills';


--
-- Name: contact_work_history; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.contact_work_history (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    contact_id uuid NOT NULL,
    company_name text NOT NULL,
    company_contact_id uuid,
    title text NOT NULL,
    department text,
    employment_type text,
    start_date date NOT NULL,
    end_date date,
    is_current boolean DEFAULT false,
    description text,
    achievements text[],
    reason_for_leaving text,
    manager_name text,
    manager_contact text,
    location text,
    is_remote boolean DEFAULT false,
    is_verified boolean DEFAULT false,
    verified_by uuid,
    verified_at timestamp with time zone,
    display_order integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone
);


--
-- Name: TABLE contact_work_history; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.contact_work_history IS 'Employment history for contacts, migrated from candidate_work_history';


--
-- Name: content_assets; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.content_assets (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    filename text NOT NULL,
    storage_path text NOT NULL,
    file_type text NOT NULL,
    mime_type text NOT NULL,
    file_size_bytes bigint NOT NULL,
    topic_id uuid,
    lesson_id uuid,
    cdn_url text,
    is_public boolean DEFAULT false,
    replaced_by uuid,
    is_current boolean DEFAULT true,
    uploaded_by uuid,
    uploaded_at timestamp with time zone DEFAULT now(),
    searchable_content text,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT content_assets_file_size_bytes_check CHECK ((file_size_bytes > 0)),
    CONSTRAINT content_assets_file_type_check CHECK ((file_type = ANY (ARRAY['video'::text, 'pdf'::text, 'image'::text, 'document'::text, 'other'::text])))
);


--
-- Name: TABLE content_assets; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.content_assets IS 'Tracks uploaded course content files (videos, PDFs, images)';


--
-- Name: COLUMN content_assets.storage_path; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.content_assets.storage_path IS 'Unique path in Supabase Storage bucket';


--
-- Name: COLUMN content_assets.replaced_by; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.content_assets.replaced_by IS 'ID of newer version that replaced this asset';


--
-- Name: COLUMN content_assets.is_current; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.content_assets.is_current IS 'Whether this is the current version (not replaced)';


--
-- Name: COLUMN content_assets.searchable_content; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.content_assets.searchable_content IS 'Extracted text from PDFs for full-text search';


--
-- Name: course_pricing; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.course_pricing (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    course_id uuid NOT NULL,
    price_monthly numeric(10,2),
    price_annual numeric(10,2),
    price_one_time numeric(10,2),
    stripe_price_id_monthly text,
    stripe_price_id_annual text,
    stripe_price_id_one_time text,
    stripe_product_id text,
    early_bird_price numeric(10,2),
    early_bird_valid_until timestamp with time zone,
    scholarship_available boolean DEFAULT false,
    scholarship_criteria text,
    team_discount_percentage numeric(5,2),
    min_team_size integer DEFAULT 5,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE course_pricing; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.course_pricing IS 'ACAD-029: Course-specific pricing overrides';


--
-- Name: payment_transactions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.payment_transactions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    enrollment_id uuid,
    stripe_payment_intent_id text,
    stripe_invoice_id text,
    stripe_customer_id text,
    amount numeric(10,2) NOT NULL,
    currency text DEFAULT 'usd'::text,
    status text NOT NULL,
    payment_method_type text,
    metadata jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT payment_transactions_status_check CHECK ((status = ANY (ARRAY['succeeded'::text, 'pending'::text, 'failed'::text, 'refunded'::text])))
);


--
-- Name: TABLE payment_transactions; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.payment_transactions IS 'Record of all financial transactions (payments, refunds)';


--
-- Name: student_enrollments; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.student_enrollments (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    course_id uuid NOT NULL,
    status text DEFAULT 'pending'::text NOT NULL,
    enrolled_at timestamp with time zone DEFAULT now(),
    starts_at timestamp with time zone,
    expires_at timestamp with time zone,
    completed_at timestamp with time zone,
    dropped_at timestamp with time zone,
    payment_id text,
    payment_amount numeric(10,2),
    payment_type text,
    current_module_id uuid,
    current_topic_id uuid,
    completion_percentage integer DEFAULT 0,
    enrollment_source text,
    notes text,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    is_at_risk boolean DEFAULT false,
    at_risk_since timestamp with time zone,
    risk_level text,
    risk_reasons text[],
    CONSTRAINT student_enrollments_completion_percentage_check CHECK (((completion_percentage >= 0) AND (completion_percentage <= 100))),
    CONSTRAINT student_enrollments_payment_type_check CHECK ((payment_type = ANY (ARRAY['subscription'::text, 'one_time'::text, 'free'::text, 'scholarship'::text]))),
    CONSTRAINT student_enrollments_risk_level_check CHECK ((risk_level = ANY (ARRAY['low'::text, 'medium'::text, 'high'::text]))),
    CONSTRAINT student_enrollments_status_check CHECK ((status = ANY (ARRAY['pending'::text, 'active'::text, 'completed'::text, 'dropped'::text, 'expired'::text]))),
    CONSTRAINT valid_dates CHECK ((((completed_at IS NULL) OR (completed_at >= enrolled_at)) AND ((dropped_at IS NULL) OR (dropped_at >= enrolled_at))))
);


--
-- Name: TABLE student_enrollments; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.student_enrollments IS 'Track student enrollments in courses with payment and progress tracking';


--
-- Name: COLUMN student_enrollments.status; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.student_enrollments.status IS 'Enrollment lifecycle: pending → active → completed/dropped/expired';


--
-- Name: COLUMN student_enrollments.payment_type; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.student_enrollments.payment_type IS 'Payment method: subscription (recurring), one_time (single payment), free (no charge), scholarship (sponsored)';


--
-- Name: COLUMN student_enrollments.is_at_risk; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.student_enrollments.is_at_risk IS 'ACAD-027: Flag indicating if student is at risk of not completing';


--
-- Name: COLUMN student_enrollments.at_risk_since; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.student_enrollments.at_risk_since IS 'ACAD-027: Timestamp when student was flagged as at-risk';


--
-- Name: COLUMN student_enrollments.risk_level; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.student_enrollments.risk_level IS 'ACAD-027: Severity of risk (low, medium, high)';


--
-- Name: COLUMN student_enrollments.risk_reasons; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.student_enrollments.risk_reasons IS 'ACAD-027: Array of reasons why student is at risk';


--
-- Name: course_revenue_analytics; Type: MATERIALIZED VIEW; Schema: public; Owner: -
--

CREATE MATERIALIZED VIEW public.course_revenue_analytics AS
 SELECT c.id AS course_id,
    c.title AS course_title,
    c.slug AS course_slug,
    sum(
        CASE
            WHEN (pt.status = 'succeeded'::text) THEN pt.amount
            ELSE (0)::numeric
        END) AS total_revenue,
    count(DISTINCT se.id) AS total_enrollments,
    count(DISTINCT
        CASE
            WHEN (se.status = 'active'::text) THEN se.id
            ELSE NULL::uuid
        END) AS active_enrollments,
    count(DISTINCT
        CASE
            WHEN (se.status = 'completed'::text) THEN se.id
            ELSE NULL::uuid
        END) AS completed_enrollments,
    avg(
        CASE
            WHEN (pt.status = 'succeeded'::text) THEN pt.amount
            ELSE NULL::numeric
        END) AS avg_revenue_per_enrollment,
    round((((count(DISTINCT
        CASE
            WHEN (se.status = 'completed'::text) THEN se.id
            ELSE NULL::uuid
        END))::numeric / (NULLIF(count(DISTINCT se.id), 0))::numeric) * (100)::numeric), 2) AS completion_rate_percent,
    min(se.enrolled_at) AS first_enrollment_at,
    max(se.enrolled_at) AS last_enrollment_at
   FROM ((public.courses c
     LEFT JOIN public.student_enrollments se ON ((se.course_id = c.id)))
     LEFT JOIN public.payment_transactions pt ON ((pt.enrollment_id = se.id)))
  WHERE (c.deleted_at IS NULL)
  GROUP BY c.id, c.title, c.slug
  WITH NO DATA;


--
-- Name: MATERIALIZED VIEW course_revenue_analytics; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON MATERIALIZED VIEW public.course_revenue_analytics IS 'ACAD-030: Per-course revenue analytics';


--
-- Name: deal_competitors; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.deal_competitors (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    deal_id uuid NOT NULL,
    competitor_name text NOT NULL,
    competitor_website text,
    strengths text,
    weaknesses text,
    our_differentiators text,
    pricing text,
    status text DEFAULT 'active'::text,
    threat_level text,
    notes text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE deal_competitors; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.deal_competitors IS 'Competitive intelligence per deal';


--
-- Name: deal_products; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.deal_products (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    deal_id uuid NOT NULL,
    product_type text NOT NULL,
    product_name text,
    description text,
    quantity integer DEFAULT 1,
    unit_price numeric(12,2),
    total_value numeric(12,2),
    discount numeric(5,2),
    currency text DEFAULT 'USD'::text,
    duration_months integer,
    start_date timestamp with time zone,
    end_date timestamp with time zone,
    notes text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE deal_products; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.deal_products IS 'Products/services included in deals';


--
-- Name: deal_stages_history; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.deal_stages_history (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    deal_id uuid NOT NULL,
    stage text NOT NULL,
    previous_stage text,
    entered_at timestamp with time zone DEFAULT now() NOT NULL,
    exited_at timestamp with time zone,
    duration_days integer,
    notes text,
    reason text,
    changed_by uuid,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE deal_stages_history; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.deal_stages_history IS 'Historical stage transitions for deals';


--
-- Name: deal_stakeholders; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.deal_stakeholders (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    deal_id uuid NOT NULL,
    contact_id uuid,
    name text,
    title text,
    email text,
    role text NOT NULL,
    influence_level text,
    sentiment text,
    engagement_notes text,
    is_active boolean DEFAULT true,
    is_primary boolean DEFAULT false,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE deal_stakeholders; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.deal_stakeholders IS 'Decision makers and influencers on deals';


--
-- Name: deals; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.deals (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    lead_id uuid,
    account_id uuid,
    title text NOT NULL,
    description text,
    value numeric(12,2) NOT NULL,
    stage text DEFAULT 'discovery'::text NOT NULL,
    probability integer,
    expected_close_date date,
    actual_close_date date,
    owner_id uuid NOT NULL,
    close_reason text,
    linked_job_ids uuid[],
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid,
    deleted_at timestamp with time zone,
    name text,
    deal_type text,
    currency text DEFAULT 'USD'::text,
    loss_reason text,
    competitor_won text,
    notes text,
    value_basis text DEFAULT 'one_time'::text,
    weighted_value numeric(12,2) GENERATED ALWAYS AS (((value * (probability)::numeric) / 100.0)) STORED,
    estimated_placements integer,
    avg_bill_rate numeric(10,2),
    contract_length_months integer,
    hiring_needs text,
    roles_breakdown jsonb,
    services_required text[],
    competitors text[],
    competitive_advantage text,
    pod_manager_id uuid,
    secondary_owner_id uuid,
    next_action text,
    next_action_date date,
    health_status text DEFAULT 'on_track'::text,
    last_activity_at timestamp with time zone DEFAULT now(),
    contract_signed_date date,
    contract_start_date date,
    contract_duration_months integer,
    contract_type text,
    payment_terms text,
    billing_frequency text,
    billing_contact jsonb,
    confirmed_roles jsonb,
    win_reason text,
    win_details text,
    competitors_beat text[],
    loss_reason_category text,
    loss_details text,
    competitor_price numeric(10,2),
    future_potential text,
    reengagement_date date,
    lessons_learned text,
    created_account_id uuid,
    company_id uuid,
    CONSTRAINT deals_billing_frequency_check CHECK ((billing_frequency = ANY (ARRAY['weekly'::text, 'biweekly'::text, 'monthly'::text]))),
    CONSTRAINT deals_contract_type_check CHECK ((contract_type = ANY (ARRAY['msa'::text, 'sow'::text, 'po'::text, 'email'::text]))),
    CONSTRAINT deals_future_potential_check CHECK ((future_potential = ANY (ARRAY['yes'::text, 'maybe'::text, 'no'::text]))),
    CONSTRAINT deals_health_status_check CHECK ((health_status = ANY (ARRAY['on_track'::text, 'slow'::text, 'stale'::text, 'urgent'::text, 'at_risk'::text]))),
    CONSTRAINT deals_loss_reason_category_check CHECK ((loss_reason_category = ANY (ARRAY['competitor'::text, 'no_budget'::text, 'project_cancelled'::text, 'hired_internally'::text, 'went_dark'::text, 'price_too_high'::text, 'requirements_changed'::text, 'other'::text]))),
    CONSTRAINT deals_payment_terms_check CHECK ((payment_terms = ANY (ARRAY['net_15'::text, 'net_30'::text, 'net_45'::text, 'net_60'::text]))),
    CONSTRAINT deals_probability_check CHECK (((probability >= 0) AND (probability <= 100))),
    CONSTRAINT deals_value_basis_check CHECK ((value_basis = ANY (ARRAY['one_time'::text, 'annual'::text, 'monthly'::text]))),
    CONSTRAINT deals_win_reason_check CHECK ((win_reason = ANY (ARRAY['price_value'::text, 'expertise_speed'::text, 'relationship_trust'::text, 'candidate_quality'::text, 'response_time'::text, 'other'::text])))
);


--
-- Name: TABLE deals; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.deals IS 'Revenue opportunities and closed business';


--
-- Name: COLUMN deals.stage; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.deals.stage IS 'Valid values: discovery, qualification, proposal, negotiation, verbal_commit, closed_won, closed_lost. Stage probabilities: discovery=20%, qualification=40%, proposal=60%, negotiation=70%, verbal_commit=90%, closed_won=100%, closed_lost=0%';


--
-- Name: COLUMN deals.value_basis; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.deals.value_basis IS 'How deal value is calculated: one_time, annual, or monthly';


--
-- Name: COLUMN deals.weighted_value; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.deals.weighted_value IS 'Auto-calculated: value * probability / 100';


--
-- Name: COLUMN deals.health_status; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.deals.health_status IS 'Deal pipeline health: on_track (active), slow (7-14d stale), stale (>14d), urgent (close <14d), at_risk (manual)';


--
-- Name: COLUMN deals.company_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.deals.company_id IS 'FK to companies table (replaces account_id)';


--
-- Name: discount_code_usage; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.discount_code_usage (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    discount_code_id uuid NOT NULL,
    user_id uuid NOT NULL,
    enrollment_id uuid,
    original_amount numeric(10,2) NOT NULL,
    discount_amount numeric(10,2) NOT NULL,
    final_amount numeric(10,2) NOT NULL,
    stripe_payment_intent_id text,
    used_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE discount_code_usage; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.discount_code_usage IS 'ACAD-029: Tracking of discount code usage by users';


--
-- Name: discount_codes; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.discount_codes (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    code text NOT NULL,
    name text NOT NULL,
    description text,
    discount_type text NOT NULL,
    discount_value numeric(10,2) NOT NULL,
    max_uses integer,
    uses_count integer DEFAULT 0,
    max_uses_per_user integer DEFAULT 1,
    valid_from timestamp with time zone DEFAULT now(),
    valid_until timestamp with time zone,
    applicable_plan_types text[],
    applicable_course_ids uuid[],
    minimum_purchase_amount numeric(10,2),
    stripe_coupon_id text,
    stripe_promotion_code_id text,
    is_active boolean DEFAULT true,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    created_by uuid,
    deleted_at timestamp with time zone,
    CONSTRAINT discount_codes_discount_type_check CHECK ((discount_type = ANY (ARRAY['percentage'::text, 'fixed'::text]))),
    CONSTRAINT discount_codes_discount_value_check CHECK ((discount_value > (0)::numeric)),
    CONSTRAINT discount_codes_uses_count_check CHECK ((uses_count >= 0))
);


--
-- Name: TABLE discount_codes; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.discount_codes IS 'ACAD-029: Discount codes for promotions and special offers';


--
-- Name: discount_effectiveness_analytics; Type: MATERIALIZED VIEW; Schema: public; Owner: -
--

CREATE MATERIALIZED VIEW public.discount_effectiveness_analytics AS
 SELECT dc.id AS discount_code_id,
    dc.code AS discount_code,
    dc.name AS discount_name,
    dc.discount_type,
    dc.discount_value,
    count(dcu.id) AS total_uses,
    dc.max_uses AS max_uses_limit,
    sum(dcu.original_amount) AS total_original_amount,
    sum(dcu.discount_amount) AS total_discount_given,
    sum(dcu.final_amount) AS total_revenue_generated,
    avg(dcu.discount_amount) AS avg_discount_per_use,
    round((sum(dcu.final_amount) / NULLIF(sum(dcu.discount_amount), (0)::numeric)), 2) AS roi_ratio,
    min(dcu.used_at) AS first_used_at,
    max(dcu.used_at) AS last_used_at,
    dc.is_active,
    dc.valid_from,
    dc.valid_until
   FROM (public.discount_codes dc
     LEFT JOIN public.discount_code_usage dcu ON ((dcu.discount_code_id = dc.id)))
  WHERE (dc.deleted_at IS NULL)
  GROUP BY dc.id, dc.code, dc.name, dc.discount_type, dc.discount_value, dc.max_uses, dc.is_active, dc.valid_from, dc.valid_until
  WITH NO DATA;


--
-- Name: MATERIALIZED VIEW discount_effectiveness_analytics; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON MATERIALIZED VIEW public.discount_effectiveness_analytics IS 'ACAD-030: Discount code ROI analytics';


--
-- Name: document_templates; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.document_templates (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    name text NOT NULL,
    description text,
    template_type text NOT NULL,
    category text NOT NULL,
    template_content text NOT NULL,
    variables jsonb DEFAULT '{}'::jsonb NOT NULL,
    sample_data jsonb DEFAULT '{}'::jsonb,
    is_active boolean DEFAULT true NOT NULL,
    created_by uuid NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone,
    CONSTRAINT valid_template_type CHECK ((template_type = ANY (ARRAY['pdf'::text, 'docx'::text, 'html'::text])))
);


--
-- Name: TABLE document_templates; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.document_templates IS 'Document templates for PDF/DOCX generation';


--
-- Name: COLUMN document_templates.template_content; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.document_templates.template_content IS 'Handlebars template (HTML for PDF, custom for DOCX)';


--
-- Name: COLUMN document_templates.variables; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.document_templates.variables IS 'Expected variables: {"studentName": {"type": "string", "required": true}}';


--
-- Name: duplicate_records; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.duplicate_records (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    entity_type character varying(50) NOT NULL,
    record_id_1 uuid NOT NULL,
    record_id_2 uuid NOT NULL,
    confidence_score numeric(5,4) NOT NULL,
    match_fields text[] NOT NULL,
    match_details jsonb DEFAULT '{}'::jsonb,
    status character varying(20) DEFAULT 'pending'::character varying NOT NULL,
    merged_into_id uuid,
    dismissed_reason text,
    detected_at timestamp with time zone DEFAULT now() NOT NULL,
    reviewed_by uuid,
    reviewed_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT ordered_record_ids CHECK ((record_id_1 < record_id_2))
);


--
-- Name: TABLE duplicate_records; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.duplicate_records IS 'Tracks potential duplicate records for review and merge';


--
-- Name: COLUMN duplicate_records.status; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.duplicate_records.status IS 'pending, merged, dismissed, auto_merged';


--
-- Name: duplicate_rules; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.duplicate_rules (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    entity_type character varying(50) NOT NULL,
    rule_name character varying(100) NOT NULL,
    is_active boolean DEFAULT true,
    match_fields text[] NOT NULL,
    match_type character varying(20) DEFAULT 'exact'::character varying NOT NULL,
    fuzzy_threshold numeric(3,2) DEFAULT 0.85,
    auto_merge_threshold numeric(5,4),
    auto_merge_enabled boolean DEFAULT false,
    created_by uuid NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE duplicate_rules; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.duplicate_rules IS 'Configurable rules for duplicate detection per entity type';


--
-- Name: COLUMN duplicate_rules.match_type; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.duplicate_rules.match_type IS 'exact, fuzzy, phonetic';


--
-- Name: email_logs; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.email_logs (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    template_id uuid,
    to_email text NOT NULL,
    cc_email text[],
    bcc_email text[],
    subject text NOT NULL,
    status text DEFAULT 'pending'::text NOT NULL,
    resend_id text,
    error_message text,
    sent_at timestamp with time zone,
    opened_at timestamp with time zone,
    clicked_at timestamp with time zone,
    metadata jsonb DEFAULT '{}'::jsonb NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT valid_email_status CHECK ((status = ANY (ARRAY['pending'::text, 'sent'::text, 'failed'::text, 'bounced'::text, 'opened'::text, 'clicked'::text])))
);


--
-- Name: TABLE email_logs; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.email_logs IS 'Log of all emails sent (for tracking and compliance)';


--
-- Name: email_senders; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.email_senders (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    email text NOT NULL,
    name text NOT NULL,
    is_default boolean DEFAULT false,
    is_verified boolean DEFAULT false,
    verified_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid,
    deleted_at timestamp with time zone
);


--
-- Name: TABLE email_senders; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.email_senders IS 'Verified sender email addresses for an organization';


--
-- Name: email_sends; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.email_sends (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    template_id uuid,
    recipient_email text NOT NULL,
    recipient_name text,
    subject text NOT NULL,
    from_email text NOT NULL,
    from_name text,
    status text DEFAULT 'queued'::text NOT NULL,
    resend_id text,
    variables_data jsonb,
    sent_at timestamp with time zone,
    delivered_at timestamp with time zone,
    opened_at timestamp with time zone,
    clicked_at timestamp with time zone,
    bounced_at timestamp with time zone,
    error_message text,
    entity_type text,
    entity_id uuid,
    triggered_by text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid,
    CONSTRAINT email_sends_status_check CHECK ((status = ANY (ARRAY['queued'::text, 'sent'::text, 'delivered'::text, 'opened'::text, 'clicked'::text, 'bounced'::text, 'failed'::text, 'spam'::text]))),
    CONSTRAINT email_sends_triggered_by_check CHECK ((triggered_by = ANY (ARRAY['workflow'::text, 'manual'::text, 'system'::text, 'test'::text])))
);


--
-- Name: TABLE email_sends; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.email_sends IS 'Log of all emails sent through the system';


--
-- Name: COLUMN email_sends.triggered_by; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.email_sends.triggered_by IS 'What triggered this email: workflow, manual, system, test';


--
-- Name: email_templates; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.email_templates (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    name text NOT NULL,
    subject text NOT NULL,
    body_html text NOT NULL,
    body_text text,
    category text NOT NULL,
    variables jsonb DEFAULT '{}'::jsonb NOT NULL,
    is_active boolean DEFAULT true NOT NULL,
    created_by uuid NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone,
    slug text NOT NULL,
    preview_text text,
    from_name text DEFAULT '{{company_name}}'::text NOT NULL,
    from_email text DEFAULT 'noreply@{{company_domain}}'::text NOT NULL,
    reply_to text,
    variables_used text[] DEFAULT '{}'::text[],
    notes text,
    status text DEFAULT 'draft'::text NOT NULL,
    version integer DEFAULT 1 NOT NULL,
    updated_by uuid,
    archived_at timestamp with time zone,
    CONSTRAINT email_templates_category_check CHECK ((category = ANY (ARRAY['user'::text, 'candidate'::text, 'client'::text, 'internal'::text, 'system'::text, 'marketing'::text]))),
    CONSTRAINT email_templates_status_check CHECK ((status = ANY (ARRAY['draft'::text, 'active'::text, 'disabled'::text, 'archived'::text])))
);


--
-- Name: TABLE email_templates; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.email_templates IS 'Email templates for notifications and communications';


--
-- Name: COLUMN email_templates.category; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.email_templates.category IS 'Template category: user, candidate, client, internal, system, marketing';


--
-- Name: COLUMN email_templates.variables_used; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.email_templates.variables_used IS 'Array of variable names used in the template';


--
-- Name: COLUMN email_templates.status; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.email_templates.status IS 'Template status: draft, active, disabled, archived';


--
-- Name: emergency_drills; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.emergency_drills (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    drill_type text NOT NULL,
    title text NOT NULL,
    scenario text NOT NULL,
    participants uuid[] DEFAULT '{}'::uuid[],
    scheduled_at timestamp with time zone NOT NULL,
    started_at timestamp with time zone,
    completed_at timestamp with time zone,
    status text DEFAULT 'scheduled'::text,
    findings text,
    action_items jsonb DEFAULT '[]'::jsonb,
    created_by uuid,
    updated_by uuid,
    metadata jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT emergency_drills_drill_type_check CHECK ((drill_type = ANY (ARRAY['tabletop'::text, 'simulated_outage'::text, 'security_breach'::text, 'backup_restore'::text]))),
    CONSTRAINT emergency_drills_status_check CHECK ((status = ANY (ARRAY['scheduled'::text, 'in_progress'::text, 'completed'::text, 'cancelled'::text])))
);


--
-- Name: TABLE emergency_drills; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.emergency_drills IS 'Scheduled emergency drill tracking';


--
-- Name: employees; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.employees (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    user_id uuid NOT NULL,
    employee_number text,
    status public.employment_status DEFAULT 'onboarding'::public.employment_status NOT NULL,
    employment_type public.employment_type DEFAULT 'fte'::public.employment_type NOT NULL,
    hire_date date NOT NULL,
    termination_date date,
    termination_reason text,
    department text,
    job_title text,
    manager_id uuid,
    location text,
    work_mode public.work_mode DEFAULT 'on_site'::public.work_mode,
    salary_type public.salary_type DEFAULT 'annual'::public.salary_type NOT NULL,
    salary_amount numeric(12,2),
    currency text DEFAULT 'USD'::text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid,
    updated_by uuid,
    deleted_at timestamp with time zone
);


--
-- Name: employee_addresses_view; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.employee_addresses_view AS
 SELECT e.id AS employee_id,
    e.org_id,
    up.full_name AS employee_name,
    up.email,
    addr.id AS address_id,
    addr.address_type,
    addr.address_line_1,
    addr.city,
    addr.state_province,
    addr.postal_code,
    addr.country_code,
    addr.is_primary,
    addr.created_at,
    addr.updated_at
   FROM ((public.employees e
     LEFT JOIN public.user_profiles up ON ((up.id = e.user_id)))
     LEFT JOIN public.addresses addr ON (((addr.entity_type = 'employee'::text) AND (addr.entity_id = e.id))))
  WHERE (e.deleted_at IS NULL);


--
-- Name: VIEW employee_addresses_view; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.employee_addresses_view IS 'View for accessing employee addresses';


--
-- Name: employee_benefits; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.employee_benefits (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    employee_id uuid NOT NULL,
    plan_option_id uuid NOT NULL,
    status public.benefit_status DEFAULT 'pending'::public.benefit_status NOT NULL,
    enrollment_date date,
    coverage_start date,
    coverage_end date,
    dependents_count integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid
);


--
-- Name: employee_compliance; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.employee_compliance (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    employee_id uuid NOT NULL,
    requirement_id uuid NOT NULL,
    status public.compliance_status DEFAULT 'pending'::public.compliance_status NOT NULL,
    due_date date,
    completed_at timestamp with time zone,
    document_url text,
    notes text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: employee_documents; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.employee_documents (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    employee_id uuid NOT NULL,
    document_type public.document_type NOT NULL,
    file_name text NOT NULL,
    file_url text NOT NULL,
    issue_date date,
    expiry_date date,
    status public.document_status DEFAULT 'pending'::public.document_status NOT NULL,
    verified_by uuid,
    verified_at timestamp with time zone,
    notes text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid
);


--
-- Name: employee_metadata; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.employee_metadata (
    user_id uuid NOT NULL,
    employment_type text DEFAULT 'full_time'::text,
    employee_id_number text,
    bonus_target numeric(12,2),
    commission_plan text,
    equity_shares integer,
    pod_id uuid,
    pod_role text,
    kpi_targets jsonb,
    monthly_placement_target integer,
    work_schedule text DEFAULT 'standard'::text,
    weekly_hours integer DEFAULT 40,
    benefits_eligible boolean DEFAULT true,
    benefits_start_date date,
    emergency_contact_name text,
    emergency_contact_phone text,
    emergency_contact_relationship text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE employee_metadata; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.employee_metadata IS 'Extended metadata for employees';


--
-- Name: employee_onboarding; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.employee_onboarding (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    employee_id uuid NOT NULL,
    checklist_template_id uuid,
    status public.onboarding_status DEFAULT 'not_started'::public.onboarding_status NOT NULL,
    started_at timestamp with time zone,
    completed_at timestamp with time zone,
    assigned_to uuid,
    notes text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid
);


--
-- Name: employee_profiles; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.employee_profiles (
    employee_id uuid NOT NULL,
    date_of_birth date,
    ssn_encrypted text,
    address_street text,
    address_city text,
    address_state text,
    address_country text DEFAULT 'USA'::text,
    address_postal text,
    emergency_contact_name text,
    emergency_contact_phone text,
    emergency_contact_relationship text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: employee_screenshots; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.employee_screenshots (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    filename text NOT NULL,
    file_size integer NOT NULL,
    storage_bucket text DEFAULT 'employee-screenshots'::text,
    captured_at timestamp with time zone NOT NULL,
    machine_name text,
    os_type text,
    active_window_title text,
    analyzed boolean DEFAULT false,
    activity_category text,
    confidence double precision,
    analyzed_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    deleted_at timestamp with time zone
);


--
-- Name: TABLE employee_screenshots; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.employee_screenshots IS 'Employee productivity screenshots for audit and compliance (mandatory background service)';


--
-- Name: COLUMN employee_screenshots.filename; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.employee_screenshots.filename IS 'Path in Supabase Storage bucket';


--
-- Name: COLUMN employee_screenshots.machine_name; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.employee_screenshots.machine_name IS 'Hostname of the machine where screenshot was captured';


--
-- Name: COLUMN employee_screenshots.active_window_title; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.employee_screenshots.active_window_title IS 'Title of active window at capture time (for context)';


--
-- Name: COLUMN employee_screenshots.analyzed; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.employee_screenshots.analyzed IS 'Whether AI has classified this screenshot';


--
-- Name: COLUMN employee_screenshots.activity_category; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.employee_screenshots.activity_category IS 'AI-classified activity type';


--
-- Name: COLUMN employee_screenshots.confidence; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.employee_screenshots.confidence IS 'AI confidence score (0-100)';


--
-- Name: COLUMN employee_screenshots.deleted_at; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.employee_screenshots.deleted_at IS 'Soft delete timestamp for audit trail (90-day retention)';


--
-- Name: employee_time_off; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.employee_time_off (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    employee_id uuid NOT NULL,
    type public.time_off_type NOT NULL,
    status public.time_off_status DEFAULT 'pending'::public.time_off_status NOT NULL,
    start_date date NOT NULL,
    end_date date NOT NULL,
    hours numeric(5,2) NOT NULL,
    reason text,
    approved_by uuid,
    approved_at timestamp with time zone,
    denial_reason text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid
);


--
-- Name: employee_twin_interactions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.employee_twin_interactions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    user_id uuid NOT NULL,
    twin_role text NOT NULL,
    interaction_type text NOT NULL,
    prompt text,
    response text NOT NULL,
    context jsonb DEFAULT '{}'::jsonb,
    model_used text DEFAULT 'gpt-4o-mini'::text,
    tokens_used integer,
    cost_usd double precision,
    latency_ms integer,
    was_helpful boolean,
    user_feedback text,
    dismissed boolean DEFAULT false,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT employee_twin_interactions_interaction_type_check CHECK ((interaction_type = ANY (ARRAY['morning_briefing'::text, 'suggestion'::text, 'question'::text]))),
    CONSTRAINT employee_twin_interactions_twin_role_check CHECK ((twin_role = ANY (ARRAY['ceo'::text, 'admin'::text, 'recruiter'::text, 'bench_sales'::text, 'talent_acquisition'::text, 'hr'::text, 'immigration'::text, 'trainer'::text])))
);


--
-- Name: TABLE employee_twin_interactions; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.employee_twin_interactions IS 'Tracks all Employee AI Twin interactions';


--
-- Name: engagement_tracking; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.engagement_tracking (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    campaign_contact_id uuid NOT NULL,
    event_type text NOT NULL,
    event_data jsonb,
    event_timestamp timestamp with time zone DEFAULT now() NOT NULL,
    tracking_id text,
    user_agent text,
    ip_address inet,
    clicked_url text,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE engagement_tracking; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.engagement_tracking IS 'Email/LinkedIn engagement events (opens, clicks, responses)';


--
-- Name: escalation_daily_stats; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.escalation_daily_stats AS
 SELECT date(created_at) AS date,
    count(*) AS total_escalations,
    count(DISTINCT user_id) AS unique_students,
    count(*) FILTER (WHERE (auto_detected = true)) AS auto_detected_count,
    count(*) FILTER (WHERE (auto_detected = false)) AS manual_count,
    avg(confidence) AS avg_confidence,
    count(*) FILTER (WHERE (status = 'resolved'::text)) AS resolved_count,
    count(*) FILTER (WHERE (status = 'dismissed'::text)) AS dismissed_count,
    avg(resolution_time_minutes) FILTER (WHERE (resolution_time_minutes IS NOT NULL)) AS avg_resolution_time_minutes
   FROM public.ai_mentor_escalations
  GROUP BY (date(created_at))
  ORDER BY (date(created_at)) DESC;


--
-- Name: VIEW escalation_daily_stats; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.escalation_daily_stats IS 'Daily aggregated escalation statistics';


--
-- Name: escalation_notifications; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.escalation_notifications (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    escalation_id uuid NOT NULL,
    notification_type text NOT NULL,
    recipient_id uuid,
    recipient_email text,
    recipient_slack_id text,
    sent_at timestamp with time zone,
    delivered_at timestamp with time zone,
    error_message text,
    created_at timestamp with time zone DEFAULT now(),
    CONSTRAINT escalation_notifications_notification_type_check CHECK ((notification_type = ANY (ARRAY['slack'::text, 'email'::text, 'in_app'::text])))
);


--
-- Name: TABLE escalation_notifications; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.escalation_notifications IS 'Notification delivery tracking for escalations';


--
-- Name: escalation_number_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.escalation_number_seq
    START WITH 1000
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: trainer_responses; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.trainer_responses (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    escalation_id uuid NOT NULL,
    trainer_id uuid NOT NULL,
    message text NOT NULL,
    is_internal_note boolean DEFAULT false,
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE trainer_responses; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.trainer_responses IS 'Trainer responses to student escalations';


--
-- Name: escalation_queue; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.escalation_queue AS
 SELECT e.id AS escalation_id,
    e.chat_id,
    e.user_id,
    u.full_name AS student_name,
    u.email AS student_email,
    e.topic_id,
    mt.title AS topic_title,
    e.reason,
    e.confidence,
    e.auto_detected,
    e.triggers,
    e.metadata,
    e.status,
    e.assigned_to,
    trainer.full_name AS assigned_trainer_name,
    e.created_at,
    (EXTRACT(epoch FROM (now() - e.created_at)) / (60)::numeric) AS wait_time_minutes,
    c.question AS original_question,
    ( SELECT count(*) AS count
           FROM public.trainer_responses
          WHERE (trainer_responses.escalation_id = e.id)) AS response_count
   FROM ((((public.ai_mentor_escalations e
     JOIN public.user_profiles u ON ((u.id = e.user_id)))
     LEFT JOIN public.module_topics mt ON ((mt.id = e.topic_id)))
     LEFT JOIN public.user_profiles trainer ON ((trainer.id = e.assigned_to)))
     LEFT JOIN public.ai_mentor_chats c ON ((c.id = e.chat_id)))
  WHERE (e.status = ANY (ARRAY['pending'::text, 'in_progress'::text]))
  ORDER BY e.created_at;


--
-- Name: VIEW escalation_queue; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.escalation_queue IS 'Real-time queue of pending/in-progress escalations for trainers';


--
-- Name: escalation_updates; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.escalation_updates (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    escalation_id uuid NOT NULL,
    update_type text NOT NULL,
    content text NOT NULL,
    old_status text,
    new_status text,
    old_assignee_id uuid,
    new_assignee_id uuid,
    created_by uuid NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    is_internal boolean DEFAULT true
);


--
-- Name: TABLE escalation_updates; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.escalation_updates IS 'Timeline of updates for escalations';


--
-- Name: escalations; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.escalations (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    escalation_number text NOT NULL,
    account_id uuid NOT NULL,
    escalation_type text NOT NULL,
    severity text DEFAULT 'medium'::text NOT NULL,
    issue_summary text NOT NULL,
    detailed_description text NOT NULL,
    related_entities jsonb DEFAULT '[]'::jsonb,
    client_impact text[],
    root_cause text,
    immediate_actions text,
    resolution_plan text,
    status text DEFAULT 'open'::text NOT NULL,
    sla_response_due timestamp with time zone,
    sla_resolution_due timestamp with time zone,
    sla_response_met boolean,
    sla_resolution_met boolean,
    created_by uuid NOT NULL,
    assigned_to uuid,
    escalated_to uuid,
    resolved_by uuid,
    resolved_at timestamp with time zone,
    resolution_summary text,
    resolution_actions text,
    time_to_resolve interval,
    client_satisfaction text,
    lessons_learned text,
    preventive_measures text,
    manager_notification_type text,
    manager_notified_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone
);


--
-- Name: TABLE escalations; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.escalations IS 'Tracks client escalations and issues (C06)';


--
-- Name: COLUMN escalations.escalation_number; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.escalations.escalation_number IS 'Human-readable ID like ESC-1001';


--
-- Name: COLUMN escalations.severity; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.escalations.severity IS 'Severity level affecting SLA: low, medium, high, critical';


--
-- Name: event_delivery_log; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.event_delivery_log (
    id uuid DEFAULT extensions.uuid_generate_v4() NOT NULL,
    event_id uuid NOT NULL,
    subscription_id uuid NOT NULL,
    attempted_at timestamp with time zone DEFAULT now() NOT NULL,
    status text NOT NULL,
    response_code integer,
    response_body text,
    error_message text,
    duration_ms integer,
    org_id uuid NOT NULL,
    CONSTRAINT valid_delivery_status CHECK ((status = ANY (ARRAY['success'::text, 'failure'::text, 'timeout'::text, 'skipped'::text])))
);


--
-- Name: TABLE event_delivery_log; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.event_delivery_log IS 'Delivery attempts log for debugging and monitoring event processing.';


--
-- Name: COLUMN event_delivery_log.org_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.event_delivery_log.org_id IS 'Organization this delivery log belongs to';


--
-- Name: event_subscriptions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.event_subscriptions (
    id uuid DEFAULT extensions.uuid_generate_v4() NOT NULL,
    subscriber_name text NOT NULL,
    event_pattern text NOT NULL,
    handler_function text,
    webhook_url text,
    is_active boolean DEFAULT true,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    last_triggered_at timestamp with time zone,
    org_id uuid NOT NULL,
    failure_count integer DEFAULT 0,
    consecutive_failures integer DEFAULT 0,
    last_failure_at timestamp with time zone,
    last_failure_message text,
    auto_disabled_at timestamp with time zone,
    user_id uuid,
    channel text DEFAULT 'email'::text NOT NULL,
    frequency text DEFAULT 'immediate'::text,
    digest boolean DEFAULT false,
    filter_criteria jsonb DEFAULT '{}'::jsonb,
    CONSTRAINT valid_handler CHECK (((handler_function IS NOT NULL) OR (webhook_url IS NOT NULL)))
);


--
-- Name: TABLE event_subscriptions; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.event_subscriptions IS 'Subscribers listening to event patterns. Supports both PostgreSQL functions and HTTP webhooks.';


--
-- Name: COLUMN event_subscriptions.org_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.event_subscriptions.org_id IS 'Organization this subscription belongs to';


--
-- Name: COLUMN event_subscriptions.failure_count; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.event_subscriptions.failure_count IS 'Total number of failures';


--
-- Name: COLUMN event_subscriptions.consecutive_failures; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.event_subscriptions.consecutive_failures IS 'Number of consecutive failures (resets on success)';


--
-- Name: export_jobs; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.export_jobs (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    entity_type character varying(50) NOT NULL,
    export_name character varying(255),
    filters jsonb DEFAULT '{}'::jsonb,
    columns text[] NOT NULL,
    format character varying(20) DEFAULT 'csv'::character varying NOT NULL,
    include_headers boolean DEFAULT true,
    is_scheduled boolean DEFAULT false,
    schedule_cron character varying(100),
    schedule_name character varying(255),
    last_run_at timestamp with time zone,
    next_run_at timestamp with time zone,
    file_path text,
    file_size_bytes integer,
    record_count integer,
    status character varying(20) DEFAULT 'pending'::character varying NOT NULL,
    error_message text,
    started_at timestamp with time zone,
    completed_at timestamp with time zone,
    expires_at timestamp with time zone,
    created_by uuid NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE export_jobs; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.export_jobs IS 'Tracks data export operations';


--
-- Name: COLUMN export_jobs.format; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.export_jobs.format IS 'csv, excel, json';


--
-- Name: COLUMN export_jobs.status; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.export_jobs.status IS 'pending, processing, completed, failed, cancelled';


--
-- Name: external_job_order_notes; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.external_job_order_notes (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    order_id uuid NOT NULL,
    note text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid
);


--
-- Name: TABLE external_job_order_notes; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.external_job_order_notes IS 'Notes on external job orders';


--
-- Name: external_job_order_requirements; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.external_job_order_requirements (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    order_id uuid NOT NULL,
    requirement text NOT NULL,
    type text NOT NULL,
    priority integer DEFAULT 1,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE external_job_order_requirements; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.external_job_order_requirements IS 'Requirements for external job orders';


--
-- Name: external_job_order_skills; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.external_job_order_skills (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    order_id uuid NOT NULL,
    skill_name text NOT NULL,
    years_required numeric(4,1),
    proficiency_required integer,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT job_order_skills_proficiency_required_check CHECK (((proficiency_required >= 1) AND (proficiency_required <= 5)))
);


--
-- Name: TABLE external_job_order_skills; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.external_job_order_skills IS 'Skills required for external job orders';


--
-- Name: external_job_order_submissions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.external_job_order_submissions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    order_id uuid NOT NULL,
    consultant_id uuid NOT NULL,
    status text DEFAULT 'submitted'::text NOT NULL,
    submitted_rate numeric(10,2),
    submitted_at timestamp with time zone DEFAULT now() NOT NULL,
    client_response_at timestamp with time zone,
    notes text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid
);


--
-- Name: TABLE external_job_order_submissions; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.external_job_order_submissions IS 'Submissions to external job orders from bench consultants';


--
-- Name: external_job_orders; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.external_job_orders (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    vendor_id uuid,
    client_name text,
    title text NOT NULL,
    description text,
    location text,
    work_mode text,
    rate_type text DEFAULT 'hourly'::text,
    bill_rate numeric(10,2),
    duration_months integer,
    positions integer DEFAULT 1,
    status public.job_order_status DEFAULT 'new'::public.job_order_status NOT NULL,
    priority public.job_order_priority DEFAULT 'medium'::public.job_order_priority,
    received_at timestamp with time zone DEFAULT now() NOT NULL,
    response_due_at timestamp with time zone,
    source public.job_order_source DEFAULT 'email'::public.job_order_source,
    original_source_url text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid,
    deleted_at timestamp with time zone,
    vendor_company_id uuid
);


--
-- Name: TABLE external_job_orders; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.external_job_orders IS 'External job orders from vendors (bench sales module). NOT the same as workspace.job_orders which are confirmed client orders.';


--
-- Name: COLUMN external_job_orders.vendor_company_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.external_job_orders.vendor_company_id IS 'FK to companies table (replaces vendor_id)';


--
-- Name: feature_flag_categories; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.feature_flag_categories (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid,
    name text NOT NULL,
    display_order integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT now()
);


--
-- Name: feature_flag_feedback; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.feature_flag_feedback (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    feature_flag_id uuid NOT NULL,
    user_id uuid NOT NULL,
    rating integer,
    feedback_text text,
    submitted_at timestamp with time zone DEFAULT now(),
    CONSTRAINT feature_flag_feedback_rating_check CHECK (((rating >= 1) AND (rating <= 5)))
);


--
-- Name: feature_flag_roles; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.feature_flag_roles (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    feature_flag_id uuid NOT NULL,
    role_id uuid NOT NULL,
    enabled boolean DEFAULT true,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: feature_flag_usage; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.feature_flag_usage (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    feature_flag_id uuid NOT NULL,
    user_id uuid NOT NULL,
    session_id text,
    checked_at timestamp with time zone DEFAULT now(),
    was_enabled boolean NOT NULL,
    context jsonb DEFAULT '{}'::jsonb
);


--
-- Name: feature_flags; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.feature_flags (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid,
    key character varying(100) NOT NULL,
    name character varying(100) NOT NULL,
    description text,
    default_enabled boolean DEFAULT false,
    is_global boolean DEFAULT false,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone,
    state text DEFAULT 'disabled'::text NOT NULL,
    rollout_strategy text DEFAULT 'none'::text NOT NULL,
    rollout_percentage integer DEFAULT 0,
    enabled_users uuid[] DEFAULT '{}'::uuid[],
    enabled_pods uuid[] DEFAULT '{}'::uuid[],
    enabled_roles uuid[] DEFAULT '{}'::uuid[],
    category text,
    show_in_nav boolean DEFAULT true,
    show_new_badge boolean DEFAULT false,
    show_beta_badge boolean DEFAULT false,
    log_usage boolean DEFAULT true,
    show_feedback_prompt boolean DEFAULT false,
    rollout_schedule jsonb DEFAULT '[]'::jsonb,
    safeguards jsonb DEFAULT '{}'::jsonb,
    metadata jsonb DEFAULT '{}'::jsonb,
    created_by uuid,
    updated_by uuid,
    CONSTRAINT feature_flags_rollout_percentage_check CHECK (((rollout_percentage >= 0) AND (rollout_percentage <= 100))),
    CONSTRAINT feature_flags_rollout_strategy_check CHECK ((rollout_strategy = ANY (ARRAY['all'::text, 'roles'::text, 'users'::text, 'percentage'::text, 'pods'::text, 'none'::text]))),
    CONSTRAINT feature_flags_state_check CHECK ((state = ANY (ARRAY['enabled'::text, 'disabled'::text, 'beta'::text, 'internal'::text, 'percentage'::text, 'coming_soon'::text])))
);


--
-- Name: file_uploads; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.file_uploads (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    bucket text NOT NULL,
    file_path text NOT NULL,
    file_name text NOT NULL,
    file_size integer NOT NULL,
    mime_type text NOT NULL,
    entity_type text,
    entity_id uuid,
    uploaded_by uuid NOT NULL,
    uploaded_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone,
    metadata jsonb DEFAULT '{}'::jsonb NOT NULL,
    CONSTRAINT valid_bucket CHECK ((bucket = ANY (ARRAY['avatars'::text, 'resumes'::text, 'documents'::text, 'attachments'::text, 'course-materials'::text])))
);


--
-- Name: TABLE file_uploads; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.file_uploads IS 'Metadata for all uploaded files (files stored in Supabase Storage)';


--
-- Name: COLUMN file_uploads.bucket; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.file_uploads.bucket IS 'Supabase Storage bucket name';


--
-- Name: COLUMN file_uploads.file_path; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.file_uploads.file_path IS 'Full path in Supabase Storage';


--
-- Name: gdpr_requests; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.gdpr_requests (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    request_number character varying(50) NOT NULL,
    request_type character varying(30) NOT NULL,
    subject_email character varying(255) NOT NULL,
    subject_name character varying(255),
    subject_phone character varying(50),
    verification_method character varying(50),
    verified_at timestamp with time zone,
    data_found jsonb DEFAULT '{}'::jsonb,
    tables_scanned text[],
    total_records_found integer DEFAULT 0,
    status character varying(20) DEFAULT 'pending'::character varying NOT NULL,
    action_taken character varying(50),
    export_file_path text,
    anonymized_fields jsonb DEFAULT '[]'::jsonb,
    notes text,
    due_date date NOT NULL,
    compliance_notes text,
    processed_by uuid,
    processed_at timestamp with time zone,
    created_by uuid NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE gdpr_requests; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.gdpr_requests IS 'Tracks GDPR data subject requests (DSAR, erasure, etc.)';


--
-- Name: COLUMN gdpr_requests.request_type; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.gdpr_requests.request_type IS 'dsar, erasure, rectification, restriction, portability';


--
-- Name: COLUMN gdpr_requests.status; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.gdpr_requests.status IS 'pending, in_review, processing, completed, rejected';


--
-- Name: generated_documents; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.generated_documents (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    template_id uuid NOT NULL,
    entity_type text NOT NULL,
    entity_id uuid NOT NULL,
    file_path text NOT NULL,
    file_name text NOT NULL,
    file_size integer NOT NULL,
    mime_type text NOT NULL,
    generated_by uuid NOT NULL,
    generated_at timestamp with time zone DEFAULT now() NOT NULL,
    metadata jsonb DEFAULT '{}'::jsonb NOT NULL,
    CONSTRAINT valid_mime_type CHECK ((mime_type = ANY (ARRAY['application/pdf'::text, 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'::text])))
);


--
-- Name: TABLE generated_documents; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.generated_documents IS 'Metadata for generated documents (files in Supabase Storage)';


--
-- Name: generated_resumes; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.generated_resumes (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    user_id uuid NOT NULL,
    target_role text NOT NULL,
    resume_text text NOT NULL,
    resume_pdf_path text,
    quality_score integer,
    ats_keywords text[],
    has_quantified_achievements boolean DEFAULT false,
    has_action_verbs boolean DEFAULT false,
    length_appropriate boolean DEFAULT false,
    no_typos boolean DEFAULT false,
    student_feedback text,
    interview_count integer DEFAULT 0,
    placement_achieved boolean DEFAULT false,
    model_used text,
    tokens_used integer,
    cost_usd numeric(10,6),
    generation_latency_ms integer,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT generated_resumes_quality_score_check CHECK (((quality_score >= 0) AND (quality_score <= 100)))
);


--
-- Name: TABLE generated_resumes; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.generated_resumes IS 'AI-generated resumes for students (AI-GURU-003)';


--
-- Name: COLUMN generated_resumes.quality_score; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.generated_resumes.quality_score IS 'Overall quality score 0-100 (automated validation)';


--
-- Name: COLUMN generated_resumes.ats_keywords; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.generated_resumes.ats_keywords IS 'ATS-friendly keywords detected in resume';


--
-- Name: COLUMN generated_resumes.interview_count; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.generated_resumes.interview_count IS 'Number of interviews secured with this resume (success tracking)';


--
-- Name: lab_submissions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.lab_submissions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    topic_id uuid NOT NULL,
    enrollment_id uuid NOT NULL,
    lab_instance_id uuid NOT NULL,
    repository_url text NOT NULL,
    commit_sha text,
    branch_name text DEFAULT 'main'::text,
    submitted_at timestamp with time zone DEFAULT now(),
    status text DEFAULT 'pending'::text,
    auto_grade_result jsonb,
    auto_grade_score numeric(5,2),
    auto_graded_at timestamp with time zone,
    manual_grade_score numeric(5,2),
    rubric_scores jsonb,
    graded_by uuid,
    graded_at timestamp with time zone,
    feedback text,
    final_score numeric(5,2),
    passed boolean,
    attempt_number integer DEFAULT 1,
    previous_submission_id uuid,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT lab_submissions_status_check CHECK ((status = ANY (ARRAY['pending'::text, 'grading'::text, 'auto_graded'::text, 'manual_review'::text, 'passed'::text, 'failed'::text]))),
    CONSTRAINT valid_auto_score CHECK (((auto_grade_score IS NULL) OR ((auto_grade_score >= (0)::numeric) AND (auto_grade_score <= (100)::numeric)))),
    CONSTRAINT valid_final_score CHECK (((final_score IS NULL) OR ((final_score >= (0)::numeric) AND (final_score <= (100)::numeric)))),
    CONSTRAINT valid_manual_score CHECK (((manual_grade_score IS NULL) OR ((manual_grade_score >= (0)::numeric) AND (manual_grade_score <= (100)::numeric))))
);


--
-- Name: TABLE lab_submissions; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.lab_submissions IS 'Store lab submissions and grading results';


--
-- Name: COLUMN lab_submissions.auto_grade_result; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.lab_submissions.auto_grade_result IS 'JSON result from GitHub Actions or auto-grader';


--
-- Name: COLUMN lab_submissions.rubric_scores; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.lab_submissions.rubric_scores IS 'JSON scores for manual grading rubric items';


--
-- Name: grading_queue; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.grading_queue AS
 SELECT ls.id AS submission_id,
    ls.user_id,
    up.full_name AS student_name,
    up.email AS student_email,
    ls.topic_id,
    mt.title AS topic_title,
    cm.title AS module_title,
    c.title AS course_title,
    ls.repository_url,
    ls.commit_sha,
    ls.submitted_at,
    ls.status,
    ls.auto_grade_score,
    ls.attempt_number,
    ls.enrollment_id
   FROM ((((public.lab_submissions ls
     JOIN public.user_profiles up ON ((up.id = ls.user_id)))
     JOIN public.module_topics mt ON ((mt.id = ls.topic_id)))
     JOIN public.course_modules cm ON ((cm.id = mt.module_id)))
     JOIN public.courses c ON ((c.id = cm.course_id)))
  WHERE (ls.status = ANY (ARRAY['pending'::text, 'manual_review'::text]))
  ORDER BY ls.submitted_at;


--
-- Name: graduate_candidates; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.graduate_candidates (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    enrollment_id uuid NOT NULL,
    graduated_at timestamp with time zone NOT NULL,
    course_id uuid,
    final_grade text,
    gpa_equivalent integer,
    project_score integer,
    assessment_score integer,
    job_readiness_score integer,
    technical_skills_score integer,
    soft_skills_score integer,
    status public.graduate_candidate_status DEFAULT 'pending_review'::public.graduate_candidate_status NOT NULL,
    status_changed_at timestamp with time zone,
    status_changed_by uuid,
    assigned_recruiter_id uuid,
    assigned_at timestamp with time zone,
    bench_candidate_id uuid,
    recruiter_notes text,
    opt_out_reason text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE graduate_candidates; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.graduate_candidates IS 'Cross-pillar link between Academy graduates and Recruiting pipeline';


--
-- Name: guru_interactions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.guru_interactions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    student_id uuid NOT NULL,
    agent_type text NOT NULL,
    conversation_id text,
    input jsonb NOT NULL,
    output jsonb NOT NULL,
    was_helpful boolean,
    user_feedback text,
    model_used text NOT NULL,
    tokens_used integer DEFAULT 0 NOT NULL,
    cost_usd numeric(10,6) DEFAULT 0 NOT NULL,
    latency_ms integer DEFAULT 0 NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT guru_interactions_agent_type_check CHECK ((agent_type = ANY (ARRAY['code_mentor'::text, 'resume_builder'::text, 'project_planner'::text, 'interview_coach'::text]))),
    CONSTRAINT guru_interactions_cost_check CHECK ((cost_usd >= (0)::numeric)),
    CONSTRAINT guru_interactions_tokens_check CHECK ((tokens_used >= 0))
);


--
-- Name: TABLE guru_interactions; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.guru_interactions IS 'Logs all Guru agent interactions for analytics and improvement';


--
-- Name: COLUMN guru_interactions.agent_type; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.guru_interactions.agent_type IS 'Type of Guru agent (code_mentor, resume_builder, project_planner, interview_coach)';


--
-- Name: COLUMN guru_interactions.conversation_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.guru_interactions.conversation_id IS 'Groups multi-turn conversations for context';


--
-- Name: hotlist_consultants; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.hotlist_consultants (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    hotlist_id uuid NOT NULL,
    consultant_id uuid NOT NULL,
    position_order integer,
    notes text,
    added_at timestamp with time zone DEFAULT now() NOT NULL,
    added_by uuid
);


--
-- Name: TABLE hotlist_consultants; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.hotlist_consultants IS 'Junction table for hotlists and consultants';


--
-- Name: i9_records; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.i9_records (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    employee_id uuid NOT NULL,
    section1_completed_at timestamp with time zone,
    section2_completed_at timestamp with time zone,
    list_a_document text,
    list_b_document text,
    list_c_document text,
    authorized_rep_name text,
    authorized_rep_title text,
    reverification_date date,
    status public.i9_status DEFAULT 'pending'::public.i9_status NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid
);


--
-- Name: immigration_alerts; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.immigration_alerts (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    consultant_id uuid NOT NULL,
    alert_type text NOT NULL,
    entity_id uuid,
    alert_date date NOT NULL,
    severity text NOT NULL,
    message text NOT NULL,
    acknowledged_by uuid,
    acknowledged_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE immigration_alerts; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.immigration_alerts IS 'Automated alerts for visa expiry and deadlines';


--
-- Name: immigration_attorneys; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.immigration_attorneys (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    name text NOT NULL,
    firm text,
    email text,
    phone text,
    specialization text[],
    rating numeric(3,1),
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT immigration_attorneys_rating_check CHECK (((rating >= 1.0) AND (rating <= 5.0)))
);


--
-- Name: TABLE immigration_attorneys; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.immigration_attorneys IS 'Immigration attorney directory';


--
-- Name: immigration_documents; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.immigration_documents (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    case_id uuid NOT NULL,
    document_type text NOT NULL,
    file_url text,
    file_id uuid,
    file_name text,
    issue_date date,
    expiry_date date,
    verified_by uuid,
    verified_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE immigration_documents; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.immigration_documents IS 'Immigration case documents';


--
-- Name: immigration_timelines; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.immigration_timelines (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    case_id uuid NOT NULL,
    milestone text NOT NULL,
    target_date date,
    actual_date date,
    status text DEFAULT 'pending'::text NOT NULL,
    notes text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE immigration_timelines; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.immigration_timelines IS 'Case milestone tracking';


--
-- Name: import_jobs; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.import_jobs (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    entity_type character varying(50) NOT NULL,
    file_name character varying(255) NOT NULL,
    file_path text NOT NULL,
    file_size_bytes integer,
    field_mapping jsonb DEFAULT '{}'::jsonb NOT NULL,
    import_options jsonb DEFAULT '{}'::jsonb NOT NULL,
    total_rows integer,
    processed_rows integer DEFAULT 0,
    success_rows integer DEFAULT 0,
    error_rows integer DEFAULT 0,
    warning_rows integer DEFAULT 0,
    status character varying(20) DEFAULT 'pending'::character varying NOT NULL,
    error_message text,
    error_log jsonb DEFAULT '[]'::jsonb,
    warnings_log jsonb DEFAULT '[]'::jsonb,
    started_at timestamp with time zone,
    completed_at timestamp with time zone,
    created_by uuid NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE import_jobs; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.import_jobs IS 'Tracks data import operations';


--
-- Name: COLUMN import_jobs.import_options; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.import_jobs.import_options IS 'error_handling: skip|stop|flag, create_missing_references, etc.';


--
-- Name: COLUMN import_jobs.status; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.import_jobs.status IS 'pending, validating, processing, completed, failed, cancelled';


--
-- Name: incident_notifications; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.incident_notifications (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    incident_id uuid NOT NULL,
    notification_type text NOT NULL,
    recipient text NOT NULL,
    subject text,
    body text NOT NULL,
    status text DEFAULT 'pending'::text,
    sent_at timestamp with time zone,
    delivered_at timestamp with time zone,
    error_message text,
    sent_by uuid,
    metadata jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT incident_notifications_notification_type_check CHECK ((notification_type = ANY (ARRAY['email'::text, 'sms'::text, 'slack'::text, 'status_page'::text, 'in_app'::text]))),
    CONSTRAINT incident_notifications_status_check CHECK ((status = ANY (ARRAY['pending'::text, 'sent'::text, 'delivered'::text, 'failed'::text])))
);


--
-- Name: TABLE incident_notifications; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.incident_notifications IS 'Notifications sent during incidents';


--
-- Name: incident_timeline; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.incident_timeline (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    incident_id uuid NOT NULL,
    event_type text NOT NULL,
    description text NOT NULL,
    performed_by uuid,
    metadata jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT incident_timeline_event_type_check CHECK ((event_type = ANY (ARRAY['detection'::text, 'notification'::text, 'escalation'::text, 'action'::text, 'update'::text, 'resolution'::text])))
);


--
-- Name: TABLE incident_timeline; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.incident_timeline IS 'Timeline of events during incidents';


--
-- Name: incidents; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.incidents (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    incident_number text NOT NULL,
    title text NOT NULL,
    description text,
    severity text NOT NULL,
    status text DEFAULT 'open'::text NOT NULL,
    impact text,
    root_cause text,
    resolution text,
    started_at timestamp with time zone NOT NULL,
    detected_at timestamp with time zone,
    resolved_at timestamp with time zone,
    incident_commander uuid,
    created_by uuid,
    updated_by uuid,
    metadata jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT incidents_severity_check CHECK ((severity = ANY (ARRAY['P0'::text, 'P1'::text, 'P2'::text, 'P3'::text]))),
    CONSTRAINT incidents_status_check CHECK ((status = ANY (ARRAY['open'::text, 'investigating'::text, 'identified'::text, 'monitoring'::text, 'resolved'::text])))
);


--
-- Name: TABLE incidents; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.incidents IS 'P0-P3 incident tracking for emergency response';


--
-- Name: integration_failover_config; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.integration_failover_config (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    integration_type character varying(50) NOT NULL,
    primary_integration_id uuid NOT NULL,
    backup_integration_id uuid,
    failover_threshold integer DEFAULT 3,
    auto_failover boolean DEFAULT true,
    auto_recovery boolean DEFAULT false,
    recovery_check_interval_minutes integer DEFAULT 30,
    current_active character varying(20) DEFAULT 'primary'::character varying,
    last_failover_at timestamp with time zone,
    last_recovery_at timestamp with time zone,
    failover_count integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: integration_health_logs; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.integration_health_logs (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    integration_id uuid NOT NULL,
    check_type character varying(50) DEFAULT 'manual'::character varying NOT NULL,
    status character varying(20) NOT NULL,
    response_time_ms integer,
    error_message text,
    error_code character varying(50),
    details jsonb DEFAULT '{}'::jsonb,
    checked_by uuid,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: integration_oauth_tokens; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.integration_oauth_tokens (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    integration_id uuid NOT NULL,
    user_id uuid,
    provider character varying(50) NOT NULL,
    access_token text NOT NULL,
    refresh_token text,
    token_type character varying(20) DEFAULT 'Bearer'::character varying,
    scope text,
    expires_at timestamp with time zone,
    refresh_expires_at timestamp with time zone,
    account_id character varying(255),
    account_email character varying(255),
    raw_token_response jsonb,
    last_refreshed_at timestamp with time zone,
    last_used_at timestamp with time zone,
    status character varying(20) DEFAULT 'active'::character varying,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: integration_retry_config; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.integration_retry_config (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    max_retries integer DEFAULT 3 NOT NULL,
    retry_strategy character varying(20) DEFAULT 'exponential'::character varying NOT NULL,
    base_delay_seconds integer DEFAULT 5 NOT NULL,
    max_delay_seconds integer DEFAULT 300 NOT NULL,
    enable_jitter boolean DEFAULT true,
    enable_dlq boolean DEFAULT true,
    dlq_retention_days integer DEFAULT 30,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: integration_types; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.integration_types (
    id character varying(50) NOT NULL,
    name character varying(100) NOT NULL,
    description text,
    category character varying(50) NOT NULL,
    icon character varying(50),
    config_schema jsonb,
    providers jsonb DEFAULT '[]'::jsonb,
    is_active boolean DEFAULT true,
    sort_order integer DEFAULT 0
);


--
-- Name: integrations; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.integrations (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    type character varying(50) NOT NULL,
    provider character varying(50) NOT NULL,
    name character varying(100) NOT NULL,
    description text,
    config jsonb DEFAULT '{}'::jsonb NOT NULL,
    status character varying(20) DEFAULT 'inactive'::character varying NOT NULL,
    is_primary boolean DEFAULT false,
    last_health_check timestamp with time zone,
    last_sync timestamp with time zone,
    health_status character varying(20) DEFAULT 'unknown'::character varying,
    error_message text,
    error_count integer DEFAULT 0,
    metadata jsonb DEFAULT '{}'::jsonb,
    created_by uuid,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone
);


--
-- Name: interviews; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.interviews (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    submission_id uuid NOT NULL,
    job_id uuid NOT NULL,
    candidate_id uuid NOT NULL,
    round_number integer DEFAULT 1 NOT NULL,
    interview_type text DEFAULT 'technical'::text,
    scheduled_at timestamp with time zone,
    duration_minutes integer DEFAULT 60,
    timezone text DEFAULT 'America/New_York'::text,
    meeting_link text,
    meeting_location text,
    interviewer_names text[],
    interviewer_emails text[],
    scheduled_by uuid,
    status text DEFAULT 'scheduled'::text NOT NULL,
    cancellation_reason text,
    feedback text,
    rating integer,
    recommendation text,
    submitted_by uuid,
    feedback_submitted_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    org_id uuid NOT NULL,
    proposed_times jsonb DEFAULT '[]'::jsonb,
    confirmed_at timestamp with time zone,
    confirmed_by uuid,
    rescheduled_at timestamp with time zone,
    rescheduled_by uuid,
    reschedule_reason text,
    reschedule_count integer DEFAULT 0,
    cancelled_at timestamp with time zone,
    cancelled_by uuid,
    cancellation_notes text,
    prep_completed_at timestamp with time zone,
    prep_completed_by uuid,
    prep_notes text,
    prep_checklist jsonb DEFAULT '[]'::jsonb,
    prep_materials_sent_at timestamp with time zone,
    technical_rating integer,
    communication_rating integer,
    problem_solving_rating integer,
    culture_fit_rating integer,
    strengths text,
    concerns text,
    description text,
    internal_notes text,
    location text,
    candidate_experience text,
    candidate_interest_level text,
    candidate_feedback text,
    candidate_concerns text,
    attendance_status text,
    next_steps text,
    ics_uid text,
    ics_sequence integer DEFAULT 0,
    contact_id uuid,
    CONSTRAINT interviews_attendance_status_check CHECK ((attendance_status = ANY (ARRAY['attended'::text, 'no_show'::text, 'cancelled'::text, 'rescheduled'::text]))),
    CONSTRAINT interviews_candidate_experience_check CHECK ((candidate_experience = ANY (ARRAY['great'::text, 'good'::text, 'okay'::text, 'poor'::text]))),
    CONSTRAINT interviews_candidate_interest_level_check CHECK ((candidate_interest_level = ANY (ARRAY['very_high'::text, 'high'::text, 'medium'::text, 'low'::text, 'withdrawn'::text]))),
    CONSTRAINT interviews_communication_rating_check CHECK (((communication_rating >= 1) AND (communication_rating <= 5))),
    CONSTRAINT interviews_culture_fit_rating_check CHECK (((culture_fit_rating >= 1) AND (culture_fit_rating <= 5))),
    CONSTRAINT interviews_next_steps_check CHECK ((next_steps = ANY (ARRAY['schedule_next_round'::text, 'extend_offer'::text, 'reject'::text, 'on_hold'::text]))),
    CONSTRAINT interviews_problem_solving_rating_check CHECK (((problem_solving_rating >= 1) AND (problem_solving_rating <= 5))),
    CONSTRAINT interviews_rating_check CHECK (((rating >= 1) AND (rating <= 5))),
    CONSTRAINT interviews_technical_rating_check CHECK (((technical_rating >= 1) AND (technical_rating <= 5)))
);


--
-- Name: TABLE interviews; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.interviews IS 'Interview records with full lifecycle tracking: scheduling, confirmation, prep, feedback';


--
-- Name: COLUMN interviews.status; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.interviews.status IS 'Valid values: proposed, scheduled, confirmed, completed, cancelled, no_show';


--
-- Name: interview_addresses_view; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.interview_addresses_view AS
 SELECT i.id AS interview_id,
    i.org_id,
    i.interview_type,
    i.scheduled_at,
    addr.id AS address_id,
    addr.address_type,
    addr.address_line_1,
    addr.city,
    addr.state_province,
    addr.notes AS address_notes,
    addr.is_primary
   FROM (public.interviews i
     LEFT JOIN public.addresses addr ON (((addr.entity_type = 'interview'::text) AND (addr.entity_id = i.id))))
  WHERE (i.cancelled_at IS NULL);


--
-- Name: VIEW interview_addresses_view; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.interview_addresses_view IS 'View for accessing interview meeting locations';


--
-- Name: interview_feedback; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.interview_feedback (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    interview_id uuid NOT NULL,
    submitted_by uuid NOT NULL,
    rating integer,
    recommendation text,
    strengths text,
    weaknesses text,
    notes text,
    submitted_at timestamp with time zone DEFAULT now() NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone
);


--
-- Name: interview_participants; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.interview_participants (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    interview_id uuid NOT NULL,
    participant_type text NOT NULL,
    user_id uuid,
    external_name text,
    external_email text,
    is_required boolean DEFAULT true,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone
);


--
-- Name: interview_reminders; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.interview_reminders (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    interview_id uuid NOT NULL,
    reminder_type text NOT NULL,
    sent_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: interview_sessions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.interview_sessions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    student_id uuid NOT NULL,
    interview_type text NOT NULL,
    guidewire_module text,
    questions jsonb DEFAULT '[]'::jsonb NOT NULL,
    average_score numeric(4,2) DEFAULT 0 NOT NULL,
    started_at timestamp with time zone DEFAULT now() NOT NULL,
    completed_at timestamp with time zone,
    duration integer,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT interview_sessions_average_score_check CHECK (((average_score >= (0)::numeric) AND (average_score <= (10)::numeric))),
    CONSTRAINT interview_sessions_interview_type_check CHECK ((interview_type = ANY (ARRAY['technical'::text, 'behavioral'::text, 'mixed'::text])))
);


--
-- Name: TABLE interview_sessions; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.interview_sessions IS 'Mock interview sessions with scoring and feedback';


--
-- Name: COLUMN interview_sessions.average_score; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.interview_sessions.average_score IS 'Average score across all questions in session (1-10 scale)';


--
-- Name: jobs; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.jobs (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    account_id uuid,
    deal_id uuid,
    title text NOT NULL,
    description text,
    job_type text DEFAULT 'contract'::text,
    location text,
    is_remote boolean DEFAULT false,
    hybrid_days integer,
    rate_min numeric(10,2),
    rate_max numeric(10,2),
    rate_type text DEFAULT 'hourly'::text,
    currency text DEFAULT 'USD'::text,
    status text DEFAULT 'draft'::text NOT NULL,
    urgency text DEFAULT 'medium'::text,
    positions_count integer DEFAULT 1,
    positions_filled integer DEFAULT 0,
    required_skills text[],
    nice_to_have_skills text[],
    min_experience_years integer,
    max_experience_years integer,
    visa_requirements text[],
    owner_id uuid NOT NULL,
    recruiter_ids uuid[],
    posted_date date,
    target_fill_date date,
    filled_date date,
    client_submission_instructions text,
    client_interview_process text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid,
    deleted_at timestamp with time zone,
    search_vector tsvector,
    client_id uuid,
    priority text DEFAULT 'medium'::text,
    target_start_date timestamp with time zone,
    closed_at timestamp with time zone,
    closed_by uuid,
    closure_reason text,
    closure_note text,
    on_hold_reason text,
    expected_reactivation_date date,
    published_at timestamp with time zone,
    published_by uuid,
    days_to_fill integer,
    company_id uuid
);


--
-- Name: TABLE jobs; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.jobs IS 'Job requisitions from clients';


--
-- Name: COLUMN jobs.company_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.jobs.company_id IS 'FK to companies table (replaces account_id)';


--
-- Name: job_addresses_view; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.job_addresses_view AS
 SELECT j.id AS job_id,
    j.org_id,
    j.title AS job_title,
    a.name AS account_name,
    addr.id AS address_id,
    addr.address_type,
    addr.address_line_1,
    addr.city,
    addr.state_province,
    addr.postal_code,
    addr.country_code,
    addr.is_primary,
    addr.created_at,
    addr.updated_at
   FROM ((public.jobs j
     LEFT JOIN public.accounts a ON ((a.id = j.account_id)))
     LEFT JOIN public.addresses addr ON (((addr.entity_type = 'job'::text) AND (addr.entity_id = j.id))))
  WHERE (j.deleted_at IS NULL);


--
-- Name: VIEW job_addresses_view; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.job_addresses_view IS 'View for accessing job location addresses';


--
-- Name: job_assignments; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.job_assignments (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    job_id uuid NOT NULL,
    user_id uuid NOT NULL,
    role text DEFAULT 'secondary'::text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone
);


--
-- Name: job_rates; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.job_rates (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    job_id uuid NOT NULL,
    bill_rate_min numeric(10,2),
    bill_rate_max numeric(10,2),
    pay_rate_min numeric(10,2),
    pay_rate_max numeric(10,2),
    currency text DEFAULT 'USD'::text,
    rate_type text DEFAULT 'hourly'::text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone
);


--
-- Name: job_requirements; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.job_requirements (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    job_id uuid NOT NULL,
    requirement text NOT NULL,
    type text DEFAULT 'must_have'::text NOT NULL,
    sequence integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone
);


--
-- Name: job_screening_questions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.job_screening_questions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    job_id uuid NOT NULL,
    question text NOT NULL,
    type text DEFAULT 'text'::text NOT NULL,
    options jsonb,
    is_required boolean DEFAULT false,
    sequence integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone
);


--
-- Name: job_skills; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.job_skills (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    job_id uuid NOT NULL,
    skill_id uuid NOT NULL,
    importance text DEFAULT 'required'::text NOT NULL,
    min_years numeric(4,1),
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone
);


--
-- Name: job_status_history; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.job_status_history (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    job_id uuid NOT NULL,
    previous_status text,
    new_status text NOT NULL,
    changed_by uuid NOT NULL,
    changed_at timestamp with time zone DEFAULT now() NOT NULL,
    reason text,
    notes text,
    is_system_triggered boolean DEFAULT false,
    expected_reactivation_date date,
    actual_reactivation_date date,
    hold_duration_days integer,
    days_to_fill integer,
    positions_filled_count integer,
    candidates_affected_count integer,
    interviews_cancelled_count integer,
    offers_withdrawn_count integer,
    reopen_approved_by uuid,
    reopen_approval_date timestamp with time zone,
    metadata jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: lab_instances; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.lab_instances (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    topic_id uuid NOT NULL,
    enrollment_id uuid NOT NULL,
    lab_template_id uuid,
    forked_repo_url text NOT NULL,
    forked_repo_name text,
    original_template_url text NOT NULL,
    status text DEFAULT 'active'::text,
    started_at timestamp with time zone DEFAULT now(),
    expires_at timestamp with time zone,
    completed_at timestamp with time zone,
    time_spent_seconds integer DEFAULT 0,
    last_activity_at timestamp with time zone DEFAULT now(),
    github_username text,
    provisioning_metadata jsonb,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT lab_instances_status_check CHECK ((status = ANY (ARRAY['active'::text, 'submitted'::text, 'expired'::text, 'abandoned'::text, 'completed'::text]))),
    CONSTRAINT valid_time_spent CHECK ((time_spent_seconds >= 0))
);


--
-- Name: TABLE lab_instances; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.lab_instances IS 'Track active lab sessions for students';


--
-- Name: COLUMN lab_instances.expires_at; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.lab_instances.expires_at IS 'When the lab session expires (based on time_limit)';


--
-- Name: lab_statistics; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.lab_statistics AS
 SELECT mt.id AS topic_id,
    mt.title AS lab_title,
    count(DISTINCT li.user_id) AS total_students_started,
    count(DISTINCT ls.user_id) AS total_students_submitted,
    count(ls.id) FILTER (WHERE (ls.passed = true)) AS total_passed,
    count(ls.id) FILTER (WHERE (ls.passed = false)) AS total_failed,
    avg(ls.final_score) AS avg_final_score,
    avg(li.time_spent_seconds) FILTER (WHERE (li.status = 'completed'::text)) AS avg_time_spent_seconds
   FROM ((public.module_topics mt
     LEFT JOIN public.lab_instances li ON ((li.topic_id = mt.id)))
     LEFT JOIN public.lab_submissions ls ON ((ls.topic_id = mt.id)))
  WHERE (mt.content_type = 'lab'::text)
  GROUP BY mt.id, mt.title;


--
-- Name: lab_templates; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.lab_templates (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    name text NOT NULL,
    description text,
    github_template_url text NOT NULL,
    difficulty_level text,
    time_limit_minutes integer DEFAULT 120,
    auto_grading_enabled boolean DEFAULT false,
    github_actions_workflow text,
    required_skills text[],
    estimated_duration_minutes integer,
    created_by uuid,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    is_active boolean DEFAULT true,
    CONSTRAINT lab_templates_difficulty_level_check CHECK ((difficulty_level = ANY (ARRAY['beginner'::text, 'intermediate'::text, 'advanced'::text])))
);


--
-- Name: TABLE lab_templates; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.lab_templates IS 'Store metadata about lab template repositories';


--
-- Name: leads; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.leads (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    lead_type text DEFAULT 'company'::text NOT NULL,
    company_name text,
    industry text,
    company_size text,
    first_name text,
    last_name text,
    title text,
    email text,
    phone text,
    linkedin_url text,
    status text DEFAULT 'new'::text NOT NULL,
    estimated_value numeric(12,2),
    source text,
    source_campaign_id uuid,
    owner_id uuid,
    last_contacted_at timestamp with time zone,
    last_response_at timestamp with time zone,
    engagement_score integer,
    converted_to_deal_id uuid,
    converted_to_account_id uuid,
    converted_at timestamp with time zone,
    lost_reason text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid,
    deleted_at timestamp with time zone,
    company_type text,
    website text,
    tier text,
    company_description text,
    decision_authority text,
    preferred_contact_method text DEFAULT 'email'::text,
    account_id uuid,
    notes text,
    search_vector tsvector,
    bant_budget integer DEFAULT 0,
    bant_authority integer DEFAULT 0,
    bant_need integer DEFAULT 0,
    bant_timeline integer DEFAULT 0,
    bant_budget_notes text,
    bant_authority_notes text,
    bant_need_notes text,
    bant_timeline_notes text,
    bant_total_score integer GENERATED ALWAYS AS ((((COALESCE(bant_budget, 0) + COALESCE(bant_authority, 0)) + COALESCE(bant_need, 0)) + COALESCE(bant_timeline, 0))) STORED,
    budget_status text,
    estimated_monthly_spend numeric(12,2),
    authority_level text,
    business_need text,
    urgency text,
    target_start_date date,
    positions_count integer DEFAULT 1,
    skills_needed text[],
    contract_types text[],
    qualification_result text,
    qualification_notes text,
    qualified_at timestamp with time zone,
    qualified_by uuid,
    campaign_id uuid,
    campaign_prospect_id uuid,
    cross_pillar_type text,
    target_pillar text,
    handoff_notes text,
    interest_level text,
    hiring_needs text,
    pain_points text,
    budget_notes text,
    authority_status text,
    authority_notes text,
    need_status text,
    need_notes text,
    timeline_status text,
    timeline_notes text,
    next_action text,
    next_action_date date,
    lead_score integer,
    contact_id uuid,
    company_id uuid,
    converted_to_company_id uuid,
    CONSTRAINT leads_authority_level_check CHECK ((authority_level = ANY (ARRAY['decision_maker'::text, 'influencer'::text, 'gatekeeper'::text, 'no_authority'::text]))),
    CONSTRAINT leads_bant_authority_check CHECK (((bant_authority >= 0) AND (bant_authority <= 25))),
    CONSTRAINT leads_bant_budget_check CHECK (((bant_budget >= 0) AND (bant_budget <= 25))),
    CONSTRAINT leads_bant_need_check CHECK (((bant_need >= 0) AND (bant_need <= 25))),
    CONSTRAINT leads_bant_timeline_check CHECK (((bant_timeline >= 0) AND (bant_timeline <= 25))),
    CONSTRAINT leads_budget_status_check CHECK ((budget_status = ANY (ARRAY['confirmed'::text, 'likely'::text, 'unclear'::text, 'no_budget'::text]))),
    CONSTRAINT leads_engagement_score_check CHECK (((engagement_score >= 0) AND (engagement_score <= 100))),
    CONSTRAINT leads_lead_score_check CHECK (((lead_score >= 0) AND (lead_score <= 100))),
    CONSTRAINT leads_positions_count_check CHECK (((positions_count >= 1) AND (positions_count <= 100))),
    CONSTRAINT leads_qualification_result_check CHECK ((qualification_result = ANY (ARRAY['qualified_convert'::text, 'qualified_nurture'::text, 'not_qualified'::text]))),
    CONSTRAINT leads_urgency_check CHECK ((urgency = ANY (ARRAY['immediate'::text, 'high'::text, 'medium'::text, 'low'::text])))
);


--
-- Name: TABLE leads; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.leads IS 'CRM leads for recruiting/staffing - can be company or person type';


--
-- Name: COLUMN leads.status; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.leads.status IS 'Valid values: new, contacted, qualified, unqualified, nurture, converted. Status colors: new=gray, contacted=blue, qualified=green, unqualified=red, nurture=yellow, converted=purple';


--
-- Name: COLUMN leads.budget_status; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.leads.budget_status IS 'BANT Budget: confirmed=25pts, likely=15pts, unclear=5pts, no_budget=0pts';


--
-- Name: COLUMN leads.authority_level; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.leads.authority_level IS 'BANT Authority: decision_maker=25pts, influencer=20pts, gatekeeper=10pts, no_authority=0pts';


--
-- Name: COLUMN leads.urgency; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.leads.urgency IS 'BANT Timeline urgency: immediate=25pts, high=20pts, medium=10pts, low=5pts';


--
-- Name: COLUMN leads.company_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.leads.company_id IS 'FK to companies table (replaces account_id)';


--
-- Name: COLUMN leads.converted_to_company_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.leads.converted_to_company_id IS 'FK to companies table for converted company (replaces converted_to_account_id)';


--
-- Name: lead_addresses_view; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.lead_addresses_view AS
 SELECT l.id AS lead_id,
    l.org_id,
    l.company_name,
    l.first_name,
    l.last_name,
    addr.id AS address_id,
    addr.address_type,
    addr.address_line_1,
    addr.address_line_2,
    addr.address_line_3,
    addr.city,
    addr.state_province,
    addr.postal_code,
    addr.country_code,
    addr.county,
    addr.latitude,
    addr.longitude,
    addr.is_verified,
    addr.is_primary,
    addr.effective_from,
    addr.effective_to,
    addr.notes,
    addr.created_at,
    addr.updated_at
   FROM (public.leads l
     LEFT JOIN public.addresses addr ON (((addr.entity_type = 'lead'::text) AND (addr.entity_id = l.id))));


--
-- Name: VIEW lead_addresses_view; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.lead_addresses_view IS 'View for accessing lead addresses from the unified addresses table';


--
-- Name: lead_qualification; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.lead_qualification (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    lead_id uuid NOT NULL,
    has_budget boolean,
    budget_amount numeric(12,2),
    budget_timeframe text,
    budget_notes text,
    decision_maker text,
    decision_process text,
    other_stakeholders text,
    authority_notes text,
    need_identified boolean,
    need_urgency text,
    pain_points text[],
    current_solution text,
    need_notes text,
    timeline text,
    decision_date timestamp with time zone,
    project_start_date timestamp with time zone,
    timeline_notes text,
    qualified_by uuid,
    qualified_at timestamp with time zone,
    qualification_status text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE lead_qualification; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.lead_qualification IS 'Detailed BANT qualification data';


--
-- Name: lead_scores; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.lead_scores (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    lead_id uuid NOT NULL,
    score integer DEFAULT 0 NOT NULL,
    factors jsonb,
    budget_score integer DEFAULT 0,
    authority_score integer DEFAULT 0,
    need_score integer DEFAULT 0,
    timeline_score integer DEFAULT 0,
    engagement_score integer DEFAULT 0,
    fit_score integer DEFAULT 0,
    calculated_at timestamp with time zone DEFAULT now() NOT NULL,
    calculated_by text,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE lead_scores; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.lead_scores IS 'Lead scoring with BANT factors';


--
-- Name: lead_sourcing_credits; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.lead_sourcing_credits (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    lead_id uuid NOT NULL,
    sourced_by uuid NOT NULL,
    source_pillar text NOT NULL,
    target_pillar text NOT NULL,
    assigned_to uuid,
    credit_points integer DEFAULT 10,
    bonus_points integer DEFAULT 0,
    status text DEFAULT 'pending'::text,
    converted_at timestamp with time zone,
    conversion_value numeric(12,2),
    commission_earned numeric(12,2),
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: lead_strategies; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.lead_strategies (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    lead_id uuid NOT NULL,
    strategy_notes text,
    talking_points jsonb DEFAULT '[]'::jsonb,
    value_proposition text,
    differentiators jsonb DEFAULT '[]'::jsonb,
    objections jsonb DEFAULT '[]'::jsonb,
    stakeholders jsonb DEFAULT '[]'::jsonb,
    competitors jsonb DEFAULT '[]'::jsonb,
    win_themes jsonb DEFAULT '[]'::jsonb,
    pain_points jsonb DEFAULT '[]'::jsonb,
    meeting_agenda jsonb DEFAULT '[]'::jsonb,
    questions_to_ask jsonb DEFAULT '[]'::jsonb,
    desired_outcomes jsonb DEFAULT '[]'::jsonb,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid,
    updated_by uuid
);


--
-- Name: lead_tasks; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.lead_tasks (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    lead_id uuid NOT NULL,
    title text NOT NULL,
    description text,
    due_date date NOT NULL,
    priority text DEFAULT 'medium'::text NOT NULL,
    completed boolean DEFAULT false NOT NULL,
    completed_at timestamp with time zone,
    completed_by uuid,
    assigned_to uuid,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid,
    deleted_at timestamp with time zone,
    CONSTRAINT lead_tasks_priority_check CHECK ((priority = ANY (ARRAY['low'::text, 'medium'::text, 'high'::text])))
);


--
-- Name: lead_touchpoints; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.lead_touchpoints (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    lead_id uuid NOT NULL,
    touchpoint_type text NOT NULL,
    direction text DEFAULT 'outbound'::text NOT NULL,
    subject text,
    notes text,
    outcome text,
    next_steps text,
    next_follow_up_date timestamp with time zone,
    duration_minutes integer,
    campaign_id uuid,
    template_used text,
    created_by uuid,
    touchpoint_date timestamp with time zone DEFAULT now() NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE lead_touchpoints; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.lead_touchpoints IS 'All outreach/contact history for leads';


--
-- Name: xp_transactions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.xp_transactions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    amount integer NOT NULL,
    transaction_type text NOT NULL,
    reference_type text,
    reference_id uuid,
    description text,
    awarded_at timestamp with time zone DEFAULT now() NOT NULL,
    awarded_by uuid,
    created_at timestamp with time zone DEFAULT now(),
    CONSTRAINT xp_transactions_reference_type_check CHECK ((reference_type = ANY (ARRAY['topic_completion'::text, 'enrollment'::text, 'achievement'::text, 'admin_action'::text]))),
    CONSTRAINT xp_transactions_transaction_type_check CHECK ((transaction_type = ANY (ARRAY['topic_completion'::text, 'quiz_passed'::text, 'lab_completed'::text, 'project_submitted'::text, 'bonus_achievement'::text, 'penalty'::text, 'adjustment'::text])))
);


--
-- Name: TABLE xp_transactions; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.xp_transactions IS 'Ledger of all XP awards and penalties for gamification';


--
-- Name: user_xp_totals; Type: MATERIALIZED VIEW; Schema: public; Owner: -
--

CREATE MATERIALIZED VIEW public.user_xp_totals AS
 SELECT user_id,
    sum(amount) AS total_xp,
    count(*) AS transaction_count,
    max(awarded_at) AS last_xp_earned_at,
    rank() OVER (ORDER BY (sum(amount)) DESC) AS leaderboard_rank
   FROM public.xp_transactions
  GROUP BY user_id
  WITH NO DATA;


--
-- Name: MATERIALIZED VIEW user_xp_totals; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON MATERIALIZED VIEW public.user_xp_totals IS 'Aggregated XP totals for leaderboard performance';


--
-- Name: leaderboard_all_time; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.leaderboard_all_time AS
 WITH all_time_stats AS (
         SELECT up.id AS user_id,
            up.full_name,
            up.avatar_url,
            up.created_at AS joined_at,
            uxp.total_xp,
            ((floor(((uxp.total_xp / 1000))::double precision))::integer + 1) AS level,
                CASE
                    WHEN (uxp.total_xp < 1000) THEN 'Beginner'::text
                    WHEN (uxp.total_xp < 5000) THEN 'Intermediate'::text
                    WHEN (uxp.total_xp < 10000) THEN 'Advanced'::text
                    WHEN (uxp.total_xp < 25000) THEN 'Expert'::text
                    ELSE 'Master'::text
                END AS level_name,
            ( SELECT count(*) AS count
                   FROM public.user_badges
                  WHERE (user_badges.user_id = up.id)) AS badge_count,
            ( SELECT count(*) AS count
                   FROM public.student_enrollments
                  WHERE ((student_enrollments.user_id = up.id) AND (student_enrollments.status = 'completed'::text))) AS courses_completed,
            ((CURRENT_DATE - (up.created_at)::date))::numeric AS days_active
           FROM (public.user_profiles up
             JOIN public.user_xp_totals uxp ON ((uxp.user_id = up.id)))
          WHERE ((up.leaderboard_visible = true) AND (uxp.total_xp > 0))
        ), ranked_all_time AS (
         SELECT all_time_stats.user_id,
            all_time_stats.full_name,
            all_time_stats.avatar_url,
            all_time_stats.joined_at,
            all_time_stats.total_xp,
            all_time_stats.level,
            all_time_stats.level_name,
            all_time_stats.badge_count,
            all_time_stats.courses_completed,
            all_time_stats.days_active,
            rank() OVER (ORDER BY all_time_stats.total_xp DESC) AS rank,
                CASE
                    WHEN (all_time_stats.days_active > (0)::numeric) THEN round(((all_time_stats.total_xp)::numeric / all_time_stats.days_active), 2)
                    ELSE (0)::numeric
                END AS avg_xp_per_day
           FROM all_time_stats
        )
 SELECT user_id,
    full_name,
    avatar_url,
    joined_at,
    total_xp,
    level,
    level_name,
    badge_count,
    courses_completed,
    days_active,
    rank,
    avg_xp_per_day
   FROM ranked_all_time
  WHERE (rank <= 100)
  ORDER BY rank;


--
-- Name: VIEW leaderboard_all_time; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.leaderboard_all_time IS 'Top 100 all-time XP leaders with comprehensive stats';


--
-- Name: leaderboard_by_cohort; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.leaderboard_by_cohort AS
 WITH cohorts AS (
         SELECT e.course_id,
            c.title AS course_title,
            date_trunc('month'::text, e.enrolled_at) AS cohort_month,
            to_char(e.enrolled_at, 'Month YYYY'::text) AS cohort_name,
            up.id AS user_id,
            up.full_name,
            up.avatar_url,
            uxp.total_xp,
            e.completion_percentage,
            e.enrolled_at
           FROM (((public.student_enrollments e
             JOIN public.user_profiles up ON ((up.id = e.user_id)))
             JOIN public.courses c ON ((c.id = e.course_id)))
             JOIN public.user_xp_totals uxp ON ((uxp.user_id = up.id)))
          WHERE ((up.leaderboard_visible = true) AND (e.status = ANY (ARRAY['active'::text, 'completed'::text])))
        ), ranked_cohorts AS (
         SELECT cohorts.course_id,
            cohorts.course_title,
            cohorts.cohort_month,
            cohorts.cohort_name,
            cohorts.user_id,
            cohorts.full_name,
            cohorts.avatar_url,
            cohorts.total_xp,
            cohorts.completion_percentage,
            cohorts.enrolled_at,
            rank() OVER (PARTITION BY cohorts.course_id, cohorts.cohort_month ORDER BY cohorts.total_xp DESC) AS rank,
            count(*) OVER (PARTITION BY cohorts.course_id, cohorts.cohort_month) AS cohort_size
           FROM cohorts
        )
 SELECT course_id,
    course_title,
    cohort_month,
    cohort_name,
    user_id,
    full_name,
    avatar_url,
    total_xp,
    completion_percentage,
    enrolled_at,
    rank,
    cohort_size,
    round((((1)::numeric - ((rank)::numeric / (cohort_size)::numeric)) * (100)::numeric), 1) AS cohort_percentile
   FROM ranked_cohorts
  ORDER BY cohort_month DESC, rank;


--
-- Name: VIEW leaderboard_by_cohort; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.leaderboard_by_cohort IS 'Cohort-based leaderboard grouping students by enrollment month';


--
-- Name: leaderboard_by_course; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.leaderboard_by_course AS
 WITH ranked_students AS (
         SELECT e.course_id,
            c.title AS course_title,
            up.id AS user_id,
            up.full_name,
            up.avatar_url,
            uxp.total_xp AS course_xp,
            e.completion_percentage,
            0 AS modules_completed,
            0 AS total_modules,
            rank() OVER (PARTITION BY e.course_id ORDER BY uxp.total_xp DESC) AS rank,
            count(*) OVER (PARTITION BY e.course_id) AS total_students
           FROM (((public.student_enrollments e
             JOIN public.user_profiles up ON ((up.id = e.user_id)))
             JOIN public.courses c ON ((c.id = e.course_id)))
             JOIN public.user_xp_totals uxp ON ((uxp.user_id = e.user_id)))
          WHERE ((up.leaderboard_visible = true) AND (e.status = ANY (ARRAY['active'::text, 'completed'::text])) AND (uxp.total_xp > 0))
        )
 SELECT course_id,
    course_title,
    user_id,
    full_name,
    avatar_url,
    course_xp,
    completion_percentage,
    modules_completed,
    total_modules,
    rank,
    total_students,
    round((((1)::numeric - ((rank)::numeric / (total_students)::numeric)) * (100)::numeric), 1) AS percentile
   FROM ranked_students
  ORDER BY course_id, rank;


--
-- Name: VIEW leaderboard_by_course; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.leaderboard_by_course IS 'Course-specific XP leaderboards with completion stats';


--
-- Name: leaderboard_entries; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.leaderboard_entries (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    leaderboard_id uuid NOT NULL,
    user_id uuid NOT NULL,
    rank integer NOT NULL,
    xp_earned integer DEFAULT 0 NOT NULL,
    courses_completed integer DEFAULT 0 NOT NULL,
    lessons_completed integer DEFAULT 0 NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: leaderboard_global; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.leaderboard_global AS
 WITH ranked_users AS (
         SELECT up.id AS user_id,
            up.full_name,
            up.avatar_url,
            uxp.total_xp,
            ((floor(((uxp.total_xp / 1000))::double precision))::integer + 1) AS level,
                CASE
                    WHEN (uxp.total_xp < 1000) THEN 'Beginner'::text
                    WHEN (uxp.total_xp < 5000) THEN 'Intermediate'::text
                    WHEN (uxp.total_xp < 10000) THEN 'Advanced'::text
                    WHEN (uxp.total_xp < 25000) THEN 'Expert'::text
                    ELSE 'Master'::text
                END AS level_name,
            rank() OVER (ORDER BY uxp.total_xp DESC) AS rank,
            dense_rank() OVER (ORDER BY uxp.total_xp DESC) AS dense_rank
           FROM (public.user_profiles up
             JOIN public.user_xp_totals uxp ON ((uxp.user_id = up.id)))
          WHERE ((up.leaderboard_visible = true) AND (uxp.total_xp > 0))
        )
 SELECT user_id,
    full_name,
    avatar_url,
    total_xp,
    level,
    level_name,
    rank,
    dense_rank,
    (total_xp - lag(total_xp) OVER (ORDER BY rank DESC)) AS xp_diff_from_above,
    (lead(total_xp) OVER (ORDER BY rank DESC) - total_xp) AS xp_to_next_rank
   FROM ranked_users
  ORDER BY rank;


--
-- Name: VIEW leaderboard_global; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.leaderboard_global IS 'Global XP leaderboard with all visible students';


--
-- Name: leaderboard_weekly; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.leaderboard_weekly AS
 WITH weekly_xp AS (
         SELECT xt.user_id,
            up.full_name,
            up.avatar_url,
            date_trunc('week'::text, xt.created_at) AS week_start,
            to_char(date_trunc('week'::text, xt.created_at), 'Mon DD, YYYY'::text) AS week_label,
            sum(xt.amount) AS weekly_xp
           FROM (public.xp_transactions xt
             JOIN public.user_profiles up ON ((up.id = xt.user_id)))
          WHERE ((up.leaderboard_visible = true) AND (xt.created_at >= (CURRENT_DATE - '84 days'::interval)))
          GROUP BY xt.user_id, up.full_name, up.avatar_url, (date_trunc('week'::text, xt.created_at))
        ), ranked_weekly AS (
         SELECT weekly_xp.week_start,
            weekly_xp.week_label,
            weekly_xp.user_id,
            weekly_xp.full_name,
            weekly_xp.avatar_url,
            weekly_xp.weekly_xp,
            rank() OVER (PARTITION BY weekly_xp.week_start ORDER BY weekly_xp.weekly_xp DESC) AS rank,
            count(*) OVER (PARTITION BY weekly_xp.week_start) AS participants
           FROM weekly_xp
          WHERE (weekly_xp.weekly_xp > 0)
        )
 SELECT week_start,
    week_label,
    user_id,
    full_name,
    avatar_url,
    weekly_xp,
    rank,
    participants,
        CASE
            WHEN (week_start = date_trunc('week'::text, (CURRENT_DATE)::timestamp with time zone)) THEN true
            ELSE false
        END AS is_current_week
   FROM ranked_weekly
  ORDER BY week_start DESC, rank;


--
-- Name: VIEW leaderboard_weekly; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.leaderboard_weekly IS 'Weekly XP leaders for past 12 weeks';


--
-- Name: leaderboards; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.leaderboards (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    type public.leaderboard_type NOT NULL,
    scope public.leaderboard_scope NOT NULL,
    period_start timestamp with time zone NOT NULL,
    period_end timestamp with time zone NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: learning_path_courses; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.learning_path_courses (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    path_id uuid NOT NULL,
    course_id uuid NOT NULL,
    sequence integer NOT NULL,
    is_required boolean DEFAULT true NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: learning_paths; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.learning_paths (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    slug text NOT NULL,
    title text NOT NULL,
    description text NOT NULL,
    category text,
    difficulty public.skill_level DEFAULT 'beginner'::public.skill_level NOT NULL,
    duration_estimate_hours integer,
    status public.path_status DEFAULT 'draft'::public.path_status NOT NULL,
    thumbnail_url text,
    created_by uuid,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone
);


--
-- Name: learning_streaks; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.learning_streaks (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    streak_type public.streak_type_enum NOT NULL,
    current_count integer DEFAULT 0 NOT NULL,
    longest_count integer DEFAULT 0 NOT NULL,
    last_activity_date timestamp with time zone,
    streak_started_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: level_definitions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.level_definitions (
    level integer NOT NULL,
    xp_required integer NOT NULL,
    title text NOT NULL,
    badge_url text,
    perks jsonb,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: login_history; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.login_history (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid,
    org_id uuid NOT NULL,
    email character varying(255) NOT NULL,
    success boolean NOT NULL,
    ip_address inet,
    user_agent text,
    failure_reason character varying(100),
    device_info jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE login_history; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.login_history IS 'Tracks user login attempts for security auditing';


--
-- Name: COLUMN login_history.failure_reason; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.login_history.failure_reason IS 'Reason for login failure if success is false';


--
-- Name: marketing_formats; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.marketing_formats (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    profile_id uuid NOT NULL,
    format_type text NOT NULL,
    content text,
    file_url text,
    file_id uuid,
    version integer DEFAULT 1 NOT NULL,
    is_default boolean DEFAULT false,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE marketing_formats; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.marketing_formats IS 'Different format versions of marketing profiles';


--
-- Name: marketing_profiles; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.marketing_profiles (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    consultant_id uuid NOT NULL,
    headline text NOT NULL,
    summary text,
    highlights text[],
    target_roles text[],
    target_industries text[],
    version integer DEFAULT 1 NOT NULL,
    status public.marketing_status DEFAULT 'draft'::public.marketing_status NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid
);


--
-- Name: TABLE marketing_profiles; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.marketing_profiles IS 'Consultant marketing profiles (resumes, bios, highlights)';


--
-- Name: marketing_templates; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.marketing_templates (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    name text NOT NULL,
    format_type text NOT NULL,
    template_content text NOT NULL,
    placeholders jsonb,
    is_active boolean DEFAULT true,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid
);


--
-- Name: TABLE marketing_templates; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.marketing_templates IS 'Reusable marketing templates';


--
-- Name: meeting_notes; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.meeting_notes (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    account_id uuid NOT NULL,
    contact_ids uuid[],
    meeting_type text DEFAULT 'check_in'::text NOT NULL,
    title text NOT NULL,
    description text,
    scheduled_at timestamp with time zone,
    started_at timestamp with time zone,
    ended_at timestamp with time zone,
    duration_minutes integer,
    location_type text DEFAULT 'video'::text,
    location_details text,
    status text DEFAULT 'scheduled'::text NOT NULL,
    agenda text,
    discussion_notes text,
    key_takeaways text[],
    action_items jsonb DEFAULT '[]'::jsonb,
    next_meeting_scheduled timestamp with time zone,
    follow_up_notes text,
    client_satisfaction text,
    client_feedback text,
    related_job_ids uuid[],
    related_candidate_ids uuid[],
    related_escalation_id uuid,
    created_by uuid,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_by uuid,
    deleted_at timestamp with time zone
);


--
-- Name: TABLE meeting_notes; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.meeting_notes IS 'Tracks scheduled and completed client meetings (C05)';


--
-- Name: module_unlock_requirements; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.module_unlock_requirements AS
 SELECT id AS module_id,
    course_id,
    title AS module_title,
    module_number,
    prerequisite_module_ids,
    ( SELECT array_agg(cm2.title) AS array_agg
           FROM public.course_modules cm2
          WHERE (cm2.id = ANY (cm.prerequisite_module_ids))) AS prerequisite_titles,
    ( SELECT array_agg(cm2.module_number) AS array_agg
           FROM public.course_modules cm2
          WHERE (cm2.id = ANY (cm.prerequisite_module_ids))) AS prerequisite_numbers
   FROM public.course_modules cm;


--
-- Name: VIEW module_unlock_requirements; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.module_unlock_requirements IS 'Helper view showing module prerequisites with titles';


--
-- Name: notifications; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.notifications (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    user_id uuid NOT NULL,
    notification_type text NOT NULL,
    title text NOT NULL,
    message text NOT NULL,
    entity_type text,
    entity_id uuid,
    channels text[] DEFAULT ARRAY['in_app'::text],
    email_sent_at timestamp with time zone,
    email_error text,
    slack_sent_at timestamp with time zone,
    slack_error text,
    is_read boolean DEFAULT false,
    read_at timestamp with time zone,
    is_archived boolean DEFAULT false,
    archived_at timestamp with time zone,
    priority text DEFAULT 'normal'::text,
    action_url text,
    action_label text,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE notifications; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.notifications IS 'In-app and email notifications for users';


--
-- Name: object_owners; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.object_owners (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    entity_type text NOT NULL,
    entity_id uuid NOT NULL,
    user_id uuid NOT NULL,
    role text NOT NULL,
    permission text DEFAULT 'view'::text NOT NULL,
    is_primary boolean DEFAULT false,
    assigned_at timestamp with time zone DEFAULT now() NOT NULL,
    assigned_by uuid,
    assignment_type text DEFAULT 'auto'::text,
    notes text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT object_owners_assignment_type_check CHECK ((assignment_type = ANY (ARRAY['auto'::text, 'manual'::text]))),
    CONSTRAINT object_owners_entity_type_check CHECK ((entity_type = ANY (ARRAY['campaign'::text, 'lead'::text, 'deal'::text, 'account'::text, 'job'::text, 'job_order'::text, 'submission'::text, 'contact'::text, 'external_job'::text]))),
    CONSTRAINT object_owners_permission_check CHECK ((permission = ANY (ARRAY['edit'::text, 'view'::text]))),
    CONSTRAINT object_owners_role_check CHECK ((role = ANY (ARRAY['responsible'::text, 'accountable'::text, 'consulted'::text, 'informed'::text])))
);


--
-- Name: TABLE object_owners; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.object_owners IS 'RACI ownership assignments for all business objects';


--
-- Name: offer_approvals; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.offer_approvals (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    offer_id uuid NOT NULL,
    approver_id uuid NOT NULL,
    status text DEFAULT 'pending'::text NOT NULL,
    notes text,
    decided_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone,
    approval_type character varying(30),
    requested_by uuid,
    request_notes text,
    proposed_changes jsonb,
    responded_at timestamp with time zone,
    CONSTRAINT offer_approvals_approval_type_check CHECK (((approval_type)::text = ANY ((ARRAY['rate_change'::character varying, 'terms_change'::character varying, 'low_margin'::character varying, 'extension'::character varying])::text[])))
);


--
-- Name: offer_negotiations; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.offer_negotiations (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    offer_id uuid NOT NULL,
    requested_by text NOT NULL,
    requested_changes text,
    status text DEFAULT 'pending'::text NOT NULL,
    notes text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone,
    initiated_by character varying(20),
    original_terms jsonb,
    proposed_terms jsonb,
    counter_message text,
    CONSTRAINT offer_negotiations_initiated_by_check CHECK (((initiated_by)::text = ANY ((ARRAY['candidate'::character varying, 'client'::character varying, 'recruiter'::character varying])::text[])))
);


--
-- Name: offer_terms; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.offer_terms (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    offer_id uuid NOT NULL,
    term_type text NOT NULL,
    value text,
    description text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone
);


--
-- Name: offers; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.offers (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    submission_id uuid NOT NULL,
    job_id uuid NOT NULL,
    candidate_id uuid NOT NULL,
    offer_type text DEFAULT 'contract'::text,
    rate numeric(10,2) NOT NULL,
    rate_type text DEFAULT 'hourly'::text,
    start_date date,
    end_date date,
    bonus numeric(10,2),
    benefits text,
    relocation_assistance boolean DEFAULT false,
    sign_on_bonus numeric(10,2),
    status text DEFAULT 'draft'::text NOT NULL,
    sent_at timestamp with time zone,
    expires_at timestamp with time zone,
    candidate_counter_offer numeric(10,2),
    negotiation_notes text,
    accepted_at timestamp with time zone,
    declined_at timestamp with time zone,
    decline_reason text,
    offer_letter_file_id uuid,
    signed_offer_file_id uuid,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid,
    org_id uuid NOT NULL,
    pay_rate numeric(10,2),
    bill_rate numeric(10,2),
    overtime_rate numeric(10,2),
    duration_months integer,
    employment_type character varying(20) DEFAULT 'w2'::character varying,
    pto_days integer,
    sick_days integer,
    health_insurance boolean DEFAULT false,
    has_401k boolean DEFAULT false,
    work_location character varying(20) DEFAULT 'remote'::character varying,
    standard_hours_per_week integer DEFAULT 40,
    internal_notes text,
    sent_by uuid,
    accepted_by uuid,
    withdrawn_at timestamp with time zone,
    withdrawal_reason text,
    CONSTRAINT offers_employment_type_check CHECK (((employment_type)::text = ANY ((ARRAY['w2'::character varying, 'c2c'::character varying, '1099'::character varying])::text[]))),
    CONSTRAINT offers_work_location_check CHECK (((work_location)::text = ANY ((ARRAY['remote'::character varying, 'onsite'::character varying, 'hybrid'::character varying])::text[])))
);


--
-- Name: TABLE offers; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.offers IS 'Job offers and negotiations';


--
-- Name: onboarding_checklist; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.onboarding_checklist (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    completed_profile boolean DEFAULT false,
    completed_profile_at timestamp with time zone,
    enrolled_first_course boolean DEFAULT false,
    enrolled_first_course_at timestamp with time zone,
    watched_first_video boolean DEFAULT false,
    watched_first_video_at timestamp with time zone,
    completed_first_quiz boolean DEFAULT false,
    completed_first_quiz_at timestamp with time zone,
    joined_community boolean DEFAULT false,
    joined_community_at timestamp with time zone,
    connected_payment_method boolean DEFAULT false,
    connected_payment_method_at timestamp with time zone,
    set_learning_goals boolean DEFAULT false,
    set_learning_goals_at timestamp with time zone,
    completed_orientation boolean DEFAULT false,
    completed_orientation_at timestamp with time zone,
    total_steps integer GENERATED ALWAYS AS (8) STORED,
    completed_steps integer GENERATED ALWAYS AS ((((((((
CASE
    WHEN completed_profile THEN 1
    ELSE 0
END +
CASE
    WHEN enrolled_first_course THEN 1
    ELSE 0
END) +
CASE
    WHEN watched_first_video THEN 1
    ELSE 0
END) +
CASE
    WHEN completed_first_quiz THEN 1
    ELSE 0
END) +
CASE
    WHEN joined_community THEN 1
    ELSE 0
END) +
CASE
    WHEN connected_payment_method THEN 1
    ELSE 0
END) +
CASE
    WHEN set_learning_goals THEN 1
    ELSE 0
END) +
CASE
    WHEN completed_orientation THEN 1
    ELSE 0
END)) STORED,
    completion_percentage integer GENERATED ALWAYS AS (round(((((((((((
CASE
    WHEN completed_profile THEN 1
    ELSE 0
END +
CASE
    WHEN enrolled_first_course THEN 1
    ELSE 0
END) +
CASE
    WHEN watched_first_video THEN 1
    ELSE 0
END) +
CASE
    WHEN completed_first_quiz THEN 1
    ELSE 0
END) +
CASE
    WHEN joined_community THEN 1
    ELSE 0
END) +
CASE
    WHEN connected_payment_method THEN 1
    ELSE 0
END) +
CASE
    WHEN set_learning_goals THEN 1
    ELSE 0
END) +
CASE
    WHEN completed_orientation THEN 1
    ELSE 0
END))::numeric / (8)::numeric) * (100)::numeric))) STORED,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    completed_at timestamp with time zone
);


--
-- Name: TABLE onboarding_checklist; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.onboarding_checklist IS 'Student onboarding progress tracking';


--
-- Name: onboarding_tasks; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.onboarding_tasks (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    onboarding_id uuid NOT NULL,
    task_name text NOT NULL,
    category public.task_category DEFAULT 'other'::public.task_category NOT NULL,
    description text,
    is_required boolean DEFAULT true,
    due_days_from_start integer,
    status public.task_status DEFAULT 'pending'::public.task_status NOT NULL,
    completed_at timestamp with time zone,
    completed_by uuid,
    notes text,
    sort_order integer DEFAULT 0 NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: org_context_cache; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.org_context_cache (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    context_type text NOT NULL,
    data jsonb NOT NULL,
    expires_at timestamp with time zone DEFAULT (now() + '24:00:00'::interval) NOT NULL,
    refresh_triggered_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT org_context_cache_context_type_check CHECK ((context_type = ANY (ARRAY['priorities'::text, 'metrics'::text, 'pillar_health'::text, 'cross_pollination'::text, 'announcements'::text, 'goals'::text])))
);


--
-- Name: TABLE org_context_cache; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.org_context_cache IS 'Cached shared organizational context';


--
-- Name: org_standups; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.org_standups (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    standup_date date DEFAULT CURRENT_DATE NOT NULL,
    generated_by text DEFAULT 'organization_twin'::text NOT NULL,
    report jsonb NOT NULL,
    pillar_summaries jsonb DEFAULT '{}'::jsonb,
    cross_pollination_insights jsonb DEFAULT '[]'::jsonb,
    escalations jsonb DEFAULT '[]'::jsonb,
    blockers jsonb DEFAULT '[]'::jsonb,
    organism_health_score numeric(5,2),
    tokens_used integer,
    cost_usd numeric(10,6),
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE org_standups; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.org_standups IS 'Daily standup reports generated by OrganizationTwin';


--
-- Name: organizations; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.organizations (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    name text NOT NULL,
    slug text NOT NULL,
    legal_name text,
    email text,
    phone text,
    website text,
    billing_email text,
    tax_id text,
    subscription_tier text DEFAULT 'free'::text NOT NULL,
    subscription_status text DEFAULT 'active'::text NOT NULL,
    max_users integer DEFAULT 5,
    max_candidates integer DEFAULT 100,
    max_storage_gb integer DEFAULT 10,
    features jsonb DEFAULT '{}'::jsonb,
    settings jsonb DEFAULT '{}'::jsonb,
    status text DEFAULT 'active'::text NOT NULL,
    onboarding_completed boolean DEFAULT false,
    onboarding_step text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone,
    timezone text DEFAULT 'America/New_York'::text,
    locale text DEFAULT 'en-US'::text,
    logo_url text,
    favicon_url text,
    plan text DEFAULT 'free'::text,
    metadata jsonb DEFAULT '{}'::jsonb,
    stripe_coupon_id text,
    stripe_customer_id text,
    tier text DEFAULT 'starter'::text,
    industry text,
    health_score integer,
    business_hours_start time without time zone DEFAULT '09:00:00'::time without time zone,
    business_hours_end time without time zone DEFAULT '17:00:00'::time without time zone,
    business_timezone text DEFAULT 'America/New_York'::text,
    holiday_calendar jsonb DEFAULT '[]'::jsonb,
    company_size text,
    founded_year integer,
    primary_color text DEFAULT '#000000'::text,
    secondary_color text DEFAULT '#B76E79'::text,
    background_color text DEFAULT '#FDFBF7'::text,
    text_color text DEFAULT '#171717'::text,
    date_format text DEFAULT 'MM/DD/YYYY'::text,
    time_format text DEFAULT '12h'::text,
    week_start text DEFAULT 'sunday'::text,
    currency text DEFAULT 'USD'::text,
    number_format text DEFAULT '1,234.56'::text,
    fiscal_year_start integer DEFAULT 1,
    reporting_period text DEFAULT 'quarterly'::text,
    sprint_alignment boolean DEFAULT true,
    business_hours jsonb DEFAULT '{"friday": {"end": "17:00", "open": true, "start": "09:00", "break_minutes": 60}, "monday": {"end": "17:00", "open": true, "start": "09:00", "break_minutes": 60}, "sunday": {"open": false}, "tuesday": {"end": "17:00", "open": true, "start": "09:00", "break_minutes": 60}, "saturday": {"open": false}, "thursday": {"end": "17:00", "open": true, "start": "09:00", "break_minutes": 60}, "wednesday": {"end": "17:00", "open": true, "start": "09:00", "break_minutes": 60}}'::jsonb,
    custom_holidays jsonb DEFAULT '[]'::jsonb,
    default_values jsonb DEFAULT '{"job_type": "contract", "job_status": "draft", "work_location": "hybrid", "follow_up_days": 3, "candidate_source": "direct_application", "auto_parse_resume": true, "submission_status": "pending_review", "auto_create_followup": true, "auto_send_client_email": false, "candidate_availability": "2_weeks", "email_signature_location": "below", "include_company_disclaimer": true}'::jsonb,
    contact_info jsonb DEFAULT '{"fax": null, "hr_email": null, "main_phone": null, "linkedin_url": null, "billing_email": null, "general_email": null, "support_email": null, "twitter_handle": null}'::jsonb,
    CONSTRAINT chk_background_color CHECK (((background_color IS NULL) OR (background_color ~ '^#[0-9A-Fa-f]{6}$'::text))),
    CONSTRAINT chk_fiscal_year_start CHECK (((fiscal_year_start >= 1) AND (fiscal_year_start <= 12))),
    CONSTRAINT chk_primary_color CHECK (((primary_color IS NULL) OR (primary_color ~ '^#[0-9A-Fa-f]{6}$'::text))),
    CONSTRAINT chk_secondary_color CHECK (((secondary_color IS NULL) OR (secondary_color ~ '^#[0-9A-Fa-f]{6}$'::text))),
    CONSTRAINT chk_text_color CHECK (((text_color IS NULL) OR (text_color ~ '^#[0-9A-Fa-f]{6}$'::text)))
);


--
-- Name: TABLE organizations; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.organizations IS 'Multi-tenant organizations (staffing companies using InTime)';


--
-- Name: COLUMN organizations.slug; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.organizations.slug IS 'URL-friendly identifier for the organization';


--
-- Name: COLUMN organizations.subscription_tier; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.organizations.subscription_tier IS 'Pricing tier: free, startup, business, enterprise';


--
-- Name: COLUMN organizations.max_users; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.organizations.max_users IS 'Maximum number of users allowed in this organization';


--
-- Name: COLUMN organizations.timezone; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.organizations.timezone IS 'Default timezone (IANA identifier)';


--
-- Name: COLUMN organizations.locale; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.organizations.locale IS 'Default locale for formatting';


--
-- Name: COLUMN organizations.logo_url; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.organizations.logo_url IS 'URL to organization logo image';


--
-- Name: COLUMN organizations.favicon_url; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.organizations.favicon_url IS 'URL to organization favicon';


--
-- Name: COLUMN organizations.industry; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.organizations.industry IS 'Industry classification: IT Staffing, Healthcare, Finance, etc.';


--
-- Name: COLUMN organizations.holiday_calendar; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.organizations.holiday_calendar IS 'Holiday calendar preset: us_federal, us_federal_common, custom';


--
-- Name: COLUMN organizations.company_size; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.organizations.company_size IS 'Company size range: 1-10, 11-50, 51-200, etc.';


--
-- Name: COLUMN organizations.founded_year; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.organizations.founded_year IS 'Year the company was founded';


--
-- Name: COLUMN organizations.primary_color; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.organizations.primary_color IS 'Primary brand color (hex)';


--
-- Name: COLUMN organizations.secondary_color; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.organizations.secondary_color IS 'Secondary/accent brand color (hex)';


--
-- Name: COLUMN organizations.background_color; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.organizations.background_color IS 'Background color for branded pages';


--
-- Name: COLUMN organizations.text_color; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.organizations.text_color IS 'Primary text color';


--
-- Name: COLUMN organizations.date_format; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.organizations.date_format IS 'Date format pattern: MM/DD/YYYY, DD/MM/YYYY, YYYY-MM-DD';


--
-- Name: COLUMN organizations.time_format; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.organizations.time_format IS 'Time format: 12h or 24h';


--
-- Name: COLUMN organizations.week_start; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.organizations.week_start IS 'Week start day: sunday or monday';


--
-- Name: COLUMN organizations.currency; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.organizations.currency IS 'Default currency code (ISO 4217)';


--
-- Name: COLUMN organizations.number_format; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.organizations.number_format IS 'Number format pattern: 1,234.56 or 1.234,56';


--
-- Name: COLUMN organizations.fiscal_year_start; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.organizations.fiscal_year_start IS 'Fiscal year start month (1=January, 12=December)';


--
-- Name: COLUMN organizations.reporting_period; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.organizations.reporting_period IS 'Reporting period type: monthly, quarterly, semi-annual';


--
-- Name: COLUMN organizations.sprint_alignment; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.organizations.sprint_alignment IS 'Whether sprints align with fiscal periods';


--
-- Name: COLUMN organizations.business_hours; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.organizations.business_hours IS 'Business hours per day with start, end, and break times';


--
-- Name: COLUMN organizations.custom_holidays; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.organizations.custom_holidays IS 'Array of custom holidays [{date, name}]';


--
-- Name: COLUMN organizations.default_values; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.organizations.default_values IS 'Default values for new records (jobs, candidates, submissions)';


--
-- Name: COLUMN organizations.contact_info; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.organizations.contact_info IS 'Extended contact information including social media';


--
-- Name: organization_addresses_view; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.organization_addresses_view AS
 SELECT o.id AS organization_id,
    o.name AS organization_name,
    addr.id AS address_id,
    addr.address_type,
    addr.address_line_1,
    addr.address_line_2,
    addr.address_line_3,
    addr.city,
    addr.state_province,
    addr.postal_code,
    addr.country_code,
    addr.county,
    addr.latitude,
    addr.longitude,
    addr.is_verified,
    addr.is_primary,
    addr.effective_from,
    addr.effective_to,
    addr.notes,
    addr.created_at,
    addr.updated_at
   FROM (public.organizations o
     LEFT JOIN public.addresses addr ON (((addr.entity_type = 'organization'::text) AND (addr.entity_id = o.id))));


--
-- Name: VIEW organization_addresses_view; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.organization_addresses_view IS 'View for accessing organization addresses from the unified addresses table';


--
-- Name: organization_branding; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.organization_branding (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    asset_type character varying(50) NOT NULL,
    storage_path text NOT NULL,
    file_name text NOT NULL,
    file_size integer,
    mime_type character varying(100),
    width integer,
    height integer,
    created_at timestamp with time zone DEFAULT now(),
    uploaded_by uuid
);


--
-- Name: TABLE organization_branding; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.organization_branding IS 'Organization branding asset metadata';


--
-- Name: COLUMN organization_branding.asset_type; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.organization_branding.asset_type IS 'Asset type: logo_light, logo_dark, favicon, login_background';


--
-- Name: organization_settings; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.organization_settings (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    key character varying(100) NOT NULL,
    value jsonb DEFAULT '{}'::jsonb NOT NULL,
    category character varying(50) NOT NULL,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    updated_by uuid
);


--
-- Name: TABLE organization_settings; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.organization_settings IS 'Per-organization configuration settings';


--
-- Name: COLUMN organization_settings.category; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.organization_settings.category IS 'Setting category: general, branding, localization, business, compliance';


--
-- Name: path_enrollments; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.path_enrollments (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    path_id uuid NOT NULL,
    status public.enrollment_status DEFAULT 'pending'::public.enrollment_status NOT NULL,
    enrolled_at timestamp with time zone DEFAULT now() NOT NULL,
    completed_at timestamp with time zone,
    progress_percent integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT path_enrollments_progress_percent_check CHECK (((progress_percent >= 0) AND (progress_percent <= 100)))
);


--
-- Name: pattern_checklist_items; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.pattern_checklist_items (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    pattern_id uuid NOT NULL,
    item_text text NOT NULL,
    order_index integer DEFAULT 0,
    is_required boolean DEFAULT false,
    auto_complete_condition jsonb,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE pattern_checklist_items; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.pattern_checklist_items IS 'Checklist items for activity patterns';


--
-- Name: pattern_fields; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.pattern_fields (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    pattern_id uuid NOT NULL,
    field_name text NOT NULL,
    field_label text NOT NULL,
    field_type text NOT NULL,
    is_required boolean DEFAULT false,
    default_value text,
    validation_rules jsonb,
    order_index integer DEFAULT 0,
    placeholder text,
    help_text text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    options jsonb DEFAULT '[]'::jsonb
);


--
-- Name: TABLE pattern_fields; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.pattern_fields IS 'Custom fields configuration for activity patterns';


--
-- Name: payroll_items; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.payroll_items (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    payroll_run_id uuid NOT NULL,
    employee_id uuid NOT NULL,
    base_salary numeric(10,2),
    commission numeric(10,2),
    bonus numeric(10,2),
    overtime_hours numeric(5,2),
    overtime_pay numeric(10,2),
    other_earnings numeric(10,2),
    gross_pay numeric(10,2) NOT NULL,
    taxes_withheld numeric(10,2),
    benefits_deductions numeric(10,2),
    other_deductions numeric(10,2),
    net_pay numeric(10,2) NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE payroll_items; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.payroll_items IS 'Individual employee payroll details';


--
-- Name: payroll_runs; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.payroll_runs (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    period_start_date date NOT NULL,
    period_end_date date NOT NULL,
    pay_date date NOT NULL,
    status text DEFAULT 'draft'::text NOT NULL,
    employee_count integer DEFAULT 0 NOT NULL,
    total_gross_pay numeric(12,2) DEFAULT 0,
    total_taxes numeric(12,2) DEFAULT 0,
    total_net_pay numeric(12,2) DEFAULT 0,
    gusto_payroll_id text,
    processed_at timestamp with time zone,
    processing_error text,
    approved_by uuid,
    approved_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid
);


--
-- Name: TABLE payroll_runs; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.payroll_runs IS 'Bi-weekly payroll cycles';


--
-- Name: peer_reviews; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.peer_reviews (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    submission_id uuid NOT NULL,
    reviewer_id uuid NOT NULL,
    rating integer NOT NULL,
    comments text NOT NULL,
    strengths text,
    improvements text,
    reviewed_at timestamp with time zone DEFAULT now(),
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT peer_reviews_rating_check CHECK (((rating >= 1) AND (rating <= 5)))
);


--
-- Name: TABLE peer_reviews; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.peer_reviews IS 'Peer reviews for capstone submissions';


--
-- Name: peer_review_leaderboard; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.peer_review_leaderboard AS
 SELECT pr.reviewer_id,
    up.full_name AS reviewer_name,
    count(*) AS reviews_completed,
    avg(pr.rating) AS avg_rating_given,
    count(DISTINCT cs.course_id) AS courses_reviewed
   FROM ((public.peer_reviews pr
     JOIN public.user_profiles up ON ((pr.reviewer_id = up.id)))
     JOIN public.capstone_submissions cs ON ((pr.submission_id = cs.id)))
  GROUP BY pr.reviewer_id, up.full_name
  ORDER BY (count(*)) DESC;


--
-- Name: VIEW peer_review_leaderboard; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.peer_review_leaderboard IS 'Top peer reviewers by review count';


--
-- Name: performance_feedback; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.performance_feedback (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    review_id uuid NOT NULL,
    feedback_type public.feedback_type NOT NULL,
    content text NOT NULL,
    category text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid
);


--
-- Name: performance_goals; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.performance_goals (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    employee_id uuid NOT NULL,
    review_id uuid,
    goal text NOT NULL,
    category public.performance_goal_category NOT NULL,
    weight_percent integer,
    status public.goal_status DEFAULT 'not_started'::public.goal_status NOT NULL,
    rating integer,
    comments text,
    start_date date,
    target_date date,
    completed_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid,
    CONSTRAINT performance_goals_rating_check CHECK (((rating >= 1) AND (rating <= 5)))
);


--
-- Name: performance_reviews; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.performance_reviews (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    employee_id uuid NOT NULL,
    reviewer_id uuid NOT NULL,
    review_cycle text NOT NULL,
    review_type text DEFAULT 'annual'::text,
    period_start_date date NOT NULL,
    period_end_date date NOT NULL,
    overall_rating integer,
    quality_of_work integer,
    communication integer,
    teamwork integer,
    initiative integer,
    reliability integer,
    goals_achieved jsonb,
    goals_next_period jsonb,
    strengths text,
    areas_for_improvement text,
    manager_comments text,
    employee_self_assessment text,
    employee_comments text,
    status text DEFAULT 'draft'::text NOT NULL,
    scheduled_date date,
    completed_at timestamp with time zone,
    employee_acknowledged_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT performance_reviews_communication_check CHECK (((communication >= 1) AND (communication <= 5))),
    CONSTRAINT performance_reviews_initiative_check CHECK (((initiative >= 1) AND (initiative <= 5))),
    CONSTRAINT performance_reviews_overall_rating_check CHECK (((overall_rating >= 1) AND (overall_rating <= 5))),
    CONSTRAINT performance_reviews_quality_of_work_check CHECK (((quality_of_work >= 1) AND (quality_of_work <= 5))),
    CONSTRAINT performance_reviews_reliability_check CHECK (((reliability >= 1) AND (reliability <= 5))),
    CONSTRAINT performance_reviews_teamwork_check CHECK (((teamwork >= 1) AND (teamwork <= 5)))
);


--
-- Name: TABLE performance_reviews; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.performance_reviews IS 'Annual and mid-year performance reviews';


--
-- Name: permission_overrides; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.permission_overrides (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    user_id uuid NOT NULL,
    permission_id uuid NOT NULL,
    granted boolean NOT NULL,
    scope_override character varying(50),
    reason text NOT NULL,
    expires_at timestamp with time zone,
    created_by uuid NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    revoked_at timestamp with time zone,
    revoked_by uuid,
    CONSTRAINT permission_overrides_valid_scope CHECK (((scope_override IS NULL) OR ((scope_override)::text = ANY ((ARRAY['own'::character varying, 'own_raci'::character varying, 'own_ra'::character varying, 'team'::character varying, 'region'::character varying, 'org'::character varying, 'draft_only'::character varying])::text[]))))
);


--
-- Name: permissions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.permissions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    code character varying(100) NOT NULL,
    name character varying(100) NOT NULL,
    description text,
    object_type character varying(50) NOT NULL,
    action character varying(20) NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone,
    CONSTRAINT permissions_valid_action CHECK (((action)::text = ANY ((ARRAY['create'::character varying, 'read'::character varying, 'update'::character varying, 'delete'::character varying, 'approve'::character varying, 'reject'::character varying, 'export'::character varying, 'import'::character varying, 'manage'::character varying, 'assign'::character varying, 'send'::character varying, 'issue'::character varying, 'view'::character varying, 'use'::character varying, 'access'::character varying])::text[])))
);


--
-- Name: placements; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.placements (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    submission_id uuid NOT NULL,
    offer_id uuid,
    job_id uuid NOT NULL,
    candidate_id uuid NOT NULL,
    account_id uuid NOT NULL,
    placement_type text DEFAULT 'contract'::text,
    start_date date NOT NULL,
    end_date date,
    bill_rate numeric(10,2) NOT NULL,
    pay_rate numeric(10,2) NOT NULL,
    markup_percentage numeric(5,2) GENERATED ALWAYS AS (round((((bill_rate - pay_rate) / pay_rate) * (100)::numeric), 2)) STORED,
    status text DEFAULT 'active'::text NOT NULL,
    end_reason text,
    actual_end_date date,
    total_revenue numeric(12,2),
    total_paid numeric(12,2),
    onboarding_status text DEFAULT 'pending'::text,
    onboarding_completed_at timestamp with time zone,
    performance_rating integer,
    extension_count integer DEFAULT 0,
    recruiter_id uuid NOT NULL,
    account_manager_id uuid,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid,
    health_status character varying(20) DEFAULT 'healthy'::character varying,
    next_check_in_date date,
    last_check_in_date date,
    last_check_in_by uuid,
    rate_type character varying(20) DEFAULT 'hourly'::character varying,
    employment_type character varying(20) DEFAULT 'w2'::character varying,
    work_location character varying(20) DEFAULT 'remote'::character varying,
    work_schedule character varying(100),
    timezone character varying(50) DEFAULT 'America/New_York'::character varying,
    onboarding_format character varying(20) DEFAULT 'virtual'::character varying,
    first_day_meeting_link text,
    first_day_location text,
    hiring_manager_name character varying(100),
    hiring_manager_email character varying(200),
    hiring_manager_phone character varying(30),
    hr_contact_name character varying(100),
    hr_contact_email character varying(200),
    paperwork_complete boolean DEFAULT false,
    background_check_status character varying(20),
    i9_complete boolean DEFAULT false,
    nda_signed boolean DEFAULT false,
    equipment_ordered boolean DEFAULT false,
    equipment_notes text,
    internal_notes text,
    deleted_at timestamp with time zone,
    contact_id uuid,
    company_id uuid,
    billing_company_id uuid,
    end_client_company_id uuid,
    CONSTRAINT placements_background_check_status_check CHECK (((background_check_status)::text = ANY ((ARRAY['pending'::character varying, 'passed'::character varying, 'failed'::character varying, 'waived'::character varying])::text[]))),
    CONSTRAINT placements_health_status_check CHECK (((health_status)::text = ANY ((ARRAY['healthy'::character varying, 'at_risk'::character varying, 'critical'::character varying])::text[]))),
    CONSTRAINT placements_onboarding_format_check CHECK (((onboarding_format)::text = ANY ((ARRAY['virtual'::character varying, 'in_person'::character varying, 'hybrid'::character varying])::text[]))),
    CONSTRAINT placements_performance_rating_check CHECK (((performance_rating >= 1) AND (performance_rating <= 5)))
);


--
-- Name: TABLE placements; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.placements IS 'Successful hires and active placements';


--
-- Name: COLUMN placements.company_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.placements.company_id IS 'FK to companies table for primary client (replaces account_id)';


--
-- Name: COLUMN placements.billing_company_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.placements.billing_company_id IS 'FK to companies table for billing entity (may differ from primary client)';


--
-- Name: COLUMN placements.end_client_company_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.placements.end_client_company_id IS 'FK to companies table for end client (for MSP arrangements)';


--
-- Name: placement_addresses_view; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.placement_addresses_view AS
 SELECT p.id AS placement_id,
    p.org_id,
    p.status AS placement_status,
    p.start_date,
    addr.id AS address_id,
    addr.address_type,
    addr.address_line_1,
    addr.city,
    addr.state_province,
    addr.notes AS address_notes,
    addr.is_primary
   FROM (public.placements p
     LEFT JOIN public.addresses addr ON (((addr.entity_type = 'placement'::text) AND (addr.entity_id = p.id))));


--
-- Name: VIEW placement_addresses_view; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.placement_addresses_view IS 'View for accessing placement first day locations';


--
-- Name: placement_checkins; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.placement_checkins (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    placement_id uuid NOT NULL,
    checkin_type character varying(20) NOT NULL,
    checkin_date date NOT NULL,
    candidate_contact_method character varying(20),
    candidate_response_status character varying(20),
    candidate_overall_satisfaction character varying(20),
    candidate_role_satisfaction character varying(20),
    candidate_team_relationship character varying(20),
    candidate_workload character varying(20),
    candidate_payment_status character varying(20),
    candidate_extension_interest character varying(30),
    candidate_sentiment character varying(20),
    candidate_concerns text,
    candidate_notes text,
    client_contact_method character varying(20),
    client_contact_id uuid,
    client_performance_rating character varying(20),
    client_team_integration character varying(20),
    client_work_quality character varying(20),
    client_communication character varying(20),
    client_extension_interest character varying(20),
    client_satisfaction character varying(20),
    client_concerns text,
    client_notes text,
    overall_health character varying(20) NOT NULL,
    risk_factors text[],
    action_items jsonb DEFAULT '[]'::jsonb,
    next_checkin_date date,
    follow_up_required character varying(20),
    escalated_to uuid,
    conducted_by uuid NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT placement_checkins_candidate_contact_method_check CHECK (((candidate_contact_method)::text = ANY ((ARRAY['phone'::character varying, 'video'::character varying, 'in_person'::character varying, 'email'::character varying])::text[]))),
    CONSTRAINT placement_checkins_candidate_extension_interest_check CHECK (((candidate_extension_interest)::text = ANY ((ARRAY['definitely_interested'::character varying, 'probably_interested'::character varying, 'unsure'::character varying, 'not_interested'::character varying, 'too_early'::character varying])::text[]))),
    CONSTRAINT placement_checkins_candidate_overall_satisfaction_check CHECK (((candidate_overall_satisfaction)::text = ANY ((ARRAY['excellent'::character varying, 'good'::character varying, 'fair'::character varying, 'poor'::character varying])::text[]))),
    CONSTRAINT placement_checkins_candidate_payment_status_check CHECK (((candidate_payment_status)::text = ANY ((ARRAY['no_issues'::character varying, 'minor_delay'::character varying, 'major_issue'::character varying])::text[]))),
    CONSTRAINT placement_checkins_candidate_response_status_check CHECK (((candidate_response_status)::text = ANY ((ARRAY['completed'::character varying, 'scheduled'::character varying, 'left_message'::character varying, 'no_response'::character varying])::text[]))),
    CONSTRAINT placement_checkins_candidate_role_satisfaction_check CHECK (((candidate_role_satisfaction)::text = ANY ((ARRAY['very_satisfied'::character varying, 'satisfied'::character varying, 'neutral'::character varying, 'unsatisfied'::character varying])::text[]))),
    CONSTRAINT placement_checkins_candidate_sentiment_check CHECK (((candidate_sentiment)::text = ANY ((ARRAY['very_positive'::character varying, 'positive'::character varying, 'neutral'::character varying, 'negative'::character varying])::text[]))),
    CONSTRAINT placement_checkins_candidate_team_relationship_check CHECK (((candidate_team_relationship)::text = ANY ((ARRAY['excellent'::character varying, 'good'::character varying, 'fair'::character varying, 'poor'::character varying])::text[]))),
    CONSTRAINT placement_checkins_candidate_workload_check CHECK (((candidate_workload)::text = ANY ((ARRAY['just_right'::character varying, 'a_bit_much'::character varying, 'too_much'::character varying, 'too_little'::character varying])::text[]))),
    CONSTRAINT placement_checkins_checkin_type_check CHECK (((checkin_type)::text = ANY ((ARRAY['7_day'::character varying, '30_day'::character varying, '60_day'::character varying, '90_day'::character varying, 'ad_hoc'::character varying])::text[]))),
    CONSTRAINT placement_checkins_client_communication_check CHECK (((client_communication)::text = ANY ((ARRAY['excellent'::character varying, 'good'::character varying, 'fair'::character varying, 'poor'::character varying])::text[]))),
    CONSTRAINT placement_checkins_client_contact_method_check CHECK (((client_contact_method)::text = ANY ((ARRAY['phone'::character varying, 'video'::character varying, 'in_person'::character varying, 'email'::character varying])::text[]))),
    CONSTRAINT placement_checkins_client_extension_interest_check CHECK (((client_extension_interest)::text = ANY ((ARRAY['definitely'::character varying, 'probably'::character varying, 'unsure'::character varying, 'probably_not'::character varying])::text[]))),
    CONSTRAINT placement_checkins_client_performance_rating_check CHECK (((client_performance_rating)::text = ANY ((ARRAY['exceeds'::character varying, 'meets'::character varying, 'below'::character varying, 'not_meeting'::character varying])::text[]))),
    CONSTRAINT placement_checkins_client_satisfaction_check CHECK (((client_satisfaction)::text = ANY ((ARRAY['very_satisfied'::character varying, 'satisfied'::character varying, 'neutral'::character varying, 'unsatisfied'::character varying])::text[]))),
    CONSTRAINT placement_checkins_client_team_integration_check CHECK (((client_team_integration)::text = ANY ((ARRAY['excellent'::character varying, 'good'::character varying, 'fair'::character varying, 'poor'::character varying])::text[]))),
    CONSTRAINT placement_checkins_client_work_quality_check CHECK (((client_work_quality)::text = ANY ((ARRAY['excellent'::character varying, 'good'::character varying, 'fair'::character varying, 'poor'::character varying])::text[]))),
    CONSTRAINT placement_checkins_follow_up_required_check CHECK (((follow_up_required)::text = ANY ((ARRAY['none'::character varying, 'scheduled'::character varying, 'escalate'::character varying])::text[]))),
    CONSTRAINT placement_checkins_overall_health_check CHECK (((overall_health)::text = ANY ((ARRAY['excellent'::character varying, 'good'::character varying, 'at_risk'::character varying, 'critical'::character varying])::text[])))
);


--
-- Name: placement_credits; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.placement_credits (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    pod_id uuid NOT NULL,
    sprint_number integer NOT NULL,
    sprint_start_date date NOT NULL,
    sprint_end_date date NOT NULL,
    placement_id uuid NOT NULL,
    placement_date date NOT NULL,
    credit_amount numeric(4,2) DEFAULT 1.0 NOT NULL,
    senior_rec_id uuid,
    junior_rec_id uuid,
    bill_rate numeric(10,2),
    pay_rate numeric(10,2),
    margin_percentage numeric(5,2),
    estimated_revenue numeric(14,2),
    source_pillar text DEFAULT 'recruiting'::text NOT NULL,
    original_lead_id uuid,
    original_campaign_id uuid,
    original_graduate_id uuid,
    is_verified boolean DEFAULT false,
    verified_at timestamp with time zone,
    verified_by uuid,
    notes text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid
);


--
-- Name: TABLE placement_credits; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.placement_credits IS 'Tracks placements credited to pods for productivity metrics. Target: 2 credits per pod per sprint.';


--
-- Name: COLUMN placement_credits.credit_amount; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.placement_credits.credit_amount IS 'Full credit = 1.0, Split credit = 0.5 when multiple pods involved';


--
-- Name: COLUMN placement_credits.source_pillar; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.placement_credits.source_pillar IS 'Origin pillar for cross-pollination tracking: recruiting, bench_sales, training_academy, talent_acquisition, cross_border';


--
-- Name: placement_extensions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.placement_extensions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    placement_id uuid NOT NULL,
    previous_end_date date NOT NULL,
    new_end_date date NOT NULL,
    reason text,
    approved_by uuid,
    approved_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone,
    original_end_date date,
    extension_months integer,
    new_pay_rate numeric(10,2),
    new_bill_rate numeric(10,2),
    notes text
);


--
-- Name: placement_milestones; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.placement_milestones (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    placement_id uuid NOT NULL,
    milestone_type text NOT NULL,
    due_date date,
    completed_at timestamp with time zone,
    notes text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone,
    status character varying(20) DEFAULT 'pending'::character varying,
    completed_date date,
    CONSTRAINT placement_milestones_status_check CHECK (((status)::text = ANY ((ARRAY['pending'::character varying, 'completed'::character varying, 'skipped'::character varying])::text[])))
);


--
-- Name: placement_rates; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.placement_rates (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    placement_id uuid NOT NULL,
    bill_rate numeric(10,2) NOT NULL,
    pay_rate numeric(10,2) NOT NULL,
    margin_percent numeric(5,2),
    effective_from date NOT NULL,
    effective_to date,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone,
    rate_type character varying(20) DEFAULT 'regular'::character varying,
    effective_date date,
    CONSTRAINT placement_rates_rate_type_check CHECK (((rate_type)::text = ANY ((ARRAY['regular'::character varying, 'overtime'::character varying, 'holiday'::character varying])::text[])))
);


--
-- Name: placement_timesheets; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.placement_timesheets (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    placement_id uuid NOT NULL,
    week_ending date NOT NULL,
    regular_hours numeric(5,2) DEFAULT 0,
    overtime_hours numeric(5,2) DEFAULT 0,
    status text DEFAULT 'draft'::text NOT NULL,
    submitted_at timestamp with time zone,
    approved_by uuid,
    approved_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone
);


--
-- Name: pod_managers; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.pod_managers (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    pod_id uuid NOT NULL,
    user_id uuid NOT NULL,
    is_primary boolean DEFAULT true,
    assigned_at timestamp with time zone DEFAULT now() NOT NULL,
    assigned_by uuid,
    removed_at timestamp with time zone,
    removed_by uuid,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE pod_managers; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.pod_managers IS 'Historical record of pod manager assignments';


--
-- Name: pod_members; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.pod_members (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    pod_id uuid NOT NULL,
    user_id uuid NOT NULL,
    role text NOT NULL,
    joined_at timestamp with time zone DEFAULT now() NOT NULL,
    left_at timestamp with time zone,
    is_active boolean DEFAULT true,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT pod_members_role_check CHECK ((role = ANY (ARRAY['senior'::text, 'junior'::text])))
);


--
-- Name: pod_sprint_metrics; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.pod_sprint_metrics (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    pod_id uuid NOT NULL,
    sprint_number integer NOT NULL,
    sprint_start_date date NOT NULL,
    sprint_end_date date NOT NULL,
    placements_target integer DEFAULT 2,
    placements_stretch_target integer DEFAULT 3,
    submissions_target integer DEFAULT 20,
    submissions_stretch_target integer DEFAULT 30,
    client_meetings_target integer DEFAULT 5,
    new_candidates_target integer DEFAULT 30,
    placements_actual integer DEFAULT 0,
    submissions_actual integer DEFAULT 0,
    client_meetings_actual integer DEFAULT 0,
    new_candidates_actual integer DEFAULT 0,
    target_achievement_pct numeric(5,2) GENERATED ALWAYS AS (
CASE
    WHEN (placements_target > 0) THEN round((((placements_actual)::numeric / (placements_target)::numeric) * (100)::numeric), 2)
    ELSE (0)::numeric
END) STORED,
    status text DEFAULT 'active'::text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT pod_sprint_metrics_status_check CHECK ((status = ANY (ARRAY['active'::text, 'completed'::text, 'cancelled'::text])))
);


--
-- Name: TABLE pod_sprint_metrics; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.pod_sprint_metrics IS 'Sprint-based performance metrics for pods';


--
-- Name: pods; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.pods (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    name text NOT NULL,
    pod_type text NOT NULL,
    senior_member_id uuid,
    junior_member_id uuid,
    sprint_duration_weeks integer DEFAULT 2,
    placements_per_sprint_target integer DEFAULT 2,
    total_placements integer DEFAULT 0,
    current_sprint_placements integer DEFAULT 0,
    current_sprint_start_date date,
    average_placements_per_sprint numeric(5,2),
    is_active boolean DEFAULT true,
    formed_date date,
    dissolved_date date,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid,
    region_id uuid,
    status text DEFAULT 'active'::text,
    deleted_at timestamp with time zone,
    manager_id uuid,
    description text,
    sprint_start_day text DEFAULT 'monday'::text,
    send_sprint_summary boolean DEFAULT true,
    send_midpoint_check boolean DEFAULT true,
    alert_if_below_target boolean DEFAULT true,
    CONSTRAINT pods_pod_type_check CHECK ((pod_type = ANY (ARRAY['recruiting'::text, 'bench_sales'::text, 'ta'::text, 'hr'::text, 'mixed'::text]))),
    CONSTRAINT pods_sprint_start_day_check CHECK ((sprint_start_day = ANY (ARRAY['monday'::text, 'tuesday'::text, 'wednesday'::text, 'thursday'::text, 'friday'::text, 'saturday'::text, 'sunday'::text])))
);


--
-- Name: TABLE pods; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.pods IS '2-person team structure with sprint goals';


--
-- Name: COLUMN pods.manager_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.pods.manager_id IS 'Current primary manager of the pod';


--
-- Name: COLUMN pods.sprint_start_day; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.pods.sprint_start_day IS 'Day of week when sprints begin';


--
-- Name: pricing_plans; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.pricing_plans (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    name text NOT NULL,
    description text,
    slug text NOT NULL,
    plan_type text NOT NULL,
    price_monthly numeric(10,2),
    price_annual numeric(10,2),
    price_one_time numeric(10,2),
    stripe_price_id_monthly text,
    stripe_price_id_annual text,
    stripe_price_id_one_time text,
    stripe_product_id text,
    features jsonb DEFAULT '[]'::jsonb,
    max_courses integer,
    max_users integer,
    display_order integer DEFAULT 0,
    is_featured boolean DEFAULT false,
    badge_text text,
    is_active boolean DEFAULT true,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    deleted_at timestamp with time zone,
    CONSTRAINT pricing_plans_plan_type_check CHECK ((plan_type = ANY (ARRAY['per_course'::text, 'all_access'::text, 'team'::text, 'enterprise'::text])))
);


--
-- Name: TABLE pricing_plans; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.pricing_plans IS 'ACAD-029: Pricing plan configurations for courses and subscriptions';


--
-- Name: productivity_reports; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.productivity_reports (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    date date NOT NULL,
    summary text NOT NULL,
    productive_hours double precision NOT NULL,
    top_activities jsonb DEFAULT '[]'::jsonb NOT NULL,
    insights jsonb DEFAULT '[]'::jsonb NOT NULL,
    recommendations jsonb DEFAULT '[]'::jsonb NOT NULL,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE productivity_reports; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.productivity_reports IS 'AI-generated daily productivity timelines for employees';


--
-- Name: COLUMN productivity_reports.summary; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.productivity_reports.summary IS 'Narrative daily summary generated by AI';


--
-- Name: COLUMN productivity_reports.productive_hours; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.productivity_reports.productive_hours IS 'Total productive hours calculated from screenshots';


--
-- Name: COLUMN productivity_reports.top_activities; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.productivity_reports.top_activities IS 'Top 3 activities as JSON array';


--
-- Name: COLUMN productivity_reports.insights; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.productivity_reports.insights IS 'AI-generated insights as JSON array';


--
-- Name: COLUMN productivity_reports.recommendations; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.productivity_reports.recommendations IS 'AI-generated recommendations as JSON array';


--
-- Name: project_timeline; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.project_timeline (
    id uuid DEFAULT extensions.uuid_generate_v4() NOT NULL,
    session_id character varying(50) NOT NULL,
    session_date timestamp with time zone DEFAULT now() NOT NULL,
    agent_type character varying(50),
    agent_model character varying(100),
    duration character varying(50),
    conversation_summary text NOT NULL,
    user_intent text,
    actions_taken jsonb DEFAULT '{"blocked": [], "completed": [], "inProgress": []}'::jsonb,
    files_changed jsonb DEFAULT '{"created": [], "deleted": [], "modified": []}'::jsonb,
    decisions jsonb DEFAULT '[]'::jsonb,
    assumptions jsonb DEFAULT '[]'::jsonb,
    results jsonb DEFAULT '{"status": "success", "metrics": {}, "summary": "", "artifacts": []}'::jsonb,
    future_notes jsonb DEFAULT '[]'::jsonb,
    related_commits text[],
    related_prs text[],
    related_docs text[],
    tags text[],
    ai_generated_summary text,
    key_learnings text[],
    search_vector tsvector,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    deleted_at timestamp with time zone,
    is_archived boolean DEFAULT false,
    org_id uuid NOT NULL
);


--
-- Name: COLUMN project_timeline.org_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.project_timeline.org_id IS 'Organization this timeline entry belongs to';


--
-- Name: pto_balances; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.pto_balances (
    employee_id uuid NOT NULL,
    year integer NOT NULL,
    annual_accrual_days numeric(5,2) DEFAULT 15.0,
    accrual_rate_per_pay_period numeric(5,2),
    total_accrued numeric(5,2) DEFAULT 0,
    total_used numeric(5,2) DEFAULT 0,
    total_pending numeric(5,2) DEFAULT 0,
    current_balance numeric(5,2) GENERATED ALWAYS AS (((total_accrued - total_used) - total_pending)) STORED,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE pto_balances; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.pto_balances IS 'PTO accrual and balance tracking by year';


--
-- Name: question_bank_stats; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.question_bank_stats AS
SELECT
    NULL::uuid AS question_id,
    NULL::uuid AS topic_id,
    NULL::text AS question_text,
    NULL::text AS question_type,
    NULL::text AS difficulty,
    NULL::integer AS points,
    NULL::boolean AS is_public,
    NULL::uuid AS created_by,
    NULL::text AS created_by_name,
    NULL::bigint AS times_used,
    NULL::bigint AS unique_students,
    NULL::numeric AS avg_correct_percentage,
    NULL::timestamp with time zone AS created_at,
    NULL::timestamp with time zone AS updated_at;


--
-- Name: VIEW question_bank_stats; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.question_bank_stats IS 'Statistics and analytics for questions in the question bank';


--
-- Name: queue_items; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.queue_items (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    queue_id uuid NOT NULL,
    entity_type text NOT NULL,
    entity_id uuid NOT NULL,
    priority integer DEFAULT 0,
    order_index integer DEFAULT 0,
    assigned_to uuid,
    assigned_at timestamp with time zone,
    status text DEFAULT 'queued'::text,
    enqueued_at timestamp with time zone DEFAULT now() NOT NULL,
    started_at timestamp with time zone,
    completed_at timestamp with time zone,
    removed_at timestamp with time zone,
    metadata jsonb
);


--
-- Name: TABLE queue_items; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.queue_items IS 'Items in work queues';


--
-- Name: quiz_analytics; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.quiz_analytics AS
SELECT
    NULL::uuid AS topic_id,
    NULL::text AS topic_title,
    NULL::uuid AS module_id,
    NULL::text AS module_title,
    NULL::uuid AS course_id,
    NULL::text AS course_title,
    NULL::bigint AS total_questions,
    NULL::bigint AS easy_questions,
    NULL::bigint AS medium_questions,
    NULL::bigint AS hard_questions,
    NULL::bigint AS total_attempts,
    NULL::bigint AS unique_students,
    NULL::bigint AS passed_attempts,
    NULL::numeric AS avg_score,
    NULL::numeric AS avg_time_seconds,
    NULL::double precision AS pass_rate;


--
-- Name: VIEW quiz_analytics; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.quiz_analytics IS 'Aggregated quiz performance metrics per topic';


--
-- Name: quiz_attempts; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.quiz_attempts (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    topic_id uuid NOT NULL,
    enrollment_id uuid NOT NULL,
    attempt_number integer DEFAULT 1 NOT NULL,
    started_at timestamp with time zone DEFAULT now() NOT NULL,
    submitted_at timestamp with time zone,
    time_taken_seconds integer,
    answers jsonb,
    total_questions integer NOT NULL,
    correct_answers integer,
    score numeric(5,2),
    passed boolean,
    xp_earned integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT quiz_attempts_attempt_number_check CHECK ((attempt_number > 0)),
    CONSTRAINT quiz_attempts_correct_answers_check CHECK ((correct_answers >= 0)),
    CONSTRAINT quiz_attempts_score_check CHECK (((score >= (0)::numeric) AND (score <= (100)::numeric))),
    CONSTRAINT quiz_attempts_total_questions_check CHECK ((total_questions > 0))
);


--
-- Name: TABLE quiz_attempts; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.quiz_attempts IS 'Student quiz attempts with answers and scoring';


--
-- Name: COLUMN quiz_attempts.answers; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.quiz_attempts.answers IS 'JSONB object mapping question IDs to selected answer indices';


--
-- Name: quiz_questions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.quiz_questions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    topic_id uuid,
    created_by uuid NOT NULL,
    question_text text NOT NULL,
    question_type text NOT NULL,
    options jsonb NOT NULL,
    correct_answers jsonb NOT NULL,
    explanation text,
    difficulty text DEFAULT 'medium'::text NOT NULL,
    points integer DEFAULT 1 NOT NULL,
    code_language text,
    is_public boolean DEFAULT false NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT quiz_questions_difficulty_check CHECK ((difficulty = ANY (ARRAY['easy'::text, 'medium'::text, 'hard'::text]))),
    CONSTRAINT quiz_questions_points_check CHECK ((points > 0)),
    CONSTRAINT quiz_questions_question_text_check CHECK ((length(question_text) >= 10)),
    CONSTRAINT quiz_questions_question_type_check CHECK ((question_type = ANY (ARRAY['multiple_choice_single'::text, 'multiple_choice_multiple'::text, 'true_false'::text, 'code'::text])))
);


--
-- Name: TABLE quiz_questions; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.quiz_questions IS 'Reusable quiz questions with multiple question types';


--
-- Name: COLUMN quiz_questions.options; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.quiz_questions.options IS 'Array of option strings stored as JSONB';


--
-- Name: COLUMN quiz_questions.correct_answers; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.quiz_questions.correct_answers IS 'Array of indices pointing to correct options in the options array';


--
-- Name: quiz_settings; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.quiz_settings (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    topic_id uuid NOT NULL,
    randomize_questions boolean DEFAULT false NOT NULL,
    randomize_options boolean DEFAULT false NOT NULL,
    passing_threshold integer DEFAULT 70 NOT NULL,
    show_correct_answers boolean DEFAULT true NOT NULL,
    time_limit_minutes integer,
    max_attempts integer,
    allow_review boolean DEFAULT true NOT NULL,
    xp_reward integer DEFAULT 10 NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT quiz_settings_max_attempts_check CHECK ((max_attempts > 0)),
    CONSTRAINT quiz_settings_passing_threshold_check CHECK (((passing_threshold >= 0) AND (passing_threshold <= 100))),
    CONSTRAINT quiz_settings_time_limit_minutes_check CHECK ((time_limit_minutes > 0)),
    CONSTRAINT quiz_settings_xp_reward_check CHECK ((xp_reward >= 0))
);


--
-- Name: TABLE quiz_settings; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.quiz_settings IS 'Quiz configuration and settings per topic';


--
-- Name: raci_change_log; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.raci_change_log (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    object_owner_id uuid,
    entity_type text NOT NULL,
    entity_id uuid NOT NULL,
    change_type text NOT NULL,
    previous_role text,
    new_role text,
    previous_user_id uuid,
    new_user_id uuid,
    previous_permission text,
    new_permission text,
    changed_by uuid,
    reason text,
    changed_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT raci_change_log_change_type_check CHECK ((change_type = ANY (ARRAY['assigned'::text, 'role_changed'::text, 'permission_changed'::text, 'removed'::text, 'transferred'::text])))
);


--
-- Name: TABLE raci_change_log; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.raci_change_log IS 'Audit trail for RACI ownership changes';


--
-- Name: rare_achievements; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.rare_achievements AS
 SELECT b.id AS badge_id,
    b.name AS badge_name,
    b.rarity,
    count(ub.id) AS earner_count,
    (((count(DISTINCT ub.user_id))::numeric / (NULLIF(( SELECT count(DISTINCT user_badges.user_id) AS count
           FROM public.user_badges), 0))::numeric) * (100)::numeric) AS earner_percentage
   FROM (public.badges b
     LEFT JOIN public.user_badges ub ON ((ub.badge_id = b.id)))
  GROUP BY b.id, b.name, b.rarity
 HAVING ((((count(DISTINCT ub.user_id))::numeric / (NULLIF(( SELECT count(DISTINCT user_badges.user_id) AS count
           FROM public.user_badges), 0))::numeric) * (100)::numeric) <= 1.0)
  ORDER BY (((count(DISTINCT ub.user_id))::numeric / (NULLIF(( SELECT count(DISTINCT user_badges.user_id) AS count
           FROM public.user_badges), 0))::numeric) * (100)::numeric);


--
-- Name: VIEW rare_achievements; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.rare_achievements IS 'Badges earned by less than 1% of users';


--
-- Name: reading_progress; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.reading_progress (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    topic_id uuid NOT NULL,
    enrollment_id uuid NOT NULL,
    scroll_percentage integer DEFAULT 0 NOT NULL,
    last_scroll_position integer DEFAULT 0,
    total_reading_time_seconds integer DEFAULT 0 NOT NULL,
    current_page integer,
    total_pages integer,
    content_type text,
    content_length integer,
    session_count integer DEFAULT 1 NOT NULL,
    last_read_at timestamp with time zone DEFAULT now(),
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT valid_content_type CHECK ((content_type = ANY (ARRAY['markdown'::text, 'pdf'::text, 'html'::text]))),
    CONSTRAINT valid_page CHECK (((current_page IS NULL) OR (current_page > 0))),
    CONSTRAINT valid_reading_time CHECK ((total_reading_time_seconds >= 0)),
    CONSTRAINT valid_scroll_percentage CHECK (((scroll_percentage >= 0) AND (scroll_percentage <= 100))),
    CONSTRAINT valid_scroll_position CHECK ((last_scroll_position >= 0))
);


--
-- Name: TABLE reading_progress; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.reading_progress IS 'Tracks reading progress for articles, PDFs, and documents';


--
-- Name: COLUMN reading_progress.scroll_percentage; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.reading_progress.scroll_percentage IS 'Percentage of content scrolled (0-100)';


--
-- Name: COLUMN reading_progress.last_scroll_position; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.reading_progress.last_scroll_position IS 'Last scroll position in pixels for resume';


--
-- Name: COLUMN reading_progress.current_page; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.reading_progress.current_page IS 'Current page number for PDFs';


--
-- Name: COLUMN reading_progress.session_count; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.reading_progress.session_count IS 'Number of times user read this content';


--
-- Name: reading_stats; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.reading_stats AS
 SELECT rp.user_id,
    rp.topic_id,
    rp.enrollment_id,
    mt.title AS topic_title,
    cm.title AS module_title,
    c.title AS course_title,
    rp.scroll_percentage,
    rp.total_reading_time_seconds,
    rp.session_count,
    rp.last_read_at,
    rp.content_type,
    rp.current_page,
    rp.total_pages,
        CASE
            WHEN (rp.scroll_percentage >= 90) THEN 100
            WHEN (rp.scroll_percentage >= 75) THEN 85
            WHEN (rp.scroll_percentage >= 50) THEN 70
            WHEN (rp.scroll_percentage >= 25) THEN 50
            ELSE 25
        END AS engagement_score
   FROM (((public.reading_progress rp
     JOIN public.module_topics mt ON ((mt.id = rp.topic_id)))
     JOIN public.course_modules cm ON ((cm.id = mt.module_id)))
     JOIN public.courses c ON ((c.id = cm.course_id)));


--
-- Name: regions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.regions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    name text NOT NULL,
    code text,
    country text,
    timezone text DEFAULT 'America/New_York'::text,
    manager_id uuid,
    is_active boolean DEFAULT true,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid,
    deleted_at timestamp with time zone
);


--
-- Name: requisition_embeddings; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.requisition_embeddings (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    requisition_id uuid NOT NULL,
    embedding public.vector(1536),
    description text NOT NULL,
    required_skills text[],
    nice_to_have_skills text[],
    experience_level text,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT requisition_embeddings_experience_level_check CHECK ((experience_level = ANY (ARRAY['entry'::text, 'mid'::text, 'senior'::text])))
);


--
-- Name: TABLE requisition_embeddings; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.requisition_embeddings IS 'Semantic embeddings for job requisitions (resume matching AI-MATCH-001)';


--
-- Name: COLUMN requisition_embeddings.embedding; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.requisition_embeddings.embedding IS 'pgvector embedding of job description + requirements';


--
-- Name: resume_matches; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.resume_matches (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    requisition_id uuid NOT NULL,
    candidate_id uuid NOT NULL,
    match_score integer,
    reasoning text,
    skills_matched text[],
    skills_missing text[],
    skills_score integer,
    experience_score integer,
    project_score integer,
    availability_score integer,
    recruiter_feedback text,
    is_relevant boolean,
    submitted boolean DEFAULT false,
    interview_scheduled boolean DEFAULT false,
    placement_achieved boolean DEFAULT false,
    model_used text,
    tokens_used integer,
    cost_usd numeric(10,6),
    search_latency_ms integer,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT resume_matches_availability_score_check CHECK (((availability_score >= 0) AND (availability_score <= 100))),
    CONSTRAINT resume_matches_experience_score_check CHECK (((experience_score >= 0) AND (experience_score <= 100))),
    CONSTRAINT resume_matches_match_score_check CHECK (((match_score >= 0) AND (match_score <= 100))),
    CONSTRAINT resume_matches_project_score_check CHECK (((project_score >= 0) AND (project_score <= 100))),
    CONSTRAINT resume_matches_skills_score_check CHECK (((skills_score >= 0) AND (skills_score <= 100)))
);


--
-- Name: TABLE resume_matches; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.resume_matches IS 'Resume matching history and outcomes (AI-MATCH-001)';


--
-- Name: COLUMN resume_matches.match_score; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.resume_matches.match_score IS 'Overall match score 0-100 (weighted sum of component scores)';


--
-- Name: COLUMN resume_matches.is_relevant; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.resume_matches.is_relevant IS 'Recruiter feedback: Was this match relevant? Used for accuracy calculation';


--
-- Name: resume_versions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.resume_versions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    student_id uuid NOT NULL,
    version integer DEFAULT 1 NOT NULL,
    format text NOT NULL,
    content jsonb NOT NULL,
    ats_score integer DEFAULT 0 NOT NULL,
    keyword_matches text[] DEFAULT '{}'::text[] NOT NULL,
    target_job_description text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT resume_versions_ats_score_check CHECK (((ats_score >= 0) AND (ats_score <= 100))),
    CONSTRAINT resume_versions_format_check CHECK ((format = ANY (ARRAY['pdf'::text, 'docx'::text, 'linkedin'::text, 'json'::text])))
);


--
-- Name: TABLE resume_versions; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.resume_versions IS 'Stores resume versions with ATS optimization scores';


--
-- Name: COLUMN resume_versions.ats_score; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.resume_versions.ats_score IS 'ATS optimization score 0-100 based on keyword matching';


--
-- Name: retention_policies; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.retention_policies (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    entity_type character varying(50) NOT NULL,
    policy_name character varying(100) NOT NULL,
    is_active boolean DEFAULT true,
    retention_days integer NOT NULL,
    archive_after_days integer,
    delete_after_archive_days integer,
    status_filter text[],
    additional_conditions jsonb DEFAULT '{}'::jsonb,
    created_by uuid NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE retention_policies; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.retention_policies IS 'Configurable data retention policies per entity type';


--
-- Name: revenue_analytics; Type: MATERIALIZED VIEW; Schema: public; Owner: -
--

CREATE MATERIALIZED VIEW public.revenue_analytics AS
 SELECT date_trunc('month'::text, pt.created_at) AS month,
    sum(
        CASE
            WHEN ((pt.status = 'succeeded'::text) AND (se.payment_type = 'subscription'::text)) THEN pt.amount
            ELSE (0)::numeric
        END) AS mrr,
    sum(
        CASE
            WHEN (pt.status = 'succeeded'::text) THEN pt.amount
            ELSE (0)::numeric
        END) AS total_revenue,
    sum(
        CASE
            WHEN ((pt.status = 'succeeded'::text) AND (se.payment_type = 'one_time'::text)) THEN pt.amount
            ELSE (0)::numeric
        END) AS one_time_revenue,
    count(DISTINCT se.id) AS total_enrollments,
    count(DISTINCT
        CASE
            WHEN ((se.status = 'active'::text) AND (se.payment_type = 'subscription'::text)) THEN se.id
            ELSE NULL::uuid
        END) AS active_subscriptions,
    count(DISTINCT
        CASE
            WHEN ((se.payment_type = 'subscription'::text) AND (date_trunc('month'::text, se.enrolled_at) = date_trunc('month'::text, pt.created_at))) THEN se.id
            ELSE NULL::uuid
        END) AS new_subscriptions,
    count(DISTINCT
        CASE
            WHEN ((se.status = ANY (ARRAY['dropped'::text, 'expired'::text])) AND (se.payment_type = 'subscription'::text) AND (date_trunc('month'::text, se.updated_at) = date_trunc('month'::text, pt.created_at))) THEN se.id
            ELSE NULL::uuid
        END) AS churned_subscriptions,
    count(
        CASE
            WHEN (pt.status = 'succeeded'::text) THEN 1
            ELSE NULL::integer
        END) AS successful_payments,
    count(
        CASE
            WHEN (pt.status = 'failed'::text) THEN 1
            ELSE NULL::integer
        END) AS failed_payments,
    count(
        CASE
            WHEN (pt.status = 'refunded'::text) THEN 1
            ELSE NULL::integer
        END) AS refunded_payments,
    sum(
        CASE
            WHEN (pt.status = 'refunded'::text) THEN pt.amount
            ELSE (0)::numeric
        END) AS refund_amount,
    avg(
        CASE
            WHEN (pt.status = 'succeeded'::text) THEN pt.amount
            ELSE NULL::numeric
        END) AS avg_revenue_per_enrollment,
    count(DISTINCT pt.user_id) AS unique_paying_students
   FROM (public.payment_transactions pt
     JOIN public.student_enrollments se ON ((se.id = pt.enrollment_id)))
  GROUP BY (date_trunc('month'::text, pt.created_at))
  WITH NO DATA;


--
-- Name: MATERIALIZED VIEW revenue_analytics; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON MATERIALIZED VIEW public.revenue_analytics IS 'ACAD-030: Monthly revenue analytics aggregation';


--
-- Name: role_permissions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.role_permissions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    role_id uuid NOT NULL,
    permission_id uuid NOT NULL,
    scope_condition character varying(50) DEFAULT 'own'::character varying,
    granted boolean DEFAULT true,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    granted_by uuid,
    CONSTRAINT role_permissions_valid_scope CHECK (((scope_condition)::text = ANY ((ARRAY['own'::character varying, 'own_raci'::character varying, 'own_ra'::character varying, 'team'::character varying, 'region'::character varying, 'org'::character varying, 'draft_only'::character varying])::text[])))
);


--
-- Name: saved_searches; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.saved_searches (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    user_id uuid NOT NULL,
    entity_type text DEFAULT 'candidate'::text NOT NULL,
    name text NOT NULL,
    description text,
    filters jsonb DEFAULT '{}'::jsonb NOT NULL,
    is_default boolean DEFAULT false,
    is_shared boolean DEFAULT false,
    email_alerts boolean DEFAULT false,
    alert_frequency text DEFAULT 'daily'::text,
    result_count integer,
    last_executed_at timestamp with time zone,
    execution_count integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone
);


--
-- Name: TABLE saved_searches; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.saved_searches IS 'Stores user-saved search criteria for candidates, jobs, and other entities';


--
-- Name: COLUMN saved_searches.filters; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.saved_searches.filters IS 'JSONB containing search filters that match the searchCandidatesInput schema';


--
-- Name: COLUMN saved_searches.is_shared; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.saved_searches.is_shared IS 'When true, search is visible to all users in the organization';


--
-- Name: COLUMN saved_searches.email_alerts; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.saved_searches.email_alerts IS 'When true, user receives notifications when new matches are found';


--
-- Name: security_alerts; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.security_alerts (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    alert_type text NOT NULL,
    severity text NOT NULL,
    title text NOT NULL,
    description text,
    related_user_id uuid,
    related_user_email text,
    related_events jsonb DEFAULT '[]'::jsonb,
    status text DEFAULT 'open'::text,
    assigned_to uuid,
    resolved_at timestamp with time zone,
    resolution_notes text,
    risk_level text,
    risk_indicators jsonb DEFAULT '{}'::jsonb,
    recommended_actions jsonb DEFAULT '[]'::jsonb,
    actions_taken jsonb DEFAULT '[]'::jsonb,
    metadata jsonb DEFAULT '{}'::jsonb,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT security_alerts_risk_level_check CHECK ((risk_level = ANY (ARRAY['LOW'::text, 'LOW_MEDIUM'::text, 'MEDIUM'::text, 'MEDIUM_HIGH'::text, 'HIGH'::text]))),
    CONSTRAINT security_alerts_severity_check CHECK ((severity = ANY (ARRAY['LOW'::text, 'MEDIUM'::text, 'HIGH'::text, 'CRITICAL'::text]))),
    CONSTRAINT security_alerts_status_check CHECK ((status = ANY (ARRAY['open'::text, 'investigating'::text, 'resolved'::text, 'dismissed'::text])))
);


--
-- Name: sequence_templates; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.sequence_templates (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    name text NOT NULL,
    description text,
    channel text NOT NULL,
    steps jsonb DEFAULT '[]'::jsonb NOT NULL,
    settings jsonb DEFAULT '{}'::jsonb,
    is_active boolean DEFAULT true,
    usage_count integer DEFAULT 0,
    created_by uuid,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    deleted_at timestamp with time zone,
    CONSTRAINT sequence_templates_channel_check CHECK ((channel = ANY (ARRAY['email'::text, 'linkedin'::text, 'phone'::text, 'sms'::text]))),
    CONSTRAINT sequence_templates_name_length CHECK ((char_length(name) <= 255))
);


--
-- Name: TABLE sequence_templates; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.sequence_templates IS 'Reusable sequence templates for campaign outreach';


--
-- Name: COLUMN sequence_templates.channel; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.sequence_templates.channel IS 'Outreach channel: email, linkedin, phone, sms';


--
-- Name: COLUMN sequence_templates.steps; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.sequence_templates.steps IS 'Array of sequence steps with day, action, subject, body';


--
-- Name: COLUMN sequence_templates.settings; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.sequence_templates.settings IS 'Sequence settings like stopOnReply, sendTime, dailyLimit';


--
-- Name: COLUMN sequence_templates.usage_count; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.sequence_templates.usage_count IS 'Number of campaigns using this template';


--
-- Name: session_metadata; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.session_metadata (
    id uuid DEFAULT extensions.uuid_generate_v4() NOT NULL,
    session_id character varying(50) NOT NULL,
    started_at timestamp with time zone NOT NULL,
    ended_at timestamp with time zone,
    duration character varying(50),
    branch character varying(100),
    commit_hash character varying(40),
    environment character varying(20),
    files_modified integer DEFAULT 0,
    lines_added integer DEFAULT 0,
    lines_removed integer DEFAULT 0,
    commands_executed integer DEFAULT 0,
    overall_goal text,
    successfully_completed boolean DEFAULT false,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    org_id uuid NOT NULL
);


--
-- Name: COLUMN session_metadata.org_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.session_metadata.org_id IS 'Organization this session belongs to';


--
-- Name: skill_aliases; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.skill_aliases (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    skill_id uuid NOT NULL,
    alias text NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone
);


--
-- Name: skills; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.skills (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    name text NOT NULL,
    category text,
    parent_skill_id uuid,
    description text,
    is_verified boolean DEFAULT false,
    usage_count integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE skills; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.skills IS 'Normalized skill taxonomy for matching candidates to jobs';


--
-- Name: sla_definitions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.sla_definitions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid,
    sla_name text NOT NULL,
    sla_code text NOT NULL,
    description text,
    entity_type text NOT NULL,
    activity_type text,
    activity_category text,
    priority text,
    target_hours integer NOT NULL,
    warning_hours integer,
    critical_hours integer,
    use_business_hours boolean DEFAULT false,
    business_hours_start text DEFAULT '09:00'::text,
    business_hours_end text DEFAULT '17:00'::text,
    escalate_on_breach boolean DEFAULT false,
    escalate_to_user_id uuid,
    escalate_to_group_id uuid,
    is_active boolean DEFAULT true,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    category text,
    start_event text,
    end_event text,
    target_value integer,
    target_unit text DEFAULT 'business_hours'::text,
    conditions jsonb DEFAULT '[]'::jsonb,
    status text DEFAULT 'draft'::text,
    pause_on_hold boolean DEFAULT false,
    apply_retroactive boolean DEFAULT false,
    CONSTRAINT sla_definitions_status_check CHECK (((status IS NULL) OR (status = ANY (ARRAY['draft'::text, 'active'::text, 'disabled'::text])))),
    CONSTRAINT sla_definitions_target_unit_check CHECK (((target_unit IS NULL) OR (target_unit = ANY (ARRAY['minutes'::text, 'hours'::text, 'business_hours'::text, 'days'::text, 'business_days'::text, 'weeks'::text]))))
);


--
-- Name: TABLE sla_definitions; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.sla_definitions IS 'SLA (Service Level Agreement) configuration';


--
-- Name: sla_escalation_levels; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.sla_escalation_levels (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    sla_definition_id uuid NOT NULL,
    level_number integer NOT NULL,
    level_name text NOT NULL,
    trigger_percentage integer NOT NULL,
    notify_email boolean DEFAULT true,
    notify_slack boolean DEFAULT false,
    notify_sms boolean DEFAULT false,
    email_recipients text[] DEFAULT '{}'::text[],
    slack_channel text,
    sms_recipients text[] DEFAULT '{}'::text[],
    show_badge boolean DEFAULT true,
    badge_color text DEFAULT 'yellow'::text,
    add_to_report boolean DEFAULT false,
    add_to_dashboard boolean DEFAULT false,
    create_task boolean DEFAULT false,
    task_assignee text,
    escalate_ownership boolean DEFAULT false,
    escalate_to text,
    block_actions boolean DEFAULT false,
    require_resolution_notes boolean DEFAULT false,
    flag_for_review boolean DEFAULT false,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT sla_escalation_levels_level_number_check CHECK (((level_number >= 1) AND (level_number <= 10))),
    CONSTRAINT sla_escalation_levels_trigger_percentage_check CHECK (((trigger_percentage >= 1) AND (trigger_percentage <= 500)))
);


--
-- Name: TABLE sla_escalation_levels; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.sla_escalation_levels IS 'Multi-level escalation configuration for SLA rules';


--
-- Name: sla_events; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.sla_events (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    sla_definition_id uuid NOT NULL,
    entity_type text NOT NULL,
    entity_id uuid NOT NULL,
    start_time timestamp with time zone NOT NULL,
    end_time timestamp with time zone,
    target_deadline timestamp with time zone NOT NULL,
    elapsed_minutes integer DEFAULT 0,
    current_percentage numeric(6,2) DEFAULT 0,
    current_level integer DEFAULT 0,
    status text DEFAULT 'pending'::text NOT NULL,
    met_at timestamp with time zone,
    resolution_notes text,
    resolved_by uuid,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT sla_events_status_check CHECK ((status = ANY (ARRAY['pending'::text, 'warning'::text, 'breach'::text, 'critical'::text, 'met'::text, 'cancelled'::text])))
);


--
-- Name: TABLE sla_events; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.sla_events IS 'Individual SLA tracking events for entity records';


--
-- Name: sla_instances; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.sla_instances (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    sla_definition_id uuid NOT NULL,
    activity_id uuid NOT NULL,
    start_time timestamp with time zone NOT NULL,
    target_time timestamp with time zone NOT NULL,
    warning_time timestamp with time zone,
    critical_time timestamp with time zone,
    completed_at timestamp with time zone,
    status text DEFAULT 'active'::text,
    paused_at timestamp with time zone,
    resumed_at timestamp with time zone,
    breach_duration integer,
    is_breached boolean DEFAULT false,
    breached_at timestamp with time zone,
    escalation_sent boolean DEFAULT false,
    escalation_sent_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE sla_instances; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.sla_instances IS 'SLA tracking for individual activities';


--
-- Name: sla_notifications; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.sla_notifications (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    sla_event_id uuid NOT NULL,
    escalation_level integer NOT NULL,
    notification_type text NOT NULL,
    recipients text[] NOT NULL,
    sent_at timestamp with time zone DEFAULT now(),
    delivered_at timestamp with time zone,
    failed_at timestamp with time zone,
    error_message text,
    external_message_id text,
    CONSTRAINT sla_notifications_notification_type_check CHECK ((notification_type = ANY (ARRAY['email'::text, 'slack'::text, 'sms'::text, 'in_app'::text])))
);


--
-- Name: TABLE sla_notifications; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.sla_notifications IS 'Log of sent SLA notifications for audit trail';


--
-- Name: sla_scheduled_runs; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.sla_scheduled_runs (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    last_run_at timestamp with time zone NOT NULL,
    rules_checked integer DEFAULT 0,
    events_updated integer DEFAULT 0,
    notifications_sent integer DEFAULT 0,
    errors text[],
    run_duration_ms integer,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE sla_scheduled_runs; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.sla_scheduled_runs IS 'Tracking table for SLA monitoring background job runs';


--
-- Name: student_interventions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.student_interventions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    student_id uuid NOT NULL,
    enrollment_id uuid NOT NULL,
    course_id uuid NOT NULL,
    risk_level text NOT NULL,
    risk_reasons text[] NOT NULL,
    intervention_type text,
    assigned_trainer_id uuid,
    assigned_at timestamp with time zone,
    status text DEFAULT 'pending'::text NOT NULL,
    notes text,
    trainer_notes text,
    resolution_notes text,
    outcome text,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    resolved_at timestamp with time zone,
    deleted_at timestamp with time zone,
    CONSTRAINT student_interventions_intervention_type_check CHECK ((intervention_type = ANY (ARRAY['automated_email'::text, 'trainer_notification'::text, 'one_on_one_scheduled'::text, 'mentor_assigned'::text, 'resource_recommended'::text, 'deadline_extended'::text, 'other'::text]))),
    CONSTRAINT student_interventions_outcome_check CHECK ((outcome = ANY (ARRAY['student_improved'::text, 'student_completed'::text, 'student_dropped'::text, 'false_positive'::text, 'needs_escalation'::text]))),
    CONSTRAINT student_interventions_risk_level_check CHECK ((risk_level = ANY (ARRAY['low'::text, 'medium'::text, 'high'::text]))),
    CONSTRAINT student_interventions_status_check CHECK ((status = ANY (ARRAY['pending'::text, 'in_progress'::text, 'resolved'::text, 'escalated'::text, 'dismissed'::text]))),
    CONSTRAINT valid_assignment CHECK ((((assigned_trainer_id IS NULL) AND (assigned_at IS NULL)) OR ((assigned_trainer_id IS NOT NULL) AND (assigned_at IS NOT NULL)))),
    CONSTRAINT valid_resolution CHECK ((((status <> 'resolved'::text) AND (resolved_at IS NULL)) OR ((status = 'resolved'::text) AND (resolved_at IS NOT NULL))))
);


--
-- Name: TABLE student_interventions; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.student_interventions IS 'ACAD-027: Tracks interventions for at-risk students';


--
-- Name: student_ltv_analytics; Type: MATERIALIZED VIEW; Schema: public; Owner: -
--

CREATE MATERIALIZED VIEW public.student_ltv_analytics AS
 SELECT up.id AS student_id,
    up.full_name AS student_name,
    up.email AS student_email,
    sum(
        CASE
            WHEN (pt.status = 'succeeded'::text) THEN pt.amount
            ELSE (0)::numeric
        END) AS lifetime_revenue,
    count(DISTINCT se.id) AS total_enrollments,
    count(DISTINCT
        CASE
            WHEN ((se.status = 'active'::text) AND (se.payment_type = 'subscription'::text)) THEN se.id
            ELSE NULL::uuid
        END) AS active_subscriptions,
    avg(
        CASE
            WHEN (pt.status = 'succeeded'::text) THEN pt.amount
            ELSE NULL::numeric
        END) AS avg_revenue_per_enrollment,
    min(pt.created_at) AS first_purchase_at,
    max(pt.created_at) AS last_purchase_at,
    (EXTRACT(epoch FROM (max(pt.created_at) - min(pt.created_at))) / ((((30 * 24) * 60) * 60))::numeric) AS months_as_customer
   FROM ((public.user_profiles up
     JOIN public.payment_transactions pt ON ((pt.user_id = up.id)))
     JOIN public.student_enrollments se ON ((se.id = pt.enrollment_id)))
  WHERE (pt.status = 'succeeded'::text)
  GROUP BY up.id, up.full_name, up.email
  WITH NO DATA;


--
-- Name: MATERIALIZED VIEW student_ltv_analytics; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON MATERIALIZED VIEW public.student_ltv_analytics IS 'ACAD-030: Student lifetime value analytics';


--
-- Name: student_progress; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.student_progress (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    student_id uuid NOT NULL,
    current_module text NOT NULL,
    completed_modules text[] DEFAULT '{}'::text[] NOT NULL,
    struggle_areas text[] DEFAULT '{}'::text[] NOT NULL,
    mastery_score integer DEFAULT 0 NOT NULL,
    total_interactions integer DEFAULT 0 NOT NULL,
    helpful_interactions integer DEFAULT 0 NOT NULL,
    last_activity_at timestamp with time zone DEFAULT now() NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT student_progress_mastery_score_check CHECK (((mastery_score >= 0) AND (mastery_score <= 100)))
);


--
-- Name: TABLE student_progress; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.student_progress IS 'Tracks Guidewire student learning progress and mastery';


--
-- Name: COLUMN student_progress.mastery_score; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.student_progress.mastery_score IS 'Overall mastery score 0-100 based on interactions and completions';


--
-- Name: submission_notes; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.submission_notes (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    submission_id uuid NOT NULL,
    note text NOT NULL,
    is_client_visible boolean DEFAULT false,
    created_by uuid NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone
);


--
-- Name: submission_rates; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.submission_rates (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    submission_id uuid NOT NULL,
    bill_rate numeric(10,2),
    pay_rate numeric(10,2),
    margin_percent numeric(5,2),
    margin_amount numeric(10,2),
    currency text DEFAULT 'USD'::text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone
);


--
-- Name: submission_screening_answers; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.submission_screening_answers (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    submission_id uuid NOT NULL,
    question_id uuid NOT NULL,
    answer text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone
);


--
-- Name: submission_status_history; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.submission_status_history (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    submission_id uuid NOT NULL,
    from_status text,
    to_status text NOT NULL,
    reason text,
    changed_by uuid NOT NULL,
    changed_at timestamp with time zone DEFAULT now() NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: submissions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.submissions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    job_id uuid NOT NULL,
    candidate_id uuid NOT NULL,
    account_id uuid,
    status text DEFAULT 'sourced'::text NOT NULL,
    ai_match_score integer,
    recruiter_match_score integer,
    match_explanation text,
    submitted_rate numeric(10,2),
    submitted_rate_type text DEFAULT 'hourly'::text,
    submission_notes text,
    submitted_to_client_at timestamp with time zone,
    submitted_to_client_by uuid,
    client_resume_file_id uuid,
    client_profile_url text,
    interview_count integer DEFAULT 0,
    last_interview_date timestamp with time zone,
    interview_feedback text,
    offer_extended_at timestamp with time zone,
    offer_accepted_at timestamp with time zone,
    offer_declined_at timestamp with time zone,
    offer_decline_reason text,
    rejected_at timestamp with time zone,
    rejection_reason text,
    rejection_source text,
    owner_id uuid NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid,
    deleted_at timestamp with time zone,
    vendor_submitted_at timestamp with time zone,
    vendor_submitted_by uuid,
    vendor_decision text,
    vendor_decision_at timestamp with time zone,
    vendor_decision_by uuid,
    vendor_notes text,
    vendor_screening_notes text,
    vendor_screening_completed_at timestamp with time zone,
    client_decision text,
    client_decision_at timestamp with time zone,
    client_decision_notes text,
    offer_id uuid,
    placement_id uuid,
    contact_id uuid,
    company_id uuid,
    CONSTRAINT submissions_ai_match_score_check CHECK (((ai_match_score >= 0) AND (ai_match_score <= 100))),
    CONSTRAINT submissions_recruiter_match_score_check CHECK (((recruiter_match_score >= 0) AND (recruiter_match_score <= 100)))
);


--
-- Name: TABLE submissions; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.submissions IS 'Candidate applications and matches to jobs';


--
-- Name: COLUMN submissions.vendor_decision; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.submissions.vendor_decision IS 'Vendor approval status: pending, accepted, or rejected';


--
-- Name: COLUMN submissions.client_decision; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.submissions.client_decision IS 'Client decision status: pending, accepted, or rejected';


--
-- Name: COLUMN submissions.company_id; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.submissions.company_id IS 'FK to companies table (replaces account_id)';


--
-- Name: system_roles; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.system_roles (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    code text NOT NULL,
    name text NOT NULL,
    display_name text NOT NULL,
    description text,
    category text NOT NULL,
    hierarchy_level integer DEFAULT 0,
    is_system_role boolean DEFAULT true,
    is_active boolean DEFAULT true,
    color_code text DEFAULT '#6366f1'::text,
    icon_name text,
    pod_type text,
    default_permissions text[],
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT system_roles_category_check CHECK ((category = ANY (ARRAY['pod_ic'::text, 'pod_manager'::text, 'leadership'::text, 'executive'::text, 'portal'::text, 'admin'::text]))),
    CONSTRAINT system_roles_pod_type_check CHECK (((pod_type IS NULL) OR (pod_type = ANY (ARRAY['recruiting'::text, 'bench_sales'::text, 'ta'::text]))))
);


--
-- Name: system_settings; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.system_settings (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    key character varying(100) NOT NULL,
    value jsonb DEFAULT '{}'::jsonb NOT NULL,
    category character varying(50) NOT NULL,
    data_type character varying(20) DEFAULT 'string'::character varying NOT NULL,
    description text,
    default_value jsonb,
    constraints jsonb,
    is_sensitive boolean DEFAULT false,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    updated_by uuid
);


--
-- Name: TABLE system_settings; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.system_settings IS 'Global platform-wide configuration settings';


--
-- Name: COLUMN system_settings.key; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.system_settings.key IS 'Unique setting identifier';


--
-- Name: COLUMN system_settings.value; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.system_settings.value IS 'Setting value stored as JSONB';


--
-- Name: COLUMN system_settings.category; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.system_settings.category IS 'Setting category: general, security, email, files, api';


--
-- Name: COLUMN system_settings.data_type; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.system_settings.data_type IS 'Data type: string, number, boolean, array, object';


--
-- Name: COLUMN system_settings.is_sensitive; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.system_settings.is_sensitive IS 'Whether the setting contains sensitive data';


--
-- Name: talking_point_templates; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.talking_point_templates (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    name text NOT NULL,
    description text,
    category text,
    talking_points jsonb DEFAULT '[]'::jsonb,
    is_default boolean DEFAULT false,
    is_active boolean DEFAULT true,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid
);


--
-- Name: tasks; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.tasks (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    title text NOT NULL,
    description text,
    entity_type text,
    entity_id uuid,
    assigned_to uuid,
    created_by uuid NOT NULL,
    status text DEFAULT 'todo'::text NOT NULL,
    priority text DEFAULT 'medium'::text,
    due_date date,
    completed_at timestamp with time zone,
    completed_by uuid,
    is_recurring boolean DEFAULT false,
    recurrence_pattern text,
    parent_task_id uuid,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE tasks; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.tasks IS 'To-do items and action items with assignment';


--
-- Name: team_metrics; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.team_metrics (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    pod_id uuid NOT NULL,
    metric_date timestamp with time zone NOT NULL,
    metric_period text DEFAULT 'day'::text,
    total_activities integer DEFAULT 0,
    completed_activities integer DEFAULT 0,
    avg_response_time_hours numeric(10,2),
    avg_resolution_time_hours numeric(10,2),
    total_active_members integer DEFAULT 0,
    avg_activities_per_member numeric(10,2),
    sla_compliance_rate numeric(5,2),
    activities_created_per_day numeric(10,2),
    activities_completed_per_day numeric(10,2),
    escalation_count integer DEFAULT 0,
    reassignment_count integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE team_metrics; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.team_metrics IS 'Aggregated team performance metrics';


--
-- Name: time_attendance; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.time_attendance (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    employee_id uuid NOT NULL,
    date date NOT NULL,
    regular_hours numeric(5,2) DEFAULT 0,
    overtime_hours numeric(5,2) DEFAULT 0,
    pto_hours numeric(5,2) DEFAULT 0,
    sick_hours numeric(5,2) DEFAULT 0,
    holiday_hours numeric(5,2) DEFAULT 0,
    total_hours numeric(5,2) GENERATED ALWAYS AS (((((regular_hours + overtime_hours) + pto_hours) + sick_hours) + holiday_hours)) STORED,
    status text DEFAULT 'draft'::text NOT NULL,
    approved_by uuid,
    approved_at timestamp with time zone,
    rejection_reason text,
    notes text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE time_attendance; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.time_attendance IS 'Daily timesheet tracking';


--
-- Name: topic_completions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.topic_completions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    enrollment_id uuid NOT NULL,
    course_id uuid NOT NULL,
    module_id uuid NOT NULL,
    topic_id uuid NOT NULL,
    completed_at timestamp with time zone DEFAULT now() NOT NULL,
    time_spent_seconds integer DEFAULT 0,
    xp_earned integer DEFAULT 0 NOT NULL,
    completion_source text DEFAULT 'manual'::text,
    notes text,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT topic_completions_completion_source_check CHECK ((completion_source = ANY (ARRAY['manual'::text, 'auto'::text, 'admin_override'::text]))),
    CONSTRAINT valid_time_spent CHECK ((time_spent_seconds >= 0)),
    CONSTRAINT valid_xp CHECK ((xp_earned >= 0))
);


--
-- Name: TABLE topic_completions; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.topic_completions IS 'Tracks student completion of individual course topics';


--
-- Name: topic_difficulty_stats; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.topic_difficulty_stats AS
 SELECT mt.id AS topic_id,
    mt.title AS topic_title,
    cm.title AS module_title,
    c.title AS course_title,
    count(e.id) AS escalation_count,
    count(DISTINCT e.user_id) AS unique_students,
    avg(e.confidence) AS avg_escalation_confidence,
    count(*) FILTER (WHERE (e.status = 'resolved'::text)) AS resolved_count
   FROM (((public.module_topics mt
     JOIN public.course_modules cm ON ((cm.id = mt.module_id)))
     JOIN public.courses c ON ((c.id = cm.course_id)))
     LEFT JOIN public.ai_mentor_escalations e ON ((e.topic_id = mt.id)))
  GROUP BY mt.id, mt.title, cm.title, c.title
 HAVING (count(e.id) > 0)
  ORDER BY (count(e.id)) DESC;


--
-- Name: VIEW topic_difficulty_stats; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.topic_difficulty_stats IS 'Topics ranked by escalation frequency';


--
-- Name: topic_lessons; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.topic_lessons (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    topic_id uuid NOT NULL,
    title text NOT NULL,
    lesson_number integer NOT NULL,
    content_type text NOT NULL,
    content_url text,
    content_markdown text,
    duration_seconds integer,
    lab_environment_template text,
    lab_instructions_url text,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT topic_lessons_content_type_check CHECK ((content_type = ANY (ARRAY['video'::text, 'markdown'::text, 'pdf'::text, 'quiz'::text, 'lab'::text, 'external_link'::text])))
);


--
-- Name: TABLE topic_lessons; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.topic_lessons IS 'Granular content items (videos, readings, quizzes, labs)';


--
-- Name: topic_unlock_requirements; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.topic_unlock_requirements AS
 SELECT id AS topic_id,
    module_id,
    title AS topic_title,
    topic_number,
    prerequisite_topic_ids,
    ( SELECT array_agg(mt2.title) AS array_agg
           FROM public.module_topics mt2
          WHERE (mt2.id = ANY (mt.prerequisite_topic_ids))) AS prerequisite_titles,
    ( SELECT array_agg(mt2.topic_number) AS array_agg
           FROM public.module_topics mt2
          WHERE (mt2.id = ANY (mt.prerequisite_topic_ids))) AS prerequisite_numbers
   FROM public.module_topics mt;


--
-- Name: VIEW topic_unlock_requirements; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.topic_unlock_requirements IS 'Helper view showing topic prerequisites with titles';


--
-- Name: trainer_escalation_stats; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.trainer_escalation_stats AS
 SELECT t.id AS trainer_id,
    t.full_name AS trainer_name,
    count(e.id) AS total_assigned,
    count(*) FILTER (WHERE (e.status = 'resolved'::text)) AS resolved_count,
    count(*) FILTER (WHERE (e.status = 'dismissed'::text)) AS dismissed_count,
    avg(e.resolution_time_minutes) FILTER (WHERE (e.resolution_time_minutes IS NOT NULL)) AS avg_resolution_time_minutes,
    count(tr.id) AS total_responses,
    max(e.resolved_at) AS last_resolution_at
   FROM ((((public.user_profiles t
     JOIN public.user_roles ur ON ((ur.user_id = t.id)))
     JOIN public.roles r ON ((r.id = ur.role_id)))
     LEFT JOIN public.ai_mentor_escalations e ON ((e.assigned_to = t.id)))
     LEFT JOIN public.trainer_responses tr ON ((tr.trainer_id = t.id)))
  WHERE (r.name = 'trainer'::text)
  GROUP BY t.id, t.full_name;


--
-- Name: VIEW trainer_escalation_stats; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.trainer_escalation_stats IS 'Per-trainer escalation handling performance';


--
-- Name: twin_conversations; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.twin_conversations (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    initiator_user_id uuid,
    initiator_role text NOT NULL,
    responder_role text NOT NULL,
    question text NOT NULL,
    response text,
    tokens_used integer,
    cost_usd numeric(10,6),
    latency_ms integer,
    model_used text DEFAULT 'gpt-4o-mini'::text,
    context jsonb DEFAULT '{}'::jsonb,
    status text DEFAULT 'completed'::text,
    error_message text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT twin_conversations_initiator_role_check CHECK ((initiator_role = ANY (ARRAY['ceo'::text, 'admin'::text, 'recruiter'::text, 'bench_sales'::text, 'talent_acquisition'::text, 'hr'::text, 'immigration'::text, 'trainer'::text, 'organization'::text]))),
    CONSTRAINT twin_conversations_responder_role_check CHECK ((responder_role = ANY (ARRAY['ceo'::text, 'admin'::text, 'recruiter'::text, 'bench_sales'::text, 'talent_acquisition'::text, 'hr'::text, 'immigration'::text, 'trainer'::text, 'organization'::text]))),
    CONSTRAINT twin_conversations_status_check CHECK ((status = ANY (ARRAY['pending'::text, 'completed'::text, 'failed'::text])))
);


--
-- Name: TABLE twin_conversations; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.twin_conversations IS 'Audit trail for direct twin-to-twin queries';


--
-- Name: twin_events; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.twin_events (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    source_user_id uuid NOT NULL,
    source_role text NOT NULL,
    target_role text,
    event_type text NOT NULL,
    payload jsonb DEFAULT '{}'::jsonb NOT NULL,
    priority text DEFAULT 'medium'::text NOT NULL,
    processed boolean DEFAULT false NOT NULL,
    processed_at timestamp with time zone,
    processed_by uuid,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    expires_at timestamp with time zone DEFAULT (now() + '7 days'::interval),
    CONSTRAINT twin_events_event_type_check CHECK ((event_type = ANY (ARRAY['placement_complete'::text, 'bench_ending'::text, 'training_graduate'::text, 'deal_closed'::text, 'escalation'::text, 'approval_needed'::text, 'milestone_reached'::text, 'cross_sell_opportunity'::text, 'custom'::text]))),
    CONSTRAINT twin_events_priority_check CHECK ((priority = ANY (ARRAY['low'::text, 'medium'::text, 'high'::text, 'critical'::text]))),
    CONSTRAINT twin_events_source_role_check CHECK ((source_role = ANY (ARRAY['ceo'::text, 'admin'::text, 'recruiter'::text, 'bench_sales'::text, 'talent_acquisition'::text, 'hr'::text, 'immigration'::text, 'trainer'::text]))),
    CONSTRAINT twin_events_target_role_check CHECK (((target_role IS NULL) OR (target_role = ANY (ARRAY['ceo'::text, 'admin'::text, 'recruiter'::text, 'bench_sales'::text, 'talent_acquisition'::text, 'hr'::text, 'immigration'::text, 'trainer'::text]))))
);


--
-- Name: TABLE twin_events; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.twin_events IS 'Async event bus for inter-twin communication';


--
-- Name: twin_preferences; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.twin_preferences (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    enable_morning_briefing boolean DEFAULT true,
    morning_briefing_time time without time zone DEFAULT '09:00:00'::time without time zone,
    enable_proactive_suggestions boolean DEFAULT true,
    suggestion_frequency integer DEFAULT 3,
    notify_via_ui boolean DEFAULT true,
    notify_via_slack boolean DEFAULT false,
    notify_via_email boolean DEFAULT false,
    use_productivity_data boolean DEFAULT true,
    use_activity_data boolean DEFAULT true,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);


--
-- Name: TABLE twin_preferences; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.twin_preferences IS 'User preferences for AI Twin behavior';


--
-- Name: user_achievements; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.user_achievements (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    achievement_id uuid NOT NULL,
    unlocked_at timestamp with time zone DEFAULT now() NOT NULL,
    progress jsonb,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: user_badge_progress; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.user_badge_progress AS
 SELECT u.id AS user_id,
    u.full_name,
    count(ub.id) FILTER (WHERE (b.rarity = 'common'::text)) AS common_badges,
    count(ub.id) FILTER (WHERE (b.rarity = 'rare'::text)) AS rare_badges,
    count(ub.id) FILTER (WHERE (b.rarity = 'epic'::text)) AS epic_badges,
    count(ub.id) FILTER (WHERE (b.rarity = 'legendary'::text)) AS legendary_badges,
    count(ub.id) AS total_badges_earned,
    ( SELECT count(*) AS count
           FROM public.badges
          WHERE (badges.is_hidden = false)) AS total_badges_available,
    (((count(ub.id))::numeric / (NULLIF(( SELECT count(*) AS count
           FROM public.badges
          WHERE (badges.is_hidden = false)), 0))::numeric) * (100)::numeric) AS completion_percentage,
    max(ub.earned_at) AS last_badge_earned_at,
    count(*) FILTER (WHERE (ub.is_new = true)) AS new_badges_count
   FROM ((public.user_profiles u
     LEFT JOIN public.user_badges ub ON ((ub.user_id = u.id)))
     LEFT JOIN public.badges b ON ((b.id = ub.badge_id)))
  GROUP BY u.id, u.full_name
  ORDER BY (count(ub.id)) DESC;


--
-- Name: VIEW user_badge_progress; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.user_badge_progress IS 'User badge collection progress';


--
-- Name: user_invitations; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.user_invitations (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    email character varying(255) NOT NULL,
    first_name character varying(100),
    last_name character varying(100),
    role_id uuid NOT NULL,
    pod_id uuid,
    manager_id uuid,
    token character varying(255) NOT NULL,
    invited_by uuid NOT NULL,
    expires_at timestamp with time zone NOT NULL,
    accepted_at timestamp with time zone,
    cancelled_at timestamp with time zone,
    require_two_factor boolean DEFAULT false,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE user_invitations; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.user_invitations IS 'Stores pending user invitations for organization onboarding';


--
-- Name: COLUMN user_invitations.token; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.user_invitations.token IS 'Unique token for invitation link validation';


--
-- Name: user_levels; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.user_levels (
    user_id uuid NOT NULL,
    current_level integer DEFAULT 1 NOT NULL,
    current_xp integer DEFAULT 0 NOT NULL,
    xp_to_next_level integer DEFAULT 100 NOT NULL,
    level_up_at timestamp with time zone,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: user_session_context; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.user_session_context (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    active_role text NOT NULL,
    session_started_at timestamp with time zone DEFAULT now() NOT NULL,
    session_ended_at timestamp with time zone,
    duration_seconds integer GENERATED ALWAYS AS (
CASE
    WHEN (session_ended_at IS NOT NULL) THEN (EXTRACT(epoch FROM (session_ended_at - session_started_at)))::integer
    ELSE NULL::integer
END) STORED
);


--
-- Name: TABLE user_session_context; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.user_session_context IS 'Tracks user context switching for analytics';


--
-- Name: v_active_users; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_active_users AS
 SELECT id,
    auth_id,
    email,
    full_name,
    avatar_url,
    phone,
    timezone,
    locale,
    student_enrollment_date,
    student_course_id,
    student_current_module,
    student_course_progress,
    student_graduation_date,
    student_certificates,
    employee_hire_date,
    employee_department,
    employee_position,
    employee_salary,
    employee_status,
    employee_manager_id,
    employee_performance_rating,
    candidate_status,
    candidate_resume_url,
    candidate_skills,
    candidate_experience_years,
    candidate_current_visa,
    candidate_visa_expiry,
    candidate_hourly_rate,
    candidate_bench_start_date,
    candidate_availability,
    candidate_location,
    candidate_willing_to_relocate,
    client_company_name,
    client_industry,
    client_tier,
    client_contract_start_date,
    client_contract_end_date,
    client_payment_terms,
    client_preferred_markup_percentage,
    recruiter_territory,
    recruiter_specialization,
    recruiter_monthly_placement_target,
    recruiter_pod_id,
    created_at,
    updated_at,
    created_by,
    updated_by,
    deleted_at,
    is_active,
    search_vector
   FROM public.user_profiles
  WHERE ((deleted_at IS NULL) AND (is_active = true));


--
-- Name: v_agent_framework_status; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_agent_framework_status AS
 SELECT ( SELECT count(*) AS count
           FROM public.ai_prompts
          WHERE (ai_prompts.is_active = true)) AS active_prompts,
    ( SELECT count(DISTINCT ai_prompts.name) AS count
           FROM public.ai_prompts) AS unique_templates,
    ( SELECT count(*) AS count
           FROM public.ai_cost_tracking
          WHERE (ai_cost_tracking.created_at > (now() - '24:00:00'::interval))) AS cost_entries_24h,
    ( SELECT COALESCE(sum(ai_cost_tracking.cost_usd), (0)::numeric) AS "coalesce"
           FROM public.ai_cost_tracking
          WHERE (ai_cost_tracking.created_at > (now() - '24:00:00'::interval))) AS cost_24h_usd,
    ( SELECT COALESCE(sum(ai_cost_tracking.cost_usd), (0)::numeric) AS "coalesce"
           FROM public.ai_cost_tracking
          WHERE (ai_cost_tracking.created_at > (now() - '30 days'::interval))) AS cost_30d_usd,
    ( SELECT count(*) AS count
           FROM public.ai_agent_interactions
          WHERE (ai_agent_interactions.created_at > (now() - '24:00:00'::interval))) AS interactions_24h,
    ( SELECT count(*) AS count
           FROM public.ai_agent_interactions
          WHERE ((ai_agent_interactions.created_at > (now() - '24:00:00'::interval)) AND (ai_agent_interactions.success = false))) AS failures_24h,
    ( SELECT count(DISTINCT ai_agent_interactions.agent_name) AS count
           FROM public.ai_agent_interactions
          WHERE (ai_agent_interactions.created_at > (now() - '7 days'::interval))) AS active_agents_7d;


--
-- Name: VIEW v_agent_framework_status; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.v_agent_framework_status IS 'Agent framework health and usage metrics';


--
-- Name: v_audit_logs_critical; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_audit_logs_critical AS
 SELECT al.id,
    al.created_at,
    al.table_name,
    al.action,
    al.user_email,
    al.record_id,
    al.metadata,
    up.full_name AS user_name
   FROM (public.audit_logs al
     LEFT JOIN public.user_profiles up ON ((al.user_id = up.id)))
  WHERE (al.severity = ANY (ARRAY['error'::text, 'critical'::text]))
  ORDER BY al.created_at DESC;


--
-- Name: v_audit_logs_recent; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_audit_logs_recent AS
 SELECT al.id,
    al.created_at,
    al.table_name,
    al.action,
    al.user_email,
    al.changed_fields,
    al.severity,
    up.full_name AS user_name
   FROM (public.audit_logs al
     LEFT JOIN public.user_profiles up ON ((al.user_id = up.id)))
  WHERE (al.created_at > (now() - '7 days'::interval))
  ORDER BY al.created_at DESC
 LIMIT 1000;


--
-- Name: v_auth_rls_status; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_auth_rls_status AS
 SELECT c.relname AS table_name,
    c.relrowsecurity AS rls_enabled,
    c.relforcerowsecurity AS rls_forced,
    count(p.polname) AS policy_count,
    array_agg(p.polname ORDER BY p.polname) AS policies
   FROM (pg_class c
     LEFT JOIN pg_policy p ON ((p.polrelid = c.oid)))
  WHERE ((c.relnamespace = ('public'::regnamespace)::oid) AND (c.relkind = 'r'::"char") AND (c.relname = ANY (ARRAY['user_profiles'::name, 'roles'::name, 'permissions'::name, 'user_roles'::name, 'role_permissions'::name, 'organizations'::name, 'audit_logs'::name])))
  GROUP BY c.relname, c.relrowsecurity, c.relforcerowsecurity
  ORDER BY c.relname;


--
-- Name: VIEW v_auth_rls_status; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.v_auth_rls_status IS 'Validation view showing RLS status for auth/access control tables';


--
-- Name: v_bench_candidates; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_bench_candidates AS
 SELECT id,
    email,
    full_name,
    candidate_skills,
    candidate_experience_years,
    candidate_current_visa,
    candidate_hourly_rate,
    candidate_availability,
    candidate_location,
    candidate_bench_start_date
   FROM public.user_profiles
  WHERE ((candidate_status = 'bench'::text) AND (deleted_at IS NULL))
  ORDER BY candidate_bench_start_date;


--
-- Name: v_clients; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_clients AS
 SELECT id,
    email,
    full_name AS contact_name,
    client_company_name,
    client_industry,
    client_tier,
    client_contract_start_date,
    client_contract_end_date,
    client_payment_terms
   FROM public.user_profiles
  WHERE ((client_company_name IS NOT NULL) AND (deleted_at IS NULL))
  ORDER BY client_tier DESC, client_company_name;


--
-- Name: v_employees; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_employees AS
 SELECT id,
    email,
    full_name,
    employee_department,
    employee_position,
    employee_hire_date,
    employee_manager_id,
    employee_status
   FROM public.user_profiles
  WHERE ((employee_hire_date IS NOT NULL) AND (employee_status = 'active'::text) AND (deleted_at IS NULL))
  ORDER BY employee_hire_date DESC;


--
-- Name: v_event_stats_by_type; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_event_stats_by_type AS
 SELECT event_type,
    count(*) AS total_events,
    count(*) FILTER (WHERE (status = 'completed'::text)) AS completed,
    count(*) FILTER (WHERE (status = 'failed'::text)) AS failed,
    count(*) FILTER (WHERE (status = 'dead_letter'::text)) AS dead_letter,
    avg(EXTRACT(epoch FROM (processed_at - created_at))) AS avg_processing_time_seconds,
    max(created_at) AS last_event_at
   FROM public.events
  WHERE (created_at > (now() - '7 days'::interval))
  GROUP BY event_type
  ORDER BY (count(*)) DESC;


--
-- Name: v_events_failed; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_events_failed AS
 SELECT id,
    event_type,
    status,
    retry_count,
    max_retries,
    next_retry_at,
    error_message,
    created_at,
    failed_at
   FROM public.events e
  WHERE (status = ANY (ARRAY['failed'::text, 'dead_letter'::text]))
  ORDER BY created_at DESC;


--
-- Name: v_events_recent; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_events_recent AS
 SELECT e.id,
    e.event_type,
    e.event_category,
    e.status,
    e.user_email,
    e.payload,
    e.created_at,
    up.full_name AS triggered_by
   FROM (public.events e
     LEFT JOIN public.user_profiles up ON ((e.user_id = up.id)))
  WHERE (e.created_at > (now() - '24:00:00'::interval))
  ORDER BY e.created_at DESC
 LIMIT 100;


--
-- Name: v_multi_tenancy_status; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_multi_tenancy_status AS
 SELECT 'organizations'::text AS table_name,
    count(*) AS total_records,
    count(DISTINCT organizations.id) AS unique_orgs,
    count(*) FILTER (WHERE (organizations.status = 'active'::text)) AS active_orgs,
    count(*) FILTER (WHERE (organizations.deleted_at IS NOT NULL)) AS soft_deleted_orgs
   FROM public.organizations
UNION ALL
 SELECT 'user_profiles'::text AS table_name,
    count(*) AS total_records,
    count(DISTINCT user_profiles.org_id) AS unique_orgs,
    count(*) FILTER (WHERE (user_profiles.org_id IS NOT NULL)) AS active_orgs,
    NULL::bigint AS soft_deleted_orgs
   FROM public.user_profiles
UNION ALL
 SELECT 'audit_logs'::text AS table_name,
    count(*) AS total_records,
    count(DISTINCT audit_logs.org_id) AS unique_orgs,
    count(*) FILTER (WHERE (audit_logs.org_id IS NOT NULL)) AS active_orgs,
    NULL::bigint AS soft_deleted_orgs
   FROM public.audit_logs
UNION ALL
 SELECT 'events'::text AS table_name,
    count(*) AS total_records,
    count(DISTINCT events.org_id) AS unique_orgs,
    count(*) FILTER (WHERE (events.org_id IS NOT NULL)) AS active_orgs,
    NULL::bigint AS soft_deleted_orgs
   FROM public.events
UNION ALL
 SELECT 'event_delivery_log'::text AS table_name,
    count(*) AS total_records,
    count(DISTINCT event_delivery_log.org_id) AS unique_orgs,
    count(*) FILTER (WHERE (event_delivery_log.org_id IS NOT NULL)) AS active_orgs,
    NULL::bigint AS soft_deleted_orgs
   FROM public.event_delivery_log
UNION ALL
 SELECT 'project_timeline'::text AS table_name,
    count(*) AS total_records,
    count(DISTINCT project_timeline.org_id) AS unique_orgs,
    count(*) FILTER (WHERE (project_timeline.org_id IS NOT NULL)) AS active_orgs,
    NULL::bigint AS soft_deleted_orgs
   FROM public.project_timeline
UNION ALL
 SELECT 'session_metadata'::text AS table_name,
    count(*) AS total_records,
    count(DISTINCT session_metadata.org_id) AS unique_orgs,
    count(*) FILTER (WHERE (session_metadata.org_id IS NOT NULL)) AS active_orgs,
    NULL::bigint AS soft_deleted_orgs
   FROM public.session_metadata;


--
-- Name: VIEW v_multi_tenancy_status; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.v_multi_tenancy_status IS 'Validation view showing multi-tenancy data distribution across tables';


--
-- Name: v_organization_stats; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_organization_stats AS
SELECT
    NULL::uuid AS id,
    NULL::text AS name,
    NULL::text AS slug,
    NULL::text AS subscription_tier,
    NULL::text AS subscription_status,
    NULL::text AS status,
    NULL::integer AS max_users,
    NULL::bigint AS current_users,
    NULL::bigint AS available_user_slots,
    NULL::integer AS max_candidates,
    NULL::bigint AS current_candidates,
    NULL::timestamp with time zone AS created_at,
    NULL::timestamp with time zone AS updated_at;


--
-- Name: VIEW v_organization_stats; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.v_organization_stats IS 'Organization statistics including user counts and capacity';


--
-- Name: v_rls_policies; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_rls_policies AS
 SELECT schemaname,
    tablename,
    policyname,
    permissive,
    roles,
    cmd,
    qual,
    with_check
   FROM pg_policies
  WHERE (schemaname = 'public'::name)
  ORDER BY tablename, policyname;


--
-- Name: v_rls_status; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_rls_status AS
 SELECT schemaname,
    tablename,
    rowsecurity AS rls_enabled
   FROM pg_tables
  WHERE ((schemaname = 'public'::name) AND (tablename = ANY (ARRAY['user_profiles'::name, 'roles'::name, 'permissions'::name, 'user_roles'::name, 'role_permissions'::name, 'audit_logs'::name, 'events'::name, 'event_subscriptions'::name])))
  ORDER BY tablename;


--
-- Name: v_session_summary; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_session_summary AS
SELECT
    NULL::uuid AS id,
    NULL::character varying(50) AS session_id,
    NULL::timestamp with time zone AS started_at,
    NULL::timestamp with time zone AS ended_at,
    NULL::character varying(50) AS duration,
    NULL::character varying(100) AS branch,
    NULL::character varying(40) AS commit_hash,
    NULL::character varying(20) AS environment,
    NULL::integer AS files_modified,
    NULL::integer AS lines_added,
    NULL::integer AS lines_removed,
    NULL::integer AS commands_executed,
    NULL::text AS overall_goal,
    NULL::boolean AS successfully_completed,
    NULL::timestamp with time zone AS created_at,
    NULL::timestamp with time zone AS updated_at,
    NULL::bigint AS timeline_entries,
    NULL::text[] AS all_tags;


--
-- Name: v_sprint_5_status; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_sprint_5_status AS
 SELECT 'generated_resumes'::text AS table_name,
    count(*) AS total_records,
    count(DISTINCT generated_resumes.org_id) AS unique_orgs,
    count(DISTINCT generated_resumes.user_id) AS unique_users,
    count(*) FILTER (WHERE (generated_resumes.placement_achieved = true)) AS placements,
    round(avg(generated_resumes.quality_score), 2) AS avg_quality
   FROM public.generated_resumes
UNION ALL
 SELECT 'candidate_embeddings'::text AS table_name,
    count(*) AS total_records,
    count(DISTINCT candidate_embeddings.org_id) AS unique_orgs,
    count(DISTINCT candidate_embeddings.candidate_id) AS unique_users,
    NULL::bigint AS placements,
    NULL::numeric AS avg_quality
   FROM public.candidate_embeddings
UNION ALL
 SELECT 'requisition_embeddings'::text AS table_name,
    count(*) AS total_records,
    count(DISTINCT requisition_embeddings.org_id) AS unique_orgs,
    count(DISTINCT requisition_embeddings.requisition_id) AS unique_users,
    NULL::bigint AS placements,
    NULL::numeric AS avg_quality
   FROM public.requisition_embeddings
UNION ALL
 SELECT 'resume_matches'::text AS table_name,
    count(*) AS total_records,
    count(DISTINCT resume_matches.org_id) AS unique_orgs,
    count(DISTINCT resume_matches.candidate_id) AS unique_users,
    count(*) FILTER (WHERE (resume_matches.placement_achieved = true)) AS placements,
    round(avg(resume_matches.match_score), 2) AS avg_quality
   FROM public.resume_matches;


--
-- Name: VIEW v_sprint_5_status; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.v_sprint_5_status IS 'Validation view for Sprint 5 data (Guidewire Guru & Resume Matching)';


--
-- Name: v_students; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_students AS
 SELECT id,
    email,
    full_name,
    student_enrollment_date,
    student_current_module,
    student_course_progress,
    student_graduation_date,
    created_at
   FROM public.user_profiles
  WHERE ((student_enrollment_date IS NOT NULL) AND (deleted_at IS NULL))
  ORDER BY student_enrollment_date DESC;


--
-- Name: v_subscriber_performance; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_subscriber_performance AS
 SELECT es.subscriber_name,
    es.event_pattern,
    count(edl.id) AS total_deliveries,
    count(*) FILTER (WHERE (edl.status = 'success'::text)) AS successful,
    count(*) FILTER (WHERE (edl.status = 'failure'::text)) AS failed,
    avg(edl.duration_ms) AS avg_duration_ms,
    max(edl.attempted_at) AS last_delivery_at
   FROM (public.event_subscriptions es
     LEFT JOIN public.event_delivery_log edl ON ((es.id = edl.subscription_id)))
  WHERE (edl.attempted_at > (now() - '7 days'::interval))
  GROUP BY es.id, es.subscriber_name, es.event_pattern
  ORDER BY (count(edl.id)) DESC;


--
-- Name: v_timeline_recent; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_timeline_recent AS
 SELECT pt.id,
    pt.session_id,
    pt.session_date,
    pt.agent_type,
    pt.agent_model,
    pt.duration,
    pt.conversation_summary,
    pt.user_intent,
    pt.actions_taken,
    pt.files_changed,
    pt.decisions,
    pt.assumptions,
    pt.results,
    pt.future_notes,
    pt.related_commits,
    pt.related_prs,
    pt.related_docs,
    pt.tags,
    pt.ai_generated_summary,
    pt.key_learnings,
    pt.search_vector,
    pt.created_at,
    pt.updated_at,
    pt.deleted_at,
    pt.is_archived,
    sm.started_at AS session_started_at,
    sm.ended_at AS session_ended_at,
    sm.branch AS session_branch,
    sm.successfully_completed
   FROM (public.project_timeline pt
     LEFT JOIN public.session_metadata sm ON (((pt.session_id)::text = (sm.session_id)::text)))
  WHERE ((pt.is_archived = false) AND (pt.deleted_at IS NULL))
  ORDER BY pt.session_date DESC
 LIMIT 100;


--
-- Name: v_timeline_stats_by_tag; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_timeline_stats_by_tag AS
 SELECT unnest(tags) AS tag,
    count(*) AS entry_count,
    count(DISTINCT session_id) AS session_count,
    min(session_date) AS first_occurrence,
    max(session_date) AS last_occurrence
   FROM public.project_timeline
  WHERE ((is_archived = false) AND (deleted_at IS NULL))
  GROUP BY (unnest(tags))
  ORDER BY (count(*)) DESC;


--
-- Name: v_user_activity_summary; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_user_activity_summary AS
 SELECT user_id,
    user_email,
    count(*) AS total_actions,
    count(*) FILTER (WHERE (action = 'INSERT'::text)) AS inserts,
    count(*) FILTER (WHERE (action = 'UPDATE'::text)) AS updates,
    count(*) FILTER (WHERE (action = 'DELETE'::text)) AS deletes,
    max(created_at) AS last_activity
   FROM public.audit_logs
  WHERE ((user_id IS NOT NULL) AND (created_at > (now() - '30 days'::interval)))
  GROUP BY user_id, user_email
  ORDER BY (count(*)) DESC;


--
-- Name: v_user_roles_detailed; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_user_roles_detailed AS
 SELECT up.id AS user_id,
    up.email,
    up.full_name,
    r.name AS role_name,
    r.display_name AS role_display_name,
    ur.is_primary,
    ur.assigned_at,
    ur.expires_at,
        CASE
            WHEN ((ur.expires_at IS NOT NULL) AND (ur.expires_at < now())) THEN 'expired'::text
            WHEN (ur.deleted_at IS NOT NULL) THEN 'revoked'::text
            ELSE 'active'::text
        END AS role_status
   FROM ((public.user_profiles up
     JOIN public.user_roles ur ON ((up.id = ur.user_id)))
     JOIN public.roles r ON ((ur.role_id = r.id)))
  WHERE (up.deleted_at IS NULL)
  ORDER BY up.email, ur.is_primary DESC, r.name;


--
-- Name: workflow_instances; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.workflow_instances (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    workflow_id uuid NOT NULL,
    entity_type text NOT NULL,
    entity_id uuid NOT NULL,
    current_state_id uuid NOT NULL,
    started_at timestamp with time zone DEFAULT now() NOT NULL,
    completed_at timestamp with time zone,
    cancelled_at timestamp with time zone,
    status text DEFAULT 'active'::text NOT NULL,
    metadata jsonb DEFAULT '{}'::jsonb NOT NULL,
    version integer DEFAULT 0 NOT NULL,
    created_by uuid NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT valid_status CHECK ((status = ANY (ARRAY['active'::text, 'completed'::text, 'cancelled'::text, 'failed'::text])))
);


--
-- Name: TABLE workflow_instances; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.workflow_instances IS 'Active workflow instances (executions)';


--
-- Name: COLUMN workflow_instances.metadata; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.workflow_instances.metadata IS 'Runtime data (e.g., approval notes, rejections)';


--
-- Name: COLUMN workflow_instances.version; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.workflow_instances.version IS 'Version for optimistic locking (prevent concurrent transitions)';


--
-- Name: workflow_states; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.workflow_states (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    workflow_id uuid NOT NULL,
    name text NOT NULL,
    display_name text NOT NULL,
    description text,
    state_order integer NOT NULL,
    is_initial boolean DEFAULT false NOT NULL,
    is_terminal boolean DEFAULT false NOT NULL,
    actions jsonb DEFAULT '[]'::jsonb NOT NULL,
    metadata jsonb DEFAULT '{}'::jsonb NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE workflow_states; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.workflow_states IS 'States in a workflow definition';


--
-- Name: COLUMN workflow_states.state_order; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.workflow_states.state_order IS 'Display order in UI (not necessarily execution order)';


--
-- Name: COLUMN workflow_states.actions; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.workflow_states.actions IS 'Available actions from this state (e.g., ["approve", "reject"])';


--
-- Name: workflows; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.workflows (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    name text NOT NULL,
    description text,
    entity_type text NOT NULL,
    initial_state_id uuid,
    version integer DEFAULT 1 NOT NULL,
    is_active boolean DEFAULT true NOT NULL,
    created_by uuid NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone
);


--
-- Name: TABLE workflows; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.workflows IS 'Workflow definitions (templates) for business processes';


--
-- Name: COLUMN workflows.entity_type; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.workflows.entity_type IS 'Type of entity this workflow applies to';


--
-- Name: COLUMN workflows.version; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.workflows.version IS 'Workflow version (for iteration without breaking active instances)';


--
-- Name: v_workflow_instances_with_state; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_workflow_instances_with_state AS
 SELECT wi.id,
    wi.org_id,
    w.name AS workflow_name,
    wi.entity_type,
    wi.entity_id,
    ws.name AS current_state,
    ws.display_name AS current_state_display,
    ws.is_terminal,
    wi.status,
    wi.started_at,
    wi.completed_at,
    wi.cancelled_at,
    (EXTRACT(epoch FROM (COALESCE(wi.completed_at, now()) - wi.started_at)) / (3600)::numeric) AS duration_hours,
    up.full_name AS created_by_name,
    wi.created_at,
    wi.updated_at
   FROM (((public.workflow_instances wi
     JOIN public.workflows w ON ((wi.workflow_id = w.id)))
     JOIN public.workflow_states ws ON ((wi.current_state_id = ws.id)))
     JOIN public.user_profiles up ON ((wi.created_by = up.id)))
  WHERE ((wi.org_id = public.auth_user_org_id()) OR public.user_is_admin());


--
-- Name: VIEW v_workflow_instances_with_state; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.v_workflow_instances_with_state IS 'Workflow instances with current state info (org-filtered)';


--
-- Name: v_workflow_metrics; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_workflow_metrics AS
 SELECT w.id AS workflow_id,
    w.name AS workflow_name,
    w.entity_type,
    count(*) AS total_instances,
    count(*) FILTER (WHERE (wi.status = 'active'::text)) AS active_instances,
    count(*) FILTER (WHERE (wi.status = 'completed'::text)) AS completed_instances,
    count(*) FILTER (WHERE (wi.status = 'cancelled'::text)) AS cancelled_instances,
    round(avg((EXTRACT(epoch FROM (wi.completed_at - wi.started_at)) / (3600)::numeric)), 2) AS avg_completion_hours,
    max(wi.started_at) AS last_started_at,
    w.org_id
   FROM (public.workflows w
     LEFT JOIN public.workflow_instances wi ON ((w.id = wi.workflow_id)))
  WHERE ((w.org_id = public.auth_user_org_id()) OR public.user_is_admin())
  GROUP BY w.id, w.name, w.entity_type, w.org_id;


--
-- Name: VIEW v_workflow_metrics; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.v_workflow_metrics IS 'Workflow metrics by workflow type';


--
-- Name: vendor_blacklist; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.vendor_blacklist (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    vendor_id uuid NOT NULL,
    reason text NOT NULL,
    review_date date,
    blacklisted_at timestamp with time zone DEFAULT now() NOT NULL,
    blacklisted_by uuid
);


--
-- Name: TABLE vendor_blacklist; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.vendor_blacklist IS 'Blacklisted vendors';


--
-- Name: vendor_contacts_view; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.vendor_contacts_view AS
 SELECT id,
    vendor_id,
    concat(first_name, ' ', last_name) AS name,
    first_name,
    last_name,
    title,
    email,
    phone,
    department,
    false AS is_primary,
    created_at,
    updated_at
   FROM public.contacts c
  WHERE ((subtype = 'person_vendor_contact'::text) AND (vendor_id IS NOT NULL) AND (deleted_at IS NULL));


--
-- Name: VIEW vendor_contacts_view; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.vendor_contacts_view IS 'View of contacts who are vendor contacts (subtype=person_vendor_contact) - migrated from contact_type=vendor';


--
-- Name: vendor_performance; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.vendor_performance (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    vendor_id uuid NOT NULL,
    period text NOT NULL,
    submissions_count integer DEFAULT 0,
    interviews_count integer DEFAULT 0,
    placements_count integer DEFAULT 0,
    avg_margin_percent numeric(5,2),
    payment_timeliness_score integer,
    responsiveness_score integer,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT vendor_performance_payment_timeliness_score_check CHECK (((payment_timeliness_score >= 1) AND (payment_timeliness_score <= 5))),
    CONSTRAINT vendor_performance_responsiveness_score_check CHECK (((responsiveness_score >= 1) AND (responsiveness_score <= 5)))
);


--
-- Name: TABLE vendor_performance; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.vendor_performance IS 'Monthly performance metrics for vendors';


--
-- Name: vendor_relationships; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.vendor_relationships (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    vendor_id uuid NOT NULL,
    related_entity_type text NOT NULL,
    related_entity_id uuid NOT NULL,
    relationship_type text NOT NULL,
    strength text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid
);


--
-- Name: TABLE vendor_relationships; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.vendor_relationships IS 'Relationships between vendors and other entities';


--
-- Name: vendor_terms; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.vendor_terms (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    vendor_id uuid NOT NULL,
    payment_terms_days integer DEFAULT 30,
    markup_min_percent numeric(5,2),
    markup_max_percent numeric(5,2),
    preferred_rate_range_min numeric(10,2),
    preferred_rate_range_max numeric(10,2),
    contract_type text,
    contract_expiry date,
    msa_on_file boolean DEFAULT false,
    notes text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid
);


--
-- Name: TABLE vendor_terms; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.vendor_terms IS 'Custom negotiated financial terms with vendors';


--
-- Name: vendors; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.vendors (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    name text NOT NULL,
    type public.vendor_type NOT NULL,
    status text DEFAULT 'active'::text NOT NULL,
    tier public.vendor_tier DEFAULT 'standard'::public.vendor_tier,
    website text,
    industry_focus text[],
    geographic_focus text[],
    notes text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid,
    deleted_at timestamp with time zone
);


--
-- Name: TABLE vendors; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.vendors IS 'Vendor/partner companies';


--
-- Name: vendors_v; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.vendors_v AS
 SELECT c.id,
    c.org_id,
    c.name,
    (vd.vendor_type)::text AS type,
    (c.status)::text AS status,
    (c.tier)::text AS tier,
    c.website,
    vd.industry_focus,
    vd.geographic_focus,
    c.created_at,
    c.updated_at,
    c.created_by,
    c.deleted_at
   FROM (public.companies c
     JOIN public.company_vendor_details vd ON ((vd.company_id = c.id)))
  WHERE ((c.category = 'vendor'::public.company_category) AND (c.deleted_at IS NULL));


--
-- Name: VIEW vendors_v; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON VIEW public.vendors_v IS 'Backward compatibility view for vendors table - maps to companies with category = vendor';


--
-- Name: video_progress; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.video_progress (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    topic_id uuid NOT NULL,
    enrollment_id uuid NOT NULL,
    last_position_seconds integer DEFAULT 0 NOT NULL,
    total_watch_time_seconds integer DEFAULT 0 NOT NULL,
    video_duration_seconds integer,
    completion_percentage integer GENERATED ALWAYS AS (
CASE
    WHEN (video_duration_seconds > 0) THEN LEAST(100, ((last_position_seconds * 100) / video_duration_seconds))
    ELSE 0
END) STORED,
    video_url text,
    video_provider text,
    session_count integer DEFAULT 1 NOT NULL,
    last_watched_at timestamp with time zone DEFAULT now(),
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT valid_duration CHECK (((video_duration_seconds IS NULL) OR (video_duration_seconds > 0))),
    CONSTRAINT valid_position CHECK ((last_position_seconds >= 0)),
    CONSTRAINT valid_provider CHECK ((video_provider = ANY (ARRAY['vimeo'::text, 'youtube'::text, 'direct'::text, 's3'::text]))),
    CONSTRAINT valid_watch_time CHECK ((total_watch_time_seconds >= 0))
);


--
-- Name: TABLE video_progress; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.video_progress IS 'Tracks video watching progress and analytics';


--
-- Name: COLUMN video_progress.last_position_seconds; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.video_progress.last_position_seconds IS 'Last playback position for resume functionality';


--
-- Name: COLUMN video_progress.total_watch_time_seconds; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.video_progress.total_watch_time_seconds IS 'Cumulative time spent watching (can exceed video duration)';


--
-- Name: COLUMN video_progress.completion_percentage; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.video_progress.completion_percentage IS 'Calculated from last_position / duration';


--
-- Name: COLUMN video_progress.session_count; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.video_progress.session_count IS 'Number of times user watched this video';


--
-- Name: video_watch_stats; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.video_watch_stats AS
 SELECT vp.user_id,
    vp.topic_id,
    vp.enrollment_id,
    mt.title AS topic_title,
    cm.title AS module_title,
    c.title AS course_title,
    vp.total_watch_time_seconds,
    vp.completion_percentage,
    vp.session_count,
    vp.last_watched_at,
    vp.video_duration_seconds,
    vp.video_provider,
        CASE
            WHEN (vp.video_duration_seconds > 0) THEN LEAST(100, ((vp.total_watch_time_seconds * 100) / vp.video_duration_seconds))
            ELSE 0
        END AS engagement_score
   FROM (((public.video_progress vp
     JOIN public.module_topics mt ON ((mt.id = vp.topic_id)))
     JOIN public.course_modules cm ON ((cm.id = mt.module_id)))
     JOIN public.courses c ON ((c.id = cm.course_id)));


--
-- Name: webhook_deliveries; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.webhook_deliveries (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    webhook_id uuid NOT NULL,
    event_type character varying(100) NOT NULL,
    event_id uuid,
    payload jsonb NOT NULL,
    request_url text NOT NULL,
    request_headers jsonb NOT NULL,
    request_body text NOT NULL,
    response_status integer,
    response_headers jsonb,
    response_body text,
    duration_ms integer,
    attempt_number integer DEFAULT 1,
    max_attempts integer DEFAULT 3,
    status character varying(20) DEFAULT 'pending'::character varying NOT NULL,
    error_message text,
    error_code character varying(50),
    next_retry_at timestamp with time zone,
    delivered_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: webhooks; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.webhooks (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    name character varying(100) NOT NULL,
    description text,
    url text NOT NULL,
    secret character varying(64) NOT NULL,
    events text[] DEFAULT '{}'::text[] NOT NULL,
    headers jsonb DEFAULT '{}'::jsonb,
    status character varying(20) DEFAULT 'active'::character varying NOT NULL,
    consecutive_failures integer DEFAULT 0,
    last_triggered_at timestamp with time zone,
    last_success_at timestamp with time zone,
    last_failure_at timestamp with time zone,
    created_by uuid,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    deleted_at timestamp with time zone
);


--
-- Name: work_queues; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.work_queues (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid,
    queue_name text NOT NULL,
    queue_code text NOT NULL,
    description text,
    queue_type text DEFAULT 'activity'::text,
    entity_type text,
    assigned_to_group_id uuid,
    assignment_strategy text DEFAULT 'round_robin'::text,
    filter_criteria jsonb,
    sort_order text DEFAULT 'priority_desc'::text,
    is_active boolean DEFAULT true,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE work_queues; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.work_queues IS 'Work queue definitions for activity management';


--
-- Name: workflow_history; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.workflow_history (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    workflow_instance_id uuid NOT NULL,
    from_state_id uuid,
    to_state_id uuid NOT NULL,
    action text NOT NULL,
    performed_by uuid NOT NULL,
    notes text,
    metadata jsonb DEFAULT '{}'::jsonb NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE workflow_history; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.workflow_history IS 'Immutable audit trail of workflow state changes';


--
-- Name: workflow_transitions; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.workflow_transitions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    workflow_id uuid NOT NULL,
    from_state_id uuid NOT NULL,
    to_state_id uuid NOT NULL,
    action text NOT NULL,
    display_name text NOT NULL,
    required_permission text,
    conditions jsonb DEFAULT '{}'::jsonb NOT NULL,
    auto_transition boolean DEFAULT false NOT NULL,
    metadata jsonb DEFAULT '{}'::jsonb NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    CONSTRAINT no_self_transition CHECK ((from_state_id <> to_state_id))
);


--
-- Name: TABLE workflow_transitions; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.workflow_transitions IS 'Valid state transitions (edges in state machine)';


--
-- Name: COLUMN workflow_transitions.conditions; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.workflow_transitions.conditions IS 'JSON conditions that must be met for transition';


--
-- Name: COLUMN workflow_transitions.auto_transition; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON COLUMN public.workflow_transitions.auto_transition IS 'If true, transition happens automatically when conditions met';


--
-- Name: workplan_instances; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.workplan_instances (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    template_id uuid,
    entity_type text NOT NULL,
    entity_id uuid NOT NULL,
    template_code text,
    template_name text,
    status text DEFAULT 'active'::text,
    total_activities integer DEFAULT 0,
    completed_activities integer DEFAULT 0,
    skipped_activities integer DEFAULT 0,
    current_phase text,
    started_at timestamp with time zone DEFAULT now(),
    paused_at timestamp with time zone,
    completed_at timestamp with time zone,
    canceled_at timestamp with time zone,
    outcome text,
    outcome_notes text,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    progress_percentage integer GENERATED ALWAYS AS (
CASE
    WHEN (total_activities > 0) THEN (((completed_activities + skipped_activities) * 100) / total_activities)
    ELSE 0
END) STORED
);


--
-- Name: TABLE workplan_instances; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.workplan_instances IS 'Runtime workplan execution tracking';


--
-- Name: workplan_phases; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.workplan_phases (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    template_id uuid NOT NULL,
    phase_name text NOT NULL,
    phase_code text NOT NULL,
    description text,
    order_index integer DEFAULT 0,
    completion_criteria text DEFAULT 'all_required'::text,
    auto_advance boolean DEFAULT true,
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE workplan_phases; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.workplan_phases IS 'Workflow phases for organizing activities';


--
-- Name: workplan_template_activities; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.workplan_template_activities (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    template_id uuid NOT NULL,
    pattern_id uuid NOT NULL,
    order_index integer DEFAULT 0 NOT NULL,
    phase text,
    is_required boolean DEFAULT true,
    skip_condition jsonb,
    can_run_parallel boolean DEFAULT false,
    depends_on_activity_ids uuid[],
    created_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE workplan_template_activities; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.workplan_template_activities IS 'Activity patterns within workplan templates';


--
-- Name: workplan_templates; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.workplan_templates (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid,
    code text NOT NULL,
    name text NOT NULL,
    description text,
    entity_type text NOT NULL,
    trigger_event text DEFAULT 'manual'::text,
    trigger_status text,
    trigger_field text,
    trigger_condition jsonb,
    completion_criteria text DEFAULT 'all_required'::text,
    is_system boolean DEFAULT false,
    is_active boolean DEFAULT true,
    version integer DEFAULT 1,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);


--
-- Name: TABLE workplan_templates; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON TABLE public.workplan_templates IS 'Workflow templates with activity sequences';


--
-- Name: audit_logs_2025_11; Type: TABLE ATTACH; Schema: public; Owner: -
--

ALTER TABLE ONLY public.audit_logs ATTACH PARTITION public.audit_logs_2025_11 FOR VALUES FROM ('2025-11-01 00:00:00+00') TO ('2025-12-01 00:00:00+00');


--
-- Name: audit_logs_2025_12; Type: TABLE ATTACH; Schema: public; Owner: -
--

ALTER TABLE ONLY public.audit_logs ATTACH PARTITION public.audit_logs_2025_12 FOR VALUES FROM ('2025-12-01 00:00:00+00') TO ('2026-01-01 00:00:00+00');


--
-- Name: audit_logs_2026_01; Type: TABLE ATTACH; Schema: public; Owner: -
--

ALTER TABLE ONLY public.audit_logs ATTACH PARTITION public.audit_logs_2026_01 FOR VALUES FROM ('2026-01-01 00:00:00+00') TO ('2026-02-01 00:00:00+00');


--
-- Name: audit_logs_2026_02; Type: TABLE ATTACH; Schema: public; Owner: -
--

ALTER TABLE ONLY public.audit_logs ATTACH PARTITION public.audit_logs_2026_02 FOR VALUES FROM ('2026-02-01 00:00:00+00') TO ('2026-03-01 00:00:00+00');


--
-- Name: audit_logs event_id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.audit_logs ALTER COLUMN event_id SET DEFAULT nextval('public.audit_logs_event_id_seq'::regclass);


--
-- Name: _migration_candidate_mapping _migration_candidate_mapping_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public._migration_candidate_mapping
    ADD CONSTRAINT _migration_candidate_mapping_pkey PRIMARY KEY (user_profile_id);


--
-- Name: _migration_lead_mapping _migration_lead_mapping_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public._migration_lead_mapping
    ADD CONSTRAINT _migration_lead_mapping_pkey PRIMARY KEY (lead_id);


--
-- Name: account_contacts account_contacts_account_id_contact_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.account_contacts
    ADD CONSTRAINT account_contacts_account_id_contact_id_key UNIQUE (account_id, contact_id);


--
-- Name: account_contacts account_contacts_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.account_contacts
    ADD CONSTRAINT account_contacts_pkey PRIMARY KEY (id);


--
-- Name: account_contracts account_contracts_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.account_contracts
    ADD CONSTRAINT account_contracts_pkey PRIMARY KEY (id);


--
-- Name: account_metrics account_metrics_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.account_metrics
    ADD CONSTRAINT account_metrics_pkey PRIMARY KEY (id);


--
-- Name: account_notes account_notes_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.account_notes
    ADD CONSTRAINT account_notes_pkey PRIMARY KEY (id);


--
-- Name: account_preferences account_preferences_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.account_preferences
    ADD CONSTRAINT account_preferences_pkey PRIMARY KEY (id);


--
-- Name: account_team account_team_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.account_team
    ADD CONSTRAINT account_team_pkey PRIMARY KEY (id);


--
-- Name: accounts accounts_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.accounts
    ADD CONSTRAINT accounts_pkey PRIMARY KEY (id);


--
-- Name: achievements achievements_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.achievements
    ADD CONSTRAINT achievements_pkey PRIMARY KEY (id);


--
-- Name: achievements achievements_slug_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.achievements
    ADD CONSTRAINT achievements_slug_key UNIQUE (slug);


--
-- Name: activities activities_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activities
    ADD CONSTRAINT activities_pkey PRIMARY KEY (id);


--
-- Name: activity_attachments activity_attachments_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_attachments
    ADD CONSTRAINT activity_attachments_pkey PRIMARY KEY (id);


--
-- Name: activity_auto_rules activity_auto_rules_org_id_rule_code_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_auto_rules
    ADD CONSTRAINT activity_auto_rules_org_id_rule_code_key UNIQUE (org_id, rule_code);


--
-- Name: activity_auto_rules activity_auto_rules_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_auto_rules
    ADD CONSTRAINT activity_auto_rules_pkey PRIMARY KEY (id);


--
-- Name: activity_checklist_items activity_checklist_items_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_checklist_items
    ADD CONSTRAINT activity_checklist_items_pkey PRIMARY KEY (id);


--
-- Name: activity_comments activity_comments_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_comments
    ADD CONSTRAINT activity_comments_pkey PRIMARY KEY (id);


--
-- Name: activity_dependencies activity_dependencies_activity_id_depends_on_activity_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_dependencies
    ADD CONSTRAINT activity_dependencies_activity_id_depends_on_activity_id_key UNIQUE (activity_id, depends_on_activity_id);


--
-- Name: activity_dependencies activity_dependencies_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_dependencies
    ADD CONSTRAINT activity_dependencies_pkey PRIMARY KEY (id);


--
-- Name: activity_field_values activity_field_values_activity_id_field_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_field_values
    ADD CONSTRAINT activity_field_values_activity_id_field_id_key UNIQUE (activity_id, field_id);


--
-- Name: activity_field_values activity_field_values_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_field_values
    ADD CONSTRAINT activity_field_values_pkey PRIMARY KEY (id);


--
-- Name: activity_history activity_history_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_history
    ADD CONSTRAINT activity_history_pkey PRIMARY KEY (id);


--
-- Name: activity_log activity_log_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_log
    ADD CONSTRAINT activity_log_pkey PRIMARY KEY (id);


--
-- Name: activity_metrics activity_metrics_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_metrics
    ADD CONSTRAINT activity_metrics_pkey PRIMARY KEY (id);


--
-- Name: activity_participants activity_participants_activity_id_user_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_participants
    ADD CONSTRAINT activity_participants_activity_id_user_id_key UNIQUE (activity_id, user_id);


--
-- Name: activity_participants activity_participants_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_participants
    ADD CONSTRAINT activity_participants_pkey PRIMARY KEY (id);


--
-- Name: activity_pattern_successors activity_pattern_successors_pattern_id_successor_pattern_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_pattern_successors
    ADD CONSTRAINT activity_pattern_successors_pattern_id_successor_pattern_id_key UNIQUE (pattern_id, successor_pattern_id);


--
-- Name: activity_pattern_successors activity_pattern_successors_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_pattern_successors
    ADD CONSTRAINT activity_pattern_successors_pkey PRIMARY KEY (id);


--
-- Name: activity_patterns activity_patterns_org_id_code_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_patterns
    ADD CONSTRAINT activity_patterns_org_id_code_key UNIQUE (org_id, code);


--
-- Name: activity_patterns activity_patterns_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_patterns
    ADD CONSTRAINT activity_patterns_pkey PRIMARY KEY (id);


--
-- Name: activity_reminders activity_reminders_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_reminders
    ADD CONSTRAINT activity_reminders_pkey PRIMARY KEY (id);


--
-- Name: activity_stats_daily activity_stats_daily_org_id_user_id_date_pattern_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_stats_daily
    ADD CONSTRAINT activity_stats_daily_org_id_user_id_date_pattern_id_key UNIQUE (org_id, user_id, date, pattern_id);


--
-- Name: activity_stats_daily activity_stats_daily_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_stats_daily
    ADD CONSTRAINT activity_stats_daily_pkey PRIMARY KEY (id);


--
-- Name: activity_time_entries activity_time_entries_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_time_entries
    ADD CONSTRAINT activity_time_entries_pkey PRIMARY KEY (id);


--
-- Name: addresses addresses_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.addresses
    ADD CONSTRAINT addresses_pkey PRIMARY KEY (id);


--
-- Name: ai_agent_interactions ai_agent_interactions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_agent_interactions
    ADD CONSTRAINT ai_agent_interactions_pkey PRIMARY KEY (id);


--
-- Name: ai_conversations ai_conversations_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_conversations
    ADD CONSTRAINT ai_conversations_pkey PRIMARY KEY (id);


--
-- Name: ai_cost_tracking ai_cost_tracking_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_cost_tracking
    ADD CONSTRAINT ai_cost_tracking_pkey PRIMARY KEY (id);


--
-- Name: ai_embeddings ai_embeddings_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_embeddings
    ADD CONSTRAINT ai_embeddings_pkey PRIMARY KEY (id);


--
-- Name: ai_mentor_chats ai_mentor_chats_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_mentor_chats
    ADD CONSTRAINT ai_mentor_chats_pkey PRIMARY KEY (id);


--
-- Name: ai_mentor_escalations ai_mentor_escalations_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_mentor_escalations
    ADD CONSTRAINT ai_mentor_escalations_pkey PRIMARY KEY (id);


--
-- Name: ai_mentor_rate_limits ai_mentor_rate_limits_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_mentor_rate_limits
    ADD CONSTRAINT ai_mentor_rate_limits_pkey PRIMARY KEY (id);


--
-- Name: ai_mentor_rate_limits ai_mentor_rate_limits_user_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_mentor_rate_limits
    ADD CONSTRAINT ai_mentor_rate_limits_user_id_key UNIQUE (user_id);


--
-- Name: ai_mentor_sessions ai_mentor_sessions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_mentor_sessions
    ADD CONSTRAINT ai_mentor_sessions_pkey PRIMARY KEY (id);


--
-- Name: ai_patterns ai_patterns_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_patterns
    ADD CONSTRAINT ai_patterns_pkey PRIMARY KEY (id);


--
-- Name: ai_prompt_variants ai_prompt_variants_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_prompt_variants
    ADD CONSTRAINT ai_prompt_variants_pkey PRIMARY KEY (id);


--
-- Name: ai_prompt_variants ai_prompt_variants_variant_name_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_prompt_variants
    ADD CONSTRAINT ai_prompt_variants_variant_name_key UNIQUE (variant_name);


--
-- Name: ai_prompts ai_prompts_name_version_unique; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_prompts
    ADD CONSTRAINT ai_prompts_name_version_unique UNIQUE (name, version);


--
-- Name: ai_prompts ai_prompts_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_prompts
    ADD CONSTRAINT ai_prompts_pkey PRIMARY KEY (id);


--
-- Name: ai_question_patterns ai_question_patterns_pattern_hash_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_question_patterns
    ADD CONSTRAINT ai_question_patterns_pattern_hash_key UNIQUE (pattern_hash);


--
-- Name: ai_question_patterns ai_question_patterns_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_question_patterns
    ADD CONSTRAINT ai_question_patterns_pkey PRIMARY KEY (id);


--
-- Name: ai_test ai_test_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_test
    ADD CONSTRAINT ai_test_pkey PRIMARY KEY (id);


--
-- Name: alert_rules alert_rules_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.alert_rules
    ADD CONSTRAINT alert_rules_pkey PRIMARY KEY (id);


--
-- Name: api_tokens api_tokens_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.api_tokens
    ADD CONSTRAINT api_tokens_pkey PRIMARY KEY (id);


--
-- Name: approval_instances approval_instances_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.approval_instances
    ADD CONSTRAINT approval_instances_pkey PRIMARY KEY (id);


--
-- Name: approval_steps approval_steps_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.approval_steps
    ADD CONSTRAINT approval_steps_pkey PRIMARY KEY (id);


--
-- Name: approval_workflows approval_workflows_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.approval_workflows
    ADD CONSTRAINT approval_workflows_pkey PRIMARY KEY (id);


--
-- Name: archived_records archived_records_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.archived_records
    ADD CONSTRAINT archived_records_pkey PRIMARY KEY (id);


--
-- Name: audit_log_retention_policy audit_log_retention_policy_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.audit_log_retention_policy
    ADD CONSTRAINT audit_log_retention_policy_pkey PRIMARY KEY (id);


--
-- Name: audit_log_retention_policy audit_log_retention_policy_table_name_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.audit_log_retention_policy
    ADD CONSTRAINT audit_log_retention_policy_table_name_key UNIQUE (table_name);


--
-- Name: background_jobs background_jobs_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.background_jobs
    ADD CONSTRAINT background_jobs_pkey PRIMARY KEY (id);


--
-- Name: badge_progress badge_progress_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.badge_progress
    ADD CONSTRAINT badge_progress_pkey PRIMARY KEY (id);


--
-- Name: badge_progress badge_progress_user_id_badge_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.badge_progress
    ADD CONSTRAINT badge_progress_user_id_badge_id_key UNIQUE (user_id, badge_id);


--
-- Name: badge_trigger_events badge_trigger_events_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.badge_trigger_events
    ADD CONSTRAINT badge_trigger_events_pkey PRIMARY KEY (id);


--
-- Name: badges badges_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.badges
    ADD CONSTRAINT badges_pkey PRIMARY KEY (id);


--
-- Name: badges badges_slug_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.badges
    ADD CONSTRAINT badges_slug_key UNIQUE (slug);


--
-- Name: bench_consultants bench_consultants_candidate_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.bench_consultants
    ADD CONSTRAINT bench_consultants_candidate_id_key UNIQUE (candidate_id);


--
-- Name: bench_consultants bench_consultants_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.bench_consultants
    ADD CONSTRAINT bench_consultants_pkey PRIMARY KEY (id);


--
-- Name: benefit_dependents benefit_dependents_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.benefit_dependents
    ADD CONSTRAINT benefit_dependents_pkey PRIMARY KEY (id);


--
-- Name: benefit_plan_options benefit_plan_options_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.benefit_plan_options
    ADD CONSTRAINT benefit_plan_options_pkey PRIMARY KEY (id);


--
-- Name: benefit_plans benefit_plans_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.benefit_plans
    ADD CONSTRAINT benefit_plans_pkey PRIMARY KEY (id);


--
-- Name: break_glass_access break_glass_access_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.break_glass_access
    ADD CONSTRAINT break_glass_access_pkey PRIMARY KEY (id);


--
-- Name: bulk_activity_jobs bulk_activity_jobs_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.bulk_activity_jobs
    ADD CONSTRAINT bulk_activity_jobs_pkey PRIMARY KEY (id);


--
-- Name: bulk_update_history bulk_update_history_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.bulk_update_history
    ADD CONSTRAINT bulk_update_history_pkey PRIMARY KEY (id);


--
-- Name: campaign_documents campaign_documents_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.campaign_documents
    ADD CONSTRAINT campaign_documents_pkey PRIMARY KEY (id);


--
-- Name: campaign_enrollments campaign_enrollments_campaign_id_contact_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.campaign_enrollments
    ADD CONSTRAINT campaign_enrollments_campaign_id_contact_id_key UNIQUE (campaign_id, contact_id);


--
-- Name: campaign_enrollments campaign_enrollments_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.campaign_enrollments
    ADD CONSTRAINT campaign_enrollments_pkey PRIMARY KEY (id);


--
-- Name: campaign_sequence_logs campaign_sequence_logs_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.campaign_sequence_logs
    ADD CONSTRAINT campaign_sequence_logs_pkey PRIMARY KEY (id);


--
-- Name: campaign_sequences campaign_sequences_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.campaign_sequences
    ADD CONSTRAINT campaign_sequences_pkey PRIMARY KEY (id);


--
-- Name: campaign_sequences campaign_sequences_unique; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.campaign_sequences
    ADD CONSTRAINT campaign_sequences_unique UNIQUE (campaign_id, sequence_template_id);


--
-- Name: campaigns campaigns_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.campaigns
    ADD CONSTRAINT campaigns_pkey PRIMARY KEY (id);


--
-- Name: candidate_availability candidate_availability_candidate_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_availability
    ADD CONSTRAINT candidate_availability_candidate_id_key UNIQUE (candidate_id);


--
-- Name: candidate_availability candidate_availability_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_availability
    ADD CONSTRAINT candidate_availability_pkey PRIMARY KEY (id);


--
-- Name: candidate_background_checks candidate_background_checks_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_background_checks
    ADD CONSTRAINT candidate_background_checks_pkey PRIMARY KEY (id);


--
-- Name: candidate_certifications candidate_certifications_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_certifications
    ADD CONSTRAINT candidate_certifications_pkey PRIMARY KEY (id);


--
-- Name: candidate_compliance_documents candidate_compliance_documents_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_compliance_documents
    ADD CONSTRAINT candidate_compliance_documents_pkey PRIMARY KEY (id);


--
-- Name: candidate_documents candidate_documents_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_documents
    ADD CONSTRAINT candidate_documents_pkey PRIMARY KEY (id);


--
-- Name: candidate_education candidate_education_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_education
    ADD CONSTRAINT candidate_education_pkey PRIMARY KEY (id);


--
-- Name: candidate_embeddings candidate_embeddings_org_id_candidate_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_embeddings
    ADD CONSTRAINT candidate_embeddings_org_id_candidate_id_key UNIQUE (org_id, candidate_id);


--
-- Name: candidate_embeddings candidate_embeddings_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_embeddings
    ADD CONSTRAINT candidate_embeddings_pkey PRIMARY KEY (id);


--
-- Name: candidate_preferences candidate_preferences_candidate_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_preferences
    ADD CONSTRAINT candidate_preferences_candidate_id_key UNIQUE (candidate_id);


--
-- Name: candidate_preferences candidate_preferences_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_preferences
    ADD CONSTRAINT candidate_preferences_pkey PRIMARY KEY (id);


--
-- Name: candidate_prepared_profiles candidate_prepared_profiles_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_prepared_profiles
    ADD CONSTRAINT candidate_prepared_profiles_pkey PRIMARY KEY (id);


--
-- Name: candidate_profiles candidate_profiles_candidate_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_profiles
    ADD CONSTRAINT candidate_profiles_candidate_id_key UNIQUE (candidate_id);


--
-- Name: candidate_profiles candidate_profiles_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_profiles
    ADD CONSTRAINT candidate_profiles_pkey PRIMARY KEY (id);


--
-- Name: candidate_references candidate_references_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_references
    ADD CONSTRAINT candidate_references_pkey PRIMARY KEY (id);


--
-- Name: candidate_resumes candidate_resumes_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_resumes
    ADD CONSTRAINT candidate_resumes_pkey PRIMARY KEY (id);


--
-- Name: candidate_screenings candidate_screenings_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_screenings
    ADD CONSTRAINT candidate_screenings_pkey PRIMARY KEY (id);


--
-- Name: candidate_skills candidate_skills_candidate_id_skill_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_skills
    ADD CONSTRAINT candidate_skills_candidate_id_skill_id_key UNIQUE (candidate_id, skill_id);


--
-- Name: candidate_skills candidate_skills_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_skills
    ADD CONSTRAINT candidate_skills_pkey PRIMARY KEY (id);


--
-- Name: candidate_work_authorizations candidate_work_authorizations_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_work_authorizations
    ADD CONSTRAINT candidate_work_authorizations_pkey PRIMARY KEY (id);


--
-- Name: candidate_work_history candidate_work_history_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_work_history
    ADD CONSTRAINT candidate_work_history_pkey PRIMARY KEY (id);


--
-- Name: capstone_submissions capstone_submissions_enrollment_id_revision_count_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.capstone_submissions
    ADD CONSTRAINT capstone_submissions_enrollment_id_revision_count_key UNIQUE (enrollment_id, revision_count);


--
-- Name: capstone_submissions capstone_submissions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.capstone_submissions
    ADD CONSTRAINT capstone_submissions_pkey PRIMARY KEY (id);


--
-- Name: certificate_templates certificate_templates_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.certificate_templates
    ADD CONSTRAINT certificate_templates_pkey PRIMARY KEY (id);


--
-- Name: certificates certificates_certificate_number_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.certificates
    ADD CONSTRAINT certificates_certificate_number_key UNIQUE (certificate_number);


--
-- Name: certificates certificates_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.certificates
    ADD CONSTRAINT certificates_pkey PRIMARY KEY (id);


--
-- Name: certificates certificates_verification_code_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.certificates
    ADD CONSTRAINT certificates_verification_code_key UNIQUE (verification_code);


--
-- Name: comments comments_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.comments
    ADD CONSTRAINT comments_pkey PRIMARY KEY (id);


--
-- Name: commission_payments commission_payments_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.commission_payments
    ADD CONSTRAINT commission_payments_pkey PRIMARY KEY (id);


--
-- Name: commissions commissions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.commissions
    ADD CONSTRAINT commissions_pkey PRIMARY KEY (id);


--
-- Name: companies companies_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.companies
    ADD CONSTRAINT companies_pkey PRIMARY KEY (id);


--
-- Name: company_addresses company_addresses_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_addresses
    ADD CONSTRAINT company_addresses_pkey PRIMARY KEY (id);


--
-- Name: company_client_details company_client_details_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_client_details
    ADD CONSTRAINT company_client_details_pkey PRIMARY KEY (company_id);


--
-- Name: company_compliance_requirements company_compliance_requirements_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_compliance_requirements
    ADD CONSTRAINT company_compliance_requirements_pkey PRIMARY KEY (company_id);


--
-- Name: company_contacts company_contacts_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_contacts
    ADD CONSTRAINT company_contacts_pkey PRIMARY KEY (id);


--
-- Name: company_contracts company_contracts_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_contracts
    ADD CONSTRAINT company_contracts_pkey PRIMARY KEY (id);


--
-- Name: company_health_scores company_health_scores_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_health_scores
    ADD CONSTRAINT company_health_scores_pkey PRIMARY KEY (id);


--
-- Name: company_metrics company_metrics_company_id_period_type_period_start_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_metrics
    ADD CONSTRAINT company_metrics_company_id_period_type_period_start_key UNIQUE (company_id, period_type, period_start);


--
-- Name: company_metrics company_metrics_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_metrics
    ADD CONSTRAINT company_metrics_pkey PRIMARY KEY (id);


--
-- Name: company_notes company_notes_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_notes
    ADD CONSTRAINT company_notes_pkey PRIMARY KEY (id);


--
-- Name: company_partner_details company_partner_details_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_partner_details
    ADD CONSTRAINT company_partner_details_pkey PRIMARY KEY (company_id);


--
-- Name: company_preferences company_preferences_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_preferences
    ADD CONSTRAINT company_preferences_pkey PRIMARY KEY (company_id);


--
-- Name: company_rate_card_items company_rate_card_items_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_rate_card_items
    ADD CONSTRAINT company_rate_card_items_pkey PRIMARY KEY (id);


--
-- Name: company_rate_cards company_rate_cards_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_rate_cards
    ADD CONSTRAINT company_rate_cards_pkey PRIMARY KEY (id);


--
-- Name: company_relationships company_relationships_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_relationships
    ADD CONSTRAINT company_relationships_pkey PRIMARY KEY (id);


--
-- Name: company_revenue company_revenue_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_revenue
    ADD CONSTRAINT company_revenue_pkey PRIMARY KEY (id);


--
-- Name: company_tags company_tags_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_tags
    ADD CONSTRAINT company_tags_pkey PRIMARY KEY (id);


--
-- Name: company_team company_team_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_team
    ADD CONSTRAINT company_team_pkey PRIMARY KEY (id);


--
-- Name: company_vendor_details company_vendor_details_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_vendor_details
    ADD CONSTRAINT company_vendor_details_pkey PRIMARY KEY (company_id);


--
-- Name: compliance_requirements compliance_requirements_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.compliance_requirements
    ADD CONSTRAINT compliance_requirements_pkey PRIMARY KEY (id);


--
-- Name: consultant_availability consultant_availability_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.consultant_availability
    ADD CONSTRAINT consultant_availability_pkey PRIMARY KEY (id);


--
-- Name: consultant_rates consultant_rates_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.consultant_rates
    ADD CONSTRAINT consultant_rates_pkey PRIMARY KEY (id);


--
-- Name: consultant_visa_details consultant_visa_details_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.consultant_visa_details
    ADD CONSTRAINT consultant_visa_details_pkey PRIMARY KEY (id);


--
-- Name: consultant_work_authorization consultant_work_authorization_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.consultant_work_authorization
    ADD CONSTRAINT consultant_work_authorization_pkey PRIMARY KEY (id);


--
-- Name: contact_agreements contact_agreements_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_agreements
    ADD CONSTRAINT contact_agreements_pkey PRIMARY KEY (id);


--
-- Name: contact_certifications contact_certifications_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_certifications
    ADD CONSTRAINT contact_certifications_pkey PRIMARY KEY (id);


--
-- Name: contact_communication_preferences contact_comm_prefs_unique; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_communication_preferences
    ADD CONSTRAINT contact_comm_prefs_unique UNIQUE (contact_id, channel);


--
-- Name: contact_communication_preferences contact_communication_preferences_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_communication_preferences
    ADD CONSTRAINT contact_communication_preferences_pkey PRIMARY KEY (id);


--
-- Name: contact_compliance contact_compliance_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_compliance
    ADD CONSTRAINT contact_compliance_pkey PRIMARY KEY (id);


--
-- Name: contact_education contact_education_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_education
    ADD CONSTRAINT contact_education_pkey PRIMARY KEY (id);


--
-- Name: contact_lead_data contact_lead_data_contact_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_lead_data
    ADD CONSTRAINT contact_lead_data_contact_id_key UNIQUE (contact_id);


--
-- Name: contact_lead_data contact_lead_data_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_lead_data
    ADD CONSTRAINT contact_lead_data_pkey PRIMARY KEY (id);


--
-- Name: contact_merge_history contact_merge_history_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_merge_history
    ADD CONSTRAINT contact_merge_history_pkey PRIMARY KEY (id);


--
-- Name: contact_rate_cards contact_rate_cards_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_rate_cards
    ADD CONSTRAINT contact_rate_cards_pkey PRIMARY KEY (id);


--
-- Name: contact_relationships contact_relationships_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_relationships
    ADD CONSTRAINT contact_relationships_pkey PRIMARY KEY (id);


--
-- Name: contact_relationships contact_relationships_unique; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_relationships
    ADD CONSTRAINT contact_relationships_unique UNIQUE (source_contact_id, target_contact_id, relationship_type);


--
-- Name: contact_roles contact_roles_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_roles
    ADD CONSTRAINT contact_roles_pkey PRIMARY KEY (id);


--
-- Name: contact_skills contact_skills_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_skills
    ADD CONSTRAINT contact_skills_pkey PRIMARY KEY (id);


--
-- Name: contact_work_history contact_work_history_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_work_history
    ADD CONSTRAINT contact_work_history_pkey PRIMARY KEY (id);


--
-- Name: contacts contacts_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contacts
    ADD CONSTRAINT contacts_pkey PRIMARY KEY (id);


--
-- Name: content_assets content_assets_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.content_assets
    ADD CONSTRAINT content_assets_pkey PRIMARY KEY (id);


--
-- Name: content_assets content_assets_storage_path_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.content_assets
    ADD CONSTRAINT content_assets_storage_path_key UNIQUE (storage_path);


--
-- Name: course_modules course_modules_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.course_modules
    ADD CONSTRAINT course_modules_pkey PRIMARY KEY (id);


--
-- Name: course_pricing course_pricing_course_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.course_pricing
    ADD CONSTRAINT course_pricing_course_id_key UNIQUE (course_id);


--
-- Name: course_pricing course_pricing_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.course_pricing
    ADD CONSTRAINT course_pricing_pkey PRIMARY KEY (id);


--
-- Name: courses courses_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.courses
    ADD CONSTRAINT courses_pkey PRIMARY KEY (id);


--
-- Name: courses courses_slug_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.courses
    ADD CONSTRAINT courses_slug_key UNIQUE (slug);


--
-- Name: deal_competitors deal_competitors_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.deal_competitors
    ADD CONSTRAINT deal_competitors_pkey PRIMARY KEY (id);


--
-- Name: deal_products deal_products_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.deal_products
    ADD CONSTRAINT deal_products_pkey PRIMARY KEY (id);


--
-- Name: deal_stages_history deal_stages_history_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.deal_stages_history
    ADD CONSTRAINT deal_stages_history_pkey PRIMARY KEY (id);


--
-- Name: deal_stakeholders deal_stakeholders_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.deal_stakeholders
    ADD CONSTRAINT deal_stakeholders_pkey PRIMARY KEY (id);


--
-- Name: deals deals_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.deals
    ADD CONSTRAINT deals_pkey PRIMARY KEY (id);


--
-- Name: discount_code_usage discount_code_usage_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.discount_code_usage
    ADD CONSTRAINT discount_code_usage_pkey PRIMARY KEY (id);


--
-- Name: discount_codes discount_codes_code_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.discount_codes
    ADD CONSTRAINT discount_codes_code_key UNIQUE (code);


--
-- Name: discount_codes discount_codes_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.discount_codes
    ADD CONSTRAINT discount_codes_pkey PRIMARY KEY (id);


--
-- Name: document_templates document_templates_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.document_templates
    ADD CONSTRAINT document_templates_pkey PRIMARY KEY (id);


--
-- Name: duplicate_records duplicate_records_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.duplicate_records
    ADD CONSTRAINT duplicate_records_pkey PRIMARY KEY (id);


--
-- Name: duplicate_rules duplicate_rules_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.duplicate_rules
    ADD CONSTRAINT duplicate_rules_pkey PRIMARY KEY (id);


--
-- Name: email_logs email_logs_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.email_logs
    ADD CONSTRAINT email_logs_pkey PRIMARY KEY (id);


--
-- Name: email_senders email_senders_org_id_email_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.email_senders
    ADD CONSTRAINT email_senders_org_id_email_key UNIQUE (org_id, email);


--
-- Name: email_senders email_senders_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.email_senders
    ADD CONSTRAINT email_senders_pkey PRIMARY KEY (id);


--
-- Name: email_sends email_sends_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.email_sends
    ADD CONSTRAINT email_sends_pkey PRIMARY KEY (id);


--
-- Name: email_templates email_templates_org_id_slug_version_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.email_templates
    ADD CONSTRAINT email_templates_org_id_slug_version_key UNIQUE (org_id, slug, version);


--
-- Name: email_templates email_templates_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.email_templates
    ADD CONSTRAINT email_templates_pkey PRIMARY KEY (id);


--
-- Name: emergency_drills emergency_drills_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.emergency_drills
    ADD CONSTRAINT emergency_drills_pkey PRIMARY KEY (id);


--
-- Name: employee_benefits employee_benefits_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.employee_benefits
    ADD CONSTRAINT employee_benefits_pkey PRIMARY KEY (id);


--
-- Name: employee_compliance employee_compliance_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.employee_compliance
    ADD CONSTRAINT employee_compliance_pkey PRIMARY KEY (id);


--
-- Name: employee_documents employee_documents_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.employee_documents
    ADD CONSTRAINT employee_documents_pkey PRIMARY KEY (id);


--
-- Name: employee_metadata employee_metadata_employee_id_number_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.employee_metadata
    ADD CONSTRAINT employee_metadata_employee_id_number_key UNIQUE (employee_id_number);


--
-- Name: employee_metadata employee_metadata_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.employee_metadata
    ADD CONSTRAINT employee_metadata_pkey PRIMARY KEY (user_id);


--
-- Name: employee_onboarding employee_onboarding_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.employee_onboarding
    ADD CONSTRAINT employee_onboarding_pkey PRIMARY KEY (id);


--
-- Name: employee_profiles employee_profiles_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.employee_profiles
    ADD CONSTRAINT employee_profiles_pkey PRIMARY KEY (employee_id);


--
-- Name: employee_screenshots employee_screenshots_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.employee_screenshots
    ADD CONSTRAINT employee_screenshots_pkey PRIMARY KEY (id);


--
-- Name: employee_time_off employee_time_off_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.employee_time_off
    ADD CONSTRAINT employee_time_off_pkey PRIMARY KEY (id);


--
-- Name: employee_twin_interactions employee_twin_interactions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.employee_twin_interactions
    ADD CONSTRAINT employee_twin_interactions_pkey PRIMARY KEY (id);


--
-- Name: employees employees_employee_number_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.employees
    ADD CONSTRAINT employees_employee_number_key UNIQUE (employee_number);


--
-- Name: employees employees_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.employees
    ADD CONSTRAINT employees_pkey PRIMARY KEY (id);


--
-- Name: employees employees_user_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.employees
    ADD CONSTRAINT employees_user_id_key UNIQUE (user_id);


--
-- Name: engagement_tracking engagement_tracking_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.engagement_tracking
    ADD CONSTRAINT engagement_tracking_pkey PRIMARY KEY (id);


--
-- Name: escalation_notifications escalation_notifications_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.escalation_notifications
    ADD CONSTRAINT escalation_notifications_pkey PRIMARY KEY (id);


--
-- Name: escalation_updates escalation_updates_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.escalation_updates
    ADD CONSTRAINT escalation_updates_pkey PRIMARY KEY (id);


--
-- Name: escalations escalations_escalation_number_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.escalations
    ADD CONSTRAINT escalations_escalation_number_key UNIQUE (escalation_number);


--
-- Name: escalations escalations_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.escalations
    ADD CONSTRAINT escalations_pkey PRIMARY KEY (id);


--
-- Name: event_delivery_log event_delivery_log_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.event_delivery_log
    ADD CONSTRAINT event_delivery_log_pkey PRIMARY KEY (id);


--
-- Name: event_subscriptions event_subscriptions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.event_subscriptions
    ADD CONSTRAINT event_subscriptions_pkey PRIMARY KEY (id);


--
-- Name: events events_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.events
    ADD CONSTRAINT events_pkey PRIMARY KEY (id);


--
-- Name: export_jobs export_jobs_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.export_jobs
    ADD CONSTRAINT export_jobs_pkey PRIMARY KEY (id);


--
-- Name: feature_flag_categories feature_flag_categories_org_id_name_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feature_flag_categories
    ADD CONSTRAINT feature_flag_categories_org_id_name_key UNIQUE NULLS NOT DISTINCT (org_id, name);


--
-- Name: feature_flag_categories feature_flag_categories_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feature_flag_categories
    ADD CONSTRAINT feature_flag_categories_pkey PRIMARY KEY (id);


--
-- Name: feature_flag_feedback feature_flag_feedback_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feature_flag_feedback
    ADD CONSTRAINT feature_flag_feedback_pkey PRIMARY KEY (id);


--
-- Name: feature_flag_roles feature_flag_roles_feature_flag_id_role_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feature_flag_roles
    ADD CONSTRAINT feature_flag_roles_feature_flag_id_role_id_key UNIQUE (feature_flag_id, role_id);


--
-- Name: feature_flag_roles feature_flag_roles_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feature_flag_roles
    ADD CONSTRAINT feature_flag_roles_pkey PRIMARY KEY (id);


--
-- Name: feature_flag_usage feature_flag_usage_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feature_flag_usage
    ADD CONSTRAINT feature_flag_usage_pkey PRIMARY KEY (id);


--
-- Name: feature_flags feature_flags_org_id_code_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feature_flags
    ADD CONSTRAINT feature_flags_org_id_code_key UNIQUE NULLS NOT DISTINCT (org_id, key);


--
-- Name: feature_flags feature_flags_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feature_flags
    ADD CONSTRAINT feature_flags_pkey PRIMARY KEY (id);


--
-- Name: file_uploads file_uploads_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.file_uploads
    ADD CONSTRAINT file_uploads_pkey PRIMARY KEY (id);


--
-- Name: gdpr_requests gdpr_requests_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.gdpr_requests
    ADD CONSTRAINT gdpr_requests_pkey PRIMARY KEY (id);


--
-- Name: generated_documents generated_documents_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.generated_documents
    ADD CONSTRAINT generated_documents_pkey PRIMARY KEY (id);


--
-- Name: generated_resumes generated_resumes_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.generated_resumes
    ADD CONSTRAINT generated_resumes_pkey PRIMARY KEY (id);


--
-- Name: graduate_candidates graduate_candidates_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.graduate_candidates
    ADD CONSTRAINT graduate_candidates_pkey PRIMARY KEY (id);


--
-- Name: guru_interactions guru_interactions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.guru_interactions
    ADD CONSTRAINT guru_interactions_pkey PRIMARY KEY (id);


--
-- Name: hotlist_consultants hotlist_consultants_hotlist_id_consultant_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.hotlist_consultants
    ADD CONSTRAINT hotlist_consultants_hotlist_id_consultant_id_key UNIQUE (hotlist_id, consultant_id);


--
-- Name: hotlist_consultants hotlist_consultants_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.hotlist_consultants
    ADD CONSTRAINT hotlist_consultants_pkey PRIMARY KEY (id);


--
-- Name: i9_records i9_records_employee_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.i9_records
    ADD CONSTRAINT i9_records_employee_id_key UNIQUE (employee_id);


--
-- Name: i9_records i9_records_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.i9_records
    ADD CONSTRAINT i9_records_pkey PRIMARY KEY (id);


--
-- Name: immigration_alerts immigration_alerts_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.immigration_alerts
    ADD CONSTRAINT immigration_alerts_pkey PRIMARY KEY (id);


--
-- Name: immigration_attorneys immigration_attorneys_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.immigration_attorneys
    ADD CONSTRAINT immigration_attorneys_pkey PRIMARY KEY (id);


--
-- Name: immigration_documents immigration_documents_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.immigration_documents
    ADD CONSTRAINT immigration_documents_pkey PRIMARY KEY (id);


--
-- Name: immigration_timelines immigration_timelines_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.immigration_timelines
    ADD CONSTRAINT immigration_timelines_pkey PRIMARY KEY (id);


--
-- Name: import_jobs import_jobs_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.import_jobs
    ADD CONSTRAINT import_jobs_pkey PRIMARY KEY (id);


--
-- Name: incident_notifications incident_notifications_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.incident_notifications
    ADD CONSTRAINT incident_notifications_pkey PRIMARY KEY (id);


--
-- Name: incident_timeline incident_timeline_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.incident_timeline
    ADD CONSTRAINT incident_timeline_pkey PRIMARY KEY (id);


--
-- Name: incidents incidents_org_id_incident_number_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.incidents
    ADD CONSTRAINT incidents_org_id_incident_number_key UNIQUE (org_id, incident_number);


--
-- Name: incidents incidents_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.incidents
    ADD CONSTRAINT incidents_pkey PRIMARY KEY (id);


--
-- Name: integration_failover_config integration_failover_config_org_id_integration_type_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.integration_failover_config
    ADD CONSTRAINT integration_failover_config_org_id_integration_type_key UNIQUE (org_id, integration_type);


--
-- Name: integration_failover_config integration_failover_config_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.integration_failover_config
    ADD CONSTRAINT integration_failover_config_pkey PRIMARY KEY (id);


--
-- Name: integration_health_logs integration_health_logs_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.integration_health_logs
    ADD CONSTRAINT integration_health_logs_pkey PRIMARY KEY (id);


--
-- Name: integration_oauth_tokens integration_oauth_tokens_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.integration_oauth_tokens
    ADD CONSTRAINT integration_oauth_tokens_pkey PRIMARY KEY (id);


--
-- Name: integration_retry_config integration_retry_config_org_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.integration_retry_config
    ADD CONSTRAINT integration_retry_config_org_id_key UNIQUE (org_id);


--
-- Name: integration_retry_config integration_retry_config_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.integration_retry_config
    ADD CONSTRAINT integration_retry_config_pkey PRIMARY KEY (id);


--
-- Name: integration_types integration_types_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.integration_types
    ADD CONSTRAINT integration_types_pkey PRIMARY KEY (id);


--
-- Name: integrations integrations_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.integrations
    ADD CONSTRAINT integrations_pkey PRIMARY KEY (id);


--
-- Name: interview_feedback interview_feedback_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.interview_feedback
    ADD CONSTRAINT interview_feedback_pkey PRIMARY KEY (id);


--
-- Name: interview_participants interview_participants_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.interview_participants
    ADD CONSTRAINT interview_participants_pkey PRIMARY KEY (id);


--
-- Name: interview_reminders interview_reminders_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.interview_reminders
    ADD CONSTRAINT interview_reminders_pkey PRIMARY KEY (id);


--
-- Name: interview_sessions interview_sessions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.interview_sessions
    ADD CONSTRAINT interview_sessions_pkey PRIMARY KEY (id);


--
-- Name: interviews interviews_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.interviews
    ADD CONSTRAINT interviews_pkey PRIMARY KEY (id);


--
-- Name: job_assignments job_assignments_job_id_user_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.job_assignments
    ADD CONSTRAINT job_assignments_job_id_user_id_key UNIQUE (job_id, user_id);


--
-- Name: job_assignments job_assignments_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.job_assignments
    ADD CONSTRAINT job_assignments_pkey PRIMARY KEY (id);


--
-- Name: external_job_order_notes job_order_notes_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.external_job_order_notes
    ADD CONSTRAINT job_order_notes_pkey PRIMARY KEY (id);


--
-- Name: external_job_order_requirements job_order_requirements_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.external_job_order_requirements
    ADD CONSTRAINT job_order_requirements_pkey PRIMARY KEY (id);


--
-- Name: external_job_order_skills job_order_skills_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.external_job_order_skills
    ADD CONSTRAINT job_order_skills_pkey PRIMARY KEY (id);


--
-- Name: external_job_order_submissions job_order_submissions_order_id_consultant_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.external_job_order_submissions
    ADD CONSTRAINT job_order_submissions_order_id_consultant_id_key UNIQUE (order_id, consultant_id);


--
-- Name: external_job_order_submissions job_order_submissions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.external_job_order_submissions
    ADD CONSTRAINT job_order_submissions_pkey PRIMARY KEY (id);


--
-- Name: external_job_orders job_orders_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.external_job_orders
    ADD CONSTRAINT job_orders_pkey PRIMARY KEY (id);


--
-- Name: job_rates job_rates_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.job_rates
    ADD CONSTRAINT job_rates_pkey PRIMARY KEY (id);


--
-- Name: job_requirements job_requirements_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.job_requirements
    ADD CONSTRAINT job_requirements_pkey PRIMARY KEY (id);


--
-- Name: job_screening_questions job_screening_questions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.job_screening_questions
    ADD CONSTRAINT job_screening_questions_pkey PRIMARY KEY (id);


--
-- Name: job_skills job_skills_job_id_skill_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.job_skills
    ADD CONSTRAINT job_skills_job_id_skill_id_key UNIQUE (job_id, skill_id);


--
-- Name: job_skills job_skills_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.job_skills
    ADD CONSTRAINT job_skills_pkey PRIMARY KEY (id);


--
-- Name: job_status_history job_status_history_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.job_status_history
    ADD CONSTRAINT job_status_history_pkey PRIMARY KEY (id);


--
-- Name: jobs jobs_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.jobs
    ADD CONSTRAINT jobs_pkey PRIMARY KEY (id);


--
-- Name: lab_instances lab_instances_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lab_instances
    ADD CONSTRAINT lab_instances_pkey PRIMARY KEY (id);


--
-- Name: lab_submissions lab_submissions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lab_submissions
    ADD CONSTRAINT lab_submissions_pkey PRIMARY KEY (id);


--
-- Name: lab_templates lab_templates_github_template_url_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lab_templates
    ADD CONSTRAINT lab_templates_github_template_url_key UNIQUE (github_template_url);


--
-- Name: lab_templates lab_templates_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lab_templates
    ADD CONSTRAINT lab_templates_pkey PRIMARY KEY (id);


--
-- Name: lead_qualification lead_qualification_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lead_qualification
    ADD CONSTRAINT lead_qualification_pkey PRIMARY KEY (id);


--
-- Name: lead_scores lead_scores_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lead_scores
    ADD CONSTRAINT lead_scores_pkey PRIMARY KEY (id);


--
-- Name: lead_sourcing_credits lead_sourcing_credits_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lead_sourcing_credits
    ADD CONSTRAINT lead_sourcing_credits_pkey PRIMARY KEY (id);


--
-- Name: lead_strategies lead_strategies_lead_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lead_strategies
    ADD CONSTRAINT lead_strategies_lead_id_key UNIQUE (lead_id);


--
-- Name: lead_strategies lead_strategies_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lead_strategies
    ADD CONSTRAINT lead_strategies_pkey PRIMARY KEY (id);


--
-- Name: lead_tasks lead_tasks_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lead_tasks
    ADD CONSTRAINT lead_tasks_pkey PRIMARY KEY (id);


--
-- Name: lead_touchpoints lead_touchpoints_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lead_touchpoints
    ADD CONSTRAINT lead_touchpoints_pkey PRIMARY KEY (id);


--
-- Name: leaderboard_entries leaderboard_entries_leaderboard_id_user_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.leaderboard_entries
    ADD CONSTRAINT leaderboard_entries_leaderboard_id_user_id_key UNIQUE (leaderboard_id, user_id);


--
-- Name: leaderboard_entries leaderboard_entries_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.leaderboard_entries
    ADD CONSTRAINT leaderboard_entries_pkey PRIMARY KEY (id);


--
-- Name: leaderboards leaderboards_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.leaderboards
    ADD CONSTRAINT leaderboards_pkey PRIMARY KEY (id);


--
-- Name: leads leads_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.leads
    ADD CONSTRAINT leads_pkey PRIMARY KEY (id);


--
-- Name: learning_path_courses learning_path_courses_path_id_course_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.learning_path_courses
    ADD CONSTRAINT learning_path_courses_path_id_course_id_key UNIQUE (path_id, course_id);


--
-- Name: learning_path_courses learning_path_courses_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.learning_path_courses
    ADD CONSTRAINT learning_path_courses_pkey PRIMARY KEY (id);


--
-- Name: learning_paths learning_paths_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.learning_paths
    ADD CONSTRAINT learning_paths_pkey PRIMARY KEY (id);


--
-- Name: learning_paths learning_paths_slug_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.learning_paths
    ADD CONSTRAINT learning_paths_slug_key UNIQUE (slug);


--
-- Name: learning_streaks learning_streaks_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.learning_streaks
    ADD CONSTRAINT learning_streaks_pkey PRIMARY KEY (id);


--
-- Name: learning_streaks learning_streaks_user_id_streak_type_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.learning_streaks
    ADD CONSTRAINT learning_streaks_user_id_streak_type_key UNIQUE (user_id, streak_type);


--
-- Name: level_definitions level_definitions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.level_definitions
    ADD CONSTRAINT level_definitions_pkey PRIMARY KEY (level);


--
-- Name: login_history login_history_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.login_history
    ADD CONSTRAINT login_history_pkey PRIMARY KEY (id);


--
-- Name: marketing_formats marketing_formats_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.marketing_formats
    ADD CONSTRAINT marketing_formats_pkey PRIMARY KEY (id);


--
-- Name: marketing_profiles marketing_profiles_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.marketing_profiles
    ADD CONSTRAINT marketing_profiles_pkey PRIMARY KEY (id);


--
-- Name: marketing_templates marketing_templates_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.marketing_templates
    ADD CONSTRAINT marketing_templates_pkey PRIMARY KEY (id);


--
-- Name: meeting_notes meeting_notes_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.meeting_notes
    ADD CONSTRAINT meeting_notes_pkey PRIMARY KEY (id);


--
-- Name: module_topics module_topics_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.module_topics
    ADD CONSTRAINT module_topics_pkey PRIMARY KEY (id);


--
-- Name: notifications notifications_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.notifications
    ADD CONSTRAINT notifications_pkey PRIMARY KEY (id);


--
-- Name: object_owners object_owners_entity_type_entity_id_user_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.object_owners
    ADD CONSTRAINT object_owners_entity_type_entity_id_user_id_key UNIQUE (entity_type, entity_id, user_id);


--
-- Name: object_owners object_owners_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.object_owners
    ADD CONSTRAINT object_owners_pkey PRIMARY KEY (id);


--
-- Name: offer_approvals offer_approvals_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.offer_approvals
    ADD CONSTRAINT offer_approvals_pkey PRIMARY KEY (id);


--
-- Name: offer_negotiations offer_negotiations_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.offer_negotiations
    ADD CONSTRAINT offer_negotiations_pkey PRIMARY KEY (id);


--
-- Name: offer_terms offer_terms_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.offer_terms
    ADD CONSTRAINT offer_terms_pkey PRIMARY KEY (id);


--
-- Name: offers offers_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.offers
    ADD CONSTRAINT offers_pkey PRIMARY KEY (id);


--
-- Name: onboarding_checklist onboarding_checklist_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.onboarding_checklist
    ADD CONSTRAINT onboarding_checklist_pkey PRIMARY KEY (id);


--
-- Name: onboarding_tasks onboarding_tasks_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.onboarding_tasks
    ADD CONSTRAINT onboarding_tasks_pkey PRIMARY KEY (id);


--
-- Name: org_context_cache org_context_cache_org_id_context_type_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.org_context_cache
    ADD CONSTRAINT org_context_cache_org_id_context_type_key UNIQUE (org_id, context_type);


--
-- Name: org_context_cache org_context_cache_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.org_context_cache
    ADD CONSTRAINT org_context_cache_pkey PRIMARY KEY (id);


--
-- Name: org_standups org_standups_org_id_standup_date_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.org_standups
    ADD CONSTRAINT org_standups_org_id_standup_date_key UNIQUE (org_id, standup_date);


--
-- Name: org_standups org_standups_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.org_standups
    ADD CONSTRAINT org_standups_pkey PRIMARY KEY (id);


--
-- Name: organization_branding organization_branding_org_id_asset_type_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.organization_branding
    ADD CONSTRAINT organization_branding_org_id_asset_type_key UNIQUE (org_id, asset_type);


--
-- Name: organization_branding organization_branding_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.organization_branding
    ADD CONSTRAINT organization_branding_pkey PRIMARY KEY (id);


--
-- Name: organization_settings organization_settings_org_id_key_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.organization_settings
    ADD CONSTRAINT organization_settings_org_id_key_key UNIQUE (org_id, key);


--
-- Name: organization_settings organization_settings_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.organization_settings
    ADD CONSTRAINT organization_settings_pkey PRIMARY KEY (id);


--
-- Name: organizations organizations_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.organizations
    ADD CONSTRAINT organizations_pkey PRIMARY KEY (id);


--
-- Name: organizations organizations_slug_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.organizations
    ADD CONSTRAINT organizations_slug_key UNIQUE (slug);


--
-- Name: path_enrollments path_enrollments_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.path_enrollments
    ADD CONSTRAINT path_enrollments_pkey PRIMARY KEY (id);


--
-- Name: path_enrollments path_enrollments_user_id_path_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.path_enrollments
    ADD CONSTRAINT path_enrollments_user_id_path_id_key UNIQUE (user_id, path_id);


--
-- Name: pattern_checklist_items pattern_checklist_items_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.pattern_checklist_items
    ADD CONSTRAINT pattern_checklist_items_pkey PRIMARY KEY (id);


--
-- Name: pattern_fields pattern_fields_pattern_id_field_name_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.pattern_fields
    ADD CONSTRAINT pattern_fields_pattern_id_field_name_key UNIQUE (pattern_id, field_name);


--
-- Name: pattern_fields pattern_fields_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.pattern_fields
    ADD CONSTRAINT pattern_fields_pkey PRIMARY KEY (id);


--
-- Name: payment_transactions payment_transactions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payment_transactions
    ADD CONSTRAINT payment_transactions_pkey PRIMARY KEY (id);


--
-- Name: payroll_items payroll_items_payroll_run_id_employee_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payroll_items
    ADD CONSTRAINT payroll_items_payroll_run_id_employee_id_key UNIQUE (payroll_run_id, employee_id);


--
-- Name: payroll_items payroll_items_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payroll_items
    ADD CONSTRAINT payroll_items_pkey PRIMARY KEY (id);


--
-- Name: payroll_runs payroll_runs_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payroll_runs
    ADD CONSTRAINT payroll_runs_pkey PRIMARY KEY (id);


--
-- Name: peer_reviews peer_reviews_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.peer_reviews
    ADD CONSTRAINT peer_reviews_pkey PRIMARY KEY (id);


--
-- Name: peer_reviews peer_reviews_submission_id_reviewer_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.peer_reviews
    ADD CONSTRAINT peer_reviews_submission_id_reviewer_id_key UNIQUE (submission_id, reviewer_id);


--
-- Name: performance_feedback performance_feedback_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.performance_feedback
    ADD CONSTRAINT performance_feedback_pkey PRIMARY KEY (id);


--
-- Name: performance_goals performance_goals_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.performance_goals
    ADD CONSTRAINT performance_goals_pkey PRIMARY KEY (id);


--
-- Name: performance_reviews performance_reviews_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.performance_reviews
    ADD CONSTRAINT performance_reviews_pkey PRIMARY KEY (id);


--
-- Name: permission_overrides permission_overrides_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.permission_overrides
    ADD CONSTRAINT permission_overrides_pkey PRIMARY KEY (id);


--
-- Name: permissions permissions_code_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.permissions
    ADD CONSTRAINT permissions_code_key UNIQUE (code);


--
-- Name: permissions permissions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.permissions
    ADD CONSTRAINT permissions_pkey PRIMARY KEY (id);


--
-- Name: placement_checkins placement_checkins_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placement_checkins
    ADD CONSTRAINT placement_checkins_pkey PRIMARY KEY (id);


--
-- Name: placement_credits placement_credits_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placement_credits
    ADD CONSTRAINT placement_credits_pkey PRIMARY KEY (id);


--
-- Name: placement_extensions placement_extensions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placement_extensions
    ADD CONSTRAINT placement_extensions_pkey PRIMARY KEY (id);


--
-- Name: placement_milestones placement_milestones_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placement_milestones
    ADD CONSTRAINT placement_milestones_pkey PRIMARY KEY (id);


--
-- Name: placement_rates placement_rates_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placement_rates
    ADD CONSTRAINT placement_rates_pkey PRIMARY KEY (id);


--
-- Name: placement_timesheets placement_timesheets_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placement_timesheets
    ADD CONSTRAINT placement_timesheets_pkey PRIMARY KEY (id);


--
-- Name: placements placements_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placements
    ADD CONSTRAINT placements_pkey PRIMARY KEY (id);


--
-- Name: pod_managers pod_managers_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.pod_managers
    ADD CONSTRAINT pod_managers_pkey PRIMARY KEY (id);


--
-- Name: pod_members pod_members_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.pod_members
    ADD CONSTRAINT pod_members_pkey PRIMARY KEY (id);


--
-- Name: pod_members pod_members_pod_id_user_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.pod_members
    ADD CONSTRAINT pod_members_pod_id_user_id_key UNIQUE (pod_id, user_id);


--
-- Name: pod_sprint_metrics pod_sprint_metrics_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.pod_sprint_metrics
    ADD CONSTRAINT pod_sprint_metrics_pkey PRIMARY KEY (id);


--
-- Name: pod_sprint_metrics pod_sprint_metrics_pod_id_sprint_number_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.pod_sprint_metrics
    ADD CONSTRAINT pod_sprint_metrics_pod_id_sprint_number_key UNIQUE (pod_id, sprint_number);


--
-- Name: pods pods_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.pods
    ADD CONSTRAINT pods_pkey PRIMARY KEY (id);


--
-- Name: pricing_plans pricing_plans_name_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.pricing_plans
    ADD CONSTRAINT pricing_plans_name_key UNIQUE (name);


--
-- Name: pricing_plans pricing_plans_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.pricing_plans
    ADD CONSTRAINT pricing_plans_pkey PRIMARY KEY (id);


--
-- Name: pricing_plans pricing_plans_slug_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.pricing_plans
    ADD CONSTRAINT pricing_plans_slug_key UNIQUE (slug);


--
-- Name: productivity_reports productivity_reports_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.productivity_reports
    ADD CONSTRAINT productivity_reports_pkey PRIMARY KEY (id);


--
-- Name: productivity_reports productivity_reports_user_id_date_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.productivity_reports
    ADD CONSTRAINT productivity_reports_user_id_date_key UNIQUE (user_id, date);


--
-- Name: project_timeline project_timeline_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.project_timeline
    ADD CONSTRAINT project_timeline_pkey PRIMARY KEY (id);


--
-- Name: pto_balances pto_balances_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.pto_balances
    ADD CONSTRAINT pto_balances_pkey PRIMARY KEY (employee_id, year);


--
-- Name: queue_items queue_items_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.queue_items
    ADD CONSTRAINT queue_items_pkey PRIMARY KEY (id);


--
-- Name: queue_items queue_items_queue_id_entity_type_entity_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.queue_items
    ADD CONSTRAINT queue_items_queue_id_entity_type_entity_id_key UNIQUE (queue_id, entity_type, entity_id);


--
-- Name: quiz_attempts quiz_attempts_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.quiz_attempts
    ADD CONSTRAINT quiz_attempts_pkey PRIMARY KEY (id);


--
-- Name: quiz_questions quiz_questions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.quiz_questions
    ADD CONSTRAINT quiz_questions_pkey PRIMARY KEY (id);


--
-- Name: quiz_settings quiz_settings_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.quiz_settings
    ADD CONSTRAINT quiz_settings_pkey PRIMARY KEY (id);


--
-- Name: quiz_settings quiz_settings_topic_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.quiz_settings
    ADD CONSTRAINT quiz_settings_topic_id_key UNIQUE (topic_id);


--
-- Name: raci_change_log raci_change_log_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.raci_change_log
    ADD CONSTRAINT raci_change_log_pkey PRIMARY KEY (id);


--
-- Name: reading_progress reading_progress_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.reading_progress
    ADD CONSTRAINT reading_progress_pkey PRIMARY KEY (id);


--
-- Name: reading_progress reading_progress_user_id_topic_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.reading_progress
    ADD CONSTRAINT reading_progress_user_id_topic_id_key UNIQUE (user_id, topic_id);


--
-- Name: regions regions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.regions
    ADD CONSTRAINT regions_pkey PRIMARY KEY (id);


--
-- Name: requisition_embeddings requisition_embeddings_org_id_requisition_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.requisition_embeddings
    ADD CONSTRAINT requisition_embeddings_org_id_requisition_id_key UNIQUE (org_id, requisition_id);


--
-- Name: requisition_embeddings requisition_embeddings_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.requisition_embeddings
    ADD CONSTRAINT requisition_embeddings_pkey PRIMARY KEY (id);


--
-- Name: resume_matches resume_matches_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.resume_matches
    ADD CONSTRAINT resume_matches_pkey PRIMARY KEY (id);


--
-- Name: resume_versions resume_versions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.resume_versions
    ADD CONSTRAINT resume_versions_pkey PRIMARY KEY (id);


--
-- Name: resume_versions resume_versions_student_id_version_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.resume_versions
    ADD CONSTRAINT resume_versions_student_id_version_key UNIQUE (student_id, version);


--
-- Name: retention_policies retention_policies_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.retention_policies
    ADD CONSTRAINT retention_policies_pkey PRIMARY KEY (id);


--
-- Name: role_permissions role_permissions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.role_permissions
    ADD CONSTRAINT role_permissions_pkey PRIMARY KEY (id);


--
-- Name: role_permissions role_permissions_role_id_permission_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.role_permissions
    ADD CONSTRAINT role_permissions_role_id_permission_id_key UNIQUE (role_id, permission_id);


--
-- Name: roles roles_name_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roles
    ADD CONSTRAINT roles_name_key UNIQUE (name);


--
-- Name: roles roles_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roles
    ADD CONSTRAINT roles_pkey PRIMARY KEY (id);


--
-- Name: saved_searches saved_searches_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.saved_searches
    ADD CONSTRAINT saved_searches_pkey PRIMARY KEY (id);


--
-- Name: saved_searches saved_searches_unique_name; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.saved_searches
    ADD CONSTRAINT saved_searches_unique_name UNIQUE (org_id, user_id, name, entity_type);


--
-- Name: security_alerts security_alerts_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.security_alerts
    ADD CONSTRAINT security_alerts_pkey PRIMARY KEY (id);


--
-- Name: sequence_templates sequence_templates_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.sequence_templates
    ADD CONSTRAINT sequence_templates_pkey PRIMARY KEY (id);


--
-- Name: session_metadata session_metadata_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.session_metadata
    ADD CONSTRAINT session_metadata_pkey PRIMARY KEY (id);


--
-- Name: session_metadata session_metadata_session_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.session_metadata
    ADD CONSTRAINT session_metadata_session_id_key UNIQUE (session_id);


--
-- Name: skill_aliases skill_aliases_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.skill_aliases
    ADD CONSTRAINT skill_aliases_pkey PRIMARY KEY (id);


--
-- Name: skills skills_name_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.skills
    ADD CONSTRAINT skills_name_key UNIQUE (name);


--
-- Name: skills skills_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.skills
    ADD CONSTRAINT skills_pkey PRIMARY KEY (id);


--
-- Name: sla_definitions sla_definitions_org_id_sla_code_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.sla_definitions
    ADD CONSTRAINT sla_definitions_org_id_sla_code_key UNIQUE (org_id, sla_code);


--
-- Name: sla_definitions sla_definitions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.sla_definitions
    ADD CONSTRAINT sla_definitions_pkey PRIMARY KEY (id);


--
-- Name: sla_escalation_levels sla_escalation_levels_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.sla_escalation_levels
    ADD CONSTRAINT sla_escalation_levels_pkey PRIMARY KEY (id);


--
-- Name: sla_escalation_levels sla_escalation_levels_sla_definition_id_level_number_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.sla_escalation_levels
    ADD CONSTRAINT sla_escalation_levels_sla_definition_id_level_number_key UNIQUE (sla_definition_id, level_number);


--
-- Name: sla_events sla_events_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.sla_events
    ADD CONSTRAINT sla_events_pkey PRIMARY KEY (id);


--
-- Name: sla_events sla_events_sla_definition_id_entity_type_entity_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.sla_events
    ADD CONSTRAINT sla_events_sla_definition_id_entity_type_entity_id_key UNIQUE (sla_definition_id, entity_type, entity_id);


--
-- Name: sla_instances sla_instances_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.sla_instances
    ADD CONSTRAINT sla_instances_pkey PRIMARY KEY (id);


--
-- Name: sla_notifications sla_notifications_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.sla_notifications
    ADD CONSTRAINT sla_notifications_pkey PRIMARY KEY (id);


--
-- Name: sla_scheduled_runs sla_scheduled_runs_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.sla_scheduled_runs
    ADD CONSTRAINT sla_scheduled_runs_pkey PRIMARY KEY (id);


--
-- Name: student_enrollments student_enrollments_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.student_enrollments
    ADD CONSTRAINT student_enrollments_pkey PRIMARY KEY (id);


--
-- Name: student_interventions student_interventions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.student_interventions
    ADD CONSTRAINT student_interventions_pkey PRIMARY KEY (id);


--
-- Name: student_progress student_progress_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.student_progress
    ADD CONSTRAINT student_progress_pkey PRIMARY KEY (id);


--
-- Name: student_progress student_progress_student_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.student_progress
    ADD CONSTRAINT student_progress_student_id_key UNIQUE (student_id);


--
-- Name: submission_notes submission_notes_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.submission_notes
    ADD CONSTRAINT submission_notes_pkey PRIMARY KEY (id);


--
-- Name: submission_rates submission_rates_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.submission_rates
    ADD CONSTRAINT submission_rates_pkey PRIMARY KEY (id);


--
-- Name: submission_rates submission_rates_submission_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.submission_rates
    ADD CONSTRAINT submission_rates_submission_id_key UNIQUE (submission_id);


--
-- Name: submission_screening_answers submission_screening_answers_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.submission_screening_answers
    ADD CONSTRAINT submission_screening_answers_pkey PRIMARY KEY (id);


--
-- Name: submission_screening_answers submission_screening_answers_submission_id_question_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.submission_screening_answers
    ADD CONSTRAINT submission_screening_answers_submission_id_question_id_key UNIQUE (submission_id, question_id);


--
-- Name: submission_status_history submission_status_history_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.submission_status_history
    ADD CONSTRAINT submission_status_history_pkey PRIMARY KEY (id);


--
-- Name: submissions submissions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.submissions
    ADD CONSTRAINT submissions_pkey PRIMARY KEY (id);


--
-- Name: system_roles system_roles_code_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.system_roles
    ADD CONSTRAINT system_roles_code_key UNIQUE (code);


--
-- Name: system_roles system_roles_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.system_roles
    ADD CONSTRAINT system_roles_pkey PRIMARY KEY (id);


--
-- Name: system_settings system_settings_key_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.system_settings
    ADD CONSTRAINT system_settings_key_key UNIQUE (key);


--
-- Name: system_settings system_settings_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.system_settings
    ADD CONSTRAINT system_settings_pkey PRIMARY KEY (id);


--
-- Name: talking_point_templates talking_point_templates_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.talking_point_templates
    ADD CONSTRAINT talking_point_templates_pkey PRIMARY KEY (id);


--
-- Name: tasks tasks_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.tasks
    ADD CONSTRAINT tasks_pkey PRIMARY KEY (id);


--
-- Name: team_metrics team_metrics_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.team_metrics
    ADD CONSTRAINT team_metrics_pkey PRIMARY KEY (id);


--
-- Name: team_metrics team_metrics_pod_id_metric_date_metric_period_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.team_metrics
    ADD CONSTRAINT team_metrics_pod_id_metric_date_metric_period_key UNIQUE (pod_id, metric_date, metric_period);


--
-- Name: time_attendance time_attendance_employee_id_date_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.time_attendance
    ADD CONSTRAINT time_attendance_employee_id_date_key UNIQUE (employee_id, date);


--
-- Name: time_attendance time_attendance_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.time_attendance
    ADD CONSTRAINT time_attendance_pkey PRIMARY KEY (id);


--
-- Name: topic_completions topic_completions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.topic_completions
    ADD CONSTRAINT topic_completions_pkey PRIMARY KEY (id);


--
-- Name: topic_lessons topic_lessons_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.topic_lessons
    ADD CONSTRAINT topic_lessons_pkey PRIMARY KEY (id);


--
-- Name: trainer_responses trainer_responses_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.trainer_responses
    ADD CONSTRAINT trainer_responses_pkey PRIMARY KEY (id);


--
-- Name: twin_conversations twin_conversations_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.twin_conversations
    ADD CONSTRAINT twin_conversations_pkey PRIMARY KEY (id);


--
-- Name: twin_events twin_events_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.twin_events
    ADD CONSTRAINT twin_events_pkey PRIMARY KEY (id);


--
-- Name: twin_preferences twin_preferences_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.twin_preferences
    ADD CONSTRAINT twin_preferences_pkey PRIMARY KEY (id);


--
-- Name: twin_preferences twin_preferences_user_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.twin_preferences
    ADD CONSTRAINT twin_preferences_user_id_key UNIQUE (user_id);


--
-- Name: alert_rules unique_alert_rule_name_per_org; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.alert_rules
    ADD CONSTRAINT unique_alert_rule_name_per_org UNIQUE (org_id, name);


--
-- Name: archived_records unique_archived_record; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.archived_records
    ADD CONSTRAINT unique_archived_record UNIQUE (org_id, entity_type, original_id);


--
-- Name: onboarding_checklist unique_checklist_per_user; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.onboarding_checklist
    ADD CONSTRAINT unique_checklist_per_user UNIQUE (user_id);


--
-- Name: course_modules unique_course_module_number; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.course_modules
    ADD CONSTRAINT unique_course_module_number UNIQUE (course_id, module_number);


--
-- Name: course_modules unique_course_module_slug; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.course_modules
    ADD CONSTRAINT unique_course_module_slug UNIQUE (course_id, slug);


--
-- Name: duplicate_records unique_duplicate_pair; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.duplicate_records
    ADD CONSTRAINT unique_duplicate_pair UNIQUE (org_id, entity_type, record_id_1, record_id_2);


--
-- Name: email_templates unique_email_template_name; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.email_templates
    ADD CONSTRAINT unique_email_template_name UNIQUE (org_id, name);


--
-- Name: workflow_instances unique_entity_workflow; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflow_instances
    ADD CONSTRAINT unique_entity_workflow UNIQUE (org_id, entity_type, entity_id, workflow_id);


--
-- Name: file_uploads unique_file_path; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.file_uploads
    ADD CONSTRAINT unique_file_path UNIQUE (bucket, file_path);


--
-- Name: module_topics unique_module_topic_number; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.module_topics
    ADD CONSTRAINT unique_module_topic_number UNIQUE (module_id, topic_number);


--
-- Name: module_topics unique_module_topic_slug; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.module_topics
    ADD CONSTRAINT unique_module_topic_slug UNIQUE (module_id, slug);


--
-- Name: retention_policies unique_retention_policy; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.retention_policies
    ADD CONSTRAINT unique_retention_policy UNIQUE (org_id, entity_type, policy_name);


--
-- Name: duplicate_rules unique_rule_name; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.duplicate_rules
    ADD CONSTRAINT unique_rule_name UNIQUE (org_id, entity_type, rule_name);


--
-- Name: workflow_states unique_state_name_per_workflow; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflow_states
    ADD CONSTRAINT unique_state_name_per_workflow UNIQUE (workflow_id, name);


--
-- Name: workflow_states unique_state_order_per_workflow; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflow_states
    ADD CONSTRAINT unique_state_order_per_workflow UNIQUE (workflow_id, state_order);


--
-- Name: document_templates unique_template_name_per_org; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.document_templates
    ADD CONSTRAINT unique_template_name_per_org UNIQUE (org_id, name);


--
-- Name: topic_lessons unique_topic_lesson_number; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.topic_lessons
    ADD CONSTRAINT unique_topic_lesson_number UNIQUE (topic_id, lesson_number);


--
-- Name: workflow_transitions unique_transition_action; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflow_transitions
    ADD CONSTRAINT unique_transition_action UNIQUE (workflow_id, from_state_id, action);


--
-- Name: student_enrollments unique_user_course_enrollment; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.student_enrollments
    ADD CONSTRAINT unique_user_course_enrollment UNIQUE (user_id, course_id);


--
-- Name: topic_completions unique_user_topic_completion; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.topic_completions
    ADD CONSTRAINT unique_user_topic_completion UNIQUE (user_id, topic_id);


--
-- Name: workflows unique_workflow_name_per_org; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflows
    ADD CONSTRAINT unique_workflow_name_per_org UNIQUE (org_id, name, version);


--
-- Name: activities uq_activities_org_activity_number; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activities
    ADD CONSTRAINT uq_activities_org_activity_number UNIQUE (org_id, activity_number);


--
-- Name: user_achievements user_achievements_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_achievements
    ADD CONSTRAINT user_achievements_pkey PRIMARY KEY (id);


--
-- Name: user_achievements user_achievements_user_id_achievement_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_achievements
    ADD CONSTRAINT user_achievements_user_id_achievement_id_key UNIQUE (user_id, achievement_id);


--
-- Name: user_badges user_badges_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_badges
    ADD CONSTRAINT user_badges_pkey PRIMARY KEY (id);


--
-- Name: user_badges user_badges_user_id_badge_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_badges
    ADD CONSTRAINT user_badges_user_id_badge_id_key UNIQUE (user_id, badge_id);


--
-- Name: user_invitations user_invitations_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_invitations
    ADD CONSTRAINT user_invitations_pkey PRIMARY KEY (id);


--
-- Name: user_invitations user_invitations_token_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_invitations
    ADD CONSTRAINT user_invitations_token_key UNIQUE (token);


--
-- Name: user_levels user_levels_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_levels
    ADD CONSTRAINT user_levels_pkey PRIMARY KEY (user_id);


--
-- Name: user_profiles user_profiles_auth_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_profiles
    ADD CONSTRAINT user_profiles_auth_id_key UNIQUE (auth_id);


--
-- Name: user_profiles user_profiles_email_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_profiles
    ADD CONSTRAINT user_profiles_email_key UNIQUE (email);


--
-- Name: user_profiles user_profiles_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_profiles
    ADD CONSTRAINT user_profiles_pkey PRIMARY KEY (id);


--
-- Name: user_roles user_roles_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_roles
    ADD CONSTRAINT user_roles_pkey PRIMARY KEY (user_id, role_id);


--
-- Name: user_session_context user_session_context_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_session_context
    ADD CONSTRAINT user_session_context_pkey PRIMARY KEY (id);


--
-- Name: vendor_blacklist vendor_blacklist_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.vendor_blacklist
    ADD CONSTRAINT vendor_blacklist_pkey PRIMARY KEY (id);


--
-- Name: vendor_performance vendor_performance_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.vendor_performance
    ADD CONSTRAINT vendor_performance_pkey PRIMARY KEY (id);


--
-- Name: vendor_performance vendor_performance_vendor_id_period_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.vendor_performance
    ADD CONSTRAINT vendor_performance_vendor_id_period_key UNIQUE (vendor_id, period);


--
-- Name: vendor_relationships vendor_relationships_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.vendor_relationships
    ADD CONSTRAINT vendor_relationships_pkey PRIMARY KEY (id);


--
-- Name: vendor_terms vendor_terms_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.vendor_terms
    ADD CONSTRAINT vendor_terms_pkey PRIMARY KEY (id);


--
-- Name: vendors vendors_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.vendors
    ADD CONSTRAINT vendors_pkey PRIMARY KEY (id);


--
-- Name: video_progress video_progress_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.video_progress
    ADD CONSTRAINT video_progress_pkey PRIMARY KEY (id);


--
-- Name: video_progress video_progress_user_id_topic_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.video_progress
    ADD CONSTRAINT video_progress_user_id_topic_id_key UNIQUE (user_id, topic_id);


--
-- Name: webhook_deliveries webhook_deliveries_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.webhook_deliveries
    ADD CONSTRAINT webhook_deliveries_pkey PRIMARY KEY (id);


--
-- Name: webhooks webhooks_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.webhooks
    ADD CONSTRAINT webhooks_pkey PRIMARY KEY (id);


--
-- Name: work_queues work_queues_org_id_queue_code_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.work_queues
    ADD CONSTRAINT work_queues_org_id_queue_code_key UNIQUE (org_id, queue_code);


--
-- Name: work_queues work_queues_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.work_queues
    ADD CONSTRAINT work_queues_pkey PRIMARY KEY (id);


--
-- Name: workflow_history workflow_history_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflow_history
    ADD CONSTRAINT workflow_history_pkey PRIMARY KEY (id);


--
-- Name: workflow_instances workflow_instances_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflow_instances
    ADD CONSTRAINT workflow_instances_pkey PRIMARY KEY (id);


--
-- Name: workflow_states workflow_states_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflow_states
    ADD CONSTRAINT workflow_states_pkey PRIMARY KEY (id);


--
-- Name: workflow_transitions workflow_transitions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflow_transitions
    ADD CONSTRAINT workflow_transitions_pkey PRIMARY KEY (id);


--
-- Name: workflows workflows_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflows
    ADD CONSTRAINT workflows_pkey PRIMARY KEY (id);


--
-- Name: workplan_instances workplan_instances_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workplan_instances
    ADD CONSTRAINT workplan_instances_pkey PRIMARY KEY (id);


--
-- Name: workplan_phases workplan_phases_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workplan_phases
    ADD CONSTRAINT workplan_phases_pkey PRIMARY KEY (id);


--
-- Name: workplan_phases workplan_phases_template_id_phase_code_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workplan_phases
    ADD CONSTRAINT workplan_phases_template_id_phase_code_key UNIQUE (template_id, phase_code);


--
-- Name: workplan_template_activities workplan_template_activities_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workplan_template_activities
    ADD CONSTRAINT workplan_template_activities_pkey PRIMARY KEY (id);


--
-- Name: workplan_template_activities workplan_template_activities_template_id_pattern_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workplan_template_activities
    ADD CONSTRAINT workplan_template_activities_template_id_pattern_id_key UNIQUE (template_id, pattern_id);


--
-- Name: workplan_templates workplan_templates_org_id_code_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workplan_templates
    ADD CONSTRAINT workplan_templates_org_id_code_key UNIQUE (org_id, code);


--
-- Name: workplan_templates workplan_templates_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workplan_templates
    ADD CONSTRAINT workplan_templates_pkey PRIMARY KEY (id);


--
-- Name: xp_transactions xp_transactions_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.xp_transactions
    ADD CONSTRAINT xp_transactions_pkey PRIMARY KEY (id);


--
-- Name: activities_activity_type_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX activities_activity_type_idx ON public.activities USING btree (activity_type);


--
-- Name: activities_assigned_to_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX activities_assigned_to_idx ON public.activities USING btree (assigned_to);


--
-- Name: activities_due_date_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX activities_due_date_idx ON public.activities USING btree (due_date);


--
-- Name: activities_entity_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX activities_entity_idx ON public.activities USING btree (entity_type, entity_id);


--
-- Name: activities_pattern_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX activities_pattern_idx ON public.activities USING btree (pattern_id);


--
-- Name: activities_status_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX activities_status_idx ON public.activities USING btree (status);


--
-- Name: activities_workplan_instance_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX activities_workplan_instance_idx ON public.activities USING btree (workplan_instance_id);


--
-- Name: activity_attachments_activity_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX activity_attachments_activity_idx ON public.activity_attachments USING btree (activity_id);


--
-- Name: activity_auto_rules_event_type_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX activity_auto_rules_event_type_idx ON public.activity_auto_rules USING btree (event_type);


--
-- Name: activity_comments_activity_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX activity_comments_activity_idx ON public.activity_comments USING btree (activity_id);


--
-- Name: activity_dependencies_activity_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX activity_dependencies_activity_idx ON public.activity_dependencies USING btree (activity_id);


--
-- Name: activity_history_activity_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX activity_history_activity_idx ON public.activity_history USING btree (activity_id);


--
-- Name: activity_history_changed_at_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX activity_history_changed_at_idx ON public.activity_history USING btree (changed_at);


--
-- Name: activity_metrics_date_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX activity_metrics_date_idx ON public.activity_metrics USING btree (metric_date);


--
-- Name: activity_metrics_pod_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX activity_metrics_pod_idx ON public.activity_metrics USING btree (pod_id);


--
-- Name: activity_metrics_user_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX activity_metrics_user_idx ON public.activity_metrics USING btree (user_id);


--
-- Name: activity_participants_activity_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX activity_participants_activity_idx ON public.activity_participants USING btree (activity_id);


--
-- Name: activity_participants_user_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX activity_participants_user_idx ON public.activity_participants USING btree (user_id);


--
-- Name: activity_patterns_entity_type_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX activity_patterns_entity_type_idx ON public.activity_patterns USING btree (entity_type);


--
-- Name: activity_reminders_activity_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX activity_reminders_activity_idx ON public.activity_reminders USING btree (activity_id);


--
-- Name: activity_reminders_remind_at_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX activity_reminders_remind_at_idx ON public.activity_reminders USING btree (remind_at);


--
-- Name: activity_time_entries_activity_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX activity_time_entries_activity_idx ON public.activity_time_entries USING btree (activity_id);


--
-- Name: activity_time_entries_user_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX activity_time_entries_user_idx ON public.activity_time_entries USING btree (user_id);


--
-- Name: idx_audit_logs_action; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_audit_logs_action ON ONLY public.audit_logs USING btree (action);


--
-- Name: audit_logs_2025_11_action_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2025_11_action_idx ON public.audit_logs_2025_11 USING btree (action);


--
-- Name: idx_audit_logs_actor_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_audit_logs_actor_id ON ONLY public.audit_logs USING btree (actor_id);


--
-- Name: audit_logs_2025_11_actor_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2025_11_actor_id_idx ON public.audit_logs_2025_11 USING btree (actor_id);


--
-- Name: idx_audit_logs_correlation_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_audit_logs_correlation_id ON ONLY public.audit_logs USING btree (correlation_id);


--
-- Name: audit_logs_2025_11_correlation_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2025_11_correlation_id_idx ON public.audit_logs_2025_11 USING btree (correlation_id);


--
-- Name: idx_audit_logs_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_audit_logs_created_at ON ONLY public.audit_logs USING btree (created_at DESC);


--
-- Name: audit_logs_2025_11_created_at_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2025_11_created_at_idx ON public.audit_logs_2025_11 USING btree (created_at DESC);


--
-- Name: idx_audit_logs_entity_type_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_audit_logs_entity_type_id ON ONLY public.audit_logs USING btree (entity_type, entity_id);


--
-- Name: audit_logs_2025_11_entity_type_entity_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2025_11_entity_type_entity_id_idx ON public.audit_logs_2025_11 USING btree (entity_type, entity_id);


--
-- Name: idx_audit_logs_event_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_audit_logs_event_id ON ONLY public.audit_logs USING btree (event_id);


--
-- Name: audit_logs_2025_11_event_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2025_11_event_id_idx ON public.audit_logs_2025_11 USING btree (event_id);


--
-- Name: idx_audit_logs_ip_address; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_audit_logs_ip_address ON ONLY public.audit_logs USING btree (ip_address);


--
-- Name: audit_logs_2025_11_ip_address_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2025_11_ip_address_idx ON public.audit_logs_2025_11 USING btree (ip_address);


--
-- Name: idx_audit_logs_org_created; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_audit_logs_org_created ON ONLY public.audit_logs USING btree (org_id, created_at DESC);


--
-- Name: audit_logs_2025_11_org_id_created_at_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2025_11_org_id_created_at_idx ON public.audit_logs_2025_11 USING btree (org_id, created_at DESC);


--
-- Name: idx_audit_logs_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_audit_logs_org_id ON ONLY public.audit_logs USING btree (org_id);


--
-- Name: audit_logs_2025_11_org_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2025_11_org_id_idx ON public.audit_logs_2025_11 USING btree (org_id);


--
-- Name: idx_audit_logs_record_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_audit_logs_record_id ON ONLY public.audit_logs USING btree (record_id) WHERE (record_id IS NOT NULL);


--
-- Name: audit_logs_2025_11_record_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2025_11_record_id_idx ON public.audit_logs_2025_11 USING btree (record_id) WHERE (record_id IS NOT NULL);


--
-- Name: idx_audit_logs_result; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_audit_logs_result ON ONLY public.audit_logs USING btree (result);


--
-- Name: audit_logs_2025_11_result_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2025_11_result_idx ON public.audit_logs_2025_11 USING btree (result);


--
-- Name: idx_audit_logs_session_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_audit_logs_session_id ON ONLY public.audit_logs USING btree (session_id) WHERE (session_id IS NOT NULL);


--
-- Name: audit_logs_2025_11_session_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2025_11_session_id_idx ON public.audit_logs_2025_11 USING btree (session_id) WHERE (session_id IS NOT NULL);


--
-- Name: idx_audit_logs_severity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_audit_logs_severity ON ONLY public.audit_logs USING btree (severity) WHERE (severity = ANY (ARRAY['error'::text, 'critical'::text]));


--
-- Name: audit_logs_2025_11_severity_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2025_11_severity_idx ON public.audit_logs_2025_11 USING btree (severity) WHERE (severity = ANY (ARRAY['error'::text, 'critical'::text]));


--
-- Name: idx_audit_logs_table_action; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_audit_logs_table_action ON ONLY public.audit_logs USING btree (table_name, action);


--
-- Name: audit_logs_2025_11_table_name_action_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2025_11_table_name_action_idx ON public.audit_logs_2025_11 USING btree (table_name, action);


--
-- Name: idx_audit_logs_table_name; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_audit_logs_table_name ON ONLY public.audit_logs USING btree (table_name);


--
-- Name: audit_logs_2025_11_table_name_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2025_11_table_name_idx ON public.audit_logs_2025_11 USING btree (table_name);


--
-- Name: idx_audit_logs_user_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_audit_logs_user_id ON ONLY public.audit_logs USING btree (user_id) WHERE (user_id IS NOT NULL);


--
-- Name: audit_logs_2025_11_user_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2025_11_user_id_idx ON public.audit_logs_2025_11 USING btree (user_id) WHERE (user_id IS NOT NULL);


--
-- Name: audit_logs_2025_12_action_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2025_12_action_idx ON public.audit_logs_2025_12 USING btree (action);


--
-- Name: audit_logs_2025_12_actor_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2025_12_actor_id_idx ON public.audit_logs_2025_12 USING btree (actor_id);


--
-- Name: audit_logs_2025_12_correlation_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2025_12_correlation_id_idx ON public.audit_logs_2025_12 USING btree (correlation_id);


--
-- Name: audit_logs_2025_12_created_at_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2025_12_created_at_idx ON public.audit_logs_2025_12 USING btree (created_at DESC);


--
-- Name: audit_logs_2025_12_entity_type_entity_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2025_12_entity_type_entity_id_idx ON public.audit_logs_2025_12 USING btree (entity_type, entity_id);


--
-- Name: audit_logs_2025_12_event_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2025_12_event_id_idx ON public.audit_logs_2025_12 USING btree (event_id);


--
-- Name: audit_logs_2025_12_ip_address_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2025_12_ip_address_idx ON public.audit_logs_2025_12 USING btree (ip_address);


--
-- Name: audit_logs_2025_12_org_id_created_at_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2025_12_org_id_created_at_idx ON public.audit_logs_2025_12 USING btree (org_id, created_at DESC);


--
-- Name: audit_logs_2025_12_org_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2025_12_org_id_idx ON public.audit_logs_2025_12 USING btree (org_id);


--
-- Name: audit_logs_2025_12_record_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2025_12_record_id_idx ON public.audit_logs_2025_12 USING btree (record_id) WHERE (record_id IS NOT NULL);


--
-- Name: audit_logs_2025_12_result_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2025_12_result_idx ON public.audit_logs_2025_12 USING btree (result);


--
-- Name: audit_logs_2025_12_session_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2025_12_session_id_idx ON public.audit_logs_2025_12 USING btree (session_id) WHERE (session_id IS NOT NULL);


--
-- Name: audit_logs_2025_12_severity_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2025_12_severity_idx ON public.audit_logs_2025_12 USING btree (severity) WHERE (severity = ANY (ARRAY['error'::text, 'critical'::text]));


--
-- Name: audit_logs_2025_12_table_name_action_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2025_12_table_name_action_idx ON public.audit_logs_2025_12 USING btree (table_name, action);


--
-- Name: audit_logs_2025_12_table_name_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2025_12_table_name_idx ON public.audit_logs_2025_12 USING btree (table_name);


--
-- Name: audit_logs_2025_12_user_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2025_12_user_id_idx ON public.audit_logs_2025_12 USING btree (user_id) WHERE (user_id IS NOT NULL);


--
-- Name: audit_logs_2026_01_action_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2026_01_action_idx ON public.audit_logs_2026_01 USING btree (action);


--
-- Name: audit_logs_2026_01_actor_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2026_01_actor_id_idx ON public.audit_logs_2026_01 USING btree (actor_id);


--
-- Name: audit_logs_2026_01_correlation_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2026_01_correlation_id_idx ON public.audit_logs_2026_01 USING btree (correlation_id);


--
-- Name: audit_logs_2026_01_created_at_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2026_01_created_at_idx ON public.audit_logs_2026_01 USING btree (created_at DESC);


--
-- Name: audit_logs_2026_01_entity_type_entity_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2026_01_entity_type_entity_id_idx ON public.audit_logs_2026_01 USING btree (entity_type, entity_id);


--
-- Name: audit_logs_2026_01_event_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2026_01_event_id_idx ON public.audit_logs_2026_01 USING btree (event_id);


--
-- Name: audit_logs_2026_01_ip_address_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2026_01_ip_address_idx ON public.audit_logs_2026_01 USING btree (ip_address);


--
-- Name: audit_logs_2026_01_org_id_created_at_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2026_01_org_id_created_at_idx ON public.audit_logs_2026_01 USING btree (org_id, created_at DESC);


--
-- Name: audit_logs_2026_01_org_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2026_01_org_id_idx ON public.audit_logs_2026_01 USING btree (org_id);


--
-- Name: audit_logs_2026_01_record_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2026_01_record_id_idx ON public.audit_logs_2026_01 USING btree (record_id) WHERE (record_id IS NOT NULL);


--
-- Name: audit_logs_2026_01_result_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2026_01_result_idx ON public.audit_logs_2026_01 USING btree (result);


--
-- Name: audit_logs_2026_01_session_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2026_01_session_id_idx ON public.audit_logs_2026_01 USING btree (session_id) WHERE (session_id IS NOT NULL);


--
-- Name: audit_logs_2026_01_severity_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2026_01_severity_idx ON public.audit_logs_2026_01 USING btree (severity) WHERE (severity = ANY (ARRAY['error'::text, 'critical'::text]));


--
-- Name: audit_logs_2026_01_table_name_action_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2026_01_table_name_action_idx ON public.audit_logs_2026_01 USING btree (table_name, action);


--
-- Name: audit_logs_2026_01_table_name_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2026_01_table_name_idx ON public.audit_logs_2026_01 USING btree (table_name);


--
-- Name: audit_logs_2026_01_user_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2026_01_user_id_idx ON public.audit_logs_2026_01 USING btree (user_id) WHERE (user_id IS NOT NULL);


--
-- Name: audit_logs_2026_02_action_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2026_02_action_idx ON public.audit_logs_2026_02 USING btree (action);


--
-- Name: audit_logs_2026_02_actor_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2026_02_actor_id_idx ON public.audit_logs_2026_02 USING btree (actor_id);


--
-- Name: audit_logs_2026_02_correlation_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2026_02_correlation_id_idx ON public.audit_logs_2026_02 USING btree (correlation_id);


--
-- Name: audit_logs_2026_02_created_at_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2026_02_created_at_idx ON public.audit_logs_2026_02 USING btree (created_at DESC);


--
-- Name: audit_logs_2026_02_entity_type_entity_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2026_02_entity_type_entity_id_idx ON public.audit_logs_2026_02 USING btree (entity_type, entity_id);


--
-- Name: audit_logs_2026_02_event_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2026_02_event_id_idx ON public.audit_logs_2026_02 USING btree (event_id);


--
-- Name: audit_logs_2026_02_ip_address_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2026_02_ip_address_idx ON public.audit_logs_2026_02 USING btree (ip_address);


--
-- Name: audit_logs_2026_02_org_id_created_at_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2026_02_org_id_created_at_idx ON public.audit_logs_2026_02 USING btree (org_id, created_at DESC);


--
-- Name: audit_logs_2026_02_org_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2026_02_org_id_idx ON public.audit_logs_2026_02 USING btree (org_id);


--
-- Name: audit_logs_2026_02_record_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2026_02_record_id_idx ON public.audit_logs_2026_02 USING btree (record_id) WHERE (record_id IS NOT NULL);


--
-- Name: audit_logs_2026_02_result_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2026_02_result_idx ON public.audit_logs_2026_02 USING btree (result);


--
-- Name: audit_logs_2026_02_session_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2026_02_session_id_idx ON public.audit_logs_2026_02 USING btree (session_id) WHERE (session_id IS NOT NULL);


--
-- Name: audit_logs_2026_02_severity_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2026_02_severity_idx ON public.audit_logs_2026_02 USING btree (severity) WHERE (severity = ANY (ARRAY['error'::text, 'critical'::text]));


--
-- Name: audit_logs_2026_02_table_name_action_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2026_02_table_name_action_idx ON public.audit_logs_2026_02 USING btree (table_name, action);


--
-- Name: audit_logs_2026_02_table_name_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2026_02_table_name_idx ON public.audit_logs_2026_02 USING btree (table_name);


--
-- Name: audit_logs_2026_02_user_id_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX audit_logs_2026_02_user_id_idx ON public.audit_logs_2026_02 USING btree (user_id) WHERE (user_id IS NOT NULL);


--
-- Name: bulk_activity_jobs_created_by_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX bulk_activity_jobs_created_by_idx ON public.bulk_activity_jobs USING btree (created_by);


--
-- Name: bulk_activity_jobs_status_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX bulk_activity_jobs_status_idx ON public.bulk_activity_jobs USING btree (status);


--
-- Name: idx_account_contacts_account_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_account_contacts_account_id ON public.account_contacts USING btree (account_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_account_contacts_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_account_contacts_active ON public.account_contacts USING btree (is_active) WHERE ((is_active = true) AND (deleted_at IS NULL));


--
-- Name: idx_account_contacts_contact_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_account_contacts_contact_id ON public.account_contacts USING btree (contact_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_account_contacts_is_primary; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_account_contacts_is_primary ON public.account_contacts USING btree (account_id, is_primary) WHERE ((is_primary = true) AND (deleted_at IS NULL));


--
-- Name: idx_account_contacts_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_account_contacts_org_id ON public.account_contacts USING btree (org_id);


--
-- Name: idx_account_contracts_account_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_account_contracts_account_id ON public.account_contracts USING btree (account_id);


--
-- Name: idx_account_contracts_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_account_contracts_status ON public.account_contracts USING btree (status);


--
-- Name: idx_account_contracts_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_account_contracts_type ON public.account_contracts USING btree (contract_type);


--
-- Name: idx_account_metrics_account_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_account_metrics_account_id ON public.account_metrics USING btree (account_id);


--
-- Name: idx_account_metrics_account_period; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_account_metrics_account_period ON public.account_metrics USING btree (account_id, period);


--
-- Name: idx_account_metrics_period; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_account_metrics_period ON public.account_metrics USING btree (period);


--
-- Name: idx_account_notes_account; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_account_notes_account ON public.account_notes USING btree (account_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_account_notes_created_by; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_account_notes_created_by ON public.account_notes USING btree (created_by);


--
-- Name: idx_account_notes_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_account_notes_org ON public.account_notes USING btree (org_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_account_notes_pinned; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_account_notes_pinned ON public.account_notes USING btree (account_id, is_pinned) WHERE ((is_pinned = true) AND (deleted_at IS NULL));


--
-- Name: idx_account_preferences_account_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_account_preferences_account_id ON public.account_preferences USING btree (account_id);


--
-- Name: idx_account_team_account_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_account_team_account_id ON public.account_team USING btree (account_id);


--
-- Name: idx_account_team_role; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_account_team_role ON public.account_team USING btree (role);


--
-- Name: idx_account_team_user_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_account_team_user_id ON public.account_team USING btree (user_id);


--
-- Name: idx_accounts_account_manager_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_accounts_account_manager_id ON public.accounts USING btree (account_manager_id);


--
-- Name: idx_accounts_health_score; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_accounts_health_score ON public.accounts USING btree (health_score);


--
-- Name: idx_accounts_last_contact; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_accounts_last_contact ON public.accounts USING btree (last_contact_date);


--
-- Name: idx_accounts_manager; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_accounts_manager ON public.accounts USING btree (account_manager_id);


--
-- Name: idx_accounts_name; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_accounts_name ON public.accounts USING btree (name) WHERE (deleted_at IS NULL);


--
-- Name: idx_accounts_onboarding_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_accounts_onboarding_status ON public.accounts USING btree (onboarding_status) WHERE (deleted_at IS NULL);


--
-- Name: idx_accounts_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_accounts_org ON public.accounts USING btree (org_id) WHERE (deleted_at IS NULL);


--
-- Name: INDEX idx_accounts_org; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON INDEX public.idx_accounts_org IS 'Primary org isolation index for accounts';


--
-- Name: idx_accounts_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_accounts_org_id ON public.accounts USING btree (org_id);


--
-- Name: idx_accounts_owner_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_accounts_owner_id ON public.accounts USING btree (owner_id);


--
-- Name: idx_accounts_relationship_health; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_accounts_relationship_health ON public.accounts USING btree (relationship_health) WHERE (deleted_at IS NULL);


--
-- Name: idx_accounts_search; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_accounts_search ON public.accounts USING gin (search_vector);


--
-- Name: idx_accounts_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_accounts_status ON public.accounts USING btree (status) WHERE (deleted_at IS NULL);


--
-- Name: idx_accounts_tier; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_accounts_tier ON public.accounts USING btree (tier);


--
-- Name: idx_achievements_category; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_achievements_category ON public.achievements USING btree (category);


--
-- Name: idx_achievements_is_secret; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_achievements_is_secret ON public.achievements USING btree (is_secret);


--
-- Name: idx_achievements_slug; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_achievements_slug ON public.achievements USING btree (slug);


--
-- Name: idx_activities_activity_number; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activities_activity_number ON public.activities USING btree (activity_number);


--
-- Name: idx_activities_assigned; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activities_assigned ON public.activities USING btree (assigned_to, status) WHERE (status = ANY (ARRAY['open'::text, 'in_progress'::text]));


--
-- Name: idx_activities_assigned_to; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activities_assigned_to ON public.activities USING btree (assigned_to);


--
-- Name: idx_activities_due; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activities_due ON public.activities USING btree (due_date) WHERE (status = ANY (ARRAY['open'::text, 'in_progress'::text]));


--
-- Name: idx_activities_due_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activities_due_date ON public.activities USING btree (due_date);


--
-- Name: idx_activities_entity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activities_entity ON public.activities USING btree (entity_type, entity_id);


--
-- Name: idx_activities_entity_timeline; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activities_entity_timeline ON public.activities USING btree (entity_type, entity_id, created_at DESC);


--
-- Name: idx_activities_escalation; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activities_escalation ON public.activities USING btree (escalation_date) WHERE ((status = 'open'::text) AND (escalation_date IS NOT NULL));


--
-- Name: idx_activities_follow_up; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activities_follow_up ON public.activities USING btree (follow_up_required, follow_up_date) WHERE ((follow_up_required = true) AND (status = ANY (ARRAY['open'::text, 'in_progress'::text])));


--
-- Name: idx_activities_follow_up_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activities_follow_up_date ON public.activities USING btree (follow_up_date) WHERE (follow_up_required = true);


--
-- Name: idx_activities_group; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activities_group ON public.activities USING btree (assigned_group, status) WHERE (status = ANY (ARRAY['open'::text, 'in_progress'::text]));


--
-- Name: idx_activities_my_tasks; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activities_my_tasks ON public.activities USING btree (assigned_to, status, due_date) WHERE (status = ANY (ARRAY['open'::text, 'in_progress'::text]));


--
-- Name: idx_activities_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activities_org ON public.activities USING btree (org_id);


--
-- Name: idx_activities_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activities_org_id ON public.activities USING btree (org_id);


--
-- Name: idx_activities_org_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activities_org_status ON public.activities USING btree (org_id, status);


--
-- Name: idx_activities_parent; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activities_parent ON public.activities USING btree (parent_activity_id);


--
-- Name: idx_activities_related_campaign; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activities_related_campaign ON public.activities USING btree (related_campaign_id) WHERE (related_campaign_id IS NOT NULL);


--
-- Name: idx_activities_related_contact; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activities_related_contact ON public.activities USING btree (related_contact_id) WHERE (related_contact_id IS NOT NULL);


--
-- Name: idx_activities_related_deal; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activities_related_deal ON public.activities USING btree (related_deal_id) WHERE (related_deal_id IS NOT NULL);


--
-- Name: idx_activities_secondary_entity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activities_secondary_entity ON public.activities USING btree (secondary_entity_type, secondary_entity_id);


--
-- Name: idx_activities_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activities_status ON public.activities USING btree (status);


--
-- Name: idx_activities_tags; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activities_tags ON public.activities USING gin (tags);


--
-- Name: idx_activities_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activities_type ON public.activities USING btree (activity_type);


--
-- Name: idx_activities_workplan; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activities_workplan ON public.activities USING btree (workplan_instance_id);


--
-- Name: idx_activity_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activity_date ON public.activity_log USING btree (activity_date DESC);


--
-- Name: idx_activity_entity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activity_entity ON public.activity_log USING btree (entity_type, entity_id);


--
-- Name: idx_activity_history_activity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activity_history_activity ON public.activity_history USING btree (activity_id, changed_at DESC);


--
-- Name: idx_activity_log_activity_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activity_log_activity_date ON public.activity_log USING btree (activity_date);


--
-- Name: idx_activity_log_entity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activity_log_entity ON public.activity_log USING btree (entity_type, entity_id);


--
-- Name: idx_activity_log_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activity_log_org_id ON public.activity_log USING btree (org_id);


--
-- Name: idx_activity_log_performed_by; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activity_log_performed_by ON public.activity_log USING btree (performed_by);


--
-- Name: idx_activity_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activity_org ON public.activity_log USING btree (org_id);


--
-- Name: idx_activity_owner; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activity_owner ON public.activity_log USING btree (performed_by);


--
-- Name: idx_activity_patterns_category; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activity_patterns_category ON public.activity_patterns USING btree (org_id, category, is_active);


--
-- Name: idx_activity_patterns_display; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activity_patterns_display ON public.activity_patterns USING btree (org_id, category, display_order);


--
-- Name: idx_activity_patterns_entity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activity_patterns_entity ON public.activity_patterns USING btree (entity_type, is_active);


--
-- Name: idx_activity_patterns_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activity_patterns_org ON public.activity_patterns USING btree (org_id) WHERE (org_id IS NOT NULL);


--
-- Name: idx_activity_poc; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activity_poc ON public.activity_log USING btree (poc_id);


--
-- Name: idx_activity_stats_user_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_activity_stats_user_date ON public.activity_stats_daily USING btree (user_id, date DESC);


--
-- Name: idx_addresses_country; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_addresses_country ON public.addresses USING btree (country_code);


--
-- Name: idx_addresses_entity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_addresses_entity ON public.addresses USING btree (entity_type, entity_id);


--
-- Name: idx_addresses_entity_lookup; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_addresses_entity_lookup ON public.addresses USING btree (entity_type, entity_id);


--
-- Name: idx_addresses_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_addresses_org ON public.addresses USING btree (org_id);


--
-- Name: idx_addresses_org_city_state; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_addresses_org_city_state ON public.addresses USING btree (org_id, city, state_province);


--
-- Name: idx_addresses_primary; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_addresses_primary ON public.addresses USING btree (entity_type, entity_id, is_primary) WHERE (is_primary = true);


--
-- Name: idx_addresses_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_addresses_type ON public.addresses USING btree (org_id, address_type);


--
-- Name: idx_ai_agent_interactions_agent; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ai_agent_interactions_agent ON public.ai_agent_interactions USING btree (agent_name);


--
-- Name: idx_ai_agent_interactions_org_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ai_agent_interactions_org_date ON public.ai_agent_interactions USING btree (org_id, created_at DESC);


--
-- Name: idx_ai_agent_interactions_success; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ai_agent_interactions_success ON public.ai_agent_interactions USING btree (success) WHERE (success = false);


--
-- Name: idx_ai_agent_interactions_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ai_agent_interactions_type ON public.ai_agent_interactions USING btree (interaction_type);


--
-- Name: idx_ai_agent_interactions_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ai_agent_interactions_user ON public.ai_agent_interactions USING btree (user_id);


--
-- Name: idx_ai_conversations_agent_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ai_conversations_agent_type ON public.ai_conversations USING btree (agent_type);


--
-- Name: idx_ai_conversations_metadata; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ai_conversations_metadata ON public.ai_conversations USING gin (metadata);


--
-- Name: idx_ai_conversations_updated_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ai_conversations_updated_at ON public.ai_conversations USING btree (updated_at DESC);


--
-- Name: idx_ai_conversations_user_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ai_conversations_user_id ON public.ai_conversations USING btree (user_id);


--
-- Name: idx_ai_cost_tracking_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ai_cost_tracking_date ON public.ai_cost_tracking USING btree (created_at DESC);


--
-- Name: idx_ai_cost_tracking_model; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ai_cost_tracking_model ON public.ai_cost_tracking USING btree (model);


--
-- Name: idx_ai_cost_tracking_org_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ai_cost_tracking_org_date ON public.ai_cost_tracking USING btree (org_id, created_at DESC);


--
-- Name: idx_ai_cost_tracking_provider; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ai_cost_tracking_provider ON public.ai_cost_tracking USING btree (provider);


--
-- Name: idx_ai_cost_tracking_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ai_cost_tracking_user ON public.ai_cost_tracking USING btree (user_id);


--
-- Name: idx_ai_embeddings_metadata; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ai_embeddings_metadata ON public.ai_embeddings USING gin (metadata);


--
-- Name: idx_ai_embeddings_vector; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ai_embeddings_vector ON public.ai_embeddings USING ivfflat (embedding public.vector_cosine_ops) WITH (lists='100');


--
-- Name: idx_ai_mentor_chats_course_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ai_mentor_chats_course_id ON public.ai_mentor_chats USING btree (course_id);


--
-- Name: idx_ai_mentor_chats_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ai_mentor_chats_created_at ON public.ai_mentor_chats USING btree (created_at DESC);


--
-- Name: idx_ai_mentor_chats_escalated; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ai_mentor_chats_escalated ON public.ai_mentor_chats USING btree (escalated_to_trainer) WHERE (escalated_to_trainer = true);


--
-- Name: idx_ai_mentor_chats_flagged; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ai_mentor_chats_flagged ON public.ai_mentor_chats USING btree (flagged_for_review) WHERE (flagged_for_review = true);


--
-- Name: idx_ai_mentor_chats_topic_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ai_mentor_chats_topic_id ON public.ai_mentor_chats USING btree (topic_id);


--
-- Name: idx_ai_mentor_chats_user_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ai_mentor_chats_user_id ON public.ai_mentor_chats USING btree (user_id);


--
-- Name: idx_ai_mentor_rate_limits_user_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ai_mentor_rate_limits_user_id ON public.ai_mentor_rate_limits USING btree (user_id);


--
-- Name: idx_ai_mentor_sessions_last_message; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ai_mentor_sessions_last_message ON public.ai_mentor_sessions USING btree (last_message_at DESC);


--
-- Name: idx_ai_mentor_sessions_user_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ai_mentor_sessions_user_id ON public.ai_mentor_sessions USING btree (user_id);


--
-- Name: idx_ai_patterns_last_seen; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ai_patterns_last_seen ON public.ai_patterns USING btree (last_seen DESC);


--
-- Name: idx_ai_patterns_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ai_patterns_type ON public.ai_patterns USING btree (pattern_type);


--
-- Name: idx_ai_patterns_user_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ai_patterns_user_id ON public.ai_patterns USING btree (user_id);


--
-- Name: idx_ai_prompts_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ai_prompts_active ON public.ai_prompts USING btree (is_active) WHERE (is_active = true);


--
-- Name: idx_ai_prompts_category; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ai_prompts_category ON public.ai_prompts USING btree (category);


--
-- Name: idx_ai_prompts_name; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_ai_prompts_name ON public.ai_prompts USING btree (name);


--
-- Name: idx_alert_rules_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_alert_rules_active ON public.alert_rules USING btree (is_active);


--
-- Name: idx_alert_rules_event_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_alert_rules_event_type ON public.alert_rules USING btree (event_type);


--
-- Name: idx_alert_rules_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_alert_rules_org ON public.alert_rules USING btree (org_id);


--
-- Name: idx_api_tokens_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_api_tokens_active ON public.api_tokens USING btree (org_id) WHERE (revoked_at IS NULL);


--
-- Name: idx_api_tokens_hash; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_api_tokens_hash ON public.api_tokens USING btree (token_hash);


--
-- Name: idx_api_tokens_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_api_tokens_org ON public.api_tokens USING btree (org_id);


--
-- Name: idx_approval_instances_entity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_approval_instances_entity ON public.approval_instances USING btree (entity_type, entity_id);


--
-- Name: idx_approval_instances_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_approval_instances_org ON public.approval_instances USING btree (org_id);


--
-- Name: idx_approval_instances_pending; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_approval_instances_pending ON public.approval_instances USING btree (org_id) WHERE (status = 'pending'::text);


--
-- Name: idx_approval_instances_requestor; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_approval_instances_requestor ON public.approval_instances USING btree (requested_by);


--
-- Name: idx_approval_instances_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_approval_instances_status ON public.approval_instances USING btree (status);


--
-- Name: idx_approval_instances_workflow; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_approval_instances_workflow ON public.approval_instances USING btree (workflow_id);


--
-- Name: idx_approval_steps_approver; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_approval_steps_approver ON public.approval_steps USING btree (approver_id);


--
-- Name: idx_approval_steps_instance; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_approval_steps_instance ON public.approval_steps USING btree (instance_id);


--
-- Name: idx_approval_steps_pending; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_approval_steps_pending ON public.approval_steps USING btree (approver_id) WHERE (status = 'pending'::text);


--
-- Name: idx_approval_workflows_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_approval_workflows_active ON public.approval_workflows USING btree (org_id) WHERE (is_active = true);


--
-- Name: idx_approval_workflows_entity_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_approval_workflows_entity_type ON public.approval_workflows USING btree (entity_type);


--
-- Name: idx_approval_workflows_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_approval_workflows_org ON public.approval_workflows USING btree (org_id);


--
-- Name: idx_archived_records_archived_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_archived_records_archived_at ON public.archived_records USING btree (archived_at DESC);


--
-- Name: idx_archived_records_entity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_archived_records_entity ON public.archived_records USING btree (entity_type, original_id);


--
-- Name: idx_archived_records_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_archived_records_org ON public.archived_records USING btree (org_id);


--
-- Name: idx_background_jobs_failed; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_background_jobs_failed ON public.background_jobs USING btree (attempts, created_at DESC) WHERE ((status = 'failed'::text) AND (attempts < max_attempts));


--
-- Name: idx_background_jobs_job_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_background_jobs_job_type ON public.background_jobs USING btree (job_type);


--
-- Name: idx_background_jobs_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_background_jobs_org_id ON public.background_jobs USING btree (org_id);


--
-- Name: idx_background_jobs_pending; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_background_jobs_pending ON public.background_jobs USING btree (priority, created_at) WHERE (status = 'pending'::text);


--
-- Name: idx_background_jobs_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_background_jobs_status ON public.background_jobs USING btree (status);


--
-- Name: idx_badge_progress_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_badge_progress_user ON public.badge_progress USING btree (user_id);


--
-- Name: idx_badge_trigger_events_processed; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_badge_trigger_events_processed ON public.badge_trigger_events USING btree (processed) WHERE (processed = false);


--
-- Name: idx_badge_trigger_events_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_badge_trigger_events_user ON public.badge_trigger_events USING btree (user_id);


--
-- Name: idx_badges_rarity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_badges_rarity ON public.badges USING btree (rarity);


--
-- Name: idx_badges_trigger_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_badges_trigger_type ON public.badges USING btree (trigger_type);


--
-- Name: idx_bench_consultants_bench_sales_rep_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_bench_consultants_bench_sales_rep_id ON public.bench_consultants USING btree (bench_sales_rep_id);


--
-- Name: idx_bench_consultants_candidate_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_bench_consultants_candidate_id ON public.bench_consultants USING btree (candidate_id);


--
-- Name: idx_bench_consultants_contact_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_bench_consultants_contact_id ON public.bench_consultants USING btree (contact_id) WHERE (contact_id IS NOT NULL);


--
-- Name: idx_bench_consultants_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_bench_consultants_org ON public.bench_consultants USING btree (org_id);


--
-- Name: idx_bench_consultants_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_bench_consultants_org_id ON public.bench_consultants USING btree (org_id);


--
-- Name: idx_bench_consultants_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_bench_consultants_status ON public.bench_consultants USING btree (status);


--
-- Name: idx_benefit_dependents_employee_benefit_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_benefit_dependents_employee_benefit_id ON public.benefit_dependents USING btree (employee_benefit_id);


--
-- Name: idx_benefit_plan_options_plan_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_benefit_plan_options_plan_id ON public.benefit_plan_options USING btree (plan_id);


--
-- Name: idx_benefit_plans_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_benefit_plans_org_id ON public.benefit_plans USING btree (org_id);


--
-- Name: idx_benefit_plans_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_benefit_plans_status ON public.benefit_plans USING btree (status);


--
-- Name: idx_benefit_plans_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_benefit_plans_type ON public.benefit_plans USING btree (type);


--
-- Name: idx_bgc_candidate; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_bgc_candidate ON public.candidate_background_checks USING btree (candidate_id);


--
-- Name: idx_bgc_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_bgc_org ON public.candidate_background_checks USING btree (org_id);


--
-- Name: idx_break_glass_accessed; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_break_glass_accessed ON public.break_glass_access USING btree (accessed_at DESC);


--
-- Name: idx_break_glass_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_break_glass_org ON public.break_glass_access USING btree (org_id);


--
-- Name: idx_break_glass_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_break_glass_user ON public.break_glass_access USING btree (user_id);


--
-- Name: idx_bulk_update_history_applied; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_bulk_update_history_applied ON public.bulk_update_history USING btree (applied_at DESC);


--
-- Name: idx_bulk_update_history_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_bulk_update_history_org ON public.bulk_update_history USING btree (org_id);


--
-- Name: idx_campaign_documents_campaign; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_campaign_documents_campaign ON public.campaign_documents USING btree (campaign_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_campaign_documents_category; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_campaign_documents_category ON public.campaign_documents USING btree (category) WHERE (deleted_at IS NULL);


--
-- Name: idx_campaign_documents_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_campaign_documents_org ON public.campaign_documents USING btree (org_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_campaign_documents_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_campaign_documents_type ON public.campaign_documents USING btree (document_type) WHERE (deleted_at IS NULL);


--
-- Name: idx_campaign_enrollments_campaign; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_campaign_enrollments_campaign ON public.campaign_enrollments USING btree (campaign_id);


--
-- Name: idx_campaign_enrollments_contact; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_campaign_enrollments_contact ON public.campaign_enrollments USING btree (contact_id);


--
-- Name: idx_campaign_enrollments_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_campaign_enrollments_org ON public.campaign_enrollments USING btree (org_id);


--
-- Name: idx_campaign_enrollments_sequence; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_campaign_enrollments_sequence ON public.campaign_enrollments USING btree (campaign_id, sequence_status);


--
-- Name: idx_campaign_enrollments_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_campaign_enrollments_status ON public.campaign_enrollments USING btree (status);


--
-- Name: idx_campaign_sequence_logs_action_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_campaign_sequence_logs_action_at ON public.campaign_sequence_logs USING btree (action_at DESC);


--
-- Name: idx_campaign_sequence_logs_action_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_campaign_sequence_logs_action_type ON public.campaign_sequence_logs USING btree (action_type);


--
-- Name: idx_campaign_sequence_logs_campaign; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_campaign_sequence_logs_campaign ON public.campaign_sequence_logs USING btree (campaign_id);


--
-- Name: idx_campaign_sequences_campaign_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_campaign_sequences_campaign_id ON public.campaign_sequences USING btree (campaign_id);


--
-- Name: idx_campaign_sequences_sequence_template_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_campaign_sequences_sequence_template_id ON public.campaign_sequences USING btree (sequence_template_id);


--
-- Name: idx_campaigns_approval_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_campaigns_approval_status ON public.campaigns USING btree (approval_status);


--
-- Name: idx_campaigns_channels; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_campaigns_channels ON public.campaigns USING gin (channels);


--
-- Name: idx_campaigns_dates; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_campaigns_dates ON public.campaigns USING btree (start_date, end_date);


--
-- Name: idx_campaigns_deleted_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_campaigns_deleted_at ON public.campaigns USING btree (deleted_at) WHERE (deleted_at IS NULL);


--
-- Name: idx_campaigns_goal; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_campaigns_goal ON public.campaigns USING btree (goal);


--
-- Name: idx_campaigns_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_campaigns_org ON public.campaigns USING btree (org_id);


--
-- Name: idx_campaigns_owner; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_campaigns_owner ON public.campaigns USING btree (owner_id);


--
-- Name: idx_campaigns_search; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_campaigns_search ON public.campaigns USING gin (search_vector);


--
-- Name: idx_campaigns_sequence_template_ids; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_campaigns_sequence_template_ids ON public.campaigns USING gin (sequence_template_ids);


--
-- Name: idx_campaigns_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_campaigns_status ON public.campaigns USING btree (status);


--
-- Name: idx_campaigns_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_campaigns_type ON public.campaigns USING btree (campaign_type);


--
-- Name: idx_candidate_availability_contact_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_candidate_availability_contact_id ON public.candidate_availability USING btree (contact_id) WHERE (contact_id IS NOT NULL);


--
-- Name: idx_candidate_background_checks_contact_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_candidate_background_checks_contact_id ON public.candidate_background_checks USING btree (contact_id) WHERE (contact_id IS NOT NULL);


--
-- Name: idx_candidate_certifications_contact_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_candidate_certifications_contact_id ON public.candidate_certifications USING btree (contact_id) WHERE (contact_id IS NOT NULL);


--
-- Name: idx_candidate_compliance_documents_contact_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_candidate_compliance_documents_contact_id ON public.candidate_compliance_documents USING btree (contact_id) WHERE (contact_id IS NOT NULL);


--
-- Name: idx_candidate_documents_candidate_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_candidate_documents_candidate_id ON public.candidate_documents USING btree (candidate_id);


--
-- Name: idx_candidate_documents_contact_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_candidate_documents_contact_id ON public.candidate_documents USING btree (contact_id) WHERE (contact_id IS NOT NULL);


--
-- Name: idx_candidate_education_contact_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_candidate_education_contact_id ON public.candidate_education USING btree (contact_id) WHERE (contact_id IS NOT NULL);


--
-- Name: idx_candidate_embeddings_availability; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_candidate_embeddings_availability ON public.candidate_embeddings USING btree (availability);


--
-- Name: idx_candidate_embeddings_contact_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_candidate_embeddings_contact_id ON public.candidate_embeddings USING btree (contact_id) WHERE (contact_id IS NOT NULL);


--
-- Name: idx_candidate_embeddings_experience; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_candidate_embeddings_experience ON public.candidate_embeddings USING btree (experience_level);


--
-- Name: idx_candidate_embeddings_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_candidate_embeddings_org ON public.candidate_embeddings USING btree (org_id);


--
-- Name: idx_candidate_embeddings_skills; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_candidate_embeddings_skills ON public.candidate_embeddings USING gin (skills);


--
-- Name: idx_candidate_embeddings_vector; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_candidate_embeddings_vector ON public.candidate_embeddings USING ivfflat (embedding public.vector_cosine_ops) WITH (lists='100');


--
-- Name: INDEX idx_candidate_embeddings_vector; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON INDEX public.idx_candidate_embeddings_vector IS 'ivfflat index optimized for 10K candidates, <500ms search target';


--
-- Name: idx_candidate_preferences_contact_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_candidate_preferences_contact_id ON public.candidate_preferences USING btree (contact_id) WHERE (contact_id IS NOT NULL);


--
-- Name: idx_candidate_prepared_profiles_candidate; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_candidate_prepared_profiles_candidate ON public.candidate_prepared_profiles USING btree (candidate_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_candidate_prepared_profiles_contact_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_candidate_prepared_profiles_contact_id ON public.candidate_prepared_profiles USING btree (contact_id) WHERE (contact_id IS NOT NULL);


--
-- Name: idx_candidate_prepared_profiles_job; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_candidate_prepared_profiles_job ON public.candidate_prepared_profiles USING btree (job_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_candidate_profiles_contact_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_candidate_profiles_contact_id ON public.candidate_profiles USING btree (contact_id) WHERE (contact_id IS NOT NULL);


--
-- Name: idx_candidate_references_contact_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_candidate_references_contact_id ON public.candidate_references USING btree (contact_id) WHERE (contact_id IS NOT NULL);


--
-- Name: idx_candidate_resumes_candidate_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_candidate_resumes_candidate_id ON public.candidate_resumes USING btree (candidate_id);


--
-- Name: idx_candidate_resumes_contact_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_candidate_resumes_contact_id ON public.candidate_resumes USING btree (contact_id) WHERE (contact_id IS NOT NULL);


--
-- Name: idx_candidate_resumes_is_latest; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_candidate_resumes_is_latest ON public.candidate_resumes USING btree (candidate_id, is_latest) WHERE (is_latest = true);


--
-- Name: idx_candidate_resumes_not_archived; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_candidate_resumes_not_archived ON public.candidate_resumes USING btree (candidate_id) WHERE (is_archived = false);


--
-- Name: idx_candidate_resumes_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_candidate_resumes_org_id ON public.candidate_resumes USING btree (org_id);


--
-- Name: idx_candidate_resumes_resume_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_candidate_resumes_resume_type ON public.candidate_resumes USING btree (resume_type);


--
-- Name: idx_candidate_screenings_candidate; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_candidate_screenings_candidate ON public.candidate_screenings USING btree (candidate_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_candidate_screenings_contact_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_candidate_screenings_contact_id ON public.candidate_screenings USING btree (contact_id) WHERE (contact_id IS NOT NULL);


--
-- Name: idx_candidate_screenings_job; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_candidate_screenings_job ON public.candidate_screenings USING btree (job_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_candidate_screenings_recommendation; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_candidate_screenings_recommendation ON public.candidate_screenings USING btree (recommendation) WHERE (deleted_at IS NULL);


--
-- Name: idx_candidate_screenings_screener; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_candidate_screenings_screener ON public.candidate_screenings USING btree (screener_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_candidate_screenings_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_candidate_screenings_status ON public.candidate_screenings USING btree (status) WHERE (deleted_at IS NULL);


--
-- Name: idx_candidate_skills_candidate; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_candidate_skills_candidate ON public.candidate_skills USING btree (candidate_id);


--
-- Name: idx_candidate_skills_contact_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_candidate_skills_contact_id ON public.candidate_skills USING btree (contact_id) WHERE (contact_id IS NOT NULL);


--
-- Name: idx_candidate_skills_primary; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_candidate_skills_primary ON public.candidate_skills USING btree (candidate_id) WHERE (is_primary = true);


--
-- Name: idx_candidate_skills_proficiency; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_candidate_skills_proficiency ON public.candidate_skills USING btree (proficiency_level);


--
-- Name: idx_candidate_skills_skill; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_candidate_skills_skill ON public.candidate_skills USING btree (skill_id);


--
-- Name: idx_candidate_work_authorizations_contact_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_candidate_work_authorizations_contact_id ON public.candidate_work_authorizations USING btree (contact_id) WHERE (contact_id IS NOT NULL);


--
-- Name: idx_candidate_work_history_contact_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_candidate_work_history_contact_id ON public.candidate_work_history USING btree (contact_id) WHERE (contact_id IS NOT NULL);


--
-- Name: idx_capstone_submissions_course; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_capstone_submissions_course ON public.capstone_submissions USING btree (course_id);


--
-- Name: idx_capstone_submissions_enrollment; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_capstone_submissions_enrollment ON public.capstone_submissions USING btree (enrollment_id);


--
-- Name: idx_capstone_submissions_grader; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_capstone_submissions_grader ON public.capstone_submissions USING btree (graded_by);


--
-- Name: idx_capstone_submissions_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_capstone_submissions_status ON public.capstone_submissions USING btree (status);


--
-- Name: idx_capstone_submissions_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_capstone_submissions_user ON public.capstone_submissions USING btree (user_id);


--
-- Name: idx_certificate_templates_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_certificate_templates_active ON public.certificate_templates USING btree (is_active);


--
-- Name: idx_certificates_certificate_number; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_certificates_certificate_number ON public.certificates USING btree (certificate_number);


--
-- Name: idx_certificates_enrollment_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_certificates_enrollment_id ON public.certificates USING btree (enrollment_id);


--
-- Name: idx_certificates_verification_code; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_certificates_verification_code ON public.certificates USING btree (verification_code);


--
-- Name: idx_certifications_candidate; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_certifications_candidate ON public.candidate_certifications USING btree (candidate_id);


--
-- Name: idx_certifications_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_certifications_org ON public.candidate_certifications USING btree (org_id);


--
-- Name: idx_client_escalations_account; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_client_escalations_account ON public.escalations USING btree (account_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_client_escalations_assigned; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_client_escalations_assigned ON public.escalations USING btree (assigned_to);


--
-- Name: idx_client_escalations_created_by; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_client_escalations_created_by ON public.escalations USING btree (created_by);


--
-- Name: idx_client_escalations_number; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_client_escalations_number ON public.escalations USING btree (escalation_number);


--
-- Name: idx_client_escalations_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_client_escalations_org ON public.escalations USING btree (org_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_client_escalations_severity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_client_escalations_severity ON public.escalations USING btree (severity);


--
-- Name: idx_client_escalations_sla_response; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_client_escalations_sla_response ON public.escalations USING btree (sla_response_due) WHERE (status = ANY (ARRAY['open'::text, 'in_progress'::text]));


--
-- Name: idx_client_escalations_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_client_escalations_status ON public.escalations USING btree (status);


--
-- Name: idx_client_escalations_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_client_escalations_type ON public.escalations USING btree (escalation_type);


--
-- Name: idx_comments_author; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_comments_author ON public.comments USING btree (author_id);


--
-- Name: idx_comments_created; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_comments_created ON public.comments USING btree (created_at DESC);


--
-- Name: idx_comments_entity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_comments_entity ON public.comments USING btree (entity_type, entity_id) WHERE (NOT is_deleted);


--
-- Name: idx_comments_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_comments_org ON public.comments USING btree (org_id);


--
-- Name: idx_comments_parent; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_comments_parent ON public.comments USING btree (parent_comment_id);


--
-- Name: idx_commission_payments_commission_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_commission_payments_commission_id ON public.commission_payments USING btree (commission_id);


--
-- Name: idx_commission_payments_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_commission_payments_org_id ON public.commission_payments USING btree (org_id);


--
-- Name: idx_commission_payments_payment_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_commission_payments_payment_date ON public.commission_payments USING btree (payment_date);


--
-- Name: idx_commissions_deal_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_commissions_deal_id ON public.commissions USING btree (deal_id);


--
-- Name: idx_commissions_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_commissions_org_id ON public.commissions USING btree (org_id);


--
-- Name: idx_commissions_payment_period; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_commissions_payment_period ON public.commissions USING btree (payment_period_start, payment_period_end);


--
-- Name: idx_commissions_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_commissions_status ON public.commissions USING btree (status);


--
-- Name: idx_commissions_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_commissions_type ON public.commissions USING btree (commission_type);


--
-- Name: idx_commissions_user_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_commissions_user_id ON public.commissions USING btree (user_id);


--
-- Name: idx_commissions_user_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_commissions_user_status ON public.commissions USING btree (user_id, status);


--
-- Name: idx_companies_account_manager; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_companies_account_manager ON public.companies USING btree (account_manager_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_companies_category; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_companies_category ON public.companies USING btree (org_id, category) WHERE (deleted_at IS NULL);


--
-- Name: idx_companies_health; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_companies_health ON public.companies USING btree (org_id, health_status, health_score) WHERE (deleted_at IS NULL);


--
-- Name: idx_companies_hierarchy; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_companies_hierarchy ON public.companies USING btree (org_id, hierarchy_path) WHERE (deleted_at IS NULL);


--
-- Name: idx_companies_legacy_account; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_companies_legacy_account ON public.companies USING btree (legacy_account_id) WHERE (legacy_account_id IS NOT NULL);


--
-- Name: idx_companies_legacy_vendor; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_companies_legacy_vendor ON public.companies USING btree (legacy_vendor_id) WHERE (legacy_vendor_id IS NOT NULL);


--
-- Name: idx_companies_name_trgm; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_companies_name_trgm ON public.companies USING gin (name public.gin_trgm_ops);


--
-- Name: idx_companies_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_companies_org ON public.companies USING btree (org_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_companies_owner; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_companies_owner ON public.companies USING btree (owner_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_companies_parent; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_companies_parent ON public.companies USING btree (parent_company_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_companies_search; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_companies_search ON public.companies USING gin (search_vector);


--
-- Name: idx_companies_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_companies_status ON public.companies USING btree (org_id, status) WHERE (deleted_at IS NULL);


--
-- Name: idx_companies_tier; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_companies_tier ON public.companies USING btree (org_id, tier) WHERE (deleted_at IS NULL);


--
-- Name: idx_company_addresses_company; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_company_addresses_company ON public.company_addresses USING btree (company_id) WHERE (is_active = true);


--
-- Name: idx_company_addresses_unique; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX idx_company_addresses_unique ON public.company_addresses USING btree (company_id, address_id, address_type);


--
-- Name: idx_company_client_details_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_company_client_details_org ON public.company_client_details USING btree (org_id);


--
-- Name: idx_company_contacts_company; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_company_contacts_company ON public.company_contacts USING btree (company_id) WHERE (is_active = true);


--
-- Name: idx_company_contacts_contact; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_company_contacts_contact ON public.company_contacts USING btree (contact_id) WHERE (is_active = true);


--
-- Name: idx_company_contacts_unique; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX idx_company_contacts_unique ON public.company_contacts USING btree (company_id, contact_id) WHERE (is_active = true);


--
-- Name: idx_company_metrics_lookup; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_company_metrics_lookup ON public.company_metrics USING btree (company_id, period_type, period_start DESC);


--
-- Name: idx_company_notes_company; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_company_notes_company ON public.company_notes USING btree (company_id, created_at DESC) WHERE (deleted_at IS NULL);


--
-- Name: idx_company_partner_details_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_company_partner_details_org ON public.company_partner_details USING btree (org_id);


--
-- Name: idx_company_relationships_a; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_company_relationships_a ON public.company_relationships USING btree (company_a_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_company_relationships_b; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_company_relationships_b ON public.company_relationships USING btree (company_b_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_company_relationships_unique; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX idx_company_relationships_unique ON public.company_relationships USING btree (company_a_id, company_b_id, relationship_category) WHERE (deleted_at IS NULL);


--
-- Name: idx_company_revenue_company; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_company_revenue_company ON public.company_revenue USING btree (company_id, revenue_date DESC);


--
-- Name: idx_company_tags_company; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_company_tags_company ON public.company_tags USING btree (company_id);


--
-- Name: idx_company_tags_name; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_company_tags_name ON public.company_tags USING btree (org_id, tag_name);


--
-- Name: idx_company_tags_unique; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX idx_company_tags_unique ON public.company_tags USING btree (company_id, tag_name);


--
-- Name: idx_company_team_company; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_company_team_company ON public.company_team USING btree (company_id) WHERE (removed_at IS NULL);


--
-- Name: idx_company_team_unique; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX idx_company_team_unique ON public.company_team USING btree (company_id, user_id, role) WHERE (removed_at IS NULL);


--
-- Name: idx_company_team_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_company_team_user ON public.company_team USING btree (user_id) WHERE (removed_at IS NULL);


--
-- Name: idx_company_vendor_details_blacklist; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_company_vendor_details_blacklist ON public.company_vendor_details USING btree (company_id) WHERE (is_blacklisted = true);


--
-- Name: idx_company_vendor_details_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_company_vendor_details_org ON public.company_vendor_details USING btree (org_id);


--
-- Name: idx_company_vendor_details_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_company_vendor_details_type ON public.company_vendor_details USING btree (vendor_type);


--
-- Name: idx_compliance_docs_candidate; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_compliance_docs_candidate ON public.candidate_compliance_documents USING btree (candidate_id);


--
-- Name: idx_compliance_docs_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_compliance_docs_org ON public.candidate_compliance_documents USING btree (org_id);


--
-- Name: idx_compliance_requirements_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_compliance_requirements_active ON public.compliance_requirements USING btree (is_active);


--
-- Name: idx_compliance_requirements_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_compliance_requirements_org_id ON public.compliance_requirements USING btree (org_id);


--
-- Name: idx_compliance_requirements_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_compliance_requirements_type ON public.compliance_requirements USING btree (type);


--
-- Name: idx_consultant_availability_consultant_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_consultant_availability_consultant_id ON public.consultant_availability USING btree (consultant_id);


--
-- Name: idx_consultant_rates_consultant_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_consultant_rates_consultant_id ON public.consultant_rates USING btree (consultant_id);


--
-- Name: idx_consultant_visa_details_alert_level; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_consultant_visa_details_alert_level ON public.consultant_visa_details USING btree (alert_level);


--
-- Name: idx_consultant_visa_details_consultant_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_consultant_visa_details_consultant_id ON public.consultant_visa_details USING btree (consultant_id);


--
-- Name: idx_consultant_work_auth_consultant_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_consultant_work_auth_consultant_id ON public.consultant_work_authorization USING btree (consultant_id);


--
-- Name: idx_contact_agreements_contact; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contact_agreements_contact ON public.contact_agreements USING btree (contact_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_contact_agreements_expiry; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contact_agreements_expiry ON public.contact_agreements USING btree (expiry_date) WHERE ((status = 'active'::text) AND (deleted_at IS NULL));


--
-- Name: idx_contact_agreements_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contact_agreements_status ON public.contact_agreements USING btree (status) WHERE (deleted_at IS NULL);


--
-- Name: idx_contact_certifications_contact; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contact_certifications_contact ON public.contact_certifications USING btree (contact_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_contact_certifications_expiry; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contact_certifications_expiry ON public.contact_certifications USING btree (expiry_date) WHERE ((is_active = true) AND (deleted_at IS NULL));


--
-- Name: idx_contact_comm_prefs_contact; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contact_comm_prefs_contact ON public.contact_communication_preferences USING btree (contact_id);


--
-- Name: idx_contact_comm_prefs_opted_out; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contact_comm_prefs_opted_out ON public.contact_communication_preferences USING btree (channel) WHERE (is_opted_in = false);


--
-- Name: idx_contact_compliance_contact; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contact_compliance_contact ON public.contact_compliance USING btree (contact_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_contact_compliance_expiry; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contact_compliance_expiry ON public.contact_compliance USING btree (expiry_date) WHERE ((status = ANY (ARRAY['verified'::text, 'expiring'::text])) AND (deleted_at IS NULL));


--
-- Name: idx_contact_compliance_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contact_compliance_type ON public.contact_compliance USING btree (compliance_type, status) WHERE (deleted_at IS NULL);


--
-- Name: idx_contact_education_contact; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contact_education_contact ON public.contact_education USING btree (contact_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_contact_lead_data_contact_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contact_lead_data_contact_id ON public.contact_lead_data USING btree (contact_id);


--
-- Name: idx_contact_lead_data_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contact_lead_data_status ON public.contact_lead_data USING btree (lead_status);


--
-- Name: idx_contact_merge_history_merged; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contact_merge_history_merged ON public.contact_merge_history USING btree (merged_contact_id);


--
-- Name: idx_contact_merge_history_survivor; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contact_merge_history_survivor ON public.contact_merge_history USING btree (survivor_contact_id);


--
-- Name: idx_contact_rate_cards_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contact_rate_cards_active ON public.contact_rate_cards USING btree (contact_id, is_active) WHERE ((is_active = true) AND (deleted_at IS NULL));


--
-- Name: idx_contact_rate_cards_client; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contact_rate_cards_client ON public.contact_rate_cards USING btree (client_id) WHERE ((client_id IS NOT NULL) AND (deleted_at IS NULL));


--
-- Name: idx_contact_rate_cards_contact; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contact_rate_cards_contact ON public.contact_rate_cards USING btree (contact_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_contact_relationships_current; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contact_relationships_current ON public.contact_relationships USING btree (source_contact_id, is_current) WHERE ((is_current = true) AND (deleted_at IS NULL));


--
-- Name: idx_contact_relationships_source; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contact_relationships_source ON public.contact_relationships USING btree (source_contact_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_contact_relationships_target; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contact_relationships_target ON public.contact_relationships USING btree (target_contact_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_contact_relationships_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contact_relationships_type ON public.contact_relationships USING btree (relationship_type) WHERE (deleted_at IS NULL);


--
-- Name: idx_contact_roles_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contact_roles_active ON public.contact_roles USING btree (contact_id, role_type) WHERE ((role_status = 'active'::text) AND (role_ended_at IS NULL) AND (deleted_at IS NULL));


--
-- Name: idx_contact_roles_contact; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contact_roles_contact ON public.contact_roles USING btree (contact_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_contact_roles_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contact_roles_type ON public.contact_roles USING btree (role_type, role_status) WHERE (deleted_at IS NULL);


--
-- Name: idx_contact_skills_contact; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contact_skills_contact ON public.contact_skills USING btree (contact_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_contact_skills_name; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contact_skills_name ON public.contact_skills USING btree (skill_name) WHERE (deleted_at IS NULL);


--
-- Name: idx_contact_skills_primary; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contact_skills_primary ON public.contact_skills USING btree (contact_id) WHERE ((is_primary = true) AND (deleted_at IS NULL));


--
-- Name: idx_contact_skills_skill; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contact_skills_skill ON public.contact_skills USING btree (skill_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_contact_work_history_company; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contact_work_history_company ON public.contact_work_history USING btree (company_contact_id) WHERE ((company_contact_id IS NOT NULL) AND (deleted_at IS NULL));


--
-- Name: idx_contact_work_history_contact; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contact_work_history_contact ON public.contact_work_history USING btree (contact_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_contact_work_history_current; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contact_work_history_current ON public.contact_work_history USING btree (contact_id) WHERE ((is_current = true) AND (deleted_at IS NULL));


--
-- Name: idx_contacts_alumni_employee; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_alumni_employee ON public.contacts USING btree (alumni_former_employee_id) WHERE ((subtype = 'person_alumni'::text) AND (deleted_at IS NULL));


--
-- Name: idx_contacts_auth_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_auth_id ON public.contacts USING btree (auth_id) WHERE (auth_id IS NOT NULL);


--
-- Name: idx_contacts_bench_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_bench_status ON public.contacts USING btree (bench_status) WHERE ((category = 'person'::text) AND (subtype ~~ 'person_bench_%'::text) AND (deleted_at IS NULL));


--
-- Name: idx_contacts_candidate_hotlist; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_candidate_hotlist ON public.contacts USING btree (org_id, candidate_hotlist_added_at DESC) WHERE ((subtype = 'candidate'::text) AND (candidate_is_on_hotlist = true) AND (deleted_at IS NULL));


--
-- Name: idx_contacts_candidate_skills; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_candidate_skills ON public.contacts USING gin (candidate_skills) WHERE ((subtype = 'candidate'::text) AND (deleted_at IS NULL));


--
-- Name: idx_contacts_candidates; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_candidates ON public.contacts USING btree (org_id, candidate_status, created_at DESC) WHERE ((subtype = 'candidate'::text) AND (deleted_at IS NULL));


--
-- Name: idx_contacts_category; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_category ON public.contacts USING btree (category) WHERE (deleted_at IS NULL);


--
-- Name: idx_contacts_category_subtype; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_category_subtype ON public.contacts USING btree (category, subtype) WHERE (deleted_at IS NULL);


--
-- Name: idx_contacts_client_contact_company; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_client_contact_company ON public.contacts USING btree (client_contact_company_id) WHERE ((category = 'person'::text) AND (subtype ~~ 'person_%_contact'::text) AND (deleted_at IS NULL));


--
-- Name: idx_contacts_client_msp; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_client_msp ON public.contacts USING btree (client_msp_id) WHERE ((client_msp_id IS NOT NULL) AND (deleted_at IS NULL));


--
-- Name: idx_contacts_client_pocs; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_client_pocs ON public.contacts USING btree (org_id, account_id) WHERE ((subtype = 'client_poc'::text) AND (deleted_at IS NULL));


--
-- Name: idx_contacts_client_tier; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_client_tier ON public.contacts USING btree (client_tier, client_status) WHERE ((category = 'company'::text) AND (subtype = 'company_client'::text) AND (deleted_at IS NULL));


--
-- Name: idx_contacts_company_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_company_id ON public.contacts USING btree (company_id);


--
-- Name: idx_contacts_company_subtypes; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_company_subtypes ON public.contacts USING btree (subtype) WHERE ((category = 'company'::text) AND (deleted_at IS NULL));


--
-- Name: idx_contacts_contact_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_contact_status ON public.contacts USING btree (contact_status) WHERE (deleted_at IS NULL);


--
-- Name: idx_contacts_current_company; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_current_company ON public.contacts USING btree (current_company_id) WHERE ((current_company_id IS NOT NULL) AND (deleted_at IS NULL));


--
-- Name: idx_contacts_email; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_email ON public.contacts USING btree (email);


--
-- Name: idx_contacts_employees; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_employees ON public.contacts USING btree (org_id, employee_status) WHERE ((subtype = 'employee'::text) AND (deleted_at IS NULL));


--
-- Name: idx_contacts_employer_company; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_employer_company ON public.contacts USING btree (employer_company_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_contacts_engagement; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_engagement ON public.contacts USING btree (engagement_score);


--
-- Name: idx_contacts_lead_skills_needed; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_lead_skills_needed ON public.contacts USING gin (lead_skills_needed) WHERE ((subtype = 'lead'::text) AND (deleted_at IS NULL));


--
-- Name: idx_contacts_leads; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_leads ON public.contacts USING btree (org_id, lead_status, lead_score DESC) WHERE ((subtype = 'lead'::text) AND (deleted_at IS NULL));


--
-- Name: idx_contacts_linked_company; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_linked_company ON public.contacts USING btree (linked_company_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_contacts_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_org_id ON public.contacts USING btree (org_id);


--
-- Name: idx_contacts_owner_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_owner_id ON public.contacts USING btree (owner_id);


--
-- Name: idx_contacts_parent_company; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_parent_company ON public.contacts USING btree (parent_company_id) WHERE ((parent_company_id IS NOT NULL) AND (deleted_at IS NULL));


--
-- Name: idx_contacts_placed_client; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_placed_client ON public.contacts USING btree (placed_client_id, placed_status) WHERE ((category = 'person'::text) AND (subtype = 'person_placed'::text) AND (deleted_at IS NULL));


--
-- Name: idx_contacts_primary_address; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_primary_address ON public.contacts USING btree (primary_address_id) WHERE (primary_address_id IS NOT NULL);


--
-- Name: idx_contacts_primary_company; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_primary_company ON public.contacts USING btree (company_id, is_primary) WHERE ((is_primary = true) AND (deleted_at IS NULL));


--
-- Name: idx_contacts_prospects; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_prospects ON public.contacts USING btree (org_id, prospect_sequence_status, engagement_score DESC) WHERE ((subtype = 'prospect'::text) AND (deleted_at IS NULL));


--
-- Name: idx_contacts_search; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_search ON public.contacts USING gin (search_vector);


--
-- Name: idx_contacts_source_company; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_source_company ON public.contacts USING btree (source_company_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_contacts_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_status ON public.contacts USING btree (status);


--
-- Name: idx_contacts_subtype; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_subtype ON public.contacts USING btree (subtype) WHERE (deleted_at IS NULL);


--
-- Name: idx_contacts_types; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_types ON public.contacts USING gin (types);


--
-- Name: idx_contacts_user_profile_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_user_profile_id ON public.contacts USING btree (user_profile_id) WHERE (user_profile_id IS NOT NULL);


--
-- Name: idx_contacts_vendor_company; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_vendor_company ON public.contacts USING btree (vendor_company_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_contacts_vendor_contact_company; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_vendor_contact_company ON public.contacts USING btree (vendor_contact_company_id) WHERE ((category = 'person'::text) AND (subtype = 'person_vendor_contact'::text) AND (deleted_at IS NULL));


--
-- Name: idx_contacts_vendor_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_vendor_id ON public.contacts USING btree (vendor_id) WHERE (vendor_id IS NOT NULL);


--
-- Name: idx_contacts_vendor_pocs; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_vendor_pocs ON public.contacts USING btree (org_id, vendor_id) WHERE ((subtype = 'vendor_poc'::text) AND (deleted_at IS NULL));


--
-- Name: idx_contacts_vendor_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contacts_vendor_status ON public.contacts USING btree (vendor_status, vendor_tier) WHERE ((category = 'company'::text) AND (subtype = 'company_vendor'::text) AND (deleted_at IS NULL));


--
-- Name: idx_content_assets_file_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_content_assets_file_type ON public.content_assets USING btree (file_type);


--
-- Name: idx_content_assets_is_current; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_content_assets_is_current ON public.content_assets USING btree (is_current) WHERE (is_current = true);


--
-- Name: idx_content_assets_lesson; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_content_assets_lesson ON public.content_assets USING btree (lesson_id);


--
-- Name: idx_content_assets_search; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_content_assets_search ON public.content_assets USING gin (to_tsvector('english'::regconfig, COALESCE(searchable_content, ''::text)));


--
-- Name: idx_content_assets_storage_path; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_content_assets_storage_path ON public.content_assets USING btree (storage_path);


--
-- Name: idx_content_assets_topic; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_content_assets_topic ON public.content_assets USING btree (topic_id);


--
-- Name: idx_content_assets_uploaded_by; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_content_assets_uploaded_by ON public.content_assets USING btree (uploaded_by);


--
-- Name: idx_contracts_company; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contracts_company ON public.company_contracts USING btree (company_id, status) WHERE (deleted_at IS NULL);


--
-- Name: idx_contracts_expiration; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contracts_expiration ON public.company_contracts USING btree (expiration_date) WHERE ((status = 'active'::public.contract_status) AND (deleted_at IS NULL));


--
-- Name: idx_course_modules_course_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_course_modules_course_id ON public.course_modules USING btree (course_id);


--
-- Name: idx_course_modules_number; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_course_modules_number ON public.course_modules USING btree (course_id, module_number);


--
-- Name: idx_course_pricing_course; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_course_pricing_course ON public.course_pricing USING btree (course_id);


--
-- Name: idx_course_pricing_early_bird; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_course_pricing_early_bird ON public.course_pricing USING btree (early_bird_valid_until) WHERE (early_bird_price IS NOT NULL);


--
-- Name: idx_course_revenue_analytics_course; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX idx_course_revenue_analytics_course ON public.course_revenue_analytics USING btree (course_id);


--
-- Name: idx_courses_featured; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_courses_featured ON public.courses USING btree (is_featured) WHERE (is_featured = true);


--
-- Name: idx_courses_published; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_courses_published ON public.courses USING btree (is_published) WHERE (is_published = true);


--
-- Name: idx_courses_slug; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_courses_slug ON public.courses USING btree (slug);


--
-- Name: idx_deal_competitors_deal_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deal_competitors_deal_id ON public.deal_competitors USING btree (deal_id);


--
-- Name: idx_deal_competitors_name; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deal_competitors_name ON public.deal_competitors USING btree (competitor_name);


--
-- Name: idx_deal_competitors_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deal_competitors_status ON public.deal_competitors USING btree (status);


--
-- Name: idx_deal_products_deal_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deal_products_deal_id ON public.deal_products USING btree (deal_id);


--
-- Name: idx_deal_products_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deal_products_type ON public.deal_products USING btree (product_type);


--
-- Name: idx_deal_stages_history_deal_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deal_stages_history_deal_id ON public.deal_stages_history USING btree (deal_id);


--
-- Name: idx_deal_stages_history_entered_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deal_stages_history_entered_at ON public.deal_stages_history USING btree (entered_at);


--
-- Name: idx_deal_stages_history_stage; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deal_stages_history_stage ON public.deal_stages_history USING btree (stage);


--
-- Name: idx_deal_stakeholders_contact_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deal_stakeholders_contact_id ON public.deal_stakeholders USING btree (contact_id);


--
-- Name: idx_deal_stakeholders_deal_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deal_stakeholders_deal_id ON public.deal_stakeholders USING btree (deal_id);


--
-- Name: idx_deal_stakeholders_role; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deal_stakeholders_role ON public.deal_stakeholders USING btree (role);


--
-- Name: idx_deals_account; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deals_account ON public.deals USING btree (account_id);


--
-- Name: idx_deals_account_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deals_account_id ON public.deals USING btree (account_id);


--
-- Name: idx_deals_company_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deals_company_id ON public.deals USING btree (company_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_deals_expected_close; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deals_expected_close ON public.deals USING btree (expected_close_date);


--
-- Name: idx_deals_expected_close_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deals_expected_close_active ON public.deals USING btree (expected_close_date) WHERE ((deleted_at IS NULL) AND (stage <> ALL (ARRAY['closed_won'::text, 'closed_lost'::text])));


--
-- Name: idx_deals_health_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deals_health_status ON public.deals USING btree (health_status) WHERE ((deleted_at IS NULL) AND (stage <> ALL (ARRAY['closed_won'::text, 'closed_lost'::text])));


--
-- Name: idx_deals_last_activity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deals_last_activity ON public.deals USING btree (last_activity_at) WHERE ((deleted_at IS NULL) AND (stage <> ALL (ARRAY['closed_won'::text, 'closed_lost'::text])));


--
-- Name: idx_deals_lead; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deals_lead ON public.deals USING btree (lead_id);


--
-- Name: idx_deals_lead_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deals_lead_id ON public.deals USING btree (lead_id);


--
-- Name: idx_deals_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deals_org ON public.deals USING btree (org_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_deals_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deals_org_id ON public.deals USING btree (org_id);


--
-- Name: idx_deals_owner; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deals_owner ON public.deals USING btree (owner_id);


--
-- Name: idx_deals_owner_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deals_owner_id ON public.deals USING btree (owner_id);


--
-- Name: idx_deals_stage; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deals_stage ON public.deals USING btree (stage);


--
-- Name: idx_deals_stage_owner; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_deals_stage_owner ON public.deals USING btree (stage, owner_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_discount_codes_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_discount_codes_active ON public.discount_codes USING btree (is_active, valid_from, valid_until) WHERE (deleted_at IS NULL);


--
-- Name: idx_discount_codes_code; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_discount_codes_code ON public.discount_codes USING btree (code) WHERE ((deleted_at IS NULL) AND (is_active = true));


--
-- Name: idx_discount_codes_validity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_discount_codes_validity ON public.discount_codes USING btree (valid_from, valid_until) WHERE ((deleted_at IS NULL) AND (is_active = true));


--
-- Name: idx_discount_effectiveness_code; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX idx_discount_effectiveness_code ON public.discount_effectiveness_analytics USING btree (discount_code_id);


--
-- Name: idx_discount_usage_code; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_discount_usage_code ON public.discount_code_usage USING btree (discount_code_id);


--
-- Name: idx_discount_usage_enrollment; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_discount_usage_enrollment ON public.discount_code_usage USING btree (enrollment_id);


--
-- Name: idx_discount_usage_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_discount_usage_user ON public.discount_code_usage USING btree (user_id);


--
-- Name: idx_discount_usage_user_code; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX idx_discount_usage_user_code ON public.discount_code_usage USING btree (user_id, discount_code_id);


--
-- Name: idx_document_templates_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_document_templates_active ON public.document_templates USING btree (is_active) WHERE (is_active = true);


--
-- Name: idx_document_templates_category; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_document_templates_category ON public.document_templates USING btree (category);


--
-- Name: idx_document_templates_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_document_templates_org_id ON public.document_templates USING btree (org_id);


--
-- Name: idx_document_templates_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_document_templates_type ON public.document_templates USING btree (template_type);


--
-- Name: idx_duplicate_records_confidence; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_duplicate_records_confidence ON public.duplicate_records USING btree (confidence_score DESC);


--
-- Name: idx_duplicate_records_entity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_duplicate_records_entity ON public.duplicate_records USING btree (entity_type);


--
-- Name: idx_duplicate_records_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_duplicate_records_org ON public.duplicate_records USING btree (org_id);


--
-- Name: idx_duplicate_records_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_duplicate_records_status ON public.duplicate_records USING btree (status);


--
-- Name: idx_duplicate_rules_entity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_duplicate_rules_entity ON public.duplicate_rules USING btree (entity_type);


--
-- Name: idx_duplicate_rules_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_duplicate_rules_org ON public.duplicate_rules USING btree (org_id);


--
-- Name: idx_education_candidate; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_education_candidate ON public.candidate_education USING btree (candidate_id);


--
-- Name: idx_education_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_education_org ON public.candidate_education USING btree (org_id);


--
-- Name: idx_email_logs_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_email_logs_org_id ON public.email_logs USING btree (org_id);


--
-- Name: idx_email_logs_resend_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_email_logs_resend_id ON public.email_logs USING btree (resend_id) WHERE (resend_id IS NOT NULL);


--
-- Name: idx_email_logs_sent_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_email_logs_sent_at ON public.email_logs USING btree (sent_at DESC);


--
-- Name: idx_email_logs_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_email_logs_status ON public.email_logs USING btree (status);


--
-- Name: idx_email_logs_template_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_email_logs_template_id ON public.email_logs USING btree (template_id);


--
-- Name: idx_email_logs_to_email; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_email_logs_to_email ON public.email_logs USING btree (to_email);


--
-- Name: idx_email_senders_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_email_senders_org ON public.email_senders USING btree (org_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_email_sends_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_email_sends_org ON public.email_sends USING btree (org_id);


--
-- Name: idx_email_sends_recipient; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_email_sends_recipient ON public.email_sends USING btree (recipient_email, created_at);


--
-- Name: idx_email_sends_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_email_sends_status ON public.email_sends USING btree (org_id, status, created_at);


--
-- Name: idx_email_sends_template; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_email_sends_template ON public.email_sends USING btree (template_id, status);


--
-- Name: idx_email_templates_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_email_templates_active ON public.email_templates USING btree (is_active) WHERE (is_active = true);


--
-- Name: idx_email_templates_category; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_email_templates_category ON public.email_templates USING btree (category);


--
-- Name: idx_email_templates_org_category; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_email_templates_org_category ON public.email_templates USING btree (org_id, category) WHERE (deleted_at IS NULL);


--
-- Name: idx_email_templates_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_email_templates_org_id ON public.email_templates USING btree (org_id);


--
-- Name: idx_email_templates_org_slug; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_email_templates_org_slug ON public.email_templates USING btree (org_id, slug) WHERE (deleted_at IS NULL);


--
-- Name: idx_email_templates_org_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_email_templates_org_status ON public.email_templates USING btree (org_id, status) WHERE (deleted_at IS NULL);


--
-- Name: idx_emergency_drills_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_emergency_drills_org ON public.emergency_drills USING btree (org_id);


--
-- Name: idx_emergency_drills_scheduled; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_emergency_drills_scheduled ON public.emergency_drills USING btree (scheduled_at);


--
-- Name: idx_emergency_drills_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_emergency_drills_status ON public.emergency_drills USING btree (status);


--
-- Name: idx_emergency_drills_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_emergency_drills_type ON public.emergency_drills USING btree (drill_type);


--
-- Name: idx_employee_benefits_employee_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_employee_benefits_employee_id ON public.employee_benefits USING btree (employee_id);


--
-- Name: idx_employee_benefits_plan_option_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_employee_benefits_plan_option_id ON public.employee_benefits USING btree (plan_option_id);


--
-- Name: idx_employee_benefits_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_employee_benefits_status ON public.employee_benefits USING btree (status);


--
-- Name: idx_employee_compliance_employee_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_employee_compliance_employee_id ON public.employee_compliance USING btree (employee_id);


--
-- Name: idx_employee_compliance_requirement_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_employee_compliance_requirement_id ON public.employee_compliance USING btree (requirement_id);


--
-- Name: idx_employee_compliance_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_employee_compliance_status ON public.employee_compliance USING btree (status);


--
-- Name: idx_employee_documents_employee_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_employee_documents_employee_id ON public.employee_documents USING btree (employee_id);


--
-- Name: idx_employee_documents_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_employee_documents_status ON public.employee_documents USING btree (status);


--
-- Name: idx_employee_documents_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_employee_documents_type ON public.employee_documents USING btree (document_type);


--
-- Name: idx_employee_id_number; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_employee_id_number ON public.employee_metadata USING btree (employee_id_number) WHERE (employee_id_number IS NOT NULL);


--
-- Name: idx_employee_metadata_pod; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_employee_metadata_pod ON public.employee_metadata USING btree (pod_id);


--
-- Name: idx_employee_onboarding_employee_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_employee_onboarding_employee_id ON public.employee_onboarding USING btree (employee_id);


--
-- Name: idx_employee_onboarding_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_employee_onboarding_status ON public.employee_onboarding USING btree (status);


--
-- Name: idx_employee_time_off_dates; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_employee_time_off_dates ON public.employee_time_off USING btree (start_date, end_date);


--
-- Name: idx_employee_time_off_employee_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_employee_time_off_employee_id ON public.employee_time_off USING btree (employee_id);


--
-- Name: idx_employee_time_off_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_employee_time_off_status ON public.employee_time_off USING btree (status);


--
-- Name: idx_employee_twin_interactions_role; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_employee_twin_interactions_role ON public.employee_twin_interactions USING btree (twin_role, created_at DESC);


--
-- Name: idx_employee_twin_interactions_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_employee_twin_interactions_type ON public.employee_twin_interactions USING btree (interaction_type, created_at DESC);


--
-- Name: idx_employee_twin_interactions_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_employee_twin_interactions_user ON public.employee_twin_interactions USING btree (user_id, created_at DESC);


--
-- Name: idx_employees_deleted_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_employees_deleted_at ON public.employees USING btree (deleted_at) WHERE (deleted_at IS NULL);


--
-- Name: idx_employees_manager_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_employees_manager_id ON public.employees USING btree (manager_id);


--
-- Name: idx_employees_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_employees_org_id ON public.employees USING btree (org_id);


--
-- Name: idx_employees_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_employees_status ON public.employees USING btree (status);


--
-- Name: idx_employees_user_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_employees_user_id ON public.employees USING btree (user_id);


--
-- Name: idx_engagement_contact; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_engagement_contact ON public.engagement_tracking USING btree (campaign_contact_id);


--
-- Name: idx_engagement_timestamp; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_engagement_timestamp ON public.engagement_tracking USING btree (event_timestamp DESC);


--
-- Name: idx_engagement_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_engagement_type ON public.engagement_tracking USING btree (event_type);


--
-- Name: idx_enrollments_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_enrollments_active ON public.student_enrollments USING btree (user_id, status) WHERE (status = 'active'::text);


--
-- Name: idx_enrollments_course_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_enrollments_course_id ON public.student_enrollments USING btree (course_id);


--
-- Name: idx_enrollments_payment; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_enrollments_payment ON public.student_enrollments USING btree (payment_id) WHERE (payment_id IS NOT NULL);


--
-- Name: idx_enrollments_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_enrollments_status ON public.student_enrollments USING btree (status);


--
-- Name: idx_enrollments_user_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_enrollments_user_id ON public.student_enrollments USING btree (user_id);


--
-- Name: idx_escalation_notifications_escalation_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_escalation_notifications_escalation_id ON public.escalation_notifications USING btree (escalation_id);


--
-- Name: idx_escalation_notifications_sent_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_escalation_notifications_sent_at ON public.escalation_notifications USING btree (sent_at);


--
-- Name: idx_escalation_updates_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_escalation_updates_created_at ON public.escalation_updates USING btree (created_at);


--
-- Name: idx_escalation_updates_escalation; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_escalation_updates_escalation ON public.escalation_updates USING btree (escalation_id);


--
-- Name: idx_escalation_updates_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_escalation_updates_type ON public.escalation_updates USING btree (update_type);


--
-- Name: idx_escalations_assigned_to; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_escalations_assigned_to ON public.ai_mentor_escalations USING btree (assigned_to) WHERE (assigned_to IS NOT NULL);


--
-- Name: idx_escalations_chat_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_escalations_chat_id ON public.ai_mentor_escalations USING btree (chat_id);


--
-- Name: idx_escalations_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_escalations_created_at ON public.ai_mentor_escalations USING btree (created_at DESC);


--
-- Name: idx_escalations_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_escalations_status ON public.ai_mentor_escalations USING btree (status) WHERE (status = ANY (ARRAY['pending'::text, 'in_progress'::text]));


--
-- Name: idx_escalations_topic_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_escalations_topic_id ON public.ai_mentor_escalations USING btree (topic_id);


--
-- Name: idx_escalations_user_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_escalations_user_id ON public.ai_mentor_escalations USING btree (user_id);


--
-- Name: idx_event_delivery_attempted; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_event_delivery_attempted ON public.event_delivery_log USING btree (attempted_at DESC);


--
-- Name: idx_event_delivery_event; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_event_delivery_event ON public.event_delivery_log USING btree (event_id);


--
-- Name: idx_event_delivery_log_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_event_delivery_log_org_id ON public.event_delivery_log USING btree (org_id);


--
-- Name: idx_event_delivery_subscription; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_event_delivery_subscription ON public.event_delivery_log USING btree (subscription_id);


--
-- Name: idx_event_subscriptions_channel; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_event_subscriptions_channel ON public.event_subscriptions USING btree (channel);


--
-- Name: idx_event_subscriptions_failure_count; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_event_subscriptions_failure_count ON public.event_subscriptions USING btree (failure_count);


--
-- Name: idx_event_subscriptions_is_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_event_subscriptions_is_active ON public.event_subscriptions USING btree (is_active);


--
-- Name: idx_event_subscriptions_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_event_subscriptions_org_id ON public.event_subscriptions USING btree (org_id);


--
-- Name: idx_event_subscriptions_unique; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX idx_event_subscriptions_unique ON public.event_subscriptions USING btree (subscriber_name, event_pattern);


--
-- Name: idx_event_subscriptions_user_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_event_subscriptions_user_id ON public.event_subscriptions USING btree (user_id);


--
-- Name: idx_events_actor_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_events_actor_id ON public.events USING btree (actor_id);


--
-- Name: idx_events_aggregate_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_events_aggregate_id ON public.events USING btree (aggregate_id) WHERE (aggregate_id IS NOT NULL);


--
-- Name: idx_events_correlation_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_events_correlation_id ON public.events USING btree (correlation_id);


--
-- Name: idx_events_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_events_created_at ON public.events USING btree (created_at DESC);


--
-- Name: idx_events_entity_type_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_events_entity_type_id ON public.events USING btree (entity_type, entity_id);


--
-- Name: idx_events_event_category; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_events_event_category ON public.events USING btree (event_category);


--
-- Name: idx_events_event_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_events_event_type ON public.events USING btree (event_type);


--
-- Name: idx_events_idempotency_key; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_events_idempotency_key ON public.events USING btree (idempotency_key);


--
-- Name: idx_events_next_retry; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_events_next_retry ON public.events USING btree (next_retry_at) WHERE (next_retry_at IS NOT NULL);


--
-- Name: idx_events_occurred_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_events_occurred_at ON public.events USING btree (occurred_at);


--
-- Name: idx_events_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_events_org_id ON public.events USING btree (org_id);


--
-- Name: idx_events_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_events_status ON public.events USING btree (status) WHERE (status = ANY (ARRAY['pending'::text, 'processing'::text, 'failed'::text]));


--
-- Name: idx_events_user_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_events_user_id ON public.events USING btree (user_id) WHERE (user_id IS NOT NULL);


--
-- Name: idx_export_jobs_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_export_jobs_created_at ON public.export_jobs USING btree (created_at DESC);


--
-- Name: idx_export_jobs_next_run; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_export_jobs_next_run ON public.export_jobs USING btree (next_run_at) WHERE (is_scheduled = true);


--
-- Name: idx_export_jobs_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_export_jobs_org ON public.export_jobs USING btree (org_id);


--
-- Name: idx_export_jobs_scheduled; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_export_jobs_scheduled ON public.export_jobs USING btree (is_scheduled) WHERE (is_scheduled = true);


--
-- Name: idx_export_jobs_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_export_jobs_status ON public.export_jobs USING btree (status);


--
-- Name: idx_external_job_orders_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_external_job_orders_org ON public.external_job_orders USING btree (org_id);


--
-- Name: idx_external_job_orders_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_external_job_orders_status ON public.external_job_orders USING btree (org_id, status) WHERE (deleted_at IS NULL);


--
-- Name: idx_external_job_orders_vendor_company; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_external_job_orders_vendor_company ON public.external_job_orders USING btree (vendor_company_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_failover_config_backup; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_failover_config_backup ON public.integration_failover_config USING btree (backup_integration_id);


--
-- Name: idx_failover_config_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_failover_config_org ON public.integration_failover_config USING btree (org_id);


--
-- Name: idx_failover_config_primary; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_failover_config_primary ON public.integration_failover_config USING btree (primary_integration_id);


--
-- Name: idx_feature_flag_feedback_flag; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feature_flag_feedback_flag ON public.feature_flag_feedback USING btree (feature_flag_id);


--
-- Name: idx_feature_flag_roles_flag; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feature_flag_roles_flag ON public.feature_flag_roles USING btree (feature_flag_id);


--
-- Name: idx_feature_flag_roles_role; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feature_flag_roles_role ON public.feature_flag_roles USING btree (role_id);


--
-- Name: idx_feature_flag_usage_flag; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feature_flag_usage_flag ON public.feature_flag_usage USING btree (feature_flag_id, checked_at DESC);


--
-- Name: idx_feature_flag_usage_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feature_flag_usage_org ON public.feature_flag_usage USING btree (org_id, checked_at DESC);


--
-- Name: idx_feature_flag_usage_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feature_flag_usage_user ON public.feature_flag_usage USING btree (user_id, checked_at DESC);


--
-- Name: idx_feature_flags_code; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feature_flags_code ON public.feature_flags USING btree (key);


--
-- Name: idx_feature_flags_enabled_pods; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feature_flags_enabled_pods ON public.feature_flags USING gin (enabled_pods);


--
-- Name: idx_feature_flags_enabled_roles; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feature_flags_enabled_roles ON public.feature_flags USING gin (enabled_roles);


--
-- Name: idx_feature_flags_enabled_users; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feature_flags_enabled_users ON public.feature_flags USING gin (enabled_users);


--
-- Name: idx_feature_flags_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feature_flags_org ON public.feature_flags USING btree (org_id);


--
-- Name: idx_feature_flags_org_key; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feature_flags_org_key ON public.feature_flags USING btree (org_id, key);


--
-- Name: idx_feature_flags_org_state; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_feature_flags_org_state ON public.feature_flags USING btree (org_id, state);


--
-- Name: idx_file_uploads_bucket; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_file_uploads_bucket ON public.file_uploads USING btree (bucket);


--
-- Name: idx_file_uploads_entity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_file_uploads_entity ON public.file_uploads USING btree (entity_type, entity_id);


--
-- Name: idx_file_uploads_not_deleted; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_file_uploads_not_deleted ON public.file_uploads USING btree (deleted_at) WHERE (deleted_at IS NULL);


--
-- Name: idx_file_uploads_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_file_uploads_org_id ON public.file_uploads USING btree (org_id);


--
-- Name: idx_file_uploads_uploaded_by; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_file_uploads_uploaded_by ON public.file_uploads USING btree (uploaded_by);


--
-- Name: idx_gdpr_requests_due_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_gdpr_requests_due_date ON public.gdpr_requests USING btree (due_date);


--
-- Name: idx_gdpr_requests_email; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_gdpr_requests_email ON public.gdpr_requests USING btree (subject_email);


--
-- Name: idx_gdpr_requests_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_gdpr_requests_org ON public.gdpr_requests USING btree (org_id);


--
-- Name: idx_gdpr_requests_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_gdpr_requests_status ON public.gdpr_requests USING btree (status);


--
-- Name: idx_gdpr_requests_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_gdpr_requests_type ON public.gdpr_requests USING btree (request_type);


--
-- Name: idx_generated_documents_entity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_generated_documents_entity ON public.generated_documents USING btree (entity_type, entity_id);


--
-- Name: idx_generated_documents_generated_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_generated_documents_generated_at ON public.generated_documents USING btree (generated_at DESC);


--
-- Name: idx_generated_documents_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_generated_documents_org_id ON public.generated_documents USING btree (org_id);


--
-- Name: idx_generated_documents_template_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_generated_documents_template_id ON public.generated_documents USING btree (template_id);


--
-- Name: idx_graduate_candidates_enrollment; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_graduate_candidates_enrollment ON public.graduate_candidates USING btree (enrollment_id);


--
-- Name: idx_graduate_candidates_pending; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_graduate_candidates_pending ON public.graduate_candidates USING btree (assigned_recruiter_id) WHERE (status = 'pending_review'::public.graduate_candidate_status);


--
-- Name: idx_graduate_candidates_recruiter; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_graduate_candidates_recruiter ON public.graduate_candidates USING btree (assigned_recruiter_id);


--
-- Name: idx_graduate_candidates_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_graduate_candidates_status ON public.graduate_candidates USING btree (status);


--
-- Name: idx_graduate_candidates_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_graduate_candidates_user ON public.graduate_candidates USING btree (user_id);


--
-- Name: idx_guru_interactions_agent_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_guru_interactions_agent_type ON public.guru_interactions USING btree (agent_type, created_at DESC);


--
-- Name: idx_guru_interactions_conversation; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_guru_interactions_conversation ON public.guru_interactions USING btree (conversation_id) WHERE (conversation_id IS NOT NULL);


--
-- Name: idx_guru_interactions_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_guru_interactions_org ON public.guru_interactions USING btree (org_id, created_at DESC);


--
-- Name: idx_guru_interactions_student; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_guru_interactions_student ON public.guru_interactions USING btree (student_id, created_at DESC);


--
-- Name: idx_health_logs_created; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_health_logs_created ON public.integration_health_logs USING btree (created_at DESC);


--
-- Name: idx_health_logs_integration; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_health_logs_integration ON public.integration_health_logs USING btree (integration_id);


--
-- Name: idx_health_logs_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_health_logs_org ON public.integration_health_logs USING btree (org_id);


--
-- Name: idx_health_logs_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_health_logs_status ON public.integration_health_logs USING btree (status);


--
-- Name: idx_health_scores_company; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_health_scores_company ON public.company_health_scores USING btree (company_id, score_date DESC);


--
-- Name: idx_health_scores_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_health_scores_date ON public.company_health_scores USING btree (org_id, score_date DESC);


--
-- Name: idx_hotlist_consultants_consultant_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_hotlist_consultants_consultant_id ON public.hotlist_consultants USING btree (consultant_id);


--
-- Name: idx_hotlist_consultants_hotlist_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_hotlist_consultants_hotlist_id ON public.hotlist_consultants USING btree (hotlist_id);


--
-- Name: idx_i9_records_employee_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_i9_records_employee_id ON public.i9_records USING btree (employee_id);


--
-- Name: idx_i9_records_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_i9_records_status ON public.i9_records USING btree (status);


--
-- Name: idx_immigration_alerts_alert_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_immigration_alerts_alert_date ON public.immigration_alerts USING btree (alert_date);


--
-- Name: idx_immigration_alerts_consultant_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_immigration_alerts_consultant_id ON public.immigration_alerts USING btree (consultant_id);


--
-- Name: idx_immigration_alerts_severity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_immigration_alerts_severity ON public.immigration_alerts USING btree (severity);


--
-- Name: idx_immigration_attorneys_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_immigration_attorneys_org_id ON public.immigration_attorneys USING btree (org_id);


--
-- Name: idx_immigration_documents_case_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_immigration_documents_case_id ON public.immigration_documents USING btree (case_id);


--
-- Name: idx_immigration_timelines_case_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_immigration_timelines_case_id ON public.immigration_timelines USING btree (case_id);


--
-- Name: idx_import_jobs_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_import_jobs_created_at ON public.import_jobs USING btree (created_at DESC);


--
-- Name: idx_import_jobs_created_by; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_import_jobs_created_by ON public.import_jobs USING btree (created_by);


--
-- Name: idx_import_jobs_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_import_jobs_org ON public.import_jobs USING btree (org_id);


--
-- Name: idx_import_jobs_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_import_jobs_status ON public.import_jobs USING btree (status);


--
-- Name: idx_incident_notifications_incident; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_incident_notifications_incident ON public.incident_notifications USING btree (incident_id);


--
-- Name: idx_incident_notifications_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_incident_notifications_org ON public.incident_notifications USING btree (org_id);


--
-- Name: idx_incident_notifications_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_incident_notifications_status ON public.incident_notifications USING btree (status);


--
-- Name: idx_incident_timeline_created; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_incident_timeline_created ON public.incident_timeline USING btree (created_at DESC);


--
-- Name: idx_incident_timeline_incident; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_incident_timeline_incident ON public.incident_timeline USING btree (incident_id);


--
-- Name: idx_incident_timeline_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_incident_timeline_org ON public.incident_timeline USING btree (org_id);


--
-- Name: idx_incidents_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_incidents_org ON public.incidents USING btree (org_id);


--
-- Name: idx_incidents_org_created; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_incidents_org_created ON public.incidents USING btree (org_id, created_at DESC);


--
-- Name: idx_incidents_org_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_incidents_org_status ON public.incidents USING btree (org_id, status);


--
-- Name: idx_incidents_severity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_incidents_severity ON public.incidents USING btree (severity);


--
-- Name: idx_incidents_started; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_incidents_started ON public.incidents USING btree (started_at DESC);


--
-- Name: idx_incidents_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_incidents_status ON public.incidents USING btree (status);


--
-- Name: idx_integrations_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_integrations_org_id ON public.integrations USING btree (org_id);


--
-- Name: idx_integrations_org_primary; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_integrations_org_primary ON public.integrations USING btree (org_id, type, is_primary) WHERE ((is_primary = true) AND (deleted_at IS NULL));


--
-- Name: idx_integrations_org_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_integrations_org_type ON public.integrations USING btree (org_id, type);


--
-- Name: idx_integrations_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_integrations_status ON public.integrations USING btree (status);


--
-- Name: idx_integrations_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_integrations_type ON public.integrations USING btree (type);


--
-- Name: idx_integrations_unique_primary; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX idx_integrations_unique_primary ON public.integrations USING btree (org_id, type) WHERE ((is_primary = true) AND (deleted_at IS NULL));


--
-- Name: idx_interview_feedback_interview_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_interview_feedback_interview_id ON public.interview_feedback USING btree (interview_id);


--
-- Name: idx_interview_participants_interview_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_interview_participants_interview_id ON public.interview_participants USING btree (interview_id);


--
-- Name: idx_interview_reminders_interview_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_interview_reminders_interview_id ON public.interview_reminders USING btree (interview_id);


--
-- Name: idx_interview_sessions_module; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_interview_sessions_module ON public.interview_sessions USING btree (guidewire_module) WHERE (guidewire_module IS NOT NULL);


--
-- Name: idx_interview_sessions_score; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_interview_sessions_score ON public.interview_sessions USING btree (average_score DESC);


--
-- Name: idx_interview_sessions_student; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_interview_sessions_student ON public.interview_sessions USING btree (student_id, created_at DESC);


--
-- Name: idx_interview_sessions_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_interview_sessions_type ON public.interview_sessions USING btree (interview_type);


--
-- Name: idx_interviews_attendance; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_interviews_attendance ON public.interviews USING btree (attendance_status);


--
-- Name: idx_interviews_candidate; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_interviews_candidate ON public.interviews USING btree (candidate_id);


--
-- Name: idx_interviews_confirmed_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_interviews_confirmed_at ON public.interviews USING btree (confirmed_at);


--
-- Name: idx_interviews_contact_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_interviews_contact_id ON public.interviews USING btree (contact_id) WHERE (contact_id IS NOT NULL);


--
-- Name: idx_interviews_job; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_interviews_job ON public.interviews USING btree (job_id);


--
-- Name: idx_interviews_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_interviews_org_id ON public.interviews USING btree (org_id);


--
-- Name: idx_interviews_prep_completed; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_interviews_prep_completed ON public.interviews USING btree (prep_completed_at);


--
-- Name: idx_interviews_proposed_times; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_interviews_proposed_times ON public.interviews USING gin (proposed_times);


--
-- Name: idx_interviews_scheduled; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_interviews_scheduled ON public.interviews USING btree (scheduled_at);


--
-- Name: idx_interviews_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_interviews_status ON public.interviews USING btree (status);


--
-- Name: idx_interviews_submission; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_interviews_submission ON public.interviews USING btree (submission_id);


--
-- Name: idx_job_assignments_job_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_job_assignments_job_id ON public.job_assignments USING btree (job_id);


--
-- Name: idx_job_assignments_user_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_job_assignments_user_id ON public.job_assignments USING btree (user_id);


--
-- Name: idx_job_order_notes_order_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_job_order_notes_order_id ON public.external_job_order_notes USING btree (order_id);


--
-- Name: idx_job_order_requirements_order_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_job_order_requirements_order_id ON public.external_job_order_requirements USING btree (order_id);


--
-- Name: idx_job_order_skills_order_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_job_order_skills_order_id ON public.external_job_order_skills USING btree (order_id);


--
-- Name: idx_job_order_submissions_consultant_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_job_order_submissions_consultant_id ON public.external_job_order_submissions USING btree (consultant_id);


--
-- Name: idx_job_order_submissions_order_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_job_order_submissions_order_id ON public.external_job_order_submissions USING btree (order_id);


--
-- Name: idx_job_orders_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_job_orders_org_id ON public.external_job_orders USING btree (org_id);


--
-- Name: idx_job_orders_priority; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_job_orders_priority ON public.external_job_orders USING btree (priority);


--
-- Name: idx_job_orders_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_job_orders_status ON public.external_job_orders USING btree (status);


--
-- Name: idx_job_orders_vendor_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_job_orders_vendor_id ON public.external_job_orders USING btree (vendor_id);


--
-- Name: idx_job_rates_job_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_job_rates_job_id ON public.job_rates USING btree (job_id);


--
-- Name: idx_job_requirements_job_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_job_requirements_job_id ON public.job_requirements USING btree (job_id);


--
-- Name: idx_job_screening_questions_job_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_job_screening_questions_job_id ON public.job_screening_questions USING btree (job_id);


--
-- Name: idx_job_skills_job_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_job_skills_job_id ON public.job_skills USING btree (job_id);


--
-- Name: idx_job_skills_skill_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_job_skills_skill_id ON public.job_skills USING btree (skill_id);


--
-- Name: idx_job_status_history_job_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_job_status_history_job_id ON public.job_status_history USING btree (job_id);


--
-- Name: idx_job_status_history_new_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_job_status_history_new_status ON public.job_status_history USING btree (new_status);


--
-- Name: idx_job_status_history_org_changed_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_job_status_history_org_changed_at ON public.job_status_history USING btree (org_id, changed_at DESC);


--
-- Name: idx_jobs_account; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_jobs_account ON public.jobs USING btree (account_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_jobs_company_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_jobs_company_id ON public.jobs USING btree (company_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_jobs_deal; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_jobs_deal ON public.jobs USING btree (deal_id);


--
-- Name: idx_jobs_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_jobs_org ON public.jobs USING btree (org_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_jobs_owner; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_jobs_owner ON public.jobs USING btree (owner_id);


--
-- Name: idx_jobs_posted_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_jobs_posted_date ON public.jobs USING btree (posted_date DESC);


--
-- Name: idx_jobs_search; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_jobs_search ON public.jobs USING gin (search_vector);


--
-- Name: idx_jobs_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_jobs_status ON public.jobs USING btree (status) WHERE (deleted_at IS NULL);


--
-- Name: idx_lab_instances_active_unique; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX idx_lab_instances_active_unique ON public.lab_instances USING btree (user_id, topic_id) WHERE (status = 'active'::text);


--
-- Name: idx_lab_instances_enrollment; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_lab_instances_enrollment ON public.lab_instances USING btree (enrollment_id);


--
-- Name: idx_lab_instances_expires; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_lab_instances_expires ON public.lab_instances USING btree (expires_at);


--
-- Name: idx_lab_instances_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_lab_instances_status ON public.lab_instances USING btree (status);


--
-- Name: idx_lab_instances_topic; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_lab_instances_topic ON public.lab_instances USING btree (topic_id);


--
-- Name: idx_lab_instances_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_lab_instances_user ON public.lab_instances USING btree (user_id);


--
-- Name: idx_lab_submissions_grader; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_lab_submissions_grader ON public.lab_submissions USING btree (graded_by);


--
-- Name: idx_lab_submissions_instance; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_lab_submissions_instance ON public.lab_submissions USING btree (lab_instance_id);


--
-- Name: idx_lab_submissions_pending; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_lab_submissions_pending ON public.lab_submissions USING btree (status) WHERE (status = ANY (ARRAY['pending'::text, 'manual_review'::text]));


--
-- Name: idx_lab_submissions_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_lab_submissions_status ON public.lab_submissions USING btree (status);


--
-- Name: idx_lab_submissions_topic; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_lab_submissions_topic ON public.lab_submissions USING btree (topic_id);


--
-- Name: idx_lab_submissions_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_lab_submissions_user ON public.lab_submissions USING btree (user_id);


--
-- Name: idx_lab_templates_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_lab_templates_active ON public.lab_templates USING btree (is_active);


--
-- Name: idx_lab_templates_difficulty; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_lab_templates_difficulty ON public.lab_templates USING btree (difficulty_level);


--
-- Name: idx_lead_qualification_lead_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_lead_qualification_lead_id ON public.lead_qualification USING btree (lead_id);


--
-- Name: idx_lead_qualification_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_lead_qualification_status ON public.lead_qualification USING btree (qualification_status);


--
-- Name: idx_lead_scores_lead_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_lead_scores_lead_id ON public.lead_scores USING btree (lead_id);


--
-- Name: idx_lead_scores_score; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_lead_scores_score ON public.lead_scores USING btree (score);


--
-- Name: idx_lead_sourcing_credits_lead; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_lead_sourcing_credits_lead ON public.lead_sourcing_credits USING btree (lead_id);


--
-- Name: idx_lead_sourcing_credits_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_lead_sourcing_credits_org ON public.lead_sourcing_credits USING btree (org_id);


--
-- Name: idx_lead_sourcing_credits_sourced_by; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_lead_sourcing_credits_sourced_by ON public.lead_sourcing_credits USING btree (sourced_by);


--
-- Name: idx_lead_sourcing_credits_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_lead_sourcing_credits_status ON public.lead_sourcing_credits USING btree (status);


--
-- Name: idx_lead_sourcing_credits_target; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_lead_sourcing_credits_target ON public.lead_sourcing_credits USING btree (target_pillar);


--
-- Name: idx_lead_strategies_lead; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_lead_strategies_lead ON public.lead_strategies USING btree (lead_id);


--
-- Name: idx_lead_strategies_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_lead_strategies_org ON public.lead_strategies USING btree (org_id);


--
-- Name: idx_lead_tasks_completed; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_lead_tasks_completed ON public.lead_tasks USING btree (completed) WHERE (NOT completed);


--
-- Name: idx_lead_tasks_due_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_lead_tasks_due_date ON public.lead_tasks USING btree (due_date);


--
-- Name: idx_lead_tasks_lead_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_lead_tasks_lead_id ON public.lead_tasks USING btree (lead_id);


--
-- Name: idx_lead_tasks_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_lead_tasks_org_id ON public.lead_tasks USING btree (org_id);


--
-- Name: idx_lead_touchpoints_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_lead_touchpoints_date ON public.lead_touchpoints USING btree (touchpoint_date);


--
-- Name: idx_lead_touchpoints_lead_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_lead_touchpoints_lead_id ON public.lead_touchpoints USING btree (lead_id);


--
-- Name: idx_lead_touchpoints_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_lead_touchpoints_type ON public.lead_touchpoints USING btree (touchpoint_type);


--
-- Name: idx_leaderboard_entries_leaderboard_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_leaderboard_entries_leaderboard_id ON public.leaderboard_entries USING btree (leaderboard_id);


--
-- Name: idx_leaderboard_entries_rank; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_leaderboard_entries_rank ON public.leaderboard_entries USING btree (rank);


--
-- Name: idx_leaderboard_entries_user_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_leaderboard_entries_user_id ON public.leaderboard_entries USING btree (user_id);


--
-- Name: idx_leaderboard_entries_xp_earned; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_leaderboard_entries_xp_earned ON public.leaderboard_entries USING btree (xp_earned);


--
-- Name: idx_leaderboards_period; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_leaderboards_period ON public.leaderboards USING btree (period_start, period_end);


--
-- Name: idx_leaderboards_scope; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_leaderboards_scope ON public.leaderboards USING btree (scope);


--
-- Name: idx_leaderboards_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_leaderboards_type ON public.leaderboards USING btree (type);


--
-- Name: idx_leads_account_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_leads_account_id ON public.leads USING btree (account_id);


--
-- Name: idx_leads_bant_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_leads_bant_status ON public.leads USING btree (bant_total_score, status) WHERE (deleted_at IS NULL);


--
-- Name: idx_leads_bant_total; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_leads_bant_total ON public.leads USING btree (bant_total_score);


--
-- Name: idx_leads_campaign; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_leads_campaign ON public.leads USING btree (campaign_id);


--
-- Name: idx_leads_company_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_leads_company_id ON public.leads USING btree (company_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_leads_contact_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_leads_contact_id ON public.leads USING btree (contact_id) WHERE (contact_id IS NOT NULL);


--
-- Name: idx_leads_converted_to_company; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_leads_converted_to_company ON public.leads USING btree (converted_to_company_id) WHERE (converted_to_company_id IS NOT NULL);


--
-- Name: idx_leads_cross_pillar_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_leads_cross_pillar_type ON public.leads USING btree (cross_pillar_type) WHERE (cross_pillar_type IS NOT NULL);


--
-- Name: idx_leads_email; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_leads_email ON public.leads USING btree (email);


--
-- Name: idx_leads_interest_level; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_leads_interest_level ON public.leads USING btree (interest_level);


--
-- Name: idx_leads_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_leads_org ON public.leads USING btree (org_id) WHERE (deleted_at IS NULL);


--
-- Name: INDEX idx_leads_org; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON INDEX public.idx_leads_org IS 'Primary org isolation index for leads';


--
-- Name: idx_leads_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_leads_org_id ON public.leads USING btree (org_id);


--
-- Name: idx_leads_owner; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_leads_owner ON public.leads USING btree (owner_id);


--
-- Name: idx_leads_owner_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_leads_owner_id ON public.leads USING btree (owner_id);


--
-- Name: idx_leads_qualification_result; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_leads_qualification_result ON public.leads USING btree (qualification_result) WHERE (deleted_at IS NULL);


--
-- Name: idx_leads_source; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_leads_source ON public.leads USING btree (source_campaign_id);


--
-- Name: idx_leads_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_leads_status ON public.leads USING btree (status) WHERE (deleted_at IS NULL);


--
-- Name: idx_leads_urgency; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_leads_urgency ON public.leads USING btree (urgency);


--
-- Name: idx_learning_path_courses_course_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_learning_path_courses_course_id ON public.learning_path_courses USING btree (course_id);


--
-- Name: idx_learning_path_courses_path_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_learning_path_courses_path_id ON public.learning_path_courses USING btree (path_id);


--
-- Name: idx_learning_path_courses_sequence; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_learning_path_courses_sequence ON public.learning_path_courses USING btree (sequence);


--
-- Name: idx_learning_paths_deleted_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_learning_paths_deleted_at ON public.learning_paths USING btree (deleted_at) WHERE (deleted_at IS NULL);


--
-- Name: idx_learning_paths_difficulty; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_learning_paths_difficulty ON public.learning_paths USING btree (difficulty);


--
-- Name: idx_learning_paths_slug; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_learning_paths_slug ON public.learning_paths USING btree (slug);


--
-- Name: idx_learning_paths_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_learning_paths_status ON public.learning_paths USING btree (status);


--
-- Name: idx_learning_streaks_current_count; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_learning_streaks_current_count ON public.learning_streaks USING btree (current_count);


--
-- Name: idx_learning_streaks_last_activity_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_learning_streaks_last_activity_date ON public.learning_streaks USING btree (last_activity_date);


--
-- Name: idx_learning_streaks_streak_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_learning_streaks_streak_type ON public.learning_streaks USING btree (streak_type);


--
-- Name: idx_learning_streaks_user_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_learning_streaks_user_id ON public.learning_streaks USING btree (user_id);


--
-- Name: idx_level_definitions_xp_required; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_level_definitions_xp_required ON public.level_definitions USING btree (xp_required);


--
-- Name: idx_login_history_created; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_login_history_created ON public.login_history USING btree (created_at DESC);


--
-- Name: idx_login_history_email; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_login_history_email ON public.login_history USING btree (email);


--
-- Name: idx_login_history_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_login_history_org_id ON public.login_history USING btree (org_id);


--
-- Name: idx_login_history_success; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_login_history_success ON public.login_history USING btree (success);


--
-- Name: idx_login_history_user_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_login_history_user_id ON public.login_history USING btree (user_id);


--
-- Name: idx_marketing_formats_profile_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_marketing_formats_profile_id ON public.marketing_formats USING btree (profile_id);


--
-- Name: idx_marketing_profiles_consultant_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_marketing_profiles_consultant_id ON public.marketing_profiles USING btree (consultant_id);


--
-- Name: idx_marketing_templates_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_marketing_templates_org_id ON public.marketing_templates USING btree (org_id);


--
-- Name: idx_matches_candidate; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_matches_candidate ON public.resume_matches USING btree (candidate_id);


--
-- Name: idx_matches_created; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_matches_created ON public.resume_matches USING btree (org_id, created_at DESC);


--
-- Name: idx_matches_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_matches_org ON public.resume_matches USING btree (org_id);


--
-- Name: idx_matches_placement; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_matches_placement ON public.resume_matches USING btree (placement_achieved) WHERE (placement_achieved = true);


--
-- Name: idx_matches_relevant; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_matches_relevant ON public.resume_matches USING btree (is_relevant) WHERE (is_relevant IS NOT NULL);


--
-- Name: idx_matches_requisition; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_matches_requisition ON public.resume_matches USING btree (requisition_id, match_score DESC);


--
-- Name: idx_meeting_notes_account; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_meeting_notes_account ON public.meeting_notes USING btree (account_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_meeting_notes_created_by; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_meeting_notes_created_by ON public.meeting_notes USING btree (created_by);


--
-- Name: idx_meeting_notes_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_meeting_notes_org ON public.meeting_notes USING btree (org_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_meeting_notes_scheduled; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_meeting_notes_scheduled ON public.meeting_notes USING btree (scheduled_at);


--
-- Name: idx_meeting_notes_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_meeting_notes_status ON public.meeting_notes USING btree (status);


--
-- Name: idx_meeting_notes_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_meeting_notes_type ON public.meeting_notes USING btree (meeting_type);


--
-- Name: idx_mentor_chats_prompt_variant; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_mentor_chats_prompt_variant ON public.ai_mentor_chats USING btree (prompt_variant_id);


--
-- Name: idx_mentor_chats_question_hash; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_mentor_chats_question_hash ON public.ai_mentor_chats USING btree (question_hash);


--
-- Name: INDEX idx_mentor_chats_question_hash; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON INDEX public.idx_mentor_chats_question_hash IS 'Index for fast question pattern lookups - avoids computing MD5 on every row';


--
-- Name: idx_module_topics_module_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_module_topics_module_id ON public.module_topics USING btree (module_id);


--
-- Name: idx_module_topics_number; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_module_topics_number ON public.module_topics USING btree (module_id, topic_number);


--
-- Name: idx_module_topics_required; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_module_topics_required ON public.module_topics USING btree (is_required) WHERE (is_required = true);


--
-- Name: idx_notifications_created; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_notifications_created ON public.notifications USING btree (created_at DESC);


--
-- Name: idx_notifications_entity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_notifications_entity ON public.notifications USING btree (entity_type, entity_id);


--
-- Name: idx_notifications_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_notifications_org ON public.notifications USING btree (org_id);


--
-- Name: idx_notifications_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_notifications_type ON public.notifications USING btree (notification_type);


--
-- Name: idx_notifications_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_notifications_user ON public.notifications USING btree (user_id);


--
-- Name: idx_notifications_user_unread; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_notifications_user_unread ON public.notifications USING btree (user_id, is_read) WHERE ((NOT is_read) AND (NOT is_archived));


--
-- Name: idx_oauth_tokens_expires; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_oauth_tokens_expires ON public.integration_oauth_tokens USING btree (expires_at) WHERE ((status)::text = 'active'::text);


--
-- Name: idx_oauth_tokens_integration; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_oauth_tokens_integration ON public.integration_oauth_tokens USING btree (integration_id);


--
-- Name: idx_oauth_tokens_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_oauth_tokens_org ON public.integration_oauth_tokens USING btree (org_id);


--
-- Name: idx_oauth_tokens_unique_integration; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX idx_oauth_tokens_unique_integration ON public.integration_oauth_tokens USING btree (integration_id) WHERE ((status)::text = 'active'::text);


--
-- Name: idx_object_owners_entity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_object_owners_entity ON public.object_owners USING btree (entity_type, entity_id);


--
-- Name: idx_object_owners_is_primary; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_object_owners_is_primary ON public.object_owners USING btree (is_primary) WHERE (is_primary = true);


--
-- Name: idx_object_owners_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_object_owners_org ON public.object_owners USING btree (org_id);


--
-- Name: idx_object_owners_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_object_owners_org_id ON public.object_owners USING btree (org_id);


--
-- Name: idx_object_owners_permission; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_object_owners_permission ON public.object_owners USING btree (permission);


--
-- Name: idx_object_owners_primary; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_object_owners_primary ON public.object_owners USING btree (entity_type, entity_id) WHERE (is_primary = true);


--
-- Name: idx_object_owners_role; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_object_owners_role ON public.object_owners USING btree (role);


--
-- Name: idx_object_owners_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_object_owners_user ON public.object_owners USING btree (user_id);


--
-- Name: idx_object_owners_user_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_object_owners_user_id ON public.object_owners USING btree (user_id);


--
-- Name: idx_offer_approvals_approver_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_offer_approvals_approver_id ON public.offer_approvals USING btree (approver_id);


--
-- Name: idx_offer_approvals_offer_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_offer_approvals_offer_id ON public.offer_approvals USING btree (offer_id);


--
-- Name: idx_offer_negotiations_offer_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_offer_negotiations_offer_id ON public.offer_negotiations USING btree (offer_id);


--
-- Name: idx_offer_terms_offer_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_offer_terms_offer_id ON public.offer_terms USING btree (offer_id);


--
-- Name: idx_offers_bill_rate; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_offers_bill_rate ON public.offers USING btree (bill_rate);


--
-- Name: idx_offers_candidate; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_offers_candidate ON public.offers USING btree (candidate_id);


--
-- Name: idx_offers_employment_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_offers_employment_type ON public.offers USING btree (employment_type);


--
-- Name: idx_offers_expires; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_offers_expires ON public.offers USING btree (expires_at);


--
-- Name: idx_offers_job; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_offers_job ON public.offers USING btree (job_id);


--
-- Name: idx_offers_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_offers_org_id ON public.offers USING btree (org_id);


--
-- Name: idx_offers_pay_rate; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_offers_pay_rate ON public.offers USING btree (pay_rate);


--
-- Name: idx_offers_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_offers_status ON public.offers USING btree (status);


--
-- Name: idx_offers_submission; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_offers_submission ON public.offers USING btree (submission_id);


--
-- Name: idx_onboarding_checklist_completion; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_onboarding_checklist_completion ON public.onboarding_checklist USING btree (completion_percentage);


--
-- Name: idx_onboarding_checklist_incomplete; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_onboarding_checklist_incomplete ON public.onboarding_checklist USING btree (user_id) WHERE (completed_at IS NULL);


--
-- Name: idx_onboarding_checklist_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_onboarding_checklist_user ON public.onboarding_checklist USING btree (user_id);


--
-- Name: idx_onboarding_tasks_onboarding_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_onboarding_tasks_onboarding_id ON public.onboarding_tasks USING btree (onboarding_id);


--
-- Name: idx_onboarding_tasks_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_onboarding_tasks_status ON public.onboarding_tasks USING btree (status);


--
-- Name: idx_org_branding_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_org_branding_org ON public.organization_branding USING btree (org_id);


--
-- Name: idx_org_context_cache_lookup; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_org_context_cache_lookup ON public.org_context_cache USING btree (org_id, context_type, expires_at);


--
-- Name: idx_org_settings_category; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_org_settings_category ON public.organization_settings USING btree (org_id, category);


--
-- Name: idx_org_settings_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_org_settings_org ON public.organization_settings USING btree (org_id);


--
-- Name: idx_org_standups_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_org_standups_date ON public.org_standups USING btree (org_id, standup_date DESC);


--
-- Name: idx_organizations_deleted_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_organizations_deleted_at ON public.organizations USING btree (deleted_at) WHERE (deleted_at IS NULL);


--
-- Name: idx_organizations_email; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_organizations_email ON public.organizations USING btree (email) WHERE (deleted_at IS NULL);


--
-- Name: idx_organizations_industry; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_organizations_industry ON public.organizations USING btree (industry);


--
-- Name: idx_organizations_slug; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_organizations_slug ON public.organizations USING btree (slug);


--
-- Name: idx_organizations_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_organizations_status ON public.organizations USING btree (status);


--
-- Name: idx_organizations_stripe_customer; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_organizations_stripe_customer ON public.organizations USING btree (stripe_customer_id) WHERE (stripe_customer_id IS NOT NULL);


--
-- Name: idx_organizations_subscription_tier; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_organizations_subscription_tier ON public.organizations USING btree (subscription_tier);


--
-- Name: idx_organizations_timezone; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_organizations_timezone ON public.organizations USING btree (timezone);


--
-- Name: idx_path_enrollments_path_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_path_enrollments_path_id ON public.path_enrollments USING btree (path_id);


--
-- Name: idx_path_enrollments_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_path_enrollments_status ON public.path_enrollments USING btree (status);


--
-- Name: idx_path_enrollments_user_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_path_enrollments_user_id ON public.path_enrollments USING btree (user_id);


--
-- Name: idx_pattern_successors_pattern; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_pattern_successors_pattern ON public.activity_pattern_successors USING btree (pattern_id);


--
-- Name: idx_payment_transactions_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payment_transactions_created_at ON public.payment_transactions USING btree (created_at);


--
-- Name: idx_payment_transactions_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payment_transactions_status ON public.payment_transactions USING btree (status);


--
-- Name: idx_payment_transactions_stripe_pi; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payment_transactions_stripe_pi ON public.payment_transactions USING btree (stripe_payment_intent_id);


--
-- Name: idx_payment_transactions_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payment_transactions_user ON public.payment_transactions USING btree (user_id);


--
-- Name: idx_payroll_items_employee; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payroll_items_employee ON public.payroll_items USING btree (employee_id);


--
-- Name: idx_payroll_items_run; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payroll_items_run ON public.payroll_items USING btree (payroll_run_id);


--
-- Name: idx_payroll_runs_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payroll_runs_org ON public.payroll_runs USING btree (org_id);


--
-- Name: idx_payroll_runs_pay_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payroll_runs_pay_date ON public.payroll_runs USING btree (pay_date DESC);


--
-- Name: idx_payroll_runs_period; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payroll_runs_period ON public.payroll_runs USING btree (period_start_date, period_end_date);


--
-- Name: idx_payroll_runs_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payroll_runs_status ON public.payroll_runs USING btree (status);


--
-- Name: idx_peer_reviews_reviewer; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_peer_reviews_reviewer ON public.peer_reviews USING btree (reviewer_id);


--
-- Name: idx_peer_reviews_submission; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_peer_reviews_submission ON public.peer_reviews USING btree (submission_id);


--
-- Name: idx_performance_feedback_review_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_performance_feedback_review_id ON public.performance_feedback USING btree (review_id);


--
-- Name: idx_performance_feedback_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_performance_feedback_type ON public.performance_feedback USING btree (feedback_type);


--
-- Name: idx_performance_goals_employee_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_performance_goals_employee_id ON public.performance_goals USING btree (employee_id);


--
-- Name: idx_performance_goals_review_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_performance_goals_review_id ON public.performance_goals USING btree (review_id);


--
-- Name: idx_performance_goals_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_performance_goals_status ON public.performance_goals USING btree (status);


--
-- Name: idx_permission_overrides_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_permission_overrides_active ON public.permission_overrides USING btree (user_id, permission_id) WHERE (revoked_at IS NULL);


--
-- Name: idx_permission_overrides_expires; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_permission_overrides_expires ON public.permission_overrides USING btree (expires_at) WHERE (expires_at IS NOT NULL);


--
-- Name: idx_permission_overrides_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_permission_overrides_org ON public.permission_overrides USING btree (org_id);


--
-- Name: idx_permission_overrides_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_permission_overrides_user ON public.permission_overrides USING btree (user_id);


--
-- Name: idx_permissions_action; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_permissions_action ON public.permissions USING btree (action);


--
-- Name: idx_permissions_code; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_permissions_code ON public.permissions USING btree (code);


--
-- Name: idx_permissions_object_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_permissions_object_type ON public.permissions USING btree (object_type);


--
-- Name: idx_placement_checkins_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_placement_checkins_date ON public.placement_checkins USING btree (checkin_date);


--
-- Name: idx_placement_checkins_health; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_placement_checkins_health ON public.placement_checkins USING btree (overall_health);


--
-- Name: idx_placement_checkins_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_placement_checkins_org ON public.placement_checkins USING btree (org_id);


--
-- Name: idx_placement_checkins_placement; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_placement_checkins_placement ON public.placement_checkins USING btree (placement_id);


--
-- Name: idx_placement_checkins_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_placement_checkins_type ON public.placement_checkins USING btree (checkin_type);


--
-- Name: idx_placement_credits_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_placement_credits_date ON public.placement_credits USING btree (placement_date);


--
-- Name: idx_placement_credits_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_placement_credits_org ON public.placement_credits USING btree (org_id);


--
-- Name: idx_placement_credits_pod; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_placement_credits_pod ON public.placement_credits USING btree (pod_id);


--
-- Name: idx_placement_credits_source; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_placement_credits_source ON public.placement_credits USING btree (source_pillar);


--
-- Name: idx_placement_credits_sprint; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_placement_credits_sprint ON public.placement_credits USING btree (pod_id, sprint_number);


--
-- Name: idx_placement_extensions_placement_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_placement_extensions_placement_id ON public.placement_extensions USING btree (placement_id);


--
-- Name: idx_placement_milestones_due_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_placement_milestones_due_date ON public.placement_milestones USING btree (due_date);


--
-- Name: idx_placement_milestones_placement_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_placement_milestones_placement_id ON public.placement_milestones USING btree (placement_id);


--
-- Name: idx_placement_rates_placement_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_placement_rates_placement_id ON public.placement_rates USING btree (placement_id);


--
-- Name: idx_placement_timesheets_placement_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_placement_timesheets_placement_id ON public.placement_timesheets USING btree (placement_id);


--
-- Name: idx_placement_timesheets_week_ending; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_placement_timesheets_week_ending ON public.placement_timesheets USING btree (week_ending);


--
-- Name: idx_placements_account; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_placements_account ON public.placements USING btree (account_id);


--
-- Name: idx_placements_billing_company; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_placements_billing_company ON public.placements USING btree (billing_company_id) WHERE (billing_company_id IS NOT NULL);


--
-- Name: idx_placements_candidate; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_placements_candidate ON public.placements USING btree (candidate_id);


--
-- Name: idx_placements_company_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_placements_company_id ON public.placements USING btree (company_id);


--
-- Name: idx_placements_contact_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_placements_contact_id ON public.placements USING btree (contact_id) WHERE (contact_id IS NOT NULL);


--
-- Name: idx_placements_end_client; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_placements_end_client ON public.placements USING btree (end_client_company_id) WHERE (end_client_company_id IS NOT NULL);


--
-- Name: idx_placements_health_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_placements_health_status ON public.placements USING btree (health_status);


--
-- Name: idx_placements_job; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_placements_job ON public.placements USING btree (job_id);


--
-- Name: idx_placements_next_check_in; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_placements_next_check_in ON public.placements USING btree (next_check_in_date);


--
-- Name: idx_placements_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_placements_org ON public.placements USING btree (org_id);


--
-- Name: idx_placements_recruiter; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_placements_recruiter ON public.placements USING btree (recruiter_id);


--
-- Name: idx_placements_start_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_placements_start_date ON public.placements USING btree (start_date DESC);


--
-- Name: idx_placements_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_placements_status ON public.placements USING btree (status);


--
-- Name: idx_pod_managers_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_pod_managers_active ON public.pod_managers USING btree (pod_id) WHERE (removed_at IS NULL);


--
-- Name: idx_pod_managers_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_pod_managers_org ON public.pod_managers USING btree (org_id);


--
-- Name: idx_pod_managers_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_pod_managers_org_id ON public.pod_managers USING btree (org_id);


--
-- Name: idx_pod_managers_pod; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_pod_managers_pod ON public.pod_managers USING btree (pod_id);


--
-- Name: idx_pod_managers_pod_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_pod_managers_pod_id ON public.pod_managers USING btree (pod_id);


--
-- Name: idx_pod_managers_primary; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX idx_pod_managers_primary ON public.pod_managers USING btree (pod_id) WHERE ((is_primary = true) AND (removed_at IS NULL));


--
-- Name: idx_pod_managers_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_pod_managers_user ON public.pod_managers USING btree (user_id);


--
-- Name: idx_pod_managers_user_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_pod_managers_user_id ON public.pod_managers USING btree (user_id);


--
-- Name: idx_pod_members_is_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_pod_members_is_active ON public.pod_members USING btree (is_active);


--
-- Name: idx_pod_members_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_pod_members_org_id ON public.pod_members USING btree (org_id);


--
-- Name: idx_pod_members_pod_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_pod_members_pod_id ON public.pod_members USING btree (pod_id);


--
-- Name: idx_pod_members_user_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_pod_members_user_id ON public.pod_members USING btree (user_id);


--
-- Name: idx_pod_sprint_metrics_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_pod_sprint_metrics_active ON public.pod_sprint_metrics USING btree (pod_id) WHERE (status = 'active'::text);


--
-- Name: idx_pod_sprint_metrics_dates; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_pod_sprint_metrics_dates ON public.pod_sprint_metrics USING btree (sprint_start_date, sprint_end_date);


--
-- Name: idx_pod_sprint_metrics_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_pod_sprint_metrics_org_id ON public.pod_sprint_metrics USING btree (org_id);


--
-- Name: idx_pod_sprint_metrics_pod_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_pod_sprint_metrics_pod_id ON public.pod_sprint_metrics USING btree (pod_id);


--
-- Name: idx_pods_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_pods_active ON public.pods USING btree (is_active) WHERE (is_active = true);


--
-- Name: idx_pods_manager_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_pods_manager_id ON public.pods USING btree (manager_id);


--
-- Name: idx_pods_members; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_pods_members ON public.pods USING btree (senior_member_id, junior_member_id);


--
-- Name: idx_pods_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_pods_org ON public.pods USING btree (org_id);


--
-- Name: idx_pods_region_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_pods_region_id ON public.pods USING btree (region_id);


--
-- Name: idx_pods_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_pods_type ON public.pods USING btree (pod_type);


--
-- Name: idx_pricing_plans_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_pricing_plans_active ON public.pricing_plans USING btree (is_active) WHERE (deleted_at IS NULL);


--
-- Name: idx_pricing_plans_plan_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_pricing_plans_plan_type ON public.pricing_plans USING btree (plan_type) WHERE (deleted_at IS NULL);


--
-- Name: idx_pricing_plans_slug; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_pricing_plans_slug ON public.pricing_plans USING btree (slug) WHERE (deleted_at IS NULL);


--
-- Name: idx_productivity_reports_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_productivity_reports_date ON public.productivity_reports USING btree (date DESC);


--
-- Name: idx_productivity_reports_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_productivity_reports_user ON public.productivity_reports USING btree (user_id);


--
-- Name: idx_productivity_reports_user_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_productivity_reports_user_date ON public.productivity_reports USING btree (user_id, date DESC);


--
-- Name: idx_project_timeline_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_project_timeline_org_id ON public.project_timeline USING btree (org_id);


--
-- Name: idx_pto_balances_employee; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_pto_balances_employee ON public.pto_balances USING btree (employee_id);


--
-- Name: idx_pto_balances_year; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_pto_balances_year ON public.pto_balances USING btree (year);


--
-- Name: idx_question_patterns_hash; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_question_patterns_hash ON public.ai_question_patterns USING btree (pattern_hash);


--
-- Name: idx_question_patterns_occurrence; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_question_patterns_occurrence ON public.ai_question_patterns USING btree (occurrence_count DESC);


--
-- Name: idx_question_patterns_topic; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_question_patterns_topic ON public.ai_question_patterns USING btree (topic_id);


--
-- Name: idx_quiz_attempts_enrollment; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_quiz_attempts_enrollment ON public.quiz_attempts USING btree (enrollment_id);


--
-- Name: idx_quiz_attempts_submitted; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_quiz_attempts_submitted ON public.quiz_attempts USING btree (submitted_at) WHERE (submitted_at IS NOT NULL);


--
-- Name: idx_quiz_attempts_topic; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_quiz_attempts_topic ON public.quiz_attempts USING btree (topic_id);


--
-- Name: idx_quiz_attempts_unique; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX idx_quiz_attempts_unique ON public.quiz_attempts USING btree (user_id, topic_id, attempt_number);


--
-- Name: idx_quiz_attempts_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_quiz_attempts_user ON public.quiz_attempts USING btree (user_id);


--
-- Name: idx_quiz_questions_created_by; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_quiz_questions_created_by ON public.quiz_questions USING btree (created_by);


--
-- Name: idx_quiz_questions_difficulty; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_quiz_questions_difficulty ON public.quiz_questions USING btree (difficulty);


--
-- Name: idx_quiz_questions_public; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_quiz_questions_public ON public.quiz_questions USING btree (is_public) WHERE (is_public = true);


--
-- Name: idx_quiz_questions_text_search; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_quiz_questions_text_search ON public.quiz_questions USING gin (to_tsvector('english'::regconfig, question_text));


--
-- Name: idx_quiz_questions_topic; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_quiz_questions_topic ON public.quiz_questions USING btree (topic_id);


--
-- Name: idx_quiz_questions_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_quiz_questions_type ON public.quiz_questions USING btree (question_type);


--
-- Name: idx_quiz_settings_topic; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_quiz_settings_topic ON public.quiz_settings USING btree (topic_id);


--
-- Name: idx_raci_change_log_changed_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_raci_change_log_changed_at ON public.raci_change_log USING btree (changed_at);


--
-- Name: idx_raci_change_log_entity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_raci_change_log_entity ON public.raci_change_log USING btree (entity_type, entity_id);


--
-- Name: idx_rate_card_items_card; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_rate_card_items_card ON public.company_rate_card_items USING btree (rate_card_id);


--
-- Name: idx_rate_cards_company; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_rate_cards_company ON public.company_rate_cards USING btree (company_id, status) WHERE (deleted_at IS NULL);


--
-- Name: idx_reading_progress_enrollment; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_reading_progress_enrollment ON public.reading_progress USING btree (enrollment_id);


--
-- Name: idx_reading_progress_topic; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_reading_progress_topic ON public.reading_progress USING btree (topic_id);


--
-- Name: idx_reading_progress_updated; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_reading_progress_updated ON public.reading_progress USING btree (updated_at DESC);


--
-- Name: idx_reading_progress_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_reading_progress_user ON public.reading_progress USING btree (user_id);


--
-- Name: idx_references_candidate; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_references_candidate ON public.candidate_references USING btree (candidate_id);


--
-- Name: idx_references_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_references_org ON public.candidate_references USING btree (org_id);


--
-- Name: idx_regions_is_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_regions_is_active ON public.regions USING btree (is_active);


--
-- Name: idx_regions_manager_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_regions_manager_id ON public.regions USING btree (manager_id);


--
-- Name: idx_regions_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_regions_org_id ON public.regions USING btree (org_id);


--
-- Name: idx_requisition_embeddings_experience; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_requisition_embeddings_experience ON public.requisition_embeddings USING btree (experience_level);


--
-- Name: idx_requisition_embeddings_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_requisition_embeddings_org ON public.requisition_embeddings USING btree (org_id);


--
-- Name: idx_requisition_embeddings_skills; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_requisition_embeddings_skills ON public.requisition_embeddings USING gin (required_skills);


--
-- Name: idx_requisition_embeddings_vector; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_requisition_embeddings_vector ON public.requisition_embeddings USING ivfflat (embedding public.vector_cosine_ops) WITH (lists='100');


--
-- Name: idx_resume_versions_ats_score; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_resume_versions_ats_score ON public.resume_versions USING btree (ats_score DESC);


--
-- Name: idx_resume_versions_format; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_resume_versions_format ON public.resume_versions USING btree (format);


--
-- Name: idx_resume_versions_student; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_resume_versions_student ON public.resume_versions USING btree (student_id, created_at DESC);


--
-- Name: idx_resumes_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_resumes_org ON public.generated_resumes USING btree (org_id);


--
-- Name: idx_resumes_placement; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_resumes_placement ON public.generated_resumes USING btree (placement_achieved) WHERE (placement_achieved = true);


--
-- Name: idx_resumes_quality; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_resumes_quality ON public.generated_resumes USING btree (quality_score) WHERE (quality_score IS NOT NULL);


--
-- Name: idx_resumes_role; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_resumes_role ON public.generated_resumes USING btree (target_role);


--
-- Name: idx_resumes_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_resumes_user ON public.generated_resumes USING btree (user_id, created_at DESC);


--
-- Name: idx_retention_policies_entity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_retention_policies_entity ON public.retention_policies USING btree (entity_type);


--
-- Name: idx_retention_policies_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_retention_policies_org ON public.retention_policies USING btree (org_id);


--
-- Name: idx_revenue_analytics_month; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX idx_revenue_analytics_month ON public.revenue_analytics USING btree (month);


--
-- Name: idx_revenue_analytics_month_desc; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_revenue_analytics_month_desc ON public.revenue_analytics USING btree (month DESC);


--
-- Name: idx_reviews_cycle; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_reviews_cycle ON public.performance_reviews USING btree (review_cycle);


--
-- Name: idx_reviews_employee; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_reviews_employee ON public.performance_reviews USING btree (employee_id);


--
-- Name: idx_reviews_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_reviews_org ON public.performance_reviews USING btree (org_id);


--
-- Name: idx_reviews_reviewer; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_reviews_reviewer ON public.performance_reviews USING btree (reviewer_id);


--
-- Name: idx_reviews_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_reviews_status ON public.performance_reviews USING btree (status);


--
-- Name: idx_role_permissions_permission_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_role_permissions_permission_id ON public.role_permissions USING btree (permission_id);


--
-- Name: idx_role_permissions_role_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_role_permissions_role_id ON public.role_permissions USING btree (role_id);


--
-- Name: idx_roles_name; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_roles_name ON public.roles USING btree (name) WHERE (deleted_at IS NULL);


--
-- Name: idx_roles_parent; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_roles_parent ON public.roles USING btree (parent_role_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_roles_system; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_roles_system ON public.roles USING btree (is_system_role) WHERE (is_system_role = true);


--
-- Name: idx_saved_searches_default; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_saved_searches_default ON public.saved_searches USING btree (user_id, entity_type, is_default) WHERE ((is_default = true) AND (deleted_at IS NULL));


--
-- Name: idx_saved_searches_entity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_saved_searches_entity ON public.saved_searches USING btree (entity_type) WHERE (deleted_at IS NULL);


--
-- Name: idx_saved_searches_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_saved_searches_org ON public.saved_searches USING btree (org_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_saved_searches_shared; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_saved_searches_shared ON public.saved_searches USING btree (org_id, entity_type, is_shared) WHERE ((is_shared = true) AND (deleted_at IS NULL));


--
-- Name: idx_saved_searches_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_saved_searches_user ON public.saved_searches USING btree (user_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_screenshots_analyzed; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_screenshots_analyzed ON public.employee_screenshots USING btree (analyzed) WHERE ((NOT analyzed) AND (deleted_at IS NULL));


--
-- Name: idx_screenshots_captured_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_screenshots_captured_at ON public.employee_screenshots USING btree (captured_at DESC) WHERE (deleted_at IS NULL);


--
-- Name: idx_screenshots_category; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_screenshots_category ON public.employee_screenshots USING btree (activity_category) WHERE (analyzed = true);


--
-- Name: idx_screenshots_machine; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_screenshots_machine ON public.employee_screenshots USING btree (machine_name);


--
-- Name: idx_screenshots_user_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_screenshots_user_date ON public.employee_screenshots USING btree (user_id, captured_at DESC) WHERE (deleted_at IS NULL);


--
-- Name: idx_screenshots_user_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_screenshots_user_id ON public.employee_screenshots USING btree (user_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_security_alerts_created; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_security_alerts_created ON public.security_alerts USING btree (created_at DESC);


--
-- Name: idx_security_alerts_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_security_alerts_org ON public.security_alerts USING btree (org_id);


--
-- Name: idx_security_alerts_severity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_security_alerts_severity ON public.security_alerts USING btree (severity);


--
-- Name: idx_security_alerts_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_security_alerts_status ON public.security_alerts USING btree (status);


--
-- Name: idx_security_alerts_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_security_alerts_user ON public.security_alerts USING btree (related_user_id);


--
-- Name: idx_sequence_templates_channel; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_sequence_templates_channel ON public.sequence_templates USING btree (channel);


--
-- Name: idx_sequence_templates_created_by; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_sequence_templates_created_by ON public.sequence_templates USING btree (created_by);


--
-- Name: idx_sequence_templates_is_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_sequence_templates_is_active ON public.sequence_templates USING btree (is_active) WHERE (deleted_at IS NULL);


--
-- Name: idx_sequence_templates_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_sequence_templates_org_id ON public.sequence_templates USING btree (org_id);


--
-- Name: idx_session_branch; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_session_branch ON public.session_metadata USING btree (branch);


--
-- Name: idx_session_context_role; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_session_context_role ON public.user_session_context USING btree (active_role);


--
-- Name: idx_session_context_started; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_session_context_started ON public.user_session_context USING btree (session_started_at DESC);


--
-- Name: idx_session_context_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_session_context_user ON public.user_session_context USING btree (user_id);


--
-- Name: idx_session_environment; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_session_environment ON public.session_metadata USING btree (environment);


--
-- Name: idx_session_metadata_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_session_metadata_org_id ON public.session_metadata USING btree (org_id);


--
-- Name: idx_session_started_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_session_started_at ON public.session_metadata USING btree (started_at DESC);


--
-- Name: idx_skill_aliases_skill_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_skill_aliases_skill_id ON public.skill_aliases USING btree (skill_id);


--
-- Name: idx_skills_category; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_skills_category ON public.skills USING btree (category);


--
-- Name: idx_skills_name_lower; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_skills_name_lower ON public.skills USING btree (lower(name));


--
-- Name: idx_skills_parent; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_skills_parent ON public.skills USING btree (parent_skill_id);


--
-- Name: idx_sla_definitions_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_sla_definitions_status ON public.sla_definitions USING btree (org_id, status);


--
-- Name: idx_sla_escalation_levels_definition; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_sla_escalation_levels_definition ON public.sla_escalation_levels USING btree (sla_definition_id);


--
-- Name: idx_sla_events_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_sla_events_active ON public.sla_events USING btree (org_id, status) WHERE (status = ANY (ARRAY['pending'::text, 'warning'::text, 'breach'::text]));


--
-- Name: idx_sla_events_deadline; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_sla_events_deadline ON public.sla_events USING btree (target_deadline) WHERE (status = 'pending'::text);


--
-- Name: idx_sla_events_entity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_sla_events_entity ON public.sla_events USING btree (entity_type, entity_id);


--
-- Name: idx_sla_events_org_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_sla_events_org_status ON public.sla_events USING btree (org_id, status);


--
-- Name: idx_sla_notifications_event_level; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_sla_notifications_event_level ON public.sla_notifications USING btree (sla_event_id, escalation_level, notification_type);


--
-- Name: idx_student_enrollments_at_risk; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_student_enrollments_at_risk ON public.student_enrollments USING btree (is_at_risk, risk_level) WHERE (is_at_risk = true);


--
-- Name: idx_student_enrollments_enrolled_month; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_student_enrollments_enrolled_month ON public.student_enrollments USING btree (course_id, enrolled_at);


--
-- Name: idx_student_interventions_created; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_student_interventions_created ON public.student_interventions USING btree (created_at DESC) WHERE (deleted_at IS NULL);


--
-- Name: idx_student_interventions_enrollment; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_student_interventions_enrollment ON public.student_interventions USING btree (enrollment_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_student_interventions_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_student_interventions_status ON public.student_interventions USING btree (status) WHERE (deleted_at IS NULL);


--
-- Name: idx_student_interventions_student; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_student_interventions_student ON public.student_interventions USING btree (student_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_student_interventions_trainer; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_student_interventions_trainer ON public.student_interventions USING btree (assigned_trainer_id) WHERE ((deleted_at IS NULL) AND (status = ANY (ARRAY['pending'::text, 'in_progress'::text])));


--
-- Name: idx_student_ltv_analytics_revenue; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_student_ltv_analytics_revenue ON public.student_ltv_analytics USING btree (lifetime_revenue DESC);


--
-- Name: idx_student_ltv_analytics_student; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX idx_student_ltv_analytics_student ON public.student_ltv_analytics USING btree (student_id);


--
-- Name: idx_student_progress_mastery; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_student_progress_mastery ON public.student_progress USING btree (mastery_score DESC);


--
-- Name: idx_student_progress_module; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_student_progress_module ON public.student_progress USING btree (current_module);


--
-- Name: idx_student_progress_student; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_student_progress_student ON public.student_progress USING btree (student_id);


--
-- Name: idx_submission_notes_submission_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_submission_notes_submission_id ON public.submission_notes USING btree (submission_id);


--
-- Name: idx_submission_screening_answers_submission_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_submission_screening_answers_submission_id ON public.submission_screening_answers USING btree (submission_id);


--
-- Name: idx_submission_status_history_submission_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_submission_status_history_submission_id ON public.submission_status_history USING btree (submission_id);


--
-- Name: idx_submissions_account; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_submissions_account ON public.submissions USING btree (account_id);


--
-- Name: idx_submissions_candidate; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_submissions_candidate ON public.submissions USING btree (candidate_id);


--
-- Name: idx_submissions_client_decision; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_submissions_client_decision ON public.submissions USING btree (client_decision) WHERE (client_decision IS NOT NULL);


--
-- Name: idx_submissions_company_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_submissions_company_id ON public.submissions USING btree (company_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_submissions_contact_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_submissions_contact_id ON public.submissions USING btree (contact_id) WHERE (contact_id IS NOT NULL);


--
-- Name: idx_submissions_created; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_submissions_created ON public.submissions USING btree (created_at DESC);


--
-- Name: idx_submissions_job; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_submissions_job ON public.submissions USING btree (job_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_submissions_offer_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_submissions_offer_id ON public.submissions USING btree (offer_id);


--
-- Name: idx_submissions_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_submissions_org ON public.submissions USING btree (org_id);


--
-- Name: idx_submissions_owner; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_submissions_owner ON public.submissions USING btree (owner_id);


--
-- Name: idx_submissions_placement_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_submissions_placement_id ON public.submissions USING btree (placement_id);


--
-- Name: idx_submissions_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_submissions_status ON public.submissions USING btree (status) WHERE (deleted_at IS NULL);


--
-- Name: idx_submissions_unique; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX idx_submissions_unique ON public.submissions USING btree (job_id, candidate_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_submissions_vendor_decision; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_submissions_vendor_decision ON public.submissions USING btree (vendor_decision) WHERE (vendor_decision IS NOT NULL);


--
-- Name: idx_system_roles_category; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_system_roles_category ON public.system_roles USING btree (category);


--
-- Name: idx_system_roles_code; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_system_roles_code ON public.system_roles USING btree (code);


--
-- Name: idx_system_roles_pod_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_system_roles_pod_type ON public.system_roles USING btree (pod_type);


--
-- Name: idx_system_settings_category; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_system_settings_category ON public.system_settings USING btree (category);


--
-- Name: idx_talking_point_templates_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_talking_point_templates_org ON public.talking_point_templates USING btree (org_id);


--
-- Name: idx_tasks_assigned; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_tasks_assigned ON public.tasks USING btree (assigned_to, status) WHERE (status = ANY (ARRAY['todo'::text, 'in_progress'::text]));


--
-- Name: idx_tasks_assignee; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_tasks_assignee ON public.tasks USING btree (assigned_to);


--
-- Name: idx_tasks_created_by; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_tasks_created_by ON public.tasks USING btree (created_by);


--
-- Name: idx_tasks_due; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_tasks_due ON public.tasks USING btree (due_date) WHERE (status = ANY (ARRAY['todo'::text, 'in_progress'::text]));


--
-- Name: idx_tasks_entity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_tasks_entity ON public.tasks USING btree (entity_type, entity_id);


--
-- Name: idx_tasks_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_tasks_org ON public.tasks USING btree (org_id);


--
-- Name: idx_tasks_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_tasks_status ON public.tasks USING btree (status);


--
-- Name: idx_time_attendance_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_time_attendance_date ON public.time_attendance USING btree (date DESC);


--
-- Name: idx_time_attendance_employee; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_time_attendance_employee ON public.time_attendance USING btree (employee_id);


--
-- Name: idx_time_attendance_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_time_attendance_status ON public.time_attendance USING btree (status);


--
-- Name: idx_timeline_agent_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_timeline_agent_type ON public.project_timeline USING btree (agent_type);


--
-- Name: idx_timeline_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_timeline_created_at ON public.project_timeline USING btree (created_at DESC);


--
-- Name: idx_timeline_not_archived; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_timeline_not_archived ON public.project_timeline USING btree (is_archived) WHERE (is_archived = false);


--
-- Name: idx_timeline_search; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_timeline_search ON public.project_timeline USING gin (search_vector);


--
-- Name: idx_timeline_session_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_timeline_session_date ON public.project_timeline USING btree (session_date DESC);


--
-- Name: idx_timeline_session_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_timeline_session_id ON public.project_timeline USING btree (session_id);


--
-- Name: idx_timeline_tags; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_timeline_tags ON public.project_timeline USING gin (tags);


--
-- Name: idx_topic_completions_completed_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_topic_completions_completed_at ON public.topic_completions USING btree (completed_at DESC);


--
-- Name: idx_topic_completions_course; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_topic_completions_course ON public.topic_completions USING btree (course_id);


--
-- Name: idx_topic_completions_enrollment; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_topic_completions_enrollment ON public.topic_completions USING btree (enrollment_id);


--
-- Name: idx_topic_completions_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_topic_completions_user ON public.topic_completions USING btree (user_id);


--
-- Name: idx_topic_lessons_topic_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_topic_lessons_topic_id ON public.topic_lessons USING btree (topic_id);


--
-- Name: idx_topic_lessons_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_topic_lessons_type ON public.topic_lessons USING btree (content_type);


--
-- Name: idx_trainer_responses_escalation_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_trainer_responses_escalation_id ON public.trainer_responses USING btree (escalation_id);


--
-- Name: idx_trainer_responses_trainer_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_trainer_responses_trainer_id ON public.trainer_responses USING btree (trainer_id);


--
-- Name: idx_twin_conversations_initiator; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_twin_conversations_initiator ON public.twin_conversations USING btree (initiator_role, created_at DESC);


--
-- Name: idx_twin_conversations_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_twin_conversations_org ON public.twin_conversations USING btree (org_id, created_at DESC);


--
-- Name: idx_twin_conversations_responder; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_twin_conversations_responder ON public.twin_conversations USING btree (responder_role, created_at DESC);


--
-- Name: idx_twin_events_org_role; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_twin_events_org_role ON public.twin_events USING btree (org_id, target_role, processed);


--
-- Name: idx_twin_events_source; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_twin_events_source ON public.twin_events USING btree (source_user_id, created_at DESC);


--
-- Name: idx_twin_events_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_twin_events_type ON public.twin_events USING btree (event_type, created_at DESC);


--
-- Name: idx_twin_events_unprocessed; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_twin_events_unprocessed ON public.twin_events USING btree (org_id, processed, priority DESC, created_at) WHERE (processed = false);


--
-- Name: idx_twin_preferences_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_twin_preferences_user ON public.twin_preferences USING btree (user_id);


--
-- Name: idx_user_achievements_achievement_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_achievements_achievement_id ON public.user_achievements USING btree (achievement_id);


--
-- Name: idx_user_achievements_unlocked_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_achievements_unlocked_at ON public.user_achievements USING btree (unlocked_at);


--
-- Name: idx_user_achievements_user_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_achievements_user_id ON public.user_achievements USING btree (user_id);


--
-- Name: idx_user_badges_badge; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_badges_badge ON public.user_badges USING btree (badge_id);


--
-- Name: idx_user_badges_earned; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_badges_earned ON public.user_badges USING btree (earned_at DESC);


--
-- Name: idx_user_badges_new; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_badges_new ON public.user_badges USING btree (user_id, is_new) WHERE (is_new = true);


--
-- Name: idx_user_badges_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_badges_user ON public.user_badges USING btree (user_id);


--
-- Name: idx_user_invitations_email; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_invitations_email ON public.user_invitations USING btree (email);


--
-- Name: idx_user_invitations_expires; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_invitations_expires ON public.user_invitations USING btree (expires_at);


--
-- Name: idx_user_invitations_invited_by; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_invitations_invited_by ON public.user_invitations USING btree (invited_by);


--
-- Name: idx_user_invitations_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_invitations_org ON public.user_invitations USING btree (org_id);


--
-- Name: idx_user_invitations_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_invitations_status ON public.user_invitations USING btree (accepted_at, cancelled_at);


--
-- Name: idx_user_invitations_token; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_invitations_token ON public.user_invitations USING btree (token);


--
-- Name: idx_user_levels_current_level; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_levels_current_level ON public.user_levels USING btree (current_level);


--
-- Name: idx_user_levels_current_xp; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_levels_current_xp ON public.user_levels USING btree (current_xp);


--
-- Name: idx_user_profiles_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_profiles_active ON public.user_profiles USING btree (is_active) WHERE (deleted_at IS NULL);


--
-- Name: idx_user_profiles_auth; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_profiles_auth ON public.user_profiles USING btree (auth_id);


--
-- Name: idx_user_profiles_auth_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_profiles_auth_id ON public.user_profiles USING btree (auth_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_user_profiles_auth_lookup; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_profiles_auth_lookup ON public.user_profiles USING btree (auth_id, org_id, email) WHERE ((deleted_at IS NULL) AND (is_active = true));


--
-- Name: idx_user_profiles_candidate_skills; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_profiles_candidate_skills ON public.user_profiles USING gin (candidate_skills) WHERE ((candidate_skills IS NOT NULL) AND (deleted_at IS NULL));


--
-- Name: idx_user_profiles_candidate_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_profiles_candidate_status ON public.user_profiles USING btree (candidate_status) WHERE ((candidate_status IS NOT NULL) AND (deleted_at IS NULL));


--
-- Name: idx_user_profiles_client_tier; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_profiles_client_tier ON public.user_profiles USING btree (client_tier) WHERE ((client_tier IS NOT NULL) AND (deleted_at IS NULL));


--
-- Name: idx_user_profiles_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_profiles_created_at ON public.user_profiles USING btree (created_at DESC);


--
-- Name: idx_user_profiles_email; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_profiles_email ON public.user_profiles USING btree (email) WHERE (deleted_at IS NULL);


--
-- Name: idx_user_profiles_employee_department; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_profiles_employee_department ON public.user_profiles USING btree (employee_department) WHERE ((employee_department IS NOT NULL) AND (deleted_at IS NULL));


--
-- Name: idx_user_profiles_employee_role; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_profiles_employee_role ON public.user_profiles USING btree (employee_role) WHERE (deleted_at IS NULL);


--
-- Name: idx_user_profiles_last_login; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_profiles_last_login ON public.user_profiles USING btree (last_login_at DESC);


--
-- Name: idx_user_profiles_leaderboard_visible; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_profiles_leaderboard_visible ON public.user_profiles USING btree (leaderboard_visible) WHERE (leaderboard_visible = true);


--
-- Name: idx_user_profiles_manager; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_profiles_manager ON public.user_profiles USING btree (manager_id);


--
-- Name: idx_user_profiles_not_deleted; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_profiles_not_deleted ON public.user_profiles USING btree (id) WHERE (deleted_at IS NULL);


--
-- Name: idx_user_profiles_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_profiles_org ON public.user_profiles USING btree (org_id);


--
-- Name: INDEX idx_user_profiles_org; Type: COMMENT; Schema: public; Owner: -
--

COMMENT ON INDEX public.idx_user_profiles_org IS 'Primary org isolation index';


--
-- Name: idx_user_profiles_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_profiles_org_id ON public.user_profiles USING btree (org_id);


--
-- Name: idx_user_profiles_org_id_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_profiles_org_id_active ON public.user_profiles USING btree (org_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_user_profiles_role; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_profiles_role ON public.user_profiles USING btree (role_id);


--
-- Name: idx_user_profiles_search; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_profiles_search ON public.user_profiles USING gin (search_vector);


--
-- Name: idx_user_profiles_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_profiles_status ON public.user_profiles USING btree (status);


--
-- Name: idx_user_profiles_stripe_customer; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_profiles_stripe_customer ON public.user_profiles USING btree (stripe_customer_id) WHERE (stripe_customer_id IS NOT NULL);


--
-- Name: idx_user_profiles_updated_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_profiles_updated_at ON public.user_profiles USING btree (updated_at DESC);


--
-- Name: idx_user_roles_expires; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_roles_expires ON public.user_roles USING btree (expires_at) WHERE (expires_at IS NOT NULL);


--
-- Name: idx_user_roles_primary; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_roles_primary ON public.user_roles USING btree (user_id, is_primary) WHERE (is_primary = true);


--
-- Name: idx_user_roles_role; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_roles_role ON public.user_roles USING btree (role_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_user_roles_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_roles_user ON public.user_roles USING btree (user_id) WHERE (deleted_at IS NULL);


--
-- Name: idx_user_xp_totals_rank; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_user_xp_totals_rank ON public.user_xp_totals USING btree (leaderboard_rank);


--
-- Name: idx_user_xp_totals_user; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX idx_user_xp_totals_user ON public.user_xp_totals USING btree (user_id);


--
-- Name: idx_vendor_blacklist_vendor_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_vendor_blacklist_vendor_id ON public.vendor_blacklist USING btree (vendor_id);


--
-- Name: idx_vendor_performance_vendor_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_vendor_performance_vendor_id ON public.vendor_performance USING btree (vendor_id);


--
-- Name: idx_vendor_relationships_related_entity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_vendor_relationships_related_entity ON public.vendor_relationships USING btree (related_entity_type, related_entity_id);


--
-- Name: idx_vendor_relationships_vendor_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_vendor_relationships_vendor_id ON public.vendor_relationships USING btree (vendor_id);


--
-- Name: idx_vendor_terms_vendor_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_vendor_terms_vendor_id ON public.vendor_terms USING btree (vendor_id);


--
-- Name: idx_vendors_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_vendors_org ON public.vendors USING btree (org_id);


--
-- Name: idx_vendors_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_vendors_org_id ON public.vendors USING btree (org_id);


--
-- Name: idx_vendors_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_vendors_status ON public.vendors USING btree (status);


--
-- Name: idx_vendors_tier; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_vendors_tier ON public.vendors USING btree (tier);


--
-- Name: idx_video_progress_enrollment; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_video_progress_enrollment ON public.video_progress USING btree (enrollment_id);


--
-- Name: idx_video_progress_topic; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_video_progress_topic ON public.video_progress USING btree (topic_id);


--
-- Name: idx_video_progress_updated; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_video_progress_updated ON public.video_progress USING btree (updated_at DESC);


--
-- Name: idx_video_progress_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_video_progress_user ON public.video_progress USING btree (user_id);


--
-- Name: idx_webhook_deliveries_created; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_webhook_deliveries_created ON public.webhook_deliveries USING btree (created_at DESC);


--
-- Name: idx_webhook_deliveries_dlq; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_webhook_deliveries_dlq ON public.webhook_deliveries USING btree (org_id, status) WHERE ((status)::text = 'dlq'::text);


--
-- Name: idx_webhook_deliveries_next_retry; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_webhook_deliveries_next_retry ON public.webhook_deliveries USING btree (next_retry_at) WHERE (((status)::text = 'retrying'::text) AND (next_retry_at IS NOT NULL));


--
-- Name: idx_webhook_deliveries_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_webhook_deliveries_org ON public.webhook_deliveries USING btree (org_id);


--
-- Name: idx_webhook_deliveries_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_webhook_deliveries_status ON public.webhook_deliveries USING btree (status);


--
-- Name: idx_webhook_deliveries_webhook; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_webhook_deliveries_webhook ON public.webhook_deliveries USING btree (webhook_id);


--
-- Name: idx_webhooks_events; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_webhooks_events ON public.webhooks USING gin (events);


--
-- Name: idx_webhooks_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_webhooks_org_id ON public.webhooks USING btree (org_id);


--
-- Name: idx_webhooks_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_webhooks_status ON public.webhooks USING btree (status);


--
-- Name: idx_work_auth_candidate; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_work_auth_candidate ON public.candidate_work_authorizations USING btree (candidate_id);


--
-- Name: idx_work_auth_country; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_work_auth_country ON public.candidate_work_authorizations USING btree (country_code);


--
-- Name: idx_work_auth_expiry; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_work_auth_expiry ON public.candidate_work_authorizations USING btree (expiry_date);


--
-- Name: idx_work_auth_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_work_auth_org ON public.candidate_work_authorizations USING btree (org_id);


--
-- Name: idx_work_auth_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_work_auth_status ON public.candidate_work_authorizations USING btree (status);


--
-- Name: idx_work_history_candidate; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_work_history_candidate ON public.candidate_work_history USING btree (candidate_id);


--
-- Name: idx_work_history_org; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_work_history_org ON public.candidate_work_history USING btree (org_id);


--
-- Name: idx_workflow_history_created_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_workflow_history_created_at ON public.workflow_history USING btree (created_at DESC);


--
-- Name: idx_workflow_history_instance_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_workflow_history_instance_id ON public.workflow_history USING btree (workflow_instance_id);


--
-- Name: idx_workflow_history_performed_by; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_workflow_history_performed_by ON public.workflow_history USING btree (performed_by);


--
-- Name: idx_workflow_instances_current_state; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_workflow_instances_current_state ON public.workflow_instances USING btree (current_state_id);


--
-- Name: idx_workflow_instances_entity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_workflow_instances_entity ON public.workflow_instances USING btree (entity_type, entity_id);


--
-- Name: idx_workflow_instances_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_workflow_instances_org_id ON public.workflow_instances USING btree (org_id);


--
-- Name: idx_workflow_instances_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_workflow_instances_status ON public.workflow_instances USING btree (status) WHERE (status = 'active'::text);


--
-- Name: idx_workflow_instances_workflow_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_workflow_instances_workflow_id ON public.workflow_instances USING btree (workflow_id);


--
-- Name: idx_workflow_states_terminal; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_workflow_states_terminal ON public.workflow_states USING btree (is_terminal) WHERE (is_terminal = true);


--
-- Name: idx_workflow_states_workflow_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_workflow_states_workflow_id ON public.workflow_states USING btree (workflow_id);


--
-- Name: idx_workflow_transitions_action; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_workflow_transitions_action ON public.workflow_transitions USING btree (action);


--
-- Name: idx_workflow_transitions_from_state; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_workflow_transitions_from_state ON public.workflow_transitions USING btree (from_state_id);


--
-- Name: idx_workflow_transitions_workflow_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_workflow_transitions_workflow_id ON public.workflow_transitions USING btree (workflow_id);


--
-- Name: idx_workflows_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_workflows_active ON public.workflows USING btree (is_active) WHERE (is_active = true);


--
-- Name: idx_workflows_entity_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_workflows_entity_type ON public.workflows USING btree (entity_type);


--
-- Name: idx_workflows_org_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_workflows_org_id ON public.workflows USING btree (org_id);


--
-- Name: idx_workplan_activities_template; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_workplan_activities_template ON public.workplan_template_activities USING btree (template_id, order_index);


--
-- Name: idx_workplan_instances_entity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_workplan_instances_entity ON public.workplan_instances USING btree (entity_type, entity_id);


--
-- Name: idx_workplan_instances_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_workplan_instances_status ON public.workplan_instances USING btree (org_id, status);


--
-- Name: idx_workplan_templates_entity; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_workplan_templates_entity ON public.workplan_templates USING btree (entity_type, is_active);


--
-- Name: idx_workplan_templates_trigger; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_workplan_templates_trigger ON public.workplan_templates USING btree (entity_type, trigger_event, trigger_status);


--
-- Name: idx_xp_transactions_awarded_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_xp_transactions_awarded_at ON public.xp_transactions USING btree (awarded_at DESC);


--
-- Name: idx_xp_transactions_created_week; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_xp_transactions_created_week ON public.xp_transactions USING btree (user_id, created_at);


--
-- Name: idx_xp_transactions_reference; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_xp_transactions_reference ON public.xp_transactions USING btree (reference_type, reference_id);


--
-- Name: idx_xp_transactions_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_xp_transactions_type ON public.xp_transactions USING btree (transaction_type);


--
-- Name: idx_xp_transactions_user; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_xp_transactions_user ON public.xp_transactions USING btree (user_id);


--
-- Name: queue_items_entity_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX queue_items_entity_idx ON public.queue_items USING btree (entity_type, entity_id);


--
-- Name: queue_items_queue_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX queue_items_queue_idx ON public.queue_items USING btree (queue_id);


--
-- Name: queue_items_status_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX queue_items_status_idx ON public.queue_items USING btree (status);


--
-- Name: sla_instances_activity_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX sla_instances_activity_idx ON public.sla_instances USING btree (activity_id);


--
-- Name: sla_instances_status_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX sla_instances_status_idx ON public.sla_instances USING btree (status);


--
-- Name: sla_instances_target_time_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX sla_instances_target_time_idx ON public.sla_instances USING btree (target_time);


--
-- Name: team_metrics_date_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX team_metrics_date_idx ON public.team_metrics USING btree (metric_date);


--
-- Name: team_metrics_pod_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX team_metrics_pod_idx ON public.team_metrics USING btree (pod_id);


--
-- Name: workplan_instances_entity_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX workplan_instances_entity_idx ON public.workplan_instances USING btree (entity_type, entity_id);


--
-- Name: workplan_instances_status_idx; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX workplan_instances_status_idx ON public.workplan_instances USING btree (status);


--
-- Name: audit_logs_2025_11_action_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_action ATTACH PARTITION public.audit_logs_2025_11_action_idx;


--
-- Name: audit_logs_2025_11_actor_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_actor_id ATTACH PARTITION public.audit_logs_2025_11_actor_id_idx;


--
-- Name: audit_logs_2025_11_correlation_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_correlation_id ATTACH PARTITION public.audit_logs_2025_11_correlation_id_idx;


--
-- Name: audit_logs_2025_11_created_at_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_created_at ATTACH PARTITION public.audit_logs_2025_11_created_at_idx;


--
-- Name: audit_logs_2025_11_entity_type_entity_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_entity_type_id ATTACH PARTITION public.audit_logs_2025_11_entity_type_entity_id_idx;


--
-- Name: audit_logs_2025_11_event_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_event_id ATTACH PARTITION public.audit_logs_2025_11_event_id_idx;


--
-- Name: audit_logs_2025_11_ip_address_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_ip_address ATTACH PARTITION public.audit_logs_2025_11_ip_address_idx;


--
-- Name: audit_logs_2025_11_org_id_created_at_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_org_created ATTACH PARTITION public.audit_logs_2025_11_org_id_created_at_idx;


--
-- Name: audit_logs_2025_11_org_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_org_id ATTACH PARTITION public.audit_logs_2025_11_org_id_idx;


--
-- Name: audit_logs_2025_11_record_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_record_id ATTACH PARTITION public.audit_logs_2025_11_record_id_idx;


--
-- Name: audit_logs_2025_11_result_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_result ATTACH PARTITION public.audit_logs_2025_11_result_idx;


--
-- Name: audit_logs_2025_11_session_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_session_id ATTACH PARTITION public.audit_logs_2025_11_session_id_idx;


--
-- Name: audit_logs_2025_11_severity_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_severity ATTACH PARTITION public.audit_logs_2025_11_severity_idx;


--
-- Name: audit_logs_2025_11_table_name_action_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_table_action ATTACH PARTITION public.audit_logs_2025_11_table_name_action_idx;


--
-- Name: audit_logs_2025_11_table_name_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_table_name ATTACH PARTITION public.audit_logs_2025_11_table_name_idx;


--
-- Name: audit_logs_2025_11_user_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_user_id ATTACH PARTITION public.audit_logs_2025_11_user_id_idx;


--
-- Name: audit_logs_2025_12_action_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_action ATTACH PARTITION public.audit_logs_2025_12_action_idx;


--
-- Name: audit_logs_2025_12_actor_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_actor_id ATTACH PARTITION public.audit_logs_2025_12_actor_id_idx;


--
-- Name: audit_logs_2025_12_correlation_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_correlation_id ATTACH PARTITION public.audit_logs_2025_12_correlation_id_idx;


--
-- Name: audit_logs_2025_12_created_at_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_created_at ATTACH PARTITION public.audit_logs_2025_12_created_at_idx;


--
-- Name: audit_logs_2025_12_entity_type_entity_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_entity_type_id ATTACH PARTITION public.audit_logs_2025_12_entity_type_entity_id_idx;


--
-- Name: audit_logs_2025_12_event_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_event_id ATTACH PARTITION public.audit_logs_2025_12_event_id_idx;


--
-- Name: audit_logs_2025_12_ip_address_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_ip_address ATTACH PARTITION public.audit_logs_2025_12_ip_address_idx;


--
-- Name: audit_logs_2025_12_org_id_created_at_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_org_created ATTACH PARTITION public.audit_logs_2025_12_org_id_created_at_idx;


--
-- Name: audit_logs_2025_12_org_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_org_id ATTACH PARTITION public.audit_logs_2025_12_org_id_idx;


--
-- Name: audit_logs_2025_12_record_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_record_id ATTACH PARTITION public.audit_logs_2025_12_record_id_idx;


--
-- Name: audit_logs_2025_12_result_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_result ATTACH PARTITION public.audit_logs_2025_12_result_idx;


--
-- Name: audit_logs_2025_12_session_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_session_id ATTACH PARTITION public.audit_logs_2025_12_session_id_idx;


--
-- Name: audit_logs_2025_12_severity_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_severity ATTACH PARTITION public.audit_logs_2025_12_severity_idx;


--
-- Name: audit_logs_2025_12_table_name_action_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_table_action ATTACH PARTITION public.audit_logs_2025_12_table_name_action_idx;


--
-- Name: audit_logs_2025_12_table_name_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_table_name ATTACH PARTITION public.audit_logs_2025_12_table_name_idx;


--
-- Name: audit_logs_2025_12_user_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_user_id ATTACH PARTITION public.audit_logs_2025_12_user_id_idx;


--
-- Name: audit_logs_2026_01_action_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_action ATTACH PARTITION public.audit_logs_2026_01_action_idx;


--
-- Name: audit_logs_2026_01_actor_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_actor_id ATTACH PARTITION public.audit_logs_2026_01_actor_id_idx;


--
-- Name: audit_logs_2026_01_correlation_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_correlation_id ATTACH PARTITION public.audit_logs_2026_01_correlation_id_idx;


--
-- Name: audit_logs_2026_01_created_at_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_created_at ATTACH PARTITION public.audit_logs_2026_01_created_at_idx;


--
-- Name: audit_logs_2026_01_entity_type_entity_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_entity_type_id ATTACH PARTITION public.audit_logs_2026_01_entity_type_entity_id_idx;


--
-- Name: audit_logs_2026_01_event_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_event_id ATTACH PARTITION public.audit_logs_2026_01_event_id_idx;


--
-- Name: audit_logs_2026_01_ip_address_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_ip_address ATTACH PARTITION public.audit_logs_2026_01_ip_address_idx;


--
-- Name: audit_logs_2026_01_org_id_created_at_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_org_created ATTACH PARTITION public.audit_logs_2026_01_org_id_created_at_idx;


--
-- Name: audit_logs_2026_01_org_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_org_id ATTACH PARTITION public.audit_logs_2026_01_org_id_idx;


--
-- Name: audit_logs_2026_01_record_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_record_id ATTACH PARTITION public.audit_logs_2026_01_record_id_idx;


--
-- Name: audit_logs_2026_01_result_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_result ATTACH PARTITION public.audit_logs_2026_01_result_idx;


--
-- Name: audit_logs_2026_01_session_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_session_id ATTACH PARTITION public.audit_logs_2026_01_session_id_idx;


--
-- Name: audit_logs_2026_01_severity_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_severity ATTACH PARTITION public.audit_logs_2026_01_severity_idx;


--
-- Name: audit_logs_2026_01_table_name_action_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_table_action ATTACH PARTITION public.audit_logs_2026_01_table_name_action_idx;


--
-- Name: audit_logs_2026_01_table_name_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_table_name ATTACH PARTITION public.audit_logs_2026_01_table_name_idx;


--
-- Name: audit_logs_2026_01_user_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_user_id ATTACH PARTITION public.audit_logs_2026_01_user_id_idx;


--
-- Name: audit_logs_2026_02_action_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_action ATTACH PARTITION public.audit_logs_2026_02_action_idx;


--
-- Name: audit_logs_2026_02_actor_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_actor_id ATTACH PARTITION public.audit_logs_2026_02_actor_id_idx;


--
-- Name: audit_logs_2026_02_correlation_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_correlation_id ATTACH PARTITION public.audit_logs_2026_02_correlation_id_idx;


--
-- Name: audit_logs_2026_02_created_at_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_created_at ATTACH PARTITION public.audit_logs_2026_02_created_at_idx;


--
-- Name: audit_logs_2026_02_entity_type_entity_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_entity_type_id ATTACH PARTITION public.audit_logs_2026_02_entity_type_entity_id_idx;


--
-- Name: audit_logs_2026_02_event_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_event_id ATTACH PARTITION public.audit_logs_2026_02_event_id_idx;


--
-- Name: audit_logs_2026_02_ip_address_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_ip_address ATTACH PARTITION public.audit_logs_2026_02_ip_address_idx;


--
-- Name: audit_logs_2026_02_org_id_created_at_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_org_created ATTACH PARTITION public.audit_logs_2026_02_org_id_created_at_idx;


--
-- Name: audit_logs_2026_02_org_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_org_id ATTACH PARTITION public.audit_logs_2026_02_org_id_idx;


--
-- Name: audit_logs_2026_02_record_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_record_id ATTACH PARTITION public.audit_logs_2026_02_record_id_idx;


--
-- Name: audit_logs_2026_02_result_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_result ATTACH PARTITION public.audit_logs_2026_02_result_idx;


--
-- Name: audit_logs_2026_02_session_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_session_id ATTACH PARTITION public.audit_logs_2026_02_session_id_idx;


--
-- Name: audit_logs_2026_02_severity_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_severity ATTACH PARTITION public.audit_logs_2026_02_severity_idx;


--
-- Name: audit_logs_2026_02_table_name_action_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_table_action ATTACH PARTITION public.audit_logs_2026_02_table_name_action_idx;


--
-- Name: audit_logs_2026_02_table_name_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_table_name ATTACH PARTITION public.audit_logs_2026_02_table_name_idx;


--
-- Name: audit_logs_2026_02_user_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -
--

ALTER INDEX public.idx_audit_logs_user_id ATTACH PARTITION public.audit_logs_2026_02_user_id_idx;


--
-- Name: question_bank_stats _RETURN; Type: RULE; Schema: public; Owner: -
--

CREATE OR REPLACE VIEW public.question_bank_stats AS
 SELECT qq.id AS question_id,
    qq.topic_id,
    qq.question_text,
    qq.question_type,
    qq.difficulty,
    qq.points,
    qq.is_public,
    qq.created_by,
    up.full_name AS created_by_name,
    count(DISTINCT qa.id) AS times_used,
    count(DISTINCT qa.user_id) AS unique_students,
    COALESCE(avg(
        CASE
            WHEN (qa.submitted_at IS NOT NULL) THEN
            CASE
                WHEN ((qa.answers -> (qq.id)::text) = qq.correct_answers) THEN 100.0
                ELSE 0.0
            END
            ELSE NULL::numeric
        END), (0)::numeric) AS avg_correct_percentage,
    qq.created_at,
    qq.updated_at
   FROM ((public.quiz_questions qq
     LEFT JOIN public.user_profiles up ON ((qq.created_by = up.id)))
     LEFT JOIN public.quiz_attempts qa ON ((qa.topic_id = qq.topic_id)))
  GROUP BY qq.id, up.full_name;


--
-- Name: quiz_analytics _RETURN; Type: RULE; Schema: public; Owner: -
--

CREATE OR REPLACE VIEW public.quiz_analytics AS
 SELECT mt.id AS topic_id,
    mt.title AS topic_title,
    cm.id AS module_id,
    cm.title AS module_title,
    c.id AS course_id,
    c.title AS course_title,
    count(DISTINCT qq.id) AS total_questions,
    count(DISTINCT
        CASE
            WHEN (qq.difficulty = 'easy'::text) THEN qq.id
            ELSE NULL::uuid
        END) AS easy_questions,
    count(DISTINCT
        CASE
            WHEN (qq.difficulty = 'medium'::text) THEN qq.id
            ELSE NULL::uuid
        END) AS medium_questions,
    count(DISTINCT
        CASE
            WHEN (qq.difficulty = 'hard'::text) THEN qq.id
            ELSE NULL::uuid
        END) AS hard_questions,
    count(DISTINCT qa.id) AS total_attempts,
    count(DISTINCT qa.user_id) AS unique_students,
    count(DISTINCT
        CASE
            WHEN (qa.passed = true) THEN qa.id
            ELSE NULL::uuid
        END) AS passed_attempts,
    COALESCE(avg(qa.score), (0)::numeric) AS avg_score,
    COALESCE(avg(qa.time_taken_seconds), (0)::numeric) AS avg_time_seconds,
    COALESCE((((count(DISTINCT
        CASE
            WHEN (qa.passed = true) THEN qa.id
            ELSE NULL::uuid
        END))::double precision / (NULLIF(count(DISTINCT qa.id), 0))::double precision) * (100)::double precision), (0)::double precision) AS pass_rate
   FROM ((((public.module_topics mt
     JOIN public.course_modules cm ON ((mt.module_id = cm.id)))
     JOIN public.courses c ON ((cm.course_id = c.id)))
     LEFT JOIN public.quiz_questions qq ON ((qq.topic_id = mt.id)))
     LEFT JOIN public.quiz_attempts qa ON (((qa.topic_id = mt.id) AND (qa.submitted_at IS NOT NULL))))
  WHERE (mt.content_type = 'quiz'::text)
  GROUP BY mt.id, cm.id, c.id;


--
-- Name: v_organization_stats _RETURN; Type: RULE; Schema: public; Owner: -
--

CREATE OR REPLACE VIEW public.v_organization_stats AS
 SELECT o.id,
    o.name,
    o.slug,
    o.subscription_tier,
    o.subscription_status,
    o.status,
    o.max_users,
    count(DISTINCT up.id) AS current_users,
    (o.max_users - count(DISTINCT up.id)) AS available_user_slots,
    o.max_candidates,
    count(DISTINCT up.id) FILTER (WHERE (up.candidate_status IS NOT NULL)) AS current_candidates,
    o.created_at,
    o.updated_at
   FROM (public.organizations o
     LEFT JOIN public.user_profiles up ON (((up.org_id = o.id) AND (up.deleted_at IS NULL))))
  WHERE (o.deleted_at IS NULL)
  GROUP BY o.id;


--
-- Name: v_session_summary _RETURN; Type: RULE; Schema: public; Owner: -
--

CREATE OR REPLACE VIEW public.v_session_summary AS
 SELECT sm.id,
    sm.session_id,
    sm.started_at,
    sm.ended_at,
    sm.duration,
    sm.branch,
    sm.commit_hash,
    sm.environment,
    sm.files_modified,
    sm.lines_added,
    sm.lines_removed,
    sm.commands_executed,
    sm.overall_goal,
    sm.successfully_completed,
    sm.created_at,
    sm.updated_at,
    count(pt.id) AS timeline_entries,
    COALESCE(array_agg(DISTINCT t.tag) FILTER (WHERE (t.tag IS NOT NULL)), ARRAY[]::text[]) AS all_tags
   FROM ((public.session_metadata sm
     LEFT JOIN public.project_timeline pt ON (((sm.session_id)::text = (pt.session_id)::text)))
     LEFT JOIN LATERAL unnest(pt.tags) t(tag) ON (true))
  GROUP BY sm.id
  ORDER BY sm.started_at DESC;


--
-- Name: achievements achievements_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER achievements_updated_at BEFORE UPDATE ON public.achievements FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: activities activities_generate_number; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER activities_generate_number BEFORE INSERT ON public.activities FOR EACH ROW EXECUTE FUNCTION public.generate_activity_number();


--
-- Name: activities activities_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER activities_updated_at BEFORE UPDATE ON public.activities FOR EACH ROW EXECUTE FUNCTION public.update_activities_updated_at();


--
-- Name: activities activities_updated_at_trigger; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER activities_updated_at_trigger BEFORE UPDATE ON public.activities FOR EACH ROW EXECUTE FUNCTION public.update_activities_updated_at();


--
-- Name: approval_instances approval_instances_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER approval_instances_updated_at BEFORE UPDATE ON public.approval_instances FOR EACH ROW EXECUTE FUNCTION public.update_approval_updated_at();


--
-- Name: approval_steps approval_steps_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER approval_steps_updated_at BEFORE UPDATE ON public.approval_steps FOR EACH ROW EXECUTE FUNCTION public.update_approval_updated_at();


--
-- Name: approval_workflows approval_workflows_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER approval_workflows_updated_at BEFORE UPDATE ON public.approval_workflows FOR EACH ROW EXECUTE FUNCTION public.update_approval_updated_at();


--
-- Name: archived_records archived_records_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER archived_records_updated_at BEFORE UPDATE ON public.archived_records FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: user_profiles audit_trigger; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER audit_trigger AFTER INSERT OR DELETE OR UPDATE ON public.user_profiles FOR EACH ROW EXECUTE FUNCTION public.audit_trigger_func();


--
-- Name: user_badges award_badge_xp_trigger; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER award_badge_xp_trigger AFTER INSERT ON public.user_badges FOR EACH ROW EXECUTE FUNCTION public.award_badge_xp();


--
-- Name: badges badge_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER badge_updated_at BEFORE UPDATE ON public.badges FOR EACH ROW EXECUTE FUNCTION public.update_badge_updated_at();


--
-- Name: benefit_dependents benefit_dependents_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER benefit_dependents_updated_at BEFORE UPDATE ON public.benefit_dependents FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: benefit_plan_options benefit_plan_options_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER benefit_plan_options_updated_at BEFORE UPDATE ON public.benefit_plan_options FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: benefit_plans benefit_plans_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER benefit_plans_updated_at BEFORE UPDATE ON public.benefit_plans FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: candidate_prepared_profiles candidate_prepared_profiles_updated_at_trigger; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER candidate_prepared_profiles_updated_at_trigger BEFORE UPDATE ON public.candidate_prepared_profiles FOR EACH ROW EXECUTE FUNCTION public.update_candidate_prepared_profiles_updated_at();


--
-- Name: candidate_screenings candidate_screenings_updated_at_trigger; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER candidate_screenings_updated_at_trigger BEFORE UPDATE ON public.candidate_screenings FOR EACH ROW EXECUTE FUNCTION public.update_candidate_screenings_updated_at();


--
-- Name: candidate_skills candidate_skills_populate_name; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER candidate_skills_populate_name BEFORE INSERT OR UPDATE ON public.candidate_skills FOR EACH ROW EXECUTE FUNCTION public.candidate_skills_populate_skill_name();


--
-- Name: certificate_templates certificate_templates_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER certificate_templates_updated_at BEFORE UPDATE ON public.certificate_templates FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: onboarding_checklist check_onboarding_completion; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER check_onboarding_completion BEFORE UPDATE ON public.onboarding_checklist FOR EACH ROW WHEN (((old.completed_profile IS DISTINCT FROM new.completed_profile) OR (old.enrolled_first_course IS DISTINCT FROM new.enrolled_first_course) OR (old.watched_first_video IS DISTINCT FROM new.watched_first_video) OR (old.completed_first_quiz IS DISTINCT FROM new.completed_first_quiz) OR (old.joined_community IS DISTINCT FROM new.joined_community) OR (old.connected_payment_method IS DISTINCT FROM new.connected_payment_method) OR (old.set_learning_goals IS DISTINCT FROM new.set_learning_goals) OR (old.completed_orientation IS DISTINCT FROM new.completed_orientation))) EXECUTE FUNCTION public.set_onboarding_completion();


--
-- Name: compliance_requirements compliance_requirements_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER compliance_requirements_updated_at BEFORE UPDATE ON public.compliance_requirements FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: contacts contacts_search_update; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER contacts_search_update BEFORE INSERT OR UPDATE ON public.contacts FOR EACH ROW EXECUTE FUNCTION public.contacts_search_trigger();


--
-- Name: content_assets content_assets_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER content_assets_updated_at BEFORE UPDATE ON public.content_assets FOR EACH ROW EXECUTE FUNCTION public.update_content_assets_updated_at();


--
-- Name: duplicate_records duplicate_records_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER duplicate_records_updated_at BEFORE UPDATE ON public.duplicate_records FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: duplicate_rules duplicate_rules_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER duplicate_rules_updated_at BEFORE UPDATE ON public.duplicate_rules FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: employee_benefits employee_benefits_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER employee_benefits_updated_at BEFORE UPDATE ON public.employee_benefits FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: employee_compliance employee_compliance_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER employee_compliance_updated_at BEFORE UPDATE ON public.employee_compliance FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: employee_documents employee_documents_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER employee_documents_updated_at BEFORE UPDATE ON public.employee_documents FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: employee_onboarding employee_onboarding_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER employee_onboarding_updated_at BEFORE UPDATE ON public.employee_onboarding FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: employee_profiles employee_profiles_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER employee_profiles_updated_at BEFORE UPDATE ON public.employee_profiles FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: employee_time_off employee_time_off_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER employee_time_off_updated_at BEFORE UPDATE ON public.employee_time_off FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: employees employees_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER employees_updated_at BEFORE UPDATE ON public.employees FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: student_enrollments enrollment_graduation_trigger; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER enrollment_graduation_trigger AFTER UPDATE ON public.student_enrollments FOR EACH ROW EXECUTE FUNCTION public.create_graduate_candidate();


--
-- Name: ai_mentor_escalations escalation_resolution_time; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER escalation_resolution_time BEFORE UPDATE ON public.ai_mentor_escalations FOR EACH ROW EXECUTE FUNCTION public.calculate_resolution_time();


--
-- Name: ai_mentor_escalations escalation_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER escalation_updated_at BEFORE UPDATE ON public.ai_mentor_escalations FOR EACH ROW EXECUTE FUNCTION public.update_escalation_updated_at();


--
-- Name: export_jobs export_jobs_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER export_jobs_updated_at BEFORE UPDATE ON public.export_jobs FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: feature_flags feature_flags_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER feature_flags_updated_at BEFORE UPDATE ON public.feature_flags FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: gdpr_requests gdpr_requests_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER gdpr_requests_updated_at BEFORE UPDATE ON public.gdpr_requests FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: graduate_candidates graduate_candidates_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER graduate_candidates_updated_at BEFORE UPDATE ON public.graduate_candidates FOR EACH ROW EXECUTE FUNCTION public.update_approval_updated_at();


--
-- Name: i9_records i9_records_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER i9_records_updated_at BEFORE UPDATE ON public.i9_records FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: import_jobs import_jobs_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER import_jobs_updated_at BEFORE UPDATE ON public.import_jobs FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: lead_strategies lead_strategies_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER lead_strategies_updated_at BEFORE UPDATE ON public.lead_strategies FOR EACH ROW EXECUTE FUNCTION public.update_lead_strategies_updated_at();


--
-- Name: leaderboard_entries leaderboard_entries_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER leaderboard_entries_updated_at BEFORE UPDATE ON public.leaderboard_entries FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: leaderboards leaderboards_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER leaderboards_updated_at BEFORE UPDATE ON public.leaderboards FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: learning_paths learning_paths_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER learning_paths_updated_at BEFORE UPDATE ON public.learning_paths FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: learning_streaks learning_streaks_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER learning_streaks_updated_at BEFORE UPDATE ON public.learning_streaks FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: level_definitions level_definitions_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER level_definitions_updated_at BEFORE UPDATE ON public.level_definitions FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: student_interventions log_intervention_status_change_trigger; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER log_intervention_status_change_trigger AFTER UPDATE ON public.student_interventions FOR EACH ROW WHEN ((old.status IS DISTINCT FROM new.status)) EXECUTE FUNCTION public.log_intervention_status_change();


--
-- Name: object_owners object_owners_enforce_primary; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER object_owners_enforce_primary BEFORE INSERT OR UPDATE ON public.object_owners FOR EACH ROW EXECUTE FUNCTION public.enforce_primary_owner();


--
-- Name: object_owners object_owners_log_change; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER object_owners_log_change AFTER INSERT OR DELETE OR UPDATE ON public.object_owners FOR EACH ROW EXECUTE FUNCTION public.log_raci_change();


--
-- Name: object_owners object_owners_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER object_owners_updated_at BEFORE UPDATE ON public.object_owners FOR EACH ROW EXECUTE FUNCTION public.object_owners_updated_at_trigger();


--
-- Name: object_owners object_owners_validate_accountable; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER object_owners_validate_accountable BEFORE INSERT OR UPDATE ON public.object_owners FOR EACH ROW EXECUTE FUNCTION public.validate_single_accountable();


--
-- Name: student_enrollments onboarding_first_enrollment; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER onboarding_first_enrollment AFTER INSERT ON public.student_enrollments FOR EACH ROW EXECUTE FUNCTION public.auto_complete_enrollment_step();


--
-- Name: payment_transactions onboarding_first_payment; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER onboarding_first_payment AFTER INSERT ON public.payment_transactions FOR EACH ROW EXECUTE FUNCTION public.auto_complete_payment_step();


--
-- Name: quiz_attempts onboarding_first_quiz; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER onboarding_first_quiz AFTER INSERT OR UPDATE ON public.quiz_attempts FOR EACH ROW EXECUTE FUNCTION public.auto_complete_quiz_step();


--
-- Name: video_progress onboarding_first_video; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER onboarding_first_video AFTER INSERT OR UPDATE ON public.video_progress FOR EACH ROW EXECUTE FUNCTION public.auto_complete_video_step();


--
-- Name: onboarding_tasks onboarding_tasks_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER onboarding_tasks_updated_at BEFORE UPDATE ON public.onboarding_tasks FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: path_enrollments path_enrollments_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER path_enrollments_updated_at BEFORE UPDATE ON public.path_enrollments FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: performance_feedback performance_feedback_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER performance_feedback_updated_at BEFORE UPDATE ON public.performance_feedback FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: performance_goals performance_goals_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER performance_goals_updated_at BEFORE UPDATE ON public.performance_goals FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: placement_credits placement_credits_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER placement_credits_updated_at BEFORE UPDATE ON public.placement_credits FOR EACH ROW EXECUTE FUNCTION public.update_approval_updated_at();


--
-- Name: pod_managers pod_managers_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER pod_managers_updated_at BEFORE UPDATE ON public.pod_managers FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: pod_members pod_members_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER pod_members_updated_at BEFORE UPDATE ON public.pod_members FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: pod_sprint_metrics pod_sprint_metrics_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER pod_sprint_metrics_updated_at BEFORE UPDATE ON public.pod_sprint_metrics FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: regions regions_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER regions_updated_at BEFORE UPDATE ON public.regions FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: retention_policies retention_policies_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER retention_policies_updated_at BEFORE UPDATE ON public.retention_policies FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: saved_searches saved_searches_updated_at_trigger; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER saved_searches_updated_at_trigger BEFORE UPDATE ON public.saved_searches FOR EACH ROW EXECUTE FUNCTION public.update_saved_searches_updated_at();


--
-- Name: course_pricing set_course_pricing_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER set_course_pricing_updated_at BEFORE UPDATE ON public.course_pricing FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: discount_codes set_discount_codes_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER set_discount_codes_updated_at BEFORE UPDATE ON public.discount_codes FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: lab_instances set_lab_instances_timestamp; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER set_lab_instances_timestamp BEFORE UPDATE ON public.lab_instances FOR EACH ROW EXECUTE FUNCTION public.update_lab_timestamp();


--
-- Name: lab_submissions set_lab_submissions_timestamp; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER set_lab_submissions_timestamp BEFORE UPDATE ON public.lab_submissions FOR EACH ROW EXECUTE FUNCTION public.update_lab_timestamp();


--
-- Name: lab_templates set_lab_templates_timestamp; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER set_lab_templates_timestamp BEFORE UPDATE ON public.lab_templates FOR EACH ROW EXECUTE FUNCTION public.update_lab_timestamp();


--
-- Name: payment_transactions set_payment_transactions_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER set_payment_transactions_updated_at BEFORE UPDATE ON public.payment_transactions FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: pricing_plans set_pricing_plans_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER set_pricing_plans_updated_at BEFORE UPDATE ON public.pricing_plans FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: reading_progress set_reading_progress_timestamp; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER set_reading_progress_timestamp BEFORE UPDATE ON public.reading_progress FOR EACH ROW EXECUTE FUNCTION public.update_reading_progress_timestamp();


--
-- Name: candidate_embeddings set_timestamp_candidate_embeddings; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER set_timestamp_candidate_embeddings BEFORE UPDATE ON public.candidate_embeddings FOR EACH ROW EXECUTE FUNCTION public.trigger_set_timestamp();


--
-- Name: generated_resumes set_timestamp_generated_resumes; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER set_timestamp_generated_resumes BEFORE UPDATE ON public.generated_resumes FOR EACH ROW EXECUTE FUNCTION public.trigger_set_timestamp();


--
-- Name: organizations set_timestamp_organizations; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER set_timestamp_organizations BEFORE UPDATE ON public.organizations FOR EACH ROW EXECUTE FUNCTION public.trigger_set_timestamp();


--
-- Name: requisition_embeddings set_timestamp_requisition_embeddings; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER set_timestamp_requisition_embeddings BEFORE UPDATE ON public.requisition_embeddings FOR EACH ROW EXECUTE FUNCTION public.trigger_set_timestamp();


--
-- Name: resume_matches set_timestamp_resume_matches; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER set_timestamp_resume_matches BEFORE UPDATE ON public.resume_matches FOR EACH ROW EXECUTE FUNCTION public.trigger_set_timestamp();


--
-- Name: video_progress set_video_progress_timestamp; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER set_video_progress_timestamp BEFORE UPDATE ON public.video_progress FOR EACH ROW EXECUTE FUNCTION public.update_video_progress_timestamp();


--
-- Name: sla_escalation_levels sla_escalation_levels_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER sla_escalation_levels_updated_at BEFORE UPDATE ON public.sla_escalation_levels FOR EACH ROW EXECUTE FUNCTION public.update_sla_updated_at();


--
-- Name: sla_events sla_events_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER sla_events_updated_at BEFORE UPDATE ON public.sla_events FOR EACH ROW EXECUTE FUNCTION public.update_sla_updated_at();


--
-- Name: system_roles system_roles_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER system_roles_updated_at BEFORE UPDATE ON public.system_roles FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: topic_completions topic_completions_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER topic_completions_updated_at BEFORE UPDATE ON public.topic_completions FOR EACH ROW EXECUTE FUNCTION public.update_topic_completions_updated_at();


--
-- Name: activities trg_activity_completion_check; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_activity_completion_check AFTER UPDATE OF status ON public.activities FOR EACH ROW WHEN (((new.status = 'completed'::text) AND (old.status <> 'completed'::text))) EXECUTE FUNCTION public.trigger_activity_completion_check();


--
-- Name: campaigns trg_campaign_workplan; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_campaign_workplan AFTER INSERT ON public.campaigns FOR EACH ROW EXECUTE FUNCTION public.trigger_campaign_workplan();


--
-- Name: companies trg_companies_hierarchy_path; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_companies_hierarchy_path BEFORE INSERT OR UPDATE OF parent_company_id ON public.companies FOR EACH ROW EXECUTE FUNCTION public.update_companies_hierarchy_path();


--
-- Name: companies trg_companies_search_vector; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trg_companies_search_vector BEFORE INSERT OR UPDATE ON public.companies FOR EACH ROW EXECUTE FUNCTION public.update_companies_search_vector();


--
-- Name: account_contacts trigger_account_contacts_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_account_contacts_updated_at BEFORE UPDATE ON public.account_contacts FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: account_notes trigger_account_notes_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_account_notes_updated_at BEFORE UPDATE ON public.account_notes FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: accounts trigger_accounts_search_vector; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_accounts_search_vector BEFORE INSERT OR UPDATE ON public.accounts FOR EACH ROW EXECUTE FUNCTION public.update_accounts_search_vector();


--
-- Name: accounts trigger_accounts_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_accounts_updated_at BEFORE UPDATE ON public.accounts FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: ai_prompts trigger_ai_prompts_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_ai_prompts_updated_at BEFORE UPDATE ON public.ai_prompts FOR EACH ROW EXECUTE FUNCTION public.trigger_set_timestamp();


--
-- Name: roles trigger_audit_roles; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_audit_roles AFTER INSERT OR DELETE OR UPDATE ON public.roles FOR EACH ROW EXECUTE FUNCTION public.trigger_audit_log();


--
-- Name: user_profiles trigger_audit_user_profiles; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_audit_user_profiles AFTER INSERT OR DELETE OR UPDATE ON public.user_profiles FOR EACH ROW EXECUTE FUNCTION public.trigger_audit_log();


--
-- Name: user_roles trigger_audit_user_roles; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_audit_user_roles AFTER INSERT OR DELETE OR UPDATE ON public.user_roles FOR EACH ROW EXECUTE FUNCTION public.trigger_audit_log();


--
-- Name: background_jobs trigger_background_jobs_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_background_jobs_updated_at BEFORE UPDATE ON public.background_jobs FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: campaign_documents trigger_campaign_documents_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_campaign_documents_updated_at BEFORE UPDATE ON public.campaign_documents FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: campaign_enrollments trigger_campaign_enrollments_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_campaign_enrollments_updated_at BEFORE UPDATE ON public.campaign_enrollments FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: campaigns trigger_campaigns_search_vector; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_campaigns_search_vector BEFORE INSERT OR UPDATE ON public.campaigns FOR EACH ROW EXECUTE FUNCTION public.update_campaigns_search_vector();


--
-- Name: campaigns trigger_campaigns_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_campaigns_updated_at BEFORE UPDATE ON public.campaigns FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: comments trigger_comments_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_comments_updated_at BEFORE UPDATE ON public.comments FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: commissions trigger_commissions_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_commissions_updated_at BEFORE UPDATE ON public.commissions FOR EACH ROW EXECUTE FUNCTION public.update_commissions_updated_at();


--
-- Name: contact_lead_data trigger_contact_lead_data_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_contact_lead_data_updated_at BEFORE UPDATE ON public.contact_lead_data FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: deals trigger_deal_health_status; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_deal_health_status BEFORE INSERT OR UPDATE ON public.deals FOR EACH ROW EXECUTE FUNCTION public.update_deal_health_status();


--
-- Name: deals trigger_deal_stage_change; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_deal_stage_change BEFORE UPDATE ON public.deals FOR EACH ROW EXECUTE FUNCTION public.log_deal_stage_change();


--
-- Name: deals trigger_deals_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_deals_updated_at BEFORE UPDATE ON public.deals FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: document_templates trigger_document_templates_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_document_templates_updated_at BEFORE UPDATE ON public.document_templates FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: email_senders trigger_email_senders_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_email_senders_updated_at BEFORE UPDATE ON public.email_senders FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: email_templates trigger_email_templates_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_email_templates_updated_at BEFORE UPDATE ON public.email_templates FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: emergency_drills trigger_emergency_drills_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_emergency_drills_updated_at BEFORE UPDATE ON public.emergency_drills FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: employee_metadata trigger_employee_metadata_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_employee_metadata_updated_at BEFORE UPDATE ON public.employee_metadata FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: employee_screenshots trigger_employee_screenshots_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_employee_screenshots_updated_at BEFORE UPDATE ON public.employee_screenshots FOR EACH ROW EXECUTE FUNCTION public.update_employee_screenshots_updated_at();


--
-- Name: student_enrollments trigger_enrollment_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_enrollment_updated_at BEFORE UPDATE ON public.student_enrollments FOR EACH ROW EXECUTE FUNCTION public.update_enrollment_timestamp();


--
-- Name: escalations trigger_escalations_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_escalations_updated_at BEFORE UPDATE ON public.escalations FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: event_subscriptions trigger_event_subscriptions_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_event_subscriptions_updated_at BEFORE UPDATE ON public.event_subscriptions FOR EACH ROW EXECUTE FUNCTION public.update_event_subscriptions_updated_at();


--
-- Name: integration_failover_config trigger_failover_config_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_failover_config_updated_at BEFORE UPDATE ON public.integration_failover_config FOR EACH ROW EXECUTE FUNCTION public.update_webhooks_updated_at();


--
-- Name: activities trigger_generate_activity_number; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_generate_activity_number BEFORE INSERT ON public.activities FOR EACH ROW EXECUTE FUNCTION public.generate_activity_number();


--
-- Name: incidents trigger_generate_incident_number; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_generate_incident_number BEFORE INSERT ON public.incidents FOR EACH ROW WHEN (((new.incident_number IS NULL) OR (new.incident_number = ''::text))) EXECUTE FUNCTION public.generate_incident_number();


--
-- Name: incidents trigger_incidents_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_incidents_updated_at BEFORE UPDATE ON public.incidents FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: integrations trigger_integrations_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_integrations_updated_at BEFORE UPDATE ON public.integrations FOR EACH ROW EXECUTE FUNCTION public.update_integrations_updated_at();


--
-- Name: jobs trigger_jobs_search_vector; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_jobs_search_vector BEFORE INSERT OR UPDATE ON public.jobs FOR EACH ROW EXECUTE FUNCTION public.update_jobs_search_vector();


--
-- Name: jobs trigger_jobs_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_jobs_updated_at BEFORE UPDATE ON public.jobs FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: lab_submissions trigger_lab_instance_submission; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_lab_instance_submission AFTER INSERT ON public.lab_submissions FOR EACH ROW EXECUTE FUNCTION public.update_lab_instance_on_submission();


--
-- Name: lead_sourcing_credits trigger_lead_sourcing_credits_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_lead_sourcing_credits_updated_at BEFORE UPDATE ON public.lead_sourcing_credits FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: lead_tasks trigger_lead_tasks_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_lead_tasks_updated_at BEFORE UPDATE ON public.lead_tasks FOR EACH ROW EXECUTE FUNCTION public.update_lead_tasks_updated_at();


--
-- Name: leads trigger_leads_search_vector; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_leads_search_vector BEFORE INSERT OR UPDATE ON public.leads FOR EACH ROW EXECUTE FUNCTION public.update_leads_search_vector();


--
-- Name: leads trigger_leads_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_leads_updated_at BEFORE UPDATE ON public.leads FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: meeting_notes trigger_meeting_notes_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_meeting_notes_updated_at BEFORE UPDATE ON public.meeting_notes FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: comments trigger_notify_mentions; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_notify_mentions AFTER INSERT ON public.comments FOR EACH ROW EXECUTE FUNCTION public.notify_mentioned_users();


--
-- Name: tasks trigger_notify_task_assigned; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_notify_task_assigned AFTER INSERT OR UPDATE OF assigned_to ON public.tasks FOR EACH ROW EXECUTE FUNCTION public.notify_task_assigned();


--
-- Name: integration_oauth_tokens trigger_oauth_tokens_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_oauth_tokens_updated_at BEFORE UPDATE ON public.integration_oauth_tokens FOR EACH ROW EXECUTE FUNCTION public.update_webhooks_updated_at();


--
-- Name: payroll_runs trigger_payroll_runs_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_payroll_runs_updated_at BEFORE UPDATE ON public.payroll_runs FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: pods trigger_pods_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_pods_updated_at BEFORE UPDATE ON public.pods FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: audit_logs trigger_prevent_audit_delete; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_prevent_audit_delete BEFORE DELETE ON public.audit_logs FOR EACH ROW EXECUTE FUNCTION public.prevent_audit_log_modification();


--
-- Name: audit_logs trigger_prevent_audit_update; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_prevent_audit_update BEFORE UPDATE ON public.audit_logs FOR EACH ROW EXECUTE FUNCTION public.prevent_audit_log_modification();


--
-- Name: user_profiles trigger_prevent_user_hard_delete; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_prevent_user_hard_delete BEFORE DELETE ON public.user_profiles FOR EACH ROW EXECUTE FUNCTION public.prevent_user_hard_delete();


--
-- Name: workflow_history trigger_prevent_workflow_history_delete; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_prevent_workflow_history_delete BEFORE DELETE ON public.workflow_history FOR EACH ROW EXECUTE FUNCTION public.prevent_workflow_history_modification();


--
-- Name: workflow_history trigger_prevent_workflow_history_update; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_prevent_workflow_history_update BEFORE UPDATE ON public.workflow_history FOR EACH ROW EXECUTE FUNCTION public.prevent_workflow_history_modification();


--
-- Name: productivity_reports trigger_productivity_reports_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_productivity_reports_updated_at BEFORE UPDATE ON public.productivity_reports FOR EACH ROW EXECUTE FUNCTION public.update_productivity_reports_updated_at();


--
-- Name: integration_retry_config trigger_retry_config_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_retry_config_updated_at BEFORE UPDATE ON public.integration_retry_config FOR EACH ROW EXECUTE FUNCTION public.update_webhooks_updated_at();


--
-- Name: roles trigger_roles_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_roles_updated_at BEFORE UPDATE ON public.roles FOR EACH ROW EXECUTE FUNCTION public.update_roles_updated_at();


--
-- Name: campaign_sequences trigger_sequence_template_usage; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_sequence_template_usage AFTER INSERT OR DELETE ON public.campaign_sequences FOR EACH ROW EXECUTE FUNCTION public.increment_sequence_template_usage();


--
-- Name: sequence_templates trigger_sequence_templates_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_sequence_templates_updated_at BEFORE UPDATE ON public.sequence_templates FOR EACH ROW EXECUTE FUNCTION public.update_sequence_templates_updated_at();


--
-- Name: session_metadata trigger_session_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_session_updated_at BEFORE UPDATE ON public.session_metadata FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: escalations trigger_set_escalation_number; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_set_escalation_number BEFORE INSERT ON public.escalations FOR EACH ROW EXECUTE FUNCTION public.set_escalation_number();


--
-- Name: submissions trigger_submissions_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_submissions_updated_at BEFORE UPDATE ON public.submissions FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: jobs trigger_sync_job_client_id; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_sync_job_client_id BEFORE UPDATE ON public.jobs FOR EACH ROW EXECUTE FUNCTION public.sync_job_client_id();


--
-- Name: lead_tasks trigger_task_completion; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_task_completion BEFORE UPDATE ON public.lead_tasks FOR EACH ROW EXECUTE FUNCTION public.handle_task_completion();


--
-- Name: tasks trigger_tasks_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_tasks_updated_at BEFORE UPDATE ON public.tasks FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: project_timeline trigger_timeline_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_timeline_updated_at BEFORE UPDATE ON public.project_timeline FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: placements trigger_update_candidate_placement; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_update_candidate_placement AFTER INSERT OR UPDATE OF status ON public.placements FOR EACH ROW EXECUTE FUNCTION public.update_candidate_on_placement();


--
-- Name: engagement_tracking trigger_update_contact_engagement; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_update_contact_engagement AFTER INSERT ON public.engagement_tracking FOR EACH ROW EXECUTE FUNCTION public.update_contact_from_engagement();


--
-- Name: course_modules trigger_update_course_module_count; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_update_course_module_count AFTER INSERT OR DELETE ON public.course_modules FOR EACH ROW EXECUTE FUNCTION public.update_course_module_count();


--
-- Name: module_topics trigger_update_course_topic_count; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_update_course_topic_count AFTER INSERT OR DELETE ON public.module_topics FOR EACH ROW EXECUTE FUNCTION public.update_course_topic_count();


--
-- Name: performance_reviews trigger_update_employee_rating; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_update_employee_rating AFTER UPDATE OF status ON public.performance_reviews FOR EACH ROW EXECUTE FUNCTION public.update_employee_rating();


--
-- Name: interviews trigger_update_interview_count; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_update_interview_count AFTER INSERT ON public.interviews FOR EACH ROW EXECUTE FUNCTION public.update_submission_interview_count();


--
-- Name: submissions trigger_update_job_positions; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_update_job_positions AFTER INSERT OR UPDATE OF status ON public.submissions FOR EACH ROW EXECUTE FUNCTION public.update_job_positions_filled();


--
-- Name: payroll_items trigger_update_payroll_totals; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_update_payroll_totals AFTER INSERT OR UPDATE ON public.payroll_items FOR EACH ROW EXECUTE FUNCTION public.update_payroll_run_totals();


--
-- Name: peer_reviews trigger_update_peer_review_stats; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_update_peer_review_stats AFTER INSERT OR UPDATE ON public.peer_reviews FOR EACH ROW EXECUTE FUNCTION public.update_peer_review_stats();


--
-- Name: comments trigger_update_reply_count; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_update_reply_count AFTER INSERT OR UPDATE OF is_deleted ON public.comments FOR EACH ROW EXECUTE FUNCTION public.update_comment_reply_count();


--
-- Name: offers trigger_update_submission_on_offer; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_update_submission_on_offer AFTER UPDATE OF status ON public.offers FOR EACH ROW EXECUTE FUNCTION public.update_submission_on_offer();


--
-- Name: project_timeline trigger_update_timeline_search; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_update_timeline_search BEFORE INSERT OR UPDATE ON public.project_timeline FOR EACH ROW EXECUTE FUNCTION public.update_timeline_search_vector();


--
-- Name: user_profiles trigger_user_profiles_search; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_user_profiles_search BEFORE INSERT OR UPDATE ON public.user_profiles FOR EACH ROW EXECUTE FUNCTION public.update_user_profiles_search_vector();


--
-- Name: user_profiles trigger_user_profiles_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_user_profiles_updated_at BEFORE UPDATE ON public.user_profiles FOR EACH ROW EXECUTE FUNCTION public.update_user_profiles_updated_at();


--
-- Name: webhooks trigger_webhook_auto_disable; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_webhook_auto_disable BEFORE UPDATE ON public.webhooks FOR EACH ROW WHEN ((new.consecutive_failures IS DISTINCT FROM old.consecutive_failures)) EXECUTE FUNCTION public.check_webhook_auto_disable();


--
-- Name: webhooks trigger_webhooks_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_webhooks_updated_at BEFORE UPDATE ON public.webhooks FOR EACH ROW EXECUTE FUNCTION public.update_webhooks_updated_at();


--
-- Name: workflow_instances trigger_workflow_instances_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_workflow_instances_updated_at BEFORE UPDATE ON public.workflow_instances FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: workflows trigger_workflows_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_workflows_updated_at BEFORE UPDATE ON public.workflows FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: activities update_activities_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_activities_updated_at BEFORE UPDATE ON public.activities FOR EACH ROW EXECUTE FUNCTION public.update_updated_at();


--
-- Name: activity_patterns update_activity_patterns_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_activity_patterns_updated_at BEFORE UPDATE ON public.activity_patterns FOR EACH ROW EXECUTE FUNCTION public.update_updated_at();


--
-- Name: alert_rules update_alert_rules_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_alert_rules_updated_at BEFORE UPDATE ON public.alert_rules FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: bench_consultants update_bench_consultants_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_bench_consultants_updated_at BEFORE UPDATE ON public.bench_consultants FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: capstone_submissions update_capstone_submissions_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_capstone_submissions_updated_at BEFORE UPDATE ON public.capstone_submissions FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: consultant_availability update_consultant_availability_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_consultant_availability_updated_at BEFORE UPDATE ON public.consultant_availability FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: consultant_visa_details update_consultant_visa_details_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_consultant_visa_details_updated_at BEFORE UPDATE ON public.consultant_visa_details FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: consultant_work_authorization update_consultant_work_authorization_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_consultant_work_authorization_updated_at BEFORE UPDATE ON public.consultant_work_authorization FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: immigration_attorneys update_immigration_attorneys_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_immigration_attorneys_updated_at BEFORE UPDATE ON public.immigration_attorneys FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: immigration_documents update_immigration_documents_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_immigration_documents_updated_at BEFORE UPDATE ON public.immigration_documents FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: immigration_timelines update_immigration_timelines_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_immigration_timelines_updated_at BEFORE UPDATE ON public.immigration_timelines FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: interview_sessions update_interview_sessions_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_interview_sessions_updated_at BEFORE UPDATE ON public.interview_sessions FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: external_job_orders update_job_orders_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_job_orders_updated_at BEFORE UPDATE ON public.external_job_orders FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: marketing_formats update_marketing_formats_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_marketing_formats_updated_at BEFORE UPDATE ON public.marketing_formats FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: marketing_profiles update_marketing_profiles_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_marketing_profiles_updated_at BEFORE UPDATE ON public.marketing_profiles FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: marketing_templates update_marketing_templates_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_marketing_templates_updated_at BEFORE UPDATE ON public.marketing_templates FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: onboarding_checklist update_onboarding_checklist_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_onboarding_checklist_updated_at BEFORE UPDATE ON public.onboarding_checklist FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: organization_settings update_org_settings_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_org_settings_updated_at BEFORE UPDATE ON public.organization_settings FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: peer_reviews update_peer_reviews_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_peer_reviews_updated_at BEFORE UPDATE ON public.peer_reviews FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: placement_checkins update_placement_checkins_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_placement_checkins_updated_at BEFORE UPDATE ON public.placement_checkins FOR EACH ROW EXECUTE FUNCTION public.update_placement_checkins_updated_at();


--
-- Name: quiz_questions update_quiz_questions_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_quiz_questions_updated_at BEFORE UPDATE ON public.quiz_questions FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: quiz_settings update_quiz_settings_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_quiz_settings_updated_at BEFORE UPDATE ON public.quiz_settings FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: resume_versions update_resume_versions_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_resume_versions_updated_at BEFORE UPDATE ON public.resume_versions FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: security_alerts update_security_alerts_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_security_alerts_updated_at BEFORE UPDATE ON public.security_alerts FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: student_interventions update_student_interventions_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_student_interventions_updated_at BEFORE UPDATE ON public.student_interventions FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: student_progress update_student_progress_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_student_progress_updated_at BEFORE UPDATE ON public.student_progress FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: system_settings update_system_settings_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_system_settings_updated_at BEFORE UPDATE ON public.system_settings FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: vendor_performance update_vendor_performance_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_vendor_performance_updated_at BEFORE UPDATE ON public.vendor_performance FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: vendor_terms update_vendor_terms_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_vendor_terms_updated_at BEFORE UPDATE ON public.vendor_terms FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: vendors update_vendors_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_vendors_updated_at BEFORE UPDATE ON public.vendors FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: workplan_instances update_workplan_instances_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_workplan_instances_updated_at BEFORE UPDATE ON public.workplan_instances FOR EACH ROW EXECUTE FUNCTION public.update_updated_at();


--
-- Name: workplan_templates update_workplan_templates_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_workplan_templates_updated_at BEFORE UPDATE ON public.workplan_templates FOR EACH ROW EXECUTE FUNCTION public.update_updated_at();


--
-- Name: user_invitations user_invitations_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER user_invitations_updated_at BEFORE UPDATE ON public.user_invitations FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: user_levels user_levels_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER user_levels_updated_at BEFORE UPDATE ON public.user_levels FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: quiz_questions validate_quiz_question_trigger; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER validate_quiz_question_trigger BEFORE INSERT OR UPDATE ON public.quiz_questions FOR EACH ROW EXECUTE FUNCTION public.validate_quiz_question();


--
-- Name: ai_prompt_variants validate_traffic_before_insert; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER validate_traffic_before_insert BEFORE INSERT ON public.ai_prompt_variants FOR EACH ROW EXECUTE FUNCTION public.validate_traffic_allocation();


--
-- Name: ai_prompt_variants validate_traffic_before_update; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER validate_traffic_before_update BEFORE UPDATE ON public.ai_prompt_variants FOR EACH ROW WHEN (((new.is_active IS DISTINCT FROM old.is_active) OR (new.traffic_percentage IS DISTINCT FROM old.traffic_percentage))) EXECUTE FUNCTION public.validate_traffic_allocation();


--
-- Name: account_contacts account_contacts_account_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.account_contacts
    ADD CONSTRAINT account_contacts_account_id_fkey FOREIGN KEY (account_id) REFERENCES public.accounts(id) ON DELETE CASCADE;


--
-- Name: account_contacts account_contacts_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.account_contacts
    ADD CONSTRAINT account_contacts_contact_id_fkey FOREIGN KEY (contact_id) REFERENCES public.contacts(id) ON DELETE CASCADE;


--
-- Name: account_contacts account_contacts_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.account_contacts
    ADD CONSTRAINT account_contacts_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: account_contacts account_contacts_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.account_contacts
    ADD CONSTRAINT account_contacts_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: account_contacts account_contacts_vendor_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.account_contacts
    ADD CONSTRAINT account_contacts_vendor_id_fkey FOREIGN KEY (vendor_id) REFERENCES public.vendors(id);


--
-- Name: account_contracts account_contracts_account_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.account_contracts
    ADD CONSTRAINT account_contracts_account_id_fkey FOREIGN KEY (account_id) REFERENCES public.accounts(id) ON DELETE CASCADE;


--
-- Name: account_contracts account_contracts_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.account_contracts
    ADD CONSTRAINT account_contracts_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: account_metrics account_metrics_account_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.account_metrics
    ADD CONSTRAINT account_metrics_account_id_fkey FOREIGN KEY (account_id) REFERENCES public.accounts(id) ON DELETE CASCADE;


--
-- Name: account_notes account_notes_account_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.account_notes
    ADD CONSTRAINT account_notes_account_id_fkey FOREIGN KEY (account_id) REFERENCES public.accounts(id) ON DELETE CASCADE;


--
-- Name: account_notes account_notes_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.account_notes
    ADD CONSTRAINT account_notes_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: account_notes account_notes_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.account_notes
    ADD CONSTRAINT account_notes_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: account_notes account_notes_updated_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.account_notes
    ADD CONSTRAINT account_notes_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES public.user_profiles(id);


--
-- Name: account_preferences account_preferences_account_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.account_preferences
    ADD CONSTRAINT account_preferences_account_id_fkey FOREIGN KEY (account_id) REFERENCES public.accounts(id) ON DELETE CASCADE;


--
-- Name: account_team account_team_account_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.account_team
    ADD CONSTRAINT account_team_account_id_fkey FOREIGN KEY (account_id) REFERENCES public.accounts(id) ON DELETE CASCADE;


--
-- Name: account_team account_team_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.account_team
    ADD CONSTRAINT account_team_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: account_team account_team_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.account_team
    ADD CONSTRAINT account_team_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: accounts accounts_account_manager_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.accounts
    ADD CONSTRAINT accounts_account_manager_id_fkey FOREIGN KEY (account_manager_id) REFERENCES public.user_profiles(id);


--
-- Name: accounts accounts_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.accounts
    ADD CONSTRAINT accounts_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: accounts accounts_onboarding_completed_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.accounts
    ADD CONSTRAINT accounts_onboarding_completed_by_fkey FOREIGN KEY (onboarding_completed_by) REFERENCES public.user_profiles(id);


--
-- Name: accounts accounts_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.accounts
    ADD CONSTRAINT accounts_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: accounts accounts_owner_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.accounts
    ADD CONSTRAINT accounts_owner_id_fkey FOREIGN KEY (owner_id) REFERENCES public.user_profiles(id);


--
-- Name: accounts accounts_updated_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.accounts
    ADD CONSTRAINT accounts_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES public.user_profiles(id);


--
-- Name: activities activities_assigned_group_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activities
    ADD CONSTRAINT activities_assigned_group_fkey FOREIGN KEY (assigned_group) REFERENCES public.pods(id);


--
-- Name: activities activities_assigned_to_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activities
    ADD CONSTRAINT activities_assigned_to_fkey FOREIGN KEY (assigned_to) REFERENCES public.user_profiles(id);


--
-- Name: activities activities_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activities
    ADD CONSTRAINT activities_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: activities activities_follow_up_activity_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activities
    ADD CONSTRAINT activities_follow_up_activity_id_fkey FOREIGN KEY (follow_up_activity_id) REFERENCES public.activities(id);


--
-- Name: activities activities_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activities
    ADD CONSTRAINT activities_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: activities activities_parent_activity_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activities
    ADD CONSTRAINT activities_parent_activity_id_fkey FOREIGN KEY (parent_activity_id) REFERENCES public.activities(id);


--
-- Name: activities activities_pattern_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activities
    ADD CONSTRAINT activities_pattern_id_fkey FOREIGN KEY (pattern_id) REFERENCES public.activity_patterns(id);


--
-- Name: activities activities_performed_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activities
    ADD CONSTRAINT activities_performed_by_fkey FOREIGN KEY (performed_by) REFERENCES public.user_profiles(id);


--
-- Name: activities activities_predecessor_activity_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activities
    ADD CONSTRAINT activities_predecessor_activity_id_fkey FOREIGN KEY (predecessor_activity_id) REFERENCES public.activities(id);


--
-- Name: activities activities_related_campaign_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activities
    ADD CONSTRAINT activities_related_campaign_id_fkey FOREIGN KEY (related_campaign_id) REFERENCES public.campaigns(id);


--
-- Name: activities activities_related_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activities
    ADD CONSTRAINT activities_related_contact_id_fkey FOREIGN KEY (related_contact_id) REFERENCES public.contacts(id);


--
-- Name: activities activities_related_deal_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activities
    ADD CONSTRAINT activities_related_deal_id_fkey FOREIGN KEY (related_deal_id) REFERENCES public.deals(id);


--
-- Name: activities activities_updated_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activities
    ADD CONSTRAINT activities_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES public.user_profiles(id);


--
-- Name: activities activities_workplan_instance_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activities
    ADD CONSTRAINT activities_workplan_instance_id_fkey FOREIGN KEY (workplan_instance_id) REFERENCES public.workplan_instances(id) ON DELETE SET NULL;


--
-- Name: activity_attachments activity_attachments_activity_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_attachments
    ADD CONSTRAINT activity_attachments_activity_id_fkey FOREIGN KEY (activity_id) REFERENCES public.activities(id) ON DELETE CASCADE;


--
-- Name: activity_attachments activity_attachments_uploaded_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_attachments
    ADD CONSTRAINT activity_attachments_uploaded_by_fkey FOREIGN KEY (uploaded_by) REFERENCES public.user_profiles(id);


--
-- Name: activity_auto_rules activity_auto_rules_activity_pattern_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_auto_rules
    ADD CONSTRAINT activity_auto_rules_activity_pattern_id_fkey FOREIGN KEY (activity_pattern_id) REFERENCES public.activity_patterns(id);


--
-- Name: activity_auto_rules activity_auto_rules_assign_to_group_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_auto_rules
    ADD CONSTRAINT activity_auto_rules_assign_to_group_id_fkey FOREIGN KEY (assign_to_group_id) REFERENCES public.pods(id);


--
-- Name: activity_auto_rules activity_auto_rules_assign_to_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_auto_rules
    ADD CONSTRAINT activity_auto_rules_assign_to_user_id_fkey FOREIGN KEY (assign_to_user_id) REFERENCES public.user_profiles(id);


--
-- Name: activity_auto_rules activity_auto_rules_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_auto_rules
    ADD CONSTRAINT activity_auto_rules_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: activity_checklist_items activity_checklist_items_activity_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_checklist_items
    ADD CONSTRAINT activity_checklist_items_activity_id_fkey FOREIGN KEY (activity_id) REFERENCES public.activities(id) ON DELETE CASCADE;


--
-- Name: activity_checklist_items activity_checklist_items_completed_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_checklist_items
    ADD CONSTRAINT activity_checklist_items_completed_by_fkey FOREIGN KEY (completed_by) REFERENCES public.user_profiles(id);


--
-- Name: activity_checklist_items activity_checklist_items_pattern_checklist_item_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_checklist_items
    ADD CONSTRAINT activity_checklist_items_pattern_checklist_item_id_fkey FOREIGN KEY (pattern_checklist_item_id) REFERENCES public.pattern_checklist_items(id);


--
-- Name: activity_comments activity_comments_activity_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_comments
    ADD CONSTRAINT activity_comments_activity_id_fkey FOREIGN KEY (activity_id) REFERENCES public.activities(id) ON DELETE CASCADE;


--
-- Name: activity_comments activity_comments_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_comments
    ADD CONSTRAINT activity_comments_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: activity_comments activity_comments_parent_comment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_comments
    ADD CONSTRAINT activity_comments_parent_comment_id_fkey FOREIGN KEY (parent_comment_id) REFERENCES public.activity_comments(id);


--
-- Name: activity_comments activity_comments_updated_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_comments
    ADD CONSTRAINT activity_comments_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES public.user_profiles(id);


--
-- Name: activity_dependencies activity_dependencies_activity_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_dependencies
    ADD CONSTRAINT activity_dependencies_activity_id_fkey FOREIGN KEY (activity_id) REFERENCES public.activities(id) ON DELETE CASCADE;


--
-- Name: activity_dependencies activity_dependencies_depends_on_activity_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_dependencies
    ADD CONSTRAINT activity_dependencies_depends_on_activity_id_fkey FOREIGN KEY (depends_on_activity_id) REFERENCES public.activities(id) ON DELETE CASCADE;


--
-- Name: activity_field_values activity_field_values_activity_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_field_values
    ADD CONSTRAINT activity_field_values_activity_id_fkey FOREIGN KEY (activity_id) REFERENCES public.activities(id) ON DELETE CASCADE;


--
-- Name: activity_field_values activity_field_values_field_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_field_values
    ADD CONSTRAINT activity_field_values_field_id_fkey FOREIGN KEY (field_id) REFERENCES public.pattern_fields(id) ON DELETE CASCADE;


--
-- Name: activity_history activity_history_activity_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_history
    ADD CONSTRAINT activity_history_activity_id_fkey FOREIGN KEY (activity_id) REFERENCES public.activities(id) ON DELETE CASCADE;


--
-- Name: activity_history activity_history_changed_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_history
    ADD CONSTRAINT activity_history_changed_by_fkey FOREIGN KEY (changed_by) REFERENCES public.user_profiles(id);


--
-- Name: activity_log activity_log_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_log
    ADD CONSTRAINT activity_log_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: activity_log activity_log_performed_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_log
    ADD CONSTRAINT activity_log_performed_by_fkey FOREIGN KEY (performed_by) REFERENCES public.user_profiles(id);


--
-- Name: activity_metrics activity_metrics_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_metrics
    ADD CONSTRAINT activity_metrics_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: activity_metrics activity_metrics_pod_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_metrics
    ADD CONSTRAINT activity_metrics_pod_id_fkey FOREIGN KEY (pod_id) REFERENCES public.pods(id);


--
-- Name: activity_metrics activity_metrics_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_metrics
    ADD CONSTRAINT activity_metrics_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id);


--
-- Name: activity_participants activity_participants_activity_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_participants
    ADD CONSTRAINT activity_participants_activity_id_fkey FOREIGN KEY (activity_id) REFERENCES public.activities(id) ON DELETE CASCADE;


--
-- Name: activity_participants activity_participants_added_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_participants
    ADD CONSTRAINT activity_participants_added_by_fkey FOREIGN KEY (added_by) REFERENCES public.user_profiles(id);


--
-- Name: activity_participants activity_participants_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_participants
    ADD CONSTRAINT activity_participants_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id);


--
-- Name: activity_pattern_successors activity_pattern_successors_pattern_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_pattern_successors
    ADD CONSTRAINT activity_pattern_successors_pattern_id_fkey FOREIGN KEY (pattern_id) REFERENCES public.activity_patterns(id) ON DELETE CASCADE;


--
-- Name: activity_pattern_successors activity_pattern_successors_successor_pattern_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_pattern_successors
    ADD CONSTRAINT activity_pattern_successors_successor_pattern_id_fkey FOREIGN KEY (successor_pattern_id) REFERENCES public.activity_patterns(id) ON DELETE CASCADE;


--
-- Name: activity_patterns activity_patterns_assignee_group_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_patterns
    ADD CONSTRAINT activity_patterns_assignee_group_id_fkey FOREIGN KEY (assignee_group_id) REFERENCES public.pods(id);


--
-- Name: activity_patterns activity_patterns_assignee_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_patterns
    ADD CONSTRAINT activity_patterns_assignee_user_id_fkey FOREIGN KEY (assignee_user_id) REFERENCES public.user_profiles(id);


--
-- Name: activity_patterns activity_patterns_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_patterns
    ADD CONSTRAINT activity_patterns_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: activity_patterns activity_patterns_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_patterns
    ADD CONSTRAINT activity_patterns_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: activity_reminders activity_reminders_activity_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_reminders
    ADD CONSTRAINT activity_reminders_activity_id_fkey FOREIGN KEY (activity_id) REFERENCES public.activities(id) ON DELETE CASCADE;


--
-- Name: activity_reminders activity_reminders_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_reminders
    ADD CONSTRAINT activity_reminders_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id);


--
-- Name: activity_stats_daily activity_stats_daily_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_stats_daily
    ADD CONSTRAINT activity_stats_daily_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: activity_stats_daily activity_stats_daily_pattern_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_stats_daily
    ADD CONSTRAINT activity_stats_daily_pattern_id_fkey FOREIGN KEY (pattern_id) REFERENCES public.activity_patterns(id) ON DELETE SET NULL;


--
-- Name: activity_stats_daily activity_stats_daily_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_stats_daily
    ADD CONSTRAINT activity_stats_daily_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: activity_time_entries activity_time_entries_activity_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_time_entries
    ADD CONSTRAINT activity_time_entries_activity_id_fkey FOREIGN KEY (activity_id) REFERENCES public.activities(id) ON DELETE CASCADE;


--
-- Name: activity_time_entries activity_time_entries_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.activity_time_entries
    ADD CONSTRAINT activity_time_entries_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id);


--
-- Name: addresses addresses_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.addresses
    ADD CONSTRAINT addresses_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: ai_agent_interactions ai_agent_interactions_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_agent_interactions
    ADD CONSTRAINT ai_agent_interactions_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: ai_agent_interactions ai_agent_interactions_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_agent_interactions
    ADD CONSTRAINT ai_agent_interactions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE SET NULL;


--
-- Name: ai_conversations ai_conversations_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_conversations
    ADD CONSTRAINT ai_conversations_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: ai_cost_tracking ai_cost_tracking_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_cost_tracking
    ADD CONSTRAINT ai_cost_tracking_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: ai_cost_tracking ai_cost_tracking_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_cost_tracking
    ADD CONSTRAINT ai_cost_tracking_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE SET NULL;


--
-- Name: ai_mentor_chats ai_mentor_chats_course_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_mentor_chats
    ADD CONSTRAINT ai_mentor_chats_course_id_fkey FOREIGN KEY (course_id) REFERENCES public.courses(id) ON DELETE SET NULL;


--
-- Name: ai_mentor_chats ai_mentor_chats_prompt_variant_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_mentor_chats
    ADD CONSTRAINT ai_mentor_chats_prompt_variant_id_fkey FOREIGN KEY (prompt_variant_id) REFERENCES public.ai_prompt_variants(id) ON DELETE SET NULL;


--
-- Name: ai_mentor_chats ai_mentor_chats_topic_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_mentor_chats
    ADD CONSTRAINT ai_mentor_chats_topic_id_fkey FOREIGN KEY (topic_id) REFERENCES public.module_topics(id) ON DELETE SET NULL;


--
-- Name: ai_mentor_chats ai_mentor_chats_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_mentor_chats
    ADD CONSTRAINT ai_mentor_chats_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: ai_mentor_escalations ai_mentor_escalations_assigned_to_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_mentor_escalations
    ADD CONSTRAINT ai_mentor_escalations_assigned_to_fkey FOREIGN KEY (assigned_to) REFERENCES public.user_profiles(id) ON DELETE SET NULL;


--
-- Name: ai_mentor_escalations ai_mentor_escalations_chat_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_mentor_escalations
    ADD CONSTRAINT ai_mentor_escalations_chat_id_fkey FOREIGN KEY (chat_id) REFERENCES public.ai_mentor_chats(id) ON DELETE CASCADE;


--
-- Name: ai_mentor_escalations ai_mentor_escalations_resolved_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_mentor_escalations
    ADD CONSTRAINT ai_mentor_escalations_resolved_by_fkey FOREIGN KEY (resolved_by) REFERENCES public.user_profiles(id) ON DELETE SET NULL;


--
-- Name: ai_mentor_escalations ai_mentor_escalations_topic_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_mentor_escalations
    ADD CONSTRAINT ai_mentor_escalations_topic_id_fkey FOREIGN KEY (topic_id) REFERENCES public.module_topics(id) ON DELETE SET NULL;


--
-- Name: ai_mentor_escalations ai_mentor_escalations_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_mentor_escalations
    ADD CONSTRAINT ai_mentor_escalations_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: ai_mentor_rate_limits ai_mentor_rate_limits_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_mentor_rate_limits
    ADD CONSTRAINT ai_mentor_rate_limits_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: ai_mentor_sessions ai_mentor_sessions_course_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_mentor_sessions
    ADD CONSTRAINT ai_mentor_sessions_course_id_fkey FOREIGN KEY (course_id) REFERENCES public.courses(id) ON DELETE SET NULL;


--
-- Name: ai_mentor_sessions ai_mentor_sessions_topic_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_mentor_sessions
    ADD CONSTRAINT ai_mentor_sessions_topic_id_fkey FOREIGN KEY (topic_id) REFERENCES public.module_topics(id) ON DELETE SET NULL;


--
-- Name: ai_mentor_sessions ai_mentor_sessions_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_mentor_sessions
    ADD CONSTRAINT ai_mentor_sessions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: ai_patterns ai_patterns_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_patterns
    ADD CONSTRAINT ai_patterns_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: ai_prompts ai_prompts_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_prompts
    ADD CONSTRAINT ai_prompts_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: ai_question_patterns ai_question_patterns_topic_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.ai_question_patterns
    ADD CONSTRAINT ai_question_patterns_topic_id_fkey FOREIGN KEY (topic_id) REFERENCES public.module_topics(id) ON DELETE SET NULL;


--
-- Name: alert_rules alert_rules_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.alert_rules
    ADD CONSTRAINT alert_rules_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id) ON DELETE SET NULL;


--
-- Name: alert_rules alert_rules_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.alert_rules
    ADD CONSTRAINT alert_rules_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: api_tokens api_tokens_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.api_tokens
    ADD CONSTRAINT api_tokens_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: api_tokens api_tokens_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.api_tokens
    ADD CONSTRAINT api_tokens_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: api_tokens api_tokens_revoked_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.api_tokens
    ADD CONSTRAINT api_tokens_revoked_by_fkey FOREIGN KEY (revoked_by) REFERENCES public.user_profiles(id);


--
-- Name: approval_instances approval_instances_escalated_to_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.approval_instances
    ADD CONSTRAINT approval_instances_escalated_to_fkey FOREIGN KEY (escalated_to) REFERENCES public.user_profiles(id);


--
-- Name: approval_instances approval_instances_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.approval_instances
    ADD CONSTRAINT approval_instances_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: approval_instances approval_instances_requested_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.approval_instances
    ADD CONSTRAINT approval_instances_requested_by_fkey FOREIGN KEY (requested_by) REFERENCES public.user_profiles(id);


--
-- Name: approval_instances approval_instances_resolved_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.approval_instances
    ADD CONSTRAINT approval_instances_resolved_by_fkey FOREIGN KEY (resolved_by) REFERENCES public.user_profiles(id);


--
-- Name: approval_instances approval_instances_workflow_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.approval_instances
    ADD CONSTRAINT approval_instances_workflow_id_fkey FOREIGN KEY (workflow_id) REFERENCES public.approval_workflows(id);


--
-- Name: approval_steps approval_steps_approver_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.approval_steps
    ADD CONSTRAINT approval_steps_approver_id_fkey FOREIGN KEY (approver_id) REFERENCES public.user_profiles(id);


--
-- Name: approval_steps approval_steps_decided_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.approval_steps
    ADD CONSTRAINT approval_steps_decided_by_fkey FOREIGN KEY (decided_by) REFERENCES public.user_profiles(id);


--
-- Name: approval_steps approval_steps_instance_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.approval_steps
    ADD CONSTRAINT approval_steps_instance_id_fkey FOREIGN KEY (instance_id) REFERENCES public.approval_instances(id) ON DELETE CASCADE;


--
-- Name: approval_workflows approval_workflows_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.approval_workflows
    ADD CONSTRAINT approval_workflows_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: approval_workflows approval_workflows_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.approval_workflows
    ADD CONSTRAINT approval_workflows_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: archived_records archived_records_archived_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.archived_records
    ADD CONSTRAINT archived_records_archived_by_fkey FOREIGN KEY (archived_by) REFERENCES public.user_profiles(id);


--
-- Name: archived_records archived_records_deleted_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.archived_records
    ADD CONSTRAINT archived_records_deleted_by_fkey FOREIGN KEY (deleted_by) REFERENCES public.user_profiles(id);


--
-- Name: archived_records archived_records_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.archived_records
    ADD CONSTRAINT archived_records_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: archived_records archived_records_restored_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.archived_records
    ADD CONSTRAINT archived_records_restored_by_fkey FOREIGN KEY (restored_by) REFERENCES public.user_profiles(id);


--
-- Name: audit_logs audit_logs_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE public.audit_logs
    ADD CONSTRAINT audit_logs_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: audit_logs audit_logs_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE public.audit_logs
    ADD CONSTRAINT audit_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id);


--
-- Name: background_jobs background_jobs_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.background_jobs
    ADD CONSTRAINT background_jobs_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: background_jobs background_jobs_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.background_jobs
    ADD CONSTRAINT background_jobs_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: badge_progress badge_progress_badge_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.badge_progress
    ADD CONSTRAINT badge_progress_badge_id_fkey FOREIGN KEY (badge_id) REFERENCES public.badges(id) ON DELETE CASCADE;


--
-- Name: badge_progress badge_progress_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.badge_progress
    ADD CONSTRAINT badge_progress_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: badge_trigger_events badge_trigger_events_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.badge_trigger_events
    ADD CONSTRAINT badge_trigger_events_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: bench_consultants bench_consultants_bench_sales_rep_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.bench_consultants
    ADD CONSTRAINT bench_consultants_bench_sales_rep_id_fkey FOREIGN KEY (bench_sales_rep_id) REFERENCES public.user_profiles(id);


--
-- Name: bench_consultants bench_consultants_candidate_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.bench_consultants
    ADD CONSTRAINT bench_consultants_candidate_id_fkey FOREIGN KEY (candidate_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: bench_consultants bench_consultants_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.bench_consultants
    ADD CONSTRAINT bench_consultants_contact_id_fkey FOREIGN KEY (contact_id) REFERENCES public.contacts(id);


--
-- Name: bench_consultants bench_consultants_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.bench_consultants
    ADD CONSTRAINT bench_consultants_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: bench_consultants bench_consultants_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.bench_consultants
    ADD CONSTRAINT bench_consultants_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: benefit_dependents benefit_dependents_employee_benefit_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.benefit_dependents
    ADD CONSTRAINT benefit_dependents_employee_benefit_id_fkey FOREIGN KEY (employee_benefit_id) REFERENCES public.employee_benefits(id) ON DELETE CASCADE;


--
-- Name: benefit_plan_options benefit_plan_options_plan_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.benefit_plan_options
    ADD CONSTRAINT benefit_plan_options_plan_id_fkey FOREIGN KEY (plan_id) REFERENCES public.benefit_plans(id) ON DELETE CASCADE;


--
-- Name: benefit_plans benefit_plans_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.benefit_plans
    ADD CONSTRAINT benefit_plans_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: benefit_plans benefit_plans_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.benefit_plans
    ADD CONSTRAINT benefit_plans_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: break_glass_access break_glass_access_incident_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.break_glass_access
    ADD CONSTRAINT break_glass_access_incident_id_fkey FOREIGN KEY (incident_id) REFERENCES public.incidents(id);


--
-- Name: break_glass_access break_glass_access_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.break_glass_access
    ADD CONSTRAINT break_glass_access_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: break_glass_access break_glass_access_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.break_glass_access
    ADD CONSTRAINT break_glass_access_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id);


--
-- Name: bulk_activity_jobs bulk_activity_jobs_activity_pattern_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.bulk_activity_jobs
    ADD CONSTRAINT bulk_activity_jobs_activity_pattern_id_fkey FOREIGN KEY (activity_pattern_id) REFERENCES public.activity_patterns(id);


--
-- Name: bulk_activity_jobs bulk_activity_jobs_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.bulk_activity_jobs
    ADD CONSTRAINT bulk_activity_jobs_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: bulk_activity_jobs bulk_activity_jobs_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.bulk_activity_jobs
    ADD CONSTRAINT bulk_activity_jobs_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: bulk_update_history bulk_update_history_applied_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.bulk_update_history
    ADD CONSTRAINT bulk_update_history_applied_by_fkey FOREIGN KEY (applied_by) REFERENCES public.user_profiles(id);


--
-- Name: bulk_update_history bulk_update_history_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.bulk_update_history
    ADD CONSTRAINT bulk_update_history_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: bulk_update_history bulk_update_history_rolled_back_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.bulk_update_history
    ADD CONSTRAINT bulk_update_history_rolled_back_by_fkey FOREIGN KEY (rolled_back_by) REFERENCES public.user_profiles(id);


--
-- Name: campaign_documents campaign_documents_campaign_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.campaign_documents
    ADD CONSTRAINT campaign_documents_campaign_id_fkey FOREIGN KEY (campaign_id) REFERENCES public.campaigns(id) ON DELETE CASCADE;


--
-- Name: campaign_documents campaign_documents_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.campaign_documents
    ADD CONSTRAINT campaign_documents_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: campaign_documents campaign_documents_uploaded_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.campaign_documents
    ADD CONSTRAINT campaign_documents_uploaded_by_fkey FOREIGN KEY (uploaded_by) REFERENCES public.user_profiles(id);


--
-- Name: campaign_enrollments campaign_enrollments_campaign_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.campaign_enrollments
    ADD CONSTRAINT campaign_enrollments_campaign_id_fkey FOREIGN KEY (campaign_id) REFERENCES public.campaigns(id) ON DELETE CASCADE;


--
-- Name: campaign_enrollments campaign_enrollments_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.campaign_enrollments
    ADD CONSTRAINT campaign_enrollments_contact_id_fkey FOREIGN KEY (contact_id) REFERENCES public.contacts(id) ON DELETE CASCADE;


--
-- Name: campaign_enrollments campaign_enrollments_converted_lead_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.campaign_enrollments
    ADD CONSTRAINT campaign_enrollments_converted_lead_id_fkey FOREIGN KEY (converted_lead_id) REFERENCES public.leads(id);


--
-- Name: campaign_enrollments campaign_enrollments_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.campaign_enrollments
    ADD CONSTRAINT campaign_enrollments_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: campaign_sequence_logs campaign_sequence_logs_campaign_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.campaign_sequence_logs
    ADD CONSTRAINT campaign_sequence_logs_campaign_id_fkey FOREIGN KEY (campaign_id) REFERENCES public.campaigns(id) ON DELETE CASCADE;


--
-- Name: campaign_sequence_logs campaign_sequence_logs_enrollment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.campaign_sequence_logs
    ADD CONSTRAINT campaign_sequence_logs_enrollment_id_fkey FOREIGN KEY (enrollment_id) REFERENCES public.campaign_enrollments(id);


--
-- Name: campaign_sequence_logs campaign_sequence_logs_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.campaign_sequence_logs
    ADD CONSTRAINT campaign_sequence_logs_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: campaign_sequences campaign_sequences_campaign_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.campaign_sequences
    ADD CONSTRAINT campaign_sequences_campaign_id_fkey FOREIGN KEY (campaign_id) REFERENCES public.campaigns(id) ON DELETE CASCADE;


--
-- Name: campaign_sequences campaign_sequences_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.campaign_sequences
    ADD CONSTRAINT campaign_sequences_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: campaign_sequences campaign_sequences_sequence_template_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.campaign_sequences
    ADD CONSTRAINT campaign_sequences_sequence_template_id_fkey FOREIGN KEY (sequence_template_id) REFERENCES public.sequence_templates(id) ON DELETE CASCADE;


--
-- Name: campaigns campaigns_approved_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.campaigns
    ADD CONSTRAINT campaigns_approved_by_fkey FOREIGN KEY (approved_by) REFERENCES public.user_profiles(id);


--
-- Name: campaigns campaigns_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.campaigns
    ADD CONSTRAINT campaigns_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: campaigns campaigns_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.campaigns
    ADD CONSTRAINT campaigns_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: campaigns campaigns_owner_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.campaigns
    ADD CONSTRAINT campaigns_owner_id_fkey FOREIGN KEY (owner_id) REFERENCES public.user_profiles(id);


--
-- Name: campaigns campaigns_updated_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.campaigns
    ADD CONSTRAINT campaigns_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES public.user_profiles(id);


--
-- Name: candidate_availability candidate_availability_candidate_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_availability
    ADD CONSTRAINT candidate_availability_candidate_id_fkey FOREIGN KEY (candidate_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: candidate_availability candidate_availability_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_availability
    ADD CONSTRAINT candidate_availability_contact_id_fkey FOREIGN KEY (contact_id) REFERENCES public.contacts(id);


--
-- Name: candidate_availability candidate_availability_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_availability
    ADD CONSTRAINT candidate_availability_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: candidate_background_checks candidate_background_checks_candidate_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_background_checks
    ADD CONSTRAINT candidate_background_checks_candidate_id_fkey FOREIGN KEY (candidate_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: candidate_background_checks candidate_background_checks_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_background_checks
    ADD CONSTRAINT candidate_background_checks_contact_id_fkey FOREIGN KEY (contact_id) REFERENCES public.contacts(id);


--
-- Name: candidate_background_checks candidate_background_checks_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_background_checks
    ADD CONSTRAINT candidate_background_checks_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: candidate_background_checks candidate_background_checks_placement_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_background_checks
    ADD CONSTRAINT candidate_background_checks_placement_id_fkey FOREIGN KEY (placement_id) REFERENCES public.placements(id) ON DELETE SET NULL;


--
-- Name: candidate_background_checks candidate_background_checks_submission_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_background_checks
    ADD CONSTRAINT candidate_background_checks_submission_id_fkey FOREIGN KEY (submission_id) REFERENCES public.submissions(id) ON DELETE SET NULL;


--
-- Name: candidate_certifications candidate_certifications_candidate_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_certifications
    ADD CONSTRAINT candidate_certifications_candidate_id_fkey FOREIGN KEY (candidate_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: candidate_certifications candidate_certifications_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_certifications
    ADD CONSTRAINT candidate_certifications_contact_id_fkey FOREIGN KEY (contact_id) REFERENCES public.contacts(id);


--
-- Name: candidate_certifications candidate_certifications_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_certifications
    ADD CONSTRAINT candidate_certifications_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: candidate_compliance_documents candidate_compliance_documents_candidate_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_compliance_documents
    ADD CONSTRAINT candidate_compliance_documents_candidate_id_fkey FOREIGN KEY (candidate_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: candidate_compliance_documents candidate_compliance_documents_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_compliance_documents
    ADD CONSTRAINT candidate_compliance_documents_contact_id_fkey FOREIGN KEY (contact_id) REFERENCES public.contacts(id);


--
-- Name: candidate_compliance_documents candidate_compliance_documents_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_compliance_documents
    ADD CONSTRAINT candidate_compliance_documents_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: candidate_compliance_documents candidate_compliance_documents_placement_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_compliance_documents
    ADD CONSTRAINT candidate_compliance_documents_placement_id_fkey FOREIGN KEY (placement_id) REFERENCES public.placements(id) ON DELETE SET NULL;


--
-- Name: candidate_compliance_documents candidate_compliance_documents_submission_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_compliance_documents
    ADD CONSTRAINT candidate_compliance_documents_submission_id_fkey FOREIGN KEY (submission_id) REFERENCES public.submissions(id) ON DELETE SET NULL;


--
-- Name: candidate_documents candidate_documents_candidate_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_documents
    ADD CONSTRAINT candidate_documents_candidate_id_fkey FOREIGN KEY (candidate_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: candidate_documents candidate_documents_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_documents
    ADD CONSTRAINT candidate_documents_contact_id_fkey FOREIGN KEY (contact_id) REFERENCES public.contacts(id);


--
-- Name: candidate_documents candidate_documents_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_documents
    ADD CONSTRAINT candidate_documents_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: candidate_education candidate_education_candidate_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_education
    ADD CONSTRAINT candidate_education_candidate_id_fkey FOREIGN KEY (candidate_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: candidate_education candidate_education_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_education
    ADD CONSTRAINT candidate_education_contact_id_fkey FOREIGN KEY (contact_id) REFERENCES public.contacts(id);


--
-- Name: candidate_education candidate_education_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_education
    ADD CONSTRAINT candidate_education_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: candidate_embeddings candidate_embeddings_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_embeddings
    ADD CONSTRAINT candidate_embeddings_contact_id_fkey FOREIGN KEY (contact_id) REFERENCES public.contacts(id);


--
-- Name: candidate_embeddings candidate_embeddings_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_embeddings
    ADD CONSTRAINT candidate_embeddings_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: candidate_preferences candidate_preferences_candidate_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_preferences
    ADD CONSTRAINT candidate_preferences_candidate_id_fkey FOREIGN KEY (candidate_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: candidate_preferences candidate_preferences_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_preferences
    ADD CONSTRAINT candidate_preferences_contact_id_fkey FOREIGN KEY (contact_id) REFERENCES public.contacts(id);


--
-- Name: candidate_preferences candidate_preferences_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_preferences
    ADD CONSTRAINT candidate_preferences_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: candidate_prepared_profiles candidate_prepared_profiles_candidate_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_prepared_profiles
    ADD CONSTRAINT candidate_prepared_profiles_candidate_id_fkey FOREIGN KEY (candidate_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: candidate_prepared_profiles candidate_prepared_profiles_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_prepared_profiles
    ADD CONSTRAINT candidate_prepared_profiles_contact_id_fkey FOREIGN KEY (contact_id) REFERENCES public.contacts(id);


--
-- Name: candidate_prepared_profiles candidate_prepared_profiles_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_prepared_profiles
    ADD CONSTRAINT candidate_prepared_profiles_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: candidate_prepared_profiles candidate_prepared_profiles_finalized_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_prepared_profiles
    ADD CONSTRAINT candidate_prepared_profiles_finalized_by_fkey FOREIGN KEY (finalized_by) REFERENCES public.user_profiles(id);


--
-- Name: candidate_prepared_profiles candidate_prepared_profiles_job_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_prepared_profiles
    ADD CONSTRAINT candidate_prepared_profiles_job_id_fkey FOREIGN KEY (job_id) REFERENCES public.jobs(id) ON DELETE SET NULL;


--
-- Name: candidate_prepared_profiles candidate_prepared_profiles_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_prepared_profiles
    ADD CONSTRAINT candidate_prepared_profiles_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: candidate_profiles candidate_profiles_candidate_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_profiles
    ADD CONSTRAINT candidate_profiles_candidate_id_fkey FOREIGN KEY (candidate_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: candidate_profiles candidate_profiles_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_profiles
    ADD CONSTRAINT candidate_profiles_contact_id_fkey FOREIGN KEY (contact_id) REFERENCES public.contacts(id);


--
-- Name: candidate_profiles candidate_profiles_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_profiles
    ADD CONSTRAINT candidate_profiles_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: candidate_references candidate_references_candidate_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_references
    ADD CONSTRAINT candidate_references_candidate_id_fkey FOREIGN KEY (candidate_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: candidate_references candidate_references_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_references
    ADD CONSTRAINT candidate_references_contact_id_fkey FOREIGN KEY (contact_id) REFERENCES public.contacts(id);


--
-- Name: candidate_references candidate_references_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_references
    ADD CONSTRAINT candidate_references_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: candidate_resumes candidate_resumes_archived_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_resumes
    ADD CONSTRAINT candidate_resumes_archived_by_fkey FOREIGN KEY (archived_by) REFERENCES public.user_profiles(id);


--
-- Name: candidate_resumes candidate_resumes_candidate_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_resumes
    ADD CONSTRAINT candidate_resumes_candidate_id_fkey FOREIGN KEY (candidate_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: candidate_resumes candidate_resumes_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_resumes
    ADD CONSTRAINT candidate_resumes_contact_id_fkey FOREIGN KEY (contact_id) REFERENCES public.contacts(id);


--
-- Name: candidate_resumes candidate_resumes_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_resumes
    ADD CONSTRAINT candidate_resumes_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: candidate_resumes candidate_resumes_previous_version_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_resumes
    ADD CONSTRAINT candidate_resumes_previous_version_id_fkey FOREIGN KEY (previous_version_id) REFERENCES public.candidate_resumes(id);


--
-- Name: candidate_resumes candidate_resumes_uploaded_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_resumes
    ADD CONSTRAINT candidate_resumes_uploaded_by_fkey FOREIGN KEY (uploaded_by) REFERENCES public.user_profiles(id);


--
-- Name: candidate_screenings candidate_screenings_candidate_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_screenings
    ADD CONSTRAINT candidate_screenings_candidate_id_fkey FOREIGN KEY (candidate_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: candidate_screenings candidate_screenings_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_screenings
    ADD CONSTRAINT candidate_screenings_contact_id_fkey FOREIGN KEY (contact_id) REFERENCES public.contacts(id);


--
-- Name: candidate_screenings candidate_screenings_job_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_screenings
    ADD CONSTRAINT candidate_screenings_job_id_fkey FOREIGN KEY (job_id) REFERENCES public.jobs(id) ON DELETE SET NULL;


--
-- Name: candidate_screenings candidate_screenings_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_screenings
    ADD CONSTRAINT candidate_screenings_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: candidate_screenings candidate_screenings_screener_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_screenings
    ADD CONSTRAINT candidate_screenings_screener_id_fkey FOREIGN KEY (screener_id) REFERENCES public.user_profiles(id);


--
-- Name: candidate_screenings candidate_screenings_submission_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_screenings
    ADD CONSTRAINT candidate_screenings_submission_id_fkey FOREIGN KEY (submission_id) REFERENCES public.submissions(id) ON DELETE SET NULL;


--
-- Name: candidate_skills candidate_skills_candidate_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_skills
    ADD CONSTRAINT candidate_skills_candidate_id_fkey FOREIGN KEY (candidate_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: candidate_skills candidate_skills_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_skills
    ADD CONSTRAINT candidate_skills_contact_id_fkey FOREIGN KEY (contact_id) REFERENCES public.contacts(id);


--
-- Name: candidate_skills candidate_skills_skill_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_skills
    ADD CONSTRAINT candidate_skills_skill_id_fkey FOREIGN KEY (skill_id) REFERENCES public.skills(id);


--
-- Name: candidate_work_authorizations candidate_work_authorizations_candidate_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_work_authorizations
    ADD CONSTRAINT candidate_work_authorizations_candidate_id_fkey FOREIGN KEY (candidate_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: candidate_work_authorizations candidate_work_authorizations_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_work_authorizations
    ADD CONSTRAINT candidate_work_authorizations_contact_id_fkey FOREIGN KEY (contact_id) REFERENCES public.contacts(id);


--
-- Name: candidate_work_authorizations candidate_work_authorizations_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_work_authorizations
    ADD CONSTRAINT candidate_work_authorizations_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: candidate_work_history candidate_work_history_candidate_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_work_history
    ADD CONSTRAINT candidate_work_history_candidate_id_fkey FOREIGN KEY (candidate_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: candidate_work_history candidate_work_history_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_work_history
    ADD CONSTRAINT candidate_work_history_contact_id_fkey FOREIGN KEY (contact_id) REFERENCES public.contacts(id);


--
-- Name: candidate_work_history candidate_work_history_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.candidate_work_history
    ADD CONSTRAINT candidate_work_history_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: capstone_submissions capstone_submissions_course_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.capstone_submissions
    ADD CONSTRAINT capstone_submissions_course_id_fkey FOREIGN KEY (course_id) REFERENCES public.courses(id) ON DELETE CASCADE;


--
-- Name: capstone_submissions capstone_submissions_enrollment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.capstone_submissions
    ADD CONSTRAINT capstone_submissions_enrollment_id_fkey FOREIGN KEY (enrollment_id) REFERENCES public.student_enrollments(id) ON DELETE CASCADE;


--
-- Name: capstone_submissions capstone_submissions_graded_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.capstone_submissions
    ADD CONSTRAINT capstone_submissions_graded_by_fkey FOREIGN KEY (graded_by) REFERENCES public.user_profiles(id);


--
-- Name: capstone_submissions capstone_submissions_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.capstone_submissions
    ADD CONSTRAINT capstone_submissions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: certificates certificates_enrollment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.certificates
    ADD CONSTRAINT certificates_enrollment_id_fkey FOREIGN KEY (enrollment_id) REFERENCES public.student_enrollments(id);


--
-- Name: certificates certificates_template_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.certificates
    ADD CONSTRAINT certificates_template_id_fkey FOREIGN KEY (template_id) REFERENCES public.certificate_templates(id);


--
-- Name: comments comments_author_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.comments
    ADD CONSTRAINT comments_author_id_fkey FOREIGN KEY (author_id) REFERENCES public.user_profiles(id);


--
-- Name: comments comments_deleted_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.comments
    ADD CONSTRAINT comments_deleted_by_fkey FOREIGN KEY (deleted_by) REFERENCES public.user_profiles(id);


--
-- Name: comments comments_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.comments
    ADD CONSTRAINT comments_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: comments comments_parent_comment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.comments
    ADD CONSTRAINT comments_parent_comment_id_fkey FOREIGN KEY (parent_comment_id) REFERENCES public.comments(id);


--
-- Name: commission_payments commission_payments_commission_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.commission_payments
    ADD CONSTRAINT commission_payments_commission_id_fkey FOREIGN KEY (commission_id) REFERENCES public.commissions(id) ON DELETE CASCADE;


--
-- Name: commission_payments commission_payments_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.commission_payments
    ADD CONSTRAINT commission_payments_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: commission_payments commission_payments_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.commission_payments
    ADD CONSTRAINT commission_payments_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: commissions commissions_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.commissions
    ADD CONSTRAINT commissions_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: commissions commissions_deal_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.commissions
    ADD CONSTRAINT commissions_deal_id_fkey FOREIGN KEY (deal_id) REFERENCES public.deals(id) ON DELETE CASCADE;


--
-- Name: commissions commissions_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.commissions
    ADD CONSTRAINT commissions_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: commissions commissions_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.commissions
    ADD CONSTRAINT commissions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: companies companies_account_manager_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.companies
    ADD CONSTRAINT companies_account_manager_id_fkey FOREIGN KEY (account_manager_id) REFERENCES public.user_profiles(id);


--
-- Name: companies companies_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.companies
    ADD CONSTRAINT companies_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: companies companies_msp_provider_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.companies
    ADD CONSTRAINT companies_msp_provider_id_fkey FOREIGN KEY (msp_provider_id) REFERENCES public.companies(id);


--
-- Name: companies companies_onboarding_completed_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.companies
    ADD CONSTRAINT companies_onboarding_completed_by_fkey FOREIGN KEY (onboarding_completed_by) REFERENCES public.user_profiles(id);


--
-- Name: companies companies_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.companies
    ADD CONSTRAINT companies_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id);


--
-- Name: companies companies_owner_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.companies
    ADD CONSTRAINT companies_owner_id_fkey FOREIGN KEY (owner_id) REFERENCES public.user_profiles(id);


--
-- Name: companies companies_parent_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.companies
    ADD CONSTRAINT companies_parent_company_id_fkey FOREIGN KEY (parent_company_id) REFERENCES public.companies(id);


--
-- Name: companies companies_pod_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.companies
    ADD CONSTRAINT companies_pod_id_fkey FOREIGN KEY (pod_id) REFERENCES public.pods(id);


--
-- Name: companies companies_referring_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.companies
    ADD CONSTRAINT companies_referring_company_id_fkey FOREIGN KEY (referring_company_id) REFERENCES public.companies(id);


--
-- Name: companies companies_updated_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.companies
    ADD CONSTRAINT companies_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES public.user_profiles(id);


--
-- Name: company_addresses company_addresses_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_addresses
    ADD CONSTRAINT company_addresses_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id) ON DELETE CASCADE;


--
-- Name: company_addresses company_addresses_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_addresses
    ADD CONSTRAINT company_addresses_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id);


--
-- Name: company_client_details company_client_details_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_client_details
    ADD CONSTRAINT company_client_details_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id) ON DELETE CASCADE;


--
-- Name: company_client_details company_client_details_executive_sponsor_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_client_details
    ADD CONSTRAINT company_client_details_executive_sponsor_id_fkey FOREIGN KEY (executive_sponsor_id) REFERENCES public.user_profiles(id);


--
-- Name: company_client_details company_client_details_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_client_details
    ADD CONSTRAINT company_client_details_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id);


--
-- Name: company_compliance_requirements company_compliance_requirements_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_compliance_requirements
    ADD CONSTRAINT company_compliance_requirements_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id) ON DELETE CASCADE;


--
-- Name: company_compliance_requirements company_compliance_requirements_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_compliance_requirements
    ADD CONSTRAINT company_compliance_requirements_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id);


--
-- Name: company_compliance_requirements company_compliance_requirements_updated_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_compliance_requirements
    ADD CONSTRAINT company_compliance_requirements_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES public.user_profiles(id);


--
-- Name: company_contacts company_contacts_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_contacts
    ADD CONSTRAINT company_contacts_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id) ON DELETE CASCADE;


--
-- Name: company_contacts company_contacts_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_contacts
    ADD CONSTRAINT company_contacts_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: company_contacts company_contacts_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_contacts
    ADD CONSTRAINT company_contacts_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id);


--
-- Name: company_contacts company_contacts_vendor_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_contacts
    ADD CONSTRAINT company_contacts_vendor_company_id_fkey FOREIGN KEY (vendor_company_id) REFERENCES public.companies(id);


--
-- Name: company_contracts company_contracts_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_contracts
    ADD CONSTRAINT company_contracts_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id) ON DELETE CASCADE;


--
-- Name: company_contracts company_contracts_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_contracts
    ADD CONSTRAINT company_contracts_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: company_contracts company_contracts_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_contracts
    ADD CONSTRAINT company_contracts_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id);


--
-- Name: company_contracts company_contracts_our_signatory_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_contracts
    ADD CONSTRAINT company_contracts_our_signatory_id_fkey FOREIGN KEY (our_signatory_id) REFERENCES public.user_profiles(id);


--
-- Name: company_contracts company_contracts_parent_contract_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_contracts
    ADD CONSTRAINT company_contracts_parent_contract_id_fkey FOREIGN KEY (parent_contract_id) REFERENCES public.company_contracts(id);


--
-- Name: company_health_scores company_health_scores_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_health_scores
    ADD CONSTRAINT company_health_scores_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id) ON DELETE CASCADE;


--
-- Name: company_health_scores company_health_scores_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_health_scores
    ADD CONSTRAINT company_health_scores_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id);


--
-- Name: company_metrics company_metrics_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_metrics
    ADD CONSTRAINT company_metrics_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id) ON DELETE CASCADE;


--
-- Name: company_metrics company_metrics_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_metrics
    ADD CONSTRAINT company_metrics_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id);


--
-- Name: company_notes company_notes_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_notes
    ADD CONSTRAINT company_notes_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id) ON DELETE CASCADE;


--
-- Name: company_notes company_notes_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_notes
    ADD CONSTRAINT company_notes_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: company_notes company_notes_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_notes
    ADD CONSTRAINT company_notes_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id);


--
-- Name: company_partner_details company_partner_details_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_partner_details
    ADD CONSTRAINT company_partner_details_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id) ON DELETE CASCADE;


--
-- Name: company_partner_details company_partner_details_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_partner_details
    ADD CONSTRAINT company_partner_details_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id);


--
-- Name: company_preferences company_preferences_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_preferences
    ADD CONSTRAINT company_preferences_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id) ON DELETE CASCADE;


--
-- Name: company_preferences company_preferences_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_preferences
    ADD CONSTRAINT company_preferences_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id);


--
-- Name: company_preferences company_preferences_updated_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_preferences
    ADD CONSTRAINT company_preferences_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES public.user_profiles(id);


--
-- Name: company_rate_card_items company_rate_card_items_rate_card_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_rate_card_items
    ADD CONSTRAINT company_rate_card_items_rate_card_id_fkey FOREIGN KEY (rate_card_id) REFERENCES public.company_rate_cards(id) ON DELETE CASCADE;


--
-- Name: company_rate_cards company_rate_cards_approved_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_rate_cards
    ADD CONSTRAINT company_rate_cards_approved_by_fkey FOREIGN KEY (approved_by) REFERENCES public.user_profiles(id);


--
-- Name: company_rate_cards company_rate_cards_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_rate_cards
    ADD CONSTRAINT company_rate_cards_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id) ON DELETE CASCADE;


--
-- Name: company_rate_cards company_rate_cards_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_rate_cards
    ADD CONSTRAINT company_rate_cards_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: company_rate_cards company_rate_cards_msp_program_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_rate_cards
    ADD CONSTRAINT company_rate_cards_msp_program_id_fkey FOREIGN KEY (msp_program_id) REFERENCES public.companies(id);


--
-- Name: company_rate_cards company_rate_cards_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_rate_cards
    ADD CONSTRAINT company_rate_cards_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id);


--
-- Name: company_relationships company_relationships_company_a_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_relationships
    ADD CONSTRAINT company_relationships_company_a_id_fkey FOREIGN KEY (company_a_id) REFERENCES public.companies(id);


--
-- Name: company_relationships company_relationships_company_b_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_relationships
    ADD CONSTRAINT company_relationships_company_b_id_fkey FOREIGN KEY (company_b_id) REFERENCES public.companies(id);


--
-- Name: company_relationships company_relationships_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_relationships
    ADD CONSTRAINT company_relationships_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: company_relationships company_relationships_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_relationships
    ADD CONSTRAINT company_relationships_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id);


--
-- Name: company_revenue company_revenue_billing_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_revenue
    ADD CONSTRAINT company_revenue_billing_company_id_fkey FOREIGN KEY (billing_company_id) REFERENCES public.companies(id);


--
-- Name: company_revenue company_revenue_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_revenue
    ADD CONSTRAINT company_revenue_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id);


--
-- Name: company_revenue company_revenue_end_client_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_revenue
    ADD CONSTRAINT company_revenue_end_client_company_id_fkey FOREIGN KEY (end_client_company_id) REFERENCES public.companies(id);


--
-- Name: company_revenue company_revenue_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_revenue
    ADD CONSTRAINT company_revenue_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id);


--
-- Name: company_tags company_tags_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_tags
    ADD CONSTRAINT company_tags_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id) ON DELETE CASCADE;


--
-- Name: company_tags company_tags_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_tags
    ADD CONSTRAINT company_tags_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: company_tags company_tags_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_tags
    ADD CONSTRAINT company_tags_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id);


--
-- Name: company_team company_team_assigned_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_team
    ADD CONSTRAINT company_team_assigned_by_fkey FOREIGN KEY (assigned_by) REFERENCES public.user_profiles(id);


--
-- Name: company_team company_team_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_team
    ADD CONSTRAINT company_team_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id) ON DELETE CASCADE;


--
-- Name: company_team company_team_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_team
    ADD CONSTRAINT company_team_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id);


--
-- Name: company_team company_team_removed_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_team
    ADD CONSTRAINT company_team_removed_by_fkey FOREIGN KEY (removed_by) REFERENCES public.user_profiles(id);


--
-- Name: company_team company_team_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_team
    ADD CONSTRAINT company_team_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id);


--
-- Name: company_vendor_details company_vendor_details_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_vendor_details
    ADD CONSTRAINT company_vendor_details_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id) ON DELETE CASCADE;


--
-- Name: company_vendor_details company_vendor_details_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_vendor_details
    ADD CONSTRAINT company_vendor_details_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id);


--
-- Name: company_vendor_details company_vendor_details_vendor_manager_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.company_vendor_details
    ADD CONSTRAINT company_vendor_details_vendor_manager_id_fkey FOREIGN KEY (vendor_manager_id) REFERENCES public.user_profiles(id);


--
-- Name: compliance_requirements compliance_requirements_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.compliance_requirements
    ADD CONSTRAINT compliance_requirements_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: compliance_requirements compliance_requirements_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.compliance_requirements
    ADD CONSTRAINT compliance_requirements_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: consultant_availability consultant_availability_consultant_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.consultant_availability
    ADD CONSTRAINT consultant_availability_consultant_id_fkey FOREIGN KEY (consultant_id) REFERENCES public.bench_consultants(id) ON DELETE CASCADE;


--
-- Name: consultant_rates consultant_rates_consultant_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.consultant_rates
    ADD CONSTRAINT consultant_rates_consultant_id_fkey FOREIGN KEY (consultant_id) REFERENCES public.bench_consultants(id) ON DELETE CASCADE;


--
-- Name: consultant_rates consultant_rates_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.consultant_rates
    ADD CONSTRAINT consultant_rates_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: consultant_visa_details consultant_visa_details_consultant_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.consultant_visa_details
    ADD CONSTRAINT consultant_visa_details_consultant_id_fkey FOREIGN KEY (consultant_id) REFERENCES public.bench_consultants(id) ON DELETE CASCADE;


--
-- Name: consultant_work_authorization consultant_work_authorization_consultant_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.consultant_work_authorization
    ADD CONSTRAINT consultant_work_authorization_consultant_id_fkey FOREIGN KEY (consultant_id) REFERENCES public.bench_consultants(id) ON DELETE CASCADE;


--
-- Name: consultant_work_authorization consultant_work_authorization_verified_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.consultant_work_authorization
    ADD CONSTRAINT consultant_work_authorization_verified_by_fkey FOREIGN KEY (verified_by) REFERENCES public.user_profiles(id);


--
-- Name: contact_agreements contact_agreements_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_agreements
    ADD CONSTRAINT contact_agreements_contact_id_fkey FOREIGN KEY (contact_id) REFERENCES public.contacts(id) ON DELETE CASCADE;


--
-- Name: contact_agreements contact_agreements_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_agreements
    ADD CONSTRAINT contact_agreements_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: contact_agreements contact_agreements_our_signer_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_agreements
    ADD CONSTRAINT contact_agreements_our_signer_id_fkey FOREIGN KEY (our_signer_id) REFERENCES public.user_profiles(id);


--
-- Name: contact_certifications contact_certifications_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_certifications
    ADD CONSTRAINT contact_certifications_contact_id_fkey FOREIGN KEY (contact_id) REFERENCES public.contacts(id) ON DELETE CASCADE;


--
-- Name: contact_certifications contact_certifications_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_certifications
    ADD CONSTRAINT contact_certifications_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: contact_communication_preferences contact_communication_preferences_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_communication_preferences
    ADD CONSTRAINT contact_communication_preferences_contact_id_fkey FOREIGN KEY (contact_id) REFERENCES public.contacts(id) ON DELETE CASCADE;


--
-- Name: contact_communication_preferences contact_communication_preferences_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_communication_preferences
    ADD CONSTRAINT contact_communication_preferences_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: contact_compliance contact_compliance_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_compliance
    ADD CONSTRAINT contact_compliance_contact_id_fkey FOREIGN KEY (contact_id) REFERENCES public.contacts(id) ON DELETE CASCADE;


--
-- Name: contact_compliance contact_compliance_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_compliance
    ADD CONSTRAINT contact_compliance_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: contact_compliance contact_compliance_verified_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_compliance
    ADD CONSTRAINT contact_compliance_verified_by_fkey FOREIGN KEY (verified_by) REFERENCES public.user_profiles(id);


--
-- Name: contact_education contact_education_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_education
    ADD CONSTRAINT contact_education_contact_id_fkey FOREIGN KEY (contact_id) REFERENCES public.contacts(id) ON DELETE CASCADE;


--
-- Name: contact_education contact_education_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_education
    ADD CONSTRAINT contact_education_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: contact_education contact_education_verified_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_education
    ADD CONSTRAINT contact_education_verified_by_fkey FOREIGN KEY (verified_by) REFERENCES public.user_profiles(id);


--
-- Name: contact_lead_data contact_lead_data_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_lead_data
    ADD CONSTRAINT contact_lead_data_contact_id_fkey FOREIGN KEY (contact_id) REFERENCES public.contacts(id) ON DELETE CASCADE;


--
-- Name: contact_lead_data contact_lead_data_converted_to_account_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_lead_data
    ADD CONSTRAINT contact_lead_data_converted_to_account_id_fkey FOREIGN KEY (converted_to_account_id) REFERENCES public.accounts(id);


--
-- Name: contact_lead_data contact_lead_data_source_campaign_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_lead_data
    ADD CONSTRAINT contact_lead_data_source_campaign_id_fkey FOREIGN KEY (source_campaign_id) REFERENCES public.campaigns(id);


--
-- Name: contact_merge_history contact_merge_history_merged_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_merge_history
    ADD CONSTRAINT contact_merge_history_merged_by_fkey FOREIGN KEY (merged_by) REFERENCES public.user_profiles(id);


--
-- Name: contact_merge_history contact_merge_history_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_merge_history
    ADD CONSTRAINT contact_merge_history_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: contact_merge_history contact_merge_history_survivor_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_merge_history
    ADD CONSTRAINT contact_merge_history_survivor_contact_id_fkey FOREIGN KEY (survivor_contact_id) REFERENCES public.contacts(id);


--
-- Name: contact_rate_cards contact_rate_cards_approved_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_rate_cards
    ADD CONSTRAINT contact_rate_cards_approved_by_fkey FOREIGN KEY (approved_by) REFERENCES public.user_profiles(id);


--
-- Name: contact_rate_cards contact_rate_cards_client_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_rate_cards
    ADD CONSTRAINT contact_rate_cards_client_id_fkey FOREIGN KEY (client_id) REFERENCES public.contacts(id);


--
-- Name: contact_rate_cards contact_rate_cards_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_rate_cards
    ADD CONSTRAINT contact_rate_cards_contact_id_fkey FOREIGN KEY (contact_id) REFERENCES public.contacts(id) ON DELETE CASCADE;


--
-- Name: contact_rate_cards contact_rate_cards_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_rate_cards
    ADD CONSTRAINT contact_rate_cards_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: contact_rate_cards contact_rate_cards_skill_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_rate_cards
    ADD CONSTRAINT contact_rate_cards_skill_id_fkey FOREIGN KEY (skill_id) REFERENCES public.skills(id);


--
-- Name: contact_relationships contact_relationships_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_relationships
    ADD CONSTRAINT contact_relationships_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: contact_relationships contact_relationships_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_relationships
    ADD CONSTRAINT contact_relationships_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: contact_relationships contact_relationships_source_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_relationships
    ADD CONSTRAINT contact_relationships_source_contact_id_fkey FOREIGN KEY (source_contact_id) REFERENCES public.contacts(id) ON DELETE CASCADE;


--
-- Name: contact_relationships contact_relationships_target_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_relationships
    ADD CONSTRAINT contact_relationships_target_contact_id_fkey FOREIGN KEY (target_contact_id) REFERENCES public.contacts(id) ON DELETE CASCADE;


--
-- Name: contact_relationships contact_relationships_updated_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_relationships
    ADD CONSTRAINT contact_relationships_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES public.user_profiles(id);


--
-- Name: contact_roles contact_roles_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_roles
    ADD CONSTRAINT contact_roles_contact_id_fkey FOREIGN KEY (contact_id) REFERENCES public.contacts(id) ON DELETE CASCADE;


--
-- Name: contact_roles contact_roles_context_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_roles
    ADD CONSTRAINT contact_roles_context_company_id_fkey FOREIGN KEY (context_company_id) REFERENCES public.contacts(id);


--
-- Name: contact_roles contact_roles_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_roles
    ADD CONSTRAINT contact_roles_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: contact_roles contact_roles_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_roles
    ADD CONSTRAINT contact_roles_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: contact_skills contact_skills_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_skills
    ADD CONSTRAINT contact_skills_contact_id_fkey FOREIGN KEY (contact_id) REFERENCES public.contacts(id) ON DELETE CASCADE;


--
-- Name: contact_skills contact_skills_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_skills
    ADD CONSTRAINT contact_skills_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: contact_skills contact_skills_skill_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_skills
    ADD CONSTRAINT contact_skills_skill_id_fkey FOREIGN KEY (skill_id) REFERENCES public.skills(id);


--
-- Name: contact_skills contact_skills_verified_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_skills
    ADD CONSTRAINT contact_skills_verified_by_fkey FOREIGN KEY (verified_by) REFERENCES public.user_profiles(id);


--
-- Name: contact_work_history contact_work_history_company_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_work_history
    ADD CONSTRAINT contact_work_history_company_contact_id_fkey FOREIGN KEY (company_contact_id) REFERENCES public.contacts(id);


--
-- Name: contact_work_history contact_work_history_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_work_history
    ADD CONSTRAINT contact_work_history_contact_id_fkey FOREIGN KEY (contact_id) REFERENCES public.contacts(id) ON DELETE CASCADE;


--
-- Name: contact_work_history contact_work_history_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_work_history
    ADD CONSTRAINT contact_work_history_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: contact_work_history contact_work_history_verified_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contact_work_history
    ADD CONSTRAINT contact_work_history_verified_by_fkey FOREIGN KEY (verified_by) REFERENCES public.user_profiles(id);


--
-- Name: contacts contacts_account_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contacts
    ADD CONSTRAINT contacts_account_id_fkey FOREIGN KEY (account_id) REFERENCES public.accounts(id);


--
-- Name: contacts contacts_alumni_former_employee_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contacts
    ADD CONSTRAINT contacts_alumni_former_employee_id_fkey FOREIGN KEY (alumni_former_employee_id) REFERENCES public.employees(id);


--
-- Name: contacts contacts_bench_vendor_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contacts
    ADD CONSTRAINT contacts_bench_vendor_contact_id_fkey FOREIGN KEY (bench_vendor_contact_id) REFERENCES public.contacts(id);


--
-- Name: contacts contacts_bench_vendor_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contacts
    ADD CONSTRAINT contacts_bench_vendor_id_fkey FOREIGN KEY (bench_vendor_id) REFERENCES public.vendors(id);


--
-- Name: contacts contacts_candidate_hotlist_added_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contacts
    ADD CONSTRAINT contacts_candidate_hotlist_added_by_fkey FOREIGN KEY (candidate_hotlist_added_by) REFERENCES public.user_profiles(id);


--
-- Name: contacts contacts_client_contact_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contacts
    ADD CONSTRAINT contacts_client_contact_company_id_fkey FOREIGN KEY (client_contact_company_id) REFERENCES public.accounts(id);


--
-- Name: contacts contacts_client_contact_relationship_owner_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contacts
    ADD CONSTRAINT contacts_client_contact_relationship_owner_id_fkey FOREIGN KEY (client_contact_relationship_owner_id) REFERENCES public.user_profiles(id);


--
-- Name: contacts contacts_client_msp_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contacts
    ADD CONSTRAINT contacts_client_msp_id_fkey FOREIGN KEY (client_msp_id) REFERENCES public.contacts(id);


--
-- Name: contacts contacts_client_team_lead_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contacts
    ADD CONSTRAINT contacts_client_team_lead_id_fkey FOREIGN KEY (client_team_lead_id) REFERENCES public.user_profiles(id);


--
-- Name: contacts contacts_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contacts
    ADD CONSTRAINT contacts_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.accounts(id);


--
-- Name: contacts contacts_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contacts
    ADD CONSTRAINT contacts_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: contacts contacts_current_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contacts
    ADD CONSTRAINT contacts_current_company_id_fkey FOREIGN KEY (current_company_id) REFERENCES public.contacts(id);


--
-- Name: contacts contacts_employee_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contacts
    ADD CONSTRAINT contacts_employee_id_fkey FOREIGN KEY (employee_id) REFERENCES public.employees(id);


--
-- Name: contacts contacts_employer_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contacts
    ADD CONSTRAINT contacts_employer_company_id_fkey FOREIGN KEY (employer_company_id) REFERENCES public.companies(id);


--
-- Name: contacts contacts_lead_converted_to_account_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contacts
    ADD CONSTRAINT contacts_lead_converted_to_account_id_fkey FOREIGN KEY (lead_converted_to_account_id) REFERENCES public.accounts(id);


--
-- Name: contacts contacts_lead_converted_to_deal_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contacts
    ADD CONSTRAINT contacts_lead_converted_to_deal_id_fkey FOREIGN KEY (lead_converted_to_deal_id) REFERENCES public.deals(id);


--
-- Name: contacts contacts_linked_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contacts
    ADD CONSTRAINT contacts_linked_company_id_fkey FOREIGN KEY (linked_company_id) REFERENCES public.companies(id);


--
-- Name: contacts contacts_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contacts
    ADD CONSTRAINT contacts_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: contacts contacts_owner_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contacts
    ADD CONSTRAINT contacts_owner_id_fkey FOREIGN KEY (owner_id) REFERENCES public.user_profiles(id);


--
-- Name: contacts contacts_parent_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contacts
    ADD CONSTRAINT contacts_parent_company_id_fkey FOREIGN KEY (parent_company_id) REFERENCES public.contacts(id);


--
-- Name: contacts contacts_placed_client_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contacts
    ADD CONSTRAINT contacts_placed_client_id_fkey FOREIGN KEY (placed_client_id) REFERENCES public.accounts(id);


--
-- Name: contacts contacts_primary_address_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contacts
    ADD CONSTRAINT contacts_primary_address_id_fkey FOREIGN KEY (primary_address_id) REFERENCES public.addresses(id);


--
-- Name: contacts contacts_prospect_primary_campaign_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contacts
    ADD CONSTRAINT contacts_prospect_primary_campaign_id_fkey FOREIGN KEY (prospect_primary_campaign_id) REFERENCES public.campaigns(id);


--
-- Name: contacts contacts_source_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contacts
    ADD CONSTRAINT contacts_source_company_id_fkey FOREIGN KEY (source_company_id) REFERENCES public.companies(id);


--
-- Name: contacts contacts_ultimate_parent_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contacts
    ADD CONSTRAINT contacts_ultimate_parent_id_fkey FOREIGN KEY (ultimate_parent_id) REFERENCES public.contacts(id);


--
-- Name: contacts contacts_updated_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contacts
    ADD CONSTRAINT contacts_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES public.user_profiles(id);


--
-- Name: contacts contacts_user_profile_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contacts
    ADD CONSTRAINT contacts_user_profile_id_fkey FOREIGN KEY (user_profile_id) REFERENCES public.user_profiles(id);


--
-- Name: contacts contacts_vendor_approved_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contacts
    ADD CONSTRAINT contacts_vendor_approved_by_fkey FOREIGN KEY (vendor_approved_by) REFERENCES public.user_profiles(id);


--
-- Name: contacts contacts_vendor_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contacts
    ADD CONSTRAINT contacts_vendor_company_id_fkey FOREIGN KEY (vendor_company_id) REFERENCES public.companies(id);


--
-- Name: contacts contacts_vendor_contact_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contacts
    ADD CONSTRAINT contacts_vendor_contact_company_id_fkey FOREIGN KEY (vendor_contact_company_id) REFERENCES public.vendors(id);


--
-- Name: contacts contacts_vendor_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contacts
    ADD CONSTRAINT contacts_vendor_id_fkey FOREIGN KEY (vendor_id) REFERENCES public.vendors(id);


--
-- Name: content_assets content_assets_lesson_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.content_assets
    ADD CONSTRAINT content_assets_lesson_id_fkey FOREIGN KEY (lesson_id) REFERENCES public.topic_lessons(id) ON DELETE SET NULL;


--
-- Name: content_assets content_assets_replaced_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.content_assets
    ADD CONSTRAINT content_assets_replaced_by_fkey FOREIGN KEY (replaced_by) REFERENCES public.content_assets(id) ON DELETE SET NULL;


--
-- Name: content_assets content_assets_topic_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.content_assets
    ADD CONSTRAINT content_assets_topic_id_fkey FOREIGN KEY (topic_id) REFERENCES public.module_topics(id) ON DELETE SET NULL;


--
-- Name: content_assets content_assets_uploaded_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.content_assets
    ADD CONSTRAINT content_assets_uploaded_by_fkey FOREIGN KEY (uploaded_by) REFERENCES public.user_profiles(id) ON DELETE SET NULL;


--
-- Name: course_modules course_modules_course_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.course_modules
    ADD CONSTRAINT course_modules_course_id_fkey FOREIGN KEY (course_id) REFERENCES public.courses(id) ON DELETE CASCADE;


--
-- Name: course_pricing course_pricing_course_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.course_pricing
    ADD CONSTRAINT course_pricing_course_id_fkey FOREIGN KEY (course_id) REFERENCES public.courses(id) ON DELETE CASCADE;


--
-- Name: courses courses_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.courses
    ADD CONSTRAINT courses_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: deal_competitors deal_competitors_deal_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.deal_competitors
    ADD CONSTRAINT deal_competitors_deal_id_fkey FOREIGN KEY (deal_id) REFERENCES public.deals(id) ON DELETE CASCADE;


--
-- Name: deal_products deal_products_deal_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.deal_products
    ADD CONSTRAINT deal_products_deal_id_fkey FOREIGN KEY (deal_id) REFERENCES public.deals(id) ON DELETE CASCADE;


--
-- Name: deal_stages_history deal_stages_history_changed_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.deal_stages_history
    ADD CONSTRAINT deal_stages_history_changed_by_fkey FOREIGN KEY (changed_by) REFERENCES public.user_profiles(id);


--
-- Name: deal_stages_history deal_stages_history_deal_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.deal_stages_history
    ADD CONSTRAINT deal_stages_history_deal_id_fkey FOREIGN KEY (deal_id) REFERENCES public.deals(id) ON DELETE CASCADE;


--
-- Name: deal_stakeholders deal_stakeholders_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.deal_stakeholders
    ADD CONSTRAINT deal_stakeholders_contact_id_fkey FOREIGN KEY (contact_id) REFERENCES public.contacts(id);


--
-- Name: deal_stakeholders deal_stakeholders_deal_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.deal_stakeholders
    ADD CONSTRAINT deal_stakeholders_deal_id_fkey FOREIGN KEY (deal_id) REFERENCES public.deals(id) ON DELETE CASCADE;


--
-- Name: deals deals_account_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.deals
    ADD CONSTRAINT deals_account_id_fkey FOREIGN KEY (account_id) REFERENCES public.accounts(id);


--
-- Name: deals deals_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.deals
    ADD CONSTRAINT deals_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id);


--
-- Name: deals deals_created_account_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.deals
    ADD CONSTRAINT deals_created_account_id_fkey FOREIGN KEY (created_account_id) REFERENCES public.accounts(id);


--
-- Name: deals deals_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.deals
    ADD CONSTRAINT deals_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: deals deals_lead_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.deals
    ADD CONSTRAINT deals_lead_id_fkey FOREIGN KEY (lead_id) REFERENCES public.leads(id);


--
-- Name: deals deals_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.deals
    ADD CONSTRAINT deals_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: deals deals_owner_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.deals
    ADD CONSTRAINT deals_owner_id_fkey FOREIGN KEY (owner_id) REFERENCES public.user_profiles(id);


--
-- Name: deals deals_pod_manager_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.deals
    ADD CONSTRAINT deals_pod_manager_id_fkey FOREIGN KEY (pod_manager_id) REFERENCES public.user_profiles(id);


--
-- Name: deals deals_secondary_owner_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.deals
    ADD CONSTRAINT deals_secondary_owner_id_fkey FOREIGN KEY (secondary_owner_id) REFERENCES public.user_profiles(id);


--
-- Name: discount_code_usage discount_code_usage_discount_code_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.discount_code_usage
    ADD CONSTRAINT discount_code_usage_discount_code_id_fkey FOREIGN KEY (discount_code_id) REFERENCES public.discount_codes(id) ON DELETE CASCADE;


--
-- Name: discount_code_usage discount_code_usage_enrollment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.discount_code_usage
    ADD CONSTRAINT discount_code_usage_enrollment_id_fkey FOREIGN KEY (enrollment_id) REFERENCES public.student_enrollments(id);


--
-- Name: discount_code_usage discount_code_usage_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.discount_code_usage
    ADD CONSTRAINT discount_code_usage_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id);


--
-- Name: discount_codes discount_codes_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.discount_codes
    ADD CONSTRAINT discount_codes_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: document_templates document_templates_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.document_templates
    ADD CONSTRAINT document_templates_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: document_templates document_templates_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.document_templates
    ADD CONSTRAINT document_templates_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: duplicate_records duplicate_records_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.duplicate_records
    ADD CONSTRAINT duplicate_records_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: duplicate_records duplicate_records_reviewed_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.duplicate_records
    ADD CONSTRAINT duplicate_records_reviewed_by_fkey FOREIGN KEY (reviewed_by) REFERENCES public.user_profiles(id);


--
-- Name: duplicate_rules duplicate_rules_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.duplicate_rules
    ADD CONSTRAINT duplicate_rules_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: duplicate_rules duplicate_rules_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.duplicate_rules
    ADD CONSTRAINT duplicate_rules_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: email_logs email_logs_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.email_logs
    ADD CONSTRAINT email_logs_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: email_logs email_logs_template_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.email_logs
    ADD CONSTRAINT email_logs_template_id_fkey FOREIGN KEY (template_id) REFERENCES public.email_templates(id);


--
-- Name: email_senders email_senders_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.email_senders
    ADD CONSTRAINT email_senders_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: email_senders email_senders_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.email_senders
    ADD CONSTRAINT email_senders_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: email_sends email_sends_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.email_sends
    ADD CONSTRAINT email_sends_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: email_sends email_sends_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.email_sends
    ADD CONSTRAINT email_sends_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: email_sends email_sends_template_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.email_sends
    ADD CONSTRAINT email_sends_template_id_fkey FOREIGN KEY (template_id) REFERENCES public.email_templates(id) ON DELETE SET NULL;


--
-- Name: email_templates email_templates_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.email_templates
    ADD CONSTRAINT email_templates_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: email_templates email_templates_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.email_templates
    ADD CONSTRAINT email_templates_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: email_templates email_templates_updated_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.email_templates
    ADD CONSTRAINT email_templates_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES public.user_profiles(id);


--
-- Name: emergency_drills emergency_drills_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.emergency_drills
    ADD CONSTRAINT emergency_drills_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: emergency_drills emergency_drills_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.emergency_drills
    ADD CONSTRAINT emergency_drills_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: emergency_drills emergency_drills_updated_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.emergency_drills
    ADD CONSTRAINT emergency_drills_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES public.user_profiles(id);


--
-- Name: employee_benefits employee_benefits_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.employee_benefits
    ADD CONSTRAINT employee_benefits_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: employee_benefits employee_benefits_employee_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.employee_benefits
    ADD CONSTRAINT employee_benefits_employee_id_fkey FOREIGN KEY (employee_id) REFERENCES public.employees(id) ON DELETE CASCADE;


--
-- Name: employee_benefits employee_benefits_plan_option_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.employee_benefits
    ADD CONSTRAINT employee_benefits_plan_option_id_fkey FOREIGN KEY (plan_option_id) REFERENCES public.benefit_plan_options(id);


--
-- Name: employee_compliance employee_compliance_employee_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.employee_compliance
    ADD CONSTRAINT employee_compliance_employee_id_fkey FOREIGN KEY (employee_id) REFERENCES public.employees(id) ON DELETE CASCADE;


--
-- Name: employee_compliance employee_compliance_requirement_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.employee_compliance
    ADD CONSTRAINT employee_compliance_requirement_id_fkey FOREIGN KEY (requirement_id) REFERENCES public.compliance_requirements(id);


--
-- Name: employee_documents employee_documents_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.employee_documents
    ADD CONSTRAINT employee_documents_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: employee_documents employee_documents_employee_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.employee_documents
    ADD CONSTRAINT employee_documents_employee_id_fkey FOREIGN KEY (employee_id) REFERENCES public.employees(id) ON DELETE CASCADE;


--
-- Name: employee_documents employee_documents_verified_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.employee_documents
    ADD CONSTRAINT employee_documents_verified_by_fkey FOREIGN KEY (verified_by) REFERENCES public.user_profiles(id);


--
-- Name: employee_metadata employee_metadata_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.employee_metadata
    ADD CONSTRAINT employee_metadata_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: employee_onboarding employee_onboarding_assigned_to_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.employee_onboarding
    ADD CONSTRAINT employee_onboarding_assigned_to_fkey FOREIGN KEY (assigned_to) REFERENCES public.user_profiles(id);


--
-- Name: employee_onboarding employee_onboarding_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.employee_onboarding
    ADD CONSTRAINT employee_onboarding_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: employee_onboarding employee_onboarding_employee_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.employee_onboarding
    ADD CONSTRAINT employee_onboarding_employee_id_fkey FOREIGN KEY (employee_id) REFERENCES public.employees(id) ON DELETE CASCADE;


--
-- Name: employee_profiles employee_profiles_employee_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.employee_profiles
    ADD CONSTRAINT employee_profiles_employee_id_fkey FOREIGN KEY (employee_id) REFERENCES public.employees(id) ON DELETE CASCADE;


--
-- Name: employee_screenshots employee_screenshots_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.employee_screenshots
    ADD CONSTRAINT employee_screenshots_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: employee_time_off employee_time_off_approved_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.employee_time_off
    ADD CONSTRAINT employee_time_off_approved_by_fkey FOREIGN KEY (approved_by) REFERENCES public.user_profiles(id);


--
-- Name: employee_time_off employee_time_off_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.employee_time_off
    ADD CONSTRAINT employee_time_off_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: employee_time_off employee_time_off_employee_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.employee_time_off
    ADD CONSTRAINT employee_time_off_employee_id_fkey FOREIGN KEY (employee_id) REFERENCES public.employees(id) ON DELETE CASCADE;


--
-- Name: employee_twin_interactions employee_twin_interactions_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.employee_twin_interactions
    ADD CONSTRAINT employee_twin_interactions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: employees employees_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.employees
    ADD CONSTRAINT employees_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: employees employees_manager_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.employees
    ADD CONSTRAINT employees_manager_id_fkey FOREIGN KEY (manager_id) REFERENCES public.employees(id);


--
-- Name: employees employees_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.employees
    ADD CONSTRAINT employees_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: employees employees_updated_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.employees
    ADD CONSTRAINT employees_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES public.user_profiles(id);


--
-- Name: employees employees_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.employees
    ADD CONSTRAINT employees_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: escalation_notifications escalation_notifications_escalation_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.escalation_notifications
    ADD CONSTRAINT escalation_notifications_escalation_id_fkey FOREIGN KEY (escalation_id) REFERENCES public.ai_mentor_escalations(id) ON DELETE CASCADE;


--
-- Name: escalation_notifications escalation_notifications_recipient_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.escalation_notifications
    ADD CONSTRAINT escalation_notifications_recipient_id_fkey FOREIGN KEY (recipient_id) REFERENCES public.user_profiles(id) ON DELETE SET NULL;


--
-- Name: escalation_updates escalation_updates_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.escalation_updates
    ADD CONSTRAINT escalation_updates_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: escalation_updates escalation_updates_escalation_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.escalation_updates
    ADD CONSTRAINT escalation_updates_escalation_id_fkey FOREIGN KEY (escalation_id) REFERENCES public.escalations(id) ON DELETE CASCADE;


--
-- Name: escalation_updates escalation_updates_new_assignee_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.escalation_updates
    ADD CONSTRAINT escalation_updates_new_assignee_id_fkey FOREIGN KEY (new_assignee_id) REFERENCES public.user_profiles(id);


--
-- Name: escalation_updates escalation_updates_old_assignee_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.escalation_updates
    ADD CONSTRAINT escalation_updates_old_assignee_id_fkey FOREIGN KEY (old_assignee_id) REFERENCES public.user_profiles(id);


--
-- Name: escalations escalations_account_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.escalations
    ADD CONSTRAINT escalations_account_id_fkey FOREIGN KEY (account_id) REFERENCES public.accounts(id) ON DELETE CASCADE;


--
-- Name: escalations escalations_assigned_to_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.escalations
    ADD CONSTRAINT escalations_assigned_to_fkey FOREIGN KEY (assigned_to) REFERENCES public.user_profiles(id);


--
-- Name: escalations escalations_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.escalations
    ADD CONSTRAINT escalations_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: escalations escalations_escalated_to_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.escalations
    ADD CONSTRAINT escalations_escalated_to_fkey FOREIGN KEY (escalated_to) REFERENCES public.user_profiles(id);


--
-- Name: escalations escalations_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.escalations
    ADD CONSTRAINT escalations_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: escalations escalations_resolved_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.escalations
    ADD CONSTRAINT escalations_resolved_by_fkey FOREIGN KEY (resolved_by) REFERENCES public.user_profiles(id);


--
-- Name: event_delivery_log event_delivery_log_event_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.event_delivery_log
    ADD CONSTRAINT event_delivery_log_event_id_fkey FOREIGN KEY (event_id) REFERENCES public.events(id) ON DELETE CASCADE;


--
-- Name: event_delivery_log event_delivery_log_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.event_delivery_log
    ADD CONSTRAINT event_delivery_log_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: event_delivery_log event_delivery_log_subscription_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.event_delivery_log
    ADD CONSTRAINT event_delivery_log_subscription_id_fkey FOREIGN KEY (subscription_id) REFERENCES public.event_subscriptions(id) ON DELETE CASCADE;


--
-- Name: event_subscriptions event_subscriptions_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.event_subscriptions
    ADD CONSTRAINT event_subscriptions_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: event_subscriptions event_subscriptions_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.event_subscriptions
    ADD CONSTRAINT event_subscriptions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: events events_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.events
    ADD CONSTRAINT events_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: events events_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.events
    ADD CONSTRAINT events_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id);


--
-- Name: export_jobs export_jobs_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.export_jobs
    ADD CONSTRAINT export_jobs_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: export_jobs export_jobs_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.export_jobs
    ADD CONSTRAINT export_jobs_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: external_job_orders external_job_orders_vendor_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.external_job_orders
    ADD CONSTRAINT external_job_orders_vendor_company_id_fkey FOREIGN KEY (vendor_company_id) REFERENCES public.companies(id);


--
-- Name: feature_flag_categories feature_flag_categories_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feature_flag_categories
    ADD CONSTRAINT feature_flag_categories_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: feature_flag_feedback feature_flag_feedback_feature_flag_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feature_flag_feedback
    ADD CONSTRAINT feature_flag_feedback_feature_flag_id_fkey FOREIGN KEY (feature_flag_id) REFERENCES public.feature_flags(id) ON DELETE CASCADE;


--
-- Name: feature_flag_feedback feature_flag_feedback_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feature_flag_feedback
    ADD CONSTRAINT feature_flag_feedback_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: feature_flag_feedback feature_flag_feedback_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feature_flag_feedback
    ADD CONSTRAINT feature_flag_feedback_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: feature_flag_roles feature_flag_roles_feature_flag_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feature_flag_roles
    ADD CONSTRAINT feature_flag_roles_feature_flag_id_fkey FOREIGN KEY (feature_flag_id) REFERENCES public.feature_flags(id) ON DELETE CASCADE;


--
-- Name: feature_flag_roles feature_flag_roles_role_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feature_flag_roles
    ADD CONSTRAINT feature_flag_roles_role_id_fkey FOREIGN KEY (role_id) REFERENCES public.system_roles(id) ON DELETE CASCADE;


--
-- Name: feature_flag_usage feature_flag_usage_feature_flag_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feature_flag_usage
    ADD CONSTRAINT feature_flag_usage_feature_flag_id_fkey FOREIGN KEY (feature_flag_id) REFERENCES public.feature_flags(id) ON DELETE CASCADE;


--
-- Name: feature_flag_usage feature_flag_usage_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feature_flag_usage
    ADD CONSTRAINT feature_flag_usage_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: feature_flag_usage feature_flag_usage_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feature_flag_usage
    ADD CONSTRAINT feature_flag_usage_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: feature_flags feature_flags_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feature_flags
    ADD CONSTRAINT feature_flags_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: feature_flags feature_flags_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feature_flags
    ADD CONSTRAINT feature_flags_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: feature_flags feature_flags_updated_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.feature_flags
    ADD CONSTRAINT feature_flags_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES public.user_profiles(id);


--
-- Name: file_uploads file_uploads_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.file_uploads
    ADD CONSTRAINT file_uploads_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: file_uploads file_uploads_uploaded_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.file_uploads
    ADD CONSTRAINT file_uploads_uploaded_by_fkey FOREIGN KEY (uploaded_by) REFERENCES public.user_profiles(id);


--
-- Name: employee_metadata fk_employee_pod; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.employee_metadata
    ADD CONSTRAINT fk_employee_pod FOREIGN KEY (pod_id) REFERENCES public.pods(id);


--
-- Name: leads fk_leads_converted_to_deal; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.leads
    ADD CONSTRAINT fk_leads_converted_to_deal FOREIGN KEY (converted_to_deal_id) REFERENCES public.deals(id);


--
-- Name: gdpr_requests gdpr_requests_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.gdpr_requests
    ADD CONSTRAINT gdpr_requests_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: gdpr_requests gdpr_requests_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.gdpr_requests
    ADD CONSTRAINT gdpr_requests_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: gdpr_requests gdpr_requests_processed_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.gdpr_requests
    ADD CONSTRAINT gdpr_requests_processed_by_fkey FOREIGN KEY (processed_by) REFERENCES public.user_profiles(id);


--
-- Name: generated_documents generated_documents_generated_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.generated_documents
    ADD CONSTRAINT generated_documents_generated_by_fkey FOREIGN KEY (generated_by) REFERENCES public.user_profiles(id);


--
-- Name: generated_documents generated_documents_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.generated_documents
    ADD CONSTRAINT generated_documents_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: generated_documents generated_documents_template_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.generated_documents
    ADD CONSTRAINT generated_documents_template_id_fkey FOREIGN KEY (template_id) REFERENCES public.document_templates(id);


--
-- Name: generated_resumes generated_resumes_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.generated_resumes
    ADD CONSTRAINT generated_resumes_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: generated_resumes generated_resumes_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.generated_resumes
    ADD CONSTRAINT generated_resumes_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: graduate_candidates graduate_candidates_assigned_recruiter_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.graduate_candidates
    ADD CONSTRAINT graduate_candidates_assigned_recruiter_id_fkey FOREIGN KEY (assigned_recruiter_id) REFERENCES public.user_profiles(id);


--
-- Name: graduate_candidates graduate_candidates_course_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.graduate_candidates
    ADD CONSTRAINT graduate_candidates_course_id_fkey FOREIGN KEY (course_id) REFERENCES public.courses(id);


--
-- Name: graduate_candidates graduate_candidates_enrollment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.graduate_candidates
    ADD CONSTRAINT graduate_candidates_enrollment_id_fkey FOREIGN KEY (enrollment_id) REFERENCES public.student_enrollments(id);


--
-- Name: graduate_candidates graduate_candidates_status_changed_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.graduate_candidates
    ADD CONSTRAINT graduate_candidates_status_changed_by_fkey FOREIGN KEY (status_changed_by) REFERENCES public.user_profiles(id);


--
-- Name: graduate_candidates graduate_candidates_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.graduate_candidates
    ADD CONSTRAINT graduate_candidates_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id);


--
-- Name: guru_interactions guru_interactions_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.guru_interactions
    ADD CONSTRAINT guru_interactions_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: guru_interactions guru_interactions_student_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.guru_interactions
    ADD CONSTRAINT guru_interactions_student_id_fkey FOREIGN KEY (student_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: hotlist_consultants hotlist_consultants_added_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.hotlist_consultants
    ADD CONSTRAINT hotlist_consultants_added_by_fkey FOREIGN KEY (added_by) REFERENCES public.user_profiles(id);


--
-- Name: hotlist_consultants hotlist_consultants_consultant_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.hotlist_consultants
    ADD CONSTRAINT hotlist_consultants_consultant_id_fkey FOREIGN KEY (consultant_id) REFERENCES public.bench_consultants(id) ON DELETE CASCADE;


--
-- Name: i9_records i9_records_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.i9_records
    ADD CONSTRAINT i9_records_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: i9_records i9_records_employee_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.i9_records
    ADD CONSTRAINT i9_records_employee_id_fkey FOREIGN KEY (employee_id) REFERENCES public.employees(id) ON DELETE CASCADE;


--
-- Name: immigration_alerts immigration_alerts_acknowledged_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.immigration_alerts
    ADD CONSTRAINT immigration_alerts_acknowledged_by_fkey FOREIGN KEY (acknowledged_by) REFERENCES public.user_profiles(id);


--
-- Name: immigration_alerts immigration_alerts_consultant_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.immigration_alerts
    ADD CONSTRAINT immigration_alerts_consultant_id_fkey FOREIGN KEY (consultant_id) REFERENCES public.bench_consultants(id) ON DELETE CASCADE;


--
-- Name: immigration_attorneys immigration_attorneys_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.immigration_attorneys
    ADD CONSTRAINT immigration_attorneys_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: immigration_documents immigration_documents_verified_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.immigration_documents
    ADD CONSTRAINT immigration_documents_verified_by_fkey FOREIGN KEY (verified_by) REFERENCES public.user_profiles(id);


--
-- Name: import_jobs import_jobs_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.import_jobs
    ADD CONSTRAINT import_jobs_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: import_jobs import_jobs_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.import_jobs
    ADD CONSTRAINT import_jobs_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: incident_notifications incident_notifications_incident_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.incident_notifications
    ADD CONSTRAINT incident_notifications_incident_id_fkey FOREIGN KEY (incident_id) REFERENCES public.incidents(id) ON DELETE CASCADE;


--
-- Name: incident_notifications incident_notifications_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.incident_notifications
    ADD CONSTRAINT incident_notifications_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: incident_notifications incident_notifications_sent_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.incident_notifications
    ADD CONSTRAINT incident_notifications_sent_by_fkey FOREIGN KEY (sent_by) REFERENCES public.user_profiles(id);


--
-- Name: incident_timeline incident_timeline_incident_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.incident_timeline
    ADD CONSTRAINT incident_timeline_incident_id_fkey FOREIGN KEY (incident_id) REFERENCES public.incidents(id) ON DELETE CASCADE;


--
-- Name: incident_timeline incident_timeline_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.incident_timeline
    ADD CONSTRAINT incident_timeline_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: incident_timeline incident_timeline_performed_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.incident_timeline
    ADD CONSTRAINT incident_timeline_performed_by_fkey FOREIGN KEY (performed_by) REFERENCES public.user_profiles(id);


--
-- Name: incidents incidents_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.incidents
    ADD CONSTRAINT incidents_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: incidents incidents_incident_commander_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.incidents
    ADD CONSTRAINT incidents_incident_commander_fkey FOREIGN KEY (incident_commander) REFERENCES public.user_profiles(id);


--
-- Name: incidents incidents_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.incidents
    ADD CONSTRAINT incidents_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: incidents incidents_updated_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.incidents
    ADD CONSTRAINT incidents_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES public.user_profiles(id);


--
-- Name: integration_failover_config integration_failover_config_backup_integration_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.integration_failover_config
    ADD CONSTRAINT integration_failover_config_backup_integration_id_fkey FOREIGN KEY (backup_integration_id) REFERENCES public.integrations(id);


--
-- Name: integration_failover_config integration_failover_config_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.integration_failover_config
    ADD CONSTRAINT integration_failover_config_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: integration_failover_config integration_failover_config_primary_integration_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.integration_failover_config
    ADD CONSTRAINT integration_failover_config_primary_integration_id_fkey FOREIGN KEY (primary_integration_id) REFERENCES public.integrations(id);


--
-- Name: integration_health_logs integration_health_logs_checked_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.integration_health_logs
    ADD CONSTRAINT integration_health_logs_checked_by_fkey FOREIGN KEY (checked_by) REFERENCES public.user_profiles(id);


--
-- Name: integration_health_logs integration_health_logs_integration_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.integration_health_logs
    ADD CONSTRAINT integration_health_logs_integration_id_fkey FOREIGN KEY (integration_id) REFERENCES public.integrations(id) ON DELETE CASCADE;


--
-- Name: integration_health_logs integration_health_logs_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.integration_health_logs
    ADD CONSTRAINT integration_health_logs_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: integration_oauth_tokens integration_oauth_tokens_integration_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.integration_oauth_tokens
    ADD CONSTRAINT integration_oauth_tokens_integration_id_fkey FOREIGN KEY (integration_id) REFERENCES public.integrations(id) ON DELETE CASCADE;


--
-- Name: integration_oauth_tokens integration_oauth_tokens_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.integration_oauth_tokens
    ADD CONSTRAINT integration_oauth_tokens_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: integration_oauth_tokens integration_oauth_tokens_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.integration_oauth_tokens
    ADD CONSTRAINT integration_oauth_tokens_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id);


--
-- Name: integration_retry_config integration_retry_config_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.integration_retry_config
    ADD CONSTRAINT integration_retry_config_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: integrations integrations_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.integrations
    ADD CONSTRAINT integrations_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: integrations integrations_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.integrations
    ADD CONSTRAINT integrations_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: interview_feedback interview_feedback_interview_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.interview_feedback
    ADD CONSTRAINT interview_feedback_interview_id_fkey FOREIGN KEY (interview_id) REFERENCES public.interviews(id) ON DELETE CASCADE;


--
-- Name: interview_feedback interview_feedback_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.interview_feedback
    ADD CONSTRAINT interview_feedback_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: interview_feedback interview_feedback_submitted_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.interview_feedback
    ADD CONSTRAINT interview_feedback_submitted_by_fkey FOREIGN KEY (submitted_by) REFERENCES public.user_profiles(id);


--
-- Name: interview_participants interview_participants_interview_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.interview_participants
    ADD CONSTRAINT interview_participants_interview_id_fkey FOREIGN KEY (interview_id) REFERENCES public.interviews(id) ON DELETE CASCADE;


--
-- Name: interview_participants interview_participants_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.interview_participants
    ADD CONSTRAINT interview_participants_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: interview_participants interview_participants_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.interview_participants
    ADD CONSTRAINT interview_participants_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id);


--
-- Name: interview_reminders interview_reminders_interview_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.interview_reminders
    ADD CONSTRAINT interview_reminders_interview_id_fkey FOREIGN KEY (interview_id) REFERENCES public.interviews(id) ON DELETE CASCADE;


--
-- Name: interview_reminders interview_reminders_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.interview_reminders
    ADD CONSTRAINT interview_reminders_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: interview_sessions interview_sessions_student_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.interview_sessions
    ADD CONSTRAINT interview_sessions_student_id_fkey FOREIGN KEY (student_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: interviews interviews_cancelled_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.interviews
    ADD CONSTRAINT interviews_cancelled_by_fkey FOREIGN KEY (cancelled_by) REFERENCES public.user_profiles(id);


--
-- Name: interviews interviews_candidate_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.interviews
    ADD CONSTRAINT interviews_candidate_id_fkey FOREIGN KEY (candidate_id) REFERENCES public.user_profiles(id);


--
-- Name: interviews interviews_confirmed_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.interviews
    ADD CONSTRAINT interviews_confirmed_by_fkey FOREIGN KEY (confirmed_by) REFERENCES public.user_profiles(id);


--
-- Name: interviews interviews_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.interviews
    ADD CONSTRAINT interviews_contact_id_fkey FOREIGN KEY (contact_id) REFERENCES public.contacts(id);


--
-- Name: interviews interviews_job_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.interviews
    ADD CONSTRAINT interviews_job_id_fkey FOREIGN KEY (job_id) REFERENCES public.jobs(id);


--
-- Name: interviews interviews_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.interviews
    ADD CONSTRAINT interviews_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: interviews interviews_prep_completed_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.interviews
    ADD CONSTRAINT interviews_prep_completed_by_fkey FOREIGN KEY (prep_completed_by) REFERENCES public.user_profiles(id);


--
-- Name: interviews interviews_rescheduled_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.interviews
    ADD CONSTRAINT interviews_rescheduled_by_fkey FOREIGN KEY (rescheduled_by) REFERENCES public.user_profiles(id);


--
-- Name: interviews interviews_scheduled_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.interviews
    ADD CONSTRAINT interviews_scheduled_by_fkey FOREIGN KEY (scheduled_by) REFERENCES public.user_profiles(id);


--
-- Name: interviews interviews_submission_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.interviews
    ADD CONSTRAINT interviews_submission_id_fkey FOREIGN KEY (submission_id) REFERENCES public.submissions(id) ON DELETE CASCADE;


--
-- Name: interviews interviews_submitted_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.interviews
    ADD CONSTRAINT interviews_submitted_by_fkey FOREIGN KEY (submitted_by) REFERENCES public.user_profiles(id);


--
-- Name: job_assignments job_assignments_job_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.job_assignments
    ADD CONSTRAINT job_assignments_job_id_fkey FOREIGN KEY (job_id) REFERENCES public.jobs(id) ON DELETE CASCADE;


--
-- Name: job_assignments job_assignments_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.job_assignments
    ADD CONSTRAINT job_assignments_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: job_assignments job_assignments_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.job_assignments
    ADD CONSTRAINT job_assignments_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: external_job_order_notes job_order_notes_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.external_job_order_notes
    ADD CONSTRAINT job_order_notes_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: external_job_order_notes job_order_notes_order_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.external_job_order_notes
    ADD CONSTRAINT job_order_notes_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.external_job_orders(id) ON DELETE CASCADE;


--
-- Name: external_job_order_requirements job_order_requirements_order_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.external_job_order_requirements
    ADD CONSTRAINT job_order_requirements_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.external_job_orders(id) ON DELETE CASCADE;


--
-- Name: external_job_order_skills job_order_skills_order_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.external_job_order_skills
    ADD CONSTRAINT job_order_skills_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.external_job_orders(id) ON DELETE CASCADE;


--
-- Name: external_job_order_submissions job_order_submissions_consultant_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.external_job_order_submissions
    ADD CONSTRAINT job_order_submissions_consultant_id_fkey FOREIGN KEY (consultant_id) REFERENCES public.bench_consultants(id) ON DELETE CASCADE;


--
-- Name: external_job_order_submissions job_order_submissions_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.external_job_order_submissions
    ADD CONSTRAINT job_order_submissions_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: external_job_order_submissions job_order_submissions_order_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.external_job_order_submissions
    ADD CONSTRAINT job_order_submissions_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.external_job_orders(id) ON DELETE CASCADE;


--
-- Name: external_job_orders job_orders_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.external_job_orders
    ADD CONSTRAINT job_orders_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: external_job_orders job_orders_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.external_job_orders
    ADD CONSTRAINT job_orders_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: external_job_orders job_orders_vendor_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.external_job_orders
    ADD CONSTRAINT job_orders_vendor_id_fkey FOREIGN KEY (vendor_id) REFERENCES public.vendors(id);


--
-- Name: job_rates job_rates_job_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.job_rates
    ADD CONSTRAINT job_rates_job_id_fkey FOREIGN KEY (job_id) REFERENCES public.jobs(id) ON DELETE CASCADE;


--
-- Name: job_rates job_rates_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.job_rates
    ADD CONSTRAINT job_rates_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: job_requirements job_requirements_job_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.job_requirements
    ADD CONSTRAINT job_requirements_job_id_fkey FOREIGN KEY (job_id) REFERENCES public.jobs(id) ON DELETE CASCADE;


--
-- Name: job_requirements job_requirements_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.job_requirements
    ADD CONSTRAINT job_requirements_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: job_screening_questions job_screening_questions_job_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.job_screening_questions
    ADD CONSTRAINT job_screening_questions_job_id_fkey FOREIGN KEY (job_id) REFERENCES public.jobs(id) ON DELETE CASCADE;


--
-- Name: job_screening_questions job_screening_questions_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.job_screening_questions
    ADD CONSTRAINT job_screening_questions_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: job_skills job_skills_job_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.job_skills
    ADD CONSTRAINT job_skills_job_id_fkey FOREIGN KEY (job_id) REFERENCES public.jobs(id) ON DELETE CASCADE;


--
-- Name: job_skills job_skills_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.job_skills
    ADD CONSTRAINT job_skills_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: job_skills job_skills_skill_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.job_skills
    ADD CONSTRAINT job_skills_skill_id_fkey FOREIGN KEY (skill_id) REFERENCES public.skills(id) ON DELETE CASCADE;


--
-- Name: job_status_history job_status_history_changed_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.job_status_history
    ADD CONSTRAINT job_status_history_changed_by_fkey FOREIGN KEY (changed_by) REFERENCES public.user_profiles(id);


--
-- Name: job_status_history job_status_history_job_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.job_status_history
    ADD CONSTRAINT job_status_history_job_id_fkey FOREIGN KEY (job_id) REFERENCES public.jobs(id) ON DELETE CASCADE;


--
-- Name: job_status_history job_status_history_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.job_status_history
    ADD CONSTRAINT job_status_history_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: job_status_history job_status_history_reopen_approved_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.job_status_history
    ADD CONSTRAINT job_status_history_reopen_approved_by_fkey FOREIGN KEY (reopen_approved_by) REFERENCES public.user_profiles(id);


--
-- Name: jobs jobs_account_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.jobs
    ADD CONSTRAINT jobs_account_id_fkey FOREIGN KEY (account_id) REFERENCES public.accounts(id);


--
-- Name: jobs jobs_client_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.jobs
    ADD CONSTRAINT jobs_client_id_fkey FOREIGN KEY (client_id) REFERENCES public.accounts(id);


--
-- Name: jobs jobs_closed_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.jobs
    ADD CONSTRAINT jobs_closed_by_fkey FOREIGN KEY (closed_by) REFERENCES public.user_profiles(id);


--
-- Name: jobs jobs_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.jobs
    ADD CONSTRAINT jobs_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id);


--
-- Name: jobs jobs_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.jobs
    ADD CONSTRAINT jobs_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: jobs jobs_deal_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.jobs
    ADD CONSTRAINT jobs_deal_id_fkey FOREIGN KEY (deal_id) REFERENCES public.deals(id);


--
-- Name: jobs jobs_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.jobs
    ADD CONSTRAINT jobs_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: jobs jobs_owner_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.jobs
    ADD CONSTRAINT jobs_owner_id_fkey FOREIGN KEY (owner_id) REFERENCES public.user_profiles(id);


--
-- Name: jobs jobs_published_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.jobs
    ADD CONSTRAINT jobs_published_by_fkey FOREIGN KEY (published_by) REFERENCES public.user_profiles(id);


--
-- Name: lab_instances lab_instances_enrollment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lab_instances
    ADD CONSTRAINT lab_instances_enrollment_id_fkey FOREIGN KEY (enrollment_id) REFERENCES public.student_enrollments(id) ON DELETE CASCADE;


--
-- Name: lab_instances lab_instances_lab_template_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lab_instances
    ADD CONSTRAINT lab_instances_lab_template_id_fkey FOREIGN KEY (lab_template_id) REFERENCES public.lab_templates(id);


--
-- Name: lab_instances lab_instances_topic_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lab_instances
    ADD CONSTRAINT lab_instances_topic_id_fkey FOREIGN KEY (topic_id) REFERENCES public.module_topics(id) ON DELETE CASCADE;


--
-- Name: lab_instances lab_instances_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lab_instances
    ADD CONSTRAINT lab_instances_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: lab_submissions lab_submissions_enrollment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lab_submissions
    ADD CONSTRAINT lab_submissions_enrollment_id_fkey FOREIGN KEY (enrollment_id) REFERENCES public.student_enrollments(id) ON DELETE CASCADE;


--
-- Name: lab_submissions lab_submissions_graded_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lab_submissions
    ADD CONSTRAINT lab_submissions_graded_by_fkey FOREIGN KEY (graded_by) REFERENCES public.user_profiles(id);


--
-- Name: lab_submissions lab_submissions_lab_instance_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lab_submissions
    ADD CONSTRAINT lab_submissions_lab_instance_id_fkey FOREIGN KEY (lab_instance_id) REFERENCES public.lab_instances(id) ON DELETE CASCADE;


--
-- Name: lab_submissions lab_submissions_previous_submission_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lab_submissions
    ADD CONSTRAINT lab_submissions_previous_submission_id_fkey FOREIGN KEY (previous_submission_id) REFERENCES public.lab_submissions(id);


--
-- Name: lab_submissions lab_submissions_topic_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lab_submissions
    ADD CONSTRAINT lab_submissions_topic_id_fkey FOREIGN KEY (topic_id) REFERENCES public.module_topics(id) ON DELETE CASCADE;


--
-- Name: lab_submissions lab_submissions_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lab_submissions
    ADD CONSTRAINT lab_submissions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: lab_templates lab_templates_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lab_templates
    ADD CONSTRAINT lab_templates_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: lead_qualification lead_qualification_lead_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lead_qualification
    ADD CONSTRAINT lead_qualification_lead_id_fkey FOREIGN KEY (lead_id) REFERENCES public.leads(id) ON DELETE CASCADE;


--
-- Name: lead_qualification lead_qualification_qualified_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lead_qualification
    ADD CONSTRAINT lead_qualification_qualified_by_fkey FOREIGN KEY (qualified_by) REFERENCES public.user_profiles(id);


--
-- Name: lead_scores lead_scores_lead_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lead_scores
    ADD CONSTRAINT lead_scores_lead_id_fkey FOREIGN KEY (lead_id) REFERENCES public.leads(id) ON DELETE CASCADE;


--
-- Name: lead_sourcing_credits lead_sourcing_credits_assigned_to_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lead_sourcing_credits
    ADD CONSTRAINT lead_sourcing_credits_assigned_to_fkey FOREIGN KEY (assigned_to) REFERENCES public.user_profiles(id);


--
-- Name: lead_sourcing_credits lead_sourcing_credits_lead_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lead_sourcing_credits
    ADD CONSTRAINT lead_sourcing_credits_lead_id_fkey FOREIGN KEY (lead_id) REFERENCES public.leads(id) ON DELETE CASCADE;


--
-- Name: lead_sourcing_credits lead_sourcing_credits_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lead_sourcing_credits
    ADD CONSTRAINT lead_sourcing_credits_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: lead_sourcing_credits lead_sourcing_credits_sourced_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lead_sourcing_credits
    ADD CONSTRAINT lead_sourcing_credits_sourced_by_fkey FOREIGN KEY (sourced_by) REFERENCES public.user_profiles(id);


--
-- Name: lead_strategies lead_strategies_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lead_strategies
    ADD CONSTRAINT lead_strategies_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: lead_strategies lead_strategies_lead_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lead_strategies
    ADD CONSTRAINT lead_strategies_lead_id_fkey FOREIGN KEY (lead_id) REFERENCES public.leads(id) ON DELETE CASCADE;


--
-- Name: lead_strategies lead_strategies_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lead_strategies
    ADD CONSTRAINT lead_strategies_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: lead_strategies lead_strategies_updated_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lead_strategies
    ADD CONSTRAINT lead_strategies_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES public.user_profiles(id);


--
-- Name: lead_tasks lead_tasks_assigned_to_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lead_tasks
    ADD CONSTRAINT lead_tasks_assigned_to_fkey FOREIGN KEY (assigned_to) REFERENCES public.user_profiles(id);


--
-- Name: lead_tasks lead_tasks_completed_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lead_tasks
    ADD CONSTRAINT lead_tasks_completed_by_fkey FOREIGN KEY (completed_by) REFERENCES public.user_profiles(id);


--
-- Name: lead_tasks lead_tasks_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lead_tasks
    ADD CONSTRAINT lead_tasks_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: lead_tasks lead_tasks_lead_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lead_tasks
    ADD CONSTRAINT lead_tasks_lead_id_fkey FOREIGN KEY (lead_id) REFERENCES public.leads(id) ON DELETE CASCADE;


--
-- Name: lead_tasks lead_tasks_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lead_tasks
    ADD CONSTRAINT lead_tasks_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: lead_touchpoints lead_touchpoints_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lead_touchpoints
    ADD CONSTRAINT lead_touchpoints_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: lead_touchpoints lead_touchpoints_lead_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.lead_touchpoints
    ADD CONSTRAINT lead_touchpoints_lead_id_fkey FOREIGN KEY (lead_id) REFERENCES public.leads(id) ON DELETE CASCADE;


--
-- Name: leaderboard_entries leaderboard_entries_leaderboard_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.leaderboard_entries
    ADD CONSTRAINT leaderboard_entries_leaderboard_id_fkey FOREIGN KEY (leaderboard_id) REFERENCES public.leaderboards(id) ON DELETE CASCADE;


--
-- Name: leaderboard_entries leaderboard_entries_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.leaderboard_entries
    ADD CONSTRAINT leaderboard_entries_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id);


--
-- Name: leads leads_account_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.leads
    ADD CONSTRAINT leads_account_id_fkey FOREIGN KEY (account_id) REFERENCES public.accounts(id);


--
-- Name: leads leads_campaign_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.leads
    ADD CONSTRAINT leads_campaign_id_fkey FOREIGN KEY (campaign_id) REFERENCES public.campaigns(id);


--
-- Name: leads leads_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.leads
    ADD CONSTRAINT leads_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id);


--
-- Name: leads leads_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.leads
    ADD CONSTRAINT leads_contact_id_fkey FOREIGN KEY (contact_id) REFERENCES public.contacts(id);


--
-- Name: leads leads_converted_to_account_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.leads
    ADD CONSTRAINT leads_converted_to_account_id_fkey FOREIGN KEY (converted_to_account_id) REFERENCES public.accounts(id);


--
-- Name: leads leads_converted_to_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.leads
    ADD CONSTRAINT leads_converted_to_company_id_fkey FOREIGN KEY (converted_to_company_id) REFERENCES public.companies(id);


--
-- Name: leads leads_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.leads
    ADD CONSTRAINT leads_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: leads leads_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.leads
    ADD CONSTRAINT leads_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: leads leads_owner_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.leads
    ADD CONSTRAINT leads_owner_id_fkey FOREIGN KEY (owner_id) REFERENCES public.user_profiles(id);


--
-- Name: leads leads_qualified_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.leads
    ADD CONSTRAINT leads_qualified_by_fkey FOREIGN KEY (qualified_by) REFERENCES public.user_profiles(id);


--
-- Name: learning_path_courses learning_path_courses_course_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.learning_path_courses
    ADD CONSTRAINT learning_path_courses_course_id_fkey FOREIGN KEY (course_id) REFERENCES public.courses(id) ON DELETE CASCADE;


--
-- Name: learning_path_courses learning_path_courses_path_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.learning_path_courses
    ADD CONSTRAINT learning_path_courses_path_id_fkey FOREIGN KEY (path_id) REFERENCES public.learning_paths(id) ON DELETE CASCADE;


--
-- Name: learning_paths learning_paths_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.learning_paths
    ADD CONSTRAINT learning_paths_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: learning_streaks learning_streaks_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.learning_streaks
    ADD CONSTRAINT learning_streaks_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id);


--
-- Name: login_history login_history_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.login_history
    ADD CONSTRAINT login_history_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: login_history login_history_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.login_history
    ADD CONSTRAINT login_history_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE SET NULL;


--
-- Name: marketing_formats marketing_formats_profile_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.marketing_formats
    ADD CONSTRAINT marketing_formats_profile_id_fkey FOREIGN KEY (profile_id) REFERENCES public.marketing_profiles(id) ON DELETE CASCADE;


--
-- Name: marketing_profiles marketing_profiles_consultant_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.marketing_profiles
    ADD CONSTRAINT marketing_profiles_consultant_id_fkey FOREIGN KEY (consultant_id) REFERENCES public.bench_consultants(id) ON DELETE CASCADE;


--
-- Name: marketing_profiles marketing_profiles_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.marketing_profiles
    ADD CONSTRAINT marketing_profiles_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: marketing_templates marketing_templates_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.marketing_templates
    ADD CONSTRAINT marketing_templates_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: marketing_templates marketing_templates_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.marketing_templates
    ADD CONSTRAINT marketing_templates_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: meeting_notes meeting_notes_account_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.meeting_notes
    ADD CONSTRAINT meeting_notes_account_id_fkey FOREIGN KEY (account_id) REFERENCES public.accounts(id) ON DELETE CASCADE;


--
-- Name: meeting_notes meeting_notes_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.meeting_notes
    ADD CONSTRAINT meeting_notes_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: meeting_notes meeting_notes_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.meeting_notes
    ADD CONSTRAINT meeting_notes_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: meeting_notes meeting_notes_updated_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.meeting_notes
    ADD CONSTRAINT meeting_notes_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES public.user_profiles(id);


--
-- Name: module_topics module_topics_module_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.module_topics
    ADD CONSTRAINT module_topics_module_id_fkey FOREIGN KEY (module_id) REFERENCES public.course_modules(id) ON DELETE CASCADE;


--
-- Name: notifications notifications_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.notifications
    ADD CONSTRAINT notifications_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: notifications notifications_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.notifications
    ADD CONSTRAINT notifications_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id);


--
-- Name: object_owners object_owners_assigned_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.object_owners
    ADD CONSTRAINT object_owners_assigned_by_fkey FOREIGN KEY (assigned_by) REFERENCES public.user_profiles(id);


--
-- Name: object_owners object_owners_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.object_owners
    ADD CONSTRAINT object_owners_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: object_owners object_owners_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.object_owners
    ADD CONSTRAINT object_owners_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: offer_approvals offer_approvals_approver_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.offer_approvals
    ADD CONSTRAINT offer_approvals_approver_id_fkey FOREIGN KEY (approver_id) REFERENCES public.user_profiles(id);


--
-- Name: offer_approvals offer_approvals_offer_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.offer_approvals
    ADD CONSTRAINT offer_approvals_offer_id_fkey FOREIGN KEY (offer_id) REFERENCES public.offers(id) ON DELETE CASCADE;


--
-- Name: offer_approvals offer_approvals_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.offer_approvals
    ADD CONSTRAINT offer_approvals_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: offer_approvals offer_approvals_requested_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.offer_approvals
    ADD CONSTRAINT offer_approvals_requested_by_fkey FOREIGN KEY (requested_by) REFERENCES public.user_profiles(id);


--
-- Name: offer_negotiations offer_negotiations_offer_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.offer_negotiations
    ADD CONSTRAINT offer_negotiations_offer_id_fkey FOREIGN KEY (offer_id) REFERENCES public.offers(id) ON DELETE CASCADE;


--
-- Name: offer_negotiations offer_negotiations_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.offer_negotiations
    ADD CONSTRAINT offer_negotiations_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: offer_terms offer_terms_offer_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.offer_terms
    ADD CONSTRAINT offer_terms_offer_id_fkey FOREIGN KEY (offer_id) REFERENCES public.offers(id) ON DELETE CASCADE;


--
-- Name: offer_terms offer_terms_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.offer_terms
    ADD CONSTRAINT offer_terms_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: offers offers_accepted_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.offers
    ADD CONSTRAINT offers_accepted_by_fkey FOREIGN KEY (accepted_by) REFERENCES public.user_profiles(id);


--
-- Name: offers offers_candidate_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.offers
    ADD CONSTRAINT offers_candidate_id_fkey FOREIGN KEY (candidate_id) REFERENCES public.user_profiles(id);


--
-- Name: offers offers_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.offers
    ADD CONSTRAINT offers_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: offers offers_job_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.offers
    ADD CONSTRAINT offers_job_id_fkey FOREIGN KEY (job_id) REFERENCES public.jobs(id);


--
-- Name: offers offers_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.offers
    ADD CONSTRAINT offers_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: offers offers_sent_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.offers
    ADD CONSTRAINT offers_sent_by_fkey FOREIGN KEY (sent_by) REFERENCES public.user_profiles(id);


--
-- Name: offers offers_submission_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.offers
    ADD CONSTRAINT offers_submission_id_fkey FOREIGN KEY (submission_id) REFERENCES public.submissions(id);


--
-- Name: onboarding_checklist onboarding_checklist_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.onboarding_checklist
    ADD CONSTRAINT onboarding_checklist_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: onboarding_tasks onboarding_tasks_completed_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.onboarding_tasks
    ADD CONSTRAINT onboarding_tasks_completed_by_fkey FOREIGN KEY (completed_by) REFERENCES public.user_profiles(id);


--
-- Name: onboarding_tasks onboarding_tasks_onboarding_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.onboarding_tasks
    ADD CONSTRAINT onboarding_tasks_onboarding_id_fkey FOREIGN KEY (onboarding_id) REFERENCES public.employee_onboarding(id) ON DELETE CASCADE;


--
-- Name: organization_branding organization_branding_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.organization_branding
    ADD CONSTRAINT organization_branding_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: organization_branding organization_branding_uploaded_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.organization_branding
    ADD CONSTRAINT organization_branding_uploaded_by_fkey FOREIGN KEY (uploaded_by) REFERENCES public.user_profiles(id);


--
-- Name: organization_settings organization_settings_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.organization_settings
    ADD CONSTRAINT organization_settings_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: organization_settings organization_settings_updated_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.organization_settings
    ADD CONSTRAINT organization_settings_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES public.user_profiles(id);


--
-- Name: path_enrollments path_enrollments_path_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.path_enrollments
    ADD CONSTRAINT path_enrollments_path_id_fkey FOREIGN KEY (path_id) REFERENCES public.learning_paths(id);


--
-- Name: path_enrollments path_enrollments_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.path_enrollments
    ADD CONSTRAINT path_enrollments_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id);


--
-- Name: pattern_checklist_items pattern_checklist_items_pattern_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.pattern_checklist_items
    ADD CONSTRAINT pattern_checklist_items_pattern_id_fkey FOREIGN KEY (pattern_id) REFERENCES public.activity_patterns(id) ON DELETE CASCADE;


--
-- Name: pattern_fields pattern_fields_pattern_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.pattern_fields
    ADD CONSTRAINT pattern_fields_pattern_id_fkey FOREIGN KEY (pattern_id) REFERENCES public.activity_patterns(id) ON DELETE CASCADE;


--
-- Name: payment_transactions payment_transactions_enrollment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payment_transactions
    ADD CONSTRAINT payment_transactions_enrollment_id_fkey FOREIGN KEY (enrollment_id) REFERENCES public.student_enrollments(id);


--
-- Name: payment_transactions payment_transactions_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payment_transactions
    ADD CONSTRAINT payment_transactions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id);


--
-- Name: payroll_items payroll_items_employee_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payroll_items
    ADD CONSTRAINT payroll_items_employee_id_fkey FOREIGN KEY (employee_id) REFERENCES public.user_profiles(id);


--
-- Name: payroll_items payroll_items_payroll_run_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payroll_items
    ADD CONSTRAINT payroll_items_payroll_run_id_fkey FOREIGN KEY (payroll_run_id) REFERENCES public.payroll_runs(id) ON DELETE CASCADE;


--
-- Name: payroll_runs payroll_runs_approved_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payroll_runs
    ADD CONSTRAINT payroll_runs_approved_by_fkey FOREIGN KEY (approved_by) REFERENCES public.user_profiles(id);


--
-- Name: payroll_runs payroll_runs_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payroll_runs
    ADD CONSTRAINT payroll_runs_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: payroll_runs payroll_runs_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payroll_runs
    ADD CONSTRAINT payroll_runs_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: peer_reviews peer_reviews_reviewer_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.peer_reviews
    ADD CONSTRAINT peer_reviews_reviewer_id_fkey FOREIGN KEY (reviewer_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: peer_reviews peer_reviews_submission_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.peer_reviews
    ADD CONSTRAINT peer_reviews_submission_id_fkey FOREIGN KEY (submission_id) REFERENCES public.capstone_submissions(id) ON DELETE CASCADE;


--
-- Name: performance_feedback performance_feedback_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.performance_feedback
    ADD CONSTRAINT performance_feedback_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: performance_goals performance_goals_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.performance_goals
    ADD CONSTRAINT performance_goals_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: performance_goals performance_goals_employee_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.performance_goals
    ADD CONSTRAINT performance_goals_employee_id_fkey FOREIGN KEY (employee_id) REFERENCES public.employees(id) ON DELETE CASCADE;


--
-- Name: performance_reviews performance_reviews_employee_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.performance_reviews
    ADD CONSTRAINT performance_reviews_employee_id_fkey FOREIGN KEY (employee_id) REFERENCES public.user_profiles(id);


--
-- Name: performance_reviews performance_reviews_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.performance_reviews
    ADD CONSTRAINT performance_reviews_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: performance_reviews performance_reviews_reviewer_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.performance_reviews
    ADD CONSTRAINT performance_reviews_reviewer_id_fkey FOREIGN KEY (reviewer_id) REFERENCES public.user_profiles(id);


--
-- Name: permission_overrides permission_overrides_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.permission_overrides
    ADD CONSTRAINT permission_overrides_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: permission_overrides permission_overrides_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.permission_overrides
    ADD CONSTRAINT permission_overrides_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: permission_overrides permission_overrides_permission_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.permission_overrides
    ADD CONSTRAINT permission_overrides_permission_id_fkey FOREIGN KEY (permission_id) REFERENCES public.permissions(id) ON DELETE CASCADE;


--
-- Name: permission_overrides permission_overrides_revoked_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.permission_overrides
    ADD CONSTRAINT permission_overrides_revoked_by_fkey FOREIGN KEY (revoked_by) REFERENCES public.user_profiles(id);


--
-- Name: permission_overrides permission_overrides_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.permission_overrides
    ADD CONSTRAINT permission_overrides_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: placement_checkins placement_checkins_client_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placement_checkins
    ADD CONSTRAINT placement_checkins_client_contact_id_fkey FOREIGN KEY (client_contact_id) REFERENCES public.user_profiles(id);


--
-- Name: placement_checkins placement_checkins_conducted_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placement_checkins
    ADD CONSTRAINT placement_checkins_conducted_by_fkey FOREIGN KEY (conducted_by) REFERENCES public.user_profiles(id);


--
-- Name: placement_checkins placement_checkins_escalated_to_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placement_checkins
    ADD CONSTRAINT placement_checkins_escalated_to_fkey FOREIGN KEY (escalated_to) REFERENCES public.user_profiles(id);


--
-- Name: placement_checkins placement_checkins_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placement_checkins
    ADD CONSTRAINT placement_checkins_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: placement_checkins placement_checkins_placement_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placement_checkins
    ADD CONSTRAINT placement_checkins_placement_id_fkey FOREIGN KEY (placement_id) REFERENCES public.placements(id) ON DELETE CASCADE;


--
-- Name: placement_credits placement_credits_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placement_credits
    ADD CONSTRAINT placement_credits_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: placement_credits placement_credits_junior_rec_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placement_credits
    ADD CONSTRAINT placement_credits_junior_rec_id_fkey FOREIGN KEY (junior_rec_id) REFERENCES public.user_profiles(id);


--
-- Name: placement_credits placement_credits_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placement_credits
    ADD CONSTRAINT placement_credits_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: placement_credits placement_credits_original_graduate_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placement_credits
    ADD CONSTRAINT placement_credits_original_graduate_id_fkey FOREIGN KEY (original_graduate_id) REFERENCES public.graduate_candidates(id);


--
-- Name: placement_credits placement_credits_pod_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placement_credits
    ADD CONSTRAINT placement_credits_pod_id_fkey FOREIGN KEY (pod_id) REFERENCES public.pods(id) ON DELETE CASCADE;


--
-- Name: placement_credits placement_credits_senior_rec_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placement_credits
    ADD CONSTRAINT placement_credits_senior_rec_id_fkey FOREIGN KEY (senior_rec_id) REFERENCES public.user_profiles(id);


--
-- Name: placement_credits placement_credits_verified_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placement_credits
    ADD CONSTRAINT placement_credits_verified_by_fkey FOREIGN KEY (verified_by) REFERENCES public.user_profiles(id);


--
-- Name: placement_extensions placement_extensions_approved_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placement_extensions
    ADD CONSTRAINT placement_extensions_approved_by_fkey FOREIGN KEY (approved_by) REFERENCES public.user_profiles(id);


--
-- Name: placement_extensions placement_extensions_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placement_extensions
    ADD CONSTRAINT placement_extensions_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: placement_extensions placement_extensions_placement_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placement_extensions
    ADD CONSTRAINT placement_extensions_placement_id_fkey FOREIGN KEY (placement_id) REFERENCES public.placements(id) ON DELETE CASCADE;


--
-- Name: placement_milestones placement_milestones_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placement_milestones
    ADD CONSTRAINT placement_milestones_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: placement_milestones placement_milestones_placement_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placement_milestones
    ADD CONSTRAINT placement_milestones_placement_id_fkey FOREIGN KEY (placement_id) REFERENCES public.placements(id) ON DELETE CASCADE;


--
-- Name: placement_rates placement_rates_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placement_rates
    ADD CONSTRAINT placement_rates_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: placement_rates placement_rates_placement_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placement_rates
    ADD CONSTRAINT placement_rates_placement_id_fkey FOREIGN KEY (placement_id) REFERENCES public.placements(id) ON DELETE CASCADE;


--
-- Name: placement_timesheets placement_timesheets_approved_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placement_timesheets
    ADD CONSTRAINT placement_timesheets_approved_by_fkey FOREIGN KEY (approved_by) REFERENCES public.user_profiles(id);


--
-- Name: placement_timesheets placement_timesheets_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placement_timesheets
    ADD CONSTRAINT placement_timesheets_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: placement_timesheets placement_timesheets_placement_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placement_timesheets
    ADD CONSTRAINT placement_timesheets_placement_id_fkey FOREIGN KEY (placement_id) REFERENCES public.placements(id) ON DELETE CASCADE;


--
-- Name: placements placements_account_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placements
    ADD CONSTRAINT placements_account_id_fkey FOREIGN KEY (account_id) REFERENCES public.accounts(id);


--
-- Name: placements placements_account_manager_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placements
    ADD CONSTRAINT placements_account_manager_id_fkey FOREIGN KEY (account_manager_id) REFERENCES public.user_profiles(id);


--
-- Name: placements placements_billing_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placements
    ADD CONSTRAINT placements_billing_company_id_fkey FOREIGN KEY (billing_company_id) REFERENCES public.companies(id);


--
-- Name: placements placements_candidate_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placements
    ADD CONSTRAINT placements_candidate_id_fkey FOREIGN KEY (candidate_id) REFERENCES public.user_profiles(id);


--
-- Name: placements placements_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placements
    ADD CONSTRAINT placements_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id);


--
-- Name: placements placements_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placements
    ADD CONSTRAINT placements_contact_id_fkey FOREIGN KEY (contact_id) REFERENCES public.contacts(id);


--
-- Name: placements placements_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placements
    ADD CONSTRAINT placements_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: placements placements_end_client_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placements
    ADD CONSTRAINT placements_end_client_company_id_fkey FOREIGN KEY (end_client_company_id) REFERENCES public.companies(id);


--
-- Name: placements placements_job_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placements
    ADD CONSTRAINT placements_job_id_fkey FOREIGN KEY (job_id) REFERENCES public.jobs(id);


--
-- Name: placements placements_last_check_in_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placements
    ADD CONSTRAINT placements_last_check_in_by_fkey FOREIGN KEY (last_check_in_by) REFERENCES public.user_profiles(id);


--
-- Name: placements placements_offer_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placements
    ADD CONSTRAINT placements_offer_id_fkey FOREIGN KEY (offer_id) REFERENCES public.offers(id);


--
-- Name: placements placements_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placements
    ADD CONSTRAINT placements_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: placements placements_recruiter_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placements
    ADD CONSTRAINT placements_recruiter_id_fkey FOREIGN KEY (recruiter_id) REFERENCES public.user_profiles(id);


--
-- Name: placements placements_submission_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.placements
    ADD CONSTRAINT placements_submission_id_fkey FOREIGN KEY (submission_id) REFERENCES public.submissions(id);


--
-- Name: pod_managers pod_managers_assigned_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.pod_managers
    ADD CONSTRAINT pod_managers_assigned_by_fkey FOREIGN KEY (assigned_by) REFERENCES public.user_profiles(id);


--
-- Name: pod_managers pod_managers_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.pod_managers
    ADD CONSTRAINT pod_managers_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: pod_managers pod_managers_pod_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.pod_managers
    ADD CONSTRAINT pod_managers_pod_id_fkey FOREIGN KEY (pod_id) REFERENCES public.pods(id) ON DELETE CASCADE;


--
-- Name: pod_managers pod_managers_removed_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.pod_managers
    ADD CONSTRAINT pod_managers_removed_by_fkey FOREIGN KEY (removed_by) REFERENCES public.user_profiles(id);


--
-- Name: pod_managers pod_managers_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.pod_managers
    ADD CONSTRAINT pod_managers_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id);


--
-- Name: pod_members pod_members_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.pod_members
    ADD CONSTRAINT pod_members_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: pod_members pod_members_pod_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.pod_members
    ADD CONSTRAINT pod_members_pod_id_fkey FOREIGN KEY (pod_id) REFERENCES public.pods(id) ON DELETE CASCADE;


--
-- Name: pod_members pod_members_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.pod_members
    ADD CONSTRAINT pod_members_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: pod_sprint_metrics pod_sprint_metrics_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.pod_sprint_metrics
    ADD CONSTRAINT pod_sprint_metrics_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: pod_sprint_metrics pod_sprint_metrics_pod_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.pod_sprint_metrics
    ADD CONSTRAINT pod_sprint_metrics_pod_id_fkey FOREIGN KEY (pod_id) REFERENCES public.pods(id) ON DELETE CASCADE;


--
-- Name: pods pods_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.pods
    ADD CONSTRAINT pods_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: pods pods_junior_member_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.pods
    ADD CONSTRAINT pods_junior_member_id_fkey FOREIGN KEY (junior_member_id) REFERENCES public.user_profiles(id);


--
-- Name: pods pods_manager_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.pods
    ADD CONSTRAINT pods_manager_id_fkey FOREIGN KEY (manager_id) REFERENCES public.user_profiles(id);


--
-- Name: pods pods_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.pods
    ADD CONSTRAINT pods_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: pods pods_region_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.pods
    ADD CONSTRAINT pods_region_id_fkey FOREIGN KEY (region_id) REFERENCES public.regions(id);


--
-- Name: pods pods_senior_member_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.pods
    ADD CONSTRAINT pods_senior_member_id_fkey FOREIGN KEY (senior_member_id) REFERENCES public.user_profiles(id);


--
-- Name: productivity_reports productivity_reports_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.productivity_reports
    ADD CONSTRAINT productivity_reports_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: project_timeline project_timeline_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.project_timeline
    ADD CONSTRAINT project_timeline_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: pto_balances pto_balances_employee_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.pto_balances
    ADD CONSTRAINT pto_balances_employee_id_fkey FOREIGN KEY (employee_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: queue_items queue_items_assigned_to_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.queue_items
    ADD CONSTRAINT queue_items_assigned_to_fkey FOREIGN KEY (assigned_to) REFERENCES public.user_profiles(id);


--
-- Name: queue_items queue_items_queue_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.queue_items
    ADD CONSTRAINT queue_items_queue_id_fkey FOREIGN KEY (queue_id) REFERENCES public.work_queues(id) ON DELETE CASCADE;


--
-- Name: quiz_attempts quiz_attempts_enrollment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.quiz_attempts
    ADD CONSTRAINT quiz_attempts_enrollment_id_fkey FOREIGN KEY (enrollment_id) REFERENCES public.student_enrollments(id);


--
-- Name: quiz_attempts quiz_attempts_topic_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.quiz_attempts
    ADD CONSTRAINT quiz_attempts_topic_id_fkey FOREIGN KEY (topic_id) REFERENCES public.module_topics(id);


--
-- Name: quiz_attempts quiz_attempts_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.quiz_attempts
    ADD CONSTRAINT quiz_attempts_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id);


--
-- Name: quiz_questions quiz_questions_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.quiz_questions
    ADD CONSTRAINT quiz_questions_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: quiz_questions quiz_questions_topic_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.quiz_questions
    ADD CONSTRAINT quiz_questions_topic_id_fkey FOREIGN KEY (topic_id) REFERENCES public.module_topics(id) ON DELETE CASCADE;


--
-- Name: quiz_settings quiz_settings_topic_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.quiz_settings
    ADD CONSTRAINT quiz_settings_topic_id_fkey FOREIGN KEY (topic_id) REFERENCES public.module_topics(id) ON DELETE CASCADE;


--
-- Name: raci_change_log raci_change_log_changed_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.raci_change_log
    ADD CONSTRAINT raci_change_log_changed_by_fkey FOREIGN KEY (changed_by) REFERENCES public.user_profiles(id);


--
-- Name: raci_change_log raci_change_log_object_owner_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.raci_change_log
    ADD CONSTRAINT raci_change_log_object_owner_id_fkey FOREIGN KEY (object_owner_id) REFERENCES public.object_owners(id) ON DELETE SET NULL;


--
-- Name: raci_change_log raci_change_log_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.raci_change_log
    ADD CONSTRAINT raci_change_log_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: reading_progress reading_progress_enrollment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.reading_progress
    ADD CONSTRAINT reading_progress_enrollment_id_fkey FOREIGN KEY (enrollment_id) REFERENCES public.student_enrollments(id) ON DELETE CASCADE;


--
-- Name: reading_progress reading_progress_topic_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.reading_progress
    ADD CONSTRAINT reading_progress_topic_id_fkey FOREIGN KEY (topic_id) REFERENCES public.module_topics(id) ON DELETE CASCADE;


--
-- Name: reading_progress reading_progress_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.reading_progress
    ADD CONSTRAINT reading_progress_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: regions regions_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.regions
    ADD CONSTRAINT regions_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: regions regions_manager_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.regions
    ADD CONSTRAINT regions_manager_id_fkey FOREIGN KEY (manager_id) REFERENCES public.user_profiles(id);


--
-- Name: regions regions_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.regions
    ADD CONSTRAINT regions_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: requisition_embeddings requisition_embeddings_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.requisition_embeddings
    ADD CONSTRAINT requisition_embeddings_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: resume_matches resume_matches_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.resume_matches
    ADD CONSTRAINT resume_matches_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: resume_versions resume_versions_student_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.resume_versions
    ADD CONSTRAINT resume_versions_student_id_fkey FOREIGN KEY (student_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: retention_policies retention_policies_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.retention_policies
    ADD CONSTRAINT retention_policies_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: retention_policies retention_policies_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.retention_policies
    ADD CONSTRAINT retention_policies_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: role_permissions role_permissions_granted_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.role_permissions
    ADD CONSTRAINT role_permissions_granted_by_fkey FOREIGN KEY (granted_by) REFERENCES public.user_profiles(id);


--
-- Name: role_permissions role_permissions_permission_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.role_permissions
    ADD CONSTRAINT role_permissions_permission_id_fkey FOREIGN KEY (permission_id) REFERENCES public.permissions(id) ON DELETE CASCADE;


--
-- Name: role_permissions role_permissions_role_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.role_permissions
    ADD CONSTRAINT role_permissions_role_id_fkey FOREIGN KEY (role_id) REFERENCES public.system_roles(id) ON DELETE CASCADE;


--
-- Name: roles roles_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roles
    ADD CONSTRAINT roles_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: roles roles_parent_role_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roles
    ADD CONSTRAINT roles_parent_role_id_fkey FOREIGN KEY (parent_role_id) REFERENCES public.roles(id) ON DELETE SET NULL;


--
-- Name: saved_searches saved_searches_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.saved_searches
    ADD CONSTRAINT saved_searches_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: saved_searches saved_searches_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.saved_searches
    ADD CONSTRAINT saved_searches_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: security_alerts security_alerts_assigned_to_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.security_alerts
    ADD CONSTRAINT security_alerts_assigned_to_fkey FOREIGN KEY (assigned_to) REFERENCES public.user_profiles(id) ON DELETE SET NULL;


--
-- Name: security_alerts security_alerts_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.security_alerts
    ADD CONSTRAINT security_alerts_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: security_alerts security_alerts_related_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.security_alerts
    ADD CONSTRAINT security_alerts_related_user_id_fkey FOREIGN KEY (related_user_id) REFERENCES public.user_profiles(id) ON DELETE SET NULL;


--
-- Name: sequence_templates sequence_templates_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.sequence_templates
    ADD CONSTRAINT sequence_templates_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: sequence_templates sequence_templates_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.sequence_templates
    ADD CONSTRAINT sequence_templates_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: session_metadata session_metadata_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.session_metadata
    ADD CONSTRAINT session_metadata_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: skill_aliases skill_aliases_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.skill_aliases
    ADD CONSTRAINT skill_aliases_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: skill_aliases skill_aliases_skill_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.skill_aliases
    ADD CONSTRAINT skill_aliases_skill_id_fkey FOREIGN KEY (skill_id) REFERENCES public.skills(id) ON DELETE CASCADE;


--
-- Name: skills skills_parent_skill_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.skills
    ADD CONSTRAINT skills_parent_skill_id_fkey FOREIGN KEY (parent_skill_id) REFERENCES public.skills(id);


--
-- Name: sla_definitions sla_definitions_escalate_to_group_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.sla_definitions
    ADD CONSTRAINT sla_definitions_escalate_to_group_id_fkey FOREIGN KEY (escalate_to_group_id) REFERENCES public.pods(id);


--
-- Name: sla_definitions sla_definitions_escalate_to_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.sla_definitions
    ADD CONSTRAINT sla_definitions_escalate_to_user_id_fkey FOREIGN KEY (escalate_to_user_id) REFERENCES public.user_profiles(id);


--
-- Name: sla_definitions sla_definitions_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.sla_definitions
    ADD CONSTRAINT sla_definitions_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: sla_escalation_levels sla_escalation_levels_sla_definition_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.sla_escalation_levels
    ADD CONSTRAINT sla_escalation_levels_sla_definition_id_fkey FOREIGN KEY (sla_definition_id) REFERENCES public.sla_definitions(id) ON DELETE CASCADE;


--
-- Name: sla_events sla_events_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.sla_events
    ADD CONSTRAINT sla_events_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: sla_events sla_events_resolved_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.sla_events
    ADD CONSTRAINT sla_events_resolved_by_fkey FOREIGN KEY (resolved_by) REFERENCES public.user_profiles(id);


--
-- Name: sla_events sla_events_sla_definition_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.sla_events
    ADD CONSTRAINT sla_events_sla_definition_id_fkey FOREIGN KEY (sla_definition_id) REFERENCES public.sla_definitions(id) ON DELETE CASCADE;


--
-- Name: sla_instances sla_instances_activity_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.sla_instances
    ADD CONSTRAINT sla_instances_activity_id_fkey FOREIGN KEY (activity_id) REFERENCES public.activities(id) ON DELETE CASCADE;


--
-- Name: sla_instances sla_instances_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.sla_instances
    ADD CONSTRAINT sla_instances_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: sla_instances sla_instances_sla_definition_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.sla_instances
    ADD CONSTRAINT sla_instances_sla_definition_id_fkey FOREIGN KEY (sla_definition_id) REFERENCES public.sla_definitions(id);


--
-- Name: sla_notifications sla_notifications_sla_event_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.sla_notifications
    ADD CONSTRAINT sla_notifications_sla_event_id_fkey FOREIGN KEY (sla_event_id) REFERENCES public.sla_events(id) ON DELETE CASCADE;


--
-- Name: student_enrollments student_enrollments_course_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.student_enrollments
    ADD CONSTRAINT student_enrollments_course_id_fkey FOREIGN KEY (course_id) REFERENCES public.courses(id) ON DELETE RESTRICT;


--
-- Name: student_enrollments student_enrollments_current_module_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.student_enrollments
    ADD CONSTRAINT student_enrollments_current_module_id_fkey FOREIGN KEY (current_module_id) REFERENCES public.course_modules(id);


--
-- Name: student_enrollments student_enrollments_current_topic_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.student_enrollments
    ADD CONSTRAINT student_enrollments_current_topic_id_fkey FOREIGN KEY (current_topic_id) REFERENCES public.module_topics(id);


--
-- Name: student_enrollments student_enrollments_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.student_enrollments
    ADD CONSTRAINT student_enrollments_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: student_interventions student_interventions_assigned_trainer_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.student_interventions
    ADD CONSTRAINT student_interventions_assigned_trainer_id_fkey FOREIGN KEY (assigned_trainer_id) REFERENCES public.user_profiles(id) ON DELETE SET NULL;


--
-- Name: student_interventions student_interventions_course_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.student_interventions
    ADD CONSTRAINT student_interventions_course_id_fkey FOREIGN KEY (course_id) REFERENCES public.courses(id) ON DELETE CASCADE;


--
-- Name: student_interventions student_interventions_enrollment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.student_interventions
    ADD CONSTRAINT student_interventions_enrollment_id_fkey FOREIGN KEY (enrollment_id) REFERENCES public.student_enrollments(id) ON DELETE CASCADE;


--
-- Name: student_interventions student_interventions_student_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.student_interventions
    ADD CONSTRAINT student_interventions_student_id_fkey FOREIGN KEY (student_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: student_progress student_progress_student_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.student_progress
    ADD CONSTRAINT student_progress_student_id_fkey FOREIGN KEY (student_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: submission_notes submission_notes_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.submission_notes
    ADD CONSTRAINT submission_notes_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: submission_notes submission_notes_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.submission_notes
    ADD CONSTRAINT submission_notes_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: submission_notes submission_notes_submission_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.submission_notes
    ADD CONSTRAINT submission_notes_submission_id_fkey FOREIGN KEY (submission_id) REFERENCES public.submissions(id) ON DELETE CASCADE;


--
-- Name: submission_rates submission_rates_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.submission_rates
    ADD CONSTRAINT submission_rates_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: submission_rates submission_rates_submission_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.submission_rates
    ADD CONSTRAINT submission_rates_submission_id_fkey FOREIGN KEY (submission_id) REFERENCES public.submissions(id) ON DELETE CASCADE;


--
-- Name: submission_screening_answers submission_screening_answers_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.submission_screening_answers
    ADD CONSTRAINT submission_screening_answers_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: submission_screening_answers submission_screening_answers_question_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.submission_screening_answers
    ADD CONSTRAINT submission_screening_answers_question_id_fkey FOREIGN KEY (question_id) REFERENCES public.job_screening_questions(id) ON DELETE CASCADE;


--
-- Name: submission_screening_answers submission_screening_answers_submission_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.submission_screening_answers
    ADD CONSTRAINT submission_screening_answers_submission_id_fkey FOREIGN KEY (submission_id) REFERENCES public.submissions(id) ON DELETE CASCADE;


--
-- Name: submission_status_history submission_status_history_changed_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.submission_status_history
    ADD CONSTRAINT submission_status_history_changed_by_fkey FOREIGN KEY (changed_by) REFERENCES public.user_profiles(id);


--
-- Name: submission_status_history submission_status_history_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.submission_status_history
    ADD CONSTRAINT submission_status_history_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: submission_status_history submission_status_history_submission_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.submission_status_history
    ADD CONSTRAINT submission_status_history_submission_id_fkey FOREIGN KEY (submission_id) REFERENCES public.submissions(id) ON DELETE CASCADE;


--
-- Name: submissions submissions_account_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.submissions
    ADD CONSTRAINT submissions_account_id_fkey FOREIGN KEY (account_id) REFERENCES public.accounts(id);


--
-- Name: submissions submissions_candidate_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.submissions
    ADD CONSTRAINT submissions_candidate_id_fkey FOREIGN KEY (candidate_id) REFERENCES public.user_profiles(id);


--
-- Name: submissions submissions_company_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.submissions
    ADD CONSTRAINT submissions_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id);


--
-- Name: submissions submissions_contact_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.submissions
    ADD CONSTRAINT submissions_contact_id_fkey FOREIGN KEY (contact_id) REFERENCES public.contacts(id);


--
-- Name: submissions submissions_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.submissions
    ADD CONSTRAINT submissions_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: submissions submissions_job_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.submissions
    ADD CONSTRAINT submissions_job_id_fkey FOREIGN KEY (job_id) REFERENCES public.jobs(id);


--
-- Name: submissions submissions_offer_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.submissions
    ADD CONSTRAINT submissions_offer_id_fkey FOREIGN KEY (offer_id) REFERENCES public.offers(id);


--
-- Name: submissions submissions_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.submissions
    ADD CONSTRAINT submissions_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: submissions submissions_owner_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.submissions
    ADD CONSTRAINT submissions_owner_id_fkey FOREIGN KEY (owner_id) REFERENCES public.user_profiles(id);


--
-- Name: submissions submissions_placement_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.submissions
    ADD CONSTRAINT submissions_placement_id_fkey FOREIGN KEY (placement_id) REFERENCES public.placements(id);


--
-- Name: submissions submissions_submitted_to_client_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.submissions
    ADD CONSTRAINT submissions_submitted_to_client_by_fkey FOREIGN KEY (submitted_to_client_by) REFERENCES public.user_profiles(id);


--
-- Name: submissions submissions_vendor_decision_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.submissions
    ADD CONSTRAINT submissions_vendor_decision_by_fkey FOREIGN KEY (vendor_decision_by) REFERENCES public.user_profiles(id);


--
-- Name: submissions submissions_vendor_submitted_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.submissions
    ADD CONSTRAINT submissions_vendor_submitted_by_fkey FOREIGN KEY (vendor_submitted_by) REFERENCES public.user_profiles(id);


--
-- Name: system_settings system_settings_updated_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.system_settings
    ADD CONSTRAINT system_settings_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES public.user_profiles(id);


--
-- Name: talking_point_templates talking_point_templates_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.talking_point_templates
    ADD CONSTRAINT talking_point_templates_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: talking_point_templates talking_point_templates_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.talking_point_templates
    ADD CONSTRAINT talking_point_templates_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: tasks tasks_assigned_to_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.tasks
    ADD CONSTRAINT tasks_assigned_to_fkey FOREIGN KEY (assigned_to) REFERENCES public.user_profiles(id);


--
-- Name: tasks tasks_completed_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.tasks
    ADD CONSTRAINT tasks_completed_by_fkey FOREIGN KEY (completed_by) REFERENCES public.user_profiles(id);


--
-- Name: tasks tasks_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.tasks
    ADD CONSTRAINT tasks_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: tasks tasks_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.tasks
    ADD CONSTRAINT tasks_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: tasks tasks_parent_task_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.tasks
    ADD CONSTRAINT tasks_parent_task_id_fkey FOREIGN KEY (parent_task_id) REFERENCES public.tasks(id);


--
-- Name: team_metrics team_metrics_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.team_metrics
    ADD CONSTRAINT team_metrics_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: team_metrics team_metrics_pod_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.team_metrics
    ADD CONSTRAINT team_metrics_pod_id_fkey FOREIGN KEY (pod_id) REFERENCES public.pods(id);


--
-- Name: time_attendance time_attendance_approved_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.time_attendance
    ADD CONSTRAINT time_attendance_approved_by_fkey FOREIGN KEY (approved_by) REFERENCES public.user_profiles(id);


--
-- Name: time_attendance time_attendance_employee_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.time_attendance
    ADD CONSTRAINT time_attendance_employee_id_fkey FOREIGN KEY (employee_id) REFERENCES public.user_profiles(id);


--
-- Name: topic_completions topic_completions_course_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.topic_completions
    ADD CONSTRAINT topic_completions_course_id_fkey FOREIGN KEY (course_id) REFERENCES public.courses(id) ON DELETE RESTRICT;


--
-- Name: topic_completions topic_completions_enrollment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.topic_completions
    ADD CONSTRAINT topic_completions_enrollment_id_fkey FOREIGN KEY (enrollment_id) REFERENCES public.student_enrollments(id) ON DELETE CASCADE;


--
-- Name: topic_completions topic_completions_module_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.topic_completions
    ADD CONSTRAINT topic_completions_module_id_fkey FOREIGN KEY (module_id) REFERENCES public.course_modules(id) ON DELETE RESTRICT;


--
-- Name: topic_completions topic_completions_topic_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.topic_completions
    ADD CONSTRAINT topic_completions_topic_id_fkey FOREIGN KEY (topic_id) REFERENCES public.module_topics(id) ON DELETE RESTRICT;


--
-- Name: topic_completions topic_completions_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.topic_completions
    ADD CONSTRAINT topic_completions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: topic_lessons topic_lessons_topic_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.topic_lessons
    ADD CONSTRAINT topic_lessons_topic_id_fkey FOREIGN KEY (topic_id) REFERENCES public.module_topics(id) ON DELETE CASCADE;


--
-- Name: trainer_responses trainer_responses_escalation_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.trainer_responses
    ADD CONSTRAINT trainer_responses_escalation_id_fkey FOREIGN KEY (escalation_id) REFERENCES public.ai_mentor_escalations(id) ON DELETE CASCADE;


--
-- Name: trainer_responses trainer_responses_trainer_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.trainer_responses
    ADD CONSTRAINT trainer_responses_trainer_id_fkey FOREIGN KEY (trainer_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: twin_conversations twin_conversations_initiator_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.twin_conversations
    ADD CONSTRAINT twin_conversations_initiator_user_id_fkey FOREIGN KEY (initiator_user_id) REFERENCES public.user_profiles(id) ON DELETE SET NULL;


--
-- Name: twin_events twin_events_processed_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.twin_events
    ADD CONSTRAINT twin_events_processed_by_fkey FOREIGN KEY (processed_by) REFERENCES public.user_profiles(id);


--
-- Name: twin_events twin_events_source_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.twin_events
    ADD CONSTRAINT twin_events_source_user_id_fkey FOREIGN KEY (source_user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: twin_preferences twin_preferences_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.twin_preferences
    ADD CONSTRAINT twin_preferences_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: user_achievements user_achievements_achievement_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_achievements
    ADD CONSTRAINT user_achievements_achievement_id_fkey FOREIGN KEY (achievement_id) REFERENCES public.achievements(id);


--
-- Name: user_achievements user_achievements_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_achievements
    ADD CONSTRAINT user_achievements_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id);


--
-- Name: user_badges user_badges_badge_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_badges
    ADD CONSTRAINT user_badges_badge_id_fkey FOREIGN KEY (badge_id) REFERENCES public.badges(id) ON DELETE CASCADE;


--
-- Name: user_badges user_badges_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_badges
    ADD CONSTRAINT user_badges_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: user_invitations user_invitations_invited_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_invitations
    ADD CONSTRAINT user_invitations_invited_by_fkey FOREIGN KEY (invited_by) REFERENCES public.user_profiles(id);


--
-- Name: user_invitations user_invitations_manager_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_invitations
    ADD CONSTRAINT user_invitations_manager_id_fkey FOREIGN KEY (manager_id) REFERENCES public.user_profiles(id) ON DELETE SET NULL;


--
-- Name: user_invitations user_invitations_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_invitations
    ADD CONSTRAINT user_invitations_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: user_invitations user_invitations_pod_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_invitations
    ADD CONSTRAINT user_invitations_pod_id_fkey FOREIGN KEY (pod_id) REFERENCES public.pods(id) ON DELETE SET NULL;


--
-- Name: user_invitations user_invitations_role_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_invitations
    ADD CONSTRAINT user_invitations_role_id_fkey FOREIGN KEY (role_id) REFERENCES public.system_roles(id);


--
-- Name: user_levels user_levels_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_levels
    ADD CONSTRAINT user_levels_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id);


--
-- Name: user_profiles user_profiles_manager_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_profiles
    ADD CONSTRAINT user_profiles_manager_id_fkey FOREIGN KEY (manager_id) REFERENCES public.user_profiles(id);


--
-- Name: user_profiles user_profiles_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_profiles
    ADD CONSTRAINT user_profiles_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: user_profiles user_profiles_role_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_profiles
    ADD CONSTRAINT user_profiles_role_id_fkey FOREIGN KEY (role_id) REFERENCES public.system_roles(id);


--
-- Name: user_roles user_roles_assigned_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_roles
    ADD CONSTRAINT user_roles_assigned_by_fkey FOREIGN KEY (assigned_by) REFERENCES public.user_profiles(id);


--
-- Name: user_roles user_roles_role_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_roles
    ADD CONSTRAINT user_roles_role_id_fkey FOREIGN KEY (role_id) REFERENCES public.roles(id) ON DELETE CASCADE;


--
-- Name: user_roles user_roles_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_roles
    ADD CONSTRAINT user_roles_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: user_session_context user_session_context_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_session_context
    ADD CONSTRAINT user_session_context_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: vendor_blacklist vendor_blacklist_blacklisted_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.vendor_blacklist
    ADD CONSTRAINT vendor_blacklist_blacklisted_by_fkey FOREIGN KEY (blacklisted_by) REFERENCES public.user_profiles(id);


--
-- Name: vendor_blacklist vendor_blacklist_vendor_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.vendor_blacklist
    ADD CONSTRAINT vendor_blacklist_vendor_id_fkey FOREIGN KEY (vendor_id) REFERENCES public.vendors(id) ON DELETE CASCADE;


--
-- Name: vendor_performance vendor_performance_vendor_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.vendor_performance
    ADD CONSTRAINT vendor_performance_vendor_id_fkey FOREIGN KEY (vendor_id) REFERENCES public.vendors(id) ON DELETE CASCADE;


--
-- Name: vendor_relationships vendor_relationships_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.vendor_relationships
    ADD CONSTRAINT vendor_relationships_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: vendor_relationships vendor_relationships_vendor_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.vendor_relationships
    ADD CONSTRAINT vendor_relationships_vendor_id_fkey FOREIGN KEY (vendor_id) REFERENCES public.vendors(id) ON DELETE CASCADE;


--
-- Name: vendor_terms vendor_terms_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.vendor_terms
    ADD CONSTRAINT vendor_terms_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: vendor_terms vendor_terms_vendor_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.vendor_terms
    ADD CONSTRAINT vendor_terms_vendor_id_fkey FOREIGN KEY (vendor_id) REFERENCES public.vendors(id) ON DELETE CASCADE;


--
-- Name: vendors vendors_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.vendors
    ADD CONSTRAINT vendors_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: vendors vendors_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.vendors
    ADD CONSTRAINT vendors_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: video_progress video_progress_enrollment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.video_progress
    ADD CONSTRAINT video_progress_enrollment_id_fkey FOREIGN KEY (enrollment_id) REFERENCES public.student_enrollments(id) ON DELETE CASCADE;


--
-- Name: video_progress video_progress_topic_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.video_progress
    ADD CONSTRAINT video_progress_topic_id_fkey FOREIGN KEY (topic_id) REFERENCES public.module_topics(id) ON DELETE CASCADE;


--
-- Name: video_progress video_progress_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.video_progress
    ADD CONSTRAINT video_progress_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: webhook_deliveries webhook_deliveries_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.webhook_deliveries
    ADD CONSTRAINT webhook_deliveries_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: webhook_deliveries webhook_deliveries_webhook_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.webhook_deliveries
    ADD CONSTRAINT webhook_deliveries_webhook_id_fkey FOREIGN KEY (webhook_id) REFERENCES public.webhooks(id) ON DELETE CASCADE;


--
-- Name: webhooks webhooks_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.webhooks
    ADD CONSTRAINT webhooks_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: webhooks webhooks_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.webhooks
    ADD CONSTRAINT webhooks_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: work_queues work_queues_assigned_to_group_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.work_queues
    ADD CONSTRAINT work_queues_assigned_to_group_id_fkey FOREIGN KEY (assigned_to_group_id) REFERENCES public.pods(id);


--
-- Name: work_queues work_queues_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.work_queues
    ADD CONSTRAINT work_queues_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: workflow_history workflow_history_from_state_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflow_history
    ADD CONSTRAINT workflow_history_from_state_id_fkey FOREIGN KEY (from_state_id) REFERENCES public.workflow_states(id);


--
-- Name: workflow_history workflow_history_performed_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflow_history
    ADD CONSTRAINT workflow_history_performed_by_fkey FOREIGN KEY (performed_by) REFERENCES public.user_profiles(id);


--
-- Name: workflow_history workflow_history_to_state_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflow_history
    ADD CONSTRAINT workflow_history_to_state_id_fkey FOREIGN KEY (to_state_id) REFERENCES public.workflow_states(id);


--
-- Name: workflow_history workflow_history_workflow_instance_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflow_history
    ADD CONSTRAINT workflow_history_workflow_instance_id_fkey FOREIGN KEY (workflow_instance_id) REFERENCES public.workflow_instances(id) ON DELETE CASCADE;


--
-- Name: workflow_instances workflow_instances_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflow_instances
    ADD CONSTRAINT workflow_instances_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: workflow_instances workflow_instances_current_state_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflow_instances
    ADD CONSTRAINT workflow_instances_current_state_id_fkey FOREIGN KEY (current_state_id) REFERENCES public.workflow_states(id);


--
-- Name: workflow_instances workflow_instances_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflow_instances
    ADD CONSTRAINT workflow_instances_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: workflow_instances workflow_instances_workflow_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflow_instances
    ADD CONSTRAINT workflow_instances_workflow_id_fkey FOREIGN KEY (workflow_id) REFERENCES public.workflows(id);


--
-- Name: workflow_states workflow_states_workflow_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflow_states
    ADD CONSTRAINT workflow_states_workflow_id_fkey FOREIGN KEY (workflow_id) REFERENCES public.workflows(id) ON DELETE CASCADE;


--
-- Name: workflow_transitions workflow_transitions_from_state_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflow_transitions
    ADD CONSTRAINT workflow_transitions_from_state_id_fkey FOREIGN KEY (from_state_id) REFERENCES public.workflow_states(id) ON DELETE CASCADE;


--
-- Name: workflow_transitions workflow_transitions_to_state_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflow_transitions
    ADD CONSTRAINT workflow_transitions_to_state_id_fkey FOREIGN KEY (to_state_id) REFERENCES public.workflow_states(id) ON DELETE CASCADE;


--
-- Name: workflow_transitions workflow_transitions_workflow_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflow_transitions
    ADD CONSTRAINT workflow_transitions_workflow_id_fkey FOREIGN KEY (workflow_id) REFERENCES public.workflows(id) ON DELETE CASCADE;


--
-- Name: workflows workflows_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflows
    ADD CONSTRAINT workflows_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: workflows workflows_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workflows
    ADD CONSTRAINT workflows_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: workplan_instances workplan_instances_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workplan_instances
    ADD CONSTRAINT workplan_instances_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.user_profiles(id);


--
-- Name: workplan_instances workplan_instances_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workplan_instances
    ADD CONSTRAINT workplan_instances_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: workplan_instances workplan_instances_template_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workplan_instances
    ADD CONSTRAINT workplan_instances_template_id_fkey FOREIGN KEY (template_id) REFERENCES public.workplan_templates(id);


--
-- Name: workplan_phases workplan_phases_template_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workplan_phases
    ADD CONSTRAINT workplan_phases_template_id_fkey FOREIGN KEY (template_id) REFERENCES public.workplan_templates(id) ON DELETE CASCADE;


--
-- Name: workplan_template_activities workplan_template_activities_pattern_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workplan_template_activities
    ADD CONSTRAINT workplan_template_activities_pattern_id_fkey FOREIGN KEY (pattern_id) REFERENCES public.activity_patterns(id) ON DELETE CASCADE;


--
-- Name: workplan_template_activities workplan_template_activities_template_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workplan_template_activities
    ADD CONSTRAINT workplan_template_activities_template_id_fkey FOREIGN KEY (template_id) REFERENCES public.workplan_templates(id) ON DELETE CASCADE;


--
-- Name: workplan_templates workplan_templates_org_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.workplan_templates
    ADD CONSTRAINT workplan_templates_org_id_fkey FOREIGN KEY (org_id) REFERENCES public.organizations(id) ON DELETE CASCADE;


--
-- Name: xp_transactions xp_transactions_awarded_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.xp_transactions
    ADD CONSTRAINT xp_transactions_awarded_by_fkey FOREIGN KEY (awarded_by) REFERENCES public.user_profiles(id);


--
-- Name: xp_transactions xp_transactions_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.xp_transactions
    ADD CONSTRAINT xp_transactions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id) ON DELETE CASCADE;


--
-- Name: user_profiles Admins can insert profiles; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Admins can insert profiles" ON public.user_profiles FOR INSERT WITH CHECK (public.user_is_admin());


--
-- Name: alert_rules Admins can manage alert rules; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Admins can manage alert rules" ON public.alert_rules USING ((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid()))));


--
-- Name: audit_log_retention_policy Admins can manage retention policies; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Admins can manage retention policies" ON public.audit_log_retention_policy USING (public.user_is_admin()) WITH CHECK (public.user_is_admin());


--
-- Name: security_alerts Admins can manage security alerts; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Admins can manage security alerts" ON public.security_alerts USING ((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid()))));


--
-- Name: event_subscriptions Admins can manage subscriptions; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Admins can manage subscriptions" ON public.event_subscriptions USING (public.user_is_admin()) WITH CHECK (public.user_is_admin());


--
-- Name: user_roles Admins can manage user roles; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Admins can manage user roles" ON public.user_roles USING (public.user_is_admin()) WITH CHECK (public.user_is_admin());


--
-- Name: user_profiles Admins can soft delete profiles; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Admins can soft delete profiles" ON public.user_profiles FOR UPDATE USING (public.user_is_admin()) WITH CHECK ((deleted_at IS NOT NULL));


--
-- Name: user_profiles Admins can update any profile; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Admins can update any profile" ON public.user_profiles FOR UPDATE USING (public.user_is_admin());


--
-- Name: audit_logs Admins can view all audit logs; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Admins can view all audit logs" ON public.audit_logs FOR SELECT USING (public.user_is_admin());


--
-- Name: events Admins can view all events; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Admins can view all events" ON public.events FOR SELECT USING (public.user_is_admin());


--
-- Name: onboarding_checklist Admins can view all onboarding checklists; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Admins can view all onboarding checklists" ON public.onboarding_checklist FOR SELECT USING ((EXISTS ( SELECT 1
   FROM (public.user_roles ur
     JOIN public.roles r ON ((r.id = ur.role_id)))
  WHERE ((ur.user_id = auth.uid()) AND (r.name = ANY (ARRAY['admin'::text, 'super_admin'::text]))))));


--
-- Name: user_profiles Admins can view all profiles; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Admins can view all profiles" ON public.user_profiles FOR SELECT USING (public.user_is_admin());


--
-- Name: user_roles Admins can view all user roles; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Admins can view all user roles" ON public.user_roles FOR SELECT USING (public.user_is_admin());


--
-- Name: event_delivery_log Admins can view delivery logs; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Admins can view delivery logs" ON public.event_delivery_log FOR SELECT USING (public.user_is_admin());


--
-- Name: session_metadata Admins can view sessions; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Admins can view sessions" ON public.session_metadata FOR SELECT USING (public.user_is_admin());


--
-- Name: project_timeline Admins can view timeline; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Admins can view timeline" ON public.project_timeline FOR SELECT USING (public.user_is_admin());


--
-- Name: student_enrollments Admins create enrollments; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Admins create enrollments" ON public.student_enrollments FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM public.user_roles
  WHERE ((user_roles.user_id = auth.uid()) AND (user_roles.role_id IN ( SELECT roles.id
           FROM public.roles
          WHERE (roles.name = ANY (ARRAY['admin'::text, 'course_admin'::text]))))))));


--
-- Name: project_timeline Allow all for authenticated users; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Allow all for authenticated users" ON public.project_timeline USING (true) WITH CHECK (true);


--
-- Name: session_metadata Allow all for authenticated users; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Allow all for authenticated users" ON public.session_metadata USING (true) WITH CHECK (true);


--
-- Name: organizations Authenticated users can view active organizations; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Authenticated users can view active organizations" ON public.organizations FOR SELECT USING (((status = 'active'::text) AND (deleted_at IS NULL) AND ((id = public.auth_user_org_id()) OR public.user_is_admin())));


--
-- Name: content_assets Enrolled students view course assets; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Enrolled students view course assets" ON public.content_assets FOR SELECT USING ((EXISTS ( SELECT 1
   FROM ((public.student_enrollments se
     JOIN public.course_modules cm ON ((cm.course_id = se.course_id)))
     JOIN public.module_topics mt ON ((mt.module_id = cm.id)))
  WHERE ((mt.id = content_assets.topic_id) AND (se.user_id = auth.uid()) AND (se.status = ANY (ARRAY['active'::text, 'completed'::text]))))));


--
-- Name: roles Everyone can view active roles; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Everyone can view active roles" ON public.roles FOR SELECT USING (((deleted_at IS NULL) AND (is_active = true)));


--
-- Name: audit_log_retention_policy Everyone can view retention policies; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Everyone can view retention policies" ON public.audit_log_retention_policy FOR SELECT USING (true);


--
-- Name: event_subscriptions Everyone can view subscriptions; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Everyone can view subscriptions" ON public.event_subscriptions FOR SELECT USING ((is_active = true));


--
-- Name: user_profiles HR managers can view employees; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "HR managers can view employees" ON public.user_profiles FOR SELECT USING ((public.user_has_role('hr_manager'::text) AND (employee_hire_date IS NOT NULL) AND (deleted_at IS NULL)));


--
-- Name: email_templates Only admins can create email templates; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Only admins can create email templates" ON public.email_templates FOR INSERT WITH CHECK (public.user_is_admin());


--
-- Name: organizations Only admins can create organizations; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Only admins can create organizations" ON public.organizations FOR INSERT WITH CHECK (public.user_is_admin());


--
-- Name: document_templates Only admins can create templates; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Only admins can create templates" ON public.document_templates FOR INSERT WITH CHECK (public.user_is_admin());


--
-- Name: workflows Only admins can create workflows; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Only admins can create workflows" ON public.workflows FOR INSERT WITH CHECK (public.user_is_admin());


--
-- Name: student_interventions Only admins can delete interventions; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Only admins can delete interventions" ON public.student_interventions FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM (public.user_roles ur
     JOIN public.roles r ON ((r.id = ur.role_id)))
  WHERE ((ur.user_id = auth.uid()) AND (r.name = ANY (ARRAY['admin'::text, 'super_admin'::text]))))));


--
-- Name: organizations Only admins can delete organizations; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Only admins can delete organizations" ON public.organizations FOR DELETE USING (public.user_is_admin());


--
-- Name: document_templates Only admins can delete templates; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Only admins can delete templates" ON public.document_templates FOR DELETE USING (public.user_is_admin());


--
-- Name: workflows Only admins can delete workflows; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Only admins can delete workflows" ON public.workflows FOR DELETE USING (public.user_is_admin());


--
-- Name: workflow_states Only admins can modify workflow states; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Only admins can modify workflow states" ON public.workflow_states USING (public.user_is_admin());


--
-- Name: workflow_transitions Only admins can modify workflow transitions; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Only admins can modify workflow transitions" ON public.workflow_transitions USING (public.user_is_admin());


--
-- Name: email_templates Only admins can update email templates; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Only admins can update email templates" ON public.email_templates FOR UPDATE USING (public.user_is_admin());


--
-- Name: organizations Only admins can update organizations; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Only admins can update organizations" ON public.organizations FOR UPDATE USING ((public.user_is_admin() OR ((id = public.auth_user_org_id()) AND public.user_has_role('org_admin'::text))));


--
-- Name: document_templates Only admins can update templates; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Only admins can update templates" ON public.document_templates FOR UPDATE USING (public.user_is_admin());


--
-- Name: workflows Only admins can update workflows; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Only admins can update workflows" ON public.workflows FOR UPDATE USING (public.user_is_admin());


--
-- Name: content_assets Public assets viewable by all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Public assets viewable by all" ON public.content_assets FOR SELECT USING ((is_public = true));


--
-- Name: user_profiles Recruiters can view candidates; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Recruiters can view candidates" ON public.user_profiles FOR SELECT USING ((public.user_has_any_role(ARRAY['recruiter'::text, 'bench_sales'::text]) AND (candidate_status IS NOT NULL) AND (deleted_at IS NULL)));


--
-- Name: organizations Service role can create organizations; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role can create organizations" ON public.organizations FOR INSERT WITH CHECK (true);


--
-- Name: email_logs Service role can insert email logs; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role can insert email logs" ON public.email_logs FOR INSERT WITH CHECK (true);


--
-- Name: workflow_history Service role can insert workflow history; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role can insert workflow history" ON public.workflow_history FOR INSERT WITH CHECK (true);


--
-- Name: email_logs Service role can update email logs; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role can update email logs" ON public.email_logs FOR UPDATE USING (true);


--
-- Name: background_jobs Service role can update jobs; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role can update jobs" ON public.background_jobs FOR UPDATE USING (true);


--
-- Name: workflow_instances Service role can update workflow instances; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Service role can update workflow instances" ON public.workflow_instances FOR UPDATE USING (true);


--
-- Name: interview_sessions Students can insert own interview sessions; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Students can insert own interview sessions" ON public.interview_sessions FOR INSERT WITH CHECK ((student_id = auth.uid()));


--
-- Name: resume_versions Students can insert own resumes; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Students can insert own resumes" ON public.resume_versions FOR INSERT WITH CHECK ((student_id = auth.uid()));


--
-- Name: guru_interactions Students can update own feedback; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Students can update own feedback" ON public.guru_interactions FOR UPDATE USING ((student_id = auth.uid())) WITH CHECK ((student_id = auth.uid()));


--
-- Name: interview_sessions Students can update own interview sessions; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Students can update own interview sessions" ON public.interview_sessions FOR UPDATE USING ((student_id = auth.uid())) WITH CHECK ((student_id = auth.uid()));


--
-- Name: resume_versions Students can update own resumes; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Students can update own resumes" ON public.resume_versions FOR UPDATE USING ((student_id = auth.uid())) WITH CHECK ((student_id = auth.uid()));


--
-- Name: student_interventions Students can view own interventions; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Students can view own interventions" ON public.student_interventions FOR SELECT USING ((student_id = auth.uid()));


--
-- Name: interview_sessions Students can view own interview sessions; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Students can view own interview sessions" ON public.interview_sessions FOR SELECT USING ((student_id = auth.uid()));


--
-- Name: resume_versions Students can view own resumes; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Students can view own resumes" ON public.resume_versions FOR SELECT USING ((student_id = auth.uid()));


--
-- Name: student_enrollments Students update own enrollments; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Students update own enrollments" ON public.student_enrollments FOR UPDATE USING (((auth.uid() = user_id) OR (EXISTS ( SELECT 1
   FROM public.user_roles
  WHERE ((user_roles.user_id = auth.uid()) AND (user_roles.role_id IN ( SELECT roles.id
           FROM public.roles
          WHERE (roles.name = ANY (ARRAY['admin'::text, 'trainer'::text, 'course_admin'::text])))))))));


--
-- Name: student_enrollments Students view own enrollments; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Students view own enrollments" ON public.student_enrollments FOR SELECT USING (((auth.uid() = user_id) OR (EXISTS ( SELECT 1
   FROM public.user_roles
  WHERE ((user_roles.user_id = auth.uid()) AND (user_roles.role_id IN ( SELECT roles.id
           FROM public.roles
          WHERE (roles.name = ANY (ARRAY['admin'::text, 'trainer'::text, 'course_admin'::text])))))))));


--
-- Name: roles Super admins can manage roles; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Super admins can manage roles" ON public.roles USING (public.user_has_role('super_admin'::text)) WITH CHECK (public.user_has_role('super_admin'::text));


--
-- Name: audit_logs System can insert audit logs; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "System can insert audit logs" ON public.audit_logs FOR INSERT WITH CHECK (true);


--
-- Name: event_delivery_log System can insert delivery logs; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "System can insert delivery logs" ON public.event_delivery_log FOR INSERT WITH CHECK (true);


--
-- Name: guru_interactions System can insert guru interactions; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "System can insert guru interactions" ON public.guru_interactions FOR INSERT WITH CHECK (true);


--
-- Name: onboarding_checklist System can insert onboarding checklist; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "System can insert onboarding checklist" ON public.onboarding_checklist FOR INSERT WITH CHECK ((user_id = auth.uid()));


--
-- Name: session_metadata System can insert sessions; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "System can insert sessions" ON public.session_metadata FOR INSERT WITH CHECK (true);


--
-- Name: project_timeline System can insert timeline; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "System can insert timeline" ON public.project_timeline FOR INSERT WITH CHECK (true);


--
-- Name: student_progress System can manage student progress; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "System can manage student progress" ON public.student_progress USING (true) WITH CHECK (true);


--
-- Name: events System can publish events; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "System can publish events" ON public.events FOR INSERT WITH CHECK (true);


--
-- Name: events System can update events; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "System can update events" ON public.events FOR UPDATE USING (true);


--
-- Name: student_interventions Trainers and admins can create interventions; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Trainers and admins can create interventions" ON public.student_interventions FOR INSERT WITH CHECK ((EXISTS ( SELECT 1
   FROM (public.user_roles ur
     JOIN public.roles r ON ((r.id = ur.role_id)))
  WHERE ((ur.user_id = auth.uid()) AND (r.name = ANY (ARRAY['trainer'::text, 'admin'::text, 'super_admin'::text]))))));


--
-- Name: student_interventions Trainers and admins can view all interventions; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Trainers and admins can view all interventions" ON public.student_interventions FOR SELECT USING ((EXISTS ( SELECT 1
   FROM (public.user_roles ur
     JOIN public.roles r ON ((r.id = ur.role_id)))
  WHERE ((ur.user_id = auth.uid()) AND (r.name = ANY (ARRAY['trainer'::text, 'admin'::text, 'super_admin'::text]))))));


--
-- Name: student_interventions Trainers can update assigned interventions; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Trainers can update assigned interventions" ON public.student_interventions FOR UPDATE USING (((assigned_trainer_id = auth.uid()) OR (EXISTS ( SELECT 1
   FROM (public.user_roles ur
     JOIN public.roles r ON ((r.id = ur.role_id)))
  WHERE ((ur.user_id = auth.uid()) AND (r.name = ANY (ARRAY['admin'::text, 'super_admin'::text])))))));


--
-- Name: user_profiles Trainers can view students; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Trainers can view students" ON public.user_profiles FOR SELECT USING ((public.user_has_role('trainer'::text) AND (student_enrollment_date IS NOT NULL) AND (deleted_at IS NULL)));


--
-- Name: generated_documents Users can create generated documents in their org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can create generated documents in their org" ON public.generated_documents FOR INSERT WITH CHECK ((org_id = public.auth_user_org_id()));


--
-- Name: background_jobs Users can create jobs in their org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can create jobs in their org" ON public.background_jobs FOR INSERT WITH CHECK ((org_id = public.auth_user_org_id()));


--
-- Name: workflow_instances Users can create workflow instances in their org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can create workflow instances in their org" ON public.workflow_instances FOR INSERT WITH CHECK ((org_id = public.auth_user_org_id()));


--
-- Name: job_status_history Users can insert job status history in their org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can insert job status history in their org" ON public.job_status_history FOR INSERT WITH CHECK ((org_id = ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid()))));


--
-- Name: placement_checkins Users can insert placement checkins for their org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can insert placement checkins for their org" ON public.placement_checkins FOR INSERT WITH CHECK ((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE ((user_profiles.id = auth.uid()) OR (user_profiles.auth_id = auth.uid())))));


--
-- Name: candidate_resumes Users can insert resumes in their org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can insert resumes in their org" ON public.candidate_resumes FOR INSERT WITH CHECK ((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.auth_id = auth.uid()))));


--
-- Name: interviews Users can manage interviews in their organization; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can manage interviews in their organization" ON public.interviews USING ((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.auth_id = auth.uid()))));


--
-- Name: offers Users can manage offers in their organization; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can manage offers in their organization" ON public.offers USING ((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.auth_id = auth.uid()))));


--
-- Name: organization_branding Users can manage their org branding; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can manage their org branding" ON public.organization_branding USING (((org_id = public.auth_user_org_id()) OR public.user_is_admin()));


--
-- Name: organization_settings Users can manage their org settings; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can manage their org settings" ON public.organization_settings USING (((org_id = public.auth_user_org_id()) OR public.user_is_admin()));


--
-- Name: file_uploads Users can soft-delete their own files; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can soft-delete their own files" ON public.file_uploads FOR UPDATE USING (((org_id = public.auth_user_org_id()) AND (uploaded_by = public.auth_user_id()))) WITH CHECK (((org_id = public.auth_user_org_id()) AND (uploaded_by = public.auth_user_id())));


--
-- Name: onboarding_checklist Users can update own onboarding checklist; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update own onboarding checklist" ON public.onboarding_checklist FOR UPDATE USING ((user_id = auth.uid()));


--
-- Name: user_profiles Users can update own profile; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update own profile" ON public.user_profiles FOR UPDATE USING (((id = public.auth_user_id()) OR public.user_is_admin())) WITH CHECK (((id = public.auth_user_id()) OR public.user_is_admin()));


--
-- Name: candidate_resumes Users can update resumes in their org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update resumes in their org" ON public.candidate_resumes FOR UPDATE USING ((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.auth_id = auth.uid()))));


--
-- Name: placement_checkins Users can update their org's placement checkins; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can update their org's placement checkins" ON public.placement_checkins FOR UPDATE USING ((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE ((user_profiles.id = auth.uid()) OR (user_profiles.auth_id = auth.uid())))));


--
-- Name: file_uploads Users can upload files to their org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can upload files to their org" ON public.file_uploads FOR INSERT WITH CHECK ((org_id = public.auth_user_org_id()));


--
-- Name: alert_rules Users can view alert rules in their org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view alert rules in their org" ON public.alert_rules FOR SELECT USING ((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid()))));


--
-- Name: audit_logs Users can view audit logs in their org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view audit logs in their org" ON public.audit_logs FOR SELECT USING (((org_id = public.auth_user_org_id()) OR public.user_is_admin()));


--
-- Name: event_delivery_log Users can view delivery logs in their org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view delivery logs in their org" ON public.event_delivery_log FOR SELECT USING (((org_id = public.auth_user_org_id()) OR public.user_is_admin()));


--
-- Name: email_logs Users can view email logs in their org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view email logs in their org" ON public.email_logs FOR SELECT USING (((org_id = public.auth_user_org_id()) OR public.user_is_admin()));


--
-- Name: email_templates Users can view email templates in their org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view email templates in their org" ON public.email_templates FOR SELECT USING (((org_id = public.auth_user_org_id()) OR public.user_is_admin()));


--
-- Name: events Users can view events in their org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view events in their org" ON public.events FOR SELECT USING (((org_id = public.auth_user_org_id()) OR public.user_is_admin()));


--
-- Name: file_uploads Users can view files in their org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view files in their org" ON public.file_uploads FOR SELECT USING ((((org_id = public.auth_user_org_id()) AND (deleted_at IS NULL)) OR public.user_is_admin()));


--
-- Name: generated_documents Users can view generated documents in their org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view generated documents in their org" ON public.generated_documents FOR SELECT USING (((org_id = public.auth_user_org_id()) OR public.user_is_admin()));


--
-- Name: interviews Users can view interviews in their organization; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view interviews in their organization" ON public.interviews FOR SELECT USING ((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.auth_id = auth.uid()))));


--
-- Name: job_status_history Users can view job status history in their org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view job status history in their org" ON public.job_status_history FOR SELECT USING ((org_id = ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid()))));


--
-- Name: background_jobs Users can view jobs in their org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view jobs in their org" ON public.background_jobs FOR SELECT USING (((org_id = public.auth_user_org_id()) OR public.user_is_admin()));


--
-- Name: offers Users can view offers in their organization; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view offers in their organization" ON public.offers FOR SELECT USING ((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.auth_id = auth.uid()))));


--
-- Name: audit_logs Users can view own audit logs; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view own audit logs" ON public.audit_logs FOR SELECT USING ((user_id = public.auth_user_id()));


--
-- Name: events Users can view own events; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view own events" ON public.events FOR SELECT USING ((user_id = public.auth_user_id()));


--
-- Name: onboarding_checklist Users can view own onboarding checklist; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view own onboarding checklist" ON public.onboarding_checklist FOR SELECT USING ((user_id = auth.uid()));


--
-- Name: user_profiles Users can view own profile; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view own profile" ON public.user_profiles FOR SELECT USING (((id = public.auth_user_id()) OR public.user_is_admin()));


--
-- Name: user_roles Users can view own roles; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view own roles" ON public.user_roles FOR SELECT USING (((user_id = public.auth_user_id()) OR public.user_is_admin()));


--
-- Name: user_profiles Users can view profiles in their org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view profiles in their org" ON public.user_profiles FOR SELECT USING (((org_id = public.auth_user_org_id()) AND (org_id IS NOT NULL)));


--
-- Name: candidate_resumes Users can view resumes in their org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view resumes in their org" ON public.candidate_resumes FOR SELECT USING ((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.auth_id = auth.uid()))));


--
-- Name: security_alerts Users can view security alerts in their org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view security alerts in their org" ON public.security_alerts FOR SELECT USING ((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid()))));


--
-- Name: session_metadata Users can view sessions in their org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view sessions in their org" ON public.session_metadata FOR SELECT USING (((org_id = public.auth_user_org_id()) OR public.user_is_admin()));


--
-- Name: document_templates Users can view templates in their org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view templates in their org" ON public.document_templates FOR SELECT USING (((org_id = public.auth_user_org_id()) OR public.user_is_admin()));


--
-- Name: organization_branding Users can view their org branding; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view their org branding" ON public.organization_branding FOR SELECT USING (((org_id = public.auth_user_org_id()) OR public.user_is_admin()));


--
-- Name: organization_settings Users can view their org settings; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view their org settings" ON public.organization_settings FOR SELECT USING (((org_id = public.auth_user_org_id()) OR public.user_is_admin()));


--
-- Name: placement_checkins Users can view their org's placement checkins; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view their org's placement checkins" ON public.placement_checkins FOR SELECT USING ((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE ((user_profiles.id = auth.uid()) OR (user_profiles.auth_id = auth.uid())))));


--
-- Name: xp_transactions Users can view their own XP transactions; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view their own XP transactions" ON public.xp_transactions FOR SELECT USING ((user_id = auth.uid()));


--
-- Name: topic_completions Users can view their own completions; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view their own completions" ON public.topic_completions FOR SELECT USING ((user_id = auth.uid()));


--
-- Name: organizations Users can view their own organization; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view their own organization" ON public.organizations FOR SELECT USING (((id = public.auth_user_org_id()) OR public.user_is_admin()));


--
-- Name: project_timeline Users can view timeline in their org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view timeline in their org" ON public.project_timeline FOR SELECT USING (((org_id = public.auth_user_org_id()) OR public.user_is_admin()));


--
-- Name: workflow_history Users can view workflow history for their org instances; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view workflow history for their org instances" ON public.workflow_history FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.workflow_instances wi
  WHERE ((wi.id = workflow_history.workflow_instance_id) AND ((wi.org_id = public.auth_user_org_id()) OR public.user_is_admin())))));


--
-- Name: workflow_instances Users can view workflow instances in their org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view workflow instances in their org" ON public.workflow_instances FOR SELECT USING (((org_id = public.auth_user_org_id()) OR public.user_is_admin()));


--
-- Name: workflow_states Users can view workflow states; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view workflow states" ON public.workflow_states FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.workflows w
  WHERE ((w.id = workflow_states.workflow_id) AND ((w.org_id = public.auth_user_org_id()) OR public.user_is_admin())))));


--
-- Name: workflow_transitions Users can view workflow transitions; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view workflow transitions" ON public.workflow_transitions FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.workflows w
  WHERE ((w.id = workflow_transitions.workflow_id) AND ((w.org_id = public.auth_user_org_id()) OR public.user_is_admin())))));


--
-- Name: workflows Users can view workflows in their org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY "Users can view workflows in their org" ON public.workflows FOR SELECT USING (((org_id = public.auth_user_org_id()) OR public.user_is_admin()));


--
-- Name: account_contacts; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.account_contacts ENABLE ROW LEVEL SECURITY;

--
-- Name: account_contacts account_contacts_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY account_contacts_org_isolation ON public.account_contacts USING ((org_id = ((auth.jwt() ->> 'org_id'::text))::uuid));


--
-- Name: account_contracts; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.account_contracts ENABLE ROW LEVEL SECURITY;

--
-- Name: account_metrics; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.account_metrics ENABLE ROW LEVEL SECURITY;

--
-- Name: account_notes; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.account_notes ENABLE ROW LEVEL SECURITY;

--
-- Name: account_notes account_notes_employee_access; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY account_notes_employee_access ON public.account_notes USING ((public.auth_has_role('employee'::text) OR public.auth_has_role('admin'::text) OR public.auth_has_role('recruiter'::text)));


--
-- Name: account_notes account_notes_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY account_notes_org_isolation ON public.account_notes USING ((org_id = public.auth_org_id()));


--
-- Name: account_preferences; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.account_preferences ENABLE ROW LEVEL SECURITY;

--
-- Name: account_team; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.account_team ENABLE ROW LEVEL SECURITY;

--
-- Name: accounts; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.accounts ENABLE ROW LEVEL SECURITY;

--
-- Name: accounts accounts_admin_delete; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY accounts_admin_delete ON public.accounts FOR DELETE USING (public.auth_has_role('admin'::text));


--
-- Name: accounts accounts_employee_insert; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY accounts_employee_insert ON public.accounts FOR INSERT WITH CHECK ((public.auth_has_role('admin'::text) OR public.auth_has_role('recruiter'::text)));


--
-- Name: accounts accounts_employee_select; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY accounts_employee_select ON public.accounts FOR SELECT USING ((public.auth_has_role('employee'::text) OR public.auth_has_role('admin'::text) OR public.auth_has_role('recruiter'::text)));


--
-- Name: accounts accounts_employee_update; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY accounts_employee_update ON public.accounts FOR UPDATE USING ((public.auth_has_role('admin'::text) OR (account_manager_id = auth.uid()) OR (created_by = auth.uid())));


--
-- Name: accounts accounts_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY accounts_org_isolation ON public.accounts USING ((org_id = public.current_user_org_id()));


--
-- Name: activities; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.activities ENABLE ROW LEVEL SECURITY;

--
-- Name: activities activities_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY activities_org_isolation ON public.activities USING ((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.auth_id = auth.uid()))));


--
-- Name: activity_log activity_employee_insert; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY activity_employee_insert ON public.activity_log FOR INSERT WITH CHECK ((public.auth_has_role('employee'::text) OR public.auth_has_role('admin'::text) OR public.auth_has_role('recruiter'::text)));


--
-- Name: activity_log activity_employee_select; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY activity_employee_select ON public.activity_log FOR SELECT USING ((public.auth_has_role('employee'::text) OR public.auth_has_role('admin'::text) OR public.auth_has_role('recruiter'::text)));


--
-- Name: activity_log; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.activity_log ENABLE ROW LEVEL SECURITY;

--
-- Name: activity_log activity_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY activity_org_isolation ON public.activity_log USING ((org_id = public.auth_org_id()));


--
-- Name: activity_stats_daily; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.activity_stats_daily ENABLE ROW LEVEL SECURITY;

--
-- Name: activity_stats_daily activity_stats_daily_insert_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY activity_stats_daily_insert_policy ON public.activity_stats_daily FOR INSERT WITH CHECK (true);


--
-- Name: activity_stats_daily activity_stats_daily_select_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY activity_stats_daily_select_policy ON public.activity_stats_daily FOR SELECT USING (((user_id = auth.uid()) OR (EXISTS ( SELECT 1
   FROM (public.user_profiles up
     JOIN public.system_roles sr ON ((up.role_id = sr.id)))
  WHERE ((up.id = auth.uid()) AND (sr.code = ANY (ARRAY['admin'::text, 'super_admin'::text, 'recruiting_manager'::text, 'bench_manager'::text, 'ta_manager'::text])))))));


--
-- Name: activity_stats_daily activity_stats_daily_update_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY activity_stats_daily_update_policy ON public.activity_stats_daily FOR UPDATE USING (true);


--
-- Name: addresses; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.addresses ENABLE ROW LEVEL SECURITY;

--
-- Name: company_addresses addresses_org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY addresses_org ON public.company_addresses USING ((org_id = public.current_user_org_id()));


--
-- Name: addresses addresses_service_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY addresses_service_all ON public.addresses TO service_role USING (true) WITH CHECK (true);


--
-- Name: ai_agent_interactions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.ai_agent_interactions ENABLE ROW LEVEL SECURITY;

--
-- Name: ai_agent_interactions ai_agent_interactions_insert_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY ai_agent_interactions_insert_own ON public.ai_agent_interactions FOR INSERT WITH CHECK (((user_id = public.auth_user_id()) AND (org_id = public.auth_user_org_id())));


--
-- Name: ai_agent_interactions ai_agent_interactions_select_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY ai_agent_interactions_select_own ON public.ai_agent_interactions FOR SELECT USING ((user_id = public.auth_user_id()));


--
-- Name: ai_agent_interactions ai_agent_interactions_select_platform_admin; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY ai_agent_interactions_select_platform_admin ON public.ai_agent_interactions FOR SELECT USING (public.user_is_admin());


--
-- Name: ai_conversations; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.ai_conversations ENABLE ROW LEVEL SECURITY;

--
-- Name: ai_conversations ai_conversations_admin_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY ai_conversations_admin_all ON public.ai_conversations USING (public.user_is_admin());


--
-- Name: ai_conversations ai_conversations_delete_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY ai_conversations_delete_own ON public.ai_conversations FOR DELETE USING ((user_id = public.auth_user_id()));


--
-- Name: ai_conversations ai_conversations_insert_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY ai_conversations_insert_own ON public.ai_conversations FOR INSERT WITH CHECK ((user_id = public.auth_user_id()));


--
-- Name: ai_conversations ai_conversations_select_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY ai_conversations_select_own ON public.ai_conversations FOR SELECT USING ((user_id = public.auth_user_id()));


--
-- Name: ai_conversations ai_conversations_update_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY ai_conversations_update_own ON public.ai_conversations FOR UPDATE USING ((user_id = public.auth_user_id()));


--
-- Name: ai_cost_tracking; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.ai_cost_tracking ENABLE ROW LEVEL SECURITY;

--
-- Name: ai_cost_tracking ai_cost_tracking_insert_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY ai_cost_tracking_insert_own ON public.ai_cost_tracking FOR INSERT WITH CHECK (((user_id = public.auth_user_id()) AND (org_id = public.auth_user_org_id())));


--
-- Name: ai_cost_tracking ai_cost_tracking_select_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY ai_cost_tracking_select_own ON public.ai_cost_tracking FOR SELECT USING ((user_id = public.auth_user_id()));


--
-- Name: ai_cost_tracking ai_cost_tracking_select_platform_admin; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY ai_cost_tracking_select_platform_admin ON public.ai_cost_tracking FOR SELECT USING (public.user_is_admin());


--
-- Name: ai_embeddings; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.ai_embeddings ENABLE ROW LEVEL SECURITY;

--
-- Name: ai_embeddings ai_embeddings_admin_modify; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY ai_embeddings_admin_modify ON public.ai_embeddings USING (public.user_is_admin());


--
-- Name: ai_embeddings ai_embeddings_select_authenticated; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY ai_embeddings_select_authenticated ON public.ai_embeddings FOR SELECT USING ((public.auth_user_id() IS NOT NULL));


--
-- Name: ai_mentor_chats; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.ai_mentor_chats ENABLE ROW LEVEL SECURITY;

--
-- Name: ai_mentor_chats ai_mentor_chats_insert_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY ai_mentor_chats_insert_own ON public.ai_mentor_chats FOR INSERT WITH CHECK ((user_id = auth.uid()));


--
-- Name: ai_mentor_chats ai_mentor_chats_select_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY ai_mentor_chats_select_own ON public.ai_mentor_chats FOR SELECT USING ((user_id = auth.uid()));


--
-- Name: ai_mentor_chats ai_mentor_chats_select_staff; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY ai_mentor_chats_select_staff ON public.ai_mentor_chats FOR SELECT USING ((EXISTS ( SELECT 1
   FROM (public.user_roles ur
     JOIN public.roles r ON ((r.id = ur.role_id)))
  WHERE ((ur.user_id = auth.uid()) AND (r.name = ANY (ARRAY['admin'::text, 'trainer'::text]))))));


--
-- Name: ai_mentor_chats ai_mentor_chats_update_rating; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY ai_mentor_chats_update_rating ON public.ai_mentor_chats FOR UPDATE USING ((user_id = auth.uid())) WITH CHECK ((user_id = auth.uid()));


--
-- Name: ai_mentor_escalations; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.ai_mentor_escalations ENABLE ROW LEVEL SECURITY;

--
-- Name: ai_mentor_rate_limits; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.ai_mentor_rate_limits ENABLE ROW LEVEL SECURITY;

--
-- Name: ai_mentor_rate_limits ai_mentor_rate_limits_select_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY ai_mentor_rate_limits_select_own ON public.ai_mentor_rate_limits FOR SELECT USING ((user_id = auth.uid()));


--
-- Name: ai_mentor_sessions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.ai_mentor_sessions ENABLE ROW LEVEL SECURITY;

--
-- Name: ai_mentor_sessions ai_mentor_sessions_select_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY ai_mentor_sessions_select_own ON public.ai_mentor_sessions FOR SELECT USING ((user_id = auth.uid()));


--
-- Name: ai_mentor_sessions ai_mentor_sessions_select_staff; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY ai_mentor_sessions_select_staff ON public.ai_mentor_sessions FOR SELECT USING ((EXISTS ( SELECT 1
   FROM (public.user_roles ur
     JOIN public.roles r ON ((r.id = ur.role_id)))
  WHERE ((ur.user_id = auth.uid()) AND (r.name = ANY (ARRAY['admin'::text, 'trainer'::text]))))));


--
-- Name: ai_patterns; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.ai_patterns ENABLE ROW LEVEL SECURITY;

--
-- Name: ai_patterns ai_patterns_admin_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY ai_patterns_admin_all ON public.ai_patterns USING (public.user_is_admin());


--
-- Name: ai_patterns ai_patterns_insert_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY ai_patterns_insert_own ON public.ai_patterns FOR INSERT WITH CHECK ((user_id = public.auth_user_id()));


--
-- Name: ai_patterns ai_patterns_select_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY ai_patterns_select_own ON public.ai_patterns FOR SELECT USING ((user_id = public.auth_user_id()));


--
-- Name: ai_patterns ai_patterns_update_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY ai_patterns_update_own ON public.ai_patterns FOR UPDATE USING ((user_id = public.auth_user_id()));


--
-- Name: ai_prompt_variants; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.ai_prompt_variants ENABLE ROW LEVEL SECURITY;

--
-- Name: ai_prompts; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.ai_prompts ENABLE ROW LEVEL SECURITY;

--
-- Name: ai_prompts ai_prompts_admin_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY ai_prompts_admin_all ON public.ai_prompts USING (public.user_is_admin());


--
-- Name: ai_prompts ai_prompts_read_active; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY ai_prompts_read_active ON public.ai_prompts FOR SELECT USING ((is_active = true));


--
-- Name: ai_question_patterns; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.ai_question_patterns ENABLE ROW LEVEL SECURITY;

--
-- Name: alert_rules; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.alert_rules ENABLE ROW LEVEL SECURITY;

--
-- Name: api_tokens; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.api_tokens ENABLE ROW LEVEL SECURITY;

--
-- Name: api_tokens api_tokens_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY api_tokens_org_isolation ON public.api_tokens USING ((org_id = COALESCE(( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid())), ((auth.jwt() ->> 'org_id'::text))::uuid)));


--
-- Name: approval_instances; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.approval_instances ENABLE ROW LEVEL SECURITY;

--
-- Name: approval_instances approval_instances_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY approval_instances_org_isolation ON public.approval_instances USING ((org_id = public.current_user_org_id()));


--
-- Name: approval_steps; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.approval_steps ENABLE ROW LEVEL SECURITY;

--
-- Name: approval_steps approval_steps_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY approval_steps_org_isolation ON public.approval_steps USING ((instance_id IN ( SELECT approval_instances.id
   FROM public.approval_instances
  WHERE (approval_instances.org_id = ((auth.jwt() ->> 'org_id'::text))::uuid))));


--
-- Name: approval_workflows; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.approval_workflows ENABLE ROW LEVEL SECURITY;

--
-- Name: approval_workflows approval_workflows_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY approval_workflows_org_isolation ON public.approval_workflows USING ((org_id = public.current_user_org_id()));


--
-- Name: archived_records; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.archived_records ENABLE ROW LEVEL SECURITY;

--
-- Name: archived_records archived_records_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY archived_records_org_isolation ON public.archived_records USING (((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.auth_id = auth.uid()))) OR ((auth.jwt() ->> 'role'::text) = 'service_role'::text)));


--
-- Name: audit_log_retention_policy; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.audit_log_retention_policy ENABLE ROW LEVEL SECURITY;

--
-- Name: audit_logs; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.audit_logs ENABLE ROW LEVEL SECURITY;

--
-- Name: audit_logs audit_logs_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY audit_logs_org_isolation ON public.audit_logs FOR SELECT USING ((org_id = public.current_user_org_id()));


--
-- Name: background_jobs; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.background_jobs ENABLE ROW LEVEL SECURITY;

--
-- Name: badge_progress; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.badge_progress ENABLE ROW LEVEL SECURITY;

--
-- Name: badge_progress badge_progress_insert_system; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY badge_progress_insert_system ON public.badge_progress FOR INSERT WITH CHECK (true);


--
-- Name: badge_progress badge_progress_select_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY badge_progress_select_own ON public.badge_progress FOR SELECT USING ((user_id = auth.uid()));


--
-- Name: badge_trigger_events; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.badge_trigger_events ENABLE ROW LEVEL SECURITY;

--
-- Name: badge_trigger_events badge_trigger_events_insert_system; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY badge_trigger_events_insert_system ON public.badge_trigger_events FOR INSERT WITH CHECK (true);


--
-- Name: badges; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.badges ENABLE ROW LEVEL SECURITY;

--
-- Name: badges badges_all_admin; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY badges_all_admin ON public.badges USING ((EXISTS ( SELECT 1
   FROM (public.user_roles ur
     JOIN public.roles r ON ((r.id = ur.role_id)))
  WHERE ((ur.user_id = auth.uid()) AND (r.name = 'admin'::text)))));


--
-- Name: badges badges_select_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY badges_select_all ON public.badges FOR SELECT USING (((is_hidden = false) OR (auth.uid() IS NOT NULL)));


--
-- Name: bench_consultants; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.bench_consultants ENABLE ROW LEVEL SECURITY;

--
-- Name: bench_consultants bench_consultants_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY bench_consultants_org_isolation ON public.bench_consultants USING ((org_id = public.current_user_org_id()));


--
-- Name: candidate_background_checks bgv_service_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY bgv_service_all ON public.candidate_background_checks TO service_role USING (true) WITH CHECK (true);


--
-- Name: break_glass_access; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.break_glass_access ENABLE ROW LEVEL SECURITY;

--
-- Name: break_glass_access break_glass_access_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY break_glass_access_org_isolation ON public.break_glass_access USING ((org_id = ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid()))));


--
-- Name: bulk_update_history; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.bulk_update_history ENABLE ROW LEVEL SECURITY;

--
-- Name: bulk_update_history bulk_update_history_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY bulk_update_history_org_isolation ON public.bulk_update_history USING ((org_id = COALESCE(( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid())), ((auth.jwt() ->> 'org_id'::text))::uuid)));


--
-- Name: campaign_documents; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.campaign_documents ENABLE ROW LEVEL SECURITY;

--
-- Name: campaign_documents campaign_documents_delete; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY campaign_documents_delete ON public.campaign_documents FOR DELETE USING ((public.auth_has_role('admin'::text) OR (uploaded_by = auth.uid())));


--
-- Name: campaign_documents campaign_documents_insert; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY campaign_documents_insert ON public.campaign_documents FOR INSERT WITH CHECK ((public.auth_has_role('employee'::text) OR public.auth_has_role('admin'::text) OR public.auth_has_role('recruiter'::text)));


--
-- Name: campaign_documents campaign_documents_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY campaign_documents_org_isolation ON public.campaign_documents USING ((org_id = public.auth_org_id()));


--
-- Name: campaign_documents campaign_documents_select; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY campaign_documents_select ON public.campaign_documents FOR SELECT USING ((public.auth_has_role('employee'::text) OR public.auth_has_role('admin'::text) OR public.auth_has_role('recruiter'::text)));


--
-- Name: campaign_documents campaign_documents_update; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY campaign_documents_update ON public.campaign_documents FOR UPDATE USING ((public.auth_has_role('admin'::text) OR (uploaded_by = auth.uid())));


--
-- Name: campaign_enrollments; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.campaign_enrollments ENABLE ROW LEVEL SECURITY;

--
-- Name: campaign_enrollments campaign_enrollments_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY campaign_enrollments_org_isolation ON public.campaign_enrollments USING ((org_id = ((auth.jwt() ->> 'org_id'::text))::uuid));


--
-- Name: campaign_sequence_logs; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.campaign_sequence_logs ENABLE ROW LEVEL SECURITY;

--
-- Name: campaign_sequence_logs campaign_sequence_logs_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY campaign_sequence_logs_org_isolation ON public.campaign_sequence_logs USING ((org_id = public.auth_org_id()));


--
-- Name: campaign_sequence_logs campaign_sequence_logs_select; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY campaign_sequence_logs_select ON public.campaign_sequence_logs FOR SELECT USING ((public.auth_has_role('employee'::text) OR public.auth_has_role('admin'::text) OR public.auth_has_role('recruiter'::text)));


--
-- Name: campaign_sequences; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.campaign_sequences ENABLE ROW LEVEL SECURITY;

--
-- Name: campaign_sequences campaign_sequences_delete_org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY campaign_sequences_delete_org ON public.campaign_sequences FOR DELETE USING ((org_id = (current_setting('app.current_org_id'::text, true))::uuid));


--
-- Name: campaign_sequences campaign_sequences_insert_org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY campaign_sequences_insert_org ON public.campaign_sequences FOR INSERT WITH CHECK ((org_id = (current_setting('app.current_org_id'::text, true))::uuid));


--
-- Name: campaign_sequences campaign_sequences_select_org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY campaign_sequences_select_org ON public.campaign_sequences FOR SELECT USING ((org_id = (current_setting('app.current_org_id'::text, true))::uuid));


--
-- Name: campaign_sequences campaign_sequences_update_org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY campaign_sequences_update_org ON public.campaign_sequences FOR UPDATE USING ((org_id = (current_setting('app.current_org_id'::text, true))::uuid));


--
-- Name: campaigns; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.campaigns ENABLE ROW LEVEL SECURITY;

--
-- Name: campaigns campaigns_create; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY campaigns_create ON public.campaigns FOR INSERT WITH CHECK ((public.auth_has_role('admin'::text) OR public.auth_has_role('recruiter'::text)));


--
-- Name: campaigns campaigns_employee_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY campaigns_employee_all ON public.campaigns USING ((public.auth_has_role('employee'::text) OR public.auth_has_role('ta_specialist'::text) OR public.auth_has_role('admin'::text)));


--
-- Name: campaigns campaigns_employee_select; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY campaigns_employee_select ON public.campaigns FOR SELECT USING ((public.auth_has_role('employee'::text) OR public.auth_has_role('admin'::text) OR public.auth_has_role('recruiter'::text)));


--
-- Name: campaigns campaigns_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY campaigns_org_isolation ON public.campaigns USING ((org_id = public.auth_org_id()));


--
-- Name: campaigns campaigns_owner_update; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY campaigns_owner_update ON public.campaigns FOR UPDATE USING ((public.auth_has_role('admin'::text) OR (owner_id = auth.uid()) OR (created_by = auth.uid())));


--
-- Name: candidate_background_checks; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.candidate_background_checks ENABLE ROW LEVEL SECURITY;

--
-- Name: candidate_certifications; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.candidate_certifications ENABLE ROW LEVEL SECURITY;

--
-- Name: candidate_compliance_documents; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.candidate_compliance_documents ENABLE ROW LEVEL SECURITY;

--
-- Name: candidate_education; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.candidate_education ENABLE ROW LEVEL SECURITY;

--
-- Name: candidate_embeddings; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.candidate_embeddings ENABLE ROW LEVEL SECURITY;

--
-- Name: candidate_prepared_profiles; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.candidate_prepared_profiles ENABLE ROW LEVEL SECURITY;

--
-- Name: candidate_prepared_profiles candidate_prepared_profiles_org_access; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY candidate_prepared_profiles_org_access ON public.candidate_prepared_profiles USING ((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid()))));


--
-- Name: candidate_references; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.candidate_references ENABLE ROW LEVEL SECURITY;

--
-- Name: candidate_resumes; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.candidate_resumes ENABLE ROW LEVEL SECURITY;

--
-- Name: candidate_screenings; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.candidate_screenings ENABLE ROW LEVEL SECURITY;

--
-- Name: candidate_screenings candidate_screenings_org_access; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY candidate_screenings_org_access ON public.candidate_screenings USING ((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid()))));


--
-- Name: candidate_skills; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.candidate_skills ENABLE ROW LEVEL SECURITY;

--
-- Name: candidate_skills candidate_skills_candidate_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY candidate_skills_candidate_own ON public.candidate_skills USING ((candidate_id = auth.uid()));


--
-- Name: candidate_skills candidate_skills_employee_read; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY candidate_skills_employee_read ON public.candidate_skills FOR SELECT USING ((public.auth_has_role('employee'::text) OR public.auth_has_role('recruiter'::text) OR public.auth_has_role('admin'::text)));


--
-- Name: candidate_skills candidate_skills_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY candidate_skills_org_isolation ON public.candidate_skills USING ((candidate_id IN ( SELECT user_profiles.id
   FROM public.user_profiles
  WHERE (user_profiles.org_id = ((auth.jwt() ->> 'org_id'::text))::uuid))));


--
-- Name: candidate_skills candidate_skills_recruiter_write; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY candidate_skills_recruiter_write ON public.candidate_skills USING ((public.auth_has_role('recruiter'::text) OR public.auth_has_role('admin'::text)));


--
-- Name: candidate_work_authorizations; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.candidate_work_authorizations ENABLE ROW LEVEL SECURITY;

--
-- Name: candidate_work_history; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.candidate_work_history ENABLE ROW LEVEL SECURITY;

--
-- Name: user_profiles candidates_context_read; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY candidates_context_read ON public.user_profiles FOR SELECT USING (((id = auth.uid()) OR (public.auth_has_active_role('recruiter'::text) AND (candidate_status IS NOT NULL)) OR (public.auth_has_active_role('bench_sales'::text) AND (candidate_status = 'bench'::text)) OR (public.auth_has_active_role('ta_specialist'::text) AND (candidate_status = ANY (ARRAY['active'::text, 'sourced'::text]))) OR (public.auth_has_active_role('student'::text) AND (id = auth.uid())) OR public.auth_has_active_role('admin'::text)));


--
-- Name: capstone_submissions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.capstone_submissions ENABLE ROW LEVEL SECURITY;

--
-- Name: capstone_submissions capstone_submissions_insert_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY capstone_submissions_insert_own ON public.capstone_submissions FOR INSERT WITH CHECK ((user_id = auth.uid()));


--
-- Name: capstone_submissions capstone_submissions_select_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY capstone_submissions_select_own ON public.capstone_submissions FOR SELECT USING ((user_id = auth.uid()));


--
-- Name: capstone_submissions capstone_submissions_select_trainer; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY capstone_submissions_select_trainer ON public.capstone_submissions FOR SELECT USING ((EXISTS ( SELECT 1
   FROM (public.user_roles ur
     JOIN public.roles r ON ((ur.role_id = r.id)))
  WHERE ((ur.user_id = auth.uid()) AND (r.name = ANY (ARRAY['trainer'::text, 'admin'::text, 'super_admin'::text]))))));


--
-- Name: capstone_submissions capstone_submissions_update_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY capstone_submissions_update_own ON public.capstone_submissions FOR UPDATE USING (((user_id = auth.uid()) AND (status = 'revision_requested'::text)));


--
-- Name: capstone_submissions capstone_submissions_update_trainer; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY capstone_submissions_update_trainer ON public.capstone_submissions FOR UPDATE USING ((EXISTS ( SELECT 1
   FROM (public.user_roles ur
     JOIN public.roles r ON ((ur.role_id = r.id)))
  WHERE ((ur.user_id = auth.uid()) AND (r.name = ANY (ARRAY['trainer'::text, 'admin'::text, 'super_admin'::text]))))));


--
-- Name: candidate_certifications certifications_service_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY certifications_service_all ON public.candidate_certifications TO service_role USING (true) WITH CHECK (true);


--
-- Name: comments; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.comments ENABLE ROW LEVEL SECURITY;

--
-- Name: comments comments_create_employee; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY comments_create_employee ON public.comments FOR INSERT WITH CHECK (((author_id = auth.uid()) AND (public.auth_has_role('employee'::text) OR public.auth_has_role('admin'::text))));


--
-- Name: comments comments_delete_own_or_admin; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY comments_delete_own_or_admin ON public.comments FOR DELETE USING (((author_id = auth.uid()) OR public.auth_has_role('admin'::text)));


--
-- Name: comments comments_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY comments_org_isolation ON public.comments USING ((org_id = public.current_user_org_id()));


--
-- Name: comments comments_read_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY comments_read_all ON public.comments FOR SELECT USING ((public.auth_has_role('employee'::text) OR public.auth_has_role('admin'::text)));


--
-- Name: comments comments_update_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY comments_update_own ON public.comments FOR UPDATE USING (((author_id = auth.uid()) OR public.auth_has_role('admin'::text)));


--
-- Name: commission_payments; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.commission_payments ENABLE ROW LEVEL SECURITY;

--
-- Name: commission_payments commission_payments_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY commission_payments_org_isolation ON public.commission_payments USING ((org_id = ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.auth_id = auth.uid()))));


--
-- Name: commissions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.commissions ENABLE ROW LEVEL SECURITY;

--
-- Name: commissions commissions_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY commissions_org_isolation ON public.commissions USING ((org_id = ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.auth_id = auth.uid()))));


--
-- Name: commissions commissions_user_select; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY commissions_user_select ON public.commissions FOR SELECT USING (((user_id = ( SELECT user_profiles.id
   FROM public.user_profiles
  WHERE (user_profiles.auth_id = auth.uid()))) OR (EXISTS ( SELECT 1
   FROM (public.user_profiles up
     LEFT JOIN public.system_roles sr ON ((sr.id = up.role_id)))
  WHERE ((up.auth_id = auth.uid()) AND ((sr.name = ANY (ARRAY['admin'::text, 'pod_manager'::text, 'finance'::text])) OR (up.employee_role = ANY (ARRAY['admin'::text, 'pod_manager'::text, 'finance'::text]))))))));


--
-- Name: companies; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.companies ENABLE ROW LEVEL SECURITY;

--
-- Name: companies companies_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY companies_org_isolation ON public.companies USING ((org_id = public.current_user_org_id()));


--
-- Name: company_addresses; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.company_addresses ENABLE ROW LEVEL SECURITY;

--
-- Name: company_client_details; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.company_client_details ENABLE ROW LEVEL SECURITY;

--
-- Name: company_client_details company_client_details_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY company_client_details_org_isolation ON public.company_client_details USING ((org_id = public.current_user_org_id()));


--
-- Name: company_compliance_requirements; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.company_compliance_requirements ENABLE ROW LEVEL SECURITY;

--
-- Name: company_contacts; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.company_contacts ENABLE ROW LEVEL SECURITY;

--
-- Name: company_contracts; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.company_contracts ENABLE ROW LEVEL SECURITY;

--
-- Name: company_health_scores; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.company_health_scores ENABLE ROW LEVEL SECURITY;

--
-- Name: company_metrics; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.company_metrics ENABLE ROW LEVEL SECURITY;

--
-- Name: company_notes; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.company_notes ENABLE ROW LEVEL SECURITY;

--
-- Name: company_partner_details; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.company_partner_details ENABLE ROW LEVEL SECURITY;

--
-- Name: company_partner_details company_partner_details_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY company_partner_details_org_isolation ON public.company_partner_details USING ((org_id = public.current_user_org_id()));


--
-- Name: company_preferences; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.company_preferences ENABLE ROW LEVEL SECURITY;

--
-- Name: company_rate_card_items; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.company_rate_card_items ENABLE ROW LEVEL SECURITY;

--
-- Name: company_rate_cards; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.company_rate_cards ENABLE ROW LEVEL SECURITY;

--
-- Name: company_relationships; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.company_relationships ENABLE ROW LEVEL SECURITY;

--
-- Name: company_revenue; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.company_revenue ENABLE ROW LEVEL SECURITY;

--
-- Name: company_tags; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.company_tags ENABLE ROW LEVEL SECURITY;

--
-- Name: company_team; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.company_team ENABLE ROW LEVEL SECURITY;

--
-- Name: company_vendor_details; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.company_vendor_details ENABLE ROW LEVEL SECURITY;

--
-- Name: company_vendor_details company_vendor_details_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY company_vendor_details_org_isolation ON public.company_vendor_details USING ((org_id = public.current_user_org_id()));


--
-- Name: company_compliance_requirements compliance_org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY compliance_org ON public.company_compliance_requirements USING ((org_id = public.current_user_org_id()));


--
-- Name: candidate_compliance_documents compliance_service_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY compliance_service_all ON public.candidate_compliance_documents TO service_role USING (true) WITH CHECK (true);


--
-- Name: contact_agreements; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.contact_agreements ENABLE ROW LEVEL SECURITY;

--
-- Name: contact_agreements contact_agreements_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY contact_agreements_org_isolation ON public.contact_agreements USING ((org_id = ((auth.jwt() ->> 'org_id'::text))::uuid));


--
-- Name: contact_certifications; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.contact_certifications ENABLE ROW LEVEL SECURITY;

--
-- Name: contact_certifications contact_certifications_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY contact_certifications_org_isolation ON public.contact_certifications USING ((org_id = ((auth.jwt() ->> 'org_id'::text))::uuid));


--
-- Name: contact_communication_preferences contact_comm_prefs_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY contact_comm_prefs_org_isolation ON public.contact_communication_preferences USING ((org_id = ((auth.jwt() ->> 'org_id'::text))::uuid));


--
-- Name: contact_communication_preferences; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.contact_communication_preferences ENABLE ROW LEVEL SECURITY;

--
-- Name: contact_compliance; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.contact_compliance ENABLE ROW LEVEL SECURITY;

--
-- Name: contact_compliance contact_compliance_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY contact_compliance_org_isolation ON public.contact_compliance USING ((org_id = ((auth.jwt() ->> 'org_id'::text))::uuid));


--
-- Name: contact_education; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.contact_education ENABLE ROW LEVEL SECURITY;

--
-- Name: contact_education contact_education_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY contact_education_org_isolation ON public.contact_education USING ((org_id = ((auth.jwt() ->> 'org_id'::text))::uuid));


--
-- Name: contact_lead_data; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.contact_lead_data ENABLE ROW LEVEL SECURITY;

--
-- Name: contact_merge_history; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.contact_merge_history ENABLE ROW LEVEL SECURITY;

--
-- Name: contact_merge_history contact_merge_history_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY contact_merge_history_org_isolation ON public.contact_merge_history USING ((org_id = ((auth.jwt() ->> 'org_id'::text))::uuid));


--
-- Name: contact_rate_cards; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.contact_rate_cards ENABLE ROW LEVEL SECURITY;

--
-- Name: contact_rate_cards contact_rate_cards_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY contact_rate_cards_org_isolation ON public.contact_rate_cards USING ((org_id = ((auth.jwt() ->> 'org_id'::text))::uuid));


--
-- Name: contact_relationships; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.contact_relationships ENABLE ROW LEVEL SECURITY;

--
-- Name: contact_relationships contact_relationships_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY contact_relationships_org_isolation ON public.contact_relationships USING ((org_id = ((auth.jwt() ->> 'org_id'::text))::uuid));


--
-- Name: contact_roles; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.contact_roles ENABLE ROW LEVEL SECURITY;

--
-- Name: contact_roles contact_roles_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY contact_roles_org_isolation ON public.contact_roles USING ((org_id = ((auth.jwt() ->> 'org_id'::text))::uuid));


--
-- Name: contact_skills; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.contact_skills ENABLE ROW LEVEL SECURITY;

--
-- Name: contact_skills contact_skills_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY contact_skills_org_isolation ON public.contact_skills USING ((org_id = ((auth.jwt() ->> 'org_id'::text))::uuid));


--
-- Name: contact_work_history; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.contact_work_history ENABLE ROW LEVEL SECURITY;

--
-- Name: contact_work_history contact_work_history_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY contact_work_history_org_isolation ON public.contact_work_history USING ((org_id = ((auth.jwt() ->> 'org_id'::text))::uuid));


--
-- Name: contacts; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.contacts ENABLE ROW LEVEL SECURITY;

--
-- Name: company_contacts contacts_org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY contacts_org ON public.company_contacts USING ((org_id = public.current_user_org_id()));


--
-- Name: contacts contacts_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY contacts_org_isolation ON public.contacts USING ((org_id = ((auth.jwt() ->> 'org_id'::text))::uuid));


--
-- Name: content_assets; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.content_assets ENABLE ROW LEVEL SECURITY;

--
-- Name: company_contracts contracts_org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY contracts_org ON public.company_contracts USING ((org_id = public.current_user_org_id()));


--
-- Name: course_pricing; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.course_pricing ENABLE ROW LEVEL SECURITY;

--
-- Name: course_pricing course_pricing_admin_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY course_pricing_admin_all ON public.course_pricing USING ((EXISTS ( SELECT 1
   FROM (public.user_roles ur
     JOIN public.roles r ON ((r.id = ur.role_id)))
  WHERE ((ur.user_id = auth.uid()) AND (r.name = ANY (ARRAY['admin'::text, 'super_admin'::text]))))));


--
-- Name: course_pricing course_pricing_public_read; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY course_pricing_public_read ON public.course_pricing FOR SELECT USING (true);


--
-- Name: deal_competitors; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.deal_competitors ENABLE ROW LEVEL SECURITY;

--
-- Name: deal_products; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.deal_products ENABLE ROW LEVEL SECURITY;

--
-- Name: deal_stages_history; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.deal_stages_history ENABLE ROW LEVEL SECURITY;

--
-- Name: deal_stakeholders; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.deal_stakeholders ENABLE ROW LEVEL SECURITY;

--
-- Name: deals; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.deals ENABLE ROW LEVEL SECURITY;

--
-- Name: deals deals_employee_insert; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY deals_employee_insert ON public.deals FOR INSERT WITH CHECK ((public.auth_has_role('employee'::text) OR public.auth_has_role('admin'::text) OR public.auth_has_role('recruiter'::text)));


--
-- Name: deals deals_employee_select; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY deals_employee_select ON public.deals FOR SELECT USING ((public.auth_has_role('employee'::text) OR public.auth_has_role('admin'::text) OR public.auth_has_role('recruiter'::text)));


--
-- Name: deals deals_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY deals_org_isolation ON public.deals USING ((org_id = public.current_user_org_id()));


--
-- Name: deals deals_owner_update; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY deals_owner_update ON public.deals FOR UPDATE USING ((public.auth_has_role('admin'::text) OR (owner_id = auth.uid()) OR (created_by = auth.uid())));


--
-- Name: discount_code_usage; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.discount_code_usage ENABLE ROW LEVEL SECURITY;

--
-- Name: discount_codes; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.discount_codes ENABLE ROW LEVEL SECURITY;

--
-- Name: discount_codes discount_codes_admin_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY discount_codes_admin_all ON public.discount_codes USING ((EXISTS ( SELECT 1
   FROM (public.user_roles ur
     JOIN public.roles r ON ((r.id = ur.role_id)))
  WHERE ((ur.user_id = auth.uid()) AND (r.name = ANY (ARRAY['admin'::text, 'super_admin'::text]))))));


--
-- Name: discount_code_usage discount_usage_admin_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY discount_usage_admin_all ON public.discount_code_usage USING ((EXISTS ( SELECT 1
   FROM (public.user_roles ur
     JOIN public.roles r ON ((r.id = ur.role_id)))
  WHERE ((ur.user_id = auth.uid()) AND (r.name = ANY (ARRAY['admin'::text, 'super_admin'::text]))))));


--
-- Name: discount_code_usage discount_usage_own_read; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY discount_usage_own_read ON public.discount_code_usage FOR SELECT USING ((user_id = auth.uid()));


--
-- Name: document_templates; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.document_templates ENABLE ROW LEVEL SECURITY;

--
-- Name: duplicate_records; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.duplicate_records ENABLE ROW LEVEL SECURITY;

--
-- Name: duplicate_records duplicate_records_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY duplicate_records_org_isolation ON public.duplicate_records USING (((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.auth_id = auth.uid()))) OR ((auth.jwt() ->> 'role'::text) = 'service_role'::text)));


--
-- Name: duplicate_rules; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.duplicate_rules ENABLE ROW LEVEL SECURITY;

--
-- Name: duplicate_rules duplicate_rules_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY duplicate_rules_org_isolation ON public.duplicate_rules USING (((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.auth_id = auth.uid()))) OR ((auth.jwt() ->> 'role'::text) = 'service_role'::text)));


--
-- Name: candidate_education education_service_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY education_service_all ON public.candidate_education TO service_role USING (true) WITH CHECK (true);


--
-- Name: email_logs; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.email_logs ENABLE ROW LEVEL SECURITY;

--
-- Name: email_senders; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.email_senders ENABLE ROW LEVEL SECURITY;

--
-- Name: email_senders email_senders_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY email_senders_org_isolation ON public.email_senders USING ((org_id = ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid()))));


--
-- Name: email_sends; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.email_sends ENABLE ROW LEVEL SECURITY;

--
-- Name: email_sends email_sends_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY email_sends_org_isolation ON public.email_sends USING ((org_id = ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid()))));


--
-- Name: email_templates; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.email_templates ENABLE ROW LEVEL SECURITY;

--
-- Name: email_templates email_templates_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY email_templates_org_isolation ON public.email_templates USING ((org_id = ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid()))));


--
-- Name: candidate_embeddings embeddings_recruiter_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY embeddings_recruiter_all ON public.candidate_embeddings FOR SELECT USING (((org_id = public.auth_user_org_id()) AND public.user_has_role('recruiter'::text)));


--
-- Name: candidate_embeddings embeddings_service_role; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY embeddings_service_role ON public.candidate_embeddings USING ((((current_setting('request.jwt.claims'::text, true))::json ->> 'role'::text) = 'service_role'::text));


--
-- Name: emergency_drills; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.emergency_drills ENABLE ROW LEVEL SECURITY;

--
-- Name: emergency_drills emergency_drills_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY emergency_drills_org_isolation ON public.emergency_drills USING ((org_id = ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid()))));


--
-- Name: employee_metadata; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.employee_metadata ENABLE ROW LEVEL SECURITY;

--
-- Name: employee_metadata employee_metadata_employee_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY employee_metadata_employee_own ON public.employee_metadata FOR SELECT USING ((user_id = auth.uid()));


--
-- Name: employee_metadata employee_metadata_hr_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY employee_metadata_hr_all ON public.employee_metadata USING ((public.auth_has_role('hr'::text) OR public.auth_has_role('admin'::text)));


--
-- Name: employee_screenshots; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.employee_screenshots ENABLE ROW LEVEL SECURITY;

--
-- Name: employee_twin_interactions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.employee_twin_interactions ENABLE ROW LEVEL SECURITY;

--
-- Name: employee_twin_interactions employee_twin_interactions_user_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY employee_twin_interactions_user_own ON public.employee_twin_interactions USING ((user_id = auth.uid()));


--
-- Name: engagement_tracking; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.engagement_tracking ENABLE ROW LEVEL SECURITY;

--
-- Name: escalation_notifications; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.escalation_notifications ENABLE ROW LEVEL SECURITY;

--
-- Name: escalation_updates; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.escalation_updates ENABLE ROW LEVEL SECURITY;

--
-- Name: escalation_updates escalation_updates_access; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY escalation_updates_access ON public.escalation_updates USING ((escalation_id IN ( SELECT escalations.id
   FROM public.escalations
  WHERE (escalations.org_id = public.auth_org_id()))));


--
-- Name: escalations; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.escalations ENABLE ROW LEVEL SECURITY;

--
-- Name: escalations escalations_employee_access; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY escalations_employee_access ON public.escalations USING ((public.auth_has_role('employee'::text) OR public.auth_has_role('admin'::text) OR public.auth_has_role('recruiter'::text)));


--
-- Name: escalations escalations_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY escalations_org_isolation ON public.escalations USING ((org_id = public.auth_org_id()));


--
-- Name: ai_mentor_escalations escalations_select_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY escalations_select_own ON public.ai_mentor_escalations FOR SELECT USING ((user_id = auth.uid()));


--
-- Name: ai_mentor_escalations escalations_select_staff; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY escalations_select_staff ON public.ai_mentor_escalations FOR SELECT USING ((EXISTS ( SELECT 1
   FROM (public.user_roles ur
     JOIN public.roles r ON ((r.id = ur.role_id)))
  WHERE ((ur.user_id = auth.uid()) AND (r.name = ANY (ARRAY['admin'::text, 'trainer'::text]))))));


--
-- Name: ai_mentor_escalations escalations_update_assigned; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY escalations_update_assigned ON public.ai_mentor_escalations FOR UPDATE USING (((assigned_to = auth.uid()) OR (EXISTS ( SELECT 1
   FROM (public.user_roles ur
     JOIN public.roles r ON ((r.id = ur.role_id)))
  WHERE ((ur.user_id = auth.uid()) AND (r.name = 'admin'::text))))));


--
-- Name: event_delivery_log; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.event_delivery_log ENABLE ROW LEVEL SECURITY;

--
-- Name: event_subscriptions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.event_subscriptions ENABLE ROW LEVEL SECURITY;

--
-- Name: event_subscriptions event_subscriptions_insert; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY event_subscriptions_insert ON public.event_subscriptions FOR INSERT WITH CHECK (((public.auth_user_org_id() = org_id) OR public.user_is_admin()));


--
-- Name: event_subscriptions event_subscriptions_select; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY event_subscriptions_select ON public.event_subscriptions FOR SELECT USING (((public.auth_user_org_id() = org_id) OR public.user_is_admin()));


--
-- Name: events; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.events ENABLE ROW LEVEL SECURITY;

--
-- Name: export_jobs; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.export_jobs ENABLE ROW LEVEL SECURITY;

--
-- Name: export_jobs export_jobs_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY export_jobs_org_isolation ON public.export_jobs USING (((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.auth_id = auth.uid()))) OR ((auth.jwt() ->> 'role'::text) = 'service_role'::text)));


--
-- Name: external_job_orders; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.external_job_orders ENABLE ROW LEVEL SECURITY;

--
-- Name: external_job_orders external_job_orders_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY external_job_orders_org_isolation ON public.external_job_orders USING ((org_id = public.current_user_org_id()));


--
-- Name: integration_failover_config failover_config_org_access; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY failover_config_org_access ON public.integration_failover_config USING (((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.auth_id = auth.uid()))) OR ((auth.jwt() ->> 'role'::text) = 'service_role'::text)));


--
-- Name: feature_flag_categories; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.feature_flag_categories ENABLE ROW LEVEL SECURITY;

--
-- Name: feature_flag_categories feature_flag_categories_select; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY feature_flag_categories_select ON public.feature_flag_categories FOR SELECT USING (((org_id IS NULL) OR (org_id = COALESCE(( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid())), ((auth.jwt() ->> 'org_id'::text))::uuid))));


--
-- Name: feature_flag_feedback; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.feature_flag_feedback ENABLE ROW LEVEL SECURITY;

--
-- Name: feature_flag_feedback feature_flag_feedback_insert; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY feature_flag_feedback_insert ON public.feature_flag_feedback FOR INSERT WITH CHECK ((user_id = auth.uid()));


--
-- Name: feature_flag_feedback feature_flag_feedback_select; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY feature_flag_feedback_select ON public.feature_flag_feedback FOR SELECT USING ((org_id = COALESCE(( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid())), ((auth.jwt() ->> 'org_id'::text))::uuid)));


--
-- Name: feature_flag_roles; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.feature_flag_roles ENABLE ROW LEVEL SECURITY;

--
-- Name: feature_flag_roles feature_flag_roles_read; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY feature_flag_roles_read ON public.feature_flag_roles FOR SELECT USING (true);


--
-- Name: feature_flag_usage; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.feature_flag_usage ENABLE ROW LEVEL SECURITY;

--
-- Name: feature_flag_usage feature_flag_usage_insert; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY feature_flag_usage_insert ON public.feature_flag_usage FOR INSERT WITH CHECK ((user_id = auth.uid()));


--
-- Name: feature_flag_usage feature_flag_usage_select; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY feature_flag_usage_select ON public.feature_flag_usage FOR SELECT USING ((org_id = COALESCE(( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid())), ((auth.jwt() ->> 'org_id'::text))::uuid)));


--
-- Name: feature_flags; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.feature_flags ENABLE ROW LEVEL SECURITY;

--
-- Name: feature_flags feature_flags_access; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY feature_flags_access ON public.feature_flags FOR SELECT USING (((is_global = true) OR (org_id IS NULL) OR (org_id = COALESCE(( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid())), ((auth.jwt() ->> 'org_id'::text))::uuid))));


--
-- Name: feature_flags feature_flags_org_delete; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY feature_flags_org_delete ON public.feature_flags FOR DELETE USING (((is_global = false) AND (org_id = COALESCE(( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid())), ((auth.jwt() ->> 'org_id'::text))::uuid))));


--
-- Name: feature_flags feature_flags_org_update; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY feature_flags_org_update ON public.feature_flags FOR UPDATE USING (((is_global = false) AND (org_id = COALESCE(( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid())), ((auth.jwt() ->> 'org_id'::text))::uuid))));


--
-- Name: feature_flags feature_flags_org_write; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY feature_flags_org_write ON public.feature_flags FOR INSERT WITH CHECK ((org_id = COALESCE(( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid())), ((auth.jwt() ->> 'org_id'::text))::uuid)));


--
-- Name: file_uploads; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.file_uploads ENABLE ROW LEVEL SECURITY;

--
-- Name: file_uploads file_uploads_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY file_uploads_org_isolation ON public.file_uploads USING ((org_id = public.current_user_org_id()));


--
-- Name: gdpr_requests; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.gdpr_requests ENABLE ROW LEVEL SECURITY;

--
-- Name: gdpr_requests gdpr_requests_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY gdpr_requests_org_isolation ON public.gdpr_requests USING (((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.auth_id = auth.uid()))) OR ((auth.jwt() ->> 'role'::text) = 'service_role'::text)));


--
-- Name: generated_documents; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.generated_documents ENABLE ROW LEVEL SECURITY;

--
-- Name: generated_resumes; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.generated_resumes ENABLE ROW LEVEL SECURITY;

--
-- Name: graduate_candidates; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.graduate_candidates ENABLE ROW LEVEL SECURITY;

--
-- Name: graduate_candidates graduate_candidates_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY graduate_candidates_org_isolation ON public.graduate_candidates USING ((user_id IN ( SELECT user_profiles.id
   FROM public.user_profiles
  WHERE (user_profiles.org_id = ((auth.jwt() ->> 'org_id'::text))::uuid))));


--
-- Name: guru_interactions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.guru_interactions ENABLE ROW LEVEL SECURITY;

--
-- Name: integration_health_logs health_logs_org_access; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY health_logs_org_access ON public.integration_health_logs USING (((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.auth_id = auth.uid()))) OR ((auth.jwt() ->> 'role'::text) = 'service_role'::text)));


--
-- Name: company_health_scores health_scores_org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY health_scores_org ON public.company_health_scores USING ((org_id = public.current_user_org_id()));


--
-- Name: import_jobs; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.import_jobs ENABLE ROW LEVEL SECURITY;

--
-- Name: import_jobs import_jobs_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY import_jobs_org_isolation ON public.import_jobs USING (((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.auth_id = auth.uid()))) OR ((auth.jwt() ->> 'role'::text) = 'service_role'::text)));


--
-- Name: incident_notifications; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.incident_notifications ENABLE ROW LEVEL SECURITY;

--
-- Name: incident_notifications incident_notifications_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY incident_notifications_org_isolation ON public.incident_notifications USING ((org_id = ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid()))));


--
-- Name: incident_timeline; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.incident_timeline ENABLE ROW LEVEL SECURITY;

--
-- Name: incident_timeline incident_timeline_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY incident_timeline_org_isolation ON public.incident_timeline USING ((org_id = ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid()))));


--
-- Name: incidents; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.incidents ENABLE ROW LEVEL SECURITY;

--
-- Name: incidents incidents_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY incidents_org_isolation ON public.incidents USING ((org_id = ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid()))));


--
-- Name: integration_failover_config; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.integration_failover_config ENABLE ROW LEVEL SECURITY;

--
-- Name: integration_health_logs; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.integration_health_logs ENABLE ROW LEVEL SECURITY;

--
-- Name: integration_oauth_tokens; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.integration_oauth_tokens ENABLE ROW LEVEL SECURITY;

--
-- Name: integration_retry_config; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.integration_retry_config ENABLE ROW LEVEL SECURITY;

--
-- Name: integration_types; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.integration_types ENABLE ROW LEVEL SECURITY;

--
-- Name: integration_types integration_types_read; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY integration_types_read ON public.integration_types FOR SELECT USING (true);


--
-- Name: integrations; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.integrations ENABLE ROW LEVEL SECURITY;

--
-- Name: integrations integrations_org_access; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY integrations_org_access ON public.integrations USING (((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.auth_id = auth.uid()))) OR ((auth.jwt() ->> 'role'::text) = 'service_role'::text)));


--
-- Name: interview_sessions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.interview_sessions ENABLE ROW LEVEL SECURITY;

--
-- Name: interview_sessions interview_sessions_select_platform_admin; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY interview_sessions_select_platform_admin ON public.interview_sessions FOR SELECT USING (public.user_is_admin());


--
-- Name: interviews; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.interviews ENABLE ROW LEVEL SECURITY;

--
-- Name: interviews interviews_candidate_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY interviews_candidate_own ON public.interviews FOR SELECT USING ((candidate_id = auth.uid()));


--
-- Name: interviews interviews_employee_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY interviews_employee_all ON public.interviews USING ((public.auth_has_role('employee'::text) OR public.auth_has_role('recruiter'::text) OR public.auth_has_role('admin'::text)));


--
-- Name: job_status_history; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.job_status_history ENABLE ROW LEVEL SECURITY;

--
-- Name: jobs; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.jobs ENABLE ROW LEVEL SECURITY;

--
-- Name: jobs jobs_client_own_read; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY jobs_client_own_read ON public.jobs FOR SELECT USING ((public.auth_has_role('client'::text) AND (account_id IN ( SELECT COALESCE(( SELECT accounts.id
           FROM public.accounts
          WHERE (accounts.name = ( SELECT user_profiles.client_company_name
                   FROM public.user_profiles
                  WHERE (user_profiles.id = auth.uid())))), NULL::uuid) AS "coalesce"))));


--
-- Name: jobs jobs_employee_read; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY jobs_employee_read ON public.jobs FOR SELECT USING (((public.auth_has_active_role('recruiter'::text) AND ((owner_id = auth.uid()) OR (auth.uid() = ANY (recruiter_ids)))) OR public.auth_has_active_role('bench_sales'::text) OR public.auth_has_active_role('ta_specialist'::text) OR public.auth_has_active_role('admin'::text)));


--
-- Name: jobs jobs_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY jobs_org_isolation ON public.jobs USING ((org_id = public.current_user_org_id()));


--
-- Name: jobs jobs_recruiter_write; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY jobs_recruiter_write ON public.jobs USING ((public.auth_has_role('recruiter'::text) OR public.auth_has_role('admin'::text) OR (owner_id = auth.uid())));


--
-- Name: lab_instances; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.lab_instances ENABLE ROW LEVEL SECURITY;

--
-- Name: lab_instances lab_instances_user_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY lab_instances_user_policy ON public.lab_instances USING (((user_id = auth.uid()) OR (EXISTS ( SELECT 1
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid()))))) WITH CHECK (((user_id = auth.uid()) OR (EXISTS ( SELECT 1
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid())))));


--
-- Name: lab_submissions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.lab_submissions ENABLE ROW LEVEL SECURITY;

--
-- Name: lab_submissions lab_submissions_user_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY lab_submissions_user_policy ON public.lab_submissions USING (((user_id = auth.uid()) OR (EXISTS ( SELECT 1
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid()))))) WITH CHECK (((user_id = auth.uid()) OR (EXISTS ( SELECT 1
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid())))));


--
-- Name: lab_templates; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.lab_templates ENABLE ROW LEVEL SECURITY;

--
-- Name: lab_templates lab_templates_public_read; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY lab_templates_public_read ON public.lab_templates FOR SELECT USING ((is_active = true));


--
-- Name: lead_qualification; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.lead_qualification ENABLE ROW LEVEL SECURITY;

--
-- Name: lead_scores; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.lead_scores ENABLE ROW LEVEL SECURITY;

--
-- Name: lead_sourcing_credits; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.lead_sourcing_credits ENABLE ROW LEVEL SECURITY;

--
-- Name: lead_sourcing_credits lead_sourcing_credits_create; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY lead_sourcing_credits_create ON public.lead_sourcing_credits FOR INSERT WITH CHECK ((public.auth_has_role('employee'::text) OR public.auth_has_role('admin'::text) OR public.auth_has_role('recruiter'::text)));


--
-- Name: lead_sourcing_credits lead_sourcing_credits_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY lead_sourcing_credits_org_isolation ON public.lead_sourcing_credits USING ((org_id = public.auth_org_id()));


--
-- Name: lead_sourcing_credits lead_sourcing_credits_select; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY lead_sourcing_credits_select ON public.lead_sourcing_credits FOR SELECT USING ((public.auth_has_role('employee'::text) OR public.auth_has_role('admin'::text) OR public.auth_has_role('recruiter'::text)));


--
-- Name: lead_strategies; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.lead_strategies ENABLE ROW LEVEL SECURITY;

--
-- Name: lead_strategies lead_strategies_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY lead_strategies_org_isolation ON public.lead_strategies USING ((org_id = ((auth.jwt() ->> 'org_id'::text))::uuid));


--
-- Name: lead_tasks; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.lead_tasks ENABLE ROW LEVEL SECURITY;

--
-- Name: lead_tasks lead_tasks_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY lead_tasks_org_isolation ON public.lead_tasks USING ((org_id = ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.auth_id = auth.uid()))));


--
-- Name: lead_touchpoints; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.lead_touchpoints ENABLE ROW LEVEL SECURITY;

--
-- Name: leads; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.leads ENABLE ROW LEVEL SECURITY;

--
-- Name: leads leads_employee_insert; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY leads_employee_insert ON public.leads FOR INSERT WITH CHECK ((public.auth_has_role('employee'::text) OR public.auth_has_role('admin'::text) OR public.auth_has_role('ta_specialist'::text)));


--
-- Name: leads leads_employee_select; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY leads_employee_select ON public.leads FOR SELECT USING ((public.auth_has_role('employee'::text) OR public.auth_has_role('admin'::text) OR public.auth_has_role('ta_specialist'::text)));


--
-- Name: leads leads_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY leads_org_isolation ON public.leads USING ((org_id = public.current_user_org_id()));


--
-- Name: leads leads_owner_update; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY leads_owner_update ON public.leads FOR UPDATE USING ((public.auth_has_role('admin'::text) OR (owner_id = auth.uid()) OR (created_by = auth.uid())));


--
-- Name: login_history; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.login_history ENABLE ROW LEVEL SECURITY;

--
-- Name: login_history login_history_org_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY login_history_org_policy ON public.login_history USING (((org_id = public.auth_user_org_id()) OR public.user_is_admin()));


--
-- Name: resume_matches matches_admin_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY matches_admin_all ON public.resume_matches USING (((org_id = public.auth_user_org_id()) AND public.user_has_role('org_admin'::text)));


--
-- Name: resume_matches matches_recruiter_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY matches_recruiter_all ON public.resume_matches USING (((org_id = public.auth_user_org_id()) AND public.user_has_role('recruiter'::text)));


--
-- Name: meeting_notes; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.meeting_notes ENABLE ROW LEVEL SECURITY;

--
-- Name: meeting_notes meeting_notes_employee_access; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY meeting_notes_employee_access ON public.meeting_notes USING ((public.auth_has_role('employee'::text) OR public.auth_has_role('admin'::text) OR public.auth_has_role('recruiter'::text)));


--
-- Name: meeting_notes meeting_notes_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY meeting_notes_org_isolation ON public.meeting_notes USING ((org_id = public.auth_org_id()));


--
-- Name: company_metrics metrics_org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY metrics_org ON public.company_metrics USING ((org_id = public.current_user_org_id()));


--
-- Name: company_notes notes_org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY notes_org ON public.company_notes USING ((org_id = public.current_user_org_id()));


--
-- Name: notifications; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.notifications ENABLE ROW LEVEL SECURITY;

--
-- Name: notifications notifications_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY notifications_org_isolation ON public.notifications USING ((org_id = public.current_user_org_id()));


--
-- Name: notifications notifications_system_create; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY notifications_system_create ON public.notifications FOR INSERT WITH CHECK (true);


--
-- Name: notifications notifications_user_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY notifications_user_own ON public.notifications FOR SELECT USING ((user_id = auth.uid()));


--
-- Name: notifications notifications_user_update_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY notifications_user_update_own ON public.notifications FOR UPDATE USING ((user_id = auth.uid()));


--
-- Name: integration_oauth_tokens oauth_tokens_org_access; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY oauth_tokens_org_access ON public.integration_oauth_tokens USING (((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.auth_id = auth.uid()))) OR ((auth.jwt() ->> 'role'::text) = 'service_role'::text)));


--
-- Name: object_owners; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.object_owners ENABLE ROW LEVEL SECURITY;

--
-- Name: object_owners object_owners_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY object_owners_org_isolation ON public.object_owners USING ((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.auth_id = auth.uid()))));


--
-- Name: object_owners object_owners_user_read; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY object_owners_user_read ON public.object_owners FOR SELECT USING (((org_id = COALESCE((current_setting('app.current_org_id'::text, true))::uuid, ((auth.jwt() ->> 'org_id'::text))::uuid)) AND (user_id = COALESCE((current_setting('app.current_user_id'::text, true))::uuid, ((auth.jwt() ->> 'user_id'::text))::uuid))));


--
-- Name: offers; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.offers ENABLE ROW LEVEL SECURITY;

--
-- Name: offers offers_candidate_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY offers_candidate_own ON public.offers FOR SELECT USING ((candidate_id = auth.uid()));


--
-- Name: offers offers_employee_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY offers_employee_all ON public.offers USING ((public.auth_has_role('employee'::text) OR public.auth_has_role('recruiter'::text) OR public.auth_has_role('admin'::text)));


--
-- Name: onboarding_checklist; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.onboarding_checklist ENABLE ROW LEVEL SECURITY;

--
-- Name: org_context_cache; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.org_context_cache ENABLE ROW LEVEL SECURITY;

--
-- Name: org_context_cache org_context_cache_read; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY org_context_cache_read ON public.org_context_cache FOR SELECT USING ((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid()))));


--
-- Name: org_context_cache org_context_cache_update; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY org_context_cache_update ON public.org_context_cache FOR UPDATE USING ((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE ((user_profiles.id = auth.uid()) AND (user_profiles.employee_role = ANY (ARRAY['ceo'::text, 'admin'::text, 'super_admin'::text]))))));


--
-- Name: org_context_cache org_context_cache_write; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY org_context_cache_write ON public.org_context_cache FOR INSERT WITH CHECK ((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE ((user_profiles.id = auth.uid()) AND (user_profiles.employee_role = ANY (ARRAY['ceo'::text, 'admin'::text, 'super_admin'::text]))))));


--
-- Name: org_standups; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.org_standups ENABLE ROW LEVEL SECURITY;

--
-- Name: org_standups org_standups_org_access; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY org_standups_org_access ON public.org_standups USING ((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid()))));


--
-- Name: organization_branding; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.organization_branding ENABLE ROW LEVEL SECURITY;

--
-- Name: organization_settings; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.organization_settings ENABLE ROW LEVEL SECURITY;

--
-- Name: organizations; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.organizations ENABLE ROW LEVEL SECURITY;

--
-- Name: payment_transactions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.payment_transactions ENABLE ROW LEVEL SECURITY;

--
-- Name: payment_transactions payment_transactions_admin_read; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY payment_transactions_admin_read ON public.payment_transactions FOR SELECT USING ((EXISTS ( SELECT 1
   FROM (public.user_roles ur
     JOIN public.roles r ON ((r.id = ur.role_id)))
  WHERE ((ur.user_id = auth.uid()) AND (r.name = ANY (ARRAY['admin'::text, 'super_admin'::text]))))));


--
-- Name: payment_transactions payment_transactions_own_read; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY payment_transactions_own_read ON public.payment_transactions FOR SELECT USING ((user_id = auth.uid()));


--
-- Name: payroll_items; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.payroll_items ENABLE ROW LEVEL SECURITY;

--
-- Name: payroll_items payroll_items_employee_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY payroll_items_employee_own ON public.payroll_items FOR SELECT USING ((employee_id = auth.uid()));


--
-- Name: payroll_items payroll_items_hr_admin_only; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY payroll_items_hr_admin_only ON public.payroll_items USING ((public.auth_has_role('admin'::text) OR public.auth_has_role('hr'::text)));


--
-- Name: payroll_runs; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.payroll_runs ENABLE ROW LEVEL SECURITY;

--
-- Name: payroll_runs payroll_runs_hr_admin_only; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY payroll_runs_hr_admin_only ON public.payroll_runs USING ((public.auth_has_role('admin'::text) OR public.auth_has_role('hr'::text)));


--
-- Name: payroll_runs payroll_runs_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY payroll_runs_org_isolation ON public.payroll_runs USING ((org_id = public.current_user_org_id()));


--
-- Name: peer_reviews; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.peer_reviews ENABLE ROW LEVEL SECURITY;

--
-- Name: peer_reviews peer_reviews_insert_student; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY peer_reviews_insert_student ON public.peer_reviews FOR INSERT WITH CHECK (((reviewer_id = auth.uid()) AND (NOT (EXISTS ( SELECT 1
   FROM public.capstone_submissions
  WHERE ((capstone_submissions.id = peer_reviews.submission_id) AND (capstone_submissions.user_id = auth.uid())))))));


--
-- Name: peer_reviews peer_reviews_select_own_reviews; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY peer_reviews_select_own_reviews ON public.peer_reviews FOR SELECT USING ((reviewer_id = auth.uid()));


--
-- Name: peer_reviews peer_reviews_select_own_submission; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY peer_reviews_select_own_submission ON public.peer_reviews FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.capstone_submissions
  WHERE ((capstone_submissions.id = peer_reviews.submission_id) AND (capstone_submissions.user_id = auth.uid())))));


--
-- Name: peer_reviews peer_reviews_select_trainer; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY peer_reviews_select_trainer ON public.peer_reviews FOR SELECT USING ((EXISTS ( SELECT 1
   FROM (public.user_roles ur
     JOIN public.roles r ON ((ur.role_id = r.id)))
  WHERE ((ur.user_id = auth.uid()) AND (r.name = ANY (ARRAY['trainer'::text, 'admin'::text, 'super_admin'::text]))))));


--
-- Name: performance_reviews; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.performance_reviews ENABLE ROW LEVEL SECURITY;

--
-- Name: performance_reviews performance_reviews_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY performance_reviews_org_isolation ON public.performance_reviews USING ((org_id = public.current_user_org_id()));


--
-- Name: permission_overrides; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.permission_overrides ENABLE ROW LEVEL SECURITY;

--
-- Name: permission_overrides permission_overrides_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY permission_overrides_org_isolation ON public.permission_overrides USING ((org_id = COALESCE(( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid())), ((auth.jwt() ->> 'org_id'::text))::uuid)));


--
-- Name: permissions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.permissions ENABLE ROW LEVEL SECURITY;

--
-- Name: permissions permissions_public_read; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY permissions_public_read ON public.permissions FOR SELECT USING (true);


--
-- Name: placement_checkins; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.placement_checkins ENABLE ROW LEVEL SECURITY;

--
-- Name: placement_credits; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.placement_credits ENABLE ROW LEVEL SECURITY;

--
-- Name: placement_credits placement_credits_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY placement_credits_org_isolation ON public.placement_credits USING ((org_id = public.current_user_org_id()));


--
-- Name: placements; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.placements ENABLE ROW LEVEL SECURITY;

--
-- Name: placements placements_candidate_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY placements_candidate_own ON public.placements FOR SELECT USING ((candidate_id = auth.uid()));


--
-- Name: placements placements_employee_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY placements_employee_all ON public.placements USING ((public.auth_has_role('employee'::text) OR public.auth_has_role('recruiter'::text) OR public.auth_has_role('admin'::text)));


--
-- Name: placements placements_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY placements_org_isolation ON public.placements USING ((org_id = public.current_user_org_id()));


--
-- Name: pod_managers; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.pod_managers ENABLE ROW LEVEL SECURITY;

--
-- Name: pod_managers pod_managers_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY pod_managers_org_isolation ON public.pod_managers USING ((org_id = ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.auth_id = auth.uid())
 LIMIT 1)));


--
-- Name: pod_managers pod_managers_org_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY pod_managers_org_policy ON public.pod_managers USING (((org_id = public.auth_user_org_id()) OR public.user_is_admin()));


--
-- Name: pod_members; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.pod_members ENABLE ROW LEVEL SECURITY;

--
-- Name: pod_members pod_members_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY pod_members_org_isolation ON public.pod_members USING ((org_id = ((auth.jwt() ->> 'org_id'::text))::uuid));


--
-- Name: pod_sprint_metrics; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.pod_sprint_metrics ENABLE ROW LEVEL SECURITY;

--
-- Name: pod_sprint_metrics pod_sprint_metrics_employee_read; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY pod_sprint_metrics_employee_read ON public.pod_sprint_metrics FOR SELECT USING ((EXISTS ( SELECT 1
   FROM public.user_profiles
  WHERE (user_profiles.auth_id = auth.uid()))));


--
-- Name: pod_sprint_metrics pod_sprint_metrics_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY pod_sprint_metrics_org_isolation ON public.pod_sprint_metrics USING ((org_id = ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.auth_id = auth.uid())
 LIMIT 1)));


--
-- Name: pods; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.pods ENABLE ROW LEVEL SECURITY;

--
-- Name: pods pods_admin_write; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY pods_admin_write ON public.pods USING ((public.auth_has_role('admin'::text) OR public.auth_has_role('hr'::text)));


--
-- Name: pods pods_employee_read; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY pods_employee_read ON public.pods FOR SELECT USING ((public.auth_has_role('employee'::text) OR public.auth_has_role('admin'::text)));


--
-- Name: pods pods_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY pods_org_isolation ON public.pods USING ((org_id = public.current_user_org_id()));


--
-- Name: company_preferences preferences_org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY preferences_org ON public.company_preferences USING ((org_id = public.current_user_org_id()));


--
-- Name: pricing_plans; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.pricing_plans ENABLE ROW LEVEL SECURITY;

--
-- Name: pricing_plans pricing_plans_admin_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY pricing_plans_admin_all ON public.pricing_plans USING ((EXISTS ( SELECT 1
   FROM (public.user_roles ur
     JOIN public.roles r ON ((r.id = ur.role_id)))
  WHERE ((ur.user_id = auth.uid()) AND (r.name = ANY (ARRAY['admin'::text, 'super_admin'::text]))))));


--
-- Name: pricing_plans pricing_plans_public_read; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY pricing_plans_public_read ON public.pricing_plans FOR SELECT USING (((is_active = true) AND (deleted_at IS NULL)));


--
-- Name: productivity_reports; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.productivity_reports ENABLE ROW LEVEL SECURITY;

--
-- Name: project_timeline; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.project_timeline ENABLE ROW LEVEL SECURITY;

--
-- Name: ai_prompt_variants prompt_variants_all_admin; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY prompt_variants_all_admin ON public.ai_prompt_variants USING ((EXISTS ( SELECT 1
   FROM (public.user_roles ur
     JOIN public.roles r ON ((r.id = ur.role_id)))
  WHERE ((ur.user_id = auth.uid()) AND (r.name = 'admin'::text)))));


--
-- Name: pto_balances; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.pto_balances ENABLE ROW LEVEL SECURITY;

--
-- Name: pto_balances pto_balances_employee_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY pto_balances_employee_own ON public.pto_balances FOR SELECT USING ((employee_id = auth.uid()));


--
-- Name: pto_balances pto_balances_hr_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY pto_balances_hr_all ON public.pto_balances USING ((public.auth_has_role('hr'::text) OR public.auth_has_role('admin'::text)));


--
-- Name: ai_question_patterns question_patterns_select_admin; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY question_patterns_select_admin ON public.ai_question_patterns FOR SELECT USING ((EXISTS ( SELECT 1
   FROM (public.user_roles ur
     JOIN public.roles r ON ((r.id = ur.role_id)))
  WHERE ((ur.user_id = auth.uid()) AND (r.name = 'admin'::text)))));


--
-- Name: quiz_attempts; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.quiz_attempts ENABLE ROW LEVEL SECURITY;

--
-- Name: quiz_attempts quiz_attempts_admin_read; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY quiz_attempts_admin_read ON public.quiz_attempts FOR SELECT TO authenticated USING (true);


--
-- Name: quiz_attempts quiz_attempts_user_insert; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY quiz_attempts_user_insert ON public.quiz_attempts FOR INSERT TO authenticated WITH CHECK ((user_id = auth.uid()));


--
-- Name: quiz_attempts quiz_attempts_user_read; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY quiz_attempts_user_read ON public.quiz_attempts FOR SELECT TO authenticated USING ((user_id = auth.uid()));


--
-- Name: quiz_attempts quiz_attempts_user_update; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY quiz_attempts_user_update ON public.quiz_attempts FOR UPDATE TO authenticated USING (((user_id = auth.uid()) AND (submitted_at IS NULL)));


--
-- Name: quiz_questions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.quiz_questions ENABLE ROW LEVEL SECURITY;

--
-- Name: quiz_questions quiz_questions_admin_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY quiz_questions_admin_all ON public.quiz_questions TO authenticated USING (true);


--
-- Name: quiz_questions quiz_questions_student_read; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY quiz_questions_student_read ON public.quiz_questions FOR SELECT TO authenticated USING (((is_public = true) OR (EXISTS ( SELECT 1
   FROM ((public.student_enrollments se
     JOIN public.course_modules cm ON ((cm.course_id = se.course_id)))
     JOIN public.module_topics mt ON ((mt.module_id = cm.id)))
  WHERE ((mt.id = quiz_questions.topic_id) AND (se.user_id = auth.uid()) AND (se.status = 'active'::text))))));


--
-- Name: quiz_settings; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.quiz_settings ENABLE ROW LEVEL SECURITY;

--
-- Name: quiz_settings quiz_settings_admin_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY quiz_settings_admin_all ON public.quiz_settings TO authenticated USING (true);


--
-- Name: quiz_settings quiz_settings_student_read; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY quiz_settings_student_read ON public.quiz_settings FOR SELECT TO authenticated USING ((EXISTS ( SELECT 1
   FROM ((public.student_enrollments se
     JOIN public.course_modules cm ON ((cm.course_id = se.course_id)))
     JOIN public.module_topics mt ON ((mt.module_id = cm.id)))
  WHERE ((mt.id = quiz_settings.topic_id) AND (se.user_id = auth.uid()) AND (se.status = 'active'::text)))));


--
-- Name: raci_change_log; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.raci_change_log ENABLE ROW LEVEL SECURITY;

--
-- Name: raci_change_log raci_change_log_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY raci_change_log_org_isolation ON public.raci_change_log USING ((org_id = COALESCE((current_setting('app.current_org_id'::text, true))::uuid, ((auth.jwt() ->> 'org_id'::text))::uuid)));


--
-- Name: company_rate_card_items rate_card_items_org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY rate_card_items_org ON public.company_rate_card_items USING ((EXISTS ( SELECT 1
   FROM public.company_rate_cards rc
  WHERE ((rc.id = company_rate_card_items.rate_card_id) AND (rc.org_id = public.current_user_org_id())))));


--
-- Name: company_rate_cards rate_cards_org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY rate_cards_org ON public.company_rate_cards USING ((org_id = public.current_user_org_id()));


--
-- Name: reading_progress; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.reading_progress ENABLE ROW LEVEL SECURITY;

--
-- Name: reading_progress reading_progress_user_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY reading_progress_user_policy ON public.reading_progress USING (((user_id = auth.uid()) OR (EXISTS ( SELECT 1
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid()))))) WITH CHECK (((user_id = auth.uid()) OR (EXISTS ( SELECT 1
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid())))));


--
-- Name: candidate_references references_service_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY references_service_all ON public.candidate_references TO service_role USING (true) WITH CHECK (true);


--
-- Name: regions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.regions ENABLE ROW LEVEL SECURITY;

--
-- Name: regions regions_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY regions_org_isolation ON public.regions USING ((org_id = ((auth.jwt() ->> 'org_id'::text))::uuid));


--
-- Name: company_relationships relationships_org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY relationships_org ON public.company_relationships USING ((org_id = public.current_user_org_id()));


--
-- Name: productivity_reports reports_admin_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY reports_admin_all ON public.productivity_reports FOR SELECT USING ((EXISTS ( SELECT 1
   FROM (public.user_roles ur
     JOIN public.roles r ON ((ur.role_id = r.id)))
  WHERE ((ur.user_id = auth.uid()) AND (r.name = 'admin'::text)))));


--
-- Name: productivity_reports reports_system_insert; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY reports_system_insert ON public.productivity_reports FOR INSERT WITH CHECK (true);


--
-- Name: productivity_reports reports_system_update; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY reports_system_update ON public.productivity_reports FOR UPDATE USING (true);


--
-- Name: productivity_reports reports_user_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY reports_user_own ON public.productivity_reports FOR SELECT USING ((user_id = auth.uid()));


--
-- Name: requisition_embeddings; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.requisition_embeddings ENABLE ROW LEVEL SECURITY;

--
-- Name: requisition_embeddings requisitions_recruiter_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY requisitions_recruiter_all ON public.requisition_embeddings FOR SELECT USING (((org_id = public.auth_user_org_id()) AND public.user_has_role('recruiter'::text)));


--
-- Name: requisition_embeddings requisitions_service_role; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY requisitions_service_role ON public.requisition_embeddings USING ((((current_setting('request.jwt.claims'::text, true))::json ->> 'role'::text) = 'service_role'::text));


--
-- Name: resume_matches; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.resume_matches ENABLE ROW LEVEL SECURITY;

--
-- Name: resume_versions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.resume_versions ENABLE ROW LEVEL SECURITY;

--
-- Name: generated_resumes resumes_admin_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY resumes_admin_all ON public.generated_resumes USING (((org_id = public.auth_user_org_id()) AND public.user_has_role('org_admin'::text)));


--
-- Name: generated_resumes resumes_trainer_view; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY resumes_trainer_view ON public.generated_resumes FOR SELECT USING (((org_id = public.auth_user_org_id()) AND public.user_has_role('trainer'::text)));


--
-- Name: generated_resumes resumes_user_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY resumes_user_own ON public.generated_resumes USING (((user_id = auth.uid()) AND (org_id = public.auth_user_org_id())));


--
-- Name: retention_policies; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.retention_policies ENABLE ROW LEVEL SECURITY;

--
-- Name: retention_policies retention_policies_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY retention_policies_org_isolation ON public.retention_policies USING (((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.auth_id = auth.uid()))) OR ((auth.jwt() ->> 'role'::text) = 'service_role'::text)));


--
-- Name: integration_retry_config retry_config_org_access; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY retry_config_org_access ON public.integration_retry_config USING (((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.auth_id = auth.uid()))) OR ((auth.jwt() ->> 'role'::text) = 'service_role'::text)));


--
-- Name: company_revenue revenue_org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY revenue_org ON public.company_revenue USING ((org_id = public.current_user_org_id()));


--
-- Name: performance_reviews reviews_employee_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY reviews_employee_own ON public.performance_reviews FOR SELECT USING (((employee_id = auth.uid()) OR (reviewer_id = auth.uid())));


--
-- Name: performance_reviews reviews_hr_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY reviews_hr_all ON public.performance_reviews USING ((public.auth_has_role('hr'::text) OR public.auth_has_role('admin'::text)));


--
-- Name: performance_reviews reviews_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY reviews_org_isolation ON public.performance_reviews USING ((org_id = public.auth_org_id()));


--
-- Name: role_permissions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.role_permissions ENABLE ROW LEVEL SECURITY;

--
-- Name: role_permissions role_permissions_public_read; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY role_permissions_public_read ON public.role_permissions FOR SELECT USING (true);


--
-- Name: roles; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.roles ENABLE ROW LEVEL SECURITY;

--
-- Name: saved_searches; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.saved_searches ENABLE ROW LEVEL SECURITY;

--
-- Name: saved_searches saved_searches_delete_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY saved_searches_delete_policy ON public.saved_searches FOR DELETE USING (((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid()))) AND (user_id = auth.uid())));


--
-- Name: saved_searches saved_searches_insert_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY saved_searches_insert_policy ON public.saved_searches FOR INSERT WITH CHECK (((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid()))) AND (user_id = auth.uid())));


--
-- Name: saved_searches saved_searches_select_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY saved_searches_select_policy ON public.saved_searches FOR SELECT USING (((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid()))) AND ((user_id = auth.uid()) OR (is_shared = true)) AND (deleted_at IS NULL)));


--
-- Name: saved_searches saved_searches_update_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY saved_searches_update_policy ON public.saved_searches FOR UPDATE USING (((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid()))) AND (user_id = auth.uid())));


--
-- Name: employee_screenshots screenshots_admin_select; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY screenshots_admin_select ON public.employee_screenshots FOR SELECT USING ((EXISTS ( SELECT 1
   FROM (public.user_roles ur
     JOIN public.roles r ON ((ur.role_id = r.id)))
  WHERE ((ur.user_id = auth.uid()) AND (r.name = 'admin'::text)))));


--
-- Name: security_alerts; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.security_alerts ENABLE ROW LEVEL SECURITY;

--
-- Name: sequence_templates; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.sequence_templates ENABLE ROW LEVEL SECURITY;

--
-- Name: sequence_templates sequence_templates_delete_org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY sequence_templates_delete_org ON public.sequence_templates FOR DELETE USING ((org_id = (current_setting('app.current_org_id'::text, true))::uuid));


--
-- Name: sequence_templates sequence_templates_insert_org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY sequence_templates_insert_org ON public.sequence_templates FOR INSERT WITH CHECK ((org_id = (current_setting('app.current_org_id'::text, true))::uuid));


--
-- Name: sequence_templates sequence_templates_select_org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY sequence_templates_select_org ON public.sequence_templates FOR SELECT USING ((org_id = (current_setting('app.current_org_id'::text, true))::uuid));


--
-- Name: sequence_templates sequence_templates_update_org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY sequence_templates_update_org ON public.sequence_templates FOR UPDATE USING ((org_id = (current_setting('app.current_org_id'::text, true))::uuid));


--
-- Name: user_session_context session_context_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY session_context_own ON public.user_session_context USING ((user_id = auth.uid()));


--
-- Name: session_metadata; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.session_metadata ENABLE ROW LEVEL SECURITY;

--
-- Name: skills; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.skills ENABLE ROW LEVEL SECURITY;

--
-- Name: skills skills_admin_write; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY skills_admin_write ON public.skills USING (public.auth_has_role('admin'::text));


--
-- Name: skills skills_public_read; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY skills_public_read ON public.skills FOR SELECT USING (true);


--
-- Name: sla_definitions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.sla_definitions ENABLE ROW LEVEL SECURITY;

--
-- Name: sla_definitions sla_definitions_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY sla_definitions_org_isolation ON public.sla_definitions USING (((org_id IS NULL) OR (org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.auth_id = auth.uid())))));


--
-- Name: sla_escalation_levels; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.sla_escalation_levels ENABLE ROW LEVEL SECURITY;

--
-- Name: sla_escalation_levels sla_escalation_levels_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY sla_escalation_levels_org_isolation ON public.sla_escalation_levels USING ((sla_definition_id IN ( SELECT sla_definitions.id
   FROM public.sla_definitions
  WHERE (sla_definitions.org_id = COALESCE((current_setting('app.current_org_id'::text, true))::uuid, ((auth.jwt() ->> 'org_id'::text))::uuid)))));


--
-- Name: sla_events; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.sla_events ENABLE ROW LEVEL SECURITY;

--
-- Name: sla_events sla_events_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY sla_events_org_isolation ON public.sla_events USING ((org_id = COALESCE((current_setting('app.current_org_id'::text, true))::uuid, ((auth.jwt() ->> 'org_id'::text))::uuid)));


--
-- Name: sla_instances; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.sla_instances ENABLE ROW LEVEL SECURITY;

--
-- Name: sla_instances sla_instances_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY sla_instances_org_isolation ON public.sla_instances USING ((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.auth_id = auth.uid()))));


--
-- Name: sla_notifications; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.sla_notifications ENABLE ROW LEVEL SECURITY;

--
-- Name: sla_notifications sla_notifications_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY sla_notifications_org_isolation ON public.sla_notifications USING ((sla_event_id IN ( SELECT sla_events.id
   FROM public.sla_events
  WHERE (sla_events.org_id = COALESCE((current_setting('app.current_org_id'::text, true))::uuid, ((auth.jwt() ->> 'org_id'::text))::uuid)))));


--
-- Name: student_enrollments; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.student_enrollments ENABLE ROW LEVEL SECURITY;

--
-- Name: student_interventions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.student_interventions ENABLE ROW LEVEL SECURITY;

--
-- Name: student_progress; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.student_progress ENABLE ROW LEVEL SECURITY;

--
-- Name: student_progress student_progress_select_platform_admin; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY student_progress_select_platform_admin ON public.student_progress FOR SELECT USING (public.user_is_admin());


--
-- Name: submissions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.submissions ENABLE ROW LEVEL SECURITY;

--
-- Name: submissions submissions_candidate_own_read; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY submissions_candidate_own_read ON public.submissions FOR SELECT USING ((public.auth_has_role('candidate'::text) AND (candidate_id = auth.uid())));


--
-- Name: submissions submissions_client_own_read; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY submissions_client_own_read ON public.submissions FOR SELECT USING ((public.auth_has_role('client'::text) AND (account_id IN ( SELECT COALESCE(( SELECT accounts.id
           FROM public.accounts
          WHERE (accounts.name = ( SELECT user_profiles.client_company_name
                   FROM public.user_profiles
                  WHERE (user_profiles.id = auth.uid())))), NULL::uuid) AS "coalesce")) AND (status = ANY (ARRAY['submitted_to_client'::text, 'client_review'::text, 'client_interview'::text, 'offer_stage'::text, 'placed'::text]))));


--
-- Name: submissions submissions_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY submissions_org_isolation ON public.submissions USING ((org_id = public.current_user_org_id()));


--
-- Name: submissions submissions_recruiter_write; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY submissions_recruiter_write ON public.submissions USING ((public.auth_has_role('recruiter'::text) OR public.auth_has_role('admin'::text) OR (owner_id = auth.uid())));


--
-- Name: system_roles; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.system_roles ENABLE ROW LEVEL SECURITY;

--
-- Name: system_roles system_roles_public_read; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY system_roles_public_read ON public.system_roles FOR SELECT USING (true);


--
-- Name: company_tags tags_org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY tags_org ON public.company_tags USING ((org_id = public.current_user_org_id()));


--
-- Name: talking_point_templates; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.talking_point_templates ENABLE ROW LEVEL SECURITY;

--
-- Name: talking_point_templates talking_point_templates_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY talking_point_templates_org_isolation ON public.talking_point_templates USING ((org_id = ((auth.jwt() ->> 'org_id'::text))::uuid));


--
-- Name: tasks; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.tasks ENABLE ROW LEVEL SECURITY;

--
-- Name: tasks tasks_assigned_or_created; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY tasks_assigned_or_created ON public.tasks FOR SELECT USING (((assigned_to = auth.uid()) OR (created_by = auth.uid()) OR public.auth_has_role('admin'::text)));


--
-- Name: tasks tasks_create_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY tasks_create_own ON public.tasks FOR INSERT WITH CHECK ((created_by = auth.uid()));


--
-- Name: tasks tasks_delete_creator_or_admin; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY tasks_delete_creator_or_admin ON public.tasks FOR DELETE USING (((created_by = auth.uid()) OR public.auth_has_role('admin'::text)));


--
-- Name: tasks tasks_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY tasks_org_isolation ON public.tasks USING ((org_id = public.current_user_org_id()));


--
-- Name: tasks tasks_update_assigned_or_admin; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY tasks_update_assigned_or_admin ON public.tasks FOR UPDATE USING (((assigned_to = auth.uid()) OR (created_by = auth.uid()) OR public.auth_has_role('admin'::text)));


--
-- Name: company_team team_org; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY team_org ON public.company_team USING ((org_id = public.current_user_org_id()));


--
-- Name: time_attendance; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.time_attendance ENABLE ROW LEVEL SECURITY;

--
-- Name: time_attendance time_attendance_employee_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY time_attendance_employee_own ON public.time_attendance USING ((employee_id = auth.uid()));


--
-- Name: time_attendance time_attendance_hr_read; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY time_attendance_hr_read ON public.time_attendance FOR SELECT USING ((public.auth_has_role('hr'::text) OR public.auth_has_role('admin'::text)));


--
-- Name: time_attendance time_attendance_manager_approve; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY time_attendance_manager_approve ON public.time_attendance FOR UPDATE USING ((public.auth_has_role('hr'::text) OR public.auth_has_role('admin'::text) OR (employee_id IN ( SELECT user_profiles.id
   FROM public.user_profiles
  WHERE (user_profiles.employee_manager_id = auth.uid())))));


--
-- Name: topic_completions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.topic_completions ENABLE ROW LEVEL SECURITY;

--
-- Name: trainer_responses; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.trainer_responses ENABLE ROW LEVEL SECURITY;

--
-- Name: trainer_responses trainer_responses_insert_staff; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY trainer_responses_insert_staff ON public.trainer_responses FOR INSERT WITH CHECK (((trainer_id = auth.uid()) AND (EXISTS ( SELECT 1
   FROM (public.user_roles ur
     JOIN public.roles r ON ((r.id = ur.role_id)))
  WHERE ((ur.user_id = auth.uid()) AND (r.name = ANY (ARRAY['admin'::text, 'trainer'::text])))))));


--
-- Name: trainer_responses trainer_responses_select_staff; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY trainer_responses_select_staff ON public.trainer_responses FOR SELECT USING ((EXISTS ( SELECT 1
   FROM (public.user_roles ur
     JOIN public.roles r ON ((r.id = ur.role_id)))
  WHERE ((ur.user_id = auth.uid()) AND (r.name = ANY (ARRAY['admin'::text, 'trainer'::text]))))));


--
-- Name: trainer_responses trainer_responses_select_student; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY trainer_responses_select_student ON public.trainer_responses FOR SELECT USING (((is_internal_note = false) AND (EXISTS ( SELECT 1
   FROM public.ai_mentor_escalations e
  WHERE ((e.id = trainer_responses.escalation_id) AND (e.user_id = auth.uid()))))));


--
-- Name: twin_conversations; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.twin_conversations ENABLE ROW LEVEL SECURITY;

--
-- Name: twin_conversations twin_conversations_org_access; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY twin_conversations_org_access ON public.twin_conversations USING ((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid()))));


--
-- Name: twin_events; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.twin_events ENABLE ROW LEVEL SECURITY;

--
-- Name: twin_events twin_events_org_access; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY twin_events_org_access ON public.twin_events USING ((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid()))));


--
-- Name: twin_preferences; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.twin_preferences ENABLE ROW LEVEL SECURITY;

--
-- Name: twin_preferences twin_preferences_user_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY twin_preferences_user_own ON public.twin_preferences USING ((user_id = auth.uid()));


--
-- Name: user_badges; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.user_badges ENABLE ROW LEVEL SECURITY;

--
-- Name: user_badges user_badges_select_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY user_badges_select_own ON public.user_badges FOR SELECT USING ((user_id = auth.uid()));


--
-- Name: user_badges user_badges_update_own; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY user_badges_update_own ON public.user_badges FOR UPDATE USING ((user_id = auth.uid())) WITH CHECK ((user_id = auth.uid()));


--
-- Name: user_invitations; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.user_invitations ENABLE ROW LEVEL SECURITY;

--
-- Name: user_invitations user_invitations_org_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY user_invitations_org_policy ON public.user_invitations USING (((org_id = public.auth_user_org_id()) OR public.user_is_admin()));


--
-- Name: user_profiles; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.user_profiles ENABLE ROW LEVEL SECURITY;

--
-- Name: user_profiles user_profiles_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY user_profiles_org_isolation ON public.user_profiles USING (((org_id = public.current_user_org_id()) OR (org_id IS NULL)));


--
-- Name: user_roles; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.user_roles ENABLE ROW LEVEL SECURITY;

--
-- Name: user_session_context; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.user_session_context ENABLE ROW LEVEL SECURITY;

--
-- Name: vendors; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.vendors ENABLE ROW LEVEL SECURITY;

--
-- Name: vendors vendors_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY vendors_org_isolation ON public.vendors USING ((org_id = public.current_user_org_id()));


--
-- Name: video_progress; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.video_progress ENABLE ROW LEVEL SECURITY;

--
-- Name: video_progress video_progress_student_policy; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY video_progress_student_policy ON public.video_progress USING (((user_id = auth.uid()) OR (EXISTS ( SELECT 1
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid()))))) WITH CHECK (((user_id = auth.uid()) OR (EXISTS ( SELECT 1
   FROM public.user_profiles
  WHERE (user_profiles.id = auth.uid())))));


--
-- Name: webhook_deliveries; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.webhook_deliveries ENABLE ROW LEVEL SECURITY;

--
-- Name: webhook_deliveries webhook_deliveries_org_access; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY webhook_deliveries_org_access ON public.webhook_deliveries USING (((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.auth_id = auth.uid()))) OR ((auth.jwt() ->> 'role'::text) = 'service_role'::text)));


--
-- Name: webhooks; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.webhooks ENABLE ROW LEVEL SECURITY;

--
-- Name: webhooks webhooks_org_access; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY webhooks_org_access ON public.webhooks USING (((org_id IN ( SELECT user_profiles.org_id
   FROM public.user_profiles
  WHERE (user_profiles.auth_id = auth.uid()))) OR ((auth.jwt() ->> 'role'::text) = 'service_role'::text)));


--
-- Name: candidate_work_authorizations work_auth_service_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY work_auth_service_all ON public.candidate_work_authorizations TO service_role USING (true) WITH CHECK (true);


--
-- Name: candidate_work_history work_history_service_all; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY work_history_service_all ON public.candidate_work_history TO service_role USING (true) WITH CHECK (true);


--
-- Name: workflow_history; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.workflow_history ENABLE ROW LEVEL SECURITY;

--
-- Name: workflow_instances; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.workflow_instances ENABLE ROW LEVEL SECURITY;

--
-- Name: workflow_states; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.workflow_states ENABLE ROW LEVEL SECURITY;

--
-- Name: workflow_transitions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.workflow_transitions ENABLE ROW LEVEL SECURITY;

--
-- Name: workflows; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.workflows ENABLE ROW LEVEL SECURITY;

--
-- Name: workplan_instances; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.workplan_instances ENABLE ROW LEVEL SECURITY;

--
-- Name: workplan_instances workplan_instances_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY workplan_instances_org_isolation ON public.workplan_instances USING ((org_id = public.current_user_org_id()));


--
-- Name: workplan_templates; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.workplan_templates ENABLE ROW LEVEL SECURITY;

--
-- Name: workplan_templates workplan_templates_org_isolation; Type: POLICY; Schema: public; Owner: -
--

CREATE POLICY workplan_templates_org_isolation ON public.workplan_templates USING (((org_id = public.current_user_org_id()) OR (is_system = true)));


--
-- Name: xp_transactions; Type: ROW SECURITY; Schema: public; Owner: -
--

ALTER TABLE public.xp_transactions ENABLE ROW LEVEL SECURITY;

--
-- PostgreSQL database dump complete
--

\unrestrict Lf0LsF0AiGr8ScL5bJCl6CRwmfktnvQ2W2sLKwwufzcNr86cBEz4eXm8AZLTje5

