# ISSUE: Clean Up Interviews Schema

**Issue ID:** INTERVIEWS-01
**Created:** 2025-12-11
**Status:** Open
**Priority:** High
**Type:** Migration/Integration
**Reporter:** System (Architecture Review)
**Depends On:** CONTACTS-01 (unified contacts), SUBMISSIONS-01 (submissions migration)

---

## Summary

Clean up and standardize the interviews schema to use unified contacts for candidates and interviewers, integrate with entity_history for status tracking, and create a comprehensive feedback system. Currently, interviews have inconsistent contact references, fragmented feedback data, and limited calendar integration support.

## Location

- **Current Table**: `interviews`
- **Target**: `interviews` with unified contacts and standardized schema
- **Related Tables**: `interview_feedback`, `interview_slots`, `interview_panels`, `calendar_events`
- **Affected Modules**: ATS, Recruiting, Calendar

## Problem Description

### Current State Issues

1. **Inconsistent Contact References**:
   - `interviews.candidate_id` may reference legacy candidates table
   - Interviewers stored as user_profiles, not contacts
   - External interviewers (client-side) not properly tracked

2. **Feedback Fragmentation**:
   - Interview feedback not standardized
   - Different feedback formats per interview type
   - No structured scoring criteria

3. **Calendar Integration Gaps**:
   - Interview scheduling not fully integrated with calendar
   - No timezone handling standardization
   - Video conferencing links not consistently tracked

4. **Panel Interview Limitations**:
   - Multiple interviewers not well supported
   - Round tracking inconsistent
   - Sequential vs. panel not distinguished

5. **Status History**:
   - Interview status changes not tracked in entity_history

### Interviews Table Current Structure (Key Fields)

```sql
-- Current interviews table (simplified)
interviews:
  id, org_id
  submission_id  -- FK to submissions
  candidate_id  -- Legacy FK, should come from submission
  job_id  -- FK to jobs
  interviewer_id  -- FK to user_profiles (internal only)
  interview_type  -- phone, video, onsite, panel
  status  -- scheduled, completed, cancelled, no_show
  scheduled_at, duration_minutes
  feedback, rating
  created_at, updated_at, deleted_at
```

## Expected Behavior

After cleanup:
1. `interviews.contact_id` from submission (the candidate)
2. `interview_participants` table for all participants (internal + external)
3. Standardized feedback via `interview_feedback` with criteria scoring
4. Full calendar integration with timezone support
5. Panel and round tracking
6. Status history in entity_history

## Proposed Schema Changes

### Interviews Table Updates

```sql
-- Updated interviews table
ALTER TABLE interviews
  -- Candidate reference (from submission's contact_id)
  ADD COLUMN contact_id UUID REFERENCES contacts(id),
  
  -- Interview details
  ADD COLUMN interview_round INTEGER DEFAULT 1,
  ADD COLUMN interview_format VARCHAR,  -- 'one_on_one', 'panel', 'group', 'presentation'
  ADD COLUMN interview_mode VARCHAR,  -- 'in_person', 'video', 'phone'
  
  -- Location/Meeting details
  ADD COLUMN location_type VARCHAR,  -- 'office', 'client_site', 'remote'
  ADD COLUMN location_address TEXT,
  ADD COLUMN location_room VARCHAR,
  ADD COLUMN meeting_link VARCHAR,
  ADD COLUMN meeting_provider VARCHAR,  -- 'zoom', 'teams', 'google_meet', 'webex'
  ADD COLUMN meeting_id VARCHAR,
  ADD COLUMN meeting_password VARCHAR,
  ADD COLUMN dial_in_number VARCHAR,
  ADD COLUMN dial_in_pin VARCHAR,
  
  -- Time with timezone
  ADD COLUMN timezone VARCHAR DEFAULT 'America/Chicago',
  ADD COLUMN scheduled_end_at TIMESTAMPTZ,
  ADD COLUMN actual_start_at TIMESTAMPTZ,
  ADD COLUMN actual_end_at TIMESTAMPTZ,
  
  -- Organizer
  ADD COLUMN organizer_id UUID REFERENCES user_profiles(id),
  ADD COLUMN organized_by_client BOOLEAN DEFAULT false,
  ADD COLUMN client_contact_id UUID REFERENCES contacts(id),  -- If client organized
  
  -- Confirmation tracking
  ADD COLUMN candidate_confirmed BOOLEAN DEFAULT false,
  ADD COLUMN candidate_confirmed_at TIMESTAMPTZ,
  ADD COLUMN interviewers_confirmed BOOLEAN DEFAULT false,
  
  -- Reminders
  ADD COLUMN reminder_sent_at TIMESTAMPTZ,
  ADD COLUMN reminder_24h_sent BOOLEAN DEFAULT false,
  ADD COLUMN reminder_1h_sent BOOLEAN DEFAULT false,
  
  -- Calendar integration
  ADD COLUMN calendar_event_id VARCHAR,  -- External calendar ID
  ADD COLUMN calendar_provider VARCHAR,  -- 'google', 'outlook', 'ical'
  ADD COLUMN ics_file_url VARCHAR,
  
  -- Outcome
  ADD COLUMN outcome VARCHAR,  -- 'passed', 'failed', 'pending', 'on_hold'
  ADD COLUMN outcome_decided_at TIMESTAMPTZ,
  ADD COLUMN proceed_to_next_round BOOLEAN,
  ADD COLUMN next_round_scheduled BOOLEAN DEFAULT false,
  
  -- Aggregated scores (denormalized from feedback)
  ADD COLUMN avg_rating NUMERIC(3,2),
  ADD COLUMN recommendation_summary VARCHAR,  -- 'strong_hire', 'hire', 'no_hire', 'strong_no_hire'
  ADD COLUMN feedback_complete BOOLEAN DEFAULT false,
  ADD COLUMN feedback_due_at TIMESTAMPTZ;

-- Sync contact_id from submission
UPDATE interviews i
SET contact_id = s.contact_id
FROM submissions s
WHERE i.submission_id = s.id;

-- Indexes
CREATE INDEX idx_interviews_contact ON interviews(contact_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_interviews_submission ON interviews(submission_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_interviews_scheduled ON interviews(scheduled_at) WHERE status = 'scheduled' AND deleted_at IS NULL;
CREATE INDEX idx_interviews_status ON interviews(status) WHERE deleted_at IS NULL;
CREATE INDEX idx_interviews_feedback_pending ON interviews(id) WHERE feedback_complete = false AND status = 'completed' AND deleted_at IS NULL;
```

### Interview Participants Table

```sql
-- All participants in an interview (replaces single interviewer_id)
CREATE TABLE interview_participants (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  interview_id UUID NOT NULL REFERENCES interviews(id) ON DELETE CASCADE,
  
  -- Participant reference
  participant_type VARCHAR NOT NULL,  -- 'internal', 'client', 'candidate'
  user_id UUID REFERENCES user_profiles(id),  -- Internal users
  contact_id UUID REFERENCES contacts(id),  -- External (client interviewers, candidate)
  
  -- Role
  role VARCHAR NOT NULL,  -- 'interviewer', 'observer', 'note_taker', 'candidate', 'coordinator'
  is_primary BOOLEAN DEFAULT false,  -- Primary interviewer
  is_decision_maker BOOLEAN DEFAULT false,
  
  -- For panel/round assignment
  panel_group VARCHAR,  -- For parallel panels
  interview_order INTEGER,  -- For sequential interviews
  
  -- Attendance
  status VARCHAR DEFAULT 'pending',  -- 'pending', 'confirmed', 'declined', 'attended', 'no_show'
  confirmed_at TIMESTAMPTZ,
  declined_reason TEXT,
  
  -- Notifications
  invite_sent_at TIMESTAMPTZ,
  reminder_sent_at TIMESTAMPTZ,
  
  -- Feedback tracking (for interviewers)
  feedback_submitted BOOLEAN DEFAULT false,
  feedback_submitted_at TIMESTAMPTZ,
  feedback_id UUID,  -- REFERENCES interview_feedback(id)
  
  -- Audit
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  
  CONSTRAINT participant_reference CHECK (
    (participant_type = 'internal' AND user_id IS NOT NULL) OR
    (participant_type IN ('client', 'candidate') AND contact_id IS NOT NULL)
  )
);

CREATE INDEX idx_interview_participants_interview ON interview_participants(interview_id);
CREATE INDEX idx_interview_participants_user ON interview_participants(user_id) WHERE user_id IS NOT NULL;
CREATE INDEX idx_interview_participants_contact ON interview_participants(contact_id) WHERE contact_id IS NOT NULL;
CREATE INDEX idx_interview_participants_pending ON interview_participants(interview_id) WHERE feedback_submitted = false;
```

### Interview Feedback Table (Enhanced)

```sql
-- Structured interview feedback
CREATE TABLE interview_feedback (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  interview_id UUID NOT NULL REFERENCES interviews(id) ON DELETE CASCADE,
  participant_id UUID NOT NULL REFERENCES interview_participants(id),
  
  -- Submitter info
  submitted_by_user_id UUID REFERENCES user_profiles(id),
  submitted_by_contact_id UUID REFERENCES contacts(id),
  submitted_at TIMESTAMPTZ DEFAULT now(),
  
  -- Overall assessment
  overall_rating INTEGER CHECK (overall_rating BETWEEN 1 AND 5),
  recommendation VARCHAR NOT NULL,  -- 'strong_hire', 'hire', 'no_hire', 'strong_no_hire', 'need_more_info'
  confidence_level INTEGER CHECK (confidence_level BETWEEN 1 AND 5),
  
  -- Criteria-based scoring (JSONB for flexibility)
  criteria_scores JSONB,
  /* Example:
  {
    "technical_skills": { "score": 4, "notes": "Strong React experience" },
    "communication": { "score": 5, "notes": "Excellent communication" },
    "problem_solving": { "score": 4, "notes": "Good analytical thinking" },
    "culture_fit": { "score": 3, "notes": "May need adjustment to our pace" },
    "experience": { "score": 4, "notes": "7 years relevant experience" }
  }
  */
  
  -- Freeform feedback
  strengths TEXT,
  weaknesses TEXT,
  concerns TEXT,
  additional_notes TEXT,
  
  -- Questions asked
  questions_asked JSONB,  -- [{ question: "", answer_quality: 1-5, notes: "" }]
  
  -- Technical assessment (if applicable)
  technical_assessment_score INTEGER,
  technical_assessment_notes TEXT,
  code_quality_notes TEXT,
  
  -- Behavioral assessment
  behavioral_examples JSONB,  -- STAR examples captured
  
  -- Next steps recommendation
  recommended_next_step VARCHAR,  -- 'next_round', 'offer', 'reject', 'hold'
  recommended_role VARCHAR,  -- If different from applied
  recommended_level VARCHAR,  -- If different from applied
  salary_recommendation JSONB,  -- { min, max, target }
  
  -- Visibility
  is_visible_to_client BOOLEAN DEFAULT false,
  is_visible_to_candidate BOOLEAN DEFAULT false,
  
  -- Status
  status VARCHAR DEFAULT 'draft',  -- 'draft', 'submitted', 'reviewed'
  reviewed_by UUID REFERENCES user_profiles(id),
  reviewed_at TIMESTAMPTZ,
  
  -- Audit
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  deleted_at TIMESTAMPTZ
);

CREATE INDEX idx_interview_feedback_interview ON interview_feedback(interview_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_interview_feedback_participant ON interview_feedback(participant_id);
CREATE INDEX idx_interview_feedback_status ON interview_feedback(status) WHERE deleted_at IS NULL;
```

### Interview Scorecards (Templates)

```sql
-- Scorecard templates for consistent evaluation
CREATE TABLE interview_scorecards (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  
  -- Identity
  scorecard_name VARCHAR NOT NULL,
  scorecard_code VARCHAR,  -- 'TECH_SCREEN', 'FINAL_ROUND'
  description TEXT,
  
  -- Applicability
  interview_type VARCHAR,  -- NULL = all types
  job_category VARCHAR,  -- NULL = all jobs
  
  -- Criteria definition
  criteria JSONB NOT NULL,
  /* Example:
  [
    {
      "id": "technical",
      "name": "Technical Skills",
      "weight": 30,
      "required": true,
      "description": "Evaluate coding ability and technical knowledge",
      "scoring_guide": { "1": "Needs development", "3": "Meets expectations", "5": "Exceptional" }
    },
    {
      "id": "communication",
      "name": "Communication",
      "weight": 20,
      "required": true
    }
  ]
  */
  
  -- Weighting
  total_weight INTEGER DEFAULT 100,
  passing_score INTEGER DEFAULT 60,
  
  -- Status
  is_active BOOLEAN DEFAULT true,
  is_default BOOLEAN DEFAULT false,
  
  -- Audit
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  created_by UUID REFERENCES user_profiles(id),
  deleted_at TIMESTAMPTZ
);

CREATE INDEX idx_interview_scorecards_active ON interview_scorecards(org_id) WHERE is_active = true AND deleted_at IS NULL;
```

## Migration Strategy

### Phase 1: Schema Updates (Non-Breaking)
- Add new columns to interviews table
- Create interview_participants table
- Create enhanced interview_feedback table
- Create interview_scorecards table

### Phase 2: Data Migration

```sql
-- Step 1: Populate contact_id from submission
UPDATE interviews i
SET contact_id = s.contact_id
FROM submissions s
WHERE i.submission_id = s.id
  AND i.contact_id IS NULL;

-- Step 2: Migrate single interviewer to participants
INSERT INTO interview_participants (
  org_id, interview_id,
  participant_type, user_id,
  role, is_primary,
  status, feedback_submitted,
  created_at
)
SELECT
  i.org_id, i.id,
  'internal', i.interviewer_id,
  'interviewer', true,
  CASE i.status 
    WHEN 'completed' THEN 'attended'
    WHEN 'cancelled' THEN 'declined'
    ELSE 'confirmed'
  END,
  i.feedback IS NOT NULL,
  i.created_at
FROM interviews i
WHERE i.interviewer_id IS NOT NULL;

-- Step 3: Migrate existing feedback
INSERT INTO interview_feedback (
  org_id, interview_id, participant_id,
  submitted_by_user_id, submitted_at,
  overall_rating, recommendation,
  additional_notes, status
)
SELECT
  i.org_id, i.id, ip.id,
  i.interviewer_id, i.updated_at,
  i.rating, 
  CASE 
    WHEN i.rating >= 4 THEN 'hire'
    WHEN i.rating >= 3 THEN 'no_hire'
    ELSE 'strong_no_hire'
  END,
  i.feedback,
  'submitted'
FROM interviews i
JOIN interview_participants ip ON ip.interview_id = i.id AND ip.is_primary = true
WHERE i.feedback IS NOT NULL;

-- Step 4: Migrate status changes to entity_history
INSERT INTO entity_history (
  org_id, entity_type, entity_id,
  change_type, field_name,
  old_value, new_value,
  changed_by, changed_at
)
SELECT
  i.org_id, 'interview', i.id,
  'status_change', 'status',
  NULL, i.status,
  i.created_by, i.created_at
FROM interviews i
WHERE i.deleted_at IS NULL;
```

### Phase 3: Default Scorecards
- Create standard technical interview scorecard
- Create standard behavioral interview scorecard
- Create final round scorecard

### Phase 4: Router & UI Updates
- Update interview scheduling forms
- Add participant management
- Add structured feedback collection
- Add scorecard selection

## Acceptance Criteria

### Schema Implementation
- [ ] Add `contact_id` FK to `contacts`
- [ ] Add calendar integration fields
- [ ] Add timezone support
- [ ] Add meeting details fields
- [ ] Add outcome tracking fields
- [ ] Create `interview_participants` table
- [ ] Create enhanced `interview_feedback` table
- [ ] Create `interview_scorecards` table
- [ ] All indexes created
- [ ] RLS policies updated

### Data Migration
- [ ] All interviews have `contact_id` populated
- [ ] Existing interviewers migrated to participants
- [ ] Existing feedback migrated to new structure
- [ ] Status history migrated to entity_history
- [ ] No orphaned references

### Backward Compatibility
- [ ] Existing interview queries work
- [ ] Scheduling flows continue working
- [ ] Feedback submission works

### Frontend Updates
- [ ] Interview scheduling with participant management
- [ ] Calendar integration (invite send)
- [ ] Structured feedback form with scorecard
- [ ] Multi-interviewer support
- [ ] Panel interview configuration
- [ ] Feedback aggregation view

### Testing
- [ ] Migration script tested on staging
- [ ] Calendar integration tested
- [ ] Feedback workflow tested
- [ ] Performance benchmarks acceptable

---

## Rollback Plan

### Schema Rollback
```sql
-- Reverse order of creation
DROP TABLE IF EXISTS interview_scorecards;
DROP TABLE IF EXISTS interview_feedback;  -- New enhanced table
DROP TABLE IF EXISTS interview_participants;

-- Remove new columns from interviews (in reverse order)
ALTER TABLE interviews
  DROP COLUMN IF EXISTS feedback_due_at,
  DROP COLUMN IF EXISTS feedback_complete,
  DROP COLUMN IF EXISTS recommendation_summary,
  DROP COLUMN IF EXISTS avg_rating,
  DROP COLUMN IF EXISTS next_round_scheduled,
  DROP COLUMN IF EXISTS proceed_to_next_round,
  DROP COLUMN IF EXISTS outcome_decided_at,
  DROP COLUMN IF EXISTS outcome,
  DROP COLUMN IF EXISTS ics_file_url,
  DROP COLUMN IF EXISTS calendar_provider,
  DROP COLUMN IF EXISTS calendar_event_id,
  DROP COLUMN IF EXISTS reminder_1h_sent,
  DROP COLUMN IF EXISTS reminder_24h_sent,
  DROP COLUMN IF EXISTS reminder_sent_at,
  DROP COLUMN IF EXISTS interviewers_confirmed,
  DROP COLUMN IF EXISTS candidate_confirmed_at,
  DROP COLUMN IF EXISTS candidate_confirmed,
  DROP COLUMN IF EXISTS client_contact_id,
  DROP COLUMN IF EXISTS organized_by_client,
  DROP COLUMN IF EXISTS organizer_id,
  DROP COLUMN IF EXISTS actual_end_at,
  DROP COLUMN IF EXISTS actual_start_at,
  DROP COLUMN IF EXISTS scheduled_end_at,
  DROP COLUMN IF EXISTS timezone,
  DROP COLUMN IF EXISTS dial_in_pin,
  DROP COLUMN IF EXISTS dial_in_number,
  DROP COLUMN IF EXISTS meeting_password,
  DROP COLUMN IF EXISTS meeting_id,
  DROP COLUMN IF EXISTS meeting_provider,
  DROP COLUMN IF EXISTS meeting_link,
  DROP COLUMN IF EXISTS location_room,
  DROP COLUMN IF EXISTS location_address,
  DROP COLUMN IF EXISTS location_type,
  DROP COLUMN IF EXISTS interview_mode,
  DROP COLUMN IF EXISTS interview_format,
  DROP COLUMN IF EXISTS interview_round,
  DROP COLUMN IF EXISTS contact_id;

-- Restore original feedback column if it was dropped
-- ALTER TABLE interviews ADD COLUMN feedback TEXT;
-- ALTER TABLE interviews ADD COLUMN rating INTEGER;
```

### Full Rollback Procedure
1. Stop application deployments
2. Verify no in-flight interview scheduling
3. Execute schema rollback SQL
4. Restore tRPC router to previous git commit
5. Restore interview scheduling UI components
6. Restore feedback collection components
7. Verify interview list and detail pages work
8. Verify scheduling flows work
9. Document incident and root cause

### Data Recovery
```sql
-- Restore original feedback data if backed up
UPDATE interviews i
SET 
  feedback = ib.feedback,
  rating = ib.rating
FROM interviews_backup_[timestamp] ib
WHERE i.id = ib.id;

-- Restore interviewer_id from participants if needed
UPDATE interviews i
SET interviewer_id = (
  SELECT user_id FROM interview_participants ip
  WHERE ip.interview_id = i.id AND ip.is_primary = true
  LIMIT 1
);
```

---

## Technical Context

### Entity Relationship After Migration

```
┌─────────────────────────────────────────────────────────────────┐
│                       INTERVIEWS                                 │
├─────────────────────────────────────────────────────────────────┤
│ contact_id ─────────────────────► contacts (the candidate)      │
│ submission_id ──────────────────► submissions                   │
│ job_id ─────────────────────────► jobs                          │
│ organizer_id ───────────────────► user_profiles                 │
│ client_contact_id ──────────────► contacts (if client org'd)    │
└─────────────────────────────────────────────────────────────────┘
         │
         │ interview_id FK
         ▼
┌───────────────────────────┐    ┌──────────────────────────┐
│ interview_participants    │    │   interview_feedback     │
│ • internal interviewers   │───►│ • criteria scores        │
│ • client interviewers     │    │ • recommendations        │
│ • candidate               │    │ • structured notes       │
│ • observers               │    │ • salary guidance        │
└───────────────────────────┘    └──────────────────────────┘
```

### Interview Flow

```
scheduled → confirmed → in_progress → completed → feedback_pending → decided
                                                                      │
                                                    ┌─────────────────┼─────────────────┐
                                                    ▼                 ▼                 ▼
                                               passed             failed           on_hold
                                                  │                                    │
                                                  ▼                                    ▼
                                          next_round_scheduled                   revisit_later
```

---

## Notes

This cleanup is **critical for hiring quality**:

1. **Structured Feedback**: Consistent evaluation across all interviews
2. **Panel Support**: Multiple interviewers with individual feedback
3. **Calendar Integration**: Seamless scheduling with reminders
4. **Client Interviewers**: Track external interviewers properly
5. **Scorecards**: Standardized criteria for fair evaluation
6. **Analytics Ready**: Aggregated data for hiring metrics
