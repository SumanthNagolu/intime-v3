# ISSUE: Enterprise Payroll Processing System

**Issue ID:** PAYROLL-01
**Created:** 2025-12-10
**Status:** Open
**Priority:** High
**Type:** New Feature
**Reporter:** Architecture Review
**Depends On:** TIMESHEETS-01 (approved timesheets), PLACEMENTS-01 (active placements), RATES-01 (pay rates), CONTACTS-01 (consultant contacts), CONTRACTS-01 (employment terms)

---

## Summary

Build a comprehensive payroll processing system that transforms approved timesheets into pay calculations, handles multiple pay types (W2, 1099, Corp-to-Corp), manages deductions, generates pay stubs, and integrates with external payroll providers. This is the bridge between timesheet approval and consultant payment.

## Location

- **New Tables**: `pay_periods`, `pay_runs`, `pay_items`, `pay_item_earnings`, `pay_item_deductions`, `consultant_tax_setup`, `consultant_benefits`, `consultant_garnishments`, `pay_stubs`, `tax_documents`
- **Related Tables**: `timesheets`, `placements`, `rate_cards`, `contacts`, `contracts`
- **Affected Modules**: Finance, HR, Compliance, Consultant Portal

## Problem Description

### Current State Issues

1. **No Payroll System**:
   - Timesheets approved but no pay calculation
   - Manual export to external payroll providers
   - No pay stub generation
   - No deduction management

2. **Missing Pay Type Handling**:
   - W2 employee payroll not supported
   - 1099 contractor payments manual
   - Corp-to-Corp (C2C) invoice processing missing

3. **No Tax/Deduction Management**:
   - Federal/state tax calculations not automated
   - Benefits deductions not tracked
   - Garnishments not supported
   - Retirement contributions not managed

4. **No Payment Tracking**:
   - Direct deposit status unknown
   - Check printing not supported
   - Payment history not available
   - Year-end tax documents not generated

### Current Flow Gap

```
Timesheets → [APPROVED] → ??? → Payment
                          ↑
                   (Manual process, no system support)
```

## Expected Behavior

After implementation:
1. Approved timesheets automatically create pay calculations
2. Pay rates pulled from RATES-01 rate cards
3. Tax calculations based on consultant location and status
4. Deductions automatically applied
5. Multiple payment methods (direct deposit, check, C2C invoice)
6. Pay stub generation and history
7. Integration with external payroll providers (ADP, Gusto, etc.)
8. Year-end tax document generation (W-2, 1099)

## Proposed Schema Design

### Pay Periods

```sql
-- Pay period definitions
CREATE TABLE pay_periods (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),

  -- Period identification
  period_number INTEGER NOT NULL,  -- Sequential within year
  period_year INTEGER NOT NULL,
  period_name VARCHAR,  -- 'Week 1', 'Jan 1-15', etc.

  -- Period type
  pay_frequency VARCHAR NOT NULL,  -- 'weekly', 'biweekly', 'semimonthly', 'monthly'

  -- Dates
  start_date DATE NOT NULL,
  end_date DATE NOT NULL,
  pay_date DATE NOT NULL,  -- When payment issued
  timesheet_deadline DATE,  -- When timesheets due

  -- Status
  status VARCHAR DEFAULT 'open',  -- 'open', 'processing', 'approved', 'paid', 'closed'

  -- Totals (denormalized for performance)
  total_regular_hours NUMERIC(10,2) DEFAULT 0,
  total_overtime_hours NUMERIC(10,2) DEFAULT 0,
  total_gross_pay NUMERIC(12,2) DEFAULT 0,
  total_deductions NUMERIC(12,2) DEFAULT 0,
  total_net_pay NUMERIC(12,2) DEFAULT 0,
  total_employer_cost NUMERIC(12,2) DEFAULT 0,

  -- Processing
  processed_at TIMESTAMPTZ,
  processed_by UUID REFERENCES user_profiles(id),
  approved_at TIMESTAMPTZ,
  approved_by UUID REFERENCES user_profiles(id),

  -- Audit
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),

  CONSTRAINT pay_period_unique UNIQUE (org_id, pay_frequency, start_date)
);

CREATE INDEX idx_pay_periods_status ON pay_periods(status) WHERE status != 'closed';
CREATE INDEX idx_pay_periods_dates ON pay_periods(start_date, end_date);
```

### Pay Runs

```sql
-- Individual pay run (batch of payments)
CREATE TABLE pay_runs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  pay_period_id UUID NOT NULL REFERENCES pay_periods(id),

  -- Run identification
  run_number INTEGER NOT NULL,  -- For multiple runs per period
  run_type VARCHAR NOT NULL,  -- 'regular', 'bonus', 'correction', 'final'
  pay_type VARCHAR NOT NULL,  -- 'w2', '1099', 'c2c'

  -- Status
  status VARCHAR DEFAULT 'draft',  -- 'draft', 'calculated', 'approved', 'submitted', 'processing', 'completed', 'failed'

  -- Counts
  total_consultants INTEGER DEFAULT 0,
  total_items INTEGER DEFAULT 0,

  -- Totals
  total_gross_pay NUMERIC(12,2) DEFAULT 0,
  total_deductions NUMERIC(12,2) DEFAULT 0,
  total_taxes NUMERIC(12,2) DEFAULT 0,
  total_net_pay NUMERIC(12,2) DEFAULT 0,
  total_employer_taxes NUMERIC(12,2) DEFAULT 0,
  total_employer_cost NUMERIC(12,2) DEFAULT 0,

  -- Processing
  calculated_at TIMESTAMPTZ,
  calculated_by UUID REFERENCES user_profiles(id),
  approved_at TIMESTAMPTZ,
  approved_by UUID REFERENCES user_profiles(id),
  submitted_at TIMESTAMPTZ,
  submitted_by UUID REFERENCES user_profiles(id),
  completed_at TIMESTAMPTZ,

  -- External provider
  external_provider VARCHAR,  -- 'adp', 'gusto', 'paychex', 'internal'
  external_batch_id VARCHAR,
  external_status VARCHAR,
  external_response JSONB,

  -- Notes
  notes TEXT,

  -- Audit
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  created_by UUID REFERENCES user_profiles(id),

  CONSTRAINT pay_run_unique UNIQUE (pay_period_id, run_number, pay_type)
);

CREATE INDEX idx_pay_runs_period ON pay_runs(pay_period_id);
CREATE INDEX idx_pay_runs_status ON pay_runs(status) WHERE status NOT IN ('completed', 'failed');
```

### Pay Items (Individual Payments)

```sql
-- Individual pay item per consultant per run
CREATE TABLE pay_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  pay_run_id UUID NOT NULL REFERENCES pay_runs(id) ON DELETE CASCADE,

  -- References
  contact_id UUID NOT NULL REFERENCES contacts(id),  -- The consultant
  placement_id UUID REFERENCES placements(id),  -- Active placement
  rate_card_id UUID REFERENCES rate_cards(id),  -- Rate applied

  -- Pay type
  pay_type VARCHAR NOT NULL,  -- 'w2', '1099', 'c2c'
  employment_type VARCHAR,  -- 'full_time', 'part_time', 'contract'

  -- Status
  status VARCHAR DEFAULT 'pending',  -- 'pending', 'calculated', 'approved', 'submitted', 'paid', 'void'

  -- Hours
  regular_hours NUMERIC(10,2) DEFAULT 0,
  overtime_hours NUMERIC(10,2) DEFAULT 0,
  double_time_hours NUMERIC(10,2) DEFAULT 0,
  pto_hours NUMERIC(10,2) DEFAULT 0,
  holiday_hours NUMERIC(10,2) DEFAULT 0,
  sick_hours NUMERIC(10,2) DEFAULT 0,
  total_hours NUMERIC(10,2) GENERATED ALWAYS AS (
    regular_hours + overtime_hours + double_time_hours + pto_hours + holiday_hours + sick_hours
  ) STORED,

  -- Rates
  regular_rate NUMERIC(10,2),
  overtime_rate NUMERIC(10,2),
  double_time_rate NUMERIC(10,2),

  -- Gross calculations
  regular_pay NUMERIC(12,2) DEFAULT 0,
  overtime_pay NUMERIC(12,2) DEFAULT 0,
  double_time_pay NUMERIC(12,2) DEFAULT 0,
  pto_pay NUMERIC(12,2) DEFAULT 0,
  holiday_pay NUMERIC(12,2) DEFAULT 0,
  bonus_pay NUMERIC(12,2) DEFAULT 0,
  commission_pay NUMERIC(12,2) DEFAULT 0,
  other_pay NUMERIC(12,2) DEFAULT 0,
  gross_pay NUMERIC(12,2) GENERATED ALWAYS AS (
    regular_pay + overtime_pay + double_time_pay + pto_pay + holiday_pay + bonus_pay + commission_pay + other_pay
  ) STORED,

  -- Deductions (employee)
  federal_tax NUMERIC(10,2) DEFAULT 0,
  state_tax NUMERIC(10,2) DEFAULT 0,
  local_tax NUMERIC(10,2) DEFAULT 0,
  social_security NUMERIC(10,2) DEFAULT 0,
  medicare NUMERIC(10,2) DEFAULT 0,
  health_insurance NUMERIC(10,2) DEFAULT 0,
  dental_insurance NUMERIC(10,2) DEFAULT 0,
  vision_insurance NUMERIC(10,2) DEFAULT 0,
  retirement_401k NUMERIC(10,2) DEFAULT 0,
  retirement_roth NUMERIC(10,2) DEFAULT 0,
  hsa_contribution NUMERIC(10,2) DEFAULT 0,
  fsa_contribution NUMERIC(10,2) DEFAULT 0,
  garnishment NUMERIC(10,2) DEFAULT 0,
  other_deductions NUMERIC(10,2) DEFAULT 0,
  total_deductions NUMERIC(12,2) GENERATED ALWAYS AS (
    federal_tax + state_tax + local_tax + social_security + medicare +
    health_insurance + dental_insurance + vision_insurance +
    retirement_401k + retirement_roth + hsa_contribution + fsa_contribution +
    garnishment + other_deductions
  ) STORED,

  -- Net pay
  net_pay NUMERIC(12,2) GENERATED ALWAYS AS (
    (regular_pay + overtime_pay + double_time_pay + pto_pay + holiday_pay + bonus_pay + commission_pay + other_pay) -
    (federal_tax + state_tax + local_tax + social_security + medicare +
     health_insurance + dental_insurance + vision_insurance +
     retirement_401k + retirement_roth + hsa_contribution + fsa_contribution +
     garnishment + other_deductions)
  ) STORED,

  -- Employer costs
  employer_social_security NUMERIC(10,2) DEFAULT 0,
  employer_medicare NUMERIC(10,2) DEFAULT 0,
  employer_futa NUMERIC(10,2) DEFAULT 0,
  employer_suta NUMERIC(10,2) DEFAULT 0,
  employer_health NUMERIC(10,2) DEFAULT 0,
  employer_retirement_match NUMERIC(10,2) DEFAULT 0,
  employer_other NUMERIC(10,2) DEFAULT 0,
  total_employer_cost NUMERIC(12,2) GENERATED ALWAYS AS (
    employer_social_security + employer_medicare + employer_futa + employer_suta +
    employer_health + employer_retirement_match + employer_other
  ) STORED,

  -- YTD tracking (for tax calculations)
  ytd_gross NUMERIC(12,2) DEFAULT 0,
  ytd_federal_tax NUMERIC(12,2) DEFAULT 0,
  ytd_social_security NUMERIC(12,2) DEFAULT 0,
  ytd_medicare NUMERIC(12,2) DEFAULT 0,

  -- Payment method
  payment_method VARCHAR DEFAULT 'direct_deposit',  -- 'direct_deposit', 'check', 'invoice'
  bank_account_id UUID,  -- Reference to consultant's bank account
  check_number VARCHAR,

  -- Payment tracking
  paid_at TIMESTAMPTZ,
  payment_reference VARCHAR,

  -- C2C specific
  invoice_id UUID,  -- Reference to generated invoice for C2C

  -- Source timesheets
  timesheet_ids UUID[],

  -- Notes
  notes TEXT,

  -- Audit
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),

  CONSTRAINT pay_item_unique UNIQUE (pay_run_id, contact_id)
);

CREATE INDEX idx_pay_items_run ON pay_items(pay_run_id);
CREATE INDEX idx_pay_items_contact ON pay_items(contact_id);
CREATE INDEX idx_pay_items_placement ON pay_items(placement_id);
CREATE INDEX idx_pay_items_status ON pay_items(status) WHERE status NOT IN ('paid', 'void');
```

### Pay Item Earnings (Breakdown)

```sql
-- Detailed earnings breakdown per pay item
CREATE TABLE pay_item_earnings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  pay_item_id UUID NOT NULL REFERENCES pay_items(id) ON DELETE CASCADE,

  -- Earning type
  earning_type VARCHAR NOT NULL,  -- 'regular', 'overtime', 'double_time', 'pto', 'holiday', 'sick', 'bonus', 'commission', 'reimbursement'
  earning_code VARCHAR,  -- Custom earning code
  description VARCHAR,

  -- Source
  timesheet_id UUID REFERENCES timesheets(id),
  timesheet_entry_id UUID,

  -- Calculation
  hours NUMERIC(10,2),
  rate NUMERIC(10,2),
  amount NUMERIC(12,2) NOT NULL,
  multiplier NUMERIC(4,2) DEFAULT 1.0,  -- 1.0 regular, 1.5 OT, 2.0 DT

  -- Date range
  work_date DATE,
  work_week_start DATE,

  -- Audit
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE INDEX idx_pay_item_earnings_item ON pay_item_earnings(pay_item_id);
CREATE INDEX idx_pay_item_earnings_timesheet ON pay_item_earnings(timesheet_id);
```

### Pay Item Deductions (Breakdown)

```sql
-- Detailed deductions breakdown per pay item
CREATE TABLE pay_item_deductions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  pay_item_id UUID NOT NULL REFERENCES pay_items(id) ON DELETE CASCADE,

  -- Deduction type
  deduction_type VARCHAR NOT NULL,  -- 'tax', 'insurance', 'retirement', 'garnishment', 'other'
  deduction_category VARCHAR NOT NULL,  -- 'federal_tax', 'state_tax', 'health', '401k', etc.
  deduction_code VARCHAR,
  description VARCHAR,

  -- Who pays
  paid_by VARCHAR NOT NULL,  -- 'employee', 'employer'

  -- Calculation
  calculation_type VARCHAR,  -- 'flat', 'percentage', 'tiered'
  calculation_basis VARCHAR,  -- 'gross', 'net', 'hours'
  rate NUMERIC(10,4),  -- Percentage rate if applicable
  amount NUMERIC(12,2) NOT NULL,

  -- Pre/post tax
  is_pre_tax BOOLEAN DEFAULT false,

  -- YTD
  ytd_amount NUMERIC(12,2),

  -- Limits
  annual_limit NUMERIC(12,2),
  ytd_toward_limit NUMERIC(12,2),

  -- Audit
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE INDEX idx_pay_item_deductions_item ON pay_item_deductions(pay_item_id);
CREATE INDEX idx_pay_item_deductions_type ON pay_item_deductions(deduction_type);
```

### Consultant Tax Setup

```sql
-- Tax configuration per consultant
CREATE TABLE consultant_tax_setup (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  contact_id UUID NOT NULL REFERENCES contacts(id),

  -- Federal
  federal_filing_status VARCHAR,  -- 'single', 'married', 'married_separate', 'head_of_household'
  federal_allowances INTEGER DEFAULT 0,
  additional_federal_withholding NUMERIC(10,2) DEFAULT 0,
  federal_exempt BOOLEAN DEFAULT false,

  -- State
  work_state VARCHAR(2),
  residence_state VARCHAR(2),
  state_filing_status VARCHAR,
  state_allowances INTEGER DEFAULT 0,
  additional_state_withholding NUMERIC(10,2) DEFAULT 0,
  state_exempt BOOLEAN DEFAULT false,

  -- Local
  local_tax_jurisdiction VARCHAR,
  local_tax_rate NUMERIC(6,4),

  -- Social Security
  ss_exempt BOOLEAN DEFAULT false,

  -- Medicare
  medicare_exempt BOOLEAN DEFAULT false,

  -- W-4 info
  w4_form_date DATE,
  w4_version VARCHAR,  -- '2020' for new form
  w4_step_2_checkbox BOOLEAN DEFAULT false,
  w4_step_3_dependents NUMERIC(10,2) DEFAULT 0,
  w4_step_4a_other_income NUMERIC(10,2) DEFAULT 0,
  w4_step_4b_deductions NUMERIC(10,2) DEFAULT 0,
  w4_step_4c_extra_withholding NUMERIC(10,2) DEFAULT 0,

  -- Effective dates
  effective_date DATE NOT NULL,
  end_date DATE,

  -- Audit
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),

  CONSTRAINT consultant_tax_unique UNIQUE (contact_id, effective_date)
);

CREATE INDEX idx_consultant_tax_contact ON consultant_tax_setup(contact_id);
```

### Consultant Benefits

```sql
-- Benefits enrollment per consultant
CREATE TABLE consultant_benefits (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  contact_id UUID NOT NULL REFERENCES contacts(id),

  -- Benefit plan
  benefit_type VARCHAR NOT NULL,  -- 'health', 'dental', 'vision', 'life', '401k', 'hsa', 'fsa'
  plan_id UUID,  -- Reference to benefit_plans if using catalog
  plan_name VARCHAR NOT NULL,
  plan_tier VARCHAR,  -- 'employee_only', 'employee_spouse', 'family'

  -- Contribution
  employee_contribution NUMERIC(10,2) DEFAULT 0,
  employer_contribution NUMERIC(10,2) DEFAULT 0,
  contribution_frequency VARCHAR DEFAULT 'per_pay_period',  -- 'per_pay_period', 'monthly', 'annual'

  -- Deduction
  is_pre_tax BOOLEAN DEFAULT true,
  deduction_type VARCHAR DEFAULT 'percentage',  -- 'flat', 'percentage'
  deduction_value NUMERIC(10,4),

  -- Limits
  annual_limit NUMERIC(12,2),
  employer_match_limit NUMERIC(12,2),
  employer_match_percentage NUMERIC(5,2),

  -- Effective dates
  effective_date DATE NOT NULL,
  end_date DATE,
  enrollment_date DATE,

  -- Status
  status VARCHAR DEFAULT 'active',  -- 'pending', 'active', 'terminated', 'waived'

  -- Audit
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

CREATE INDEX idx_consultant_benefits_contact ON consultant_benefits(contact_id);
CREATE INDEX idx_consultant_benefits_type ON consultant_benefits(benefit_type, status);
```

### Garnishments

```sql
-- Wage garnishments per consultant
CREATE TABLE consultant_garnishments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  contact_id UUID NOT NULL REFERENCES contacts(id),

  -- Garnishment type
  garnishment_type VARCHAR NOT NULL,  -- 'child_support', 'tax_levy', 'creditor', 'student_loan', 'bankruptcy'

  -- Court/Order info
  case_number VARCHAR,
  court_name VARCHAR,
  order_date DATE,
  received_date DATE,

  -- Payee
  payee_name VARCHAR NOT NULL,
  payee_address TEXT,
  payee_account VARCHAR,

  -- Calculation
  calculation_type VARCHAR NOT NULL,  -- 'flat', 'percentage', 'percentage_with_cap'
  amount_or_percentage NUMERIC(10,4) NOT NULL,
  maximum_per_pay_period NUMERIC(10,2),
  total_owed NUMERIC(12,2),
  total_paid NUMERIC(12,2) DEFAULT 0,

  -- Priority (for multiple garnishments)
  priority INTEGER DEFAULT 1,

  -- Limits
  disposable_income_limit NUMERIC(5,2),  -- Max % of disposable income

  -- Effective dates
  effective_date DATE NOT NULL,
  end_date DATE,

  -- Status
  status VARCHAR DEFAULT 'active',  -- 'active', 'satisfied', 'suspended', 'terminated'

  -- Audit
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

CREATE INDEX idx_consultant_garnishments_contact ON consultant_garnishments(contact_id);
CREATE INDEX idx_consultant_garnishments_status ON consultant_garnishments(status) WHERE status = 'active';
```

### Pay Stubs

```sql
-- Generated pay stubs
CREATE TABLE pay_stubs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  pay_item_id UUID NOT NULL REFERENCES pay_items(id),
  contact_id UUID NOT NULL REFERENCES contacts(id),

  -- Period
  pay_period_start DATE NOT NULL,
  pay_period_end DATE NOT NULL,
  pay_date DATE NOT NULL,

  -- Document
  stub_number VARCHAR UNIQUE,
  document_url VARCHAR,  -- S3/storage URL for PDF

  -- Summary (denormalized for quick access)
  gross_pay NUMERIC(12,2),
  total_deductions NUMERIC(12,2),
  net_pay NUMERIC(12,2),

  -- YTD Summary
  ytd_gross NUMERIC(12,2),
  ytd_deductions NUMERIC(12,2),
  ytd_net NUMERIC(12,2),

  -- Generated
  generated_at TIMESTAMPTZ DEFAULT now(),

  -- Viewed
  first_viewed_at TIMESTAMPTZ,
  view_count INTEGER DEFAULT 0
);

CREATE INDEX idx_pay_stubs_contact ON pay_stubs(contact_id, pay_date DESC);
CREATE INDEX idx_pay_stubs_pay_item ON pay_stubs(pay_item_id);
```

### Tax Documents

```sql
-- Year-end tax documents (W-2, 1099)
CREATE TABLE tax_documents (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  contact_id UUID NOT NULL REFERENCES contacts(id),

  -- Document type
  document_type VARCHAR NOT NULL,  -- 'w2', '1099_nec', '1099_misc'
  tax_year INTEGER NOT NULL,

  -- Document details
  document_number VARCHAR,
  document_url VARCHAR,

  -- Status
  status VARCHAR DEFAULT 'draft',  -- 'draft', 'review', 'final', 'filed', 'corrected'

  -- Key amounts (varies by type)
  box_data JSONB,  -- All box values for the form

  -- Filing
  filed_at TIMESTAMPTZ,
  filed_by UUID REFERENCES user_profiles(id),

  -- Delivery
  delivery_method VARCHAR,  -- 'mail', 'electronic', 'both'
  delivered_at TIMESTAMPTZ,
  consent_for_electronic BOOLEAN DEFAULT false,

  -- Corrections
  is_corrected BOOLEAN DEFAULT false,
  original_document_id UUID REFERENCES tax_documents(id),
  correction_reason TEXT,

  -- Audit
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

CREATE INDEX idx_tax_documents_contact ON tax_documents(contact_id, tax_year DESC);
CREATE INDEX idx_tax_documents_year ON tax_documents(tax_year, document_type);
```

## Integration with Other Systems

### TIMESHEETS-01 Integration

```sql
-- Timesheets become pay items
-- When timesheet status = 'approved', eligible for payroll

-- Get approved timesheets for pay period
SELECT t.*
FROM timesheets t
WHERE t.org_id = $org_id
  AND t.status = 'approved'
  AND t.week_ending >= $period_start
  AND t.week_ending <= $period_end
  AND NOT EXISTS (
    SELECT 1 FROM pay_item_earnings pie
    JOIN pay_items pi ON pi.id = pie.pay_item_id
    JOIN pay_runs pr ON pr.id = pi.pay_run_id
    WHERE pie.timesheet_id = t.id
    AND pr.status NOT IN ('void', 'failed')
  );
```

### RATES-01 Integration

```sql
-- Get pay rate from rate card
SELECT rc.pay_rate, rc.overtime_rate, rc.double_time_rate
FROM rate_cards rc
WHERE rc.placement_id = $placement_id
  AND rc.effective_date <= $pay_date
  AND (rc.end_date IS NULL OR rc.end_date >= $pay_date)
ORDER BY rc.effective_date DESC
LIMIT 1;
```

### INVOICES-01 Integration

```sql
-- For C2C payments, create invoice instead of direct payment
-- Pay item links to invoice for payment tracking
UPDATE pay_items
SET invoice_id = $invoice_id,
    payment_method = 'invoice'
WHERE id = $pay_item_id
  AND pay_type = 'c2c';
```

## Payroll Processing Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                    PAYROLL PROCESSING FLOW                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  [Pay Period Opens] ──► [Timesheets Submitted] ──► [Approved]   │
│                                                                  │
│  [Create Pay Run] ──► [Import Approved Timesheets]              │
│                              │                                   │
│                              ▼                                   │
│                    [Calculate Gross Pay]                         │
│                    (Hours × Rates from RATES-01)                │
│                              │                                   │
│                              ▼                                   │
│                    [Calculate Deductions]                        │
│                    (Taxes, Benefits, Garnishments)              │
│                              │                                   │
│                              ▼                                   │
│                    [Review & Approve]                            │
│                              │                                   │
│            ┌─────────────────┼─────────────────┐                │
│            ▼                 ▼                 ▼                 │
│       [W2 Payroll]    [1099 Payment]    [C2C Invoice]          │
│            │                 │                 │                 │
│            ▼                 ▼                 ▼                 │
│       [ADP/Gusto]    [Payment Issued]  [Invoice Created]       │
│            │                 │                 │                 │
│            └─────────────────┴─────────────────┘                │
│                              │                                   │
│                              ▼                                   │
│                    [Generate Pay Stubs]                          │
│                              │                                   │
│                              ▼                                   │
│                    [Pay Period Closed]                           │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## Acceptance Criteria

### Schema Implementation
- [ ] pay_periods table created
- [ ] pay_runs table created
- [ ] pay_items table with all calculation fields
- [ ] pay_item_earnings breakdown table
- [ ] pay_item_deductions breakdown table
- [ ] consultant_tax_setup table
- [ ] consultant_benefits table
- [ ] consultant_garnishments table
- [ ] pay_stubs table
- [ ] tax_documents table
- [ ] All indexes created
- [ ] RLS policies implemented

### Payroll Processing
- [ ] Pay period management (open/close)
- [ ] Pay run creation by pay type
- [ ] Timesheet import from approved timesheets
- [ ] Gross pay calculation from hours + rates
- [ ] Tax calculation based on consultant setup
- [ ] Benefits deduction application
- [ ] Garnishment calculation with limits
- [ ] Net pay calculation verified
- [ ] Employer cost calculation

### Integrations
- [ ] TIMESHEETS-01: Approved timesheets populate pay items
- [ ] RATES-01: Rate cards used for pay calculations
- [ ] PLACEMENTS-01: Active placement required for payroll
- [ ] INVOICES-01: C2C payments create invoices
- [ ] External payroll API (ADP/Gusto) submission

### Reporting
- [ ] Pay run summary report
- [ ] Payroll register
- [ ] Tax liability report
- [ ] Benefits deduction report
- [ ] YTD earnings report

### Consultant Portal
- [ ] Pay stubs accessible
- [ ] YTD summary visible
- [ ] Tax documents downloadable
- [ ] Direct deposit setup

### Compliance
- [ ] Federal tax tables current
- [ ] State tax tables for all supported states
- [ ] FICA limits enforced
- [ ] Garnishment priority rules followed
- [ ] W-2/1099 generation for year-end

---

## Technical Context

### Pay Period Status State Machine (Added per Architecture Review)

```
Pay Period Status Flow:
┌─────────────────────────────────────────────────────┐
│                                                     │
│  [upcoming] ──► [active] ──► [processing]           │
│                     │              │                │
│                     │              ▼                │
│                     │        [completed]            │
│                     │              │                │
│                     ▼              ▼                │
│              [correction] ──► [completed]           │
│                                    │                │
│                                    ▼                │
│                               [voided]              │
│                            (terminal state)         │
│                                                     │
└─────────────────────────────────────────────────────┘

Status Definitions:
- upcoming: Pay period is in the future, not yet active
- active: Current pay period accepting timesheets
- processing: Timesheets submitted, payroll being calculated
- completed: Payroll processed and paid
- correction: Adjustments being made to completed period
- voided: Period cancelled (requires supervisor approval)

Transition Rules:
- upcoming → active: Automatic on period start_date
- active → processing: Manual trigger after timesheet deadline
- processing → completed: All pay runs completed successfully
- completed → correction: Manual trigger for adjustments
- correction → completed: Correction processed
- Any state → voided: Requires supervisor approval + audit trail
```

### Pay Type Differences

| Aspect | W-2 Employee | 1099 Contractor | Corp-to-Corp |
|--------|--------------|-----------------|--------------|
| Tax Withholding | Yes (FICA, Federal, State) | None | None |
| Benefits | Eligible | Not Eligible | Not Eligible |
| Overtime | Required | Contract-based | Contract-based |
| Payment | Direct Deposit/Check | Check/ACH | Invoice |
| Year-End Doc | W-2 | 1099-NEC | None (1099 to Corp) |
| Employer Taxes | FICA match, FUTA, SUTA | None | None |

### Tax Calculation Approach

```
Gross Pay
├── Regular Hours × Regular Rate
├── Overtime Hours × OT Rate (1.5x)
├── Double Time Hours × DT Rate (2x)
├── PTO/Holiday Hours × Regular Rate
├── Bonuses
└── Other Earnings

Employee Deductions (Pre-Tax)
├── Health Insurance
├── Dental/Vision
├── 401(k) Traditional
├── HSA/FSA
└── Transit Benefits

Taxable Income = Gross - Pre-Tax Deductions

Taxes
├── Federal Income Tax (W-4 based)
├── State Income Tax (state W-4 based)
├── Local Tax (if applicable)
├── Social Security (6.2% up to wage base)
└── Medicare (1.45% + 0.9% additional above threshold)

Employee Deductions (Post-Tax)
├── Roth 401(k)
├── Garnishments
├── After-tax Insurance
└── Other

Net Pay = Taxable Income - Taxes - Post-Tax Deductions
```

### External Provider Integration Points

```
ADP/Gusto/Paychex Integration:
├── Employee Sync (demographics, tax setup)
├── Pay Run Submission (hours, earnings, deductions)
├── Pay Run Status Polling
├── Pay Stub Retrieval
├── Tax Document Retrieval
└── Direct Deposit Management
```

---

## Notes

Payroll is **critical financial infrastructure**:

1. **Accuracy**: Pay errors destroy consultant trust
2. **Compliance**: Tax mistakes have legal consequences
3. **Timeliness**: Late payments cause hardship
4. **Auditability**: Every calculation must be traceable
5. **Security**: Financial data requires highest protection

Key dependencies must be solid before payroll:
- TIMESHEETS-01: Source of hours (must be accurate)
- RATES-01: Source of pay rates (must be versioned)
- PLACEMENTS-01: Active assignments (must be current)
- CONTACTS-01: Consultant records (must be complete)
- CONTRACTS-01: Employment terms (must be valid)

---

## RLS Policies

```sql
-- pay_periods table RLS
ALTER TABLE pay_periods ENABLE ROW LEVEL SECURITY;

CREATE POLICY "pay_periods_org_isolation" ON pay_periods
  FOR ALL USING (org_id = auth.org_id());

-- pay_runs table RLS
ALTER TABLE pay_runs ENABLE ROW LEVEL SECURITY;

CREATE POLICY "pay_runs_org_isolation" ON pay_runs
  FOR ALL USING (org_id = auth.org_id());

-- pay_items table RLS
ALTER TABLE pay_items ENABLE ROW LEVEL SECURITY;

CREATE POLICY "pay_items_org_isolation" ON pay_items
  FOR ALL USING (org_id = auth.org_id());

-- pay_item_earnings table RLS
ALTER TABLE pay_item_earnings ENABLE ROW LEVEL SECURITY;

CREATE POLICY "pay_item_earnings_org_isolation" ON pay_item_earnings
  FOR ALL USING (org_id = auth.org_id());

-- pay_item_deductions table RLS
ALTER TABLE pay_item_deductions ENABLE ROW LEVEL SECURITY;

CREATE POLICY "pay_item_deductions_org_isolation" ON pay_item_deductions
  FOR ALL USING (org_id = auth.org_id());

-- consultant_tax_setup table RLS
ALTER TABLE consultant_tax_setup ENABLE ROW LEVEL SECURITY;

CREATE POLICY "consultant_tax_setup_org_isolation" ON consultant_tax_setup
  FOR ALL USING (org_id = auth.org_id());

-- consultant_benefits table RLS
ALTER TABLE consultant_benefits ENABLE ROW LEVEL SECURITY;

CREATE POLICY "consultant_benefits_org_isolation" ON consultant_benefits
  FOR ALL USING (org_id = auth.org_id());

-- consultant_garnishments table RLS
ALTER TABLE consultant_garnishments ENABLE ROW LEVEL SECURITY;

CREATE POLICY "consultant_garnishments_org_isolation" ON consultant_garnishments
  FOR ALL USING (org_id = auth.org_id());

-- pay_stubs table RLS
ALTER TABLE pay_stubs ENABLE ROW LEVEL SECURITY;

CREATE POLICY "pay_stubs_org_isolation" ON pay_stubs
  FOR ALL USING (org_id = auth.org_id());

-- Consultants can view their own pay stubs
CREATE POLICY "pay_stubs_consultant_own" ON pay_stubs
  FOR SELECT USING (
    contact_id IN (
      SELECT id FROM contacts WHERE user_id = auth.uid()
    )
  );

-- tax_documents table RLS
ALTER TABLE tax_documents ENABLE ROW LEVEL SECURITY;

CREATE POLICY "tax_documents_org_isolation" ON tax_documents
  FOR ALL USING (org_id = auth.org_id());

-- Consultants can view their own tax documents
CREATE POLICY "tax_documents_consultant_own" ON tax_documents
  FOR SELECT USING (
    contact_id IN (
      SELECT id FROM contacts WHERE user_id = auth.uid()
    )
  );
```

---

## Migration Template

### Phase 1: Schema Creation

```sql
-- Create tables in order of dependencies
CREATE TABLE pay_periods (...);
CREATE TABLE pay_runs (...);
CREATE TABLE pay_items (...);
CREATE TABLE pay_item_earnings (...);
CREATE TABLE pay_item_deductions (...);
CREATE TABLE consultant_tax_setup (...);
CREATE TABLE consultant_benefits (...);
CREATE TABLE consultant_garnishments (...);
CREATE TABLE pay_stubs (...);
CREATE TABLE tax_documents (...);

-- Create all indexes
CREATE INDEX idx_pay_periods_status ON pay_periods(status) WHERE status != 'closed';
-- ... all other indexes

-- Enable RLS
ALTER TABLE pay_periods ENABLE ROW LEVEL SECURITY;
-- ... all policies
```

### Phase 2: Seed Tax Tables

```sql
-- Federal tax brackets (2024)
-- Note: These would typically come from a tax data provider
-- or be maintained as configuration tables

-- Seed standard benefit plan templates
INSERT INTO benefit_plan_templates (name, benefit_type, default_employee_contribution, default_employer_contribution)
VALUES
  ('Standard Health', 'health', 200.00, 400.00),
  ('Basic Dental', 'dental', 25.00, 25.00),
  ('401k 4% Match', '401k', 0, 0);  -- Percentage-based
```

### Phase 3: tRPC Router Creation

```typescript
// src/server/routers/payroll.ts
export const payrollRouter = router({
  // Pay Periods
  createPayPeriod: orgProtectedProcedure.input(...).mutation(...),
  listPayPeriods: orgProtectedProcedure.query(...),
  closePayPeriod: orgProtectedProcedure.input(...).mutation(...),
  
  // Pay Runs
  createPayRun: orgProtectedProcedure.input(...).mutation(...),
  calculatePayRun: orgProtectedProcedure.input(...).mutation(...),
  approvePayRun: orgProtectedProcedure.input(...).mutation(...),
  submitPayRun: orgProtectedProcedure.input(...).mutation(...),
  
  // Pay Items
  getPayItem: orgProtectedProcedure.input(...).query(...),
  adjustPayItem: orgProtectedProcedure.input(...).mutation(...),
  
  // Consultant Setup
  getTaxSetup: orgProtectedProcedure.input(...).query(...),
  updateTaxSetup: orgProtectedProcedure.input(...).mutation(...),
  getBenefits: orgProtectedProcedure.input(...).query(...),
  enrollBenefit: orgProtectedProcedure.input(...).mutation(...),
  
  // Pay Stubs (consultant portal)
  getMyPayStubs: orgProtectedProcedure.query(...),
  getPayStub: orgProtectedProcedure.input(...).query(...),
  
  // Tax Documents
  getTaxDocuments: orgProtectedProcedure.query(...),
  generateW2: orgProtectedProcedure.input(...).mutation(...),
  generate1099: orgProtectedProcedure.input(...).mutation(...),
});
```

---

## Rollback Plan

### Schema Rollback
```sql
-- Drop tables in reverse order
DROP TABLE IF EXISTS tax_documents;
DROP TABLE IF EXISTS pay_stubs;
DROP TABLE IF EXISTS consultant_garnishments;
DROP TABLE IF EXISTS consultant_benefits;
DROP TABLE IF EXISTS consultant_tax_setup;
DROP TABLE IF EXISTS pay_item_deductions;
DROP TABLE IF EXISTS pay_item_earnings;
DROP TABLE IF EXISTS pay_items;
DROP TABLE IF EXISTS pay_runs;
DROP TABLE IF EXISTS pay_periods;
```

### Full Rollback Procedure
1. **CRITICAL**: Ensure no pay runs are in 'processing' or 'submitted' status
2. Export all pay run data for external processing
3. Stop application deployments
4. Execute schema rollback SQL
5. Restore tRPC router to previous git commit
6. Restore UI components to previous git commit
7. Notify finance team of manual payroll processing required
8. Document incident and root cause

### Data Preservation (CRITICAL)
```sql
-- Before rollback, export ALL payroll data
-- This is financial data and must be preserved

COPY (
  SELECT * FROM pay_periods
) TO '/tmp/pay_periods_backup.csv' WITH CSV HEADER;

COPY (
  SELECT * FROM pay_runs
) TO '/tmp/pay_runs_backup.csv' WITH CSV HEADER;

COPY (
  SELECT * FROM pay_items
) TO '/tmp/pay_items_backup.csv' WITH CSV HEADER;

COPY (
  SELECT * FROM pay_item_earnings
) TO '/tmp/pay_item_earnings_backup.csv' WITH CSV HEADER;

COPY (
  SELECT * FROM pay_item_deductions
) TO '/tmp/pay_item_deductions_backup.csv' WITH CSV HEADER;

-- Export in JSON format as well for flexibility
COPY (
  SELECT json_agg(pi) FROM pay_items pi
) TO '/tmp/pay_items_backup.json';
```

### Emergency Payroll Continuity
If rollback occurs during active payroll:
1. Export approved timesheets to Excel
2. Calculate pay manually or with external tool
3. Process through external payroll provider directly
4. Reconcile after system restoration
