# ISSUE: Migrate Placements to Unified System

**Issue ID:** PLACEMENTS-01
**Created:** 2025-12-11
**Status:** Open
**Priority:** Critical
**Type:** Migration/Integration
**Reporter:** System (Architecture Review)
**Depends On:** CONTACTS-01 (unified contacts), ACCOUNTS-02 (unified companies), JOBS-01, SUBMISSIONS-01, RATES-01 (entity_rates)

---

## Summary

Migrate the `placements` table to use the unified `contacts`, `companies`, and `entity_rates` systems. Currently, placements have duplicate references (candidate_id AND consultant_id), inline rates instead of versioned rate tracking, and legacy account references. This migration creates a clean, unified placement model critical for staffing operations.

## Location

- **Current Table**: `placements` (references legacy entities, has inline rates)
- **Target**: `placements` with unified FKs and external rate references
- **Related Tables**: `placement_rates`, `placement_history`, `placement_extensions`, `placement_timesheets`
- **Affected Modules**: ATS, Bench Sales, Billing, HR

## Problem Description

### Current State Issues

1. **Duplicate Person References**:
   - `placements.candidate_id` references candidates
   - `placements.consultant_id` references bench_consultants
   - Same person tracked twice in different contexts

2. **Legacy Account Reference**:
   - `placements.account_id` references legacy `accounts`
   - No distinction between billing client and work site

3. **Inline Rates**:
   - `bill_rate`, `pay_rate`, `margin` stored inline
   - No version tracking for rate changes
   - No link to rate cards

4. **Vendor Tracking Incomplete**:
   - C2C placements don't clearly track vendor relationship
   - Vendor bill rate vs. our bill rate not separated

5. **Status History Fragmented**:
   - `placement_history` separate from unified `entity_history`

### Placements Table Current Structure (Key Fields)

```sql
-- Current placements table (simplified)
placements:
  id, org_id
  job_id  -- FK to jobs
  submission_id  -- FK to submissions
  candidate_id  -- Legacy FK to candidates
  consultant_id  -- Legacy FK to bench_consultants (duplicate!)
  account_id  -- Legacy FK to accounts
  status  -- pending, active, ending, completed, terminated
  start_date, end_date
  bill_rate, pay_rate, margin  -- Inline rates
  placement_type  -- contract, perm, c2h
  created_at, updated_at, deleted_at
```

## Expected Behavior

After migration:
1. Single `placements.contact_id` references unified `contacts` (the placed person)
2. `placements.client_company_id` references unified `companies`
3. `placements.work_site_company_id` for where work is performed
4. `placements.vendor_company_id` for C2C/subcontractor placements
5. Rates tracked via `entity_rates` with version history
6. Status history in `entity_history`

## Proposed Schema Changes

### Placements Table Updates

```sql
-- Updated placements table
ALTER TABLE placements
  -- Consolidate person references
  ADD COLUMN contact_id UUID REFERENCES contacts(id),
  
  -- Company references
  RENAME COLUMN account_id TO client_company_id,
  ADD COLUMN work_site_company_id UUID REFERENCES companies(id),
  ADD COLUMN vendor_company_id UUID REFERENCES companies(id),  -- For C2C
  ADD COLUMN msp_company_id UUID REFERENCES companies(id),  -- If through MSP
  
  -- Vendor details (for C2C/subcontractor)
  ADD COLUMN is_subcontracted BOOLEAN DEFAULT false,
  ADD COLUMN vendor_bill_rate NUMERIC(10,2),  -- What vendor bills us
  ADD COLUMN vendor_pay_rate NUMERIC(10,2),  -- What we pay vendor
  ADD COLUMN vendor_markup NUMERIC(5,2),
  ADD COLUMN vendor_contract_id UUID REFERENCES contracts(id),
  
  -- Rate card linkage
  ADD COLUMN rate_card_id UUID REFERENCES rate_cards(id),
  ADD COLUMN rate_card_item_id UUID REFERENCES rate_card_items(id),
  
  -- Current rates (denormalized for quick access, source of truth in entity_rates)
  ADD COLUMN current_bill_rate NUMERIC(10,2),
  ADD COLUMN current_pay_rate NUMERIC(10,2),
  ADD COLUMN current_margin NUMERIC(10,2),
  ADD COLUMN current_margin_percentage NUMERIC(5,2),
  ADD COLUMN rates_last_updated_at TIMESTAMPTZ,
  
  -- Overtime/Double-time rates
  ADD COLUMN ot_bill_rate NUMERIC(10,2),
  ADD COLUMN ot_pay_rate NUMERIC(10,2),
  ADD COLUMN dt_bill_rate NUMERIC(10,2),
  ADD COLUMN dt_pay_rate NUMERIC(10,2),
  
  -- Assignment details
  ADD COLUMN work_schedule VARCHAR,  -- 'full_time', 'part_time', 'flexible'
  ADD COLUMN hours_per_week INTEGER DEFAULT 40,
  ADD COLUMN is_remote BOOLEAN DEFAULT false,
  ADD COLUMN remote_percentage INTEGER,  -- 0-100
  
  -- Contract details
  ADD COLUMN original_end_date DATE,  -- Before extensions
  ADD COLUMN extension_count INTEGER DEFAULT 0,
  ADD COLUMN contract_document_id UUID REFERENCES documents(id),
  
  -- Compliance
  ADD COLUMN compliance_status VARCHAR DEFAULT 'pending',
  ADD COLUMN compliance_cleared_at TIMESTAMPTZ,
  ADD COLUMN background_check_status VARCHAR,
  ADD COLUMN drug_test_status VARCHAR,
  
  -- Financial tracking
  ADD COLUMN total_billed NUMERIC(15,2) DEFAULT 0,
  ADD COLUMN total_paid NUMERIC(15,2) DEFAULT 0,
  ADD COLUMN total_hours_worked NUMERIC(10,2) DEFAULT 0,
  
  -- Termination tracking
  ADD COLUMN termination_type VARCHAR,  -- 'completed', 'client_terminated', 'consultant_resigned', 'converted'
  ADD COLUMN termination_reason TEXT,
  ADD COLUMN termination_notice_date DATE,
  ADD COLUMN last_day_worked DATE,
  ADD COLUMN eligible_for_rehire BOOLEAN,

  -- Onboarding linkage (Added per Architecture Review)
  ADD COLUMN current_onboarding_id UUID REFERENCES onboardings(id);

-- Populate contact_id from candidate_id or consultant_id
-- (Will be done in migration script)

-- Update FK constraint
ALTER TABLE placements
  DROP CONSTRAINT IF EXISTS placements_account_id_fkey,
  ADD CONSTRAINT placements_client_company_id_fkey 
    FOREIGN KEY (client_company_id) REFERENCES companies(id);

-- Indexes
CREATE INDEX idx_placements_contact ON placements(contact_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_placements_client ON placements(client_company_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_placements_work_site ON placements(work_site_company_id) WHERE work_site_company_id IS NOT NULL;
CREATE INDEX idx_placements_vendor ON placements(vendor_company_id) WHERE vendor_company_id IS NOT NULL;
CREATE INDEX idx_placements_status ON placements(status, start_date) WHERE deleted_at IS NULL;
CREATE INDEX idx_placements_dates ON placements(start_date, end_date) WHERE deleted_at IS NULL;
CREATE INDEX idx_placements_active ON placements(client_company_id) WHERE status = 'active' AND deleted_at IS NULL;
```

### Placement Extensions Table

```sql
-- Track placement extensions separately
CREATE TABLE placement_extensions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  placement_id UUID NOT NULL REFERENCES placements(id) ON DELETE CASCADE,
  
  -- Extension details
  extension_number INTEGER NOT NULL,
  previous_end_date DATE NOT NULL,
  new_end_date DATE NOT NULL,
  
  -- Rate changes with extension
  new_bill_rate NUMERIC(10,2),
  new_pay_rate NUMERIC(10,2),
  rate_change_reason TEXT,
  
  -- Approval
  approved_by UUID REFERENCES user_profiles(id),
  approved_at TIMESTAMPTZ,
  client_approval_contact_id UUID REFERENCES contacts(id),
  
  -- Documents
  extension_document_id UUID REFERENCES documents(id),
  
  -- Audit
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  created_by UUID REFERENCES user_profiles(id),
  
  CONSTRAINT extension_number_unique UNIQUE (placement_id, extension_number)
);

CREATE INDEX idx_placement_extensions ON placement_extensions(placement_id);
```

### Placement Change Orders Table (Added per Architecture Review)

```sql
-- Track all changes to placements (rates, extensions, conversions, locations)
CREATE TABLE placement_change_orders (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  placement_id UUID NOT NULL REFERENCES placements(id) ON DELETE CASCADE,
  
  -- Change Order identity
  change_order_number VARCHAR GENERATED ALWAYS AS (
    'PCO-' || TO_CHAR(created_at, 'YYYYMMDD') || '-' || SUBSTRING(id::TEXT, 1, 8)
  ) STORED,
  
  -- Change type
  change_type VARCHAR NOT NULL,
  /* Change types:
     'rate_change' - Bill/pay rate modification
     'extension' - Contract extension
     'early_termination' - Ending early
     'conversion' - Contract-to-hire
     'location_change' - Work location change
     'schedule_change' - Hours/schedule modification
     'role_change' - Title/responsibilities change
     'vendor_change' - Different vendor for C2C
  */
  
  -- Effective dates
  effective_date DATE NOT NULL,
  
  -- Values before and after
  old_values JSONB NOT NULL,
  /* Example for rate_change:
  {
    "bill_rate": 100.00,
    "pay_rate": 75.00,
    "margin": 25.00
  }
  */
  new_values JSONB NOT NULL,
  /* Example:
  {
    "bill_rate": 110.00,
    "pay_rate": 80.00,
    "margin": 30.00
  }
  */
  
  -- Reason and justification
  reason VARCHAR,  -- 'annual_increase', 'market_adjustment', 'promotion', 'client_request', 'cost_reduction'
  justification TEXT,
  
  -- Approval workflow
  status VARCHAR DEFAULT 'draft',  -- 'draft', 'pending_approval', 'approved', 'rejected', 'applied'
  requires_client_approval BOOLEAN DEFAULT false,
  requires_internal_approval BOOLEAN DEFAULT true,
  
  -- Internal approval
  internal_approved_by UUID REFERENCES user_profiles(id),
  internal_approved_at TIMESTAMPTZ,
  internal_approval_notes TEXT,
  
  -- Client approval
  client_approved_by_contact_id UUID REFERENCES contacts(id),
  client_approved_at TIMESTAMPTZ,
  client_approval_reference VARCHAR,  -- PO number, email reference, etc.
  
  -- Document reference
  document_id UUID REFERENCES documents(id),  -- Supporting documentation
  
  -- Applied tracking
  applied_at TIMESTAMPTZ,
  applied_by UUID REFERENCES user_profiles(id),
  
  -- Audit
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  created_by UUID REFERENCES user_profiles(id),
  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  
  -- Constraints
  CONSTRAINT valid_status CHECK (status IN ('draft', 'pending_approval', 'approved', 'rejected', 'applied'))
);

CREATE INDEX idx_placement_change_orders_placement ON placement_change_orders(placement_id, created_at DESC);
CREATE INDEX idx_placement_change_orders_status ON placement_change_orders(status) WHERE status IN ('pending_approval', 'approved');
CREATE INDEX idx_placement_change_orders_effective ON placement_change_orders(effective_date) WHERE status = 'approved';
```

### Placement Rate History (Migrates to entity_rates)

```sql
-- Placement rates should use entity_rates table
-- This is handled by RATES-01, but here's the relationship:

-- Insert initial placement rate
INSERT INTO entity_rates (
  org_id, entity_type, entity_id,
  rate_type, currency,
  bill_rate, pay_rate,
  ot_bill_rate, ot_pay_rate,
  effective_date, is_current,
  context_job_id, context_client_id,
  rate_card_id, rate_card_item_id,
  approved_by, approved_at
)
SELECT
  p.org_id, 'placement', p.id,
  'hourly', 'USD',
  p.bill_rate, p.pay_rate,
  p.bill_rate * 1.5, p.pay_rate * 1.5,  -- OT
  p.start_date, true,
  p.job_id, p.client_company_id,
  p.rate_card_id, p.rate_card_item_id,
  p.created_by, p.created_at
FROM placements p
WHERE p.deleted_at IS NULL;
```

## Migration Strategy

### Phase 1: Schema Updates (Non-Breaking)
- Add new columns to placements table
- Create placement_extensions table
- Keep old columns temporarily

### Phase 2: Data Migration

```sql
-- Step 1: Map accounts to companies
UPDATE placements p
SET client_company_id = c.id
FROM accounts a
JOIN companies c ON c.org_id = a.org_id 
  AND c.name = a.name 
  AND c.category = 'client'
WHERE p.account_id = a.id;

-- Step 2: Consolidate person references to contact_id
-- Priority: candidate_id (if exists) then consultant_id
-- First, find matching contacts

-- From candidates
UPDATE placements p
SET contact_id = c.id
FROM candidates cand
JOIN contacts c ON c.org_id = cand.org_id 
  AND c.primary_email = cand.email
  AND c.category = 'person'
WHERE p.candidate_id = cand.id
  AND p.contact_id IS NULL;

-- From bench_consultants
UPDATE placements p
SET contact_id = c.id
FROM bench_consultants bc
JOIN contacts c ON c.org_id = bc.org_id 
  AND c.primary_email = bc.email
  AND c.category = 'person'
WHERE p.consultant_id = bc.id
  AND p.contact_id IS NULL;

-- Step 3: Migrate inline rates to entity_rates
INSERT INTO entity_rates (
  org_id, entity_type, entity_id,
  rate_type, bill_rate, pay_rate,
  effective_date, is_current,
  context_job_id
)
SELECT
  p.org_id, 'placement', p.id,
  'hourly', p.bill_rate, p.pay_rate,
  p.start_date, true,
  p.job_id
FROM placements p
WHERE (p.bill_rate IS NOT NULL OR p.pay_rate IS NOT NULL)
  AND p.deleted_at IS NULL;

-- Step 4: Copy current rates to denormalized fields
UPDATE placements p
SET 
  current_bill_rate = p.bill_rate,
  current_pay_rate = p.pay_rate,
  current_margin = p.bill_rate - p.pay_rate,
  current_margin_percentage = 
    CASE WHEN p.bill_rate > 0 
    THEN ((p.bill_rate - p.pay_rate) / p.bill_rate * 100) 
    ELSE 0 END,
  rates_last_updated_at = p.updated_at;

-- Step 5: Migrate status history to entity_history
INSERT INTO entity_history (
  org_id, entity_type, entity_id,
  change_type, field_name,
  old_value, new_value,
  changed_by, changed_at
)
SELECT
  ph.org_id, 'placement', ph.placement_id,
  'status_change', 'status',
  ph.old_status, ph.new_status,
  ph.changed_by, ph.changed_at
FROM placement_history ph;

-- Step 6: Identify C2C placements and set vendor
UPDATE placements p
SET 
  is_subcontracted = true,
  vendor_company_id = c.id
FROM bench_consultants bc
JOIN companies c ON bc.vendor_id = c.id
WHERE p.consultant_id = bc.id
  AND bc.employment_type = 'c2c';
```

### Phase 3: Backward Compatibility Views

```sql
-- View for legacy queries expecting candidate_id and consultant_id
CREATE VIEW placements_legacy_v AS
SELECT
  p.*,
  p.contact_id as candidate_id,
  p.contact_id as consultant_id,
  p.client_company_id as account_id
FROM placements p
WHERE p.deleted_at IS NULL;
```

### Phase 4: Router & UI Updates
- Update placement-related routers
- Update placement forms to use contact/company selectors
- Update placement workspace with new fields
- Add extension management UI
- Add rate history view

### Phase 5: Cleanup
- Remove legacy columns after validation period
- Drop `placement_history` after entity_history migration

## Acceptance Criteria

### Schema Implementation
- [ ] Add `contact_id` FK to `contacts` (consolidating candidate/consultant)
- [ ] Rename `account_id` to `client_company_id`
- [ ] Add `work_site_company_id` FK to `companies`
- [ ] Add `vendor_company_id` FK to `companies`
- [ ] Add rate card linkage fields
- [ ] Add vendor/C2C tracking fields
- [ ] Add compliance tracking fields
- [ ] Add financial summary fields
- [ ] Add termination tracking fields
- [ ] Create `placement_extensions` table
- [ ] All indexes created
- [ ] RLS policies updated

### Data Migration
- [ ] All placements have `contact_id` populated
- [ ] All placements have `client_company_id` populated
- [ ] C2C placements have `vendor_company_id` set
- [ ] Inline rates migrated to entity_rates
- [ ] Status history migrated to entity_history
- [ ] Extension history migrated
- [ ] No orphaned references

### Backward Compatibility
- [ ] Legacy view `placements_legacy_v` working
- [ ] Existing tRPC procedures continue working
- [ ] Reporting queries work with new schema

### Frontend Updates
- [ ] Placement creation uses contact selector
- [ ] Client vs. work site distinction visible
- [ ] Vendor tracking for C2C placements
- [ ] Rate history view functional
- [ ] Extension management UI working
- [ ] Compliance status visible
- [ ] Termination workflow complete

### Testing
- [ ] Migration script tested on staging
- [ ] All existing placement queries work
- [ ] Financial calculations accurate
- [ ] Performance benchmarks acceptable

---

## Technical Context

### Entity Relationship After Migration

```
┌─────────────────────────────────────────────────────────────────┐
│                       PLACEMENTS                                 │
├─────────────────────────────────────────────────────────────────┤
│ contact_id ─────────────────────► contacts (the placed person)  │
│ job_id ─────────────────────────► jobs                          │
│ submission_id ──────────────────► submissions                   │
│ client_company_id ──────────────► companies (billing client)    │
│ work_site_company_id ───────────► companies (work location)     │
│ vendor_company_id ──────────────► companies (if C2C)            │
│ msp_company_id ─────────────────► companies (if via MSP)        │
│ rate_card_id ───────────────────► rate_cards                    │
│ contract_document_id ───────────► documents                     │
└─────────────────────────────────────────────────────────────────┘
         │
         │ placement_id FK
         ▼
┌─────────────────────────┐    ┌─────────────────────────┐
│ placement_extensions    │    │     entity_rates        │
│ • extension history     │    │ • rate history          │
│ • rate changes          │    │ • entity_type='placemt' │
│ • approvals             │    │ • version tracking      │
└─────────────────────────┘    └─────────────────────────┘
```

### Placement Types

```
W2 Direct Placement:
  contact_id = "John Doe"
  client_company_id = "Acme Corp"
  work_site_company_id = "Acme Corp"
  vendor_company_id = NULL
  is_subcontracted = false

W2 MSP Placement:
  contact_id = "John Doe"
  client_company_id = "Magnit MSP"  -- We bill MSP
  work_site_company_id = "Google"  -- Work happens at Google
  msp_company_id = "Magnit MSP"
  is_subcontracted = false

C2C/Subcontractor Placement:
  contact_id = "Jane Smith"
  client_company_id = "Acme Corp"
  vendor_company_id = "TCS Consulting"  -- We pay TCS
  is_subcontracted = true
  vendor_bill_rate = 75.00  -- TCS bills us
  current_bill_rate = 95.00  -- We bill Acme
  vendor_markup = 26.67  -- Our margin on top
```

### Placement Status Flow

```
pending → compliance_pending → active → (extensions) → ending → completed

OR at any stage:
→ terminated (client_terminated | consultant_resigned | for_cause)
→ converted (contract-to-hire)
```

---

## Notes

This migration is **critical for staffing operations**:

1. **Single Person**: One contact record for candidate/consultant
2. **Company Clarity**: Billing client vs. work site vs. vendor
3. **Rate Tracking**: Full history of rate changes
4. **C2C Support**: Clear vendor tracking for subcontracted placements
5. **Extension Management**: Formal extension tracking with approvals
6. **Compliance Integration**: Status tracking for background/drug test
7. **Financial Accuracy**: Total billed/paid/hours for reporting
