# ISSUE: Role-Based Navigation Visibility and RACI Data Access Control

**Issue ID:** AUTH-01
**Created:** 2025-12-17
**Status:** Open
**Priority:** Critical
**Type:** Functionality
**Reporter:** User

---

## Summary

Implement role-based navigation visibility so different roles see only relevant tabs/screens, and enforce RACI-based data filtering in list views so users see only records they own or are assigned to via RACI roles.

## Location

- **Screen**: Top Navigation (`src/components/navigation/TopNavigation.tsx`)
- **Component**: Navigation config (`src/lib/navigation/top-navigation.ts`), List views
- **Action**: Navigation rendering, list data queries

## Problem Description

Currently, all employee roles see the same 8 navigation tabs regardless of their role. The only differentiation is the redirect logic (Admin/Executive/Leadership → Admin Dashboard, others → Workspace Dashboard). This means:

1. HR users see recruiting and bench sales tabs they shouldn't access
2. Recruiters see Administration and HR tabs they shouldn't access
3. Admins see all employee workflow tabs they may not need
4. List views show all org records instead of RACI-scoped records

## Expected Behavior

### Navigation Visibility by Role

| Role | Visible Tabs | Default Landing | Hidden Tabs |
|------|--------------|-----------------|-------------|
| **Admin** | Administration, My Work | Administration | HR, Accounts, Contacts, Jobs, Candidates, CRM, Pipeline |
| **HR** | HR screens, CRM, My Work | My Work | Administration, Jobs, Candidates, Pipeline (recruiting-specific) |
| **Recruiters** | Accounts, Contacts, Jobs, Candidates, CRM, Pipeline, My Work | My Work | Administration, HR |
| **Bench Sales** | Accounts, Contacts, Jobs, Candidates, CRM, Pipeline, My Work | My Work | Administration, HR |
| **TA/Sales** | Accounts, Contacts, Jobs, Candidates, CRM, Pipeline, My Work | My Work | Administration, HR |

### Data Access (RACI Filtering)

- List views should show only records where user has RACI assignment (Responsible, Accountable, Consulted, or Informed)
- Include records created by the user (`created_by = userId`)
- Present data logically with filters or categories for easy navigation

## Current Behavior

- All 8 tabs visible to all employee roles
- Only redirect path differs based on role category
- List views show all org records (filtered by `org_id` only)

## Steps to Reproduce

1. Log in as a Recruiter user
2. Observe all 8 navigation tabs are visible including "Administration" and HR-related screens
3. Navigate to any list view (e.g., Jobs)
4. Observe all org jobs are shown, not just RACI-assigned ones

## Evidence

### Research Document
Full analysis available at: `thoughts/shared/research/2025-12-17-permissions-access-control-system.md`

### Key Findings from Research

1. **13+ System Roles** exist with role categories: `admin`, `hr`, `pod_ic`, `pod_manager`, `leadership`, `executive`, `portal`
2. **Permission scopes** already defined: `own`, `own_raci`, `own_ra`, `team`, `region`, `org`, `draft_only`
3. **RACI infrastructure** exists via `object_owners` table
4. **Navigation config** at `src/lib/navigation/top-navigation.ts` has no role filtering
5. **Auth redirect** at `src/lib/auth/client.ts:24-37` only checks admin categories for routing

### Current Navigation Config Structure
```typescript
// src/lib/navigation/top-navigation.ts - shows 8 tabs for all employees
// My Work, Accounts, Contacts, Jobs, Candidates, CRM, Pipeline, Administration
```

### Current Redirect Logic
```typescript
// src/lib/auth/client.ts:24-37
const ADMIN_ROLE_CATEGORIES = ['admin', 'executive', 'leadership']
// Only distinguishes admin vs non-admin for redirect
```

## Impact

- **Severity**: Major
- **Affected Users**: All employee portal users (Recruiters, HR, Admins, Bench Sales, TA)
- **Workaround**: None - users can navigate to unauthorized screens

## Technical Context

### Related Files
- `src/lib/navigation/top-navigation.ts` - Navigation tab configuration
- `src/components/navigation/TopNavigation.tsx` - Navigation component
- `src/lib/auth/client.ts` - Auth redirect logic, role detection
- `src/lib/auth/permission-types.ts` - Role categories, permission scopes
- `src/lib/auth/permission-evaluator.ts` - Permission evaluation chain
- `src/server/trpc/middleware.ts` - tRPC middleware (orgProtectedProcedure)
- `database/schema.sql:24706-24725` - `object_owners` table (RACI)
- `database/schema.sql:28961-28979` - `system_roles` table

### Existing Infrastructure to Leverage
1. **Role categories** (`RoleCategory` type) for grouping permissions
2. **Permission scopes** (`own_raci`, `own_ra`) for data filtering
3. **`object_owners` table** for RACI assignments
4. **`evaluatePermission()` function** for scope-aware access checks

### Possible Implementation Approach
1. Add `visibleFor: RoleCategory[]` to navigation tab config
2. Filter tabs in `TopNavigation.tsx` based on user's role category
3. Update list queries to use `own_raci` scope by default
4. Add filter UI for "My Records" / "Team Records" / "All" toggle

## Acceptance Criteria

### Navigation Visibility
- [ ] Admin users see only Administration and My Work tabs
- [ ] HR users see only HR screens, CRM, and My Work tabs
- [ ] Recruiter/Bench Sales/TA users see all employee tabs except Administration and HR
- [ ] Default landing page respects role (Admin → Administration, others → My Work)
- [ ] Tab visibility is enforced (not just hidden - route protection too)

### Data Access Control
- [ ] List views default to showing RACI-scoped records (own + assigned)
- [ ] Users can filter/categorize by ownership type (My Records, Assigned to Me, etc.)
- [ ] Records created by user are always visible
- [ ] RACI-assigned records (R, A, C, I roles) are visible
- [ ] Data filtering is consistent across all entity list views

### Technical
- [ ] Navigation config supports role-based visibility
- [ ] Route protection prevents direct URL access to unauthorized tabs
- [ ] List queries use permission scopes consistently
- [ ] No regression in existing functionality

---

## Notes

- Research document provides full analysis of existing RBAC system
- System already has permission scopes and RACI infrastructure - this is about wiring it to UI
- Priority is Critical - needed immediately
- Consider adding role-specific quick actions to My Work dashboard
