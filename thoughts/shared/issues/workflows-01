# ISSUE: Unified Workflows & Automation System (Phase 1)

**Issue ID:** WORKFLOWS-01
**Created:** 2025-12-10
**Status:** Open
**Priority:** High
**Type:** Feature/Enhancement (Database Schema Redesign)
**Reporter:** User
**Depends On:** HISTORY-01 (for workflow execution history), COMMS-01 (send_email action)

---

## Summary

Unify the fragmented workflows and automation system into a centralized workflow engine. Currently, workflow logic is scattered across 8+ tables with inconsistent execution patterns, no visual builder support, and limited reusability. This issue creates an enterprise-grade workflow automation system supporting triggers, conditions, actions, and approvals.

**Note:** This is **Phase 1** of the workflow system implementation. Notification actions will be added in Phase 2 (after NOTIFICATIONS-01 is implemented) to avoid circular dependencies.

## Location

- **Current Tables**: `workflows`, `workflow_instances`, `workflow_states`, `workflow_transitions`, `workflow_executions`, `workflow_actions`, `automation_rules`, `approval_workflows`
- **Related Tables**: `activities` (workflow can create), `email_templates` (workflow can send)
- **Affected Modules**: All modules (cross-cutting automation)

## Problem Description

### Current State Issues

1. **Fragmented Workflow Tables**: 8+ separate tables
   - `workflows` - Workflow definitions
   - `workflow_instances` - Running instances
   - `workflow_states` - State machine states
   - `workflow_transitions` - State transitions
   - `workflow_executions` - Execution log
   - `workflow_actions` - Available actions
   - `automation_rules` - Separate automation system
   - `approval_workflows` - Separate approval system

2. **No Unified Execution Engine**:
   - Automations run differently than workflows
   - Approvals are separate from workflow states
   - No consistent retry/error handling

3. **Missing Enterprise Features**:
   - No visual workflow builder support
   - No workflow templates
   - No parallel execution paths
   - No sub-workflow support
   - Limited condition logic

4. **Staffing-Specific Gaps**:
   - No candidate pipeline automation
   - No submission workflow templates
   - No compliance-triggered workflows

## Expected Behavior

A unified workflow system that:
1. Centralized `workflow_definitions` with versioning
2. `workflow_steps` for actions and conditions
3. `workflow_instances` for execution tracking
4. Trigger-based automation (event, schedule, manual)
5. Parallel and sequential execution paths
6. Sub-workflow support (workflow calls workflow)
7. Approval steps integrated
8. Visual builder data structure

## Proposed Schema Design

### Workflow Definitions (Templates)

```sql
CREATE TABLE workflow_definitions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),

  -- Identity
  workflow_name VARCHAR NOT NULL,
  workflow_code VARCHAR UNIQUE,  -- 'CANDIDATE_ONBOARDING_V2'
  description TEXT,

  -- Classification
  workflow_type VARCHAR NOT NULL,
    -- 'automation' (triggered by events)
    -- 'approval' (requires human approval)
    -- 'pipeline' (entity state progression)
    -- 'scheduled' (time-based)
    -- 'manual' (user-initiated)
    -- 'onboarding' (multi-step process)

  workflow_category VARCHAR,  -- 'recruiting', 'crm', 'hr', 'operations'

  -- Entity scope (what entities can this workflow run on)
  applies_to_entity_types TEXT[],  -- ['submission', 'lead', 'placement']

  -- Trigger configuration
  trigger_type VARCHAR NOT NULL,
    -- 'event' (on entity change)
    -- 'schedule' (cron/time)
    -- 'manual' (user clicks button)
    -- 'api' (external trigger)
    -- 'sub_workflow' (called by parent)

  trigger_config JSONB,
    -- Event: { event: 'submission.status_changed', conditions: [...] }
    -- Schedule: { cron: '0 9 * * 1', timezone: 'America/Chicago' }
    -- Manual: { button_label: 'Start Onboarding', roles: ['recruiter'] }

  -- Conditions (when to run)
  entry_conditions JSONB[],  -- Must all be true to start
    -- [{ field: 'status', operator: 'equals', value: 'submitted' }]

  -- Versioning
  version INTEGER DEFAULT 1,
  is_latest_version BOOLEAN DEFAULT true,
  is_active BOOLEAN DEFAULT true,
  previous_version_id UUID REFERENCES workflow_definitions(id),

  -- Visual builder metadata
  canvas_data JSONB,  -- Position, connections for visual builder

  -- Execution settings
  max_concurrent_instances INTEGER DEFAULT 10,
  timeout_minutes INTEGER DEFAULT 1440,  -- 24 hours default
  retry_on_failure BOOLEAN DEFAULT true,
  max_retries INTEGER DEFAULT 3,
  retry_delay_minutes INTEGER DEFAULT 5,

  -- Status
  published_at TIMESTAMPTZ,
  published_by UUID REFERENCES user_profiles(id),

  -- Audit
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  created_by UUID REFERENCES user_profiles(id),
  deleted_at TIMESTAMPTZ
);

-- Indexes
CREATE INDEX idx_workflow_defs_type ON workflow_definitions(workflow_type, is_active) WHERE deleted_at IS NULL;
CREATE INDEX idx_workflow_defs_entity ON workflow_definitions USING gin(applies_to_entity_types) WHERE is_active = true;
CREATE INDEX idx_workflow_defs_trigger ON workflow_definitions(trigger_type) WHERE is_active = true;
```

### Workflow Steps (Actions)

```sql
CREATE TABLE workflow_steps (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  workflow_id UUID NOT NULL REFERENCES workflow_definitions(id) ON DELETE CASCADE,

  -- Position in workflow
  step_order INTEGER NOT NULL,
  step_code VARCHAR NOT NULL,  -- Unique within workflow
  step_name VARCHAR NOT NULL,

  -- Step type
  step_type VARCHAR NOT NULL,
    -- 'action' (do something)
    -- 'condition' (branch based on condition)
    -- 'approval' (wait for human approval)
    -- 'delay' (wait for time)
    -- 'sub_workflow' (call another workflow)
    -- 'parallel_split' (start parallel paths)
    -- 'parallel_join' (wait for parallel paths)
    -- 'loop' (iterate over collection)

  -- Action configuration (when step_type = 'action')
  action_type VARCHAR,
    -- Phase 1 Actions:
    -- 'send_email', 'create_activity', 'update_field', 'create_entity',
    -- 'assign_user', 'add_to_campaign', 'call_webhook',
    -- 'generate_document', 'schedule_interview'
    -- Phase 2 Actions (Future):
    -- 'send_notification'

  action_config JSONB,
    -- send_email: { template_id: UUID, to: '{{contact.email}}' }
    -- update_field: { field: 'status', value: 'in_progress' }
    -- create_activity: { type: 'task', subject: 'Follow up' }

  -- Condition configuration (when step_type = 'condition')
  conditions JSONB[],
    -- [{ field: 'score', operator: 'gte', value: 80 }]

  true_step_code VARCHAR,  -- Next step if conditions true
  false_step_code VARCHAR,  -- Next step if conditions false

  -- Approval configuration (when step_type = 'approval')
  approval_config JSONB,
    -- { approvers: ['manager'], timeout_hours: 48, escalate_to: 'director' }

  -- Delay configuration (when step_type = 'delay')
  delay_config JSONB,
    -- { duration_minutes: 60 } or { until_time: '09:00', timezone: 'UTC' }

  -- Sub-workflow (when step_type = 'sub_workflow')
  sub_workflow_id UUID REFERENCES workflow_definitions(id),

  -- Error handling
  on_error VARCHAR DEFAULT 'fail',  -- 'fail', 'skip', 'retry', 'goto'
  error_goto_step_code VARCHAR,

  -- Next step (for linear flow)
  next_step_code VARCHAR,

  -- Parallel execution
  parallel_branch_id VARCHAR,  -- Group steps in same parallel branch

  -- Audit
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- Indexes
CREATE INDEX idx_workflow_steps ON workflow_steps(workflow_id, step_order);
```

### Workflow Instances (Executions)

```sql
CREATE TABLE workflow_instances (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),

  workflow_id UUID NOT NULL REFERENCES workflow_definitions(id),
  workflow_version INTEGER NOT NULL,

  -- Entity context
  entity_type VARCHAR NOT NULL,
  entity_id UUID NOT NULL,

  -- Trigger context
  triggered_by VARCHAR NOT NULL,  -- 'event', 'schedule', 'manual', 'api', 'sub_workflow'
  trigger_event JSONB,  -- The event that triggered this instance
  triggered_by_user_id UUID REFERENCES user_profiles(id),
  parent_instance_id UUID REFERENCES workflow_instances(id),  -- For sub-workflows

  -- Execution state
  status VARCHAR NOT NULL DEFAULT 'pending',
    -- 'pending', 'running', 'paused', 'waiting_approval', 'completed', 'failed', 'cancelled', 'timed_out'

  current_step_code VARCHAR,

  -- Progress tracking
  steps_completed INTEGER DEFAULT 0,
  steps_total INTEGER,
  progress_percentage INTEGER GENERATED ALWAYS AS (
    CASE WHEN steps_total > 0 THEN (steps_completed * 100 / steps_total) ELSE 0 END
  ) STORED,

  -- Timing
  started_at TIMESTAMPTZ,
  completed_at TIMESTAMPTZ,
  timeout_at TIMESTAMPTZ,  -- When instance times out

  -- Error tracking
  error_message TEXT,
  retry_count INTEGER DEFAULT 0,
  last_retry_at TIMESTAMPTZ,

  -- Context data (available to all steps)
  context_data JSONB DEFAULT '{}',

  -- Audit
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  created_by UUID REFERENCES user_profiles(id),
  deleted_at TIMESTAMPTZ
);

-- Indexes
CREATE INDEX idx_workflow_instances_workflow ON workflow_instances(workflow_id, status);
CREATE INDEX idx_workflow_instances_entity ON workflow_instances(entity_type, entity_id);
CREATE INDEX idx_workflow_instances_status ON workflow_instances(status, created_at DESC);
CREATE INDEX idx_workflow_instances_timeout ON workflow_instances(timeout_at) WHERE status = 'running';
```

### Workflow Step Executions

```sql
CREATE TABLE workflow_step_executions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  instance_id UUID NOT NULL REFERENCES workflow_instances(id) ON DELETE CASCADE,
  step_id UUID NOT NULL REFERENCES workflow_steps(id),

  step_code VARCHAR NOT NULL,
  step_type VARCHAR NOT NULL,

  -- Execution state
  status VARCHAR NOT NULL DEFAULT 'pending',
    -- 'pending', 'running', 'completed', 'failed', 'skipped', 'waiting'

  -- Timing
  started_at TIMESTAMPTZ,
  completed_at TIMESTAMPTZ,
  duration_ms INTEGER,

  -- Input/Output
  input_data JSONB,
  output_data JSONB,

  -- For approval steps
  approval_status VARCHAR,  -- 'pending', 'approved', 'rejected', 'escalated'
  approved_by UUID REFERENCES user_profiles(id),
  approved_at TIMESTAMPTZ,
  approval_notes TEXT,

  -- Error tracking
  error_message TEXT,
  error_stack TEXT,
  retry_count INTEGER DEFAULT 0,

  -- Audit
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- Indexes
CREATE INDEX idx_step_executions_instance ON workflow_step_executions(instance_id, created_at);
CREATE INDEX idx_step_executions_status ON workflow_step_executions(status) WHERE status IN ('pending', 'running', 'waiting');
```

### Workflow Templates (Prebuilt)

```sql
CREATE TABLE workflow_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- Identity
  template_name VARCHAR NOT NULL,
  template_code VARCHAR UNIQUE,  -- 'STAFFING_SUBMISSION_PIPELINE'
  description TEXT,

  -- Classification
  workflow_type VARCHAR NOT NULL,
  industry VARCHAR,  -- 'staffing', 'recruiting', 'hr'
  category VARCHAR,  -- 'candidate', 'client', 'compliance'

  -- Template content
  template_definition JSONB NOT NULL,  -- Full workflow definition

  -- Status
  is_active BOOLEAN DEFAULT true,
  is_premium BOOLEAN DEFAULT false,

  -- Usage stats
  install_count INTEGER DEFAULT 0,

  -- Audit
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

CREATE INDEX idx_workflow_templates_type ON workflow_templates(workflow_type, category) WHERE is_active = true;
```

## Migration Strategy

### Phase 1: Schema Creation
- Create `workflow_definitions` with versioning
- Create `workflow_steps` with all step types
- Create `workflow_instances` for execution
- Create `workflow_step_executions` for step-level tracking
- Create `workflow_templates` for prebuilt workflows

### Phase 2: Data Migration
1. Migrate `workflows` → `workflow_definitions`
2. Migrate `workflow_states` + `workflow_transitions` → `workflow_steps`
3. Migrate `workflow_instances` → `workflow_instances` (new)
4. Migrate `workflow_executions` → `workflow_step_executions`
5. Migrate `automation_rules` → `workflow_definitions` (trigger_type='event')
6. Migrate `approval_workflows` → `workflow_definitions` (workflow_type='approval')

### Phase 3: Template Seeding
- Candidate onboarding workflow
- Submission pipeline workflow
- Lead nurturing workflow
- Placement onboarding workflow
- Client onboarding workflow

### Phase 4: Execution Engine
- Build workflow execution service
- Event listener for trigger detection
- Scheduler for time-based triggers
- Retry/error handling

### Phase 5: Router & UI Updates
- `workflows` tRPC router
- WorkflowBuilder component (visual)
- WorkflowList component
- InstanceMonitor component
- ApprovalInbox component

## Acceptance Criteria

### Schema Implementation
- [ ] Create `workflow_definitions` with versioning
- [ ] Create `workflow_steps` supporting all step types
- [ ] Create `workflow_instances` for execution tracking
- [ ] Create `workflow_step_executions`
- [ ] Parallel execution paths supported
- [ ] Sub-workflow references working
- [ ] RLS policies enforced

### Step Types
- [ ] Action steps working (send_email, update_field, etc.)
- [ ] Condition steps with branching
- [ ] Approval steps with timeout/escalation
- [ ] Delay steps (duration and until_time)
- [ ] Sub-workflow calls
- [ ] Parallel split/join

### Execution Engine
- [ ] Event triggers working
- [ ] Schedule triggers working
- [ ] Manual triggers working
- [ ] Retry on failure working
- [ ] Timeout handling working

### Data Migration
- [ ] All legacy workflow tables migrated
- [ ] No active workflows disrupted
- [ ] Historical data preserved

### Frontend Updates
- [ ] WorkflowBuilder (visual drag-drop)
- [ ] WorkflowList (all workflows)
- [ ] InstanceMonitor (running instances)
- [ ] ApprovalInbox (pending approvals)
- [ ] TemplateGallery (prebuilt workflows)

---

## Technical Context

### Workflow Step Types

```
workflow_steps
├── action
│   ├── send_email (template_id, to, cc, bcc)
│   ├── create_activity (type, subject, assigned_to)
│   ├── update_field (field, value)
│   ├── create_entity (entity_type, data)
│   ├── assign_user (user_id or role)
│   ├── add_to_campaign (campaign_id)
│   ├── call_webhook (url, method, payload)
│   ├── generate_document (template_id)
│   └── schedule_interview (config)
├── condition
│   ├── field_check (field, operator, value)
│   ├── entity_exists (entity_type, conditions)
│   └── time_check (before/after date)
├── approval
│   ├── single_approver (user or role)
│   ├── multi_approver (all or any)
│   └── chain_approval (sequential)
├── delay
│   ├── duration (minutes, hours, days)
│   └── until_time (specific time)
├── sub_workflow
│   └── call (workflow_id, input_mapping)
└── parallel
    ├── split (start branches)
    └── join (wait for branches)
```

### Trigger Configuration Examples

```json
// Event trigger
{
  "trigger_type": "event",
  "trigger_config": {
    "event": "submission.status_changed",
    "conditions": [
      { "field": "new_status", "operator": "equals", "value": "interviewing" }
    ]
  }
}

// Schedule trigger
{
  "trigger_type": "schedule",
  "trigger_config": {
    "cron": "0 9 * * 1",  // Every Monday at 9am
    "timezone": "America/Chicago"
  }
}

// Manual trigger
{
  "trigger_type": "manual",
  "trigger_config": {
    "button_label": "Start Onboarding",
    "allowed_roles": ["recruiter", "manager"]
  }
}
```

### Staffing-Specific Workflow Templates

```
Templates
├── Recruiting
│   ├── Candidate Onboarding
│   ├── Submission Pipeline
│   ├── Interview Scheduling
│   └── Offer Approval
├── CRM
│   ├── Lead Nurturing
│   ├── Deal Approval
│   └── Client Onboarding
├── Bench Sales
│   ├── Consultant Marketing
│   └── Vendor Management
└── Compliance
│   ├── Background Check
│   ├── Document Collection
│   └── Expiration Alerts
```

---

## RLS Policies

```sql
-- workflow_definitions table RLS
ALTER TABLE workflow_definitions ENABLE ROW LEVEL SECURITY;

CREATE POLICY "workflow_definitions_org_isolation" ON workflow_definitions
  FOR ALL USING (org_id = auth.org_id());

-- workflow_steps table RLS
ALTER TABLE workflow_steps ENABLE ROW LEVEL SECURITY;

CREATE POLICY "workflow_steps_org_isolation" ON workflow_steps
  FOR ALL USING (
    EXISTS (SELECT 1 FROM workflow_definitions wd WHERE wd.id = workflow_id AND wd.org_id = auth.org_id())
  );

-- workflow_instances table RLS
ALTER TABLE workflow_instances ENABLE ROW LEVEL SECURITY;

CREATE POLICY "workflow_instances_org_isolation" ON workflow_instances
  FOR ALL USING (org_id = auth.org_id());

-- workflow_step_executions table RLS
ALTER TABLE workflow_step_executions ENABLE ROW LEVEL SECURITY;

CREATE POLICY "workflow_step_executions_org_isolation" ON workflow_step_executions
  FOR ALL USING (
    EXISTS (SELECT 1 FROM workflow_instances wi WHERE wi.id = instance_id AND wi.org_id = auth.org_id())
  );
```

## Rollback Plan

### Schema Rollback
```sql
-- Drop in reverse order of creation
DROP TABLE IF EXISTS workflow_templates;
DROP TABLE IF EXISTS workflow_step_executions;
DROP TABLE IF EXISTS workflow_instances;
DROP TABLE IF EXISTS workflow_steps;
DROP TABLE IF EXISTS workflow_definitions;
```

### Full Rollback Procedure
1. Stop application deployments
2. Verify no active workflow executions
3. Execute schema rollback SQL
4. Restore tRPC router to previous git commit
5. Restore UI components to previous git commit
6. Restore legacy workflow tables if data migration occurred
7. Document incident and root cause
