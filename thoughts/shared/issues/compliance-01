# ISSUE: Unified Compliance & Requirements System

**Issue ID:** COMPLIANCE-01
**Created:** 2025-12-10
**Status:** Open
**Priority:** High
**Type:** Feature/Enhancement (Database Schema Redesign)
**Reporter:** User
**Depends On:** DOCS-01 (for document storage)

---

## Summary

Unify the fragmented compliance tracking system into a centralized `compliance_items` table with polymorphic entity references. Currently, compliance data is scattered across 5+ tables with inconsistent tracking, no expiration alerts, and limited audit trails. This issue creates an enterprise-grade compliance management system critical for staffing industry regulations (background checks, drug tests, insurance, certifications, work authorization).

## Location

- **Current Tables**: `candidate_compliance_documents`, `employee_compliance`, `company_compliance_requirements`, `compliance_requirements`, `contact_compliance`
- **Related Tables**: `candidate_background_checks`, `candidate_work_authorizations`, `consultant_work_authorization`, `immigration_documents`
- **Affected Modules**: ATS, HR, Bench Sales, Operations

## Problem Description

### Current State Issues

1. **Fragmented Compliance Tables**: 5+ separate tables
   - `candidate_compliance_documents` - Candidate compliance tracking
   - `employee_compliance` - Employee compliance
   - `company_compliance_requirements` - Client/vendor requirements
   - `compliance_requirements` - General requirements definitions
   - `contact_compliance` - New contacts compliance (from CONTACTS-01)

2. **No Centralized Requirements Definition**: Each table defines compliance types differently

3. **Inconsistent Tracking**:
   - Different status enums per table
   - Expiration tracking not standardized
   - Verification workflow varies

4. **Missing Enterprise Features**:
   - No automated expiration alerts
   - No compliance dashboard
   - No requirement inheritance (client → placement → consultant)
   - Limited audit trail

5. **Industry-Critical Gap**: Staffing compliance is heavily regulated (EEOC, I-9, E-Verify, state-specific requirements)

## Expected Behavior

A unified compliance system that:
1. Centralized `compliance_requirements` master table (what's required)
2. Polymorphic `compliance_items` table (actual compliance records)
3. Requirement inheritance (client requirements → all placements)
4. Automated expiration tracking and alerts
5. Verification workflow with audit trail
6. Compliance dashboard per entity
7. Document linkage (compliance item → document)

## Proposed Schema Design

### Compliance Requirements (Master Definition)

```sql
CREATE TABLE compliance_requirements (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),

  -- Requirement identity
  requirement_code VARCHAR UNIQUE NOT NULL,  -- 'bg_check_federal', 'drug_test_10panel', 'w9'
  requirement_name VARCHAR NOT NULL,
  description TEXT,

  -- Classification
  requirement_category VARCHAR NOT NULL,
    -- 'background_check', 'drug_test', 'insurance', 'tax_form', 'work_authorization',
    -- 'certification', 'training', 'health', 'legal', 'security_clearance'

  applies_to_entity_types TEXT[],  -- ['contact', 'company']

  -- Timing
  validity_period_days INTEGER,  -- NULL = never expires
  advance_notice_days INTEGER DEFAULT 30,  -- Alert X days before expiry
  grace_period_days INTEGER DEFAULT 0,  -- Days after expiry before blocking

  -- Requirements
  is_mandatory BOOLEAN DEFAULT false,
  is_blocking BOOLEAN DEFAULT false,  -- Blocks placement if not compliant
  required_for_roles TEXT[],  -- ['candidate', 'consultant', 'vendor']

  -- Industry/Region specific
  applicable_industries TEXT[],
  applicable_states TEXT[],
  applicable_countries TEXT[],

  -- Verification
  requires_verification BOOLEAN DEFAULT true,
  verification_methods TEXT[],  -- ['document_upload', 'api_check', 'manual_review']
  auto_verify_sources TEXT[],  -- ['checkr', 'sterling', 'e-verify']

  -- Document requirements
  required_document_types TEXT[],  -- ['background_check', 'drug_test']

  -- Workflow Triggers (Added per Architecture Review)
  auto_create_workflow_on_expiry BOOLEAN DEFAULT false,
  expiry_workflow_id UUID,  -- REFERENCES workflow_definitions(id) - from WORKFLOWS-01
  renewal_workflow_id UUID,  -- REFERENCES workflow_definitions(id) - from WORKFLOWS-01
  escalation_workflow_id UUID,  -- REFERENCES workflow_definitions(id) - for failed compliance
  
  -- Notification Settings
  notify_on_expiry BOOLEAN DEFAULT true,
  notify_days_before_expiry INTEGER[] DEFAULT '{30, 14, 7, 1}',
  escalate_after_days_expired INTEGER DEFAULT 7,
  escalation_contact_roles TEXT[] DEFAULT '{hr_manager, compliance_officer}',

  -- Status
  is_active BOOLEAN DEFAULT true,

  -- Audit
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  created_by UUID REFERENCES user_profiles(id)
);

-- Indexes
CREATE INDEX idx_compliance_req_category ON compliance_requirements(requirement_category);
CREATE INDEX idx_compliance_req_entity ON compliance_requirements USING gin(applies_to_entity_types);
```

### Compliance Items (Polymorphic Records)

```sql
CREATE TABLE compliance_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),

  -- Polymorphic entity reference
  entity_type VARCHAR NOT NULL,  -- 'contact', 'company', 'placement'
  entity_id UUID NOT NULL,

  -- Requirement reference
  requirement_id UUID NOT NULL REFERENCES compliance_requirements(id),

  -- Status tracking
  status VARCHAR NOT NULL DEFAULT 'pending',
    -- 'pending', 'in_progress', 'submitted', 'under_review',
    -- 'verified', 'expired', 'failed', 'waived', 'exempt'

  status_reason TEXT,  -- Reason for status (especially failed/waived/exempt)

  -- Dates
  effective_date DATE,
  expiry_date DATE,
  submitted_at TIMESTAMPTZ,
  verified_at TIMESTAMPTZ,
  expired_at TIMESTAMPTZ,

  -- Verification
  verified_by UUID REFERENCES user_profiles(id),
  verification_method VARCHAR,
  verification_notes TEXT,
  verification_reference VARCHAR,  -- External reference (e.g., Checkr report ID)

  -- Document linkage
  document_id UUID REFERENCES documents(id),
  document_url VARCHAR,  -- Direct URL if not in documents table

  -- Additional data (type-specific)
  compliance_data JSONB,
    -- For insurance: { policy_number, coverage_amount, carrier }
    -- For background: { report_id, adjudication, flags }
    -- For drug test: { panel_type, result, lab }
    -- For work auth: { visa_type, uscis_number, sponsor }

  -- Alerts
  expiry_alert_sent_at TIMESTAMPTZ,
  reminder_sent_count INTEGER DEFAULT 0,

  -- Inheritance (for placements)
  inherited_from_entity_type VARCHAR,
  inherited_from_entity_id UUID,
  is_inherited BOOLEAN DEFAULT false,

  -- Audit
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  created_by UUID REFERENCES user_profiles(id),
  updated_by UUID REFERENCES user_profiles(id),
  deleted_at TIMESTAMPTZ
);

-- Indexes
CREATE INDEX idx_compliance_items_entity ON compliance_items(entity_type, entity_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_compliance_items_status ON compliance_items(status, expiry_date) WHERE deleted_at IS NULL;
CREATE INDEX idx_compliance_items_expiry ON compliance_items(expiry_date) WHERE status = 'verified' AND deleted_at IS NULL;
CREATE INDEX idx_compliance_items_requirement ON compliance_items(requirement_id) WHERE deleted_at IS NULL;

-- Unique constraint (one record per entity + requirement)
CREATE UNIQUE INDEX idx_compliance_items_unique
ON compliance_items(entity_type, entity_id, requirement_id)
WHERE deleted_at IS NULL AND is_inherited = false;
```

### Compliance Audit Log

```sql
CREATE TABLE compliance_audit_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  compliance_item_id UUID NOT NULL REFERENCES compliance_items(id) ON DELETE CASCADE,

  action VARCHAR NOT NULL,  -- 'status_change', 'document_uploaded', 'verified', 'expired', 'alert_sent'
  old_status VARCHAR,
  new_status VARCHAR,

  details JSONB,

  performed_by UUID REFERENCES user_profiles(id),
  performed_at TIMESTAMPTZ DEFAULT now()
);

CREATE INDEX idx_compliance_audit_item ON compliance_audit_log(compliance_item_id, performed_at DESC);
```

### Entity Compliance Requirements (What's Required for Each Entity)

```sql
CREATE TABLE entity_compliance_requirements (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),

  -- Who requires this
  requiring_entity_type VARCHAR NOT NULL,  -- 'company' (client), 'organization' (our org)
  requiring_entity_id UUID NOT NULL,

  -- What applies to
  applies_to_entity_type VARCHAR NOT NULL,  -- 'contact' (consultants), 'company' (vendors)

  -- Requirement
  requirement_id UUID NOT NULL REFERENCES compliance_requirements(id),

  -- Override settings
  is_mandatory_override BOOLEAN,  -- Override requirement default
  is_blocking_override BOOLEAN,
  validity_period_override INTEGER,

  -- Effective dates
  effective_from DATE,
  effective_to DATE,

  -- Status
  is_active BOOLEAN DEFAULT true,

  -- Audit
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  created_by UUID REFERENCES user_profiles(id)
);

CREATE INDEX idx_entity_compliance_req_requiring ON entity_compliance_requirements(requiring_entity_type, requiring_entity_id);
```

## Migration Strategy

### Phase 1: Schema Creation
- Create `compliance_requirements` master table
- Create `compliance_items` polymorphic table
- Create `compliance_audit_log`
- Create `entity_compliance_requirements`
- Seed standard compliance requirements

### Phase 2: Data Migration
1. Migrate `candidate_compliance_documents` → `compliance_items` (entity_type='contact')
2. Migrate `employee_compliance` → `compliance_items` (entity_type='contact')
3. Migrate `company_compliance_requirements` → `entity_compliance_requirements`
4. Migrate `contact_compliance` → `compliance_items`
5. Migrate `candidate_background_checks` → `compliance_items` (entity_type='contact')
6. Migrate `candidate_work_authorizations` → `compliance_items` (entity_type='contact')

### Phase 3: Seed Master Requirements
- Standard background check types
- Drug test panels (5, 10, 12 panel)
- Insurance types (GL, WC, E&O, Cyber)
- Tax forms (W9, W4, I-9)
- Certifications
- Security clearances

### Phase 4: Router & UI Updates
- `compliance` tRPC router
- ComplianceDashboard component
- ComplianceChecklist per entity
- Expiration alert system

## Acceptance Criteria

### Schema Implementation
- [ ] Create `compliance_requirements` master table
- [ ] Create `compliance_items` polymorphic table
- [ ] Create audit log table
- [ ] Seed standard requirements (20+ common types)
- [ ] RLS policies enforced

### Requirement Inheritance
- [ ] Client requirements flow to placements
- [ ] Organization defaults apply to all entities
- [ ] Override settings work correctly

### Status Workflow
- [ ] Status transitions enforced
- [ ] Expiration auto-detected
- [ ] Verification workflow functional

### Expiration Alerts
- [ ] Automated expiry detection
- [ ] Alert emails sent at threshold
- [ ] Dashboard shows upcoming expirations

### Data Migration
- [ ] All legacy compliance data migrated
- [ ] No orphaned records
- [ ] Audit history preserved

### Frontend Updates
- [ ] ComplianceDashboard (org-wide view)
- [ ] EntityComplianceTab (per entity)
- [ ] Requirement checklist with status
- [ ] Document upload integration

---

## Technical Context

### Compliance Category Taxonomy

```
compliance_requirements
├── Background Checks
│   ├── bg_check_federal (criminal)
│   ├── bg_check_state (state criminal)
│   ├── bg_check_county (county criminal)
│   ├── bg_check_sex_offender
│   ├── bg_check_global_watchlist
│   ├── bg_check_credit
│   └── bg_check_education
├── Drug Tests
│   ├── drug_test_5panel
│   ├── drug_test_10panel
│   └── drug_test_12panel
├── Insurance
│   ├── insurance_general_liability
│   ├── insurance_workers_comp
│   ├── insurance_professional_liability
│   └── insurance_cyber
├── Tax Forms
│   ├── tax_w9
│   ├── tax_w4
│   └── tax_i9
├── Work Authorization
│   ├── work_auth_us_citizen
│   ├── work_auth_permanent_resident
│   ├── work_auth_h1b
│   ├── work_auth_opt
│   └── work_auth_tn
├── Security Clearance
│   ├── clearance_public_trust
│   ├── clearance_secret
│   └── clearance_top_secret
└── Certifications
    ├── cert_pmp
    ├── cert_aws
    └── cert_cissp
```

### Status Flow

```
pending → in_progress → submitted → under_review → verified
                                                 ↓
                                            expired (auto)
                                                 ↓
                                        needs_renewal → verified
```

---

## RLS Policies

```sql
-- compliance_requirements table RLS
ALTER TABLE compliance_requirements ENABLE ROW LEVEL SECURITY;

CREATE POLICY "compliance_requirements_org_isolation" ON compliance_requirements
  FOR ALL USING (org_id = auth.org_id());

-- compliance_items table RLS
ALTER TABLE compliance_items ENABLE ROW LEVEL SECURITY;

CREATE POLICY "compliance_items_org_isolation" ON compliance_items
  FOR ALL USING (org_id = auth.org_id());

-- compliance_audit_log table RLS
ALTER TABLE compliance_audit_log ENABLE ROW LEVEL SECURITY;

CREATE POLICY "compliance_audit_log_org_isolation" ON compliance_audit_log
  FOR ALL USING (
    EXISTS (SELECT 1 FROM compliance_items ci WHERE ci.id = compliance_item_id AND ci.org_id = auth.org_id())
  );

-- entity_compliance_requirements table RLS
ALTER TABLE entity_compliance_requirements ENABLE ROW LEVEL SECURITY;

CREATE POLICY "entity_compliance_reqs_org_isolation" ON entity_compliance_requirements
  FOR ALL USING (org_id = auth.org_id());
```

## Rollback Plan

### Schema Rollback
```sql
-- Drop tables in reverse order
DROP TABLE IF EXISTS entity_compliance_requirements;
DROP TABLE IF EXISTS compliance_audit_log;
DROP TABLE IF EXISTS compliance_items;
DROP TABLE IF EXISTS compliance_requirements;
```

### Data Rollback
```sql
-- Recreate legacy tables from backup if needed
-- INSERT INTO candidate_compliance_documents SELECT * FROM candidate_compliance_documents_backup;
```

### Full Rollback Procedure
1. Stop application deployments
2. Execute schema rollback SQL
3. Restore legacy data from backups
4. Restore tRPC router to previous git commit
5. Restore UI components to previous git commit
6. Verify compliance status in legacy views
7. Document incident and root cause
