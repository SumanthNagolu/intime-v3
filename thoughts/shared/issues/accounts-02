# ISSUE: Unify Accounts & Vendors into Enterprise-Grade Companies System

**Issue ID:** ACCOUNTS-02
**Created:** 2025-12-10
**Status:** Open
**Priority:** High
**Type:** Feature/Enhancement (Database Schema Redesign)
**Reporter:** User

**Research Document:** [accounts-01-research](./accounts-01-research) - Full schema design with SQL

---

## Summary

Redesign the accounts and vendors data model by unifying them into a single `companies` table with category-based subtypes. This enterprise-grade design is based on comprehensive research of industry leaders (Bullhorn, Salesforce, Workday, HubSpot) and addresses the ~40% field overlap between current `accounts` and `vendors` tables while adding enterprise features like MSP/VMS support, versioned rate cards, compliance tracking, and health scoring.

## Location

- **Current Tables**: `accounts` (60+ columns), `vendors` (15 columns)
- **Related Tables**: `account_*` (7 tables), `vendor_*` (4 tables)
- **Affected Modules**: CRM, Bench Sales, ATS, Recruiting

## Problem Description

### Current State Issues

1. **Data Duplication**: `accounts` and `vendors` share ~40% of fields (id, org_id, name, status, tier, website, audit fields)
2. **Inconsistent Patterns**: Accounts use separate junction tables, vendors embed preferences as arrays
3. **Limited Enterprise Features**: No MSP program tracking, no versioned rate cards, no compliance tracking
4. **No Hierarchy Support**: Cannot model parent/child corporate structures
5. **Separate Workflows**: Same company cannot be both client AND vendor

### Research Findings

Industry leaders implement:
- **Bullhorn**: ClientCorporation with parent/child hierarchy, MSP/VMS tracking, rate cards
- **Salesforce**: Account object with unlimited hierarchy nesting, roll-up summary fields, account teams
- **Workday**: Object-oriented design with unified data core, in-memory processing
- **HubSpot**: Company object with automatic enrichment, lifecycle stages

## Expected Behavior

A unified `companies` table that:
1. Replaces both `accounts` and `vendors` tables
2. Supports category subtypes: `client`, `vendor`, `partner`, `prospect`
3. Enables same company to have multiple relationships (client + vendor)
4. Provides enterprise features matching industry leaders
5. Maintains backward compatibility via database views

## Proposed Schema Design

### Core Tables (14 total)

| Category | Tables |
|----------|--------|
| Core | `companies` |
| Extensions | `company_client_details`, `company_vendor_details`, `company_partner_details` |
| Financial | `company_rate_cards`, `company_rate_card_items`, `company_revenue` |
| Metrics | `company_health_scores`, `company_metrics` |
| Relationships | `company_team`, `company_contacts`, `company_relationships` |
| Supporting | `company_addresses`, `company_notes`, `company_preferences`, `company_tags` |

> **Note**: Compliance and Contracts are **NOT** in scope for ACCOUNTS-02.
> - **Contracts**: See CONTRACTS-01 - Unified contracts system using `entity_type`/`entity_id` pattern
> - **Compliance**: See COMPLIANCE-01 - Multi-entity compliance tracking system
>
> Companies link to these systems via entity references, not company-specific tables.

### Companies Table Key Fields

```sql
-- Classification
category: 'client' | 'vendor' | 'partner' | 'prospect'
relationship_type: 'direct_client' | 'msp_client' | 'prime_vendor' | 'sub_vendor' | ...
segment: 'enterprise' | 'mid_market' | 'smb' | 'startup'
tier: 'strategic' | 'preferred' | 'standard' | 'transactional'
status: 'active' | 'inactive' | 'on_hold' | 'churned' | 'do_not_use'

-- Hierarchy
parent_company_id: UUID (self-referential)
hierarchy_level: INTEGER
hierarchy_path: TEXT (materialized path for fast queries)

-- MSP/VMS Support
is_msp_program: BOOLEAN
msp_provider_id: UUID
our_msp_tier: INTEGER (1-5)
vms_platform: 'fieldglass' | 'beeline' | 'iqnavigator' | ...
vms_vendor_id: VARCHAR
vms_api_enabled: BOOLEAN

-- Health & Scoring
account_score: INTEGER (0-100)
account_grade: CHAR ('A'-'D')
health_score: INTEGER (0-100)
health_status: 'healthy' | 'at_risk' | 'churning'
churn_risk: INTEGER (0-100)

-- Revenue Tracking (denormalized)
lifetime_revenue: NUMERIC
lifetime_placements: INTEGER
revenue_ytd: NUMERIC
avg_margin_percentage: NUMERIC
```

### Extension Tables (Class Table Inheritance)

**company_client_details** (for category='client'):
- Billing configuration
- Contract-to-hire terms
- QBR settings
- Exclusivity tracking
- Wallet share percentage

**company_vendor_details** (for category='vendor'):
- vendor_type: 'direct_client' | 'prime_vendor' | 'sub_vendor' | 'msp' | 'vms_provider' | 'talent_supplier'
- Industry/geographic focus arrays
- Fill rate tracking
- Payment terms (how fast they pay us)
- Blacklist status
- **Talent supplier tracking** (for bench consultants and recruiting candidates)

**company_partner_details** (for category='partner'):
- Partnership type and tier
- Referral fee structure
- Co-marketing fund

### Rate Cards (Versioned)

> **Note**: Rate cards are also covered in RATES-01 which provides entity-agnostic rate management.
> This section focuses on **company-level** rate card templates (for client pricing agreements).
> RATES-01 handles **placement-level** rate cards (actual rates for specific placements).

```sql
company_rate_cards:
- effective_start_date, effective_end_date
- currency, applicable_regions
- msp_program_id, msp_tier
- default_markup_percentage
- overtime_multiplier, double_time_multiplier
- direct_hire_fee_percentage

company_rate_card_items:
- job_category, job_level, job_family
- min_pay_rate, max_pay_rate, target_pay_rate
- min_bill_rate, max_bill_rate, standard_bill_rate
- target_margin_percentage
```

### Compliance & Contracts Integration

> **DELEGATED**: Company compliance and contracts are managed by their respective systems:
>
> - **COMPLIANCE-01** manages all compliance requirements via polymorphic `entity_compliance` table
> - **CONTRACTS-01** manages all contracts via polymorphic `contracts` table
>
> Companies reference these systems using `entity_type='company'` + `entity_id=company.id`

```sql
-- Example: Get company compliance requirements
SELECT * FROM entity_compliance
WHERE entity_type = 'company' AND entity_id = $company_id;

-- Example: Get company contracts
SELECT * FROM contracts
WHERE entity_type = 'company' AND entity_id = $company_id;
```

### Health Scoring (Multi-dimensional)

```sql
company_health_scores (time-series):
- Engagement Score (30 points): contact recency, response rate, meetings
- Financial Score (30 points): revenue trend, payment timeliness, AR
- Relationship Score (20 points): NPS, satisfaction, escalations
- Opportunity Score (20 points): active jobs, pipeline value, expansion potential
- Risk factors (JSONB)
- Recommended actions (JSONB)
```

### Team Assignment

```sql
company_team:
- role: 'owner' | 'account_manager' | 'recruiter' | 'sales' | 'coordinator' | 'executive_sponsor'
- is_primary: BOOLEAN
- region, job_categories (for large account specialization)
- notify_on_new_job, notify_on_placement, notify_on_activity
```

### Company Relationships

```sql
company_relationships:
- company_a_id, company_b_id
- relationship_category: 'parent_child' | 'msp_client' | 'prime_sub' | 'referral_partner' | 'competitor'
- relationship_direction: 'a_to_b' | 'b_to_a' | 'bidirectional'
- details (JSONB for type-specific data)
```

### Talent/Candidate Supplier Relationship

**Important Clarification**: Companies and Contacts (People) are distinct entities:

```
COMPANIES (Organizations)          CONTACTS (People)
├── Clients (hire talent)          ├── Client POCs (hiring managers)
├── Vendors                        ├── Vendor POCs
│   ├── Prime vendors (job orders) ├── Candidates (talent we represent)
│   ├── Sub vendors                │   ├── Independent contractors
│   └── Talent suppliers ─────────────► From talent supplier companies
├── Partners                       ├── Leads/Prospects
└── Prospects                      └── Employees
```

**Vendor as Talent Supplier**:
- Vendors can supply talent to us (bench consultants, recruiting candidates)
- This talent is represented in `contacts` table as candidates
- The `contacts.source_company_id` links candidate to their originating vendor
- Same vendor can provide BOTH job orders AND talent

**Contact-Company Relationships**:
```sql
contacts:
  source_company_id UUID  -- Vendor that supplied this candidate (if C2C/bench)
  employer_company_id UUID -- Current/previous employer

company_contacts (junction):
  company_id UUID   -- The company
  contact_id UUID   -- The person
  role_type: 'poc' | 'hiring_manager' | 'candidate_source' | 'employee'
```

## Migration Strategy

1. Create new tables (non-breaking)
2. Migrate `accounts` data → `companies` (category='client')
3. Migrate `vendors` data → `companies` (category='vendor')
4. Update FKs in jobs, placements, deals, submissions
5. Create backward compatibility views (`accounts`, `vendors`)
6. Deprecate old tables after validation

## Acceptance Criteria

### Schema Implementation
- [ ] Create `companies` table with all category/classification fields
- [ ] Create `company_client_details` extension table
- [ ] Create `company_vendor_details` extension table
- [ ] Create `company_partner_details` extension table
- [ ] Create `company_rate_cards` and `company_rate_card_items` tables
- [ ] Create `company_health_scores` table (time-series)
- [ ] Create `company_metrics` table (time-series)
- [ ] Create `company_revenue` table
- [ ] Create `company_team` table
- [ ] Create `company_contacts` junction table
- [ ] Create `company_relationships` table
- [ ] Create `company_addresses` junction table (using centralized addresses)
- [ ] Create `company_notes` table
- [ ] Create `company_preferences` table
- [ ] Create `company_tags` table
- [ ] Add all required indexes (org_id, category, status, hierarchy, health, search)
- [ ] Add search_vector trigger for full-text search

> **NOT in scope** (see separate issues):
> - `company_contracts` → CONTRACTS-01 (polymorphic contracts system)
> - `company_compliance_requirements` → COMPLIANCE-01 (polymorphic compliance system)

### Hierarchy Support
- [ ] Parent/child self-referential FK working
- [ ] hierarchy_path materialized path populated correctly
- [ ] Revenue roll-up queries functional via hierarchy

### MSP/VMS Support
- [ ] MSP program tracking fields functional
- [ ] VMS platform configuration fields functional
- [ ] Vendor tier tracking within MSP programs

### Rate Cards
- [ ] Versioned rate cards with effective dates
- [ ] Only one active rate card per company constraint
- [ ] Job orders can lock to specific rate card version

### Health Scoring
- [ ] Multi-dimensional health score calculation
- [ ] Time-series history preserved
- [ ] Risk factors and recommendations populated

### Talent Supplier Support
- [ ] `talent_supplier` vendor type supported
- [ ] `contacts.source_company_id` links candidates to supplier vendor
- [ ] Vendor can have multiple types (job orders + talent supply)
- [ ] Bench consultant tracking via vendor relationship
- [ ] Talent supplier performance metrics (candidates supplied, placement rate)

### Data Migration
- [ ] All accounts migrated to companies (category='client')
- [ ] All vendors migrated to companies (category='vendor')
- [ ] Related data (contracts, notes, addresses) migrated
- [ ] FK references updated in jobs, placements, deals, submissions

### Backward Compatibility
- [ ] `accounts` view returns client/prospect companies
- [ ] `vendors` view returns vendor companies
- [ ] Existing tRPC procedures continue working via views
- [ ] No breaking changes to frontend during transition

### Frontend Updates
- [ ] Entity config updated for unified companies
- [ ] List views support category filtering
- [ ] Detail views show category-specific sections
- [ ] Rate card management UI
- [ ] Compliance requirements UI
- [ ] Health score dashboard

### Testing
- [ ] Migration scripts tested on staging
- [ ] All existing tests pass
- [ ] New tests for hierarchy queries
- [ ] New tests for rate card versioning
- [ ] New tests for health score calculation
- [ ] Performance benchmarks for large datasets

---

## Research Sources

### Platforms Analyzed
- **Bullhorn** (Market leader for staffing ATS/CRM)
- **Salesforce** (Enterprise CRM account model)
- **Workday** (HCM + Recruiting unified platform)
- **HubSpot** (Company object and lifecycle)
- **SAP SuccessFactors** (Recruiting + HCM)
- **Monday.com, ClickUp, Airtable** (Unified platform patterns)

### Key Patterns Applied
- **Class Table Inheritance**: Base `companies` + extension tables per category
- **Polymorphic Associations**: Only for activities/notes/documents (not business FKs)
- **Hybrid JSONB**: Normalize hot fields, JSONB for preferences/custom fields
- **Time-Series Metrics**: Separate snapshot tables for historical tracking
- **Materialized Hierarchy Path**: Fast queries for parent/child traversal
- **Versioned Rate Cards**: Effective dates, job orders lock to specific version

### Industry-Specific Features
- MSP (Managed Service Provider) program tracking
- VMS (Vendor Management System) integration fields
- Prime vendor / sub-vendor relationship modeling
- Client vs end-client distinction for placements
- Per-company compliance requirements
- Rate card management with job category/level granularity

---

## Notes

This design follows the same pattern as the recent contacts centralization work:
- Single source of truth table with category discriminator
- Extension tables for category-specific fields
- Junction tables for relationships
- Centralized addresses via existing pattern
- Polymorphic only for generic entities (activities, notes, documents)

The 18-table design provides enterprise-grade features while maintaining clean separation of concerns and backward compatibility during migration.
