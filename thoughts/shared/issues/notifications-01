# ISSUE: Define Notification System

**Issue ID:** NOTIFICATIONS-01
**Created:** 2025-12-11
**Status:** Open
**Priority:** High
**Type:** Feature/New System
**Reporter:** System (Architecture Review)
**Depends On:** CONTACTS-01 (unified contacts)

---

## Summary

Define a comprehensive notification system for managing all user notifications across channels (in-app, email, SMS, push). While a basic `notifications.ts` router exists, there is no comprehensive schema for notification templates, user preferences, delivery tracking, and channel management. This issue creates an enterprise-grade notification infrastructure.

## Location

- **New Tables**: `notification_templates`, `notification_preferences`, `notifications`, `notification_delivery_log`, `notification_channels`, `notification_digests`
- **Related Tables**: `user_profiles`, `contacts`, `organizations`
- **Affected Modules**: All (notifications are cross-cutting)

## Problem Description

### Current State

A basic notifications router exists but lacks:

1. **No Template System**: No reusable notification templates
2. **No Preference Management**: Users cannot control notification preferences
3. **No Multi-Channel**: Only in-app notifications, no email/SMS/push
4. **No Delivery Tracking**: No way to track if notifications were delivered
5. **No Digest Support**: No daily/weekly digests
6. **No Channel Configuration**: No way to configure email senders, SMS providers

### Business Requirements

Enterprise notification systems require:
- Templated notifications with variable substitution
- User preference management per notification type and channel
- Multi-channel delivery (in-app, email, SMS, push)
- Delivery tracking and retry logic
- Digest/batch notifications
- Organization-level notification configuration
- External contact notifications (clients, candidates)

## Proposed Schema Design

### Notification Templates Table

```sql
CREATE TABLE notification_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID REFERENCES organizations(id),  -- NULL for system templates
  
  -- Identity
  template_code VARCHAR NOT NULL,  -- 'INTERVIEW_SCHEDULED', 'TIMESHEET_REMINDER'
  template_name VARCHAR NOT NULL,
  description TEXT,
  
  -- Category
  category VARCHAR NOT NULL,  -- 'recruiting', 'operations', 'crm', 'system', 'admin'
  notification_type VARCHAR NOT NULL,  -- 'transactional', 'reminder', 'alert', 'digest', 'marketing'
  
  -- Priority
  priority VARCHAR DEFAULT 'normal',  -- 'urgent', 'high', 'normal', 'low'
  
  -- Available channels
  available_channels JSONB NOT NULL DEFAULT '["in_app"]',
  -- ['in_app', 'email', 'sms', 'push', 'slack', 'teams']
  
  -- Default channels (if user has no preference set)
  default_channels JSONB NOT NULL DEFAULT '["in_app"]',
  
  -- In-App content
  in_app_title_template VARCHAR,
  in_app_body_template TEXT,
  in_app_icon VARCHAR,  -- Icon name or URL
  in_app_action_url_template VARCHAR,  -- URL pattern with {{variables}}
  in_app_action_label VARCHAR,
  
  -- Email content
  email_subject_template VARCHAR,
  email_html_template TEXT,
  email_text_template TEXT,
  email_from_name_template VARCHAR,
  email_reply_to VARCHAR,
  
  -- SMS content
  sms_body_template TEXT,
  
  -- Push notification
  push_title_template VARCHAR,
  push_body_template TEXT,
  push_icon_url VARCHAR,
  push_click_url_template VARCHAR,
  
  -- Slack/Teams
  slack_message_template JSONB,  -- Slack block kit format
  teams_message_template JSONB,  -- Adaptive card format
  
  -- Variables
  required_variables JSONB,  -- ['user_name', 'job_title', 'interview_date']
  optional_variables JSONB,
  
  -- Digest configuration (if notification_type = 'digest')
  digest_aggregation_key VARCHAR,  -- Field to group by
  digest_template JSONB,  -- How to format multiple items
  
  -- Triggers
  trigger_event VARCHAR,  -- Event name that triggers this notification
  trigger_conditions JSONB,  -- Conditions to check before sending
  
  -- Status
  is_active BOOLEAN DEFAULT true,
  is_default BOOLEAN DEFAULT false,  -- Default template for template_code
  
  -- Audit
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  created_by UUID REFERENCES user_profiles(id),
  
  CONSTRAINT template_code_unique UNIQUE (org_id, template_code)
);

CREATE INDEX idx_notification_templates_code ON notification_templates(template_code) WHERE is_active = true;
CREATE INDEX idx_notification_templates_trigger ON notification_templates(trigger_event) WHERE is_active = true;
```

### Notification Preferences Table

```sql
CREATE TABLE notification_preferences (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  
  -- Who this preference is for
  user_id UUID REFERENCES user_profiles(id),  -- Internal user
  contact_id UUID REFERENCES contacts(id),  -- External contact (candidate, client)
  
  -- Preference scope
  template_code VARCHAR,  -- Specific template, or NULL for category
  category VARCHAR,  -- Category preference if template_code is NULL
  
  -- Channel preferences
  in_app_enabled BOOLEAN DEFAULT true,
  email_enabled BOOLEAN DEFAULT true,
  sms_enabled BOOLEAN DEFAULT false,
  push_enabled BOOLEAN DEFAULT false,
  slack_enabled BOOLEAN DEFAULT false,
  teams_enabled BOOLEAN DEFAULT false,
  
  -- Frequency preferences
  frequency VARCHAR DEFAULT 'instant',  -- 'instant', 'hourly', 'daily', 'weekly'
  
  -- Time preferences (for non-instant)
  preferred_hour INTEGER,  -- Hour in user's timezone
  preferred_day INTEGER,  -- Day of week for weekly (0=Sunday)
  
  -- Quiet hours
  quiet_hours_enabled BOOLEAN DEFAULT false,
  quiet_hours_start TIME,
  quiet_hours_end TIME,
  quiet_hours_timezone VARCHAR,
  
  -- Unsubscribe
  unsubscribed BOOLEAN DEFAULT false,
  unsubscribed_at TIMESTAMPTZ,
  unsubscribe_reason TEXT,
  
  -- Audit
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  
  CONSTRAINT preference_owner CHECK (
    (user_id IS NOT NULL AND contact_id IS NULL) OR
    (user_id IS NULL AND contact_id IS NOT NULL)
  )
);

CREATE INDEX idx_notification_preferences_user ON notification_preferences(user_id) WHERE user_id IS NOT NULL;
CREATE INDEX idx_notification_preferences_contact ON notification_preferences(contact_id) WHERE contact_id IS NOT NULL;
CREATE UNIQUE INDEX idx_notification_preferences_unique 
ON notification_preferences(COALESCE(user_id, '00000000-0000-0000-0000-000000000000'), 
                           COALESCE(contact_id, '00000000-0000-0000-0000-000000000000'),
                           COALESCE(template_code, ''), 
                           COALESCE(category, ''));
```

### Notifications Table (Outbox)

```sql
CREATE TABLE notifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  
  -- Notification identity
  notification_uid VARCHAR GENERATED ALWAYS AS (
    'NTF-' || id::VARCHAR
  ) STORED,
  
  -- Template reference
  template_id UUID REFERENCES notification_templates(id),
  template_code VARCHAR NOT NULL,
  
  -- Recipient
  recipient_type VARCHAR NOT NULL,  -- 'user', 'contact'
  recipient_user_id UUID REFERENCES user_profiles(id),
  recipient_contact_id UUID REFERENCES contacts(id),
  recipient_email VARCHAR,  -- Denormalized for quick access
  recipient_phone VARCHAR,  -- For SMS
  
  -- Context
  entity_type VARCHAR,  -- 'job', 'submission', 'interview', etc.
  entity_id UUID,
  related_entity_type VARCHAR,  -- Secondary entity
  related_entity_id UUID,
  
  -- Content (rendered from template)
  title VARCHAR NOT NULL,
  body TEXT NOT NULL,
  body_html TEXT,
  action_url VARCHAR,
  action_label VARCHAR,
  
  -- Metadata
  metadata JSONB,  -- Original variables passed to template
  
  -- Priority and category
  priority VARCHAR DEFAULT 'normal',
  category VARCHAR,
  
  -- Channels to deliver to
  channels JSONB NOT NULL DEFAULT '["in_app"]',
  
  -- Status
  status VARCHAR DEFAULT 'pending',
  /* Status values:
     'pending' - Not yet processed
     'processing' - Being processed
     'delivered' - Delivered on at least one channel
     'failed' - All delivery attempts failed
     'cancelled' - Cancelled before delivery
     'expired' - Expired without delivery
  */
  
  -- In-app status
  in_app_created_at TIMESTAMPTZ,
  in_app_read_at TIMESTAMPTZ,
  in_app_clicked_at TIMESTAMPTZ,
  in_app_dismissed_at TIMESTAMPTZ,
  
  -- Expiration
  expires_at TIMESTAMPTZ,
  
  -- Digest grouping
  digest_group_key VARCHAR,
  digest_batch_id UUID,
  is_digest_member BOOLEAN DEFAULT false,
  
  -- Audit
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  created_by UUID REFERENCES user_profiles(id),
  deleted_at TIMESTAMPTZ,
  
  CONSTRAINT recipient_check CHECK (
    (recipient_type = 'user' AND recipient_user_id IS NOT NULL) OR
    (recipient_type = 'contact' AND recipient_contact_id IS NOT NULL)
  )
);

-- Indexes
CREATE INDEX idx_notifications_recipient_user ON notifications(recipient_user_id) 
WHERE recipient_user_id IS NOT NULL AND deleted_at IS NULL;
CREATE INDEX idx_notifications_recipient_contact ON notifications(recipient_contact_id) 
WHERE recipient_contact_id IS NOT NULL AND deleted_at IS NULL;
CREATE INDEX idx_notifications_status ON notifications(status) WHERE deleted_at IS NULL;
CREATE INDEX idx_notifications_pending ON notifications(created_at) 
WHERE status = 'pending' AND deleted_at IS NULL;
CREATE INDEX idx_notifications_unread ON notifications(recipient_user_id, in_app_read_at) 
WHERE in_app_read_at IS NULL AND deleted_at IS NULL;
CREATE INDEX idx_notifications_entity ON notifications(entity_type, entity_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_notifications_digest ON notifications(digest_group_key, created_at) 
WHERE is_digest_member = true;
```

### Notification Delivery Log Table

```sql
CREATE TABLE notification_delivery_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  notification_id UUID NOT NULL REFERENCES notifications(id) ON DELETE CASCADE,
  
  -- Channel
  channel VARCHAR NOT NULL,  -- 'in_app', 'email', 'sms', 'push', 'slack', 'teams'
  
  -- Delivery status
  status VARCHAR NOT NULL,
  /* Status values:
     'pending' - Queued for delivery
     'sent' - Sent to provider
     'delivered' - Confirmed delivery
     'opened' - Email opened / Push clicked
     'clicked' - Link clicked
     'bounced' - Email bounced
     'failed' - Delivery failed
     'unsubscribed' - Triggered unsubscribe
  */
  
  -- Timing
  queued_at TIMESTAMPTZ DEFAULT now(),
  sent_at TIMESTAMPTZ,
  delivered_at TIMESTAMPTZ,
  opened_at TIMESTAMPTZ,
  clicked_at TIMESTAMPTZ,
  failed_at TIMESTAMPTZ,
  
  -- Provider details
  provider VARCHAR,  -- 'sendgrid', 'twilio', 'firebase', 'slack_api'
  provider_message_id VARCHAR,  -- External message ID
  
  -- Retry tracking
  attempt_count INTEGER DEFAULT 0,
  max_attempts INTEGER DEFAULT 3,
  next_retry_at TIMESTAMPTZ,
  last_error TEXT,
  
  -- For email
  email_from VARCHAR,
  email_to VARCHAR,
  email_subject VARCHAR,
  
  -- For SMS
  sms_from VARCHAR,
  sms_to VARCHAR,
  
  -- Response data
  response_data JSONB,  -- Provider response
  
  -- Audit
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL
);

CREATE INDEX idx_delivery_log_notification ON notification_delivery_log(notification_id);
CREATE INDEX idx_delivery_log_channel ON notification_delivery_log(channel, status);
CREATE INDEX idx_delivery_log_retry ON notification_delivery_log(next_retry_at) 
WHERE status = 'pending' AND attempt_count < max_attempts;
CREATE INDEX idx_delivery_log_provider ON notification_delivery_log(provider, provider_message_id);
```

### Notification Channels Configuration Table

```sql
CREATE TABLE notification_channels (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  
  -- Channel identity
  channel_type VARCHAR NOT NULL,  -- 'email', 'sms', 'push', 'slack', 'teams'
  channel_name VARCHAR NOT NULL,
  
  -- Provider configuration
  provider VARCHAR NOT NULL,  -- 'sendgrid', 'mailgun', 'twilio', 'firebase'
  
  -- Credentials (encrypted)
  credentials JSONB,  -- Encrypted API keys, etc.
  
  -- Email specific
  email_from_address VARCHAR,
  email_from_name VARCHAR,
  email_reply_to VARCHAR,
  email_domain VARCHAR,
  
  -- SMS specific
  sms_from_number VARCHAR,
  sms_messaging_service_id VARCHAR,
  
  -- Push specific
  push_vapid_public_key VARCHAR,
  push_vapid_private_key VARCHAR,
  
  -- Slack specific
  slack_webhook_url VARCHAR,
  slack_bot_token VARCHAR,
  slack_channel_id VARCHAR,
  
  -- Teams specific
  teams_webhook_url VARCHAR,
  
  -- Rate limits
  rate_limit_per_second INTEGER,
  rate_limit_per_day INTEGER,
  
  -- Status
  is_active BOOLEAN DEFAULT true,
  is_default BOOLEAN DEFAULT false,
  
  -- Testing
  is_test_mode BOOLEAN DEFAULT false,
  test_recipient VARCHAR,  -- Where to send test notifications
  
  -- Health check
  last_health_check_at TIMESTAMPTZ,
  health_status VARCHAR,  -- 'healthy', 'degraded', 'down'
  
  -- Audit
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  created_by UUID REFERENCES user_profiles(id)
);

CREATE INDEX idx_notification_channels_type ON notification_channels(org_id, channel_type) WHERE is_active = true;
CREATE UNIQUE INDEX idx_notification_channels_default ON notification_channels(org_id, channel_type) 
WHERE is_default = true AND is_active = true;
```

### Notification Digests Table

```sql
CREATE TABLE notification_digests (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  
  -- Recipient
  recipient_user_id UUID REFERENCES user_profiles(id),
  recipient_contact_id UUID REFERENCES contacts(id),
  
  -- Digest period
  digest_type VARCHAR NOT NULL,  -- 'hourly', 'daily', 'weekly'
  period_start TIMESTAMPTZ NOT NULL,
  period_end TIMESTAMPTZ NOT NULL,
  
  -- Content
  notification_count INTEGER DEFAULT 0,
  notification_ids UUID[],
  
  -- Summary content
  summary_title VARCHAR,
  summary_body TEXT,
  summary_html TEXT,
  
  -- Status
  status VARCHAR DEFAULT 'pending',  -- 'pending', 'sent', 'cancelled'
  
  -- Delivery
  sent_at TIMESTAMPTZ,
  delivery_log_id UUID REFERENCES notification_delivery_log(id),
  
  -- Audit
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL
);

CREATE INDEX idx_notification_digests_user ON notification_digests(recipient_user_id) 
WHERE recipient_user_id IS NOT NULL;
CREATE INDEX idx_notification_digests_pending ON notification_digests(period_end) 
WHERE status = 'pending';
```

## Standard Notification Templates

```sql
-- Seed standard notification templates
INSERT INTO notification_templates (
  template_code, template_name, category, notification_type, priority,
  available_channels, default_channels,
  in_app_title_template, in_app_body_template, in_app_action_url_template,
  email_subject_template, email_html_template,
  trigger_event, required_variables
) VALUES
-- Recruiting notifications
('INTERVIEW_SCHEDULED', 'Interview Scheduled', 'recruiting', 'transactional', 'high',
 '["in_app", "email"]', '["in_app", "email"]',
 'Interview Scheduled: {{candidate_name}}',
 'Interview with {{candidate_name}} for {{job_title}} scheduled for {{interview_date}} at {{interview_time}}.',
 '/recruiting/interviews/{{interview_id}}',
 'Interview Scheduled: {{candidate_name}} for {{job_title}}',
 '<p>An interview has been scheduled...</p>',
 'interview.scheduled', '["candidate_name", "job_title", "interview_date", "interview_time", "interview_id"]'),

('INTERVIEW_REMINDER', 'Interview Reminder', 'recruiting', 'reminder', 'high',
 '["in_app", "email", "sms"]', '["in_app", "email"]',
 'Reminder: Interview in {{time_until}}',
 'Your interview with {{candidate_name}} for {{job_title}} starts in {{time_until}}.',
 '/recruiting/interviews/{{interview_id}}',
 'Interview Reminder: {{candidate_name}} in {{time_until}}',
 '<p>Reminder: Your interview is coming up...</p>',
 'interview.reminder', '["candidate_name", "job_title", "time_until", "interview_id"]'),

-- Operations notifications
('TIMESHEET_REMINDER', 'Timesheet Submission Reminder', 'operations', 'reminder', 'normal',
 '["in_app", "email"]', '["in_app", "email"]',
 'Submit Your Timesheet',
 'Please submit your timesheet for the period {{period_start}} - {{period_end}}.',
 '/timesheets/new',
 'Timesheet Reminder: {{period_start}} - {{period_end}}',
 '<p>Please submit your timesheet...</p>',
 'timesheet.reminder', '["period_start", "period_end"]'),

('TIMESHEET_APPROVED', 'Timesheet Approved', 'operations', 'transactional', 'normal',
 '["in_app", "email"]', '["in_app"]',
 'Timesheet Approved',
 'Your timesheet for {{period_start}} - {{period_end}} has been approved.',
 '/timesheets/{{timesheet_id}}',
 'Timesheet Approved: {{period_start}} - {{period_end}}',
 '<p>Your timesheet has been approved...</p>',
 'timesheet.approved', '["period_start", "period_end", "timesheet_id"]'),

('TIMESHEET_REJECTED', 'Timesheet Rejected', 'operations', 'transactional', 'high',
 '["in_app", "email"]', '["in_app", "email"]',
 'Timesheet Rejected - Action Required',
 'Your timesheet for {{period_start}} - {{period_end}} was rejected. Reason: {{rejection_reason}}',
 '/timesheets/{{timesheet_id}}',
 'Timesheet Rejected: Action Required',
 '<p>Your timesheet was rejected...</p>',
 'timesheet.rejected', '["period_start", "period_end", "timesheet_id", "rejection_reason"]'),

-- CRM notifications
('LEAD_ASSIGNED', 'Lead Assigned', 'crm', 'transactional', 'normal',
 '["in_app"]', '["in_app"]',
 'New Lead Assigned: {{lead_name}}',
 'A new lead has been assigned to you: {{lead_name}} from {{company_name}}.',
 '/crm/leads/{{lead_id}}',
 NULL, NULL,
 'lead.assigned', '["lead_name", "company_name", "lead_id"]'),

-- System notifications
('DAILY_DIGEST', 'Daily Activity Digest', 'system', 'digest', 'low',
 '["email"]', '["email"]',
 NULL, NULL, NULL,
 'Your Daily Digest - {{date}}',
 '<p>Here is your daily summary...</p>',
 'digest.daily', '["date"]');
```

## Acceptance Criteria

### Schema Implementation
- [ ] Create `notification_templates` table
- [ ] Create `notification_preferences` table
- [ ] Create `notifications` table
- [ ] Create `notification_delivery_log` table
- [ ] Create `notification_channels` table
- [ ] Create `notification_digests` table
- [ ] Seed standard notification templates
- [ ] All indexes created
- [ ] RLS policies enforced

### Notification Flow
- [ ] Template rendering with variable substitution
- [ ] Preference checking before send
- [ ] Multi-channel delivery
- [ ] Delivery tracking
- [ ] Retry logic for failures
- [ ] Quiet hours respect

### Preference Management
- [ ] User preference CRUD
- [ ] Per-template preferences
- [ ] Per-category preferences
- [ ] Channel enable/disable
- [ ] Unsubscribe handling

### Channels
- [ ] In-app notifications working
- [ ] Email delivery working
- [ ] SMS delivery working (optional)
- [ ] Push notifications working (optional)
- [ ] Slack integration (optional)

### Frontend Requirements
- [ ] Notification bell with unread count
- [ ] Notification dropdown/panel
- [ ] Notification center page
- [ ] Preference settings page
- [ ] Mark as read/unread
- [ ] Clear all functionality

---

## Technical Context

### Notification Flow

```
┌──────────────┐    ┌───────────────┐    ┌──────────────┐
│   Trigger    │───►│   Template    │───►│  Preferences │
│   (Event)    │    │   Lookup      │    │    Check     │
└──────────────┘    └───────────────┘    └──────────────┘
                                                │
                                                ▼
┌──────────────┐    ┌───────────────┐    ┌──────────────┐
│   Delivery   │◄───│   Render      │◄───│   Create     │
│   (Channel)  │    │   Content     │    │ Notification │
└──────────────┘    └───────────────┘    └──────────────┘
       │
       ▼
┌──────────────┐
│   Log        │
│   Tracking   │
└──────────────┘
```

### Event Integration

```typescript
// When an interview is scheduled, trigger notification
eventBus.emit('interview.scheduled', {
  interviewId: interview.id,
  candidateName: candidate.name,
  jobTitle: job.title,
  interviewDate: interview.scheduledAt,
  interviewers: interview.participants
});

// Notification service listens and creates notifications
notificationService.on('interview.scheduled', async (data) => {
  const template = await getTemplate('INTERVIEW_SCHEDULED');
  const recipients = await getRecipients(data);
  
  for (const recipient of recipients) {
    const prefs = await getPreferences(recipient, template);
    if (prefs.enabled) {
      await createNotification(template, recipient, data, prefs.channels);
    }
  }
});
```

---

## Notes

This system is **critical for user engagement**:

1. **User Awareness**: Keep users informed of relevant events
2. **Action Prompts**: Drive users to take necessary actions
3. **Preference Control**: Users control their notification experience
4. **Multi-Channel**: Reach users where they prefer
5. **Reliability**: Delivery tracking and retry ensures messages get through
6. **Scalability**: Batch processing and digests reduce notification fatigue

---

## Index Strategy

```sql
-- notification_templates indexes
CREATE INDEX idx_notification_templates_org ON notification_templates(org_id) WHERE is_active = true;
CREATE INDEX idx_notification_templates_code ON notification_templates(template_code) WHERE is_active = true;
CREATE INDEX idx_notification_templates_trigger ON notification_templates(trigger_event) WHERE is_active = true;
CREATE INDEX idx_notification_templates_category ON notification_templates(category) WHERE is_active = true;

-- notification_preferences indexes
CREATE INDEX idx_notification_preferences_user ON notification_preferences(user_id) WHERE user_id IS NOT NULL;
CREATE INDEX idx_notification_preferences_contact ON notification_preferences(contact_id) WHERE contact_id IS NOT NULL;
CREATE INDEX idx_notification_preferences_template ON notification_preferences(template_code) WHERE template_code IS NOT NULL;

-- notifications indexes
CREATE INDEX idx_notifications_org ON notifications(org_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_notifications_recipient_user ON notifications(recipient_user_id) WHERE recipient_user_id IS NOT NULL AND deleted_at IS NULL;
CREATE INDEX idx_notifications_recipient_contact ON notifications(recipient_contact_id) WHERE recipient_contact_id IS NOT NULL AND deleted_at IS NULL;
CREATE INDEX idx_notifications_status ON notifications(status) WHERE deleted_at IS NULL;
CREATE INDEX idx_notifications_pending ON notifications(created_at) WHERE status = 'pending' AND deleted_at IS NULL;
CREATE INDEX idx_notifications_unread ON notifications(recipient_user_id, in_app_read_at) WHERE in_app_read_at IS NULL AND deleted_at IS NULL;
CREATE INDEX idx_notifications_entity ON notifications(entity_type, entity_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_notifications_digest ON notifications(digest_group_key, created_at) WHERE is_digest_member = true;

-- notification_delivery_log indexes
CREATE INDEX idx_delivery_log_notification ON notification_delivery_log(notification_id);
CREATE INDEX idx_delivery_log_channel ON notification_delivery_log(channel, status);
CREATE INDEX idx_delivery_log_retry ON notification_delivery_log(next_retry_at) WHERE status = 'pending' AND attempt_count < max_attempts;
CREATE INDEX idx_delivery_log_provider ON notification_delivery_log(provider, provider_message_id);

-- notification_channels indexes
CREATE INDEX idx_notification_channels_org ON notification_channels(org_id) WHERE is_active = true;
CREATE INDEX idx_notification_channels_type ON notification_channels(org_id, channel_type) WHERE is_active = true;

-- notification_digests indexes
CREATE INDEX idx_notification_digests_user ON notification_digests(recipient_user_id) WHERE recipient_user_id IS NOT NULL;
CREATE INDEX idx_notification_digests_pending ON notification_digests(period_end) WHERE status = 'pending';
```

---

## RLS Policies

```sql
-- notification_templates table RLS
ALTER TABLE notification_templates ENABLE ROW LEVEL SECURITY;

CREATE POLICY "notification_templates_org_or_system" ON notification_templates
  FOR SELECT USING (org_id IS NULL OR org_id = auth.org_id());

CREATE POLICY "notification_templates_org_modify" ON notification_templates
  FOR ALL USING (org_id = auth.org_id());

-- notification_preferences table RLS
ALTER TABLE notification_preferences ENABLE ROW LEVEL SECURITY;

CREATE POLICY "notification_preferences_org_isolation" ON notification_preferences
  FOR ALL USING (org_id = auth.org_id());

CREATE POLICY "notification_preferences_user_own" ON notification_preferences
  FOR ALL USING (user_id = auth.uid());

-- notifications table RLS
ALTER TABLE notifications ENABLE ROW LEVEL SECURITY;

CREATE POLICY "notifications_org_isolation" ON notifications
  FOR ALL USING (org_id = auth.org_id());

CREATE POLICY "notifications_recipient_own" ON notifications
  FOR SELECT USING (recipient_user_id = auth.uid());

-- notification_delivery_log table RLS
ALTER TABLE notification_delivery_log ENABLE ROW LEVEL SECURITY;

CREATE POLICY "delivery_log_org_isolation" ON notification_delivery_log
  FOR ALL USING (org_id = auth.org_id());

-- notification_channels table RLS
ALTER TABLE notification_channels ENABLE ROW LEVEL SECURITY;

CREATE POLICY "notification_channels_org_isolation" ON notification_channels
  FOR ALL USING (org_id = auth.org_id());

-- notification_digests table RLS
ALTER TABLE notification_digests ENABLE ROW LEVEL SECURITY;

CREATE POLICY "notification_digests_org_isolation" ON notification_digests
  FOR ALL USING (org_id = auth.org_id());
```

---

## Rollback Plan

### Schema Rollback
```sql
-- Drop in reverse order
DROP TABLE IF EXISTS notification_digests;
DROP TABLE IF EXISTS notification_channels;
DROP TABLE IF EXISTS notification_delivery_log;
DROP TABLE IF EXISTS notifications;
DROP TABLE IF EXISTS notification_preferences;
DROP TABLE IF EXISTS notification_templates;
```

### Full Rollback Procedure
1. Stop application deployments
2. Stop notification worker/queue processors
3. Execute schema rollback SQL
4. Restore tRPC router to previous git commit
5. Restore UI components (notification bell, preferences) to previous git commit
6. Disable notification triggers in event system
7. Document incident and root cause

### Data Preservation
```sql
-- Before rollback, export pending notifications
COPY (
  SELECT * FROM notifications 
  WHERE status = 'pending'
) TO '/tmp/pending_notifications_backup.csv' WITH CSV HEADER;
```
