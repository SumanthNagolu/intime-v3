# ISSUE: Define Invoicing System

**Issue ID:** INVOICES-01
**Created:** 2025-12-11
**Status:** Open
**Priority:** Critical
**Type:** Feature/New System
**Reporter:** System (Architecture Review)
**Depends On:** TIMESHEETS-01 (timesheet system), PLACEMENTS-01 (placements), ACCOUNTS-02 (unified companies), RATES-01 (entity_rates), DOCS-01 (invoice PDF storage)

---

## Summary

Define a comprehensive invoicing system for generating client invoices from approved timesheets, managing payment tracking, and integrating with accounting systems. This is a **new system** that does not exist in the current schema but is **critical for revenue operations** - invoices are how staffing companies collect revenue from clients.

## Location

- **New Tables**: `invoices`, `invoice_line_items`, `invoice_payments`, `invoice_templates`, `payment_terms`, `invoice_batches`
- **Related Tables**: `timesheets`, `placements`, `companies`, `contacts`
- **Affected Modules**: Finance, Billing, Operations

## Problem Description

### Current State

No formal invoicing system exists in the current schema. This gap means:

1. **No Invoice Generation**: Cannot create invoices from timesheets
2. **No Payment Tracking**: Cannot track payments received
3. **No AR Management**: Cannot manage accounts receivable
4. **No Integration Points**: No data for accounting system exports
5. **No Credit Tracking**: Cannot track credits/adjustments

### Business Requirements

Staffing companies require:
- Invoice generation from approved timesheets
- Support for multiple billing arrangements (time & materials, fixed fee, retainer)
- Client-specific billing terms and templates
- Multi-currency support
- Payment tracking and reconciliation
- Aging reports and collection management
- Integration with QuickBooks/Xero/NetSuite
- Credit notes and adjustments

## Proposed Schema Design

### Invoices Table (Main Record)

```sql
CREATE TABLE invoices (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  
  -- Invoice identity
  invoice_number VARCHAR NOT NULL,
  invoice_display_number VARCHAR,  -- Formatted for display (e.g., "INV-2024-001234")
  
  -- Client billing
  bill_to_company_id UUID NOT NULL REFERENCES companies(id),
  bill_to_contact_id UUID REFERENCES contacts(id),  -- Billing contact
  
  -- Billing address (snapshot at invoice time)
  billing_address JSONB,
  /* {
    "line1": "123 Main St",
    "line2": "Suite 400",
    "city": "Houston",
    "state": "TX",
    "postal_code": "77002",
    "country": "US"
  } */
  
  -- Invoice type
  invoice_type VARCHAR NOT NULL DEFAULT 'standard',
  /* Types:
     'standard' - Regular timesheet-based invoice
     'fixed_fee' - Fixed fee project invoice
     'retainer' - Monthly retainer invoice
     'milestone' - Milestone-based invoice
     'credit_note' - Credit/adjustment
     'final' - Final invoice for placement
  */
  
  -- Period
  period_start DATE,
  period_end DATE,
  
  -- Status
  status VARCHAR NOT NULL DEFAULT 'draft',
  /* Status values:
     'draft' - Being prepared
     'pending_approval' - Awaiting internal approval
     'approved' - Approved, ready to send
     'sent' - Sent to client
     'viewed' - Client viewed invoice
     'partial' - Partially paid
     'paid' - Fully paid
     'overdue' - Past due date
     'disputed' - Client disputed
     'void' - Voided invoice
     'written_off' - Written off as bad debt
  */
  
  -- Dates
  invoice_date DATE NOT NULL,
  due_date DATE NOT NULL,
  sent_at TIMESTAMPTZ,
  paid_at TIMESTAMPTZ,
  
  -- Currency
  currency VARCHAR NOT NULL DEFAULT 'USD',
  exchange_rate NUMERIC(10,6) DEFAULT 1,
  
  -- Amounts
  subtotal NUMERIC(15,2) NOT NULL DEFAULT 0,
  discount_amount NUMERIC(15,2) DEFAULT 0,
  discount_percentage NUMERIC(5,2),
  discount_reason TEXT,
  tax_amount NUMERIC(15,2) DEFAULT 0,
  tax_rate NUMERIC(5,2),
  total_amount NUMERIC(15,2) NOT NULL DEFAULT 0,
  
  -- Payment tracking
  amount_paid NUMERIC(15,2) DEFAULT 0,
  amount_due NUMERIC(15,2) GENERATED ALWAYS AS (total_amount - amount_paid) STORED,
  
  -- Payment terms
  payment_terms_id UUID REFERENCES payment_terms(id),
  payment_terms_days INTEGER DEFAULT 30,
  payment_terms_text VARCHAR,  -- "Net 30", "Due on Receipt"
  
  -- Remittance
  remittance_instructions TEXT,
  payment_methods_accepted JSONB,  -- ['ach', 'wire', 'check', 'credit_card']
  
  -- Reference information
  client_po_number VARCHAR,
  client_reference VARCHAR,
  project_code VARCHAR,
  cost_center VARCHAR,
  
  -- Notes
  notes TEXT,  -- Internal notes
  client_notes TEXT,  -- Notes visible to client
  terms_and_conditions TEXT,
  
  -- Template
  template_id UUID REFERENCES invoice_templates(id),
  
  -- Batch processing
  batch_id UUID REFERENCES invoice_batches(id),
  
  -- Document
  pdf_document_id UUID REFERENCES documents(id),
  pdf_generated_at TIMESTAMPTZ,
  
  -- Collection tracking
  collection_status VARCHAR DEFAULT 'current',  -- 'current', 'follow_up', 'escalated', 'collection'
  last_collection_at TIMESTAMPTZ,
  collection_notes TEXT,
  
  -- Dispute tracking
  disputed_at TIMESTAMPTZ,
  disputed_by UUID,
  dispute_reason TEXT,
  dispute_resolved_at TIMESTAMPTZ,
  dispute_resolution TEXT,
  
  -- Void/Write-off
  voided_at TIMESTAMPTZ,
  voided_by UUID REFERENCES user_profiles(id),
  void_reason TEXT,
  written_off_at TIMESTAMPTZ,
  written_off_by UUID REFERENCES user_profiles(id),
  write_off_reason TEXT,
  
  -- Related invoices
  original_invoice_id UUID REFERENCES invoices(id),  -- For credit notes
  corrected_invoice_id UUID REFERENCES invoices(id),  -- If this replaces another
  
  -- External integration
  external_invoice_id VARCHAR,  -- ID in accounting system
  accounting_sync_status VARCHAR,  -- 'pending', 'synced', 'error'
  accounting_synced_at TIMESTAMPTZ,
  quickbooks_id VARCHAR,
  xero_id VARCHAR,
  
  -- Audit
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  created_by UUID REFERENCES user_profiles(id),
  approved_by UUID REFERENCES user_profiles(id),
  approved_at TIMESTAMPTZ,
  deleted_at TIMESTAMPTZ,
  
  -- Constraints
  CONSTRAINT valid_amounts CHECK (
    subtotal >= 0 AND total_amount >= 0 AND amount_paid >= 0
  )
);

-- Indexes
CREATE INDEX idx_invoices_company ON invoices(bill_to_company_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_invoices_status ON invoices(status) WHERE deleted_at IS NULL;
CREATE INDEX idx_invoices_due_date ON invoices(due_date) WHERE status IN ('sent', 'partial', 'overdue') AND deleted_at IS NULL;
CREATE INDEX idx_invoices_period ON invoices(period_start, period_end) WHERE deleted_at IS NULL;
CREATE INDEX idx_invoices_batch ON invoices(batch_id) WHERE batch_id IS NOT NULL;
CREATE INDEX idx_invoices_number ON invoices(invoice_number) WHERE deleted_at IS NULL;
CREATE INDEX idx_invoices_overdue ON invoices(due_date) WHERE status = 'overdue' AND deleted_at IS NULL;

-- Unique invoice number per org
CREATE UNIQUE INDEX idx_invoices_number_unique 
ON invoices(org_id, invoice_number) WHERE deleted_at IS NULL;
```

### Invoice Line Items Table

```sql
CREATE TABLE invoice_line_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  invoice_id UUID NOT NULL REFERENCES invoices(id) ON DELETE CASCADE,
  
  -- Line item identity
  line_number INTEGER NOT NULL,
  
  -- Source reference
  source_type VARCHAR NOT NULL,  -- 'timesheet', 'placement', 'expense', 'fee', 'adjustment'
  source_id UUID,  -- timesheet_id, placement_id, etc.
  
  -- Placement reference
  placement_id UUID REFERENCES placements(id),
  contact_id UUID REFERENCES contacts(id),  -- The consultant
  
  -- Description
  description TEXT NOT NULL,
  detailed_description TEXT,
  
  -- Service period
  service_period_start DATE,
  service_period_end DATE,
  
  -- Quantity and rate
  quantity NUMERIC(10,2) NOT NULL,
  quantity_type VARCHAR DEFAULT 'hours',  -- 'hours', 'days', 'units', 'fixed'
  unit_price NUMERIC(10,2) NOT NULL,
  
  -- For time-based items
  regular_hours NUMERIC(6,2),
  regular_rate NUMERIC(10,2),
  overtime_hours NUMERIC(6,2),
  overtime_rate NUMERIC(10,2),
  double_time_hours NUMERIC(6,2),
  double_time_rate NUMERIC(10,2),
  
  -- Calculated amounts
  line_subtotal NUMERIC(12,2) NOT NULL,
  discount_amount NUMERIC(12,2) DEFAULT 0,
  tax_amount NUMERIC(12,2) DEFAULT 0,
  line_total NUMERIC(12,2) NOT NULL,
  
  -- Tax
  is_taxable BOOLEAN DEFAULT true,
  tax_code VARCHAR,
  
  -- Cost tracking
  cost_amount NUMERIC(12,2),  -- Our cost (for margin calculation)
  margin_amount NUMERIC(12,2),
  margin_percentage NUMERIC(5,2),
  
  -- Project/Department allocation
  project_code VARCHAR,
  department VARCHAR,
  cost_center VARCHAR,
  gl_account VARCHAR,
  
  -- Audit
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL
);

CREATE INDEX idx_invoice_line_items_invoice ON invoice_line_items(invoice_id);
CREATE INDEX idx_invoice_line_items_placement ON invoice_line_items(placement_id) WHERE placement_id IS NOT NULL;
CREATE INDEX idx_invoice_line_items_source ON invoice_line_items(source_type, source_id) WHERE source_id IS NOT NULL;
```

### Invoice Payments Table

```sql
CREATE TABLE invoice_payments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  invoice_id UUID NOT NULL REFERENCES invoices(id) ON DELETE CASCADE,
  
  -- Payment identity
  payment_number VARCHAR,
  
  -- Amount
  amount NUMERIC(15,2) NOT NULL,
  currency VARCHAR NOT NULL DEFAULT 'USD',
  exchange_rate NUMERIC(10,6) DEFAULT 1,
  amount_base_currency NUMERIC(15,2),  -- Amount in org's base currency
  
  -- Payment details
  payment_date DATE NOT NULL,
  payment_method VARCHAR NOT NULL,  -- 'ach', 'wire', 'check', 'credit_card', 'cash'
  
  -- Reference information
  reference_number VARCHAR,  -- Check number, transaction ID
  bank_reference VARCHAR,
  confirmation_number VARCHAR,
  
  -- For check payments
  check_number VARCHAR,
  check_date DATE,
  bank_name VARCHAR,
  
  -- For wire/ACH
  transaction_id VARCHAR,
  bank_account_last4 VARCHAR,
  
  -- For credit card
  card_type VARCHAR,
  card_last4 VARCHAR,
  authorization_code VARCHAR,
  
  -- Deposit tracking
  deposit_date DATE,
  deposit_batch_id UUID,
  
  -- Status
  status VARCHAR DEFAULT 'completed',  -- 'pending', 'completed', 'failed', 'reversed'
  
  -- Reversal tracking
  is_reversed BOOLEAN DEFAULT false,
  reversed_at TIMESTAMPTZ,
  reversed_by UUID REFERENCES user_profiles(id),
  reversal_reason TEXT,
  original_payment_id UUID REFERENCES invoice_payments(id),
  
  -- Notes
  notes TEXT,
  
  -- Audit
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  created_by UUID REFERENCES user_profiles(id),
  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL
);

CREATE INDEX idx_invoice_payments_invoice ON invoice_payments(invoice_id);
CREATE INDEX idx_invoice_payments_date ON invoice_payments(payment_date);
CREATE INDEX idx_invoice_payments_status ON invoice_payments(status);
```

### Payment Terms Table

```sql
CREATE TABLE payment_terms (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  
  -- Identity
  terms_code VARCHAR NOT NULL,  -- 'NET30', 'NET45', 'DUE_ON_RECEIPT'
  terms_name VARCHAR NOT NULL,  -- "Net 30", "Net 45", "Due on Receipt"
  terms_description TEXT,
  
  -- Calculation
  due_days INTEGER NOT NULL,  -- Days from invoice date
  discount_days INTEGER,  -- Days for early payment discount
  discount_percentage NUMERIC(5,2),  -- Early payment discount %
  
  -- Display
  display_text VARCHAR,  -- "Net 30 days", "2% 10 Net 30"
  
  -- Status
  is_active BOOLEAN DEFAULT true,
  is_default BOOLEAN DEFAULT false,
  
  -- Audit
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL
);

-- Seed common payment terms
INSERT INTO payment_terms (org_id, terms_code, terms_name, due_days, display_text) VALUES
  (org_id, 'DUE_ON_RECEIPT', 'Due on Receipt', 0, 'Due on Receipt'),
  (org_id, 'NET15', 'Net 15', 15, 'Net 15 days'),
  (org_id, 'NET30', 'Net 30', 30, 'Net 30 days'),
  (org_id, 'NET45', 'Net 45', 45, 'Net 45 days'),
  (org_id, 'NET60', 'Net 60', 60, 'Net 60 days'),
  (org_id, '2_10_NET30', '2% 10 Net 30', 30, '2% 10 Net 30');
```

### Invoice Templates Table

```sql
CREATE TABLE invoice_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  
  -- Identity
  template_name VARCHAR NOT NULL,
  template_code VARCHAR,
  description TEXT,
  
  -- Applicability
  client_company_id UUID REFERENCES companies(id),  -- NULL = org default
  invoice_type VARCHAR,  -- NULL = all types
  
  -- Header configuration
  header_config JSONB,
  /* {
    "show_logo": true,
    "logo_position": "left",
    "company_details_position": "right",
    "header_color": "#000000"
  } */
  
  -- Column configuration
  columns_config JSONB,
  /* {
    "show_consultant_name": true,
    "show_dates": true,
    "show_hours_breakdown": true,
    "show_rate": true,
    "group_by": "consultant" // or "project", "none"
  } */
  
  -- Footer configuration
  footer_config JSONB,
  /* {
    "show_payment_instructions": true,
    "show_terms": true,
    "custom_message": "Thank you for your business"
  } */
  
  -- Terms and conditions
  default_terms_text TEXT,
  default_notes TEXT,
  
  -- Remittance instructions
  remittance_instructions TEXT,
  
  -- Styling
  css_styles TEXT,
  html_template TEXT,
  
  -- Status
  is_active BOOLEAN DEFAULT true,
  is_default BOOLEAN DEFAULT false,
  
  -- Audit
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  created_by UUID REFERENCES user_profiles(id)
);
```

### Invoice Batches Table

```sql
-- For batch invoice generation
CREATE TABLE invoice_batches (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  
  -- Batch identity
  batch_number VARCHAR NOT NULL,
  batch_name VARCHAR,
  
  -- Period
  billing_period_start DATE NOT NULL,
  billing_period_end DATE NOT NULL,
  
  -- Status
  status VARCHAR NOT NULL DEFAULT 'draft',
  -- 'draft', 'in_progress', 'completed', 'partially_completed', 'failed'
  
  -- Statistics
  total_invoices INTEGER DEFAULT 0,
  invoices_generated INTEGER DEFAULT 0,
  invoices_failed INTEGER DEFAULT 0,
  total_amount NUMERIC(15,2) DEFAULT 0,
  
  -- Processing
  started_at TIMESTAMPTZ,
  completed_at TIMESTAMPTZ,
  
  -- Errors
  error_log JSONB,
  
  -- Audit
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  created_by UUID REFERENCES user_profiles(id)
);

CREATE INDEX idx_invoice_batches_status ON invoice_batches(status);
CREATE INDEX idx_invoice_batches_period ON invoice_batches(billing_period_start, billing_period_end);
```

### Invoice Aging View

```sql
-- View for AR aging reports
CREATE VIEW invoice_aging AS
SELECT
  i.org_id,
  i.id as invoice_id,
  i.invoice_number,
  i.bill_to_company_id,
  c.name as company_name,
  i.invoice_date,
  i.due_date,
  i.total_amount,
  i.amount_paid,
  i.amount_due,
  i.currency,
  CURRENT_DATE - i.due_date as days_overdue,
  CASE
    WHEN i.amount_due = 0 THEN 'paid'
    WHEN CURRENT_DATE <= i.due_date THEN 'current'
    WHEN CURRENT_DATE - i.due_date <= 30 THEN '1_30_days'
    WHEN CURRENT_DATE - i.due_date <= 60 THEN '31_60_days'
    WHEN CURRENT_DATE - i.due_date <= 90 THEN '61_90_days'
    ELSE 'over_90_days'
  END as aging_bucket
FROM invoices i
JOIN companies c ON i.bill_to_company_id = c.id
WHERE i.deleted_at IS NULL
  AND i.status NOT IN ('void', 'draft', 'written_off');
```

## Invoice Generation Logic

```sql
-- Function to generate invoice from approved timesheets
CREATE OR REPLACE FUNCTION generate_invoice_from_timesheets(
  p_org_id UUID,
  p_company_id UUID,
  p_period_start DATE,
  p_period_end DATE,
  p_created_by UUID
) RETURNS UUID AS $$
DECLARE
  v_invoice_id UUID;
  v_invoice_number VARCHAR;
  v_subtotal NUMERIC(15,2) := 0;
  v_timesheet RECORD;
BEGIN
  -- Generate invoice number
  SELECT 'INV-' || TO_CHAR(CURRENT_DATE, 'YYYY') || '-' || 
         LPAD(COALESCE(MAX(CAST(SUBSTRING(invoice_number FROM 10) AS INTEGER)), 0) + 1, 6, '0')
  INTO v_invoice_number
  FROM invoices
  WHERE org_id = p_org_id
    AND invoice_number LIKE 'INV-' || TO_CHAR(CURRENT_DATE, 'YYYY') || '-%';

  -- Create invoice
  INSERT INTO invoices (
    org_id, invoice_number, bill_to_company_id,
    invoice_type, period_start, period_end,
    invoice_date, due_date, created_by
  ) VALUES (
    p_org_id, v_invoice_number, p_company_id,
    'standard', p_period_start, p_period_end,
    CURRENT_DATE, CURRENT_DATE + 30, p_created_by
  ) RETURNING id INTO v_invoice_id;

  -- Add line items from timesheets
  FOR v_timesheet IN
    SELECT t.*, p.client_company_id, c.name as consultant_name
    FROM timesheets t
    JOIN placements p ON t.placement_id = p.id
    JOIN contacts c ON t.contact_id = c.id
    WHERE t.org_id = p_org_id
      AND p.client_company_id = p_company_id
      AND t.period_start >= p_period_start
      AND t.period_end <= p_period_end
      AND t.status = 'approved'
      AND t.invoice_id IS NULL
  LOOP
    INSERT INTO invoice_line_items (
      org_id, invoice_id, line_number,
      source_type, source_id,
      placement_id, contact_id,
      description,
      service_period_start, service_period_end,
      quantity, unit_price,
      regular_hours, regular_rate,
      overtime_hours, overtime_rate,
      line_subtotal, line_total,
      cost_amount, margin_amount
    ) VALUES (
      p_org_id, v_invoice_id, 
      (SELECT COALESCE(MAX(line_number), 0) + 1 FROM invoice_line_items WHERE invoice_id = v_invoice_id),
      'timesheet', v_timesheet.id,
      v_timesheet.placement_id, v_timesheet.contact_id,
      v_timesheet.consultant_name || ' - ' || v_timesheet.period_start || ' to ' || v_timesheet.period_end,
      v_timesheet.period_start, v_timesheet.period_end,
      v_timesheet.total_billable_hours, v_timesheet.regular_bill_rate,
      v_timesheet.total_regular_hours, v_timesheet.regular_bill_rate,
      v_timesheet.total_overtime_hours, v_timesheet.ot_bill_rate,
      v_timesheet.bill_amount, v_timesheet.bill_amount,
      v_timesheet.pay_amount, v_timesheet.bill_amount - v_timesheet.pay_amount
    );

    v_subtotal := v_subtotal + v_timesheet.bill_amount;

    -- Link timesheet to invoice
    UPDATE timesheets SET invoice_id = v_invoice_id WHERE id = v_timesheet.id;
  END LOOP;

  -- Update invoice totals
  UPDATE invoices
  SET 
    subtotal = v_subtotal,
    total_amount = v_subtotal,  -- Add tax calculation if needed
    updated_at = now()
  WHERE id = v_invoice_id;

  RETURN v_invoice_id;
END;
$$ LANGUAGE plpgsql;
```

## Acceptance Criteria

### Schema Implementation
- [ ] Create `invoices` table
- [ ] Create `invoice_line_items` table
- [ ] Create `invoice_payments` table
- [ ] Create `payment_terms` table
- [ ] Create `invoice_templates` table
- [ ] Create `invoice_batches` table
- [ ] Create `invoice_aging` view
- [ ] Create invoice generation function
- [ ] All indexes created
- [ ] RLS policies enforced

### Invoice Lifecycle
- [ ] Draft creation working
- [ ] Line item management working
- [ ] Invoice approval workflow
- [ ] PDF generation
- [ ] Email sending
- [ ] Payment recording
- [ ] Partial payment handling
- [ ] Void/Credit note handling

### Integration
- [ ] Timesheet to invoice linkage
- [ ] Payment tracking
- [ ] Accounting system export
- [ ] Aging reports

### Frontend Requirements
- [ ] Invoice list view with filters
- [ ] Invoice creation wizard
- [ ] Invoice detail view
- [ ] Payment recording UI
- [ ] Aging dashboard
- [ ] Batch invoice generation

---

## Notes

This system is **critical for revenue**:

1. **Cash Flow**: Timely invoicing improves cash flow
2. **Accuracy**: System-generated invoices reduce errors
3. **Tracking**: Full payment tracking and AR management
4. **Compliance**: Proper invoice records for audits
5. **Integration**: Ready for accounting system sync
6. **Templates**: Client-specific invoice formatting



