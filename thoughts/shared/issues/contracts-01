# ISSUE: Unified Contracts & Agreements System

**Issue ID:** CONTRACTS-01
**Created:** 2025-12-10
**Status:** Open
**Priority:** High
**Type:** Feature/Enhancement (Database Schema Redesign)
**Reporter:** User
**Depends On:** DOCS-01 (for document storage), ACCOUNTS-02 (unified companies), CONTACTS-01 (unified contacts for signatories)

---

## Summary

Unify the fragmented contracts and agreements system into a centralized `contracts` table with polymorphic entity references. Currently, contract data is scattered across 6+ tables with inconsistent schemas, no version tracking, and limited lifecycle management. This issue creates an enterprise-grade contract management system critical for staffing operations (MSAs, SOWs, NDAs, employment agreements, vendor agreements).

## Location

- **Current Tables**: `account_contracts`, `company_contracts`, `contact_agreements`, `engagement_agreements`, `placement_contracts`, `vendor_agreements`
- **Related Tables**: `documents` (for contract PDFs), `company_compliance_requirements` (contractual requirements)
- **Affected Modules**: CRM, ATS, Bench Sales, Legal, Operations

## Problem Description

### Current State Issues

1. **Fragmented Contract Tables**: 6+ separate tables
   - `account_contracts` - Legacy account contracts
   - `company_contracts` - Company-level contracts
   - `contact_agreements` - Individual agreements
   - `engagement_agreements` - Engagement-specific
   - `placement_contracts` - Placement agreements
   - `vendor_agreements` - Vendor contracts

2. **No Unified Versioning**: Contract amendments not tracked consistently

3. **Inconsistent Schema**:
   - Different date fields per table
   - Terms and conditions not standardized
   - Approval workflows vary

4. **Missing Enterprise Features**:
   - No contract templates
   - No automated renewal tracking
   - No clause library
   - No signature workflow
   - Limited audit trail

5. **Industry-Critical Gap**: Staffing contracts are legally binding - errors are costly

## Expected Behavior

A unified contracts system that:
1. Centralized `contracts` table with polymorphic entity reference
2. `contract_versions` for amendment tracking
3. `contract_clauses` for reusable terms
4. Full lifecycle management (draft → negotiation → active → renewed/terminated)
5. Automated renewal alerts
6. E-signature integration ready
7. Template-based contract generation
8. Approval workflows

## Proposed Schema Design

### Contracts Table (Unified)

```sql
contracts:
  id UUID PRIMARY KEY
  org_id UUID NOT NULL

-- Identity
  contract_number VARCHAR UNIQUE  -- 'MSA-2024-0001'
  contract_name VARCHAR NOT NULL

-- Polymorphic entity relationships
  primary_entity_type VARCHAR NOT NULL  -- 'company', 'contact', 'placement'
  primary_entity_id UUID NOT NULL

  secondary_entity_type VARCHAR  -- For bilateral contracts
  secondary_entity_id UUID

-- Classification
  contract_type VARCHAR NOT NULL
    -- 'msa' (Master Service Agreement)
    -- 'sow' (Statement of Work)
    -- 'nda' (Non-Disclosure Agreement)
    -- 'employment' (Employment Agreement)
    -- 'contractor' (Independent Contractor Agreement)
    -- 'vendor' (Vendor Agreement)
    -- 'placement' (Placement Agreement)
    -- 'staffing' (Staffing Agreement)
    -- 'consulting' (Consulting Agreement)
    -- 'subcontractor' (Subcontractor Agreement)
    -- 'amendment' (Amendment to existing contract)
    -- 'addendum'
    -- 'other'

  contract_category VARCHAR  -- 'client', 'vendor', 'talent', 'internal'

-- Hierarchy (for SOWs under MSAs)
  parent_contract_id UUID REFERENCES contracts(id)

-- Status lifecycle
  status VARCHAR NOT NULL DEFAULT 'draft'
    -- 'draft', 'pending_review', 'in_negotiation', 'pending_signature',
    -- 'active', 'on_hold', 'expired', 'terminated', 'renewed'

  status_reason TEXT

-- Dates
  effective_date DATE
  expiry_date DATE
  executed_date DATE  -- When fully signed
  termination_date DATE
  termination_reason TEXT

-- Renewal
  auto_renew BOOLEAN DEFAULT false
  renewal_period_months INTEGER
  renewal_notice_days INTEGER DEFAULT 30
  renewal_alert_sent_at TIMESTAMPTZ
  renewed_to_contract_id UUID REFERENCES contracts(id)

-- Financial terms
  contract_value NUMERIC(15,2)
  currency VARCHAR DEFAULT 'USD'
  payment_terms VARCHAR  -- 'net_30', 'net_45', 'net_60'
  billing_frequency VARCHAR  -- 'weekly', 'biweekly', 'monthly'

-- Parties
  our_signatory_id UUID REFERENCES user_profiles(id)
  our_signatory_title VARCHAR
  counterparty_signatory_name VARCHAR
  counterparty_signatory_title VARCHAR
  counterparty_signatory_email VARCHAR

-- Document reference
  document_id UUID REFERENCES documents(id)  -- The actual contract PDF

-- Template reference
  template_id UUID REFERENCES contract_templates(id)

-- E-signature tracking
  esign_provider VARCHAR  -- 'docusign', 'hellosign', 'pandadoc'
  esign_envelope_id VARCHAR
  esign_status VARCHAR  -- 'sent', 'viewed', 'signed', 'completed'
  esign_sent_at TIMESTAMPTZ
  esign_completed_at TIMESTAMPTZ

-- Legal
  governing_law VARCHAR  -- 'Texas', 'Delaware', 'California'
  dispute_resolution VARCHAR  -- 'arbitration', 'litigation'
  venue VARCHAR

-- Notes
  description TEXT
  internal_notes TEXT

-- Metadata
  metadata JSONB  -- Contract-type specific data

-- Audit
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL
  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL
  created_by UUID REFERENCES user_profiles(id)
  updated_by UUID REFERENCES user_profiles(id)
  deleted_at TIMESTAMPTZ

-- Indexes
CREATE INDEX idx_contracts_entity ON contracts(primary_entity_type, primary_entity_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_contracts_type ON contracts(contract_type, status) WHERE deleted_at IS NULL;
CREATE INDEX idx_contracts_expiry ON contracts(expiry_date) WHERE status = 'active' AND deleted_at IS NULL;
CREATE INDEX idx_contracts_status ON contracts(status) WHERE deleted_at IS NULL;
CREATE INDEX idx_contracts_parent ON contracts(parent_contract_id) WHERE parent_contract_id IS NOT NULL;
```

### Contract Versions (Amendments/Revisions)

```sql
contract_versions:
  id UUID PRIMARY KEY
  contract_id UUID NOT NULL REFERENCES contracts(id)

  version_number INTEGER NOT NULL
  version_type VARCHAR NOT NULL  -- 'original', 'amendment', 'addendum', 'renewal'

  effective_date DATE NOT NULL

  -- Changes
  changes_summary TEXT
  document_id UUID REFERENCES documents(id)

  -- Approval
  approved_by UUID REFERENCES user_profiles(id)
  approved_at TIMESTAMPTZ

  -- Audit
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL
  created_by UUID REFERENCES user_profiles(id)

CREATE INDEX idx_contract_versions ON contract_versions(contract_id, version_number DESC);
```

### Contract Templates

```sql
contract_templates:
  id UUID PRIMARY KEY
  org_id UUID NOT NULL

-- Identity
  template_name VARCHAR NOT NULL
  template_code VARCHAR UNIQUE  -- 'MSA_STANDARD_V2'
  description TEXT

-- Classification
  contract_type VARCHAR NOT NULL  -- Same as contracts.contract_type
  contract_category VARCHAR

-- Content
  template_content TEXT  -- HTML/Markdown with placeholders
  clause_ids UUID[]  -- References to contract_clauses

-- Variables (for mail merge)
  variables JSONB  -- [{ name: 'client_name', type: 'text', required: true }]

-- Status
  is_active BOOLEAN DEFAULT true
  is_default BOOLEAN DEFAULT false

-- Audit
  created_at, updated_at, created_by

CREATE INDEX idx_contract_templates_type ON contract_templates(contract_type) WHERE is_active = true;
```

### Contract Clauses (Reusable)

```sql
contract_clauses:
  id UUID PRIMARY KEY
  org_id UUID NOT NULL

-- Identity
  clause_name VARCHAR NOT NULL
  clause_code VARCHAR UNIQUE  -- 'TERM_AUTO_RENEW_1YR'

-- Classification
  clause_category VARCHAR NOT NULL
    -- 'term', 'termination', 'payment', 'confidentiality', 'ip',
    -- 'indemnification', 'liability', 'governing_law', 'dispute', 'insurance'

-- Content
  clause_text TEXT NOT NULL
  clause_html TEXT  -- Formatted version

-- Variables
  variables JSONB  -- Placeholders in clause text

-- Legal
  is_standard BOOLEAN DEFAULT true
  is_negotiable BOOLEAN DEFAULT true
  risk_level VARCHAR  -- 'low', 'medium', 'high'

-- Status
  is_active BOOLEAN DEFAULT true

-- Audit
  created_at, updated_at, created_by

CREATE INDEX idx_contract_clauses_category ON contract_clauses(clause_category) WHERE is_active = true;
```

### Contract Parties (Multiple Signatories)

```sql
contract_parties:
  id UUID PRIMARY KEY
  contract_id UUID NOT NULL REFERENCES contracts(id)

-- Party info
  party_type VARCHAR NOT NULL  -- 'internal', 'client', 'vendor', 'talent'
  party_role VARCHAR NOT NULL  -- 'signatory', 'witness', 'notary'

-- Entity reference
  entity_type VARCHAR  -- 'user', 'contact', 'company'
  entity_id UUID

-- Or manual entry
  party_name VARCHAR
  party_title VARCHAR
  party_email VARCHAR

-- Signature tracking
  signature_status VARCHAR DEFAULT 'pending'  -- 'pending', 'sent', 'signed', 'declined'
  signed_at TIMESTAMPTZ
  signature_ip VARCHAR

-- Order
  sign_order INTEGER DEFAULT 0  -- For sequential signing

-- Audit
  created_at TIMESTAMPTZ DEFAULT now()

CREATE INDEX idx_contract_parties ON contract_parties(contract_id);
```

### Contract Audit Log

```sql
contract_audit_log:
  id UUID PRIMARY KEY
  contract_id UUID NOT NULL REFERENCES contracts(id)

  action VARCHAR NOT NULL
    -- 'created', 'updated', 'status_changed', 'sent_for_signature',
    -- 'signed', 'viewed', 'downloaded', 'renewed', 'terminated'

  old_status VARCHAR
  new_status VARCHAR

  details JSONB

  performed_by UUID REFERENCES user_profiles(id)
  performed_at TIMESTAMPTZ DEFAULT now()
  ip_address INET

CREATE INDEX idx_contract_audit ON contract_audit_log(contract_id, performed_at DESC);
```

## Migration Strategy

### Phase 1: Schema Creation
- Create `contracts` table
- Create `contract_versions` table
- Create `contract_templates` table
- Create `contract_clauses` table
- Create `contract_parties` table
- Create `contract_audit_log` table
- Add indexes and RLS

### Phase 2: Data Migration
1. Migrate `company_contracts` → `contracts` (primary_entity_type='company')
2. Migrate `account_contracts` → `contracts` (lookup company_id)
3. Migrate `contact_agreements` → `contracts` (primary_entity_type='contact')
4. Migrate `engagement_agreements` → `contracts` (primary_entity_type='placement')
5. Migrate `placement_contracts` → `contracts` (primary_entity_type='placement')
6. Migrate `vendor_agreements` → `contracts` (primary_entity_type='company', contract_category='vendor')

### Phase 3: Template Seeding
- Standard MSA template
- Standard NDA template
- Standard SOW template
- Employment agreement template
- Independent contractor template

### Phase 4: Router & UI Updates
- `contracts` tRPC router
- ContractList component
- ContractEditor component
- ContractVersionHistory
- TemplateSelector
- ClauseLibrary

## Acceptance Criteria

### Schema Implementation
- [ ] Create unified `contracts` table
- [ ] Create `contract_versions` for amendments
- [ ] Create `contract_templates`
- [ ] Create `contract_clauses` library
- [ ] Create `contract_parties` for multi-signatory
- [ ] Hierarchy working (SOW → MSA)
- [ ] RLS policies enforced

### Lifecycle Management
- [ ] Status transitions enforced
- [ ] Expiration tracking working
- [ ] Renewal alerts functional
- [ ] Auto-renewal logic implemented

### Template System
- [ ] Template CRUD working
- [ ] Variable substitution working
- [ ] Clause assembly working

### Data Migration
- [ ] All legacy contract tables migrated
- [ ] No data loss
- [ ] Document references preserved

### Frontend Updates
- [ ] ContractDashboard (org-wide view)
- [ ] ContractWorkspace (per contract)
- [ ] ContractGenerator (from template)
- [ ] ClauseLibrary management
- [ ] Version history view

---

## Technical Context

### Contract Type Hierarchy

```
contracts
├── Client Contracts
│   ├── msa (Master Service Agreement)
│   ├── sow (Statement of Work) → parent_contract_id → MSA
│   ├── nda (Non-Disclosure Agreement)
│   └── staffing (Staffing Agreement)
├── Vendor Contracts
│   ├── vendor (Vendor Agreement)
│   ├── subcontractor (Subcontractor Agreement)
│   └── nda
├── Talent Contracts
│   ├── employment (W2 Employment)
│   ├── contractor (1099 Independent Contractor)
│   ├── consulting (Consulting Agreement)
│   └── placement (Placement Agreement)
└── Internal
    ├── amendment (Amendment to any contract)
    └── addendum
```

### Status Lifecycle

```
draft → pending_review → in_negotiation → pending_signature → active
                                                              ↓
                                                    expired/terminated
                                                              ↓
                                                          renewed → active
```

### Relationship Model

```
contracts
├── Links → companies (client/vendor)
├── Links → contacts (talent/signatory)
├── Links → placements (placement-specific)
├── Links → documents (contract PDF)
├── Contains → contract_versions (amendment history)
├── Contains → contract_parties (signatories)
└── Uses → contract_templates + contract_clauses
```

---

## RLS Policies

```sql
-- contracts table RLS
ALTER TABLE contracts ENABLE ROW LEVEL SECURITY;

CREATE POLICY "contracts_org_isolation" ON contracts
  FOR ALL USING (org_id = auth.org_id());

-- contract_versions table RLS
ALTER TABLE contract_versions ENABLE ROW LEVEL SECURITY;

CREATE POLICY "contract_versions_org_isolation" ON contract_versions
  FOR ALL USING (
    EXISTS (SELECT 1 FROM contracts c WHERE c.id = contract_id AND c.org_id = auth.org_id())
  );

-- contract_templates table RLS
ALTER TABLE contract_templates ENABLE ROW LEVEL SECURITY;

CREATE POLICY "contract_templates_org_isolation" ON contract_templates
  FOR ALL USING (org_id = auth.org_id());

-- contract_clauses table RLS
ALTER TABLE contract_clauses ENABLE ROW LEVEL SECURITY;

CREATE POLICY "contract_clauses_org_isolation" ON contract_clauses
  FOR ALL USING (org_id = auth.org_id());

-- contract_parties table RLS
ALTER TABLE contract_parties ENABLE ROW LEVEL SECURITY;

CREATE POLICY "contract_parties_org_isolation" ON contract_parties
  FOR ALL USING (
    EXISTS (SELECT 1 FROM contracts c WHERE c.id = contract_id AND c.org_id = auth.org_id())
  );

-- contract_audit_log table RLS
ALTER TABLE contract_audit_log ENABLE ROW LEVEL SECURITY;

CREATE POLICY "contract_audit_org_isolation" ON contract_audit_log
  FOR ALL USING (
    EXISTS (SELECT 1 FROM contracts c WHERE c.id = contract_id AND c.org_id = auth.org_id())
  );
```

---

## Rollback Plan

### Schema Rollback
```sql
-- Drop in reverse order of creation
DROP TABLE IF EXISTS contract_audit_log;
DROP TABLE IF EXISTS contract_parties;
DROP TABLE IF EXISTS contract_clauses;
DROP TABLE IF EXISTS contract_templates;
DROP TABLE IF EXISTS contract_versions;
DROP TABLE IF EXISTS contracts;
```

### Data Rollback
```sql
-- Restore legacy tables from backup
-- Note: Keep backup tables for 30 days post-migration
INSERT INTO account_contracts SELECT * FROM account_contracts_backup;
INSERT INTO company_contracts SELECT * FROM company_contracts_backup;
INSERT INTO contact_agreements SELECT * FROM contact_agreements_backup;
INSERT INTO engagement_agreements SELECT * FROM engagement_agreements_backup;
INSERT INTO placement_contracts SELECT * FROM placement_contracts_backup;
INSERT INTO vendor_agreements SELECT * FROM vendor_agreements_backup;
```

### Full Rollback Procedure
1. Stop application deployments
2. Execute schema rollback SQL
3. Restore legacy data from backups
4. Restore tRPC router to previous git commit
5. Restore UI components to previous git commit
6. Verify application functionality

---

## Notes

This is **legally critical infrastructure**. Key enterprise features:

1. **Version Control**: Every amendment tracked with full history
2. **Template System**: Standardized contracts reduce legal risk
3. **Clause Library**: Reusable, approved legal language
4. **E-signature Ready**: Schema supports DocuSign, HelloSign integration
5. **Renewal Management**: Never miss a contract renewal
6. **Audit Trail**: Every action logged for legal compliance
7. **Hierarchy Support**: SOWs linked to parent MSAs
