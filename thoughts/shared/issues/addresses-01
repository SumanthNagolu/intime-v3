# ISSUE: Centralized Address System
     
**Issue ID:** ADDRESSES-01
**Created:** 2025-12-11
**Status:** Closed (Implemented)
**Priority:** Critical
**Type:** Feature/Infrastructure
**Reporter:** System (Architecture Review)

---

## Summary

A unified, enterprise-grade address management system that centralizes all address storage into a single polymorphic `addresses` table. This system replaces embedded address fields and disparate address tables across the platform, providing standardized validation, geo-location, and type management for all entities (contacts, companies, jobs, etc.).

## Location

- **Current Table**: `addresses`
- **Related Views**: `account_addresses_view`, `candidate_addresses_view`, etc.
- **Affected Modules**: All modules (cross-cutting concern)

## Implemented Schema

The `addresses` table is fully implemented with the following schema:

```sql
CREATE TABLE public.addresses (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    org_id uuid NOT NULL,
    
    -- Polymorphic Relationship
    entity_type text NOT NULL, -- 'contact', 'company', 'job', etc.
    entity_id uuid NOT NULL,
    
    -- Classification
    address_type text NOT NULL, -- 'billing', 'shipping', 'work', 'home', etc.
    is_primary boolean DEFAULT false,
    
    -- Address Components
    address_line_1 text,
    address_line_2 text,
    address_line_3 text,
    city text,
    state_province text,
    postal_code text,
    country_code text DEFAULT 'US'::text NOT NULL,
    county text,
    
    -- Geo-Location
    latitude numeric(10,7),
    longitude numeric(10,7),
    timezone text, -- (Added in recent updates or planned)
    
    -- Validation
    is_verified boolean DEFAULT false,
    verified_at timestamp with time zone,
    verification_source text, -- 'google_maps', 'smartystreets', 'manual'
    
    -- Effectiveness
    effective_from date,
    effective_to date,
    
    -- Metadata
    notes text,
    
    -- Audit
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    created_by uuid,
    updated_by uuid,
    
    -- Constraints
    CONSTRAINT addresses_address_type_check CHECK ((address_type = ANY (ARRAY['current'::text, 'permanent'::text, 'mailing'::text, 'work'::text, 'billing'::text, 'shipping'::text, 'headquarters'::text, 'office'::text, 'job_location'::text, 'meeting'::text, 'first_day'::text]))),
    CONSTRAINT addresses_entity_type_check CHECK ((entity_type = ANY (ARRAY['candidate'::text, 'account'::text, 'contact'::text, 'vendor'::text, 'organization'::text, 'lead'::text, 'job'::text, 'interview'::text, 'employee'::text, 'placement'::text])))
);
```

## Key Features

1. **Polymorphic Design**: Supports any entity type via `entity_type` and `entity_id`.
2. **Standardization**: Enforced address types and country codes.
3. **Geo-Location**: Native storage for lat/long coordinates.
4. **Validation Tracking**: Tracks if/when/how an address was verified.
5. **History**: `effective_from` and `effective_to` allow tracking address history.

## Integration Patterns

### 1. Reading Addresses
Retrieve addresses for an entity:
```sql
SELECT * FROM addresses 
WHERE entity_type = 'company' 
  AND entity_id = $company_id 
  AND (effective_to IS NULL OR effective_to > CURRENT_DATE);
```

### 2. Primary Address
Get the primary address (e.g., for billing):
```sql
SELECT * FROM addresses 
WHERE entity_type = 'company' 
  AND entity_id = $company_id 
  AND is_primary = true
LIMIT 1;
```

### 3. Writing Addresses
When creating/updating an entity, addresses should be upserted into the `addresses` table using the entity's ID.

## Next Steps (Future Enhancements)

- **Timezone Enrichment**: Auto-populate timezone based on zip/coords.
- **Distance Calculation**: Use PostGIS for radius searches (e.g., "Candidates within 20 miles").
- **Address Validation Service**: Integration with external APIs (SmartyStreets, USPS) to auto-verify on entry.
