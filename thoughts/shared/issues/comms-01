# ISSUE: Unified Communications & Interactions System

**Issue ID:** COMMS-01
**Created:** 2025-12-10
**Status:** Open
**Priority:** Medium
**Type:** Feature/Enhancement (Database Schema Redesign)
**Reporter:** User
**Depends On:** CONTACTS-01 (unified contacts for recipients), DOCS-01 (attachments)

> **NOTE:** This is foundational infrastructure. CAMPAIGNS-01 depends on COMMS-01, not vice versa.

---

## Summary

Unify the fragmented communications tracking system into a centralized `communications` table that records all outbound and inbound messages across channels. Currently, email logs, SMS, LinkedIn messages, and call records are scattered across different tables with no unified view. This issue creates a comprehensive communication history system integrated with the existing `activities` framework.

## Location

- **Current Tables**: `email_logs`, `email_sends`, `email_senders`, `contact_communication_preferences`
- **Related Tables**: `activities` (has email, call, linkedin_message types)
- **Affected Modules**: CRM, Campaigns, Recruiting

## Problem Description

### Current State Issues

1. **Fragmented Communication Tables**:
   - `email_logs` - Basic email tracking
   - `email_sends` - Campaign email sends
   - `email_senders` - Sender configurations
   - Communication preferences separate from actual communications

2. **Activities Overlap**: Some communications logged as activities, others in separate tables

3. **Missing Unified View**:
   - No single place to see all communications with a contact
   - No thread tracking (email replies)
   - No channel analytics

4. **Limited Channel Support**:
   - Email partially tracked
   - SMS not tracked
   - LinkedIn messages manual
   - Phone calls in activities only

## Expected Behavior

A unified communications system that:
1. Single `communications` table for all message types
2. Integration with `activities` (communications create activities)
3. Thread tracking for email conversations
4. Delivery/engagement tracking (sent, delivered, opened, clicked, replied)
5. Communication preferences respected
6. Channel analytics (response rates by channel)
7. Unified inbox view per contact/company

## Proposed Schema Design

### Communications Table (Unified)

```sql
communications:
  id UUID PRIMARY KEY
  org_id UUID NOT NULL

-- Polymorphic recipient
  entity_type VARCHAR NOT NULL  -- 'contact', 'company'
  entity_id UUID NOT NULL

-- Channel
  channel VARCHAR NOT NULL  -- 'email', 'sms', 'phone', 'linkedin', 'whatsapp', 'mail'
  direction VARCHAR NOT NULL  -- 'outbound', 'inbound'

-- Participants
  from_user_id UUID REFERENCES user_profiles(id)  -- Internal sender
  from_contact_id UUID REFERENCES contacts(id)  -- External sender (inbound)
  from_address VARCHAR  -- Email address or phone number
  to_address VARCHAR  -- Recipient address
  cc_addresses TEXT[]
  bcc_addresses TEXT[]

-- Content
  subject VARCHAR
  body_text TEXT
  body_html TEXT
  preview TEXT  -- First 100 chars for list view

-- Threading (for email)
  thread_id VARCHAR  -- Email thread ID
  in_reply_to_id UUID REFERENCES communications(id)
  thread_position INTEGER  -- Position in thread

-- Delivery tracking
  status VARCHAR DEFAULT 'pending'
    -- 'pending', 'queued', 'sent', 'delivered', 'bounced', 'failed'
  status_reason TEXT

  scheduled_at TIMESTAMPTZ
  sent_at TIMESTAMPTZ
  delivered_at TIMESTAMPTZ
  failed_at TIMESTAMPTZ
  failure_reason TEXT

-- Engagement tracking
  opened_at TIMESTAMPTZ
  open_count INTEGER DEFAULT 0
  clicked_at TIMESTAMPTZ
  click_count INTEGER DEFAULT 0
  replied_at TIMESTAMPTZ
  unsubscribed_at TIMESTAMPTZ

-- Attachments
  attachment_count INTEGER DEFAULT 0
  attachment_ids UUID[]  -- References to documents table

-- Campaign context
  campaign_id UUID REFERENCES campaigns(id)
  sequence_step_id UUID
  template_id UUID REFERENCES email_templates(id)

-- Activity linkage
  activity_id UUID REFERENCES activities(id)  -- Auto-created activity

-- External IDs (for sync)
  external_message_id VARCHAR  -- Provider's message ID
  external_thread_id VARCHAR
  provider VARCHAR  -- 'sendgrid', 'twilio', 'outlook', 'gmail'

-- Metadata
  metadata JSONB  -- Channel-specific data

-- Audit
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL
  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL
  created_by UUID REFERENCES user_profiles(id)
  deleted_at TIMESTAMPTZ

-- Indexes
CREATE INDEX idx_comms_entity ON communications(entity_type, entity_id, created_at DESC) WHERE deleted_at IS NULL;
CREATE INDEX idx_comms_thread ON communications(thread_id, thread_position) WHERE thread_id IS NOT NULL;
CREATE INDEX idx_comms_channel ON communications(channel, direction, sent_at DESC) WHERE deleted_at IS NULL;
CREATE INDEX idx_comms_campaign ON communications(campaign_id) WHERE campaign_id IS NOT NULL;
CREATE INDEX idx_comms_status ON communications(status) WHERE status IN ('pending', 'queued');
CREATE INDEX idx_comms_external ON communications(external_message_id) WHERE external_message_id IS NOT NULL;
```

### Communication Preferences (Enhanced)

```sql
communication_preferences:
  id UUID PRIMARY KEY
  org_id UUID NOT NULL

-- Who
  entity_type VARCHAR NOT NULL  -- 'contact'
  entity_id UUID NOT NULL

-- Channel
  channel VARCHAR NOT NULL  -- 'email', 'sms', 'phone', 'linkedin', 'whatsapp', 'mail'

-- Opt status
  is_opted_in BOOLEAN DEFAULT true
  opted_in_at TIMESTAMPTZ
  opted_out_at TIMESTAMPTZ
  opt_source VARCHAR  -- 'user_preference', 'unsubscribe_link', 'bounce', 'complaint'

-- Preferences
  frequency_preference VARCHAR  -- 'daily', 'weekly', 'monthly', 'none'
  best_time_start TIME
  best_time_end TIME
  best_days TEXT[]  -- ['monday', 'tuesday', 'wednesday']
  timezone VARCHAR

-- Content preferences
  content_preferences TEXT[]  -- ['job_alerts', 'newsletters', 'marketing']

-- Deliverability
  bounce_count INTEGER DEFAULT 0
  last_bounce_at TIMESTAMPTZ
  complaint_count INTEGER DEFAULT 0
  last_complaint_at TIMESTAMPTZ
  is_valid BOOLEAN DEFAULT true
  validation_checked_at TIMESTAMPTZ

-- Audit
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL
  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL

-- Constraints
CONSTRAINT comm_prefs_unique UNIQUE (entity_type, entity_id, channel)
```

### Email Senders (Organization Level)

```sql
email_senders:
  id UUID PRIMARY KEY
  org_id UUID NOT NULL

-- Sender details
  sender_name VARCHAR NOT NULL
  sender_email VARCHAR NOT NULL
  reply_to_email VARCHAR

-- Configuration
  sender_type VARCHAR  -- 'individual', 'shared', 'noreply'
  is_default BOOLEAN DEFAULT false
  is_verified BOOLEAN DEFAULT false

-- Provider config
  provider VARCHAR  -- 'sendgrid', 'ses', 'postmark'
  provider_config JSONB  -- Provider-specific settings

-- Limits
  daily_limit INTEGER
  sent_today INTEGER DEFAULT 0

-- Status
  is_active BOOLEAN DEFAULT true

-- Audit
  created_at, updated_at, created_by
```

## Migration Strategy

### Phase 1: Schema Creation
- Create `communications` table
- Enhance `communication_preferences`
- Update `email_senders`

### Phase 2: Data Migration
1. Migrate `email_logs` → `communications`
2. Migrate `email_sends` → `communications`
3. Migrate existing `contact_communication_preferences`
4. Create activities for historical communications

### Phase 3: Integration
- Auto-create activity when communication logged
- Integrate with campaign system
- Set up email provider webhooks

### Phase 4: Router & UI Updates
- `communications` tRPC router
- UnifiedInbox component
- CommunicationTimeline per entity
- PreferencesEditor

## Acceptance Criteria

### Schema Implementation
- [ ] Create `communications` table
- [ ] Enhanced `communication_preferences`
- [ ] Thread tracking working
- [ ] Activity auto-creation working
- [ ] RLS policies enforced

### Channel Support
- [ ] Email send/receive tracked
- [ ] SMS tracked (integration ready)
- [ ] Phone calls linked to activities
- [ ] LinkedIn message logging

### Engagement Tracking
- [ ] Open tracking working
- [ ] Click tracking working
- [ ] Reply detection working
- [ ] Bounce handling working

### Data Migration
- [ ] All email_logs migrated
- [ ] All email_sends migrated
- [ ] Preferences migrated
- [ ] Historical data preserved

### Frontend Updates
- [ ] CommunicationTimeline (per entity)
- [ ] UnifiedInbox (all communications)
- [ ] ThreadView (email conversations)
- [ ] PreferencesEditor (opt-in/out)

---

## Technical Context

### Communications vs Activities

| Aspect | Communications | Activities |
|--------|----------------|------------|
| **Purpose** | Actual message content | Event logging |
| **Content** | Full body, attachments | Summary, notes |
| **Tracking** | Delivery, opens, clicks | Completion status |
| **Threading** | Email threads | N/A |
| **Auto-link** | Creates activity | N/A |

### Relationship Model

```
communications
├── Creates → activities (auto-logged)
├── Links → campaigns (if from sequence)
├── Links → documents (attachments)
└── References → communication_preferences (respects opt-out)
```

---

## Notes

This builds on the existing `activities` framework while adding communication-specific features:

1. **Thread Tracking**: Email conversations linked together
2. **Delivery Tracking**: Know if message was delivered
3. **Engagement Metrics**: Opens, clicks, replies
4. **Preference Respect**: Check opt-in before sending
5. **Provider Agnostic**: Works with SendGrid, Twilio, etc.
6. **Unified View**: All channels in one timeline
