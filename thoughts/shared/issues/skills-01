# ISSUE: Unified Skills & Certifications Taxonomy System

**Issue ID:** SKILLS-01
**Created:** 2025-12-10
**Status:** Open
**Priority:** High
**Type:** Feature/Enhancement (Database Schema Redesign)
**Reporter:** User
**Depends On:** CONTACTS-01 (for contact_skills migration)

---

## Summary

Redesign the fragmented skills and certifications data model into a unified, enterprise-grade taxonomy system. Currently, skills are scattered across 6+ tables with inconsistent schemas, no master taxonomy, and limited AI/ML capabilities. This issue creates a centralized `skills` master taxonomy with vector embeddings for semantic matching, a polymorphic `entity_skills` junction table, and a unified `certifications` table.

## Location

- **Current Tables**: `skills`, `skill_aliases`, `candidate_skills`, `contact_skills`, `job_skills`, `external_job_order_skills`
- **Related Tables**: `candidate_certifications`, `contact_certifications`
- **Affected Modules**: ATS, Recruiting, Bench Sales, CRM

## Problem Description

### Current State Issues

1. **Fragmented Skill Tables**: 6 separate skill-related tables with different schemas
   - `skills` (14 columns) - Master table but underutilized
   - `skill_aliases` - Inconsistently populated
   - `candidate_skills` - Uses legacy candidate_id FK pattern
   - `contact_skills` - Created for contacts unification but not fully migrated
   - `job_skills` - Job requirements
   - `external_job_order_skills` - Vendor job order requirements

2. **No Semantic Matching**: No vector embeddings for AI-powered skill matching ("React" ≈ "ReactJS" ≈ "React.js")

3. **Inconsistent Proficiency Levels**:
   - candidate_skills: TEXT ('beginner', 'intermediate', 'expert')
   - contact_skills: INTEGER (1-5)
   - job_skills: No proficiency field

4. **Duplicate Skill Entries**: No canonical/normalized skill names causing duplicates

5. **No Skill Hierarchy**: Missing parent/child relationships (JavaScript → React → Next.js)

6. **Certification Fragmentation**: `candidate_certifications` and `contact_certifications` are separate tables

### Research Findings (Industry Best Practices)

Enterprise platforms implement:
- **Bullhorn**: Normalized `Skill` master with `CandidateSkill` junction, proficiency levels
- **LinkedIn**: Skills taxonomy with 35,000+ standardized skills, endorsements, vector embeddings
- **Workday**: Hierarchical skill framework with proficiency levels, certifications linked
- **Modern ATS (2024-2025)**: Vector embeddings (OpenAI ada-002) for semantic skill matching

## Expected Behavior

A unified skills system that:
1. Single `skills` master taxonomy with canonical names, aliases, hierarchy
2. Vector embeddings for AI-powered semantic matching
3. Polymorphic `entity_skills` for any entity type (contact, job, placement)
4. Unified `certifications` table linked to skills
5. Consistent proficiency levels (1-5 scale) across all entities
6. Verification tracking (verified skills vs self-reported)

## Proposed Schema Design

### Core Tables (5 total)

| Category | Tables |
|----------|--------|
| Master Data | `skills` (enhanced) |
| Junction | `entity_skills` (polymorphic) |
| Credentials | `certifications` (unified) |
| Verification | `skill_verifications`, `skill_endorsements` |

### Skills Master Table (Enhanced)

```sql
skills:
-- Identity
  id UUID PRIMARY KEY
  org_id UUID  -- NULL for global taxonomy, org_id for custom skills

-- Core
  name VARCHAR NOT NULL  -- Display name
  canonical_name VARCHAR UNIQUE NOT NULL  -- Normalized lowercase (e.g., "javascript")

-- Hierarchy
  parent_skill_id UUID REFERENCES skills(id)
  skill_level INTEGER  -- 0=root, 1=category, 2=skill, 3=specialization
  hierarchy_path TEXT  -- Materialized path for fast queries

-- Classification
  category VARCHAR  -- 'programming_language', 'framework', 'tool', 'soft_skill', 'domain'
  domain VARCHAR  -- 'technology', 'business', 'creative', 'healthcare'

-- Metadata
  description TEXT
  aliases JSONB  -- ['JS', 'ECMAScript', 'ES6']
  related_skills UUID[]  -- Array of related skill IDs

-- Versioning (e.g., "React 18" vs "React 17")
  version VARCHAR
  is_latest_version BOOLEAN DEFAULT true

-- Demand/Trending (ML-calculated)
  demand_score NUMERIC(3,2)  -- 0-100, based on job postings
  trending BOOLEAN DEFAULT false
  trending_direction VARCHAR  -- 'up', 'down', 'stable'

-- AI/ML
  embedding VECTOR(1536)  -- For semantic search (OpenAI ada-002)

-- Status
  is_active BOOLEAN DEFAULT true
  is_verified BOOLEAN DEFAULT false  -- Verified by taxonomy admin
  deprecated BOOLEAN DEFAULT false
  deprecated_successor_id UUID REFERENCES skills(id)

-- Search
  search_vector TSVECTOR

-- Audit
  created_at, updated_at, created_by
```

### Entity Skills (Polymorphic Junction)

```sql
entity_skills:
  id UUID PRIMARY KEY
  org_id UUID NOT NULL

-- Polymorphic relationship
  entity_type VARCHAR NOT NULL  -- 'contact', 'job', 'placement', 'job_order'
  entity_id UUID NOT NULL

-- Skill reference
  skill_id UUID NOT NULL REFERENCES skills(id)

-- Proficiency (universal scale)
  proficiency_level INTEGER  -- 1=Beginner, 2=Basic, 3=Intermediate, 4=Advanced, 5=Expert
  years_experience NUMERIC(4,1)
  last_used_date DATE

-- Context
  is_primary BOOLEAN DEFAULT false  -- Primary/featured skill
  is_required BOOLEAN  -- For jobs: required vs nice-to-have
  min_proficiency_required INTEGER  -- For jobs: minimum level needed

-- Verification
  is_verified BOOLEAN DEFAULT false
  verified_by UUID REFERENCES user_profiles(id)
  verified_at TIMESTAMPTZ
  verification_method VARCHAR  -- 'assessment', 'endorsement', 'certification', 'interview'
  confidence_score NUMERIC(3,2)  -- AI confidence in skill extraction

-- Source
  source VARCHAR  -- 'resume_parsed', 'manual', 'linkedin_sync', 'assessment'
  source_context TEXT  -- Where skill was demonstrated (company, project)

-- Audit
  created_at, updated_at

CONSTRAINT entity_skills_unique UNIQUE (entity_type, entity_id, skill_id)
```

### Certifications (Unified)

```sql
certifications:
  id UUID PRIMARY KEY
  org_id UUID NOT NULL

-- Polymorphic (who has this cert)
  entity_type VARCHAR NOT NULL  -- 'contact' (person), 'company' (org cert)
  entity_id UUID NOT NULL

-- Certification details
  certification_name VARCHAR NOT NULL
  issuing_organization VARCHAR
  credential_id VARCHAR
  verification_url VARCHAR

-- Linked skill (optional)
  skill_id UUID REFERENCES skills(id)

-- Dates
  issue_date DATE
  expiry_date DATE
  is_active BOOLEAN DEFAULT true

-- Renewal
  renewal_required BOOLEAN DEFAULT false
  renewal_period_months INTEGER
  renewal_reminder_sent_at TIMESTAMPTZ

-- Verification
  is_verified BOOLEAN DEFAULT false
  verified_by UUID REFERENCES user_profiles(id)
  verified_at TIMESTAMPTZ

-- Documents
  certificate_url VARCHAR

-- Audit
  created_at, updated_at

CREATE INDEX idx_certifications_entity ON certifications(entity_type, entity_id);
CREATE INDEX idx_certifications_expiry ON certifications(expiry_date) WHERE is_active = true;
```

### Skill Endorsements (Social Proof)

```sql
skill_endorsements:
  id UUID PRIMARY KEY
  org_id UUID NOT NULL

-- Who is being endorsed
  entity_skill_id UUID NOT NULL REFERENCES entity_skills(id)

-- Who is endorsing
  endorser_id UUID NOT NULL REFERENCES contacts(id)
  endorser_relationship VARCHAR  -- 'colleague', 'manager', 'client', 'recruiter'

-- Endorsement details
  endorsement_level VARCHAR  -- 'basic', 'strong', 'expert'
  comment TEXT

-- Verification
  is_verified BOOLEAN DEFAULT false  -- Endorser is verified contact

-- Audit
  created_at

CONSTRAINT skill_endorsements_unique UNIQUE (entity_skill_id, endorser_id)
```

## Migration Strategy

### Phase 0: Legacy Cleanup
- Remove duplicate skill entries
- Normalize skill names to canonical form
- Map proficiency text to integer scale

### Phase 1: Schema Enhancement
- Enhance `skills` table with hierarchy, embeddings, taxonomy fields
- Create `entity_skills` polymorphic table
- Create `certifications` unified table
- Create `skill_endorsements` table

### Phase 2: Data Migration
1. Migrate `candidate_skills` → `entity_skills` (entity_type='contact')
2. Migrate `contact_skills` → `entity_skills` (entity_type='contact')
3. Migrate `job_skills` → `entity_skills` (entity_type='job')
4. Migrate `external_job_order_skills` → `entity_skills` (entity_type='job_order')
5. Migrate `candidate_certifications` → `certifications`
6. Migrate `contact_certifications` → `certifications`

### Phase 3: Generate Embeddings
- Generate vector embeddings for all skills
- Calculate demand scores from job postings
- Build skill hierarchy relationships

### Phase 4: Backward Compatibility
- Create views: `candidate_skills`, `contact_skills`, `job_skills`
- Update tRPC routers to use new tables
- Maintain legacy API surface

### Phase 5: Router & UI Updates
- New `skills` tRPC router with taxonomy management
- Skill autocomplete with semantic search
- Skill matrix editor component
- Certification tracker component

### Phase 6: Deprecation
- Drop legacy tables after validation period

## Acceptance Criteria

### Schema Implementation
- [ ] Enhance `skills` table with hierarchy, embeddings, taxonomy fields
- [ ] Add `embedding VECTOR(1536)` column with pgvector index
- [ ] Create `entity_skills` polymorphic junction table
- [ ] Create unified `certifications` table
- [ ] Create `skill_endorsements` table
- [ ] Add all required indexes (including vector similarity)
- [ ] Add search_vector trigger for full-text search
- [ ] Enable RLS on all new tables

### Skill Taxonomy Features
- [ ] Parent/child hierarchy working (skill_level, hierarchy_path)
- [ ] Canonical names enforce uniqueness
- [ ] Aliases stored and searchable
- [ ] Deprecated skills point to successors
- [ ] Version tracking for technology skills

### AI/ML Capabilities
- [ ] Vector embeddings populated for all skills
- [ ] Semantic similarity search functional
- [ ] Demand scores calculated from job data
- [ ] Trending detection working

### Data Migration
- [ ] All candidate_skills migrated to entity_skills
- [ ] All contact_skills migrated to entity_skills
- [ ] All job_skills migrated to entity_skills
- [ ] All certifications migrated to unified table
- [ ] Proficiency levels normalized to 1-5 scale
- [ ] No data loss during migration

### Backward Compatibility
- [ ] Legacy views return expected data
- [ ] Existing tRPC procedures continue working
- [ ] No breaking changes to frontend during transition

### Frontend Updates
- [ ] Skill autocomplete with semantic search
- [ ] Skill matrix editor (add/remove/rate skills)
- [ ] Skill hierarchy browser
- [ ] Certification tracker with expiry alerts
- [ ] Skill matching visualization (job ↔ candidate)

### Testing
- [ ] Migration scripts tested on staging
- [ ] Vector similarity search benchmarked
- [ ] Skill matching accuracy validated
- [ ] Performance tests for large skill sets

---

## Technical Context

### Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                    SKILLS (Master Taxonomy)                      │
│              (Global + Org-specific skills)                      │
├─────────────────────────────────────────────────────────────────┤
│ • Canonical names (unique, normalized)                           │
│ • Hierarchy (parent/child, category/domain)                      │
│ • Aliases (searchable variations)                                │
│ • Vector embeddings (semantic matching)                          │
│ • Demand/trending scores (ML-calculated)                         │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           │ skill_id FK
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                 ENTITY_SKILLS (Polymorphic Junction)             │
├─────────────────────────────────────────────────────────────────┤
│ entity_type: 'contact' | 'job' | 'placement' | 'job_order'       │
│ entity_id: UUID                                                  │
│ • Proficiency level (1-5)                                        │
│ • Years experience                                               │
│ • Verification status                                            │
│ • Source (resume, manual, LinkedIn)                              │
└──────────────────────────┬──────────────────────────────────────┘
                           │
         ┌─────────────────┼─────────────────┐
         ▼                 ▼                 ▼
┌─────────────┐   ┌─────────────┐   ┌─────────────┐
│  Contacts   │   │    Jobs     │   │ Placements  │
│  (people)   │   │ (req skills)│   │(used skills)│
└─────────────┘   └─────────────┘   └─────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                    CERTIFICATIONS (Unified)                      │
├─────────────────────────────────────────────────────────────────┤
│ Polymorphic: entity_type + entity_id                             │
│ • Optional skill_id link                                         │
│ • Expiry tracking with alerts                                    │
│ • Verification status                                            │
└─────────────────────────────────────────────────────────────────┘
```

### Key Design Decisions

| Decision | Rationale |
|----------|-----------|
| Polymorphic entity_skills | One table for all entity types (contacts, jobs, placements) |
| Vector embeddings | AI-powered semantic matching beyond exact text match |
| Canonical names | Prevent duplicates, enable merge/cleanup |
| Skill hierarchy | Support category → skill → specialization |
| Proficiency 1-5 scale | Universal standard, maps to beginner→expert |
| Verification tracking | Distinguish verified from self-reported skills |

### Related Files (Current State)

- Skills master: `supabase/migrations/00000000000000_baseline.sql:23636` (skills table)
- Candidate skills: `baseline.sql` (candidate_skills table)
- Contact skills: `src/server/routers/unified-contacts.ts` (contact_skills usage)
- Job skills: `src/server/routers/ats.ts` (job_skills usage)

---

## RLS Policies

```sql
-- skills master table RLS
ALTER TABLE skills ENABLE ROW LEVEL SECURITY;

-- Global skills (org_id IS NULL) are readable by all orgs
-- Org-specific skills are only visible within their org
CREATE POLICY "skills_read_global_or_own" ON skills
  FOR SELECT USING (org_id IS NULL OR org_id = auth.org_id());

CREATE POLICY "skills_org_write" ON skills
  FOR ALL USING (org_id = auth.org_id());

-- entity_skills table RLS
ALTER TABLE entity_skills ENABLE ROW LEVEL SECURITY;

CREATE POLICY "entity_skills_org_isolation" ON entity_skills
  FOR ALL USING (org_id = auth.org_id());

-- certifications table RLS
ALTER TABLE certifications ENABLE ROW LEVEL SECURITY;

CREATE POLICY "certifications_org_isolation" ON certifications
  FOR ALL USING (org_id = auth.org_id());

-- skill_endorsements table RLS
ALTER TABLE skill_endorsements ENABLE ROW LEVEL SECURITY;

CREATE POLICY "skill_endorsements_org_isolation" ON skill_endorsements
  FOR ALL USING (org_id = auth.org_id());
```

---

## Index Strategy

```sql
-- Skills master indexes
CREATE INDEX idx_skills_org ON skills(org_id) WHERE org_id IS NOT NULL;
CREATE INDEX idx_skills_canonical ON skills(canonical_name);
CREATE INDEX idx_skills_category ON skills(category, domain);
CREATE INDEX idx_skills_parent ON skills(parent_skill_id) WHERE parent_skill_id IS NOT NULL;
CREATE INDEX idx_skills_hierarchy ON skills(hierarchy_path);
CREATE INDEX idx_skills_search ON skills USING gin(search_vector);
CREATE INDEX idx_skills_embedding ON skills USING ivfflat(embedding vector_cosine_ops) WITH (lists = 100);
CREATE INDEX idx_skills_trending ON skills(demand_score DESC) WHERE trending = true;

-- Entity skills indexes
CREATE INDEX idx_entity_skills_org ON entity_skills(org_id, entity_type, entity_id);
CREATE INDEX idx_entity_skills_skill ON entity_skills(skill_id);
CREATE INDEX idx_entity_skills_verified ON entity_skills(is_verified) WHERE is_verified = true;
CREATE INDEX idx_entity_skills_primary ON entity_skills(entity_type, entity_id) WHERE is_primary = true;

-- Certifications indexes
CREATE INDEX idx_certifications_entity ON certifications(entity_type, entity_id);
CREATE INDEX idx_certifications_expiry ON certifications(expiry_date) WHERE is_active = true;
CREATE INDEX idx_certifications_skill ON certifications(skill_id) WHERE skill_id IS NOT NULL;
```

---

## Rollback Plan

### Schema Rollback
```sql
-- Drop in reverse order
DROP TABLE IF EXISTS skill_endorsements;
DROP TABLE IF EXISTS certifications;
DROP TABLE IF EXISTS entity_skills;

-- Remove new columns from skills (if enhanced)
ALTER TABLE skills
  DROP COLUMN IF EXISTS embedding,
  DROP COLUMN IF EXISTS hierarchy_path,
  DROP COLUMN IF EXISTS demand_score,
  DROP COLUMN IF EXISTS trending,
  DROP COLUMN IF EXISTS trending_direction;

-- Recreate legacy skill tables from backups if needed
```

### Full Rollback Procedure
1. Stop application deployments
2. Execute schema rollback SQL
3. Restore legacy skill tables from backup
4. Restore tRPC router to previous git commit
5. Restore UI components to previous git commit
6. Verify skill pickers work with legacy tables
7. Document incident and root cause

---

## Notes

This design follows the same architectural patterns as the recent unification work:
- **Single Source of Truth**: One `skills` master taxonomy
- **Polymorphic Pattern**: `entity_skills` for all entity types
- **Centralization**: `certifications` unified table
- **AI/ML Ready**: Vector embeddings for semantic search
- **Enterprise Features**: Hierarchy, versioning, demand scoring

The skill taxonomy is foundational for:
1. AI-powered candidate matching
2. Job requirement specification
3. Skill gap analysis
4. Training recommendations
5. Market demand insights

---

## RLS Policies

```sql
-- skills table RLS (global + org-specific)
ALTER TABLE skills ENABLE ROW LEVEL SECURITY;

CREATE POLICY "skills_global_read" ON skills
  FOR SELECT USING (
    org_id IS NULL OR org_id = auth.org_id()
  );

CREATE POLICY "skills_org_modify" ON skills
  FOR ALL USING (
    org_id = auth.org_id()
  );

-- entity_skills table RLS
ALTER TABLE entity_skills ENABLE ROW LEVEL SECURITY;

CREATE POLICY "entity_skills_org_isolation" ON entity_skills
  FOR ALL USING (org_id = auth.org_id());

-- certifications table RLS
ALTER TABLE certifications ENABLE ROW LEVEL SECURITY;

CREATE POLICY "certifications_org_isolation" ON certifications
  FOR ALL USING (org_id = auth.org_id());

-- skill_endorsements table RLS
ALTER TABLE skill_endorsements ENABLE ROW LEVEL SECURITY;

CREATE POLICY "skill_endorsements_org_isolation" ON skill_endorsements
  FOR ALL USING (org_id = auth.org_id());
```

---

## Rollback Plan

### Schema Rollback
```sql
-- Drop in reverse order
DROP TABLE IF EXISTS skill_endorsements;
DROP TABLE IF EXISTS certifications;
DROP TABLE IF EXISTS entity_skills;

-- Restore skills table to original state (remove new columns)
ALTER TABLE skills
  DROP COLUMN IF EXISTS embedding,
  DROP COLUMN IF EXISTS hierarchy_path,
  DROP COLUMN IF EXISTS skill_level,
  DROP COLUMN IF EXISTS parent_skill_id,
  DROP COLUMN IF EXISTS canonical_name,
  DROP COLUMN IF EXISTS aliases,
  DROP COLUMN IF EXISTS related_skills,
  DROP COLUMN IF EXISTS version,
  DROP COLUMN IF EXISTS is_latest_version,
  DROP COLUMN IF EXISTS demand_score,
  DROP COLUMN IF EXISTS trending,
  DROP COLUMN IF EXISTS trending_direction,
  DROP COLUMN IF EXISTS deprecated,
  DROP COLUMN IF EXISTS deprecated_successor_id;

-- Recreate legacy tables from backups
-- CREATE TABLE candidate_skills AS SELECT * FROM candidate_skills_backup;
-- CREATE TABLE contact_skills AS SELECT * FROM contact_skills_backup;
-- CREATE TABLE job_skills AS SELECT * FROM job_skills_backup;
```

### Full Rollback Procedure
1. Stop application deployments
2. Execute schema rollback SQL
3. Restore legacy skill tables from backups
4. Restore tRPC router to previous git commit
5. Restore UI components to previous git commit
6. Regenerate search indexes on legacy tables
7. Verify skill autocomplete works
8. Document incident and root cause
