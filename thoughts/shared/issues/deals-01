# ISSUE: Migrate CRM Deals to Unified System

**Issue ID:** DEALS-01
**Created:** 2025-12-10
**Status:** Open
**Priority:** Medium
**Type:** Migration/Integration
**Reporter:** Architecture Review
**Depends On:** CONTACTS-01 (unified contacts), ACCOUNTS-02 (unified companies), HISTORY-01 (status tracking)

---

## Summary

Migrate the `deals` table to use the unified `contacts` and `companies` systems. Currently, deals reference legacy entities and have fragmented stage tracking. This migration ensures deals use the centralized entity model and integrate with the unified pipeline/history tracking.

## Location

- **Current Table**: `deals` (references legacy leads, accounts)
- **Target**: `deals` with updated FKs to `contacts` and `companies`
- **Related Tables**: `deal_stages`, `deal_stages_history`, `deal_products`, `deal_activities`
- **Affected Modules**: CRM, Sales, Pipeline

## Problem Description

### Current State Issues

1. **Legacy Entity References**:
   - `deals.lead_id` references legacy `leads` table
   - `deals.account_id` references legacy `accounts` table
   - After CONTACTS-01 and ACCOUNTS-02, needs unified references

2. **Contact Tracking Incomplete**:
   - No `primary_contact_id` for deal champion
   - No junction table for all deal stakeholders
   - Decision makers not tracked

3. **Stage History Fragmented**:
   - `deal_stages_history` separate from unified `entity_history`
   - Inconsistent with HISTORY-01 design

4. **Revenue Tracking Limited**:
   - No recurring revenue support (ARR/MRR)
   - No multi-currency support
   - No forecasting fields

### Deals Table Current Structure (Key Fields)

```sql
-- Current deals table (simplified)
deals:
  id, org_id
  name, description
  lead_id  -- Legacy FK to leads, should be contacts
  account_id  -- Legacy FK to accounts, should be companies
  owner_id  -- FK to user_profiles
  stage, stage_id
  amount, currency
  close_date, probability
  status  -- open, won, lost
  created_at, updated_at, deleted_at
```

## Expected Behavior

After migration:
1. `deals.primary_contact_id` references unified `contacts`
2. `deals.company_id` references unified `companies`
3. `deal_contacts` junction table for all stakeholders
4. Stage history migrated to `entity_history`
5. Revenue fields enhanced for forecasting
6. Multi-currency support

## Proposed Schema Changes

### Deals Table Updates

```sql
-- Updated deals table
ALTER TABLE deals
  -- Rename and re-point references
  RENAME COLUMN account_id TO company_id;

ALTER TABLE deals
  -- Add contact references
  ADD COLUMN primary_contact_id UUID REFERENCES contacts(id),
  ADD COLUMN lead_contact_id UUID REFERENCES contacts(id),  -- Original lead that became deal

  -- Company reference (updated FK)
  DROP CONSTRAINT IF EXISTS deals_account_id_fkey,
  ADD CONSTRAINT deals_company_id_fkey
    FOREIGN KEY (company_id) REFERENCES companies(id),

  -- Pipeline tracking
  ADD COLUMN pipeline_id UUID REFERENCES pipelines(id),
  ADD COLUMN pipeline_stage_id UUID REFERENCES pipeline_stages(id),
  ADD COLUMN stage_entered_at TIMESTAMPTZ,
  ADD COLUMN stage_duration_days INTEGER,

  -- Revenue fields
  ADD COLUMN deal_type VARCHAR,  -- 'new_business', 'upsell', 'renewal', 'expansion'
  ADD COLUMN revenue_type VARCHAR,  -- 'one_time', 'recurring', 'usage_based'
  ADD COLUMN arr NUMERIC(15,2),  -- Annual Recurring Revenue
  ADD COLUMN mrr NUMERIC(15,2),  -- Monthly Recurring Revenue
  ADD COLUMN contract_value NUMERIC(15,2),  -- Total contract value
  ADD COLUMN contract_term_months INTEGER,

  -- Multi-currency
  ADD COLUMN base_currency VARCHAR DEFAULT 'USD',
  ADD COLUMN exchange_rate NUMERIC(10,6) DEFAULT 1,
  ADD COLUMN amount_base_currency NUMERIC(15,2),

  -- Forecasting
  ADD COLUMN forecast_category VARCHAR,  -- 'pipeline', 'best_case', 'commit', 'closed'
  ADD COLUMN weighted_amount NUMERIC(15,2) GENERATED ALWAYS AS (amount * probability / 100) STORED,
  ADD COLUMN expected_close_date DATE,
  ADD COLUMN next_step TEXT,
  ADD COLUMN next_step_due_date DATE,

  -- Competition
  ADD COLUMN competitors JSONB,  -- [{ name, status: 'active'|'eliminated' }]
  ADD COLUMN competitive_notes TEXT,

  -- Win/Loss tracking
  ADD COLUMN outcome VARCHAR,  -- 'won', 'lost', 'no_decision'
  ADD COLUMN outcome_at TIMESTAMPTZ,
  ADD COLUMN outcome_reason VARCHAR,
  ADD COLUMN outcome_notes TEXT,
  ADD COLUMN loss_competitor_id UUID,  -- If lost to competitor

  -- Source tracking
  ADD COLUMN source VARCHAR,  -- 'inbound', 'outbound', 'referral', 'partner', 'event'
  ADD COLUMN source_campaign_id UUID,
  ADD COLUMN source_detail TEXT;

-- Indexes
CREATE INDEX idx_deals_company ON deals(company_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_deals_contact ON deals(primary_contact_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_deals_stage ON deals(pipeline_stage_id, status) WHERE deleted_at IS NULL;
CREATE INDEX idx_deals_close ON deals(expected_close_date) WHERE status = 'open' AND deleted_at IS NULL;
CREATE INDEX idx_deals_forecast ON deals(forecast_category, expected_close_date) WHERE status = 'open';
```

### Deal Contacts (Junction Table)

```sql
-- All stakeholders in a deal
CREATE TABLE deal_contacts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  deal_id UUID NOT NULL REFERENCES deals(id) ON DELETE CASCADE,
  contact_id UUID NOT NULL REFERENCES contacts(id),

  -- Role
  role VARCHAR NOT NULL,  -- 'decision_maker', 'champion', 'influencer', 'blocker', 'user', 'budget_holder'
  is_primary BOOLEAN DEFAULT false,

  -- Engagement
  sentiment VARCHAR,  -- 'supportive', 'neutral', 'unsupportive', 'unknown'
  engagement_level INTEGER,  -- 1-5
  last_contacted_at TIMESTAMPTZ,

  -- Notes
  notes TEXT,

  -- Audit
  created_at TIMESTAMPTZ DEFAULT now(),
  created_by UUID REFERENCES user_profiles(id),

  CONSTRAINT deal_contacts_unique UNIQUE (deal_id, contact_id)
);

CREATE INDEX idx_deal_contacts_deal ON deal_contacts(deal_id);
CREATE INDEX idx_deal_contacts_contact ON deal_contacts(contact_id);
```

### Deal Products/Line Items

```sql
-- Products/services in deal
CREATE TABLE deal_products (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  deal_id UUID NOT NULL REFERENCES deals(id) ON DELETE CASCADE,

  -- Product reference (if using product catalog)
  product_id UUID,
  product_name VARCHAR NOT NULL,
  product_code VARCHAR,

  -- Quantity and pricing
  quantity NUMERIC(10,2) DEFAULT 1,
  unit_price NUMERIC(12,2) NOT NULL,
  discount_percentage NUMERIC(5,2) DEFAULT 0,
  discount_amount NUMERIC(12,2) DEFAULT 0,
  total_price NUMERIC(12,2) NOT NULL,

  -- Recurring
  is_recurring BOOLEAN DEFAULT false,
  billing_frequency VARCHAR,  -- 'monthly', 'quarterly', 'annually'
  term_months INTEGER,

  -- Description
  description TEXT,

  -- Audit
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

CREATE INDEX idx_deal_products_deal ON deal_products(deal_id);
```

## Migration Strategy

### Phase 1: Schema Updates (Non-Breaking)
- Add new columns to deals table
- Create deal_contacts junction table
- Keep old columns temporarily

### Phase 2: Data Migration

#### Pre-Migration Validation (Added per Architecture Review)

```sql
-- CRITICAL: Run before migration to ensure clean account→company mapping
-- This query should return 0 rows. If it returns rows, manual resolution required.

-- Check 1: Find accounts that don't have exactly one matching company
SELECT a.id as account_id, a.name as account_name, COUNT(c.id) as company_matches
FROM accounts a
LEFT JOIN companies c ON c.org_id = a.org_id AND c.name = a.name AND c.category = 'client'
WHERE a.org_id = $org_id
  AND a.deleted_at IS NULL
GROUP BY a.id, a.name
HAVING COUNT(c.id) != 1;

-- Check 2: Find deals with NULL lead_id that might lose contact linkage
SELECT d.id as deal_id, d.name as deal_name
FROM deals d
WHERE d.lead_id IS NULL
  AND d.org_id = $org_id
  AND d.deleted_at IS NULL;

-- Check 3: Find leads without matching contacts (by email)
SELECT l.id as lead_id, l.email, l.first_name, l.last_name
FROM leads l
LEFT JOIN contacts c ON c.org_id = l.org_id AND c.primary_email = l.email
WHERE l.org_id = $org_id
  AND c.id IS NULL
  AND EXISTS (SELECT 1 FROM deals d WHERE d.lead_id = l.id);

-- Resolution: Create contacts for orphaned leads before migration
-- Or manually map lead_id to contact_id in a mapping table
```

#### Migration Scripts

```sql
-- Step 1: Map accounts to companies
UPDATE deals d
SET company_id = c.id
FROM accounts a
JOIN companies c ON c.org_id = a.org_id
  AND c.name = a.name
  AND c.category = 'client'
WHERE d.account_id = a.id
  AND d.company_id IS NULL;

-- Step 2: Map leads to contacts (get primary contact from lead)
UPDATE deals d
SET lead_contact_id = c.id,
    primary_contact_id = c.id
FROM leads l
JOIN contacts c ON c.org_id = l.org_id
  AND c.primary_email = l.email
WHERE d.lead_id = l.id;

-- Step 3: Migrate stage history to entity_history
INSERT INTO entity_history (
  org_id, entity_type, entity_id,
  change_type, field_name,
  old_value, new_value,
  changed_by, changed_at
)
SELECT
  dsh.org_id, 'deal', dsh.deal_id,
  'stage_change', 'stage',
  dsh.old_stage, dsh.new_stage,
  dsh.changed_by, dsh.changed_at
FROM deal_stages_history dsh;
```

### Phase 3: Backward Compatibility Views

```sql
-- View for legacy queries
CREATE VIEW deals_legacy_v AS
SELECT
  d.*,
  d.company_id as account_id,
  d.lead_contact_id as lead_id
FROM deals d
WHERE d.deleted_at IS NULL;
```

### Phase 4: Router & UI Updates
- Update `crm.ts` router to use new FK references
- Update deal forms to use company/contact selectors
- Update pipeline views with new fields
- Add deal stakeholder management UI

## Acceptance Criteria

### Schema Implementation
- [ ] Rename `account_id` to `company_id` with proper FK
- [ ] Add `primary_contact_id` FK to `contacts`
- [ ] Add `lead_contact_id` FK to `contacts`
- [ ] Add pipeline stage tracking fields
- [ ] Add revenue type fields (ARR/MRR)
- [ ] Add multi-currency support
- [ ] Add forecasting fields
- [ ] Add win/loss tracking fields
- [ ] Create `deal_contacts` junction table
- [ ] Create `deal_products` table
- [ ] All indexes created
- [ ] RLS policies updated

### Data Migration
- [ ] All deals have `company_id` populated
- [ ] Primary contacts migrated from leads
- [ ] Stage history migrated to entity_history
- [ ] No orphaned references

### Backward Compatibility
- [ ] Legacy view `deals_legacy_v` working
- [ ] Existing tRPC procedures continue working
- [ ] No breaking changes to frontend initially

### Frontend Updates
- [ ] Deal creation uses company selector
- [ ] Contact picker for deal stakeholders
- [ ] Pipeline stage selector linked to company pipeline
- [ ] Revenue forecasting fields visible
- [ ] Deal stakeholder management UI

### Testing
- [ ] Migration script tested on staging
- [ ] All existing deal queries work
- [ ] Pipeline metrics accurate
- [ ] Performance benchmarks acceptable

---

## Rollback Plan

### Schema Rollback
```sql
-- Reverse order of creation
DROP TABLE IF EXISTS deal_products;
DROP TABLE IF EXISTS deal_contacts;

-- Remove new columns from deals (in reverse order of addition)
ALTER TABLE deals 
  DROP COLUMN IF EXISTS source_detail,
  DROP COLUMN IF EXISTS source_campaign_id,
  DROP COLUMN IF EXISTS source,
  DROP COLUMN IF EXISTS loss_competitor_id,
  DROP COLUMN IF EXISTS outcome_notes,
  DROP COLUMN IF EXISTS outcome_reason,
  DROP COLUMN IF EXISTS outcome_at,
  DROP COLUMN IF EXISTS outcome,
  DROP COLUMN IF EXISTS competitive_notes,
  DROP COLUMN IF EXISTS competitors,
  DROP COLUMN IF EXISTS next_step_due_date,
  DROP COLUMN IF EXISTS next_step,
  DROP COLUMN IF EXISTS expected_close_date,
  DROP COLUMN IF EXISTS weighted_amount,
  DROP COLUMN IF EXISTS forecast_category,
  DROP COLUMN IF EXISTS amount_base_currency,
  DROP COLUMN IF EXISTS exchange_rate,
  DROP COLUMN IF EXISTS base_currency,
  DROP COLUMN IF EXISTS contract_term_months,
  DROP COLUMN IF EXISTS contract_value,
  DROP COLUMN IF EXISTS mrr,
  DROP COLUMN IF EXISTS arr,
  DROP COLUMN IF EXISTS revenue_type,
  DROP COLUMN IF EXISTS deal_type,
  DROP COLUMN IF EXISTS stage_duration_days,
  DROP COLUMN IF EXISTS stage_entered_at,
  DROP COLUMN IF EXISTS pipeline_stage_id,
  DROP COLUMN IF EXISTS pipeline_id,
  DROP COLUMN IF EXISTS lead_contact_id,
  DROP COLUMN IF EXISTS primary_contact_id;

-- Rename company_id back to account_id
ALTER TABLE deals RENAME COLUMN company_id TO account_id;

-- Re-add original FK constraint
ALTER TABLE deals
  ADD CONSTRAINT deals_account_id_fkey 
    FOREIGN KEY (account_id) REFERENCES accounts(id);

-- Drop legacy view
DROP VIEW IF EXISTS deals_legacy_v;
```

### Full Rollback Procedure
1. Stop application deployments
2. Verify no in-flight deal operations
3. Execute schema rollback SQL
4. Restore tRPC router (`crm.ts`) to previous git commit
5. Restore UI components to previous git commit
6. Verify deal list and detail pages work
7. Verify deal creation/editing works
8. Document incident and root cause

### Data Recovery
```sql
-- If data was migrated, restore from backup
INSERT INTO accounts SELECT * FROM accounts_backup_[timestamp] 
  WHERE id NOT IN (SELECT id FROM accounts);

-- Restore lead_id from lead_contact_id mapping
UPDATE deals d
SET lead_id = (
  SELECT l.id FROM leads l 
  JOIN contacts c ON c.primary_email = l.email
  WHERE c.id = d.lead_contact_id
);
```

---

## Technical Context

### Entity Relationship After Migration

```
┌─────────────────────────────────────────────────────────────────┐
│                           DEALS                                  │
├─────────────────────────────────────────────────────────────────┤
│ company_id ─────────────────────► companies (client)            │
│ primary_contact_id ─────────────► contacts (champion)           │
│ lead_contact_id ────────────────► contacts (original lead)      │
│ pipeline_id ────────────────────► pipelines                     │
│ pipeline_stage_id ──────────────► pipeline_stages               │
│ owner_id ───────────────────────► user_profiles                 │
└─────────────────────────────────────────────────────────────────┘
         │
         │ deal_id FK
         ▼
┌─────────────────────┐    ┌─────────────────────┐
│   deal_contacts     │    │   deal_products     │
│ • decision_makers   │    │ • line items        │
│ • champions         │    │ • pricing           │
│ • influencers       │    │ • recurring         │
└─────────────────────┘    └─────────────────────┘
```

### Deal Pipeline Flow

```
Lead (contact) → Qualified → Deal Created
                              ↓
                         Pipeline Stages
                              ↓
                    won / lost / no_decision
```

### Revenue Types

```
Deal Revenue:
├── one_time (single payment)
├── recurring (subscription)
│   ├── ARR (Annual Recurring Revenue)
│   └── MRR (Monthly Recurring Revenue)
└── usage_based (consumption)

Contract Value = One-time + (Recurring × Term)
```

---

## Notes

This migration is important for **CRM accuracy**:

1. **Unified Contacts**: Know who your deal stakeholders are
2. **Company Linkage**: Deals tied to proper company entity
3. **Revenue Forecasting**: Proper ARR/MRR tracking
4. **Win/Loss Analysis**: Understand why deals close or don't
5. **Pipeline Metrics**: Accurate stage duration and conversion
