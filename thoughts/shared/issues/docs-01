# ISSUE: Centralized Documents System

**Issue ID:** DOCS-01
**Created:** 2025-12-10
**Status:** Open
**Priority:** Medium
**Type:** Feature/Enhancement (Database Schema Redesign)
**Reporter:** User

---

## Summary

Unify the fragmented document storage system into a centralized `documents` table with polymorphic entity references. Currently, documents are scattered across 6+ entity-specific tables with inconsistent metadata schemas. This issue creates an enterprise-grade document management system with versioning, classification, OCR/AI processing, and secure access controls.

## Location

- **Current Tables**: `file_uploads`, `candidate_documents`, `candidate_resumes`, `campaign_documents`, `employee_documents`, `immigration_documents`, `generated_documents`, `generated_resumes`
- **Related Tables**: `document_templates`, `resume_versions`
- **Affected Modules**: ATS, HR, CRM, Recruiting

## Problem Description

### Current State Issues

1. **Fragmented Document Tables**: 8+ separate document tables
   - `file_uploads` - Generic uploads (polymorphic but underutilized)
   - `candidate_documents` - Candidate-specific docs
   - `candidate_resumes` - Resume versions
   - `campaign_documents` - Marketing materials
   - `employee_documents` - HR documents
   - `immigration_documents` - Visa/work auth docs
   - `generated_documents` - System-generated docs
   - `generated_resumes` - AI-generated resumes

2. **Schema Inconsistency**:
   - Different metadata fields per table
   - Inconsistent versioning approaches
   - No unified document types

3. **Missing Enterprise Features**:
   - No document expiration tracking
   - Limited access control (no document-level permissions)
   - No OCR/text extraction integration
   - No AI-powered document classification

4. **Duplicate Storage**: Same document can be uploaded to multiple tables

## Expected Behavior

A unified documents system that:
1. Single `documents` table with polymorphic entity reference
2. Consistent metadata schema across all document types
3. Full versioning support (version history, latest flag)
4. Document classification (resume, contract, ID, certification, etc.)
5. Expiration tracking with alerts
6. Access control (confidentiality levels)
7. OCR/AI processing metadata storage
8. Deduplication via content hashing

## Proposed Schema Design

### Documents Table (Unified Polymorphic)

```sql
CREATE TABLE documents (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),

  -- Polymorphic relationship
  entity_type VARCHAR NOT NULL,  -- 'contact', 'company', 'job', 'placement', 'campaign'
  entity_id UUID NOT NULL,

  -- File details
  file_name VARCHAR NOT NULL,
  file_type VARCHAR,  -- Extension: 'pdf', 'docx', 'png'
  mime_type VARCHAR,
  file_size_bytes BIGINT,

  -- Storage
  storage_provider VARCHAR DEFAULT 's3',  -- 's3', 'azure_blob', 'gcs'
  storage_path VARCHAR NOT NULL,
  storage_bucket VARCHAR,
  public_url VARCHAR,  -- If publicly accessible
  signed_url_expires_at TIMESTAMPTZ,  -- For temporary signed URLs

  -- Classification
  document_type VARCHAR NOT NULL,
    -- Person documents: 'resume', 'cover_letter', 'id_document', 'certification', 'reference_letter', 'background_check', 'drug_test', 'i9', 'w4', 'direct_deposit'
    -- Company documents: 'msa', 'nda', 'sow', 'w9', 'coi', 'insurance', 'contract'
    -- Job documents: 'job_description', 'requirements', 'scorecard'
    -- General: 'other', 'note_attachment'

  document_category VARCHAR,  -- 'compliance', 'legal', 'marketing', 'hr', 'operational'

  -- Versioning
  version INTEGER DEFAULT 1,
  is_latest_version BOOLEAN DEFAULT true,
  previous_version_id UUID REFERENCES documents(id),
  version_notes TEXT,

  -- Processing status
  processing_status VARCHAR DEFAULT 'pending',  -- 'pending', 'processing', 'completed', 'failed'
  processed_at TIMESTAMPTZ,

  -- OCR/AI extracted data
  ocr_text TEXT,  -- Full extracted text
  extracted_metadata JSONB,  -- AI-extracted fields
  ai_classification JSONB,  -- AI document type prediction

  -- Deduplication
  content_hash VARCHAR,  -- SHA-256 of file content

  -- Expiration
  expires_at TIMESTAMPTZ,
  expiry_alert_sent_at TIMESTAMPTZ,
  expiry_alert_days_before INTEGER DEFAULT 30,

  -- Access control
  is_confidential BOOLEAN DEFAULT false,
  access_level VARCHAR DEFAULT 'standard',  -- 'public', 'standard', 'confidential', 'restricted'
  accessible_by_roles TEXT[],  -- Roles that can access

  -- Tags
  tags TEXT[],

  -- Audit
  uploaded_by UUID REFERENCES user_profiles(id),
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  deleted_at TIMESTAMPTZ
);

-- Indexes
CREATE INDEX idx_documents_entity ON documents(entity_type, entity_id, created_at DESC) WHERE deleted_at IS NULL;
CREATE INDEX idx_documents_type ON documents(document_type, entity_type) WHERE deleted_at IS NULL;
CREATE INDEX idx_documents_expiry ON documents(expires_at) WHERE expires_at IS NOT NULL AND deleted_at IS NULL;
CREATE INDEX idx_documents_hash ON documents(content_hash) WHERE deleted_at IS NULL;
CREATE INDEX idx_documents_latest ON documents(entity_type, entity_id, document_type) WHERE is_latest_version = true AND deleted_at IS NULL;
```

### Document Access Log (Audit)

```sql
CREATE TABLE document_access_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  document_id UUID NOT NULL REFERENCES documents(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES user_profiles(id),
  action VARCHAR NOT NULL,  -- 'view', 'download', 'share', 'delete'
  ip_address INET,
  user_agent TEXT,
  accessed_at TIMESTAMPTZ DEFAULT now()
);

CREATE INDEX idx_document_access_document ON document_access_log(document_id, accessed_at DESC);
```

## Migration Strategy

### Phase 1: Schema Creation
- Create unified `documents` table
- Create `document_access_log` table
- Set up storage integration (S3/cloud)

### Phase 2: Data Migration
1. Migrate `file_uploads` → `documents`
2. Migrate `candidate_documents` → `documents` (entity_type='contact')
3. Migrate `candidate_resumes` → `documents` (document_type='resume')
4. Migrate `campaign_documents` → `documents` (entity_type='campaign')
5. Migrate `employee_documents` → `documents` (entity_type='contact')
6. Migrate `immigration_documents` → `documents` (entity_type='contact', document_category='compliance')
7. Migrate `generated_documents` → `documents`
8. Deduplicate by content_hash

### Phase 3: Backward Compatibility
- Create views for legacy tables
- Update storage URLs if needed

### Phase 4: Router & UI Updates
- New `documents` tRPC router
- DocumentUploader component
- DocumentList with filtering
- DocumentViewer with download tracking

### Phase 5: AI Integration (Optional)
- OCR processing pipeline
- AI document classification
- Metadata extraction

## Acceptance Criteria

### Schema Implementation
- [ ] Create unified `documents` table
- [ ] Support all entity types and document types
- [ ] Versioning working correctly
- [ ] Expiration tracking functional
- [ ] Access control enforced
- [ ] Content hashing for deduplication
- [ ] RLS policies enforced

### Data Migration
- [ ] All file_uploads migrated
- [ ] All candidate_documents migrated
- [ ] All candidate_resumes migrated
- [ ] All campaign_documents migrated
- [ ] All employee_documents migrated
- [ ] All immigration_documents migrated
- [ ] Duplicates identified and merged
- [ ] No data loss, storage URLs preserved

### Frontend Updates
- [ ] DocumentUploader component (drag-drop, multi-file)
- [ ] DocumentList with type filtering
- [ ] DocumentViewer (preview for PDF/images)
- [ ] Version history view
- [ ] Expiration alerts in UI

### Storage Integration
- [ ] S3 upload working
- [ ] Signed URL generation
- [ ] Download tracking

---

## Technical Context

### Document Type Taxonomy

```
documents
├── Person Documents (entity_type='contact')
│   ├── resume
│   ├── cover_letter
│   ├── id_document (passport, driver's license)
│   ├── certification
│   ├── reference_letter
│   ├── background_check
│   ├── drug_test
│   ├── i9
│   ├── w4
│   └── direct_deposit
├── Company Documents (entity_type='company')
│   ├── msa
│   ├── nda
│   ├── sow
│   ├── w9
│   ├── coi (certificate of insurance)
│   ├── insurance
│   └── contract
├── Job Documents (entity_type='job')
│   ├── job_description
│   ├── requirements
│   └── scorecard
├── Placement Documents (entity_type='placement')
│   ├── offer_letter
│   ├── timesheet
│   └── performance_review
└── Campaign Documents (entity_type='campaign')
    ├── marketing_collateral
    └── email_template
```

---

## Notes

This follows the polymorphic pattern established for `addresses`, `activities`, and `notes`. Key enterprise features:

1. **Versioning**: Track document history (resume updates, contract amendments)
2. **Expiration**: Critical for compliance (insurance, certifications)
3. **Access Control**: Confidential documents (background checks, salary info)
4. **AI Processing**: OCR for resume parsing, document classification
5. **Deduplication**: Same file uploaded multiple times = one storage entry
