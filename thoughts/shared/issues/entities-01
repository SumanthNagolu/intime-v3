# ISSUE: Polymorphic Entity Resolution Service

**Issue ID:** ENTITIES-01
**Created:** 2025-12-11
**Status:** Open
**Priority:** High
**Type:** Feature/Infrastructure
**Reporter:** System (Architecture Review)

---

## Summary

Establish a central service and registry to manage polymorphic entity resolution across the platform. Currently, multiple systems (Tasks, Notes, Documents, History, etc.) use `entity_type` and `entity_id` columns, but there is no centralized way to validate these types or resolve the IDs to actual records and display names. This issue introduces a registry table and resolution functions to standardize this behavior.

## Problem Description

### Current State
- Multiple tables use `entity_type` (VARCHAR) and `entity_id` (UUID).
- No referential integrity for `entity_type` values (string literals used in constraints).
- No unified way to "get the name of this entity" (requires complex CASE statements or multiple queries).
- Risk of inconsistent `entity_type` values (e.g., 'employee' vs 'contact').

### Goals
1. **Central Registry**: A table defining all valid entity types and their corresponding tables.
2. **Resolution Function**: A database function to resolve an ID to a JSON object (name, url, etc.).
3. **Consistency**: Enforce standard entity types across the application.

## Proposed Schema

### Entity Type Registry

```sql
-- Central entity type registry
CREATE TABLE entity_type_registry (
  entity_type VARCHAR PRIMARY KEY,
  table_name VARCHAR NOT NULL,
  id_column VARCHAR DEFAULT 'id',
  display_name_column VARCHAR DEFAULT 'name', -- Column to use for display name
  display_name VARCHAR NOT NULL, -- Human readable type name (e.g. "Candidate")
  is_active BOOLEAN DEFAULT true,
  
  created_at TIMESTAMPTZ DEFAULT now()
);

-- Seed Registry (Complete list per Architecture Review)
INSERT INTO entity_type_registry (entity_type, table_name, display_name_column, display_name) VALUES
-- Core
('organization', 'organizations', 'name', 'Organization'),
('user', 'user_profiles', 'full_name', 'User'),

-- CRM (ACCOUNTS-02, CONTACTS-01, CAMPAIGNS-01, DEALS-01)
('company', 'companies', 'name', 'Company'),
('contact', 'contacts', 'full_name', 'Contact'),
('campaign', 'campaigns', 'name', 'Campaign'),
('deal', 'deals', 'name', 'Deal'),
('lead', 'leads', 'name', 'Lead'),  -- Legacy, migrated to contacts

-- ATS (JOBS-01, SUBMISSIONS-01, INTERVIEWS-01, OFFERS-01)
('job', 'jobs', 'title', 'Job'),
('submission', 'submissions', 'id', 'Submission'),
('interview', 'interviews', 'id', 'Interview'),
('offer', 'offers', 'id', 'Offer'),

-- Placements (PLACEMENTS-01, TIMESHEETS-01, ONBOARDING-01)
('placement', 'placements', 'id', 'Placement'),
('timesheet', 'timesheets', 'id', 'Timesheet'),
('onboarding', 'onboarding_checklists', 'checklist_number', 'Onboarding'),

-- Finance (INVOICES-01, RATES-01, CONTRACTS-01, PAYROLL-01)
('invoice', 'invoices', 'invoice_number', 'Invoice'),
('rate_card', 'rate_cards', 'rate_card_name', 'Rate Card'),
('contract', 'contracts', 'contract_name', 'Contract'),
('pay_period', 'pay_periods', 'period_name', 'Pay Period'),
('pay_run', 'pay_runs', 'id', 'Pay Run'),

-- Supporting (SKILLS-01, DOCS-01, COMPLIANCE-01, ADDRESSES-01)
('skill', 'skills', 'name', 'Skill'),
('document', 'documents', 'filename', 'Document'),
('compliance_item', 'compliance_items', 'id', 'Compliance Item'),
('compliance_requirement', 'compliance_requirements', 'requirement_name', 'Compliance Requirement'),
('address', 'addresses', 'id', 'Address'),

-- Notes & Activities (NOTES-01)
('note', 'notes', 'id', 'Note'),
('activity', 'activities', 'subject', 'Activity');
```

### Complete Polymorphic Table Usage Matrix

The following tables use `entity_type` + `entity_id` pattern:

| Polymorphic Table | Supported entity_type Values |
|-------------------|------------------------------|
| `notes` | company, contact, campaign, deal, job, submission, interview, offer, placement, timesheet, invoice, contract |
| `documents` | company, contact, job, submission, offer, placement, onboarding, contract, invoice, compliance_item |
| `activities` | company, contact, campaign, deal, job, submission, interview, placement |
| `entity_history` | ALL entity types |
| `audit_log` | ALL entity types |
| `entity_skills` | contact, job, submission |
| `entity_rates` | contact, placement, submission, job |
| `compliance_items` | contact, placement, company |
| `addresses` | company, contact |

### Entity Resolution Function

```sql
-- Entity resolution function
CREATE OR REPLACE FUNCTION resolve_entity(p_entity_type VARCHAR, p_entity_id UUID)
RETURNS JSONB AS $$
DECLARE
  v_table_name VARCHAR;
  v_display_col VARCHAR;
  v_result JSONB;
  v_query TEXT;
BEGIN
  -- Get table info
  SELECT table_name, display_name_column INTO v_table_name, v_display_col
  FROM entity_type_registry WHERE entity_type = p_entity_type;
  
  IF v_table_name IS NULL THEN
    RETURN NULL;
  END IF;
  
  -- Dynamic query to fetch basic info
  -- Note: This is a simplified version. Production might need more specific handling per type.
  v_query := format('
    SELECT json_build_object(
      ''id'', id,
      ''type'', %L,
      ''name'', %I::text
    ) 
    FROM %I 
    WHERE id = %L
  ', p_entity_type, v_display_col, v_table_name, p_entity_id);
  
  EXECUTE v_query INTO v_result;
  
  RETURN v_result;
EXCEPTION WHEN OTHERS THEN
  -- Handle cases where column doesn't exist or other errors
  RETURN json_build_object('error', SQLERRM);
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

## Implementation Steps

1. **Create Registry Table**: Define the `entity_type_registry`.
2. **Seed Data**: Populate with all canonical entity types defined in the Master Guide.
3. **Create Functions**: Implement `resolve_entity` and potentially `validate_entity`.
4. **Update Constraints**: (Optional) Move away from hardcoded check constraints to FKs or triggers validating against the registry (long term goal).

## Acceptance Criteria

- [ ] `entity_type_registry` table created and seeded.
- [ ] `resolve_entity` function implemented and tested.
- [ ] Documentation updated to reference this service for all polymorphic features.
