# Database Consolidation Report & Plan
## InTime v3 - Complete Database Setup

**Version:** 1.0  
**Date:** 2025-12-01  
**Status:** Comprehensive Analysis & Consolidation Plan  
**Author:** Database Architecture Team

---

## Executive Summary

This document provides a **comprehensive analysis** of the current database state, identifies **gaps and duplicates**, and presents a **detailed consolidation plan** for the InTime v3 database schema. The analysis covers:

- **Current State Assessment**: Review of all Drizzle schemas and migration files
- **Gap Analysis**: Missing tables, relationships, and functionality
- **Duplicate Identification**: Conflicting or redundant table definitions
- **Consolidation Strategy**: Unified schema design with migration path
- **Implementation Plan**: Step-by-step migration and validation approach

**Key Findings:**
- âœ… Strong foundation with multi-tenancy, RLS, and audit trails
- âš ï¸ Multiple activity systems need consolidation (activities.ts, workplan.ts, legacy activity_log)
- âš ï¸ Contact systems fragmented (contacts, crmContacts, pointOfContacts)
- âš ï¸ Job order systems duplicated (jobs, jobOrders in workspace, jobOrders in bench)
- âš ï¸ RACI/ownership scattered across modules
- âš ï¸ User profile role-specific fields vs. separate entity tables

**Recommendation:** Implement unified schema consolidation in phases, prioritizing critical business objects (Jobs, Candidates, Submissions) first, then activity/event systems, then supporting infrastructure.

---

## Table of Contents

1. [Current State Analysis](#1-current-state-analysis)
2. [Gap Analysis](#2-gap-analysis)
3. [Duplicate Identification](#3-duplicate-identification)
4. [Consolidation Strategy](#4-consolidation-strategy)
5. [Unified Schema Design](#5-unified-schema-design)
6. [Migration Plan](#6-migration-plan)
7. [RLS Policy Strategy](#7-rls-policy-strategy)
8. [Indexing Strategy](#8-indexing-strategy)
9. [Validation & Testing](#9-validation--testing)
10. [Implementation Timeline](#10-implementation-timeline)

---

## 1. Current State Analysis

### 1.1 Schema Files Overview

| Schema File | Purpose | Tables Count | Status |
|------------|---------|-------------|--------|
| `organizations.ts` | Multi-tenancy, regions, pods | 3 | âœ… Complete |
| `user-profiles.ts` | Unified user management | 1 | âœ… Complete |
| `rbac.ts` | Role-based access control | 5 | âœ… Complete |
| `audit.ts` | Audit logging | 1 | âœ… Complete |
| `events.ts` | Event bus | 3 | âœ… Complete |
| `timeline.ts` | Project timeline tracking | 2 | âœ… Complete |
| `crm.ts` | CRM module | 25+ | âš ï¸ Needs consolidation |
| `ats.ts` | ATS module | 30+ | âš ï¸ Needs consolidation |
| `bench.ts` | Bench sales module | 20+ | âš ï¸ Needs consolidation |
| `academy.ts` | Training academy | 25+ | âœ… Complete |
| `hr.ts` | HR module | 15+ | âœ… Complete |
| `ta-hr.ts` | TA/HR extensions | 10+ | âš ï¸ Overlaps with hr.ts |
| `workspace.ts` | Unified workspace | 3 | âš ï¸ Conflicts with module tables |
| `activities.ts` | Unified activities | 1 | âš ï¸ Conflicts with workplan.ts |
| `workplan.ts` | Workplan & activity system | 20+ | âš ï¸ Conflicts with activities.ts |
| `shared.ts` | Shared infrastructure | 4 | âœ… Complete |

**Total Estimated Tables:** ~180+ tables

### 1.2 Migration Files Overview

**Migration Count:** 66 SQL files

**Key Migration Categories:**
- Multi-tenancy foundation (20251119184000)
- Event bus (20251119190000)
- Academy module (20251121000000 - 20251121200000)
- CRM module (20251124000000)
- ATS module (20251124010000)
- Bench sales (20251124020000)
- TA/HR modules (20251124030000)
- Shared infrastructure (20251124040000)
- Unified workspace (20251129000000)
- Workplan/activity system (20251130000000, 20251201000000)
- HR module (20251201000000)
- Academy enhancements (20251201010000 - 20251201010003)

### 1.3 Core Infrastructure Status

| Component | Status | Notes |
|-----------|--------|-------|
| Multi-tenancy (`org_id`) | âœ… Implemented | All tables have `org_id` |
| Row Level Security (RLS) | âš ï¸ Partial | Some tables missing RLS policies |
| Audit trails | âœ… Implemented | `audit_logs` table with partitioning |
| Soft deletes | âš ï¸ Inconsistent | Some tables use `deleted_at`, others don't |
| Event bus | âœ… Implemented | `events` table with subscriptions |
| User management | âœ… Unified | `user_profiles` with RBAC |
| RACI model | âš ï¸ Scattered | Multiple ownership systems |

---

## 2. Gap Analysis

### 2.1 Missing Core Tables

#### 2.1.1 User Management Gaps

**Current State:**
- âœ… `user_profiles` exists with role-specific fields
- âœ… `systemRoles`, `roles`, `permissions`, `rolePermissions`, `userRoles` exist
- âš ï¸ Missing: Role hierarchy enforcement
- âš ï¸ Missing: User session management table
- âš ï¸ Missing: User preferences/settings table

**Required Additions:**
```sql
-- User preferences/settings
CREATE TABLE user_preferences (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES user_profiles(id) ON DELETE CASCADE,
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  
  -- UI preferences
  theme TEXT DEFAULT 'light', -- light, dark, system
  language TEXT DEFAULT 'en',
  timezone TEXT DEFAULT 'America/New_York',
  date_format TEXT DEFAULT 'MM/DD/YYYY',
  
  -- Notification preferences
  email_notifications JSONB DEFAULT '{}',
  in_app_notifications JSONB DEFAULT '{}',
  slack_notifications JSONB DEFAULT '{}',
  
  -- Dashboard preferences
  dashboard_layout JSONB DEFAULT '{}',
  default_view JSONB DEFAULT '{}',
  
  -- Metadata
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  UNIQUE(user_id, org_id)
);

-- User sessions (for audit and security)
CREATE TABLE user_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES user_profiles(id) ON DELETE CASCADE,
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  
  -- Session details
  session_token TEXT UNIQUE NOT NULL,
  ip_address INET,
  user_agent TEXT,
  device_type TEXT, -- desktop, mobile, tablet
  browser TEXT,
  os TEXT,
  
  -- Status
  is_active BOOLEAN DEFAULT true,
  last_activity_at TIMESTAMPTZ DEFAULT NOW(),
  expires_at TIMESTAMPTZ NOT NULL,
  
  -- Metadata
  created_at TIMESTAMPTZ DEFAULT NOW(),
  logged_out_at TIMESTAMPTZ,
  
  -- Indexes
  INDEX idx_user_sessions_user_id (user_id),
  INDEX idx_user_sessions_org_id (org_id),
  INDEX idx_user_sessions_token (session_token),
  INDEX idx_user_sessions_active (is_active, expires_at)
);
```

#### 2.1.2 RACI/Ownership Gaps

**Current State:**
- âœ… `objectOwners` table exists in `workspace.ts`
- âš ï¸ Missing: RACI history/audit trail
- âš ï¸ Missing: RACI transfer workflow tracking
- âš ï¸ Missing: Default RACI assignment rules

**Required Additions:**
```sql
-- RACI assignment history (for audit)
CREATE TABLE object_owner_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  
  -- Object reference
  object_type TEXT NOT NULL, -- 'job', 'candidate', 'submission', etc.
  object_id UUID NOT NULL,
  
  -- RACI assignment
  raci_role TEXT NOT NULL, -- 'R', 'A', 'C', 'I'
  user_id UUID NOT NULL REFERENCES user_profiles(id),
  
  -- Transfer details
  transferred_from UUID REFERENCES user_profiles(id),
  transferred_by UUID NOT NULL REFERENCES user_profiles(id),
  transfer_reason TEXT,
  
  -- Timing
  assigned_at TIMESTAMPTZ DEFAULT NOW(),
  unassigned_at TIMESTAMPTZ,
  
  -- Metadata
  created_at TIMESTAMPTZ DEFAULT NOW(),
  
  -- Indexes
  INDEX idx_raci_history_object (object_type, object_id),
  INDEX idx_raci_history_user (user_id),
  INDEX idx_raci_history_org (org_id)
);

-- Default RACI assignment rules (configurable per org)
CREATE TABLE raci_assignment_rules (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  
  -- Rule definition
  object_type TEXT NOT NULL, -- 'job', 'candidate', etc.
  raci_role TEXT NOT NULL, -- 'R', 'A', 'C', 'I'
  
  -- Assignment logic
  assignment_type TEXT NOT NULL, -- 'creator', 'pod_manager', 'role_based', 'custom'
  role_filter TEXT[], -- If role_based, which roles
  pod_filter UUID REFERENCES pods(id), -- If pod-specific
  
  -- Priority (for multiple rules)
  priority INTEGER DEFAULT 0,
  
  -- Status
  is_active BOOLEAN DEFAULT true,
  
  -- Metadata
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  
  UNIQUE(org_id, object_type, raci_role, priority)
);
```

#### 2.1.3 Activity System Gaps

**Current State:**
- âœ… `activities` table exists (unified)
- âœ… `workplan.ts` has extensive activity system
- âš ï¸ Missing: Activity templates/patterns
- âš ï¸ Missing: Activity SLA definitions
- âš ï¸ Missing: Activity outcome tracking

**Note:** See Section 3.1 for duplicate analysis

#### 2.1.4 Integration Gaps

**Current State:**
- âš ï¸ Missing: External integration tracking
- âš ï¸ Missing: API key management
- âš ï¸ Missing: Webhook subscriptions

**Required Additions:**
```sql
-- External integrations
CREATE TABLE integrations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  
  -- Integration details
  name TEXT NOT NULL, -- 'linkedin', 'indeed', 'dice', 'slack', etc.
  type TEXT NOT NULL, -- 'job_board', 'ats', 'crm', 'communication', 'payment'
  provider TEXT NOT NULL,
  
  -- Authentication
  auth_type TEXT NOT NULL, -- 'oauth2', 'api_key', 'basic', 'custom'
  credentials_encrypted JSONB, -- Encrypted credentials
  
  -- Configuration
  config JSONB DEFAULT '{}',
  is_active BOOLEAN DEFAULT true,
  
  -- Status
  last_sync_at TIMESTAMPTZ,
  last_error TEXT,
  error_count INTEGER DEFAULT 0,
  
  -- Metadata
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES user_profiles(id),
  
  UNIQUE(org_id, name)
);

-- Webhook subscriptions
CREATE TABLE webhook_subscriptions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  integration_id UUID REFERENCES integrations(id) ON DELETE CASCADE,
  
  -- Subscription details
  event_type TEXT NOT NULL, -- 'job.created', 'candidate.submitted', etc.
  webhook_url TEXT NOT NULL,
  
  -- Security
  secret_token TEXT, -- For webhook signature verification
  
  -- Status
  is_active BOOLEAN DEFAULT true,
  last_triggered_at TIMESTAMPTZ,
  failure_count INTEGER DEFAULT 0,
  
  -- Metadata
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 2.2 Missing Relationships

#### 2.2.1 Cross-Module Relationships

**Gaps Identified:**
- âŒ Academy graduates â†’ Candidate profile (auto-creation)
- âŒ Candidate placement â†’ Employee profile (auto-creation)
- âŒ Job filled â†’ Placement tracking
- âŒ Bench consultant â†’ Candidate profile linkage
- âŒ Client account â†’ User profile linkage

**Required:**
- Foreign key constraints where appropriate
- Event-driven workflows for auto-creation
- Data consistency validation

#### 2.2.2 Polymorphic Relationships

**Current State:**
- âœ… Polymorphic associations used (`entityType`, `entityId`)
- âš ï¸ Missing: Type-safe polymorphic helpers
- âš ï¸ Missing: Polymorphic relationship validation

**Required:**
- Database-level constraints (check constraints or triggers)
- Application-level type guards
- Documentation of valid `entityType` values

### 2.3 Missing Business Logic Tables

#### 2.3.1 Commission & Billing

**Current State:**
- âš ï¸ Missing: Commission calculation tables
- âš ï¸ Missing: Billing/invoicing tables
- âš ï¸ Missing: Payment tracking

**Required Additions:**
```sql
-- Commission structures
CREATE TABLE commission_structures (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  
  -- Structure details
  name TEXT NOT NULL,
  type TEXT NOT NULL, -- 'percentage', 'fixed', 'tiered'
  
  -- Commission rules
  rules JSONB NOT NULL, -- Flexible commission calculation rules
  
  -- Applicability
  applies_to TEXT[], -- ['placement', 'deal', 'bench_sale']
  role_filter TEXT[], -- Which roles get this commission
  
  -- Status
  is_active BOOLEAN DEFAULT true,
  effective_date DATE NOT NULL,
  expiration_date DATE,
  
  -- Metadata
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES user_profiles(id)
);

-- Commissions earned
CREATE TABLE commissions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  
  -- Earning details
  user_id UUID NOT NULL REFERENCES user_profiles(id),
  commission_structure_id UUID REFERENCES commission_structures(id),
  
  -- Source
  source_type TEXT NOT NULL, -- 'placement', 'deal', 'bench_sale'
  source_id UUID NOT NULL, -- Placement ID, Deal ID, etc.
  
  -- Amount
  amount DECIMAL(12, 2) NOT NULL,
  currency TEXT DEFAULT 'USD',
  
  -- Status
  status TEXT DEFAULT 'pending', -- 'pending', 'approved', 'paid', 'cancelled'
  approved_at TIMESTAMPTZ,
  approved_by UUID REFERENCES user_profiles(id),
  paid_at TIMESTAMPTZ,
  
  -- Metadata
  calculated_at TIMESTAMPTZ DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Invoices
CREATE TABLE invoices (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  
  -- Invoice details
  invoice_number TEXT UNIQUE NOT NULL,
  account_id UUID NOT NULL REFERENCES accounts(id),
  
  -- Dates
  invoice_date DATE NOT NULL,
  due_date DATE NOT NULL,
  
  -- Amounts
  subtotal DECIMAL(12, 2) NOT NULL,
  tax DECIMAL(12, 2) DEFAULT 0,
  total DECIMAL(12, 2) NOT NULL,
  currency TEXT DEFAULT 'USD',
  
  -- Status
  status TEXT DEFAULT 'draft', -- 'draft', 'sent', 'paid', 'overdue', 'cancelled'
  sent_at TIMESTAMPTZ,
  paid_at TIMESTAMPTZ,
  
  -- Line items (stored as JSONB for flexibility)
  line_items JSONB NOT NULL DEFAULT '[]',
  
  -- Metadata
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES user_profiles(id)
);

-- Payments
CREATE TABLE payments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  
  -- Payment details
  invoice_id UUID REFERENCES invoices(id),
  payment_method TEXT NOT NULL, -- 'ach', 'wire', 'check', 'credit_card'
  amount DECIMAL(12, 2) NOT NULL,
  currency TEXT DEFAULT 'USD',
  
  -- Dates
  payment_date DATE NOT NULL,
  received_at TIMESTAMPTZ DEFAULT NOW(),
  
  -- Reference
  reference_number TEXT,
  notes TEXT,
  
  -- Metadata
  created_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES user_profiles(id)
);
```

#### 2.3.2 Reporting & Analytics

**Current State:**
- âš ï¸ Missing: Saved reports/queries
- âš ï¸ Missing: Report templates
- âš ï¸ Missing: Dashboard configurations

**Required Additions:**
```sql
-- Saved reports
CREATE TABLE saved_reports (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  
  -- Report details
  name TEXT NOT NULL,
  description TEXT,
  report_type TEXT NOT NULL, -- 'jobs', 'candidates', 'submissions', 'placements', 'revenue', 'custom'
  
  -- Query configuration
  filters JSONB DEFAULT '{}',
  columns JSONB DEFAULT '[]',
  sort_order JSONB DEFAULT '[]',
  grouping JSONB,
  
  -- Sharing
  is_shared BOOLEAN DEFAULT false,
  shared_with_roles TEXT[],
  shared_with_users UUID[],
  
  -- Metadata
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES user_profiles(id),
  last_run_at TIMESTAMPTZ
);

-- Dashboard configurations
CREATE TABLE dashboard_configs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  user_id UUID REFERENCES user_profiles(id), -- NULL = org default
  
  -- Dashboard details
  name TEXT NOT NULL,
  layout JSONB NOT NULL, -- Widget positions, sizes, etc.
  widgets JSONB NOT NULL DEFAULT '[]', -- Widget configurations
  
  -- Status
  is_default BOOLEAN DEFAULT false,
  is_shared BOOLEAN DEFAULT false,
  
  -- Metadata
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## 3. Duplicate Identification

### 3.1 Activity Systems (CRITICAL DUPLICATE)

**Problem:** Three different activity/task systems exist:

1. **`activities.ts`** - Unified activities table
   - Simple, polymorphic activity tracking
   - Fields: `type`, `status`, `priority`, `assignedTo`, `dueAt`, etc.
   - Purpose: General activity tracking

2. **`workplan.ts`** - Workplan & Activity System
   - Complex workplan template system
   - Has its own `activities` table (runtime activities)
   - Fields: Extensive with patterns, templates, SLA tracking
   - Purpose: Structured workflow execution

3. **`shared.ts`** - Tasks table
   - Simple task management
   - Fields: `title`, `description`, `status`, `assignedTo`, `dueDate`
   - Purpose: General to-do items

4. **Legacy `activity_log`** in CRM (if exists in migrations)
   - Historical activity logging

**Consolidation Strategy:**
- **Keep:** `activities.ts` as the PRIMARY unified activities table
- **Migrate:** Workplan activities â†’ Unified activities (with `workplanInstanceId` reference)
- **Migrate:** Tasks â†’ Unified activities (with `type = 'task'`)
- **Deprecate:** Legacy `activity_log` (migrate to `activities`)

**Unified Schema:**
```sql
-- Enhanced unified activities table
CREATE TABLE activities (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  
  -- Activity details
  type TEXT NOT NULL, -- 'call', 'email', 'meeting', 'task', 'note', 'follow_up', 'interview', 'submission', etc.
  status TEXT NOT NULL DEFAULT 'open', -- 'open', 'in_progress', 'completed', 'cancelled'
  priority TEXT DEFAULT 'medium', -- 'critical', 'high', 'medium', 'low'
  
  -- Content
  subject TEXT NOT NULL,
  description TEXT,
  outcome TEXT, -- Required when status = 'completed'
  notes TEXT,
  
  -- Assignment
  assigned_to UUID NOT NULL REFERENCES user_profiles(id),
  created_by UUID NOT NULL REFERENCES user_profiles(id),
  completed_by UUID REFERENCES user_profiles(id),
  
  -- Context (polymorphic)
  entity_type TEXT, -- 'job', 'candidate', 'submission', 'account', 'lead', 'deal', etc.
  entity_id UUID,
  
  -- Workplan integration (optional)
  workplan_instance_id UUID REFERENCES workplan_instances(id),
  activity_pattern_id UUID, -- Reference to pattern if from workplan
  
  -- Scheduling
  due_at TIMESTAMPTZ,
  scheduled_for TIMESTAMPTZ, -- For meetings, calls
  duration INTEGER, -- Minutes
  
  -- SLA tracking
  sla_deadline TIMESTAMPTZ,
  sla_compliant BOOLEAN,
  
  -- Follow-up chain
  parent_activity_id UUID REFERENCES activities(id),
  follow_up_activity_id UUID REFERENCES activities(id),
  
  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT NOW(),
  started_at TIMESTAMPTZ,
  completed_at TIMESTAMPTZ,
  cancelled_at TIMESTAMPTZ,
  
  -- Metadata
  tags TEXT[],
  attachments JSONB DEFAULT '[]',
  
  -- Indexes
  INDEX idx_activities_org (org_id),
  INDEX idx_activities_assigned (assigned_to, status),
  INDEX idx_activities_entity (entity_type, entity_id),
  INDEX idx_activities_due (due_at, status),
  INDEX idx_activities_workplan (workplan_instance_id)
);
```

### 3.2 Contact Systems (DUPLICATE)

**Problem:** Three contact systems exist:

1. **`workspace.ts`** - `contacts` table
   - Universal contact table
   - Fields: `type`, `status`, `firstName`, `lastName`, `email`, `phone`, etc.
   - Purpose: Unified contact management

2. **`crm.ts`** - `crmContacts` table
   - CRM-specific contacts
   - Fields: Similar to contacts but CRM-focused
   - Purpose: CRM contact management

3. **`crm.ts`** - `pointOfContacts` table (legacy)
   - Legacy point of contact system
   - Fields: Basic contact info
   - Purpose: Job/client contacts

**Consolidation Strategy:**
- **Keep:** `contacts` table from `workspace.ts` as PRIMARY
- **Migrate:** `crmContacts` â†’ `contacts` (with `type = 'crm_contact'`)
- **Migrate:** `pointOfContacts` â†’ `contacts` (with `type = 'poc'`)
- **Add:** Foreign key references from CRM/ATS tables to unified `contacts`

**Unified Schema:**
```sql
-- Enhanced unified contacts table
CREATE TABLE contacts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  
  -- Contact type
  type TEXT NOT NULL, -- 'candidate', 'client', 'vendor', 'poc', 'crm_contact', 'general'
  status TEXT DEFAULT 'active', -- 'active', 'inactive', 'archived'
  
  -- Basic info
  first_name TEXT,
  last_name TEXT,
  full_name TEXT GENERATED ALWAYS AS (COALESCE(first_name || ' ' || last_name, first_name, last_name)) STORED,
  email TEXT,
  phone TEXT,
  phone_secondary TEXT,
  linkedin_url TEXT,
  
  -- Company association
  account_id UUID REFERENCES accounts(id),
  company_name TEXT,
  job_title TEXT,
  department TEXT,
  
  -- Address
  address_line1 TEXT,
  address_line2 TEXT,
  city TEXT,
  state TEXT,
  postal_code TEXT,
  country TEXT DEFAULT 'US',
  
  -- Preferences
  preferred_contact_method TEXT, -- 'email', 'phone', 'linkedin', 'slack'
  timezone TEXT,
  language TEXT DEFAULT 'en',
  
  -- Notes
  notes TEXT,
  tags TEXT[],
  
  -- Metadata
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES user_profiles(id),
  deleted_at TIMESTAMPTZ,
  
  -- Indexes
  INDEX idx_contacts_org (org_id),
  INDEX idx_contacts_type (type, status),
  INDEX idx_contacts_account (account_id),
  INDEX idx_contacts_email (email),
  INDEX idx_contacts_name (first_name, last_name)
);
```

### 3.3 Job Order Systems (DUPLICATE)

**Problem:** Multiple job-related tables:

1. **`ats.ts`** - `jobs` table
   - ATS job requisitions
   - Fields: Comprehensive job details, requirements, rates, etc.
   - Purpose: Recruiting jobs

2. **`workspace.ts`** - `jobOrders` table
   - Confirmed client orders
   - Fields: Similar to jobs but order-focused
   - Purpose: Client job orders

3. **`bench.ts`** - `jobOrders` table
   - Bench sales job orders
   - Fields: Job order details for consultants
   - Purpose: Consultant placement orders

**Consolidation Strategy:**
- **Keep:** `jobs` table from `ats.ts` as PRIMARY for all job types
- **Add:** `job_type` field: 'recruiting', 'bench_sales', 'client_order'
- **Migrate:** Workspace `jobOrders` â†’ `jobs` (with `job_type = 'client_order'`)
- **Migrate:** Bench `jobOrders` â†’ `jobs` (with `job_type = 'bench_sales'`)
- **Enhance:** `jobs` table to support all job order types

**Unified Schema Enhancement:**
```sql
-- Add job_type to existing jobs table
ALTER TABLE jobs ADD COLUMN IF NOT EXISTS job_type TEXT DEFAULT 'recruiting';
-- Values: 'recruiting', 'bench_sales', 'client_order'

-- Add bench sales specific fields (nullable)
ALTER TABLE jobs ADD COLUMN IF NOT EXISTS consultant_required BOOLEAN DEFAULT false;
ALTER TABLE jobs ADD COLUMN IF NOT EXISTS visa_requirement TEXT;
ALTER TABLE jobs ADD COLUMN IF NOT EXISTS marketing_profile_id UUID;

-- Add client order specific fields (nullable)
ALTER TABLE jobs ADD COLUMN IF NOT EXISTS order_number TEXT;
ALTER TABLE jobs ADD COLUMN IF NOT EXISTS contract_type TEXT;
ALTER TABLE jobs ADD COLUMN IF NOT EXISTS start_date DATE;
```

### 3.4 RACI/Ownership Systems (DUPLICATE)

**Problem:** RACI assignments scattered:

1. **`workspace.ts`** - `objectOwners` table
   - Unified RACI assignments
   - Fields: `objectType`, `objectId`, `raciRole`, `userId`
   - Purpose: Universal ownership tracking

2. **Module-specific ownership** (implicit in various tables)
   - Some tables have `assignedTo`, `ownerId`, etc.
   - Not consistently using unified RACI

**Consolidation Strategy:**
- **Keep:** `objectOwners` table as PRIMARY
- **Migrate:** All module-specific ownership â†’ `objectOwners`
- **Add:** Foreign key constraints where appropriate
- **Enforce:** All business objects MUST have RACI assignments

**Migration Script:**
```sql
-- Migrate job assignments to objectOwners
INSERT INTO object_owners (org_id, object_type, object_id, raci_role, user_id, created_at)
SELECT 
  org_id,
  'job',
  id,
  'R',
  assigned_to,
  created_at
FROM jobs
WHERE assigned_to IS NOT NULL
ON CONFLICT DO NOTHING;

-- Similar migrations for candidates, submissions, etc.
```

### 3.5 User Profile vs. Entity Tables (DESIGN DECISION)

**Problem:** Role-specific data storage:

1. **`user-profiles.ts`** - Unified user table with role-specific fields
   - Fields: `student_enrollment_date`, `employee_hire_date`, `candidate_status`, etc.
   - Purpose: Single user table

2. **Module-specific tables:**
   - `candidateProfiles` (ATS)
   - `employees` (HR)
   - `studentEnrollments` (Academy)
   - `benchConsultants` (Bench)

**Consolidation Strategy:**
- **Keep:** Both approaches (hybrid)
  - `user_profiles` = Core user identity and authentication
  - Module tables = Extended role-specific data
- **Link:** Module tables reference `user_profiles.id`
- **Enforce:** Foreign key constraints
- **Document:** Clear separation of concerns

**Rationale:**
- User profiles = Identity (who they are)
- Module tables = Role-specific data (what they do)
- Allows users to have multiple roles simultaneously
- Maintains data integrity and query performance

---

## 4. Consolidation Strategy

### 4.1 Principles

1. **Single Source of Truth**: Each entity type has ONE primary table
2. **Polymorphic Associations**: Use `entityType`/`entityId` for flexible relationships
3. **Backward Compatibility**: Migration scripts preserve data
4. **Incremental Migration**: Phase-by-phase approach
5. **Data Integrity**: Foreign keys, constraints, validation
6. **Performance**: Proper indexing strategy

### 4.2 Consolidation Phases

#### Phase 1: Core Business Objects (Week 1)
- Consolidate activity systems
- Consolidate contact systems
- Consolidate job order systems
- Establish RACI ownership

#### Phase 2: Supporting Infrastructure (Week 2)
- Add missing core tables (user preferences, sessions, etc.)
- Add integration tables
- Add commission/billing tables
- Add reporting tables

#### Phase 3: Data Migration (Week 3)
- Migrate duplicate data
- Validate data integrity
- Update application code
- Test thoroughly

#### Phase 4: Cleanup & Optimization (Week 4)
- Drop deprecated tables
- Optimize indexes
- Update RLS policies
- Performance tuning

### 4.3 Migration Approach

**For Each Consolidation:**

1. **Create Enhanced Unified Table**
   - Add all fields from duplicate tables
   - Add `source_type` field to track origin
   - Add indexes

2. **Migrate Data**
   - Copy data from duplicates
   - Transform as needed
   - Preserve relationships

3. **Update Application Code**
   - Update queries to use unified table
   - Update foreign keys
   - Update RLS policies

4. **Validate**
   - Data integrity checks
   - Performance tests
   - User acceptance

5. **Deprecate Old Tables**
   - Rename old tables (add `_deprecated` suffix)
   - Keep for 30 days
   - Drop after validation

---

## 5. Unified Schema Design

### 5.1 Core Tables (Identity & Access)

```sql
-- Organizations (multi-tenancy root)
CREATE TABLE organizations (...); -- âœ… Already exists

-- User Profiles (unified identity)
CREATE TABLE user_profiles (...); -- âœ… Already exists, enhance with preferences

-- User Preferences (NEW)
CREATE TABLE user_preferences (...); -- See Section 2.1.1

-- User Sessions (NEW)
CREATE TABLE user_sessions (...); -- See Section 2.1.1

-- RBAC (already exists)
CREATE TABLE system_roles (...); -- âœ…
CREATE TABLE roles (...); -- âœ…
CREATE TABLE permissions (...); -- âœ…
CREATE TABLE role_permissions (...); -- âœ…
CREATE TABLE user_roles (...); -- âœ…
```

### 5.2 Business Objects (Primary Entities)

```sql
-- Contacts (UNIFIED)
CREATE TABLE contacts (...); -- Enhanced version from Section 3.2

-- Accounts (Clients)
CREATE TABLE accounts (...); -- âœ… Already exists in CRM

-- Jobs (UNIFIED - all job types)
CREATE TABLE jobs (...); -- Enhanced version from Section 3.3

-- Candidates
CREATE TABLE candidate_profiles (...); -- âœ… Already exists in ATS

-- Submissions
CREATE TABLE submissions (...); -- âœ… Already exists in ATS

-- Placements
CREATE TABLE placements (...); -- âœ… Already exists in ATS

-- Bench Consultants
CREATE TABLE bench_consultants (...); -- âœ… Already exists in Bench

-- Leads & Deals
CREATE TABLE leads (...); -- âœ… Already exists in CRM
CREATE TABLE deals (...); -- âœ… Already exists in CRM
```

### 5.3 Activity & Workflow (UNIFIED)

```sql
-- Activities (UNIFIED - primary)
CREATE TABLE activities (...); -- Enhanced version from Section 3.1

-- Workplan Templates (structured workflows)
CREATE TABLE workplan_templates (...); -- âœ… Keep from workplan.ts
CREATE TABLE workplan_instances (...); -- âœ… Keep from workplan.ts
-- Link to activities via workplan_instance_id

-- Activity Patterns (templates)
CREATE TABLE activity_patterns (...); -- âœ… Keep from workplan.ts
-- Reference from activities.activity_pattern_id
```

### 5.4 Ownership & RACI (UNIFIED)

```sql
-- Object Owners (UNIFIED RACI)
CREATE TABLE object_owners (...); -- âœ… Already exists in workspace.ts

-- RACI History (NEW)
CREATE TABLE object_owner_history (...); -- See Section 2.1.2

-- RACI Assignment Rules (NEW)
CREATE TABLE raci_assignment_rules (...); -- See Section 2.1.2
```

### 5.5 Events & Audit

```sql
-- Events (event bus)
CREATE TABLE events (...); -- âœ… Already exists

-- Event Subscriptions
CREATE TABLE event_subscriptions (...); -- âœ… Already exists

-- Audit Logs
CREATE TABLE audit_logs (...); -- âœ… Already exists
```

### 5.6 Supporting Infrastructure

```sql
-- Notifications
CREATE TABLE notifications (...); -- âœ… Already exists in shared.ts

-- Comments
CREATE TABLE comments (...); -- âœ… Already exists in shared.ts

-- File Uploads
CREATE TABLE file_uploads (...); -- âœ… Already exists in shared.ts

-- Integrations (NEW)
CREATE TABLE integrations (...); -- See Section 2.1.4

-- Webhook Subscriptions (NEW)
CREATE TABLE webhook_subscriptions (...); -- See Section 2.1.4

-- Commission Structures (NEW)
CREATE TABLE commission_structures (...); -- See Section 2.3.1

-- Commissions (NEW)
CREATE TABLE commissions (...); -- See Section 2.3.1

-- Invoices (NEW)
CREATE TABLE invoices (...); -- See Section 2.3.1

-- Payments (NEW)
CREATE TABLE payments (...); -- See Section 2.3.1

-- Saved Reports (NEW)
CREATE TABLE saved_reports (...); -- See Section 2.3.2

-- Dashboard Configs (NEW)
CREATE TABLE dashboard_configs (...); -- See Section 2.3.2
```

---

## 6. Migration Plan

### 6.1 Pre-Migration Checklist

- [ ] Backup production database
- [ ] Document current schema state
- [ ] Identify all application code using duplicate tables
- [ ] Create rollback scripts
- [ ] Set up staging environment
- [ ] Notify team of migration window

### 6.2 Migration Scripts

#### 6.2.1 Activity System Consolidation

```sql
-- Step 1: Enhance unified activities table
ALTER TABLE activities ADD COLUMN IF NOT EXISTS workplan_instance_id UUID;
ALTER TABLE activities ADD COLUMN IF NOT EXISTS activity_pattern_id UUID;
ALTER TABLE activities ADD COLUMN IF NOT EXISTS parent_activity_id UUID;
ALTER TABLE activities ADD COLUMN IF NOT EXISTS follow_up_activity_id UUID;
ALTER TABLE activities ADD COLUMN IF NOT EXISTS source_type TEXT; -- 'workplan', 'task', 'manual'

-- Step 2: Migrate workplan activities
INSERT INTO activities (
  org_id, type, status, priority, subject, description,
  assigned_to, created_by, entity_type, entity_id,
  workplan_instance_id, activity_pattern_id,
  due_at, scheduled_for, duration,
  created_at, started_at, completed_at,
  source_type
)
SELECT 
  org_id, activity_type, status, priority, subject, description,
  assigned_to, created_by, entity_type, entity_id,
  workplan_instance_id, activity_pattern_id,
  due_at, scheduled_for, duration_minutes,
  created_at, started_at, completed_at,
  'workplan'
FROM workplan_activities
ON CONFLICT DO NOTHING;

-- Step 3: Migrate tasks
INSERT INTO activities (
  org_id, type, status, priority, subject, description,
  assigned_to, created_by, entity_type, entity_id,
  due_at, created_at, completed_at,
  source_type
)
SELECT 
  org_id, 'task', status, priority, title, description,
  assigned_to, created_by, entity_type, entity_id,
  due_date, created_at, completed_at,
  'task'
FROM tasks
WHERE status != 'cancelled'
ON CONFLICT DO NOTHING;

-- Step 4: Rename old tables (keep for 30 days)
ALTER TABLE workplan_activities RENAME TO workplan_activities_deprecated;
ALTER TABLE tasks RENAME TO tasks_deprecated;
```

#### 6.2.2 Contact System Consolidation

```sql
-- Step 1: Enhance unified contacts table
ALTER TABLE contacts ADD COLUMN IF NOT EXISTS source_type TEXT;
ALTER TABLE contacts ADD COLUMN IF NOT EXISTS migrated_from_id UUID;

-- Step 2: Migrate CRM contacts
INSERT INTO contacts (
  org_id, type, status, first_name, last_name, email, phone,
  account_id, company_name, job_title, department,
  created_at, updated_at, created_by,
  source_type, migrated_from_id
)
SELECT 
  org_id, 'crm_contact', status, first_name, last_name, email, phone,
  account_id, company_name, job_title, department,
  created_at, updated_at, created_by,
  'crm_contact', id
FROM crm_contacts
ON CONFLICT DO NOTHING;

-- Step 3: Migrate point of contacts
INSERT INTO contacts (
  org_id, type, status, first_name, last_name, email, phone,
  account_id, company_name, job_title,
  created_at, updated_at,
  source_type, migrated_from_id
)
SELECT 
  org_id, 'poc', 'active', first_name, last_name, email, phone,
  account_id, company_name, title,
  created_at, updated_at,
  'poc', id
FROM point_of_contacts
ON CONFLICT DO NOTHING;

-- Step 4: Update foreign keys in related tables
-- Update jobs.poc_id to reference contacts.id
UPDATE jobs j
SET poc_id = c.id
FROM contacts c
WHERE c.migrated_from_id = j.poc_id
  AND c.source_type = 'poc';

-- Step 5: Rename old tables
ALTER TABLE crm_contacts RENAME TO crm_contacts_deprecated;
ALTER TABLE point_of_contacts RENAME TO point_of_contacts_deprecated;
```

#### 6.2.3 Job Order Consolidation

```sql
-- Step 1: Add job_type and related fields to jobs table
ALTER TABLE jobs ADD COLUMN IF NOT EXISTS job_type TEXT DEFAULT 'recruiting';
ALTER TABLE jobs ADD COLUMN IF NOT EXISTS consultant_required BOOLEAN DEFAULT false;
ALTER TABLE jobs ADD COLUMN IF NOT EXISTS visa_requirement TEXT;
ALTER TABLE jobs ADD COLUMN IF NOT EXISTS order_number TEXT;
ALTER TABLE jobs ADD COLUMN IF NOT EXISTS source_type TEXT;

-- Step 2: Migrate workspace job orders
INSERT INTO jobs (
  org_id, account_id, title, description, job_type,
  status, priority, assigned_to,
  bill_rate_min, bill_rate_max, pay_rate_min, pay_rate_max,
  employment_type, work_mode, location_city, location_state,
  order_number, source_type,
  created_at, updated_at, created_by
)
SELECT 
  org_id, account_id, title, description, 'client_order',
  status, priority, assigned_to,
  bill_rate_min, bill_rate_max, pay_rate_min, pay_rate_max,
  employment_type, work_mode, location_city, location_state,
  order_number, 'workspace',
  created_at, updated_at, created_by
FROM workspace_job_orders
ON CONFLICT DO NOTHING;

-- Step 3: Migrate bench job orders
INSERT INTO jobs (
  org_id, account_id, title, description, job_type,
  status, priority, assigned_to,
  bill_rate_min, bill_rate_max, pay_rate_min, pay_rate_max,
  employment_type, work_mode, location_city, location_state,
  consultant_required, visa_requirement, source_type,
  created_at, updated_at, created_by
)
SELECT 
  org_id, account_id, title, description, 'bench_sales',
  status, priority, assigned_to,
  bill_rate_min, bill_rate_max, pay_rate_min, pay_rate_max,
  employment_type, work_mode, location_city, location_state,
  true, visa_requirement, 'bench',
  created_at, updated_at, created_by
FROM bench_job_orders
ON CONFLICT DO NOTHING;

-- Step 4: Rename old tables
ALTER TABLE workspace_job_orders RENAME TO workspace_job_orders_deprecated;
ALTER TABLE bench_job_orders RENAME TO bench_job_orders_deprecated;
```

### 6.3 Post-Migration Validation

```sql
-- Data integrity checks
SELECT 'Activities migrated' as check_name, COUNT(*) as count
FROM activities
WHERE source_type IN ('workplan', 'task');

SELECT 'Contacts migrated' as check_name, COUNT(*) as count
FROM contacts
WHERE source_type IN ('crm_contact', 'poc');

SELECT 'Jobs migrated' as check_name, COUNT(*) as count
FROM jobs
WHERE source_type IN ('workspace', 'bench');

-- Foreign key validation
SELECT 'Orphaned activities' as check_name, COUNT(*) as count
FROM activities a
LEFT JOIN user_profiles u ON a.assigned_to = u.id
WHERE u.id IS NULL;

-- Performance checks
EXPLAIN ANALYZE
SELECT * FROM activities
WHERE org_id = '...' AND assigned_to = '...' AND status = 'open';
```

---

## 7. RLS Policy Strategy

### 7.1 RLS Requirements

**Every table MUST have:**
1. RLS enabled
2. Org isolation policy (users can only see their org's data)
3. Role-based access policies (where applicable)
4. Ownership-based policies (for RACI model)

### 7.2 Standard RLS Patterns

#### 7.2.1 Org Isolation (Base Policy)

```sql
-- Standard org isolation policy
CREATE POLICY "org_isolation" ON [table_name]
  FOR ALL
  USING (org_id = (auth.jwt() ->> 'org_id')::uuid);
```

#### 7.2.2 Role-Based Access

```sql
-- Example: Recruiters can view own + RACI assignments
CREATE POLICY "recruiters_view_own_and_raci" ON jobs
  FOR SELECT
  USING (
    org_id = (auth.jwt() ->> 'org_id')::uuid
    AND (
      -- Own jobs
      assigned_to = auth.uid()
      OR
      -- RACI assignments
      EXISTS (
        SELECT 1 FROM object_owners
        WHERE object_type = 'job'
          AND object_id = jobs.id
          AND user_id = auth.uid()
          AND raci_role IN ('R', 'A', 'C', 'I')
      )
      OR
      -- Manager+ roles
      EXISTS (
        SELECT 1 FROM user_roles ur
        JOIN system_roles sr ON ur.role_id = sr.id
        WHERE ur.user_id = auth.uid()
          AND sr.name IN ('pod_manager', 'regional_director', 'coo', 'ceo', 'admin')
      )
    )
  );
```

#### 7.2.3 Data Scope Policies

```sql
-- Own data only
CREATE POLICY "own_data_only" ON [table_name]
  FOR SELECT
  USING (
    org_id = (auth.jwt() ->> 'org_id')::uuid
    AND created_by = auth.uid()
  );

-- Team data (pod-based)
CREATE POLICY "team_data" ON [table_name]
  FOR SELECT
  USING (
    org_id = (auth.jwt() ->> 'org_id')::uuid
    AND EXISTS (
      SELECT 1 FROM pod_members pm1
      JOIN pod_members pm2 ON pm1.pod_id = pm2.pod_id
      WHERE pm1.user_id = auth.uid()
        AND pm2.user_id = [table_name].created_by
    )
  );

-- Org-wide (manager+)
CREATE POLICY "org_wide_access" ON [table_name]
  FOR SELECT
  USING (
    org_id = (auth.jwt() ->> 'org_id')::uuid
    AND EXISTS (
      SELECT 1 FROM user_roles ur
      JOIN system_roles sr ON ur.role_id = sr.id
      WHERE ur.user_id = auth.uid()
        AND sr.name IN ('pod_manager', 'regional_director', 'hr_manager', 'cfo', 'coo', 'ceo', 'admin')
    )
  );
```

### 7.3 RLS Implementation Checklist

For each table, verify:
- [ ] RLS enabled
- [ ] Org isolation policy exists
- [ ] Role-based policies (if needed)
- [ ] Ownership/RACI policies (if needed)
- [ ] Insert policies (who can create)
- [ ] Update policies (who can modify)
- [ ] Delete policies (who can delete)
- [ ] Test with different user roles

---

## 8. Indexing Strategy

### 8.1 Standard Indexes

**Every table should have:**
1. Primary key index (automatic)
2. `org_id` index (for RLS and filtering)
3. Foreign key indexes (for joins)
4. Common query indexes (based on usage patterns)

### 8.2 Index Patterns

```sql
-- Org isolation (most common filter)
CREATE INDEX idx_[table]_org_id ON [table](org_id);

-- Foreign keys
CREATE INDEX idx_[table]_[fk_field] ON [table]([fk_field]);

-- Common queries
CREATE INDEX idx_[table]_status ON [table](org_id, status);
CREATE INDEX idx_[table]_created ON [table](org_id, created_at DESC);
CREATE INDEX idx_[table]_assigned ON [table](org_id, assigned_to, status);

-- Composite indexes (for complex queries)
CREATE INDEX idx_[table]_org_status_created ON [table](org_id, status, created_at DESC);

-- Polymorphic associations
CREATE INDEX idx_[table]_entity ON [table](entity_type, entity_id) WHERE entity_type IS NOT NULL;
```

### 8.3 Index Maintenance

- Monitor index usage with `pg_stat_user_indexes`
- Remove unused indexes
- Add indexes based on slow query analysis
- Consider partial indexes for filtered queries

---

## 9. Validation & Testing

### 9.1 Data Integrity Tests

```sql
-- Test 1: All activities have valid assignees
SELECT COUNT(*) as orphaned_activities
FROM activities a
LEFT JOIN user_profiles u ON a.assigned_to = u.id
WHERE u.id IS NULL;

-- Test 2: All contacts have valid orgs
SELECT COUNT(*) as orphaned_contacts
FROM contacts c
LEFT JOIN organizations o ON c.org_id = o.id
WHERE o.id IS NULL;

-- Test 3: All jobs have valid accounts
SELECT COUNT(*) as orphaned_jobs
FROM jobs j
LEFT JOIN accounts a ON j.account_id = a.id
WHERE j.account_id IS NOT NULL AND a.id IS NULL;

-- Test 4: RACI assignments are valid
SELECT COUNT(*) as invalid_raci
FROM object_owners oo
LEFT JOIN user_profiles u ON oo.user_id = u.id
WHERE u.id IS NULL;
```

### 9.2 Performance Tests

```sql
-- Test query performance
EXPLAIN ANALYZE
SELECT * FROM activities
WHERE org_id = '...' AND assigned_to = '...' AND status = 'open'
ORDER BY due_at ASC
LIMIT 50;

-- Test join performance
EXPLAIN ANALYZE
SELECT j.*, a.name as account_name, c.full_name as contact_name
FROM jobs j
LEFT JOIN accounts a ON j.account_id = a.id
LEFT JOIN contacts c ON j.poc_id = c.id
WHERE j.org_id = '...' AND j.status = 'active';
```

### 9.3 RLS Policy Tests

```sql
-- Test as different roles
SET ROLE 'technical_recruiter';
SELECT COUNT(*) FROM jobs; -- Should only see own + RACI

SET ROLE 'pod_manager';
SELECT COUNT(*) FROM jobs; -- Should see team jobs

SET ROLE 'coo';
SELECT COUNT(*) FROM jobs; -- Should see all org jobs
```

---

## 10. Implementation Timeline

### Week 1: Core Consolidations

**Day 1-2: Activity System**
- Enhance unified activities table
- Migrate workplan activities
- Migrate tasks
- Update application code
- Test

**Day 3-4: Contact System**
- Enhance unified contacts table
- Migrate CRM contacts
- Migrate point of contacts
- Update foreign keys
- Test

**Day 5: Job Order System**
- Enhance jobs table
- Migrate workspace job orders
- Migrate bench job orders
- Update application code
- Test

### Week 2: Supporting Infrastructure

**Day 1-2: User Management**
- Create user_preferences table
- Create user_sessions table
- Update authentication code
- Test

**Day 3-4: RACI Enhancements**
- Create object_owner_history table
- Create raci_assignment_rules table
- Update RACI assignment logic
- Test

**Day 5: Integrations**
- Create integrations table
- Create webhook_subscriptions table
- Update integration code
- Test

### Week 3: Business Logic Tables

**Day 1-2: Commission & Billing**
- Create commission_structures table
- Create commissions table
- Create invoices table
- Create payments table
- Test

**Day 3-4: Reporting**
- Create saved_reports table
- Create dashboard_configs table
- Update reporting code
- Test

**Day 5: Data Migration Validation**
- Run all integrity checks
- Performance testing
- User acceptance testing
- Fix issues

### Week 4: Cleanup & Optimization

**Day 1-2: Deprecated Table Removal**
- Verify no references to deprecated tables
- Drop deprecated tables
- Update documentation

**Day 3-4: Index Optimization**
- Analyze index usage
- Add missing indexes
- Remove unused indexes
- Performance tuning

**Day 5: Final Validation**
- Complete system testing
- Documentation updates
- Team training
- Production deployment

---

## Appendix A: Table Count Summary

| Category | Current | After Consolidation | Change |
|----------|---------|---------------------|--------|
| Core Identity | 8 | 10 | +2 |
| Business Objects | 50+ | 45 | -5 |
| Activities | 3 systems | 1 unified | -2 systems |
| Contacts | 3 tables | 1 unified | -2 |
| Job Orders | 3 tables | 1 unified | -2 |
| RACI/Ownership | 1 + scattered | 3 unified | +2 |
| Events & Audit | 5 | 5 | 0 |
| Supporting | 20+ | 25+ | +5 |
| **Total** | **~180** | **~175** | **-5** |

**Note:** While table count decreases slightly, the consolidation improves:
- Data consistency
- Query performance
- Maintenance simplicity
- Developer experience

---

## Appendix B: Migration Script Template

```sql
-- Migration: [Migration Name]
-- Date: YYYY-MM-DD
-- Purpose: [Brief description]

BEGIN;

-- Step 1: Create new/enhanced table
-- [SQL]

-- Step 2: Migrate data
-- [SQL]

-- Step 3: Update foreign keys
-- [SQL]

-- Step 4: Add indexes
-- [SQL]

-- Step 5: Enable RLS
ALTER TABLE [table] ENABLE ROW LEVEL SECURITY;

-- Step 6: Create RLS policies
-- [SQL]

-- Step 7: Rename old tables (keep for 30 days)
-- ALTER TABLE [old_table] RENAME TO [old_table]_deprecated;

-- Step 8: Validation queries
-- [SQL]

COMMIT;

-- Rollback script (if needed)
-- BEGIN;
-- [Rollback SQL]
-- COMMIT;
```

---

## Appendix C: RLS Policy Template

```sql
-- RLS Policies for [table_name]

-- Enable RLS
ALTER TABLE [table_name] ENABLE ROW LEVEL SECURITY;

-- Org Isolation (Base Policy)
CREATE POLICY "org_isolation_[table_name]" ON [table_name]
  FOR ALL
  USING (org_id = (auth.jwt() ->> 'org_id')::uuid);

-- Role-Based Policies (customize as needed)
CREATE POLICY "[role]_[action]_[table_name]" ON [table_name]
  FOR [SELECT|INSERT|UPDATE|DELETE]
  USING (
    org_id = (auth.jwt() ->> 'org_id')::uuid
    AND [role conditions]
  );

-- Ownership-Based Policies (if applicable)
CREATE POLICY "ownership_[table_name]" ON [table_name]
  FOR SELECT
  USING (
    org_id = (auth.jwt() ->> 'org_id')::uuid
    AND (
      created_by = auth.uid()
      OR EXISTS (
        SELECT 1 FROM object_owners
        WHERE object_type = '[entity_type]'
          AND object_id = [table_name].id
          AND user_id = auth.uid()
      )
    )
  );
```

---

## Conclusion

This consolidation plan provides a **comprehensive roadmap** for unifying the InTime v3 database schema. The phased approach ensures:

1. **Minimal Disruption**: Incremental changes with validation at each step
2. **Data Integrity**: Comprehensive migration scripts with rollback capability
3. **Performance**: Proper indexing and query optimization
4. **Security**: Complete RLS policy coverage
5. **Maintainability**: Single source of truth for each entity type

**Next Steps:**
1. Review and approve this plan
2. Set up staging environment
3. Begin Phase 1 implementation
4. Schedule weekly review meetings
5. Execute migration timeline

**Questions or Concerns?**
Please document any questions or concerns in the project issue tracker for discussion.

---

**Document Status:** Ready for Review  
**Last Updated:** 2025-12-01  
**Version:** 1.0




# Database Consolidation - Quick Reference

**Quick lookup guide for database consolidation decisions**

---

## Critical Duplicates to Consolidate

### 1. Activity Systems â†’ Unified `activities` table

| Current System | Action | Target |
|---------------|--------|--------|
| `activities.ts` (unified) | âœ… **KEEP** | Primary activities table |
| `workplan.ts` â†’ `activities` | ðŸ”„ **MIGRATE** | Add `workplan_instance_id` reference |
| `shared.ts` â†’ `tasks` | ðŸ”„ **MIGRATE** | Convert to `type = 'task'` |
| Legacy `activity_log` (CRM) | ðŸ”„ **MIGRATE** | Historical records â†’ `activities` |

**Migration Priority:** HIGH (affects core workflow tracking)

---

### 2. Contact Systems â†’ Unified `contacts` table

| Current System | Action | Target |
|---------------|--------|--------|
| `workspace.ts` â†’ `contacts` | âœ… **KEEP** | Primary contacts table |
| `crm.ts` â†’ `crmContacts` | ðŸ”„ **MIGRATE** | Add `type = 'crm_contact'` |
| `crm.ts` â†’ `pointOfContacts` | ðŸ”„ **MIGRATE** | Add `type = 'poc'` |

**Migration Priority:** HIGH (affects CRM/ATS integration)

---

### 3. Job Order Systems â†’ Unified `jobs` table

| Current System | Action | Target |
|---------------|--------|--------|
| `ats.ts` â†’ `jobs` | âœ… **KEEP** | Primary jobs table |
| `workspace.ts` â†’ `jobOrders` | ðŸ”„ **MIGRATE** | Add `job_type = 'client_order'` |
| `bench.ts` â†’ `jobOrders` | ðŸ”„ **MIGRATE** | Add `job_type = 'bench_sales'` |

**Migration Priority:** HIGH (affects core business objects)

---

### 4. RACI/Ownership â†’ Unified `objectOwners` table

| Current System | Action | Target |
|---------------|--------|--------|
| `workspace.ts` â†’ `objectOwners` | âœ… **KEEP** | Primary RACI table |
| Module-specific ownership fields | ðŸ”„ **MIGRATE** | Use `objectOwners` for all |

**Migration Priority:** MEDIUM (improves consistency)

---

## Missing Tables to Add

### Core Infrastructure

| Table | Purpose | Priority |
|-------|---------|----------|
| `user_preferences` | User UI/notification preferences | MEDIUM |
| `user_sessions` | Session tracking for security | MEDIUM |
| `object_owner_history` | RACI assignment audit trail | LOW |
| `raci_assignment_rules` | Default RACI assignment logic | LOW |

### Business Logic

| Table | Purpose | Priority |
|-------|---------|----------|
| `integrations` | External system connections | MEDIUM |
| `webhook_subscriptions` | Webhook management | MEDIUM |
| `commission_structures` | Commission calculation rules | HIGH |
| `commissions` | Commission tracking | HIGH |
| `invoices` | Client invoicing | HIGH |
| `payments` | Payment tracking | HIGH |
| `saved_reports` | User saved reports | LOW |
| `dashboard_configs` | Dashboard layouts | LOW |

---

## Schema File Status

| File | Status | Action Required |
|------|--------|-----------------|
| `organizations.ts` | âœ… Complete | None |
| `user-profiles.ts` | âœ… Complete | Add preferences link |
| `rbac.ts` | âœ… Complete | None |
| `audit.ts` | âœ… Complete | None |
| `events.ts` | âœ… Complete | None |
| `activities.ts` | âš ï¸ Needs enhancement | Add workplan fields |
| `workplan.ts` | âš ï¸ Needs consolidation | Migrate activities |
| `workspace.ts` | âš ï¸ Needs consolidation | Migrate contacts, jobOrders |
| `crm.ts` | âš ï¸ Needs consolidation | Migrate contacts |
| `ats.ts` | âœ… Complete | None |
| `bench.ts` | âš ï¸ Needs consolidation | Migrate jobOrders |
| `academy.ts` | âœ… Complete | None |
| `hr.ts` | âœ… Complete | None |
| `shared.ts` | âš ï¸ Needs consolidation | Migrate tasks |

---

## Migration Order

### Phase 1: Core Business Objects (Week 1)
1. âœ… Activities consolidation
2. âœ… Contacts consolidation  
3. âœ… Job orders consolidation
4. âœ… RACI ownership enforcement

### Phase 2: Supporting Infrastructure (Week 2)
1. User preferences & sessions
2. RACI enhancements
3. Integration tables

### Phase 3: Business Logic (Week 3)
1. Commission & billing tables
2. Reporting tables

### Phase 4: Cleanup (Week 4)
1. Drop deprecated tables
2. Index optimization
3. Performance tuning

---

## Quick Decision Matrix

**When creating a new table, ask:**

1. **Does a similar table already exist?**
   - âœ… Yes â†’ Use existing table (add fields if needed)
   - âŒ No â†’ Create new table

2. **Is this role-specific data?**
   - âœ… Yes â†’ Create module-specific table (link to `user_profiles`)
   - âŒ No â†’ Use unified table

3. **Does this need RACI ownership?**
   - âœ… Yes â†’ Use `objectOwners` table
   - âŒ No â†’ Use simple `assigned_to` field

4. **Is this an activity/work item?**
   - âœ… Yes â†’ Use unified `activities` table
   - âŒ No â†’ Create specific table

5. **Is this a contact/person?**
   - âœ… Yes â†’ Use unified `contacts` table
   - âŒ No â†’ Create specific table

---

## RLS Policy Checklist

For every table:
- [ ] RLS enabled
- [ ] Org isolation policy
- [ ] Role-based policies (if needed)
- [ ] Ownership/RACI policies (if needed)
- [ ] Test with different roles

---

## Index Checklist

For every table:
- [ ] `org_id` index
- [ ] Foreign key indexes
- [ ] Common query indexes
- [ ] Composite indexes (if needed)

---

## Data Integrity Rules

1. **All tables MUST have:**
   - `org_id` (multi-tenancy)
   - `created_at`, `updated_at` (audit)
   - `created_by` (audit)
   - RLS enabled

2. **Business objects MUST have:**
   - RACI assignments in `objectOwners`
   - Status field
   - Soft delete (`deleted_at`)

3. **Activities MUST have:**
   - `assigned_to` (user)
   - `entity_type`, `entity_id` (polymorphic)
   - `status` (open/in_progress/completed/cancelled)

---

## Common Patterns

### Polymorphic Association
```typescript
entityType: text('entity_type'), // 'job', 'candidate', etc.
entityId: uuid('entity_id'),
```

### Soft Delete
```typescript
deletedAt: timestamp('deleted_at', { withTimezone: true }),
```

### Audit Trail
```typescript
createdAt: timestamp('created_at', { withTimezone: true }).defaultNow(),
updatedAt: timestamp('updated_at', { withTimezone: true }).defaultNow(),
createdBy: uuid('created_by').references(() => userProfiles.id),
updatedBy: uuid('updated_by').references(() => userProfiles.id),
```

### Multi-Tenancy
```typescript
orgId: uuid('org_id').notNull().references(() => organizations.id, { onDelete: 'cascade' }),
```

---

**Last Updated:** 2025-12-01  
**See Full Report:** `DATABASE-CONSOLIDATION-REPORT.md`

