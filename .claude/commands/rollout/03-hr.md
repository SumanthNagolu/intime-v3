# Phase 2: HR Module

## Component Overview

**Priority:** HIGH
**Dependencies:** Admin Console (Phase 1)
**Blocks:** None (can run parallel with TA/Sales)

---

## Scope

### Database Tables
- `user_profiles` - Employee data fields
- `employee_metadata` - Extended employee info
- `pods` - Team/pod management
- `payroll_runs` - Payroll processing
- `payroll_items` - Payroll line items
- `performance_reviews` - Review cycles
- `time_attendance` - Time tracking
- `pto_balances` - PTO/leave management

### Server Actions (TO CREATE)
- `src/app/actions/hr-employees.ts` - Employee CRUD
- `src/app/actions/hr-pods.ts` - Pod management
- `src/app/actions/hr-payroll.ts` - Payroll processing
- `src/app/actions/hr-reviews.ts` - Performance reviews
- `src/app/actions/hr-time.ts` - Time & attendance

### UI Components
- `src/components/hr/HRDashboard.tsx`
- `src/components/hr/PeopleDirectory.tsx`
- `src/components/hr/OrgChart.tsx`
- `src/components/hr/PayrollDashboard.tsx`
- `src/components/hr/Analytics.tsx`
- `src/components/hr/EmployeeProfile.tsx`
- `src/components/hr/LearningAdmin.tsx`
- `src/components/hr/Recruitment.tsx`

### Pages
- `src/app/employee/hr/dashboard/page.tsx`
- `src/app/employee/hr/people/page.tsx`
- `src/app/employee/hr/payroll/page.tsx`

---

## Phase 1: Audit

### 1.1 Schema Check

Read and verify:
```
src/lib/db/schema/ta-hr.ts
```

Check for:
- `employee_metadata` table
- `pods` table with `pod_lead_id`
- `payroll_runs` and `payroll_items`
- `performance_reviews` table
- `time_attendance` table
- `pto_balances` table

### 1.2 Component Inventory

Read each HR component:
```
src/components/hr/HRDashboard.tsx
src/components/hr/PeopleDirectory.tsx
src/components/hr/PayrollDashboard.tsx
```

Document:
- Mock data locations
- Forms without actions
- Missing CRUD operations

---

## Phase 2: Database Fixes

### 2.1 Ensure Tables Exist

If missing, create migration:

```sql
-- Pods table
CREATE TABLE IF NOT EXISTS pods (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  name TEXT NOT NULL,
  pod_lead_id UUID REFERENCES user_profiles(id),
  description TEXT,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- Pod members (junction)
CREATE TABLE IF NOT EXISTS pod_members (
  pod_id UUID NOT NULL REFERENCES pods(id),
  user_id UUID NOT NULL REFERENCES user_profiles(id),
  joined_at TIMESTAMPTZ DEFAULT now(),
  PRIMARY KEY (pod_id, user_id)
);

-- Payroll runs
CREATE TABLE IF NOT EXISTS payroll_runs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  period_start DATE NOT NULL,
  period_end DATE NOT NULL,
  status TEXT DEFAULT 'draft', -- draft, pending_approval, approved, processed
  total_amount NUMERIC(12,2),
  created_by UUID REFERENCES user_profiles(id),
  approved_by UUID REFERENCES user_profiles(id),
  approved_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT now()
);

-- Performance reviews
CREATE TABLE IF NOT EXISTS performance_reviews (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  org_id UUID NOT NULL REFERENCES organizations(id),
  employee_id UUID NOT NULL REFERENCES user_profiles(id),
  reviewer_id UUID NOT NULL REFERENCES user_profiles(id),
  review_period TEXT NOT NULL, -- 'Q1 2025', 'Annual 2024'
  status TEXT DEFAULT 'draft', -- draft, submitted, acknowledged
  rating NUMERIC(3,2),
  feedback JSONB,
  created_at TIMESTAMPTZ DEFAULT now(),
  submitted_at TIMESTAMPTZ,
  acknowledged_at TIMESTAMPTZ
);
```

### 2.2 RLS Policies

```sql
-- HR can view all employees in org
ALTER TABLE user_profiles ENABLE ROW LEVEL SECURITY;

-- Pods org isolation
ALTER TABLE pods ENABLE ROW LEVEL SECURITY;
CREATE POLICY "org_isolation" ON pods FOR ALL USING (
  org_id = (SELECT org_id FROM user_profiles WHERE auth_id = auth.uid())
);

-- Payroll: HR/Admin only
ALTER TABLE payroll_runs ENABLE ROW LEVEL SECURITY;
CREATE POLICY "hr_admin_access" ON payroll_runs FOR ALL USING (
  org_id = (SELECT org_id FROM user_profiles WHERE auth_id = auth.uid())
  AND EXISTS (
    SELECT 1 FROM user_roles ur
    JOIN roles r ON ur.role_id = r.id
    WHERE ur.user_id = (SELECT id FROM user_profiles WHERE auth_id = auth.uid())
    AND r.name IN ('super_admin', 'admin', 'hr_manager')
  )
);
```

---

## Phase 3: Server Actions

### 3.1 Employee Management

Create `src/app/actions/hr-employees.ts`:

```typescript
'use server';

// List employees with filters
export async function listEmployeesAction(filters?: {
  search?: string;
  department?: string;
  podId?: string;
  status?: string;
  page?: number;
}): Promise<ActionResult<{ employees: Employee[]; total: number }>>

// Get employee detail
export async function getEmployeeAction(employeeId: string): Promise<ActionResult<EmployeeWithDetails>>

// Update employee info
export async function updateEmployeeAction(employeeId: string, input: {
  department?: string;
  position?: string;
  managerId?: string;
  salary?: number;
  status?: string;
}): Promise<ActionResult<Employee>>

// Onboard new employee
export async function onboardEmployeeAction(input: {
  userId: string;
  department: string;
  position: string;
  hireDate: string;
  salary: number;
  managerId?: string;
}): Promise<ActionResult<Employee>>

// Terminate employee
export async function terminateEmployeeAction(employeeId: string, input: {
  terminationDate: string;
  reason: string;
}): Promise<ActionResult<void>>
```

### 3.2 Pod Management

Create `src/app/actions/hr-pods.ts`:

```typescript
'use server';

// List pods
export async function listPodsAction(): Promise<ActionResult<Pod[]>>

// Get pod with members
export async function getPodAction(podId: string): Promise<ActionResult<PodWithMembers>>

// Create pod
export async function createPodAction(input: {
  name: string;
  podLeadId: string;
  description?: string;
}): Promise<ActionResult<Pod>>

// Update pod
export async function updatePodAction(podId: string, input: {
  name?: string;
  podLeadId?: string;
  description?: string;
}): Promise<ActionResult<Pod>>

// Add member to pod
export async function addPodMemberAction(podId: string, userId: string): Promise<ActionResult<void>>

// Remove member from pod
export async function removePodMemberAction(podId: string, userId: string): Promise<ActionResult<void>>

// Get pod performance metrics
export async function getPodMetricsAction(podId: string): Promise<ActionResult<PodMetrics>>
```

### 3.3 Payroll Management

Create `src/app/actions/hr-payroll.ts`:

```typescript
'use server';

// List payroll runs
export async function listPayrollRunsAction(): Promise<ActionResult<PayrollRun[]>>

// Get payroll run detail
export async function getPayrollRunAction(runId: string): Promise<ActionResult<PayrollRunWithItems>>

// Create payroll run
export async function createPayrollRunAction(input: {
  periodStart: string;
  periodEnd: string;
}): Promise<ActionResult<PayrollRun>>

// Submit for approval
export async function submitPayrollAction(runId: string): Promise<ActionResult<PayrollRun>>

// Approve payroll (requires hr_manager+ role)
export async function approvePayrollAction(runId: string): Promise<ActionResult<PayrollRun>>

// Process payroll (final)
export async function processPayrollAction(runId: string): Promise<ActionResult<PayrollRun>>
```

### 3.4 Performance Reviews

Create `src/app/actions/hr-reviews.ts`:

```typescript
'use server';

// List reviews
export async function listReviewsAction(filters?: {
  employeeId?: string;
  reviewerId?: string;
  status?: string;
  period?: string;
}): Promise<ActionResult<PerformanceReview[]>>

// Create review
export async function createReviewAction(input: {
  employeeId: string;
  reviewerId: string;
  period: string;
}): Promise<ActionResult<PerformanceReview>>

// Submit review
export async function submitReviewAction(reviewId: string, input: {
  rating: number;
  feedback: {
    strengths: string[];
    improvements: string[];
    goals: string[];
    comments: string;
  };
}): Promise<ActionResult<PerformanceReview>>

// Acknowledge review (employee)
export async function acknowledgeReviewAction(reviewId: string): Promise<ActionResult<PerformanceReview>>
```

---

## Phase 4: UI Integration

### 4.1 HRDashboard.tsx

Wire dashboard metrics to real data:
- Total employees count
- Active pods count
- Pending reviews count
- Recent hires list

### 4.2 PeopleDirectory.tsx

Connect to employee list:
```typescript
const [employees, setEmployees] = useState<Employee[]>([]);
const [filters, setFilters] = useState({});

useEffect(() => {
  listEmployeesAction(filters).then(result => {
    if (result.success) setEmployees(result.data.employees);
  });
}, [filters]);
```

### 4.3 PayrollDashboard.tsx

Wire payroll functionality:
- List payroll runs
- Create new run button
- Approval workflow
- Status updates

### 4.4 OrgChart.tsx

Build from employee manager relationships:
```typescript
// Fetch employees and build tree structure
const buildOrgTree = (employees: Employee[]) => {
  // Find CEO/top level
  // Recursively build tree by managerId
};
```

---

## Phase 5: E2E Tests

### Test File: `tests/e2e/hr-workflows.spec.ts`

```typescript
test.describe('HR Module', () => {
  test.beforeEach(async ({ page }) => {
    await login(page, 'hr_admin@intime.com', 'TestPass123!');
  });

  // Access Control
  test('hr_manager can access HR dashboard');
  test('recruiter cannot access HR dashboard');

  // People Directory
  test('can view employee list');
  test('can search employees');
  test('can filter by department');
  test('can view employee profile');
  test('can update employee details');

  // Pods
  test('can view pods');
  test('can create new pod');
  test('can assign pod lead');
  test('can add member to pod');
  test('can remove member from pod');

  // Payroll
  test('can create payroll run');
  test('can submit payroll for approval');
  test('can approve payroll run');
  test('non-hr cannot access payroll');

  // Reviews
  test('can create performance review');
  test('can submit review with rating');
  test('employee can acknowledge review');

  // Org Chart
  test('org chart displays hierarchy');
  test('can click employee in org chart');
});
```

---

## Phase 6: Verification Checklist

### Database
- [ ] pods table exists with RLS
- [ ] pod_members junction table exists
- [ ] payroll_runs table exists with RLS
- [ ] performance_reviews table exists with RLS
- [ ] Indexes on org_id, employee_id

### Server Actions
- [ ] listEmployeesAction returns filtered employees
- [ ] updateEmployeeAction saves changes
- [ ] onboardEmployeeAction sets up employee record
- [ ] terminateEmployeeAction soft deletes
- [ ] Pod CRUD operations work
- [ ] Payroll workflow complete
- [ ] Review submission/acknowledgment works

### UI
- [ ] HRDashboard shows real metrics
- [ ] PeopleDirectory loads from database
- [ ] PayrollDashboard shows runs
- [ ] OrgChart renders from data
- [ ] All forms submit to server actions
- [ ] Loading states everywhere
- [ ] Toast notifications

### E2E Tests
- [ ] All HR scenarios passing

---

## Next Step

When complete, run:
```
Execute /rollout/04-ta-sales
```
