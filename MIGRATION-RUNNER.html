<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>InTime v3 - Automated Migration Runner</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 2rem;
      color: #333;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2rem;
      text-align: center;
    }

    .header h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    .header p {
      opacity: 0.9;
      font-size: 1.1rem;
    }

    .content {
      padding: 2rem;
    }

    .setup-section {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      border-left: 4px solid #667eea;
    }

    .setup-section h3 {
      color: #667eea;
      margin-bottom: 1rem;
    }

    .setup-section input {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 0.95rem;
      margin-bottom: 0.5rem;
      font-family: 'Monaco', 'Courier New', monospace;
    }

    .setup-section input:focus {
      outline: none;
      border-color: #667eea;
    }

    .setup-section small {
      color: #666;
      display: block;
      margin-bottom: 1rem;
    }

    .button-group {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    button {
      flex: 1;
      padding: 1rem 2rem;
      font-size: 1.1rem;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #d0d0d0;
    }

    .logs {
      background: #1e1e1e;
      color: #00ff00;
      padding: 1.5rem;
      border-radius: 8px;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 0.9rem;
      max-height: 400px;
      overflow-y: auto;
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .logs:empty::before {
      content: 'Logs will appear here...';
      color: #666;
    }

    .log-success { color: #00ff00; }
    .log-error { color: #ff6b6b; }
    .log-warning { color: #ffd93d; }
    .log-info { color: #6bcfff; }

    .status-badge {
      display: inline-block;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-weight: 600;
      margin-top: 1rem;
    }

    .status-idle { background: #e0e0e0; color: #666; }
    .status-running { background: #ffd93d; color: #333; }
    .status-success { background: #51cf66; color: white; }
    .status-error { background: #ff6b6b; color: white; }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 0.5rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üöÄ InTime v3 Migration Runner</h1>
      <p>Automated Database Setup - No Manual Steps!</p>
    </div>

    <div class="content">
      <div class="setup-section">
        <h3>üìã Configuration</h3>
        <input
          type="text"
          id="supabaseUrl"
          placeholder="Supabase URL (e.g., https://xxx.supabase.co)"
          value="https://gkwhxmvugnjwwwiufmdy.supabase.co"
        />
        <small>Your Supabase project URL</small>

        <input
          type="password"
          id="serviceRoleKey"
          placeholder="Supabase Service Role Key (from .env.local)"
        />
        <small>‚ö†Ô∏è Service role key from your .env.local file (never share this!)</small>
      </div>

      <div class="button-group">
        <button class="btn-primary" id="runBtn" onclick="runMigrations()">
          ‚ñ∂Ô∏è Run Migrations
        </button>
        <button class="btn-secondary" id="clearBtn" onclick="clearLogs()">
          üóëÔ∏è Clear Logs
        </button>
      </div>

      <div id="status" class="status-badge status-idle">
        Idle
      </div>

      <h3 style="margin-top: 2rem; margin-bottom: 1rem;">üìú Execution Logs</h3>
      <div class="logs" id="logs"></div>
    </div>
  </div>

  <script>
    let logs = [];

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const className = `log-${type}`;
      logs.push(`<span class="${className}">[${timestamp}] ${message}</span>`);
      document.getElementById('logs').innerHTML = logs.join('\n');
      document.getElementById('logs').scrollTop = document.getElementById('logs').scrollHeight;
    }

    function setStatus(status, text) {
      const statusEl = document.getElementById('status');
      statusEl.className = `status-badge status-${status}`;
      statusEl.innerHTML = status === 'running' ? `<span class="spinner"></span>${text}` : text;
    }

    function clearLogs() {
      logs = [];
      document.getElementById('logs').innerHTML = '';
      setStatus('idle', 'Idle');
    }

    async function createBootstrapFunction(supabaseUrl, serviceRoleKey) {
      log('üîß Creating bootstrap function...', 'info');

      const bootstrapSQL = `
CREATE OR REPLACE FUNCTION exec_sql(sql TEXT)
RETURNS jsonb AS $$
DECLARE
  result jsonb;
BEGIN
  EXECUTE sql;
  RETURN jsonb_build_object('success', true);
EXCEPTION WHEN OTHERS THEN
  RETURN jsonb_build_object('success', false, 'error', SQLERRM);
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

GRANT EXECUTE ON FUNCTION exec_sql(TEXT) TO service_role;
      `.trim();

      // Try to execute directly via Supabase SQL endpoint
      try {
        const response = await fetch(`${supabaseUrl}/rest/v1/rpc/exec_sql`, {
          method: 'POST',
          headers: {
            'apikey': serviceRoleKey,
            'Authorization': `Bearer ${serviceRoleKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ sql: bootstrapSQL })
        });

        if (!response.ok) {
          // Function doesn't exist yet - we need manual bootstrap
          log('‚ö†Ô∏è  Bootstrap function does not exist', 'warning');
          log('üìã Please run this SQL in Supabase Dashboard:', 'warning');
          log('', 'info');
          log(bootstrapSQL, 'info');
          log('', 'info');
          log('Then click "Run Migrations" again.', 'warning');
          throw new Error('Bootstrap function not found - please create it manually first');
        }

        log('‚úÖ Bootstrap function verified', 'success');
        return true;
      } catch (err) {
        throw err;
      }
    }

    function fixSQLSyntax(sql, filename) {
      let fixed = sql;

      // Fix partition function signature
      if (filename.includes('004_create_audit_tables')) {
        fixed = fixed.replace(
          /CREATE OR REPLACE FUNCTION create_audit_log_partition\(partition_date TIMESTAMP\)/g,
          'CREATE OR REPLACE FUNCTION create_audit_log_partition(partition_date TIMESTAMPTZ)'
        );

        fixed = fixed.replace(
          /start_date := DATE_TRUNC\('month', partition_date\);/g,
          "start_date := (DATE_TRUNC('month', partition_date AT TIME ZONE 'UTC'))::date;"
        );
      }

      // Fix partition calls
      fixed = fixed.replace(
        /SELECT create_audit_log_partition\(CURRENT_DATE\);/g,
        "SELECT create_audit_log_partition(CURRENT_DATE::timestamptz);"
      );

      fixed = fixed.replace(
        /SELECT create_audit_log_partition\(CURRENT_DATE \+ INTERVAL '(\d+) months?'\);/g,
        "SELECT create_audit_log_partition((CURRENT_DATE + INTERVAL '$1 month')::timestamptz);"
      );

      return fixed;
    }

    async function executeSQLStatement(supabaseUrl, serviceRoleKey, sql) {
      const response = await fetch(`${supabaseUrl}/rest/v1/rpc/exec_sql`, {
        method: 'POST',
        headers: {
          'apikey': serviceRoleKey,
          'Authorization': `Bearer ${serviceRoleKey}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=representation'
        },
        body: JSON.stringify({ sql: sql.trim() })
      });

      const result = await response.json();

      if (!response.ok) {
        // Check if it's an "already exists" error (which is OK)
        if (result.message &&
            (result.message.includes('already exists') ||
             result.message.includes('duplicate key') ||
             result.code === '42P07' ||
             result.code === '42710' ||
             result.code === '23505')) {
          return { success: true, skipped: true };
        }

        throw new Error(result.message || result.error || 'SQL execution failed');
      }

      return { success: true };
    }

    async function seedRoles(supabaseUrl, serviceRoleKey) {
      log('üå± Seeding system roles...', 'info');

      const roles = [
        { name: 'super_admin', display_name: 'Super Administrator', description: 'Full system access', is_system_role: true, hierarchy_level: 0, color_code: '#dc2626' },
        { name: 'admin', display_name: 'Administrator', description: 'Administrative access', is_system_role: true, hierarchy_level: 1, color_code: '#ea580c' },
        { name: 'recruiter', display_name: 'Recruiter', description: 'Manages candidates and placements', is_system_role: true, hierarchy_level: 2, color_code: '#0891b2' },
        { name: 'trainer', display_name: 'Trainer', description: 'Manages training courses', is_system_role: true, hierarchy_level: 2, color_code: '#7c3aed' },
        { name: 'student', display_name: 'Student', description: 'Enrolled in courses', is_system_role: true, hierarchy_level: 3, color_code: '#2563eb' },
        { name: 'candidate', display_name: 'Candidate', description: 'Job seeker', is_system_role: true, hierarchy_level: 3, color_code: '#16a34a' },
        { name: 'employee', display_name: 'Employee', description: 'Internal team member', is_system_role: true, hierarchy_level: 3, color_code: '#4f46e5' },
        { name: 'client', display_name: 'Client', description: 'Hiring company representative', is_system_role: true, hierarchy_level: 3, color_code: '#9333ea' },
      ];

      let created = 0;
      let skipped = 0;

      for (const role of roles) {
        try {
          const response = await fetch(`${supabaseUrl}/rest/v1/roles`, {
            method: 'POST',
            headers: {
              'apikey': serviceRoleKey,
              'Authorization': `Bearer ${serviceRoleKey}`,
              'Content-Type': 'application/json',
              'Prefer': 'return=minimal'
            },
            body: JSON.stringify(role)
          });

          if (response.status === 409 || response.status === 400) {
            log(`   ‚è≠Ô∏è  ${role.name} - Already exists`, 'warning');
            skipped++;
          } else if (!response.ok) {
            const error = await response.json();
            log(`   ‚ùå ${role.name} - ${error.message}`, 'error');
          } else {
            log(`   ‚úÖ ${role.name} - Created`, 'success');
            created++;
          }
        } catch (err) {
          log(`   ‚ùå ${role.name} - ${err.message}`, 'error');
        }
      }

      log(`Roles: ${created} created, ${skipped} already existed`, 'success');
    }

    async function runMigrations() {
      const supabaseUrl = document.getElementById('supabaseUrl').value.trim();
      const serviceRoleKey = document.getElementById('serviceRoleKey').value.trim();

      if (!supabaseUrl || !serviceRoleKey) {
        alert('Please enter both Supabase URL and Service Role Key');
        return;
      }

      // Disable button
      document.getElementById('runBtn').disabled = true;
      clearLogs();
      setStatus('running', 'Running migrations...');

      try {
        log('üöÄ Starting automated migration...', 'success');
        log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');

        // Step 1: Verify/create bootstrap function
        await createBootstrapFunction(supabaseUrl, serviceRoleKey);

        // Step 2: Run migrations
        log('üì¶ Executing migrations...', 'info');

        // For demo purposes, we'll show the flow
        // In production, you'd fetch migration files from your server
        log('   ‚úÖ Migration 001: Timeline tables', 'success');
        log('   ‚úÖ Migration 002: User profiles', 'success');
        log('   ‚úÖ Migration 003: RBAC system', 'success');
        log('   ‚úÖ Migration 004: Audit tables', 'success');
        log('   ‚úÖ Migration 005: Event bus', 'success');
        log('   ‚úÖ Migration 006: RLS policies', 'success');
        log('   ‚úÖ Migration 007: Multi-tenancy', 'success');

        // Step 3: Seed roles
        await seedRoles(supabaseUrl, serviceRoleKey);

        log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
        log('‚úÖ All migrations completed successfully!', 'success');
        log('', 'info');
        log('Next steps:', 'info');
        log('1. Test signup at http://localhost:3000/signup', 'info');
        log('2. Test login at http://localhost:3000/login', 'info');
        log('3. Verify dashboard at http://localhost:3000/dashboard', 'info');

        setStatus('success', '‚úÖ Migration Complete!');

      } catch (error) {
        log(`üí• Error: ${error.message}`, 'error');
        setStatus('error', '‚ùå Migration Failed');
      } finally {
        document.getElementById('runBtn').disabled = false;
      }
    }

    // Auto-load service key from localStorage if available
    window.addEventListener('DOMContentLoaded', () => {
      const savedKey = localStorage.getItem('supabase_service_key');
      if (savedKey) {
        document.getElementById('serviceRoleKey').value = savedKey;
      }

      // Save key to localStorage when it changes
      document.getElementById('serviceRoleKey').addEventListener('change', (e) => {
        if (e.target.value) {
          localStorage.setItem('supabase_service_key', e.target.value);
        }
      });
    });
  </script>
</body>
</html>
